<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>GECAN™ XDealFlow Intelligent Toolkits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <!-- Add this near your other script tags in the <head> -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- ==================================================================================== -->
    <!-- === DEFINITIVE PINNACLE CSS (v37.0 - Ultra-Premium GUI & Legal Fortification) === -->
    <!-- ==================================================================================== -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');

        /* ==================== PREMIUM NOTIFICATION MODAL CSS (v5.1) ==================== */
        #notification-modal { display: none; }
        #notification-modal[open] { display: flex; animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #notification-modal::backdrop { background: rgba(16, 23, 59, 0.8); backdrop-filter: blur(12px); animation: fadeIn 0.4s ease; }
        
        #notification-modal-content {
            border: 1px solid var(--premium-border); 
            box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75);
            transition: box-shadow 0.4s;
        }

        /* Dynamic Styling based on notification type */
        #notification-modal-content.success { box-shadow: 0 0 0 1px var(--success-color), 0 25px 60px -12px rgba(0,0,0,0.75); }
        #notification-modal-content.error { box-shadow: 0 0 0 1px var(--error-color), 0 25px 60px -12px rgba(0,0,0,0.75); }
        #notification-modal-content.info { box-shadow: 0 0 0 1px var(--primary-color), 0 25px 60px -12px rgba(0,0,0,0.75); }
        
        #notification-header { transition: background-color 0.4s; }
        #notification-icon-container { transition: all 0.4s; }
        
        /* Success State */
        .notification-success #notification-header { background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(3, 7, 18, 0.1)); }
        .notification-success #notification-icon-container { background: linear-gradient(135deg, var(--success-color), #16a34a); }
        .notification-success #notification-ok-btn { background: linear-gradient(135deg, var(--success-color), #16a34a); border-color: var(--success-color); }

        /* Error State */
        .notification-error #notification-header { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(3, 7, 18, 0.1)); }
        .notification-error #notification-icon-container { background: linear-gradient(135deg, var(--error-color), #b91c1c); }
        .notification-error #notification-ok-btn { background: linear-gradient(135deg, var(--error-color), #b91c1c); border-color: var(--error-color); }
        
        /* Info State */
        .notification-info #notification-header { background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(3, 7, 18, 0.1)); }
        .notification-info #notification-icon-container { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
        .notification-info #notification-ok-btn { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-color: var(--primary-color); }

        
        /* ==================== PREMIUM FINALIZATION MODAL CSS (v5.0) ==================== */
        #finalization-modal { display: none; }
        #finalization-modal[open] { display: flex; animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #finalization-modal::backdrop { background: rgba(16, 23, 59, 0.8); backdrop-filter: blur(12px); animation: fadeIn 0.4s ease; }
        
        #finalization-modal-content {
            border: 1px solid var(--premium-border); 
            box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75), 0 0 0 1px rgba(139, 92, 246, 0.2);
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 35px rgba(139, 92, 246, 0.7); }
        }

        #finalization-icon-container {
            animation: pulse-glow 3s ease-in-out infinite;
        }

        #proceed-finalize-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #proceed-finalize-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4), 0 8px 10px -6px rgba(139, 92, 246, 0.4);
        }
        :root {
            --background-dark: #030712; --background-light: #0f172a; --background-accent: #1e293b;
            --background-card: #334155; --border-color: #475569; --border-accent: #64748b;
            --primary-color: #0ea5e9; --primary-hover: #0284c7; --primary-dark: #0369a1;
            --secondary-color: #6366f1; --accent-color: #8b5cf6; --success-color: #22c55e;
            --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(148, 163, 184, 0.15);
        }
        * { box-sizing: border-box; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background: var(--background-dark); color: var(--text-primary); -webkit-font-smoothing: antialiased; min-height: 100vh; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* KINETIC ANIMATIONS & EFFECTS */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 25px var(--glow-color, var(--primary-color)), 0 0 8px var(--glow-color, var(--primary-color)); } 50% { box-shadow: 0 0 40px var(--glow-color, var(--primary-color)), 0 0 12px var(--glow-color, var(--primary-color)); } }
        @keyframes swap-icon-spin { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }
        @keyframes icon-glow-rotate { 0%, 100% { transform: rotate(0deg); filter: drop-shadow(0 0 8px currentColor); } 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .animate-scale-in { animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; } .stagger-4 { animation-delay: 0.4s; }

        /* GENERAL UI COMPONENTS */
        .glass { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border: 1px solid var(--primary-color); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-primary:active:not(:disabled) { transform: translateY(-1px); }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-card); border-color: var(--border-accent); color: var(--text-primary); }
        .report-section { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 1.25rem; position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .gradient-text { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; background-color: var(--background-dark); }
        .loading-shimmer { background: linear-gradient(90deg, var(--background-light) 25%, var(--background-card) 50%, var(--background-light) 75%); background-size: 400% 100%; animation: shimmer 1.5s infinite linear; }
        
        /* NAVIGATION */
        .nav-loading { pointer-events: none; opacity: 0.6; cursor: wait; }
        .nav-link.active { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }

        /* ==================== WALLET FORENSICS UI (STRICTLY RETAINED - WORD FOR WORD LOGIC, GUI POLISHED) ==================== */
        .score-gauge svg { transform: rotate(-90deg); filter: drop-shadow(0 0 10px currentColor); }
        .score-gauge-bg { stroke: var(--border-color); stroke-width: 3; }
        .score-gauge-fg { transition: stroke-dashoffset 1.8s cubic-bezier(0.65, 0, 0.35, 1), stroke 0.6s; stroke-linecap: round; }
        .gauge-low { color: var(--success-color); } .gauge-medium { color: var(--warning-color); }
        .gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
        .risk-CRITICAL { --flag-color: var(--critical-color); } .risk-HIGH { --flag-color: var(--error-color); }
        .risk-MEDIUM { --flag-color: var(--warning-color); } .risk-LOW { --flag-color: var(--success-color); }
        .text-risk-color { color: var(--flag-color); } .bg-risk-color { background-color: color-mix(in srgb, var(--flag-color) 15%, transparent); }
        .border-risk-color { border-left-color: var(--flag-color); }
        .transaction-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-left: 4px solid transparent; }
        .transaction-item:hover { transform: translateX(5px) scale(1.02); background-color: var(--background-accent); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .transaction-inbound { border-left-color: var(--success-color); }
        .transaction-outbound { border-left-color: var(--error-color); }
        .copied-feedback { transition: opacity 0.3s, transform 0.3s; }
        .timeline-item { position: relative; padding-bottom: 2.5rem; padding-left: 2.5rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: 0.7rem; top: 1.5rem; height: 100%; border-left: 2px dashed var(--border-color); }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 0.5rem; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--background-light); box-shadow: 0 0 0 4px var(--background-dark); }
        .timeline-dot-inner { width: 0.75rem; height: 0.75rem; border-radius: 50%; transition: all 0.3s; }
        .timeline-item:hover .timeline-dot-inner { transform: scale(1.3); box-shadow: 0 0 12px currentColor; }
        /* ==================== END WALLET FORENSICS UI ==================== */

                /* ==================== INSTITUTIONAL MODELER UI (v37.1 UPGRADE) ==================== */
        .form-input, .form-select { background-color: var(--background-light); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .form-input::placeholder { color: var(--text-muted); opacity: 1; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .deal-type-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 1.25rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); position: relative; overflow: hidden; }
        .deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-color); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
        .deal-type-icon { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); color: var(--text-secondary); }
        .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
        .deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-color); transform: translateY(-4px) scale(1.05); }
        .deal-type-card.active .deal-type-icon { color: var(--text-primary); filter: drop-shadow(0 0 15px var(--primary-color)); } /* HIGH-CONTRAST ACTIVE ICON */
        .panel-transition { transition: opacity 0.5s ease-out, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .panel-transition.exiting { opacity: 0; transform: scale(0.95) translateY(10px); position: absolute; width: 100%; }
        .input-panel { background: linear-gradient(145deg, var(--background-accent), var(--background-dark)); border: 1px solid var(--border-accent); border-radius: 1.5rem; }
        .output-panel { background: var(--background-dark); border-radius: 1.5rem; border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .input-group { background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border-color); padding: 1.25rem; border-radius: 1rem; }
        .input-group-title { font-size: 1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .output-metric-card { background: linear-gradient(145deg, var(--background-accent), var(--background-light)); border: 1px solid var(--border-accent); border-radius: 1rem; padding: 1.25rem 1.5rem; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .output-metric-card:hover { transform: scale(1.02); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .output-metric-card .label { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .output-metric-card .value { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); line-height: 1; letter-spacing: -0.05em; }
        .output-metric-card .sub-value { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; font-family: 'JetBrains Mono', monospace; }
        .output-metric-card.base-value { color: var(--accent-color); } .output-metric-card.net { color: var(--success-color); } .output-metric-card.commission { color: var(--primary-color); }
        .interactive-slider { -webkit-appearance: none; width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; outline: none; transition: background 0.3s; }
        .interactive-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(14,165,233,0.5); transition: transform 0.2s; }
        .interactive-slider:hover::-webkit-slider-thumb { transform: scale(1.2); }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .collapsible-header .chevron { transition: transform 0.3s; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1), padding-top 0.5s, opacity 0.5s; opacity: 0; }
        .collapsible-content.expanded { max-height: 2000px; padding-top: 1.5rem; opacity: 1; }
        .allocation-group-card { background: var(--background-light); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 1rem; transition: all 0.3s; }
        .allocation-group-card:hover { border-color: var(--primary-color); }
        .allocation-party-card { background: rgba(0,0,0,0.2); border-left: 3px solid var(--border-accent); padding: 1rem; border-radius: 0.5rem; }
        .yield-graph-container svg { overflow: visible; } .yield-graph-path { stroke-width: 3px; fill: none; } .yield-graph-dot { transition: all 0.2s; } .yield-graph-dot:hover { r: 6; }

                /* ==================== IMFPA & NCNDA MODAL (v38.0 ULTRA-PREMIUM AESTHETIC & UX) ==================== */
        :root {
            /* Add new premium colors for the modal */
            --premium-gold: #D4AF37;
            --premium-gold-glow: rgba(212, 175, 55, 0.4);
            --premium-bg-dark: #0a0f1c;
            --premium-bg-light: #161d31;
            --premium-border: #2a3552;
            --premium-text-primary: #f0f4ff;
            --premium-text-secondary: #a0aec0;
        }

        #imfpa-modal { display: none; }
        #imfpa-modal[open] { display: flex; animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #imfpa-modal::backdrop { background: rgba(3, 7, 18, 0.85); backdrop-filter: blur(16px); animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #imfpa-modal-content { 
            background: radial-gradient(circle at top left, var(--premium-bg-light), var(--premium-bg-dark) 70%);
            border: 1px solid var(--premium-border); 
            box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75), 0 0 0 1px var(--premium-gold-glow);
            color: var(--premium-text-primary);
        }

        /* Definitive high-contrast form elements for the modal */
        #imfpa-modal-content input,
        #imfpa-modal-content select,
        #imfpa-modal-content textarea {
            background-color: var(--premium-bg-dark) !important;
            border: 1px solid var(--premium-border) !important;
            color: var(--premium-text-primary) !important;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        #imfpa-modal-content input:focus,
        #imfpa-modal-content select:focus,
        #imfpa-modal-content textarea:focus {
             border-color: var(--premium-gold) !important;
             box-shadow: 0 0 0 3px var(--premium-gold-glow) !important;
             background-color: var(--premium-bg-light) !important;
        }
        #imfpa-modal-content input::placeholder,
        #imfpa-modal-content textarea::placeholder {
            color: var(--premium-text-secondary) !important;
            opacity: 0.7;
        }
        #imfpa-modal-content input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8) sepia(1) saturate(5) hue-rotate(10deg);
        }

        .imfpa-header { 
            padding-bottom: 1.5rem; 
            border-bottom: 1px solid var(--premium-border);
            margin-bottom: 2rem;
        }
        .imfpa-header h2 {
            background: linear-gradient(90deg, var(--premium-text-primary), var(--premium-gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .imfpa-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--premium-text-primary);
            border-left: 3px solid var(--premium-gold);
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }

        .allocation-group-card {
            background: linear-gradient(145deg, var(--premium-bg-light), var(--premium-bg-dark));
            border: 1px solid var(--premium-border);
            border-radius: 1rem;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        .allocation-group-card:before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 100% 100%, transparent, var(--premium-gold-glow) 250%);
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        .allocation-group-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--premium-gold);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 15px var(--premium-gold-glow);
        }
        .allocation-group-card:hover:before { opacity: 1; }
        
        .allocation-party-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--premium-border);
            border-radius: 0.75rem;
            transition: all 0.3s;
        }
        .allocation-party-card:hover {
            background-color: var(--premium-bg-light);
            border-color: var(--premium-text-secondary);
        }
        
        .party-details-grid {
            display: grid; grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem; padding-top: 1.25rem; margin-top: 1rem;
            border-top: 1px solid var(--premium-border);
        }
        .party-detail-label {
            display: block; font-size: 0.75rem; font-weight: 600;
            color: var(--premium-text-secondary); margin-bottom: 0.25rem;
        }

        .contract-preview {
            font-family: 'JetBrains Mono', monospace; white-space: pre-wrap;
            background-color: var(--background-dark); color: var(--text-secondary);
            border: 1px solid var(--border-color); border-radius: 0.75rem;
            padding: 1.5rem; max-height: 50vh; overflow-y: auto;
            font-size: 0.8rem; line-height: 1.7;
        }
        
        /* ==================== SCREEN & PRINT VISIBILITY (v2.0 - PREMIUM PDF OVERHAUL) ==================== */
        #print-area { display: none; }
        @media print {
    /* --- CORE PRINT ISOLATION (THE FIX) --- */
    /* 1. Hide all application UI elements that have the 'print-hide' class. */
    .print-hide {
        display: none !important;
    }
    
    /* 2. Make the master print container visible. */
    #print-area {
        display: block !important;
    }

    /* 3. Global settings for perfect print rendering. */
    body, html {
        background: #fff !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* --- PAGE LAYOUT & DYNAMIC HEADERS/FOOTERS --- */
    /* This combines your premium styles with the dynamic data from the contract. */

            @page {
                size: A4;
                margin: 2cm;

                @top-left {
            content: "${agreementReference}"; /* Dynamic Reference Code */
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 8pt;
            color: #888;
        }
                @top-right {
                    content: "GECAN™ | CONFIDENTIAL";
                    font-family: 'Helvetica Neue', Arial, sans-serif;
                    font-size: 8pt;
                    color: #888;
                }
                @bottom-center {
                    content: "Page " counter(page) " of " counter(pages);
                    font-family: 'Helvetica Neue', Arial, sans-serif;
                    font-size: 8pt;
                    color: #888;
                }
            }

            .p-doc {
                font-family: 'Garamond', 'Times New Roman', serif;
                font-size: 11pt;
                line-height: 1.4;
                color: #000;
                margin: 0; padding: 0; border: none; box-shadow: none;
            }
            .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; /* Deep Navy Blue */ border-bottom: 2px solid #D4AF37; /* Gold */ padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
            .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; /* Indigo */ border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
            .p-h3 { font-size: 12pt; font-weight: bold; color: #3949AB; margin-top: 16pt; margin-bottom: 8pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
            .p-text { text-align: justify; margin-bottom: 11pt; }
            .p-list-item { margin-left: 20pt; text-indent: -20pt; margin-bottom: 6pt; }
            .p-strong { font-weight: bold; }
            .p-code { font-family: 'Courier New', monospace; background-color: #f2f2f2; padding: 1pt 3pt; border-radius: 3pt; font-size: 10pt; }
            
            .p-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
            .p-table th, .p-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; }
            .p-table th { background-color: #e8eaf6; /* Light Indigo */ color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 10pt; }
            .p-table tr:nth-child(even) td { background-color: #f9f9f9; }
            
            .p-signature-block { margin-top: 40pt; page-break-inside: avoid; }
            .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; }
            .p-signature-label { font-size: 9pt; color: #555; }

            .p-annex-start { page-break-before: always; }
            
            .p-watermark {
                display: block !important; visibility: visible !important; position: fixed;
                top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 120pt; color: rgba(212, 175, 55, 0.08); font-weight: bold;
                z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif;
            }
        }
    </style>
</head>
<body class="min-h-screen">
   <div id="particles-js" class="print-hide"></div>
    
    <header class="p-4 md:p-6 bg-gradient-to-r from-[var(--background-light)] via-[var(--background-accent)] to-[var(--background-light)] bg-opacity-90 backdrop-blur-lg border-b border-[var(--border-color)] print-hide shadow-xl">
        <div class="container mx-auto flex flex-col xl:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-6">
                <a href="#" id="logo-link" class="flex items-center gap-3 transition-opacity duration-300 hover:opacity-80 nav-link nav-loading">
                    <span class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-sky-400 via-blue-500 to-indigo-600">GECAN™</span>
                    <div class="w-1 h-12 bg-gradient-to-b from-sky-400 to-indigo-600 rounded-full"></div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">XDealFlow Intelligent Toolkits</h1>
                </a>
            </div>
            <div id="nav-container" class="flex items-center gap-3 bg-[var(--background-dark)] bg-opacity-50 backdrop-blur-sm border border-[var(--border-color)] p-2 rounded-xl">
                <a href="#" id="home-nav-link" class="btn-secondary text-sm font-medium px-4 py-2 rounded-lg transition-all duration-300 nav-link nav-loading"><i class="fas fa-tachometer-alt mr-2"></i>XDealFlow</a>
                <a href="#" id="toolkits-nav-link" class="btn-secondary text-sm font-medium px-4 py-2 rounded-lg transition-all duration-300 nav-link nav-loading"><i class="fas fa-tools mr-2"></i>Toolkits</a>
                <a href="#" id="architect-link" class="btn-secondary text-sm font-medium px-4 py-2 rounded-lg transition-all duration-300 nav-link nav-loading"><i class="fas fa-cogs mr-2"></i>Architect Wizard</a>
                <a href="#" id="intelligence-link" class="btn-secondary text-sm font-medium px-4 py-2 rounded-lg transition-all duration-300 nav-link nav-loading"><i class="fas fa-sitemap mr-2"></i>Network Intelligence</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-color"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6"><div class="w-16 h-16 border-4 border-primary-color border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-color opacity-20"></div></div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2><p class="text-text-secondary">Loading institutional-grade analytics...</p><div class="mt-6 flex justify-center"><div class="loading-shimmer h-2 w-64 rounded-full"></div></div>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    <div id="print-area">
    <div id="print-content"></div>
</div>
    <dialog id="imfpa-modal" class="p-0 bg-transparent max-w-7xl w-full print-hide">
        <div id="imfpa-modal-content" class="glass rounded-2xl w-full flex flex-col max-h-[90vh]"></div>
    </dialog>

    <!-- ADD THIS NEW DIALOG FOR THE SIGNATURE SUITE -->
<!-- SEVERELY UPGRADED SIGNATURE SUITE DIALOG WITH TARGETING & MULTI-SIGNATURE CAPABILITY -->
<!-- SEVERELY UPGRADED SIGNATURE SUITE DIALOG WITH TARGETING & MULTI-SIGNATURE CAPABILITY -->
<dialog id="signature-modal" class="p-0 bg-transparent max-w-2xl w-full print-hide">
    <div id="signature-modal-content" class="glass rounded-2xl w-full flex flex-col max-h-[95vh] text-white" style="--glow-color: var(--success-color);">
        <!-- Modal Header & Signatory Selection -->
        <div class="p-6 border-b border-[var(--premium-border)]">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                    <p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p>
                </div>
                <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">×</button>
            </div>
            <!-- NEW: SIGNATORY SELECTION DROPDOWN -->
            <div>
                <label for="signature-target-select" class="block text-sm font-semibold text-text-secondary mb-2">Apply signature/seal for:</label>
                <select id="signature-target-select" class="form-select w-full bg-[var(--premium-bg-dark)] border-[var(--premium-border)] text-white"></select>
            </div>
        </div>

        <!-- Signing Area & Tabs -->
        <div class="p-6 flex-grow overflow-y-auto">
            <div class="flex border-b border-[var(--premium-border)] mb-4">
                <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                <!-- UPGRADED: Tab for Corporate Seal -->
                <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
            </div>
            <!-- Draw Canvas -->
            <div id="draw-mode-panel"><canvas id="signature-canvas" class="bg-[var(--premium-bg-dark)] border border-[var(--premium-border)] rounded-lg w-full h-48 cursor-crosshair"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
            <!-- Upload Panel -->
            <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--premium-border)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--premium-bg-light)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload your signature image</p></div></label></div>
            <!-- UPGRADED: Seal Upload Panel -->
            <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--premium-border)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--premium-bg-light)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import a corporate seal file</p></div></label></div>
        </div>
        
        <!-- Footer & Action Button -->
        <div class="p-6 border-t border-[var(--premium-border)] bg-[var(--premium-bg-dark)]"><div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div><button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500" style="--glow-color: var(--success-color);"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button></div>
    </div>
</dialog>

    <!-- ==================================================================================== -->
    <!-- === PREMIUM NOTIFICATION MODAL (v5.1 - UNIVERSAL REPLACEMENT) === -->
    <!-- ==================================================================================== -->
    <dialog id="notification-modal" class="p-0 bg-transparent max-w-lg w-full print-hide">
        <div id="notification-modal-content" class="glass rounded-2xl w-full flex flex-col text-white">
            <!-- Dynamic Header: Color changes based on message type -->
            <div id="notification-header" class="p-6 flex items-center gap-4 border-b border-[var(--premium-border)]">
                <div id="notification-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                    <i id="notification-icon" class="fas fa-2x"></i>
                </div>
                <div>
                    <h2 id="notification-title" class="text-2xl font-bold">Notification</h2>
                    <p id="notification-subtitle" class="text-sm text-text-secondary">Please review this message.</p>
                </div>
            </div>

            <!-- Dynamic Content -->
            <div class="p-8 flex-grow">
                <p id="notification-message" class="text-text-secondary leading-relaxed">Message content goes here.</p>
            </div>
            
            <!-- Footer & Action -->
            <div class="p-6 border-t border-[var(--premium-border)] bg-[var(--premium-bg-dark)]/50 flex justify-end">
                <button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg">OK</button>
            </div>
        </div>
    </dialog>

    <!-- ==================================================================================== -->
    <!-- === PREMIUM FINALIZATION CONFIRMATION MODAL (v5.0 - SECURE AESTHETIC) === -->
    <!-- ==================================================================================== -->
    <dialog id="finalization-modal" class="p-0 bg-transparent max-w-xl w-full print-hide">
        <div id="finalization-modal-content" class="glass rounded-2xl w-full flex flex-col text-white" style="--glow-color: var(--accent-color);">
            <!-- Modal Header -->
            <div class="p-6 flex items-center gap-4 border-b border-[var(--premium-border)] bg-[var(--premium-bg-dark)]/50">
                <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-500 to-indigo-600 shadow-lg">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Finalize & Lock Document</h2>
                    <p class="text-sm text-text-secondary">Please confirm this critical action.</p>
                </div>
                 <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors ml-auto">×</button>
            </div>

            <!-- Modal Content -->
            <div class="p-8 flex-grow">
                <p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action is irreversible and will:</p>
                <ul class="space-y-4 text-text-primary">
                    <li class="flex items-start gap-3">
                        <i class="fas fa-lock text-purple-400 mt-1"></i>
                        <div><strong>Lock Document State:</strong> The current version of the contract will be cryptographically fingerprinted to prevent future edits.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-project-diagram text-purple-400 mt-1"></i>
                        <div><strong>Generate Secure Workflow:</strong> An immutable audit trail will be created, and the system will prepare to track all subsequent actions.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="fas fa-paper-plane text-purple-400 mt-1"></i>
                        <div><strong>Dispatch Signing Links:</strong> Unique, secure signing links will be sent to all parties who have not yet signed.</div>
                    </li>
                </ul>
            </div>
            
            <!-- Modal Footer & Actions -->
            <div class="p-6 border-t border-[var(--premium-border)] bg-[var(--premium-bg-dark)]/50 flex justify-end items-center gap-4">
                <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-red-500/30 px-8 py-2 font-bold shadow-lg shadow-purple-500/20">
                    <i class="fas fa-gavel mr-2"></i>Proceed
                </button>
            </div>
        </div>
    </dialog>

    <script>
        // --- SECTION 1: STATE & MODELS ---
        // SEVERE UPGRADE: Centralized, authoritative classifier for all swappable digital assets.
        // This ensures profound accuracy by including not just cryptocurrencies but also stablecoins
        // and digital representations of real-world assets like gold. This is the single source of truth.
        
        
        
        
        const AppState = {
            isInitialized: false, 
            baseUrl: '', 
            activeToolkit: 'Dashboard', 
            marketData: [],

            // SEVERE UPGRADE: The 'Crypto Swap' toolkit is now architecturally and descriptively
            // elevated to 'Asset Swap' to reflect its universal conversion capabilities.
            toolkits: {
                Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Overview of all available institutional tools.', color: 'from-blue-500 to-purple-600' },
                WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Advanced wallet due diligence and risk assessment.', color: 'from-red-500 to-orange-600' },
                InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler', icon: 'fa-sitemap', description: 'Model complex institutional deals and generate contracts.', color: 'from-sky-500 to-indigo-600' },
            },
            walletAnalysis: { address: null, report: null, isLoading: false },
            
            modeler: {
                // DEFINITIVE FIX: The default active deal type is now 'AssetSwap'.
                activeDealType: 'AssetSwap', 
                
                // The state key is renamed from 'cryptoSwap' to 'assetSwap' for profound accuracy.
                assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
                
                // REPLACE the old `commodityTrade` object with this severely upgraded version.
                
                commodityTrade: {
    assetKey: 'WTI-BBL-USD',
    quantity: 100000,
    unitOfMeasure: 'Barrel',
    qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%',
    origin: 'United States',
    port: 'Houston',
    incoterms: 'FOB',
    procedures: `• Standard TTV (Tank-to-Vessel) Procedures
• Inspection by SGS, Intertek, or equivalent at loading port.
• Seller provides CIQ (or equivalent) for customs clearance.
• Buyer issues Dip Test Authorization (DTA) upon successful documentary review.
• Payment via Irrevocable Documentary Letter of Credit (IDLC) from a prime bank.`,
    pricingModel: 'Discount', // Can be 'Fixed' or 'Premium'
    fixedPrice: 0,
    discountPremiumValue: 0, // Represents the value for discount/premium
    settlementAssetKey: 'USD', // Default settlement currency
},
                cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                sblcMonetization: { faceValue: 100000000, ltv: 80 },
                
                // Defaults are correctly set to 0.
                pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                
                // Starts with a clean slate.
                                legal: {
                    isModalOpen: false,
                    jurisdiction: 'Singapore, Dubai, England, Wales',
                    totalCommission: 0,
                    spaReferenceCode: '', // <-- ADD THIS NEW LINE
                    groups: []
                }
            }
        };

        // --- SECTION 2: GOOGLE APPS SCRIPT INTERFACE ---
        const GAS = {
            run: (functionName, ...args) => new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[functionName](...args);
            })
        };

        // --- SECTION 3: UTILITIES ---
        const Utils = {
            showError: (containerId, title, message) => {
                const el = document.getElementById(containerId);
                if (el) { el.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 glass rounded-2xl animate-scale-in"><div class="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center mb-6"><i class="fas fa-exclamation-triangle fa-2x text-red-500"></i></div><h3 class="text-2xl font-bold text-white mb-3">${title}</h3><p class="text-text-secondary max-w-md leading-relaxed">${message}</p><button onclick="location.reload()" class="btn-primary mt-6 px-6 py-2 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry</button></div>`; }
            },
            formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
            formatNumber: (num, decimals = 2) => {
                if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T';
                if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
                if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
                return (num||0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            },
            debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
            getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
            getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
            calculateTimeAgo: (timestamp) => { const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000); if (diffMins < 60) return `${diffMins}m ago`; const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`; const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`; return new Date(timestamp).toLocaleDateString(); },
            getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
        };

        // ================== START: INSERT THE STANDALONE DATA LAYER HERE ==================
        const commodityData = {
            unitsOfMeasure: ['MT', 'BBL', 'GAL', 'LBS', 'T', 'OZ', 'MMBtu'],
            incoterms: [
                { value: 'FOB', label: 'FOB (Free On Board)' },
                { value: 'CIF', label: 'CIF (Cost, Insurance, and Freight)' },
                { value: 'TTV', label: 'TTV (Tank-to-Vessel)' },
                { value: 'TTT', label: 'TTT (Tank-to-Tank)' },
                { value: 'DDP', label: 'DDP (Delivered Duty Paid)' },
                { value: 'EXW', label: 'EXW (Ex Works)' },
                { value: 'CFR', label: 'CFR (Cost and Freight)' }
            ],
            countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia', 'Norway'],
            specifications: {
                'WTI-BBL-USD': { uom: 'BBL', spec: 'API Gravity: 40-42, Sulfur Content: <0.42%', incoterm: 'FOB', origin: 'USA' },
                'EN590-MT-USD': { uom: 'MT', spec: 'Sulphur: 10ppm max, Density @ 15°C: 820-845 kg/m³', incoterm: 'CIF', origin: 'Non-Sanctioned' },
                'D2-MT-USD': { uom: 'MT', spec: 'Sulphur 0.2% Max, Flash Point: 61°C Min', incoterm: 'CIF', origin: 'Non-Sanctioned' },
                'JET-A1-BBL-USD': { uom: 'BBL', spec: 'Flash Point: 38°C min, Freezing Point: -47°C max', incoterm: 'CIF', origin: 'Non-Sanctioned' },
                'LNG-MMBtu-USD': { uom: 'MMBtu', spec: 'Gross Heating Value: ~1,100 Btu/scf', incoterm: 'FOB', origin: 'Qatar' },
                'XAU-OZ-USD': { uom: 'OZ', spec: 'Fineness: 999.9/1000 (24 Karat), LBMA Certified', incoterm: 'DDP', origin: 'Switzerland' }
            }
        };
// =================== END: INSERT THE STANDALONE DATA LAYER HERE ===================

        // --- SECTION 4: UI RENDERERS ---
        const UI = {
            init: () => {
                if (typeof particlesJS !== 'undefined') {
                    particlesJS('particles-js', {"particles":{"number":{"value":50},"color":{"value":["#0ea5e9","#6366f1","#8b5cf6"]},"opacity":{"value":0.6,"random":true},"size":{"value":3,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#475569","opacity":0.4},"move":{"enable":true,"speed":1,"random":true,"out_mode":"out"}},"interactivity":{"events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"}}}});
                }
            },
            renderToolkitMenu: () => {
                document.getElementById('toolkit-menu').innerHTML = Object.values(AppState.toolkits).map(t => `
                    <button onclick="Logic.setActiveToolkit('${t.id}')" class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${AppState.activeToolkit === t.id ? 'bg-gradient-to-r from-primary-color to-primary-dark text-white shadow-lg shadow-primary-color/20' : 'text-text-secondary hover:bg-gradient-to-r hover:from-background-card hover:to-background-accent hover:text-white'}">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center group-hover:scale-110 transition-transform duration-300"><i class="fas ${t.icon} text-white"></i></div>
                        <div class="flex-1"><div class="font-semibold">${t.name}</div><div class="text-xs opacity-75 mt-1">${t.description.split('.')[0]}</div></div>
                        <i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity"></i>
                    </button>`).join('');
            },
            renderActiveToolkit: () => {
                const container = document.getElementById('active-toolkit-container');
                const renderFunc = UI[`render${AppState.activeToolkit}UI`];
                if (renderFunc) { container.innerHTML = renderFunc(); container.classList.remove('hidden'); Logic.bindActiveToolkitEvents(); } 
                else { Utils.showError('active-toolkit-container', 'Toolkit Not Found', `UI for '${AppState.activeToolkit}' not implemented.`); }
                UI.renderToolkitMenu();
            },
            renderDashboardUI: () => `
                <div class="glass rounded-2xl p-8 h-full flex flex-col animate-fade-in-up">
                    <div class="text-center mb-12"><h2 class="text-4xl font-bold gradient-text mb-4">GECAN™ Intelligent Toolkits</h2><p class="text-text-secondary text-lg max-w-2xl mx-auto leading-relaxed">Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                        ${Object.values(AppState.toolkits).filter(t => t.id !== 'Dashboard').map((t, index) => `<div class="report-section p-8 cursor-pointer group animate-scale-in stagger-${index + 1}" onclick="Logic.setActiveToolkit('${t.id}')"><div class="flex items-start gap-6"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform duration-300 ease-in-out"><i class="fas ${t.icon}"></i></div><div class="flex-1"><h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-color transition-colors">${t.name}</h3><p class="text-text-secondary leading-relaxed">${t.description}</p><div class="mt-4 flex items-center text-primary-color opacity-0 group-hover:opacity-100 transition-opacity duration-300"><span class="text-sm font-medium">Launch Toolkit</span><i class="fas fa-arrow-right ml-2"></i></div></div></div></div>`).join('')}
                    </div>
                </div>
            `,
            
            // ===== START: STRICTLY RETAINED WALLET FORENSICS UI =====
            renderWalletForensicsUI: () => {
                const { address, isLoading, report } = AppState.walletAnalysis;
                let contentHTML = '';
                if (isLoading) contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center animate-fade-in-up"><div class="relative mb-8"><div class="w-24 h-24 border-4 border-primary-color border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-color opacity-20"></div></div><h3 class="text-2xl font-bold text-white mb-4">Analyzing Wallet</h3><p id="spinner-text" class="text-text-secondary mb-6">Initializing analysis...</p><div class="w-64 h-2 bg-background-card rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-primary-color to-secondary-color loading-shimmer"></div></div></div>`;
                else if (report?.error) contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-scale-in"><div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8"><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i></div><h3 class="text-2xl font-bold text-white mb-4">Analysis Failed</h3><p class="text-text-secondary max-w-md leading-relaxed">${report.error.message}</p><button onclick="Logic.runWalletForensics()" class="btn-primary mt-6 px-6 py-3 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry Analysis</button></div>`;
                else if (report) contentHTML = UI.buildWalletReportHTML(report);
                else contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center glass rounded-2xl border-2 border-dashed border-border-color animate-fade-in-up"><div class="w-24 h-24 rounded-full bg-primary-color/10 flex items-center justify-center mb-8 animate-float"><i class="fas fa-search fa-3x text-primary-color"></i></div><h3 class="text-2xl font-bold text-white mb-4">Ready for Analysis</h3><p class="text-text-secondary max-w-md leading-relaxed mb-2">Enter a wallet address to begin comprehensive due diligence analysis.</p><p class="text-xs text-text-muted">Powered by GECAN Proprietary Heuristic Engine v5.0</p></div>`;
                return `<div class="glass rounded-2xl p-0 h-full flex flex-col animate-fade-in-up"><div class="p-8 border-b border-glass-border"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center"><i class="fas fa-shield-alt text-white fa-lg"></i></div><div><h2 class="text-3xl font-bold text-white">Wallet Due Diligence & Provenance</h2><p class="text-text-secondary">Advanced blockchain forensics and risk assessment</p></div></div><div class="flex items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" class="btn-primary font-bold py-4 px-8 rounded-xl whitespace-nowrap"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto">${contentHTML}</div></div>`;
            },
            buildWalletReportHTML: (report) => {
    const { metadata, wallet, analysis, provenance, transactions } = report;
    const { walletClassification, redFlags, riskLevel, integrityScore, scoreBreakdown, behaviorProfile } = analysis;
    const riskClass = `risk-${riskLevel}`;

    // --- SINGLE SOURCE OF TRUTH FOR ALL TRANSACTION COUNTS & DERIVED METRICS ---
    // All counts and metrics are derived *once* from the definitive transactions array,
    // ensuring perfect consistency and accuracy across the entire report.
    const reliableTransactionCount = Array.isArray(transactions) ? transactions.length : 0;
    const inboundCount = Array.isArray(transactions) ? transactions.filter(tx => tx.type === 'Receive').length : 0;
    const outboundCount = Array.isArray(transactions) ? transactions.filter(tx => tx.type === 'Send').length : 0;
    const lastActivityDate = reliableTransactionCount > 0 ? new Date(transactions[0].time) : null;
    const daysSinceLastTx = lastActivityDate ? Math.floor((new Date() - lastActivityDate) / (1000 * 60 * 60 * 24)) : 'N/A';
    const transactionVelocity = wallet.ageInDays > 0 ? (reliableTransactionCount / wallet.ageInDays).toFixed(2) : 0;

    // --- Dynamic Header Tags ---
    let headerTags = [];
    if (provenance.records.length > 0) {
        headerTags.push({ text: 'GECAN LEDGER MATCH', class: 'bg-success-color/20 text-success-color' });
    } else {
        headerTags.push({ text: 'UNVERIFIED IN LEDGER', class: 'bg-warning-color/20 text-warning-color' });
    }
    headerTags.push({ text: `${riskLevel} RISK`, class: `bg-risk-color text-risk-color ${riskClass}` });
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN'))];
    if (uniqueControllers.length > 1) {
        headerTags.push({ text: 'OWNERSHIP CONFLICT', class: 'bg-critical-color/20 text-critical-color' });
    }
    if (walletClassification.type === 'BLACKLISTED') {
         headerTags.push({ text: 'BLACKLISTED', class: 'bg-critical-color/20 text-critical-color' });
    }

    // --- Severely Upgraded Score Gauge Helper v8.1 ---
    const createScoreGauge = (score, label, size = 'w-40 h-40', isMain = false) => {
        let scoreClass = 'gauge-low';
        if (score < 40) { scoreClass = 'gauge-critical'; }
        else if (score < 65) { scoreClass = 'gauge-high'; }
        else if (score < 80) { scoreClass = 'gauge-medium'; }

        return `
        <div class="text-center animate-scale-in">
            <div class="relative ${size} mx-auto mb-3 transition-transform duration-300 hover:scale-105">
                <svg viewBox="0 0 36 36" class="w-full h-full">
                    <defs>
                        <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%" gradientTransform="rotate(90)">
                            <stop offset="0%" stop-color="var(--critical-color)" />
                            <stop offset="65%" stop-color="var(--warning-color)" />
                            <stop offset="100%" stop-color="var(--success-color)" />
                        </linearGradient>
                    </defs>
                    <circle cx="18" cy="18" r="15.9155" class="score-gauge-bg" fill="none"></circle>
                    <circle cx="18" cy="18" r="15.9155" class="score-gauge-fg" fill="none" stroke="url(#scoreGradient)" stroke-width="3" stroke-dasharray="0, 100" data-score="${score}"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="score-display ${isMain ? 'text-5xl' : 'text-3xl'} font-black transition-colors duration-500 ${scoreClass}">${Math.round(score)}</span>
                    ${isMain ? `<span class="text-xs font-bold -mt-1 ${scoreClass}">/ 100</span>` : ''}
                </div>
            </div>
            <p class="text-sm font-semibold text-white">${label}</p>
        </div>`;
    };

    // --- Severely Upgraded Transaction Ledger Helper ---
    const createTransactionLedgerHTML = (transactions, walletType, walletAddress) => {
        if (reliableTransactionCount === 0) {
            return `<div class="text-center text-text-muted py-12"><i class="fas fa-exchange-alt fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No On-Chain Transactions Found</p></div>`;
        }
        const currency = walletType === 'BITCOIN' ? 'BTC' : 'USDT';
        return `
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Total Txs</p><p class="text-xl font-bold text-white">${reliableTransactionCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Inbound</p><p class="text-xl font-bold text-success-color">${inboundCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Outbound</p><p class="text-xl font-bold text-error-color">${outboundCount.toLocaleString()}</p></div>
            </div>
            <div id="transaction-ledger" class="space-y-3 max-h-[28rem] overflow-y-auto pr-2">${transactions.map((tx, index) => { const isInbound = tx.type === 'Receive'; return `<div class="transaction-item glass p-3 rounded-lg flex items-center justify-between gap-4 animate-fade-in-up ${isInbound ? 'transaction-inbound' : 'transaction-outbound'}" style="animation-delay: ${index * 20}ms"><div class="flex items-center gap-3 min-w-0"><div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isInbound ? 'bg-success-color/10 text-success-color' : 'bg-error-color/10 text-error-color'}"><i class="fas ${isInbound ? 'fa-arrow-down' : 'fa-arrow-up'}"></i></div><div class="min-w-0"><a href="${Logic.getExplorerUrl({type: walletType, address: walletAddress}, tx.hash)}" target="_blank" class="font-mono text-sm text-white truncate block hover:underline" title="View Transaction: ${tx.hash}">${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}</a><p class="text-xs text-text-muted">${Utils.calculateTimeAgo(tx.time)}</p></div></div><div class="text-right flex-shrink-0"><p class="font-mono font-semibold text-base ${isInbound ? 'text-success-color' : 'text-error-color'}">${isInbound ? '+' : '-'}${Utils.formatNumber(tx.amount, 6)} <span class="text-xs text-text-muted">${currency}</span></p></div></div>` }).join('')}</div>
            <button id="show-more-tx-btn" class="hidden w-full mt-4 btn-secondary text-xs py-2 rounded-lg">Show All <span id="hidden-tx-count"></span> More Transactions</button>`;
    };
    
    // --- SEVERE UPGRADE v9.5: UNIVERSAL HARDENED COMPLIANCE ENGINE ---
    const createComplianceCheckHTML = () => {
        // --- HARDENED INSTITUTIONAL RULES ---
        const INST_USDT_BALANCE_REQ = 20000000;
        const INST_USDT_TX_REQ = 100;
        const INST_BTC_BALANCE_REQ = 1000;
        const INST_BTC_TX_REQ = 150;

        let balanceCheck, txCheck, hardRulesMet, title;
        const isLowRisk = riskLevel === 'LOW';

        if (wallet.type === 'BITCOIN') {
            title = 'Institutional Compliance (Bitcoin)';
            balanceCheck = { met: wallet.balance > INST_BTC_BALANCE_REQ, value: wallet.balance, threshold: INST_BTC_BALANCE_REQ, text: `> ${INST_BTC_BALANCE_REQ.toLocaleString()} BTC Balance` };
            txCheck = { met: reliableTransactionCount < INST_BTC_TX_REQ, value: reliableTransactionCount, threshold: INST_BTC_TX_REQ, text: `< ${INST_BTC_TX_REQ} Transactions` };
        } else if (wallet.type === 'ETHEREUM' || wallet.type === 'TRON') {
            title = 'Institutional Compliance (USDT)';
            balanceCheck = { met: wallet.balance > INST_USDT_BALANCE_REQ, value: wallet.balance, threshold: INST_USDT_BALANCE_REQ, text: `> $${Utils.formatNumber(INST_USDT_BALANCE_REQ)} USDT` };
            txCheck = { met: reliableTransactionCount < INST_USDT_TX_REQ, value: reliableTransactionCount, threshold: INST_USDT_TX_REQ, text: `< ${INST_USDT_TX_REQ} Transactions` };
        } else {
            return `<div class="text-center text-text-muted py-8"><i class="fas fa-info-circle fa-2x mb-3"></i><p class="font-semibold text-text-secondary text-sm">Compliance checks are not applicable for this asset type.</p></div>`;
        }

        hardRulesMet = balanceCheck.met && txCheck.met;

        const checkItem = (check) => {
            const isBalance = check.text.toLowerCase().includes('balance');
            const displayValue = isBalance ? Utils.formatPrice(check.value, wallet.type === 'BITCOIN' ? 'BTC' : 'USD').replace('$', '') : check.value.toLocaleString();
            const displayThreshold = isBalance ? Utils.formatPrice(check.threshold, wallet.type === 'BITCOIN' ? 'BTC' : 'USD').replace('$', '') : check.threshold.toLocaleString();

            return `<div class="flex items-center justify-between p-3 rounded-lg ${check.met ? 'bg-success-color/10' : 'bg-critical-color/10'}"><div class="flex items-center gap-3"><i class="fas ${check.met ? 'fa-check-circle text-success-color' : 'fa-times-circle text-critical-color'} fa-lg"></i><span class="font-semibold ${check.met ? 'text-white' : 'text-critical-color'}">${check.text}</span></div><div class="text-right"><span class="font-mono text-sm ${check.met ? 'text-text-secondary' : 'text-critical-color'}">${displayValue}</span><span class="font-mono text-xs text-text-muted"> / ${displayThreshold}</span></div></div>`;
        };
        
        let overallStatus;
        if (hardRulesMet && isLowRisk) {
            overallStatus = { text: 'COMPLIANT', class: 'text-success-color', icon: 'fa-shield-alt' };
        } else if (!hardRulesMet) {
            overallStatus = { text: 'NON-COMPLIANT', class: 'text-critical-color', icon: 'fa-exclamation-triangle' };
        } else {
            overallStatus = { text: 'COMPLIANT (WITH FLAGS)', class: 'text-warning-color', icon: 'fa-exclamation-circle' };
        }

        return `<div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold text-white flex items-center gap-3"><i class="fas fa-university text-secondary-color"></i>${title}</h3><div class="flex items-center gap-3"><i class="fas ${overallStatus.icon} ${overallStatus.class} text-xl"></i><p class="text-lg font-bold ${overallStatus.class}">${overallStatus.text}</p></div></div><div class="space-y-3">${checkItem(balanceCheck)}${checkItem(txCheck)}</div>`;
    };

    // --- Balanced Risk Assessment Renderer ---
    const createRiskAssessmentHTML = () => {
        if (redFlags.length > 0) {
            return `<div class="space-y-4 max-h-[28rem] overflow-y-auto pr-2">${redFlags.map(flag => `<div class="glass p-4 rounded-xl border-l-4 ${'risk-' + flag.level} border-risk-color"><div class="flex items-start gap-4"><i class="fas ${Utils.getRiskIcon(flag.level)} text-risk-color text-xl mt-1"></i><div><p class="font-bold text-risk-color">${flag.title}</p><p class="text-sm text-text-secondary mt-1">${flag.details}</p></div></div></div>`).join('')}</div>`;
        }
        const positiveIndicator = (icon, title, details) => `<div class="glass p-4 rounded-xl border-l-4 border-success-color"><div class="flex items-start gap-4"><i class="fas ${icon} text-success-color text-xl mt-1"></i><div><p class="font-bold text-success-color">${title}</p><p class="text-sm text-text-secondary mt-1">${details}</p></div></div></div>`;
        let indicatorsHTML = '';
        if (wallet.ageInDays > 730) { indicatorsHTML += positiveIndicator('fa-calendar-check', 'Established History', `Wallet has been active for over ${Math.floor(wallet.ageInDays / 365)} years, indicating stability.`); }
        if (provenance.records.length > 0 && uniqueControllers.length === 1) { indicatorsHTML += positiveIndicator('fa-user-check', 'Consistent Ownership Record', `A single controller is consistently reported in the GECAN Ledger, reducing ownership risk.`); }
        if (reliableTransactionCount > 0 && outboundCount === 0) { indicatorsHTML += positiveIndicator('fa-arrow-alt-circle-down', 'Clear Accumulation Pattern', `The wallet has only received funds, a strong indicator of a holding or accumulation strategy.`); }
        if (indicatorsHTML === '') { return `<div class="text-center text-text-muted py-12"><i class="fas fa-check-circle text-success-color fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No Significant Compliance Flags or Standout Positive Indicators Detected</p></div>`; }
        return `<div class="space-y-4">${indicatorsHTML}</div>`;
    };

    // --- Transaction Flow Analysis for Wallet Classification ---
    let flowProfile = { text: 'Balanced Flow', class: 'text-text-secondary' };
    if (reliableTransactionCount > 5) { const inOutRatio = outboundCount > 0 ? inboundCount / outboundCount : inboundCount; if (outboundCount === 0 && inboundCount > 0) { flowProfile = { text: 'Accumulation / Deposit-Only', class: 'text-success-color' }; } else if (inboundCount === 0 && outboundCount > 0) { flowProfile = { text: 'Distribution / Spend-Only', class: 'text-error-color' }; } else if (inOutRatio > 5) { flowProfile = { text: 'Primarily Accumulation', class: 'text-success-color' }; } else if (inOutRatio < 0.2) { flowProfile = { text: 'Primarily Distribution', class: 'text-error-color' }; } }
    
    return `
        <div class="animate-fade-in-up">
            <!-- REPORT HEADER -->
            <div class="mb-8"><div class="glass p-5 rounded-2xl flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-4"><div class="flex-1 min-w-0"><div class="flex items-center gap-3"><i class="fas fa-wallet text-2xl text-primary-color"></i><a href="${Logic.getExplorerUrl(wallet)}" target="_blank" class="font-mono text-lg text-white truncate hover:underline" title="View on Explorer: ${wallet.address}">${wallet.address}</a><button onclick="Logic.copyToClipboard('${wallet.address}', this)" class="text-text-muted hover:text-white relative group"><i class="fas fa-copy"></i><span class="copied-feedback absolute -top-8 left-1/2 -translate-x-1/2 text-xs bg-success-color text-white px-2 py-1 rounded-md opacity-0 transition-all pointer-events-none">Copied!</span></button></div><div class="flex flex-wrap items-center gap-2 mt-2">${headerTags.map(tag => `<span class="text-xs font-bold px-3 py-1 rounded-full ${tag.class}">${tag.text}</span>`).join('')}</div></div><div class="flex-shrink-0 flex gap-2"><button id="pdf-print-btn" onclick="Logic.initiatePdfGeneration()" class="btn-primary px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button></div></div></div>
            
            <!-- MAIN DASHBOARD GRID V9.5 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- MAIN CONTENT COLUMN (LEFT) -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-file-invoice text-primary-color"></i>Institutional Executive Summary</h3><p class="text-text-secondary leading-relaxed">${Logic.generateExecutiveSummary(report)}</p></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-2">${createComplianceCheckHTML()}</div>
                    <div class="report-section p-6 animate-fade-in-up stagger-3"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-flag text-warning-color"></i>Compliance & Risk Assessment (${redFlags.length > 0 ? redFlags.length + ' Flags' : 'Positive Indicators'})</h3>${createRiskAssessmentHTML()}</div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-exchange-alt text-teal-400"></i>On-Chain Transaction Ledger</h3>${createTransactionLedgerHTML(transactions, wallet.type, wallet.address)}</div>
                </div>

                <!-- SIDEBAR COLUMN (RIGHT) -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-6 text-center">Scoring Dashboard</h3>${createScoreGauge(integrityScore, 'Overall Integrity Score', 'w-40 h-40', true)}<div class="mt-8 border-t border-border-color pt-6 grid grid-cols-2 gap-6">${createScoreGauge(scoreBreakdown.provenance.score, 'Provenance', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.behavioral.score, 'Behavioral', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.temporal.score, 'Temporal', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.compliance.score, 'Compliance', 'w-28 h-28')}</div></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-2"><h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-microchip text-accent-color"></i>Wallet Classification</h3><div class="text-center p-4 glass rounded-xl"><i class="fas ${walletClassification.icon} fa-3x mb-3 text-primary-color"></i><p class="text-2xl font-bold text-white">${walletClassification.type}</p><p class="font-semibold mt-1 ${flowProfile.class}">${flowProfile.text}</p><div class="mt-2 text-xs text-text-muted">Confidence: <span class="font-semibold text-text-secondary">${walletClassification.confidence}</span> | Source: <span class="font-semibold text-text-secondary">${walletClassification.source}</span></div></div></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-3"><h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-cogs text-secondary-color"></i>Enriched Wallet Intel</h3><dl class="space-y-3 text-sm"><div class="flex justify-between items-center"><dt class="text-text-muted">Balance (USDT/Eq.)</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${Utils.formatNumber(wallet.balance)}</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Total Transactions</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${reliableTransactionCount.toLocaleString()}</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Last Activity</dt><dd class="font-semibold text-white">${daysSinceLastTx} days ago</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Tx Velocity</dt><dd class="font-semibold text-white">${transactionVelocity} tx/day</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Wallet Age</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${wallet.ageInDays} Days</dd></div></dl></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-history text-accent-color"></i>GECAN Provenance Timeline</h3><div class="relative">${provenance.records.length > 0 ? provenance.records.map((rec) => `<div class="timeline-item"><div class="timeline-dot"><div class="timeline-dot-inner ${uniqueControllers.length > 1 ? 'bg-critical-color' : 'bg-primary-color'}"></div></div><p class="text-xs font-mono text-text-muted mb-1">${rec.date}</p><p class="font-semibold text-white">Controller: <span class="text-primary-color">${rec.controller}</span></p></div>`).join('') : `<div class="text-center text-text-muted py-8"><i class="fas fa-question-circle text-warning-color fa-2x mb-3"></i><p class="font-semibold text-text-secondary text-sm">No GECAN Ledger Records</p></div>`}</div></div>
                </div>
            </div>
        </div>
    `;
},
            // ===== END: STRICTLY RETAINED WALLET FORENSICS UI =====
            
                        // ===== START: SEVERELY UPGRADED INSTITUTIONAL MODELER UI v37.1 =====
                        renderInstitutionalModelerUI: () => {
                // SEVERE UPGRADE: The deal types are now perfectly aligned with the application state.
                // The 'id' is corrected to 'AssetSwap', and descriptions are elevated for profound accuracy.
                const dealTypes = [
                    { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between any two priced assets in the GECAN matrix, from crypto to commodities.', gradient: 'from-blue-500 to-cyan-500' },
                    { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades, including crude oil, refined fuels, and precious metals.', gradient: 'from-yellow-500 to-orange-500' },
                    { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate and manage crypto-collateralized credit facilities with flexible LTV and term structures.', gradient: 'from-green-500 to-emerald-500' },
                    { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit (SBLC) and other bank instruments to unlock working capital.', gradient: 'from-purple-500 to-violet-500' },
                ];
                return `<div class="flex flex-col gap-8 animate-fade-in-up">
                    <div class="report-section p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-color mr-3"></i>Select Institutional Deal Type</h2>
                            <button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-error-color/20 hover:border-error-color/50 hover:text-error-color whitespace-nowrap"><i class="fas fa-undo mr-2"></i>Reset All</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map((deal, index) => `
                            <div class="deal-type-card animate-scale-in stagger-${index + 1} ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')">
                                <div class="deal-type-icon-container w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl">
                                    <i class="fas ${deal.icon} deal-type-icon"></i>
                                </div>
                                <h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p>
                            </div>`).join('')}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative">
                        <div id="modeler-input-container" class="lg:col-span-3 input-panel p-6 md:p-8 flex flex-col panel-transition"></div>
                        <div id="modeler-output-container" class="lg:col-span-2 output-panel p-6 md:p-8 flex flex-col panel-transition"></div>
                    </div>
                </div>`;
            },
                        renderModelerInputPanel: () => {
                const { activeDealType, pricingConfig } = AppState.modeler;

                // DEFINITIVE FIX: This renderer now correctly and dynamically constructs the name
                // of the panel function to call (e.g., 'renderAssetSwapPanel') based on the
                // current 'activeDealType' from the application state. This eradicates the
                // "Input panel for CryptoSwap not found" error.
                const dealPanelRenderer = UI[`render${activeDealType}Panel`];
                const dealPanelHTML = dealPanelRenderer ? dealPanelRenderer() : `<p class="text-error-color">Error: Input panel for ${activeDealType} not found.</p>`;

                const pricingConfigHTML = `<div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select data-path="pricingConfig.offerType" class="form-select">${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}</select>
                        <select data-path="pricingConfig.isValueInPercent" class="form-select">${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}</select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label><input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input"></div>
                        <div><label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label><input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input"></div>
                    </div>
                </div>`;

                return `<h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-sliders-h text-primary-color"></i>Deal Parameters</h2>
                    <div class="space-y-6">
                        <div class="input-group"><h4 class="input-group-title"><i class="fas fa-file-contract text-primary-color"></i>Transaction Core</h4><div class="space-y-4">${dealPanelHTML}</div></div>
                        <div class="input-group">
                            <div class="collapsible-header" onclick="Logic.togglePricingConfig()">
                                <h4 class="input-group-title mb-0"><i class="fas fa-percent text-primary-color"></i>Pricing & Configuration</h4>
                                <i class="fas fa-chevron-down chevron ${pricingConfig.isVisible ? 'rotate-180' : ''}"></i>
                            </div>
                            ${pricingConfigHTML}
                        </div>
                    </div>`;
            },
             renderAssetSwapPanel: () => {
                const state = AppState.modeler.assetSwap;

                // DEFINITIVE UPGRADE: The dropdown options are populated by a universal filter.
                // Any asset with a price, which is not a calculated 'Cross-Rate', is included.
                // This is the single source of truth for swappable assets, with no external dependency.
                const assetOptions = (selectedKey) => AppState.marketData
                    .filter(a => a.type !== 'Cross-Rate' && a.price > 0)
                    .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
                
                const fromAsset = Utils.getAssetByKey(state.fromAssetKey);
                return `<div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-text-muted mb-2">From Asset</label>
                                <select data-path="assetSwap.fromAssetKey" class="form-select">${assetOptions(state.fromAssetKey)}</select>
                            </div>
                            <div class="pt-8">
                                <button onclick="Logic.swapAssets()" class="w-10 h-10 flex items-center justify-center rounded-full bg-primary-color/20 text-primary-color hover:bg-primary-color/30 transition-all duration-300">
                                    <i id="swap-icon" class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-text-muted mb-2">To Asset</label>
                                <select data-path="assetSwap.toAssetKey" class="form-select">${assetOptions(state.toAssetKey)}</select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-2">Amount to Swap (<span class="font-bold text-white">${fromAsset.baseAsset || ''}</span>)</label>
                            <input type="text" data-path="assetSwap.amount" value="${state.amount.toLocaleString()}" class="form-input text-lg font-bold">
                        </div>`;
            },
            // FIND AND REPLACE THE ENTIRE `renderCommodityTradePanel` FUNCTION WITH THIS UNABRIDGED FINAL VERSION:

            // FIND AND REPLACE THE ENTIRE `renderCommodityTradePanel` FUNCTION WITH THIS UNABRIDGED FINAL VERSION:

            renderCommodityTradePanel: () => {
    const state = AppState.modeler.commodityTrade;
    
    // --- DEFENSIVE ASSET RETRIEVAL WITH COMPREHENSIVE FALLBACKS ---
    const commodityAsset = AppState.marketData?.find(asset => asset.key === state.assetKey) || 
        { price: 0, baseAsset: 'Unknown', quoteAsset: 'USD', key: '', type: 'Commodity' };
    const settlementAsset = AppState.marketData?.find(asset => asset.key === state.settlementAssetKey) || 
        { price: 1, baseAsset: 'USD', quoteAsset: 'USD', key: 'USD', type: 'Currency' };

    // --- INTELLIGENT STEP VALIDATION WITH PROGRESSIVE LOGIC ---
    const isStep1Complete = !!(state.assetKey && (state.quantity || 0) > 0 && state.unitOfMeasure);
    const isStep2Complete = isStep1Complete && !!(state.origin && state.port && state.incoterms);
    const isStep3Complete = isStep2Complete && !!(
        state.pricingModel && 
        (state.pricingModel === 'Fixed' ? (state.fixedPrice || 0) > 0 : 
         (state.pricingModel === 'Market' || typeof state.discountPremiumValue === 'number'))
    );

    // --- ENHANCED DATA PROVIDERS WITH INSTITUTIONAL-GRADE COVERAGE ---
    const commodityOptions = (selectedKey) => {
        const commodities = AppState.marketData?.filter(asset => 
            ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Metal', 'Commodity', 'Energy', 'Agricultural']
                .some(term => asset.type?.includes(term))) || [];
        const sortedCommodities = commodities.sort((a, b) => a.baseAsset.localeCompare(b.baseAsset));
        return sortedCommodities.map(a => 
            `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.key})</option>`
        ).join('') || '<option value="">No commodities available</option>';
    };

    const settlementOptions = (selectedKey) => {
        const validAssets = AppState.marketData?.filter(a => 
            a.price > 0 && 
            !['Cross-Rate', 'Derivative'].includes(a.type) &&
            a.key !== state.assetKey
        ) || [];
        const sortedAssets = validAssets.sort((a, b) => {
            const priority = { 'USD': 0, 'EUR': 1, 'GBP': 2, 'JPY': 3 };
            return (priority[a.baseAsset] || 999) - (priority[b.baseAsset] || 999);
        });
        return sortedAssets.map(a => 
            `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} ${a.quoteAsset !== a.baseAsset ? `(${a.quoteAsset})` : ''}</option>`
        ).join('') || '<option value="USD">USD</option>';
    };

    // --- COMPREHENSIVE GLOBAL TRADING INFRASTRUCTURE ---
    const majorPorts = [
        'Shanghai', 'Singapore', 'Hong Kong', 'Busan', 'Ningbo-Zhoushan', 'Qingdao', 'Guangzhou',
        'Tianjin', 'Port Kelang', 'Kaohsiung', 'Tokyo', 'Yokohama', 'Kobe', 'Mumbai', 'Chennai',
        'Rotterdam', 'Antwerp', 'Hamburg', 'Amsterdam', 'Le Havre', 'Bremen', 'Valencia',
        'Barcelona', 'Marseille', 'Genoa', 'Naples', 'Piraeus', 'Constanta', 'Gdansk',
        'Los Angeles', 'Long Beach', 'New York', 'Savannah', 'Norfolk', 'Charleston', 'Miami',
        'Houston', 'New Orleans', 'Mobile', 'Vancouver', 'Montreal', 'Santos', 'Buenos Aires',
        'Jebel Ali', 'Doha', 'Kuwait', 'Dammam', 'Sohar', 'Durban', 'Cape Town', 'Lagos',
        'Alexandria', 'Port Said', 'Suez', 'Fujairah', 'Ras Tanura', 'Mongstad', 'Milford Haven'
    ].sort();

    const majorCountries = [
        'United States', 'China', 'Russia', 'Saudi Arabia', 'Canada', 'Brazil', 'Australia', 
        'Norway', 'United Kingdom', 'Germany', 'Japan', 'South Korea', 'India', 'Mexico', 
        'Venezuela', 'Iran', 'Iraq', 'Kuwait', 'UAE', 'Nigeria', 'Algeria', 'Libya', 
        'Kazakhstan', 'Qatar', 'Indonesia', 'Malaysia', 'Angola', 'Ecuador', 'Oman',
        'Netherlands', 'France', 'Italy', 'Spain', 'Belgium', 'Singapore', 'South Africa'
    ].sort();

    // --- COMPREHENSIVE INCOTERMS 2020 WITH RISK ANALYSIS ---
    const incotermsList = [
        { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' },
        { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
        { value: 'CPT', label: 'CPT - Carriage Paid To', port: 'Destination', risk: 'Seller', cost: 'Medium' },
        { value: 'CIP', label: 'CIP - Carriage & Insurance Paid', port: 'Destination', risk: 'Seller', cost: 'High' },
        { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' },
        { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
        { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' },
        { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
        { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
    ];
    const selectedIncoterm = incotermsList.find(i => i.value === state.incoterms) || incotermsList[4]; // Default to FOB
    const portLabel = selectedIncoterm.port;

    // --- INDUSTRY-STANDARD UNITS OF MEASURE ---
    const unitsOfMeasure = [
        'Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 
        'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel', 'Cubic Foot'
    ];

    // --- ENHANCED INSTITUTIONAL-GRADE CALCULATION ENGINE v5.0 ---
    const calculateInstitutionalDeal = () => {
        // Core market data with defensive checks
        const commodityPriceUSD = parseFloat(commodityAsset.price) || 0;
        const settlementRate = parseFloat(settlementAsset.price) || 1;
        const quantity = parseFloat(state.quantity) || 0;
        const discountPremiumIsInPercent = state.discountPremiumIsInPercent === 'true' || state.discountPremiumIsInPercent === true;

        // Initialize calculation variables
        let discountPremiumAmount = 0;
        let effectivePriceUSD = commodityPriceUSD;

        // Advanced pricing model calculations with precision
        switch (state.pricingModel) {
            case 'Fixed':
                effectivePriceUSD = parseFloat(state.fixedPrice) || 0;
                break;
            case 'Discount':
                discountPremiumAmount = parseFloat(state.discountPremiumValue) || 0;
                if (discountPremiumIsInPercent) {
                    discountPremiumAmount = commodityPriceUSD * (discountPremiumAmount / 100);
                }
                effectivePriceUSD = Math.max(0, commodityPriceUSD - discountPremiumAmount);
                break;
            case 'Premium':
                discountPremiumAmount = parseFloat(state.discountPremiumValue) || 0;
                if (discountPremiumIsInPercent) {
                    discountPremiumAmount = commodityPriceUSD * (discountPremiumAmount / 100);
                }
                effectivePriceUSD = commodityPriceUSD + discountPremiumAmount;
                break;
            case 'Market':
            default:
                effectivePriceUSD = commodityPriceUSD;
                break;
        }
        
        // Core USD calculations
        const totalValueUSD = quantity * effectivePriceUSD;
        
        // Settlement currency conversions with precision
        let effectivePriceSettlement = effectivePriceUSD;
        let totalValueSettlement = totalValueUSD;
        let crossRate = 1;
        
        // Handle different settlement currencies
        if (settlementAsset.baseAsset !== 'USD' && settlementRate > 0) {
            // If settlement asset is quoted in USD (e.g., EUR/USD = 1.10)
            if (settlementAsset.quoteAsset === 'USD') {
                crossRate = 1 / settlementRate; // Convert USD to settlement currency
                effectivePriceSettlement = effectivePriceUSD * crossRate;
                totalValueSettlement = totalValueUSD * crossRate;
            }
            // If settlement asset is quoted against another currency
            else {
                crossRate = settlementRate;
                effectivePriceSettlement = effectivePriceUSD * crossRate;
                totalValueSettlement = totalValueUSD * crossRate;
            }
        }
        
        // Risk and variance calculations
        const priceVariance = Math.abs(effectivePriceUSD - commodityPriceUSD);
        const variancePercentage = commodityPriceUSD > 0 ? (priceVariance / commodityPriceUSD) * 100 : 0;
        
        // Additional analytics
        const adjustmentAmountUSD = effectivePriceUSD - commodityPriceUSD;
        const adjustmentPercentage = commodityPriceUSD > 0 ? (adjustmentAmountUSD / commodityPriceUSD) * 100 : 0;
        
        return { 
            commodityPriceUSD,
            effectivePriceUSD, 
            effectivePriceSettlement,
            totalValueUSD, 
            totalValueSettlement,
            crossRate,
            settlementRate,
            discountPremiumAmount, 
            priceVariance,
            variancePercentage,
            adjustmentAmountUSD,
            adjustmentPercentage,
            quantity,
            settlementCurrency: settlementAsset.baseAsset,
            commoditySymbol: commodityAsset.baseAsset
        };
    };

    const calculations = calculateInstitutionalDeal();

    // --- SOPHISTICATED FORMATTING WITH FINANCIAL PRECISION ---
    const formatPrice = (price, decimals = 2) => {
        if (typeof price !== 'number' || isNaN(price)) return '0.00';
        return price.toLocaleString(undefined, { 
            minimumFractionDigits: decimals, 
            maximumFractionDigits: decimals 
        });
    };

    const formatBigNumber = (price, decimals = 2) => {
        if (typeof price !== 'number' || isNaN(price)) return '0.00';
        if (Math.abs(price) >= 1e12) return (price / 1e12).toFixed(1) + 'T';
        if (Math.abs(price) >= 1e9) return (price / 1e9).toFixed(1) + 'B';
        if (Math.abs(price) >= 1e6) return (price / 1e6).toFixed(1) + 'M';
        if (Math.abs(price) >= 1e3) return (price / 1e3).toFixed(1) + 'K';
        return formatPrice(price, decimals);
    };

    const formatPercentage = (value) => {
        return `${value >= 0 ? '+' : ''}${formatPrice(value, 3)}%`;
    };

    const formatCurrency = (amount, currency = 'USD', decimals = 2) => {
        return `${formatPrice(amount, decimals)} ${currency}`;
    };

    return `
    <!-- PINNACLE INSTITUTIONAL UI STYLES v5.0 -->
    <style>
        :root { 
            --primary-rgb: 14, 165, 233; 
            --success-rgb: 34, 197, 94;
            --warning-rgb: 251, 191, 36;
            --error-rgb: 239, 68, 68;
        }
        .commodity-panel { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
        .step-container { 
            border: 2px solid transparent; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6)); 
            backdrop-filter: blur(12px); 
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        .step-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 48%, rgba(var(--primary-rgb), 0.1) 49%, rgba(var(--primary-rgb), 0.1) 51%, transparent 52%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .step-container.completed { 
            border-color: rgb(var(--success-rgb)); 
            box-shadow: 0 0 30px rgba(var(--success-rgb), 0.3);
        }
        .step-container.active { 
            border-color: rgb(var(--primary-rgb)); 
            box-shadow: 0 0 25px rgba(var(--primary-rgb), 0.25);
        }
        .step-container.active::before { opacity: 1; }
        .step-summary { 
            display: flex; 
            align-items: center; 
            padding: 1.75rem 2rem; 
            cursor: pointer; 
            user-select: none;
            transition: all 0.3s ease;
        }
        .step-summary:hover { background: rgba(var(--primary-rgb), 0.05); }
        .step-summary::-webkit-details-marker { display: none; }
        .step-icon { 
            width: 3.5rem; 
            height: 3.5rem; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 1.5rem; 
            flex-shrink: 0; 
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); 
            border: 3px solid var(--border-color); 
            background: var(--background-light); 
            font-size: 1.2rem; 
            font-weight: 800;
            position: relative;
            overflow: hidden;
        }
        .step-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transition: all 0.4s ease;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .step-summary.completed .step-icon { 
            background: linear-gradient(135deg, rgb(var(--success-rgb)), rgba(var(--success-rgb), 0.8)); 
            border-color: rgb(var(--success-rgb)); 
            color: white; 
            transform: scale(1.1) rotate(5deg); 
            animation: successPulse 3s infinite;
        }
        .step-summary.completed .step-icon::before {
            width: 100%;
            height: 100%;
        }
        .step-details[open] > .step-summary .step-icon { 
            border-color: rgb(var(--primary-rgb)); 
            background: linear-gradient(135deg, rgb(var(--primary-rgb)), rgba(var(--primary-rgb), 0.8)); 
            color: white; 
            transform: scale(1.08); 
            animation: activePulse 2s infinite;
        }
        .step-details[open] > .step-summary .step-icon::before {
            width: 100%;
            height: 100%;
        }
        .step-summary.locked .step-icon { 
            background: var(--border-color); 
            color: var(--text-muted); 
            opacity: 0.6;
        }
        @keyframes successPulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(var(--success-rgb), 0.7); } 
            50% { box-shadow: 0 0 0 15px rgba(var(--success-rgb), 0); } 
        }
        @keyframes activePulse { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.5); } 
            50% { box-shadow: 0 0 0 12px rgba(var(--primary-rgb), 0); } 
        }
        .step-title { 
            font-size: 1.375rem; 
            font-weight: 800; 
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .step-subtitle { 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            font-weight: 500;
            margin-top: 0.25rem;
        }
        .step-data-summary { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin-top: 0.75rem; 
            padding: 0.375rem 1rem; 
            background: rgba(var(--primary-rgb), 0.15); 
            border-radius: 2rem; 
            display: inline-block;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(var(--primary-rgb), 0.3);
        }
        .step-summary.completed .step-data-summary { 
            color: rgb(var(--success-rgb)); 
            font-weight: 700; 
            background: rgba(var(--success-rgb), 0.15);
            border-color: rgba(var(--success-rgb), 0.3);
        }
        .step-content { 
            padding: 2.5rem; 
            border-top: 1px solid var(--border-color); 
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.7));
            backdrop-filter: blur(8px);
        }
        .pricing-model-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 1rem; 
        }
        .pricing-option input[type="radio"] { 
            opacity: 0; 
            position: absolute; 
            pointer-events: none; 
        }
        .pricing-option label { 
            display: block; 
            padding: 1.25rem 1rem; 
            text-align: center; 
            border: 2px solid var(--border-color); 
            border-radius: 1.25rem; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            font-weight: 700;
            position: relative;
            background: var(--background-light);
            overflow: hidden;
        }
        .pricing-option label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }
        .pricing-option label:hover::before {
            left: 100%;
        }
        .pricing-option input:checked + label { 
            border-color: rgb(var(--primary-rgb)); 
            color: white; 
            background: linear-gradient(135deg, rgb(var(--primary-rgb)), rgba(var(--primary-rgb), 0.8));
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(var(--primary-rgb), 0.3);
        }
        .value-type-toggle { 
            display: flex; 
            background: var(--background-light); 
            border-radius: 1rem; 
            padding: 0.375rem;
            border: 2px solid var(--border-color);
            overflow: hidden;
        }
        .value-type-toggle input { display: none; }
        .value-type-toggle label { 
            flex: 1; 
            text-align: center; 
            padding: 0.75rem; 
            border-radius: 0.75rem; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        .value-type-toggle input:checked + label { 
            background: linear-gradient(135deg, rgb(var(--primary-rgb)), rgba(var(--primary-rgb), 0.9)); 
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.4);
        }
        
        /* ENHANCED ANALYSIS PANEL STYLES */
        .compact-analysis { 
            background: linear-gradient(145deg, rgba(var(--primary-rgb), 0.08), rgba(30, 41, 59, 0.6)); 
            backdrop-filter: blur(20px); 
            border: 2px solid rgba(var(--primary-rgb), 0.25); 
            border-radius: 2rem; 
            padding: 2rem;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }
        .compact-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgb(var(--primary-rgb)), rgb(var(--success-rgb)), rgb(var(--primary-rgb)));
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .analysis-action-button {
            background: linear-gradient(135deg, rgb(var(--primary-rgb)), rgba(var(--primary-rgb), 0.8));
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1.5rem;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.3);
        }
        
        .analysis-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(var(--primary-rgb), 0.4);
        }
        
        .key-metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1.5rem; 
        }
        
        .metric-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-color, rgb(var(--primary-rgb)));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover::before {
            transform: scaleX(1);
        }
        
        .metric-card.success { --accent-color: rgb(var(--success-rgb)); }
        .metric-card.warning { --accent-color: rgb(var(--warning-rgb)); }
        .metric-card.primary { --accent-color: rgb(var(--primary-rgb)); }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
        }
        
        .metric-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-sublabel {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 0.9rem;
            backdrop-filter: blur(8px);
        }
        .status-complete {
            background: rgba(var(--success-rgb), 0.15);
            color: rgb(var(--success-rgb));
            border: 1px solid rgba(var(--success-rgb), 0.3);
        }
        .status-incomplete {
            background: rgba(var(--warning-rgb), 0.15);
            color: rgb(var(--warning-rgb));
            border: 1px solid rgba(var(--warning-rgb), 0.3);
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Auto-updating input styles */
        .form-input, .form-select {
            transition: all 0.2s ease;
            border: 2px solid var(--border-color);
        }
        
        .form-input:focus, .form-select:focus {
            border-color: rgb(var(--primary-rgb));
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }
    </style>

    <div class="commodity-panel space-y-8" onchange="setTimeout(() => { this.dispatchEvent(new Event('refresh')); }, 50);">
        <!-- STEP 1: DEAL FOUNDATION -->
        <details class="step-details step-container ${isStep1Complete ? 'completed' : 'active'}" open>
            <summary class="step-summary ${isStep1Complete ? 'completed' : 'active'}">
                <div class="step-icon">
                    <i class="fas ${isStep1Complete ? 'fa-check' : 'fa-cube'}"></i>
                </div>
                <div class="step-title-block">
                    <p class="step-title">Step 1: Deal Foundation</p>
                    <p class="step-subtitle">${isStep1Complete ? 'Core parameters configured.' : 'Select commodity and define quantity parameters.'}</p>
                    ${isStep1Complete ? `<div class="step-data-summary">${formatPrice(state.quantity, 0)} ${state.unitOfMeasure} of ${commodityAsset.baseAsset}</div>` : ''}
                </div>
            </summary>
            <div class="step-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-bold text-text-muted mb-2">Commodity Asset</label>
                        <select data-path="commodityTrade.assetKey" class="form-select" onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                            ${commodityOptions(state.assetKey)}
                        </select>
                        <p class="text-xs text-text-muted mt-1">Current market: ${formatPrice(commodityAsset.price)} per unit</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-text-muted mb-2">Quantity</label>
                        <input type="number" data-path="commodityTrade.quantity" 
                               value="${state.quantity || ''}" 
                               class="form-input text-right font-bold" 
                               placeholder="0"
                               oninput="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-text-muted mb-2">Unit of Measure</label>
                    <select data-path="commodityTrade.unitOfMeasure" class="form-select" onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                        <option value="">Select unit...</option>
                        ${unitsOfMeasure.map(u => `<option value="${u}" ${state.unitOfMeasure === u ? 'selected' : ''}>${u}</option>`).join('')}
                    </select>
                </div>
            </div>
        </details>

        <!-- STEP 2: LOGISTICS & PROVENANCE -->
        <details class="step-details step-container ${isStep2Complete ? 'completed' : (isStep1Complete ? 'active' : 'locked')}" ${isStep1Complete ? 'open' : ''}>
            <summary class="step-summary ${isStep2Complete ? 'completed' : (isStep1Complete ? 'active' : 'locked')}">
                <div class="step-icon">
                    <i class="fas ${isStep2Complete ? 'fa-check' : (isStep1Complete ? 'fa-globe-americas' : 'fa-lock')}"></i>
                </div>
                <div class="step-title-block">
                    <p class="step-title">Step 2: Logistics & Provenance</p>
                    <p class="step-subtitle">${isStep2Complete ? 'Trade route and terms established.' : 'Configure shipping terms and origin details.'}</p>
                    ${isStep2Complete ? `<div class="step-data-summary">${state.origin} → ${state.port} (${state.incoterms})</div>` : ''}
                </div>
            </summary>
            <div class="step-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-text-muted mb-2">Origin Country</label>
                        <input list="countries-datalist" 
                               value="${state.origin || ''}" 
                               data-path="commodityTrade.origin" 
                               class="form-input"
                               placeholder="Select or type country"
                               oninput="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                        <datalist id="countries-datalist">
                            ${majorCountries.map(c => `<option value="${c}">`).join('')}
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-text-muted mb-2">${portLabel}</label>
                        <input list="ports-datalist" 
                               value="${state.port || ''}" 
                               data-path="commodityTrade.port" 
                               class="form-input"
                               placeholder="Select or type port"
                               oninput="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                        <datalist id="ports-datalist">
                            ${majorPorts.map(port => `<option value="${port}">`).join('')}
                        </datalist>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-text-muted mb-2">Incoterms® 2020</label>
                    <select data-path="commodityTrade.incoterms" class="form-select" onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                        <option value="">Select terms...</option>
                        ${incotermsList.map(i => `<option value="${i.value}" ${state.incoterms === i.value ? 'selected' : ''}>${i.label}</option>`).join('')}
                    </select>
                    <p class="text-xs text-text-muted mt-2">Risk transfers to <strong>${selectedIncoterm.risk}</strong> • Cost responsibility: ${selectedIncoterm.cost}</p>
                </div>
                <div>
                    <label class="block text-sm font-bold text-text-muted mb-2">Quality Specification (Optional)</label>
                    <textarea data-path="commodityTrade.qualitySpec" 
                              class="form-input font-mono text-sm" 
                              rows="3" 
                              placeholder="API gravity, sulfur content, moisture levels, etc.">${state.qualitySpec || ''}</textarea>
                </div>
            </div>
        </details>

        <!-- STEP 3: FINANCIAL STRUCTURE -->
        <details class="step-details step-container ${isStep3Complete ? 'completed' : (isStep2Complete ? 'active' : 'locked')}" ${isStep2Complete ? 'open' : ''}>
            <summary class="step-summary ${isStep3Complete ? 'completed' : (isStep2Complete ? 'active' : 'locked')}">
                <div class="step-icon">
                    <i class="fas ${isStep3Complete ? 'fa-check' : (isStep2Complete ? 'fa-dollar-sign' : 'fa-lock')}"></i>
                </div>
                <div class="step-title-block">
                    <p class="step-title">Step 3: Financial Structure</p>
                    <p class="step-subtitle">${isStep3Complete ? 'Pricing model and settlement configured.' : 'Define pricing methodology and settlement terms.'}</p>
                    ${isStep3Complete ? `<div class="step-data-summary">${state.pricingModel} pricing in ${settlementAsset.baseAsset}</div>` : ''}
                </div>
            </summary>
            <div class="step-content space-y-6">
                <div>
                    <label class="block text-sm font-bold text-text-muted mb-3">Pricing Model</label>
                    <div class="pricing-model-grid">
                        ${['Market', 'Discount', 'Fixed', 'Premium'].map(p => `
                        <div class="pricing-option">
                            <input type="radio" id="price-model-${p}" name="pricingModel" value="${p}" 
                                   ${state.pricingModel === p ? 'checked' : ''} 
                                   data-path="commodityTrade.pricingModel"
                                   onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                            <label for="price-model-${p}">${p}</label>
                        </div>`).join('')}
                    </div>
                </div>

                ${state.pricingModel === 'Fixed' ? `
                <div class="animate-fade-in-up space-y-4">
                    <div class="analysis-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-bold text-text-muted mb-2">Fixed Price (per ${state.unitOfMeasure || 'unit'})</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted text-lg">$</span>
                                    <input type="number" 
                                           data-path="commodityTrade.fixedPrice" 
                                           value="${state.fixedPrice || ''}" 
                                           class="form-input font-bold text-xl pl-8" 
                                           step="0.01"
                                           placeholder="0.00"
                                           oninput="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-text-muted mb-1">Market Reference</p>
                                <p class="text-lg font-mono text-text-primary">${formatPrice(calculations.commodityPriceUSD)}</p>
                                <p class="text-xs ${calculations.variancePercentage > 5 ? 'text-warning-color' : 'text-success-color'}">
                                    ${calculations.variancePercentage > 0 ? formatPercentage(calculations.adjustmentPercentage) + ' vs market' : 'At market'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : state.pricingModel && state.pricingModel !== 'Market' ? `
                <div class="animate-fade-in-up space-y-4">
                    <div class="analysis-section">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-text-muted mb-2">Market Rate</label>
                                <div class="form-input bg-background-dark/50 text-xl font-bold text-center">
                                    ${formatPrice(calculations.commodityPriceUSD)}
                                </div>
                                <p class="text-xs text-center text-text-muted mt-1">per ${state.unitOfMeasure || 'unit'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-text-muted mb-2">${state.pricingModel} Value</label>
                                <input type="number" 
                                       data-path="commodityTrade.discountPremiumValue" 
                                       value="${state.discountPremiumValue || ''}" 
                                       class="form-input font-bold text-xl text-center" 
                                       step="0.01"
                                       placeholder="0.00"
                                       oninput="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-text-muted mb-2">Value Type</label>
                                <div class="value-type-toggle">
                                    <input type="radio" id="val-type-fixed" name="valueType" value="false" 
                                           ${!state.discountPremiumIsInPercent || state.discountPremiumIsInPercent === 'false' ? 'checked' : ''} 
                                           data-path="commodityTrade.discountPremiumIsInPercent"
                                           onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                                    <label for="val-type-fixed">USD $</label>
                                    <input type="radio" id="val-type-percent" name="valueType" value="true" 
                                           ${state.discountPremiumIsInPercent === 'true' || state.discountPremiumIsInPercent === true ? 'checked' : ''} 
                                           data-path="commodityTrade.discountPremiumIsInPercent"
                                           onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                                    <label for="val-type-percent">Percent %</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <div class="inline-flex items-center gap-2 px-4 py-2 bg-primary-color/10 border border-primary-color/30 rounded-full">
                                <i class="fas fa-calculator text-primary-color"></i>
                                <span class="font-mono text-primary-color font-bold">
                                    Calculated Adjustment: ${state.pricingModel === 'Discount' ? '-' : '+'}${formatPrice(calculations.discountPremiumAmount)} per unit
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div>
                    <label class="block text-sm font-bold text-text-muted mb-2">Settlement Asset</label>
                    <select data-path="commodityTrade.settlementAssetKey" class="form-select" onchange="this.closest('.commodity-panel').dispatchEvent(new Event('refresh'));">
                        <option value="USD">USD (Default)</option>
                        ${settlementOptions(state.settlementAssetKey)}
                    </select>
                    <p class="text-xs text-text-muted mt-1">
                        Current rate: ${formatPrice(settlementAsset.price, 6)} ${settlementAsset.quoteAsset}/${settlementAsset.baseAsset}
                    </p>
                </div>
            </div>
        </details>
        
        <!-- ENHANCED COMPACT ANALYSIS PANEL -->
        <div class="compact-analysis">
            <div class="analysis-header">
                <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="fas fa-chart-line text-primary-color"></i>
                    Deal Analysis & Projections
                </h3>
                <div class="flex items-center gap-4">
                    <div class="status-indicator ${isStep3Complete ? 'status-complete' : 'status-incomplete'}">
                        <i class="fas ${isStep3Complete ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                        ${isStep3Complete ? 'Ready for Execution' : 'Configuration Required'}
                    </div>
                    ${isStep3Complete ? `
                    <button class="analysis-action-button" onclick="AppState.openInstitutionalAnalysis('commodityTrade')">
                        <i class="fas fa-chart-bar"></i>
                        Launch Full Analysis Suite
                    </button>
                    ` : ''}
                </div>
            </div>
            
            <!-- KEY METRICS OVERVIEW -->
            <div class="key-metrics-grid">
                <!-- Commodity & Quantity -->
                <div class="metric-card primary">
                    <div class="metric-value">${formatPrice(calculations.quantity, 0)}</div>
                    <div class="metric-label">${state.unitOfMeasure || 'Units'}</div>
                    <div class="metric-sublabel">${calculations.commoditySymbol} • ${state.origin || 'Origin TBD'}</div>
                </div>

                <!-- USD Effective Price -->
                <div class="metric-card ${calculations.adjustmentAmountUSD === 0 ? 'primary' : (calculations.adjustmentAmountUSD > 0 ? 'warning' : 'success')}">
                    <div class="metric-value">${formatPrice(calculations.effectivePriceUSD)}</div>
                    <div class="metric-label">Effective Price (USD)</div>
                    <div class="metric-sublabel">
                        ${calculations.adjustmentAmountUSD === 0 ? 'Market price' : 
                          `${formatPercentage(calculations.adjustmentPercentage)} vs market`}
                    </div>
                </div>

                <!-- Settlement Price (Dynamic Currency) -->
                ${calculations.settlementCurrency !== 'USD' ? `
                <div class="metric-card primary">
                    <div class="metric-value">${formatPrice(calculations.effectivePriceSettlement)} ${calculations.settlementCurrency}</div>
                    <div class="metric-label">Settlement Price</div>
                    <div class="metric-sublabel">Rate: ${formatPrice(calculations.crossRate, 6)}</div>
                </div>
                ` : ''}

                <!-- Total USD Value -->
                <div class="metric-card success">
                    <div class="metric-value">${formatBigNumber(calculations.totalValueUSD)}</div>
                    <div class="metric-label">Total Value (USD)</div>
                    <div class="metric-sublabel">Gross transaction value</div>
                </div>

                <!-- Settlement Value (Dynamic Currency) -->
                ${calculations.settlementCurrency !== 'USD' ? `
                <div class="metric-card success">
                    <div class="metric-value">${formatBigNumber(calculations.totalValueSettlement)} ${calculations.settlementCurrency}</div>
                    <div class="metric-label">Settlement Value</div>
                    <div class="metric-sublabel">Final payment amount</div>
                </div>
                ` : ''}

                <!-- Pricing Model -->
                <div class="metric-card ${state.pricingModel === 'Market' ? 'primary' : 'warning'}">
                    <div class="metric-value">${state.pricingModel || 'TBD'}</div>
                    <div class="metric-label">Pricing Model</div>
                    <div class="metric-sublabel">${state.incoterms || 'Terms TBD'}</div>
                </div>
            </div>

            <!-- COMPREHENSIVE DEAL SUMMARY -->
            ${isStep3Complete ? `
            <div class="mt-8 p-6 bg-success-color/5 border-2 border-success-color/20 rounded-2xl">
                <h4 class="text-lg font-bold text-success-color mb-4 flex items-center gap-2">
                    <i class="fas fa-handshake"></i>
                    Deal Structure Summary
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-text-muted">Commodity:</span>
                                <span class="font-bold text-text-primary">${calculations.commoditySymbol}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Quantity:</span>
                                <span class="font-bold text-text-primary">${formatPrice(calculations.quantity, 0)} ${state.unitOfMeasure}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Origin:</span>
                                <span class="font-bold text-text-primary">${state.origin}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Port:</span>
                                <span class="font-bold text-text-primary">${state.port}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Incoterms:</span>
                                <span class="font-bold text-text-primary">${state.incoterms}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-text-muted">Market Price (USD):</span>
                                <span class="font-mono text-text-primary">${formatPrice(calculations.commodityPriceUSD)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Effective Price (USD):</span>
                                <span class="font-mono font-bold text-primary-color">${formatPrice(calculations.effectivePriceUSD)}</span>
                            </div>
                            ${calculations.settlementCurrency !== 'USD' ? `
                            <div class="flex justify-between">
                                <span class="text-text-muted">Cross Rate:</span>
                                <span class="font-mono text-text-primary">${formatPrice(calculations.crossRate, 6)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-text-muted">Settlement Price:</span>
                                <span class="font-mono font-bold text-primary-color">${formatPrice(calculations.effectivePriceSettlement)} ${calculations.settlementCurrency}</span>
                            </div>
                            ` : ''}
                            <hr class="border-border-color/50 my-2">
                            <div class="flex justify-between text-lg">
                                <span class="font-bold text-text-muted">Final Value:</span>
                                <span class="font-mono font-bold text-success-color">
                                    ${calculations.settlementCurrency === 'USD' ? 
                                      `${formatBigNumber(calculations.totalValueUSD)}` : 
                                      `${formatBigNumber(calculations.totalValueSettlement)} ${calculations.settlementCurrency}`}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : `
            <div class="mt-6 p-4 bg-warning-color/5 border border-warning-color/20 rounded-xl text-center">
                <i class="fas fa-info-circle text-warning-color text-2xl mb-3"></i>
                <p class="text-warning-color font-semibold mb-2">Deal Configuration Incomplete</p>
                <p class="text-sm text-text-muted">Complete all three steps to view comprehensive analysis and projections.</p>
            </div>
            `}
        </div>
    </div>
    `;
},
            renderCryptoLoanPanel: () => {
                const state = AppState.modeler.cryptoLoan;
                const assetOptions = (selectedKey) => AppState.marketData
                    .filter(a => a.type === 'Cryptocurrency')
                    .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
                const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
                return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div>
                            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="interactive-slider flex-grow"><div class="relative w-28"><input type="number" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div>
                           <div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div>
                        </div>`;
            },
            renderSBLCMonetizationPanel: () => {
                const state = AppState.modeler.sblcMonetization;
                return `<div><label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label><input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold"></div>
                        <div><label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="interactive-slider flex-grow"><div class="relative w-28"><input type="number" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div>`;
            },
                        renderModelerOutputPanel: (calc) => {
                if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
                
                let customOutput = '';
                // DEFINITIVE FIX: Condition now correctly checks for 'AssetSwap' state.
                if(AppState.modeler.activeDealType === 'AssetSwap') {
                    // SEVERE UPGRADE: Output is now profoundly accurate with high precision and better descriptions.
                    const { fromAsset, toAsset, rate } = calc;
                    const rateDisplay = rate > 0 ? rate.toFixed(8) : '0.00000000'; // High precision for crypto
                    const subValueText = rate > 0 ? `1 ${fromAsset.baseAsset} ≈ ${rateDisplay} ${toAsset.baseAsset}` : `Price data unavailable for conversion.`;
                    
                    customOutput = `<div class="output-metric-card">
                        <p class="label"><i class="fas fa-sync-alt"></i>Institutional Cross Rate</p>
                        <p class="value">${rateDisplay}</p>
                        <p class="sub-value">${subValueText}</p>
                    </div>`;
                } else if (AppState.modeler.activeDealType === 'CryptoLoan') {
                    const monthlyPayment = calc.totalRepayment / (calc.tenureMonths || 1);
                    customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-hand-holding-usd"></i>Loan Principal</p><p class="value">${Utils.formatPrice(calc.loanPrincipal, calc.loanCurrency)}</p><p class="sub-value">Total Repayment: ${Utils.formatPrice(calc.totalRepayment, calc.loanCurrency)}</p></div>
                    <div class="output-metric-card mt-4"><p class="label"><i class="fas fa-calendar-alt"></i>Monthly Repayment</p><p class="value">${Utils.formatPrice(monthlyPayment, calc.loanCurrency)}</p><p class="sub-value">${calc.tenureMonths}-month tenure @ ${calc.interestRateValue}% fixed</p></div>
                    <div class="mt-4"><h4 class="text-sm font-semibold text-text-secondary mb-2">Projected Loan Balance Over Time</h4><div class="yield-graph-container h-40">${UI.renderYieldGraph(calc)}</div></div>`;
                }

                return `<div class="flex flex-col h-full animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-success-color"></i>Deal Analysis & Projections</h2>
                    <div class="space-y-4 flex-grow">
                        <div class="output-metric-card base-value"><p class="label"><i class="fas fa-tags"></i>Base/Market Value</p><p class="value">${Utils.formatPrice(calc.baseValueUSD)}</p><p class="sub-value">${calc.dealTitle}</p></div>
                        <div class="output-metric-card net"><p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Value to Buyer</p><p class="value">${Utils.formatPrice(calc.finalValueToBuyerUSD)}</p><p class="sub-value">${calc.netValueDescription}</p></div>
                        <div class="output-metric-card commission"><p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p><p class="value">${Utils.formatPrice(calc.totalCommissionPool)}</p><p class="sub-value">${calc.grossValueDescription}</p></div>
                        ${customOutput}
                    </div>
                    <div class="mt-auto pt-6 border-t border-border-color">
                        <button onclick="Logic.openImfpaModal()" class="btn-primary w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Commission Manager</button>
                    </div>
                </div>`;
            },
            renderYieldGraph: (calc) => {
                const { loanPrincipal, interestRateValue, tenureMonths } = calc;
                if (tenureMonths <= 0) return '<p class="text-center text-text-muted text-sm">Invalid tenure for graph.</p>';
                const monthlyRate = (interestRateValue / 100) / 12;
                const points = Array.from({length: tenureMonths + 1}, (_, i) => {
                    const simpleInterest = loanPrincipal * monthlyRate * i;
                    return { month: i, value: loanPrincipal + simpleInterest };
                });
                
                const width=300, height=120, marginY=20, marginX=30;
                const yMax = points[points.length-1].value;
                const yMin = loanPrincipal;
                const xScale = (width - marginX*2) / tenureMonths;
                const yScale = (yMax > yMin) ? (height - marginY*2) / (yMax - yMin) : 0;
                
                const pathData = points.map((p, i) => {
                    const x = marginX + p.month * xScale;
                    const y = height - marginY - ((p.value - yMin) * yScale);
                    return `${i === 0 ? 'M' : 'L'} ${x.toFixed(2)} ${y.toFixed(2)}`;
                }).join(' ');

                return `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full">
                    <line x1="${marginX}" y1="${height-marginY}" x2="${width-marginX}" y2="${height-marginY}" stroke="var(--border-color)" stroke-width="1" />
                    <line x1="${marginX}" y1="${marginY}" x2="${marginX}" y2="${height-marginY}" stroke="var(--border-color)" stroke-width="1" />
                    <text x="${marginX-5}" y="${marginY+5}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMax, 0)}</text>
                    <text x="${marginX-5}" y="${height-marginY}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMin, 0)}</text>
                    <text x="${width-marginX}" y="${height-marginY+15}" text-anchor="end" font-size="10" fill="var(--text-muted)">${tenureMonths} mos</text>
                    <path d="${pathData}" class="yield-graph-path" stroke="var(--success-color)" />
                    ${points.map(p => {
                        const x = marginX + p.month * xScale;
                        const y = height - marginY - ((p.value-yMin) * yScale);
                        return `<circle cx="${x}" cy="${y}" r="4" fill="var(--success-color)" class="yield-graph-dot" />`
                    }).join('')}
                </svg>`;
            },
           // ----- IMFPA MODAL RENDERERS (ULTRA-PRIME v37.6 UPGRADE) -----
                        // ----- In UI.renderImfpaModal() -----
            renderImfpaModal: () => {
                const { legal } = AppState.modeler;
                const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                return `
                    <div class="p-6 md:p-8 flex-1 flex flex-col overflow-hidden">
                        <div class="flex justify-between items-start mb-6 imfpa-header print-hide">
                            <div><h2 class="text-3xl font-bold text-white">Commission & Contract Suite</h2><p class="text-text-secondary">Synthesize the Irrevocable Master Fee Protection Agreement.</p></div>
                            <button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">×</button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 overflow-y-auto pr-4 -mr-4">
                            <!-- Left: Allocation -->
                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h3 class="imfpa-section-title"><i class="fas fa-sitemap mr-3 text-primary-color"></i>Commission Allocation</h3>
                                    <div class="text-right"><p class="text-xs text-text-muted">Total Pool</p><p class="text-2xl font-bold text-primary-color">${Utils.formatPrice(legal.totalCommission)}</p></div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <button onclick="Logic.addImfpaGroup()" class="btn-secondary px-3 py-1 text-sm rounded-lg"><i class="fas fa-plus mr-1"></i>Add Group</button>
                                    <!-- SEVERE FIX: Added ID for targeted updates -->
                                    <div id="imfpa-total-allocated" class="text-right font-mono text-sm ${totalGroupPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}">Total Allocated: ${totalGroupPct.toFixed(2)}%</div>
                                </div>
                                <div class="space-y-4" id="imfpa-groups-container">${UI.renderImfpaGroups()}</div>
                            </div>
                            <!-- Right: Legal Details -->
                            <div class="space-y-6">
                                <h3 class="imfpa-section-title"><i class="fas fa-gavel mr-3 text-accent-color"></i>Legal Framework</h3>
                                <div class="input-group"><h4 class="input-group-title"><i class="fas fa-landmark text-primary-color"></i>Governing Law & Jurisdiction</h4><input value="${legal.jurisdiction}" data-path="legal.jurisdiction" class="form-input" placeholder="e.g., Singapore, Dubai, England, Wales"></div>
                                <!-- SEVERE FIX: Added ID for targeted updates -->
                                <div class="input-group"><h4 class="input-group-title"><i class="fas fa-users text-primary-color"></i>Signatory Parties</h4><div class="text-xs text-text-muted mb-2">A comprehensive list of all signatories. Details are managed within the allocation groups.</div><div id="imfpa-legal-parties" class="space-y-2 text-sm text-text-secondary">${legal.groups.flatMap(g => g.parties).map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') || '<p class="text-xs text-text-muted">No parties defined in allocation groups.</p>'}</div></div>

                                                                <!-- ========================================================= -->
                                <!-- === PINNACLE UPGRADE: SPA REFERENCE INPUT (v40.0) === -->
                                <!-- ========================================================= -->
                                <div class="input-group">
                                    <h4 class="input-group-title">
                                        <i class="fas fa-link text-primary-color"></i>Cross-Referenced Contract / SPA (Optional)
                                    </h4>
                                    <input value="${legal.spaReferenceCode || ''}" data-path="legal.spaReferenceCode" class="form-input font-mono" placeholder="e.g., GECAN-SPA-XYZ-12345">
                                    <p class="text-xs text-text-muted mt-2">Enter the main contract identifier if this IMFPA is a sub-agreement.</p>
                                </div>
                                <!-- ========================================================= -->
                            </div>
                        </div>
                        <div class="pt-6 border-t border-border-color mt-auto print-hide"><button onclick="Logic.generateContract()" class="btn-primary w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Synthesize & Preview IMFPA/NCNDA</button><div id="contract-preview-container" class="mt-4 hidden"></div></div>
                    </div>
                `;
            },
            
            // ----- In UI.renderImfpaGroups() -----
            renderImfpaGroups: () => {
                const { groups, totalCommission } = AppState.modeler.legal;
                return groups.map((g, groupIndex) => {
                    const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    const groupValue = totalCommission * (g.percentage / 100);
                    return `
                    <div class="allocation-group-card animate-fade-in-up rounded-xl p-4" style="animation-delay: ${groupIndex * 100}ms">
                        <div class="flex items-center gap-2 mb-3"><input type="text" value="${g.name}" data-path="legal.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow !p-1 focus:ring-0 font-semibold text-lg !text-text-primary" placeholder="Group Name"><div class="relative w-32"><input type="number" value="${g.percentage}" data-path="legal.groups[${groupIndex}].percentage" class="form-input text-right font-bold"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div><button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-red-500 hover:text-red-400 text-xl font-bold w-8 h-8 flex items-center justify-center transition">×</button></div>
                        <!-- SEVERE FIX: Added ID for targeted updates -->
                        <p id="imfpa-group-value-${groupIndex}" class="text-right text-primary-color font-mono text-lg mb-4">${Utils.formatPrice(groupValue)}</p>
                        <div class="space-y-2 pl-4 border-l-2 border-border-accent">
                            ${g.parties.map((p, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('')}
                            <div class="flex justify-between items-center pt-2">
                                <button onclick="Logic.addImfpaParty(${groupIndex})" class="text-primary-color hover:text-primary-hover text-xs font-semibold"><i class="fas fa-user-plus mr-1"></i>Add Party</button>
                                <!-- SEVERE FIX: Added ID for targeted updates -->
                                <div id="imfpa-group-total-${groupIndex}" class="text-right font-mono text-xs ${totalPartyPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}">Group Total: ${totalPartyPct.toFixed(2)}%</div>
                            </div>
                        </div>
                    </div>`}).join('') || `<p class="text-center text-text-muted py-4">No allocation groups defined.</p>`;
            },
            renderImfpaParty: (groupIndex, partyIndex) => {
                const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
                const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
                return `<div class="allocation-party-card rounded-lg p-3">
                            <div class="flex items-center gap-2"><input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow !p-1 !text-sm focus:ring-0 !text-text-primary" placeholder="Full Legal Name"><div class="relative w-24"><input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input !text-sm text-right"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div><button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-red-500 text-lg w-6 h-6 flex items-center justify-center transition">×</button></div>
                            <div class="mt-2"><a onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-xs text-accent-color cursor-pointer hover:underline flex items-center gap-1 w-full"><i class="fas fa-user-cog"></i> Manage Details <i class="fas fa-chevron-down text-xs transition-transform ${party.detailsVisible ? 'rotate-180' : ''} ml-auto"></i></a></div>
                            <div class="collapsible-content ${party.detailsVisible ? 'expanded' : ''}">${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div>
                        </div>`
            },
            renderImfpaPartyDetails: (groupIndex, partyIndex) => {
                const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
                const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
                const paymentDetailsPlaceholder = { 'Bank Wire': 'IBAN, SWIFT, Bank Info...', 'USDT TRC-20': 'TRC-20 Wallet Address', 'USDT ERC-20': 'ERC-20 Wallet Address' }[party.payment.method] || 'Details...';
                
                return `<div class="party-details-grid">
                    <div><span class="party-detail-label">Role</span><input class="form-input !text-xs" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate"></div>
                    <div><span class="party-detail-label">Email</span><input type="email" class="form-input !text-xs" value="${party.email || ''}" data-path="${base}.email" placeholder="contact@email.com"></div>
                    <div><span class="party-detail-label">Contact Number</span><input class="form-input !text-xs" value="${party.contactNumber || ''}" data-path="${base}.contactNumber" placeholder="+1-555-123-4567"></div>
                    <div><span class="party-detail-label">Passport No.</span><input class="form-input !text-xs" value="${party.passport.number || ''}" data-path="${base}.passport.number" placeholder="P12345678"></div>
                    <div><span class="party-detail-label">Passport Issue Date</span><input type="date" class="form-input !text-xs" value="${party.passport.issueDate || ''}" data-path="${base}.passport.issueDate"></div>
                    <div><span class="party-detail-label">Passport Expiry Date</span><input type="date" class="form-input !text-xs" value="${party.passport.expiryDate || ''}" data-path="${base}.passport.expiryDate"></div>
                    <div class="col-span-2"><span class="party-detail-label">Passport Issuing Authority/Country</span><input class="form-input !text-xs" value="${party.passport.authority || ''}" data-path="${base}.passport.authority" placeholder="USA"></div>

                    <div class="col-span-2"><span class="party-detail-label pt-2 mt-2 border-t border-border-color">Payment Method</span></div>
                    <div><select class="form-select !text-xs" data-path="${base}.payment.method"><option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected':''}>Bank Wire</option><option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected':''}>USDT (TRC-20)</option><option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected':''}>USDT (ERC-20)</option></select></div>
                    <div><select class="form-select !text-xs" data-path="${base}.payment.currency"><option value="USD" ${party.payment.currency === 'USD' ? 'selected':''}>USD</option><option value="USDT" ${party.payment.currency === 'USDT' ? 'selected':''}>USDT</option><option value="EUR" ${party.payment.currency === 'EUR' ? 'selected':''}>EUR</option></select></div>
                    <div class="col-span-2"><span class="party-detail-label">Payment Coordinates</span><textarea class="form-input !text-xs" data-path="${base}.payment.details" rows="3" placeholder="${paymentDetailsPlaceholder}">${party.payment.details || ''}</textarea></div>
                </div>`;
            },
            // ===== END: UPGRADED INSTITUTIONAL MODELER UI =====
        };

        

        // --- SECTION 5: LOGIC CONTROLLER ---
        const Logic = {

          

                      // NEW UNIVERSAL FUNCTION (v4.5) - Replaces ALL alert() calls.
            showNotification: (message, type = 'info', title = null) => {
                const modal = document.getElementById('notification-modal');
                const content = document.getElementById('notification-modal-content');
                const icon = document.getElementById('notification-icon');
                const titleEl = document.getElementById('notification-title');
                const okBtn = document.getElementById('notification-ok-btn');
                
                document.getElementById('notification-message').textContent = message;

                // Configure modal based on type (success, error, info)
                const types = {
                    success: { iconClass: 'fa-check-circle', defaultTitle: 'Success', subtitle: 'The operation completed successfully.' },
                    error: { iconClass: 'fa-exclamation-triangle', defaultTitle: 'Error', subtitle: 'An error has occurred.' },
                    info: { iconClass: 'fa-info-circle', defaultTitle: 'Information', subtitle: 'Please review this message.' }
                };

                const config = types[type] || types['info'];
                
                // Remove old classes and add the new ones
                content.classList.remove('success', 'error', 'info');
                modal.classList.remove('notification-success', 'notification-error', 'notification-info');
                content.classList.add(type);
                modal.classList.add(`notification-${type}`);
                
                icon.className = `fas ${config.iconClass} fa-2x`;
                titleEl.textContent = title || config.defaultTitle;
                document.getElementById('notification-subtitle').textContent = config.subtitle;

                // Attach a one-time event listener to the OK button to close the modal
                okBtn.onclick = () => modal.close();
                
                modal.showModal();
            },

                      // ESSENTIAL HELPER FUNCTION (v3.9) - Processes an image to make the background transparent.
            // This function was missing and is now being provided.
            processImageForTransparency: (imageDataUrl, threshold = 240) => {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.crossOrigin = "Anonymous"; // Handle potential CORS issues with images from other domains

                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        try {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data; // This is a flat array of [R,G,B,A, R,G,B,A, ...]

                            // Iterate over each pixel
                            for (let i = 0; i < data.length; i += 4) {
                                const red = data[i];
                                const green = data[i + 1];
                                const blue = data[i + 2];

                                // If the pixel is close to white (based on the threshold), make it fully transparent.
                                if (red > threshold && green > threshold && blue > threshold) {
                                    data[i + 3] = 0; // Set the Alpha channel to 0 (fully transparent)
                                }
                            }

                            // Put the modified image data back onto the canvas
                            ctx.putImageData(imageData, 0, 0);
                            
                            // Resolve the Promise with the new, transparent PNG data URL.
                            resolve(canvas.toDataURL('image/png'));
                        } catch (e) {
                            console.error("Could not process image data due to security restrictions:", e);
                            // If the image is from a different domain (tainted canvas), this will fail.
                            // We reject with a user-friendly error message.
                            reject(new Error("Image is from a different origin or is security-protected. Cannot process for transparency. Please use the 'Draw Signature' method or a different image file."));
                        }
                    };

                    img.onerror = () => {
                        reject(new Error("Failed to load the signature image for processing. The file may be corrupt or inaccessible."));
                    };

                    // Start loading the image
                    img.src = imageDataUrl;
                });
            },
                            init: async () => {
                UI.init();
                Logic.setupEventListeners();
                UI.renderToolkitMenu();
                try {
                    const [url, marketDataFromServer] = await Promise.all([GAS.run('getWebAppUrl'), GAS.run('getMarketMatrixData')]);
                    if (!url) throw new Error("Server failed to return a valid Web App URL.");
                    AppState.baseUrl = url;
                    document.querySelectorAll('.nav-link').forEach(link => {
                        const page = link.id.split('-')[0];
                        link.href = `${url}?page=${page === 'home' ? 'index' : page}`;
                        link.classList.remove('nav-loading');
                        if (link.id === 'toolkits-nav-link') link.classList.add('active');
                    });
                    if (!marketDataFromServer || !Array.isArray(marketDataFromServer)) throw new Error("Market data source returned invalid data.");
                    AppState.marketData = marketDataFromServer.map(asset => ({ ...asset, price: parseFloat(asset.price) || 0 })).filter(asset => (asset.status === 'OK' || asset.status === 'MANUAL') && asset.price > 0 && asset.baseAsset && asset.baseAsset.toUpperCase() !== 'UNDEFINED');
                    if (AppState.marketData.length === 0) console.warn("Warning: No valid market data loaded.");
                    
                    const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
                    if (allSwappableAssets.length >= 2) {
                        AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key;
                        AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key;
                    } else if (allSwappableAssets.length === 1) {
                        AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key;
                        AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[0].key;
                    }
                    
                    AppState.isInitialized = true;
                    document.getElementById('initial-loader').style.display = 'none';

                    // DEFINITIVE FIX: Directly render the active toolkit ('Dashboard' by default)
                    // after initialization is complete, bypassing any flawed guard clauses.
                    // This ensures the dashboard ALWAYS displays on first load.
                    UI.renderActiveToolkit();

                } catch (err) {
                    console.error('CRITICAL INITIALIZATION FAILURE:', err);
                    Utils.showError('toolkit-content', 'Platform Initialization Error', `Failed to load critical platform data. Reason: ${err.message}. Please check your GECAN_MARKET_MATRIX sheet and server logs.`);
                }
            },
            setupEventListeners: () => document.addEventListener('keydown', (e) => { if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'WalletForensics','3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } } }),
            setActiveToolkit: (id) => { 
                if (AppState.activeToolkit === id && AppState.isInitialized) return; // Prevent re-rendering same toolkit
                AppState.activeToolkit = id; 
                UI.renderActiveToolkit(); 
            },
            bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
            
            // ===== START: STRICTLY RETAINED WALLET FORENSICS LOGIC =====
            bindWalletForensicsEvents: () => {
                const checkBtn = document.getElementById('check-wallet-btn');
                const addressInput = document.getElementById('wallet-address-input');
                checkBtn.addEventListener('click', Logic.runWalletForensics);
                addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') Logic.runWalletForensics(); });
            },
            runWalletForensics: () => {
                const address = document.getElementById('wallet-address-input').value.trim();
                if (!address) return;
                AppState.walletAnalysis = { address, report: null, isLoading: true };
                UI.renderActiveToolkit();
                const spinnerTexts = ["Connecting to blockchain networks...","Fetching transaction history...","Querying GECAN proprietary database...","Running institutional compliance checks...","Synthesizing on-chain and proprietary intel...","Calculating multi-vector risk scores...","Generating definitive wallet classification..."];
                let textIndex = 0;
                let textInterval = setInterval(() => {
                    const spinnerEl = document.getElementById('spinner-text');
                    if (spinnerEl && AppState.walletAnalysis.isLoading) {
                        spinnerEl.style.opacity = '0';
                        setTimeout(() => { spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; spinnerEl.style.opacity = '1'; }, 300);
                    } else { clearInterval(textInterval); }
                }, 2500);
                GAS.run('getWalletForensicsReport', address)
                    .then(report => {
                        if (!report || report.success === false) throw new Error(report?.error?.message || 'Server returned an invalid response.');
                        AppState.walletAnalysis.report = report;
                    }).catch(err => {
                        console.error('Wallet Forensics Error:', err);
                        AppState.walletAnalysis.report = { success: false, error: { message: err.message || 'Analysis failed.' } };
                    }).finally(() => {
                        AppState.walletAnalysis.isLoading = false;
                        clearInterval(textInterval);
                        UI.renderActiveToolkit();
                        if (AppState.walletAnalysis.report?.success) Logic.animateReportElements();
                    });
            },
            animateReportElements: () => setTimeout(() => document.querySelectorAll('.score-gauge-fg').forEach(g => g.style.strokeDasharray = `${g.dataset.score}, 100`), 200),
            initiatePdfGeneration: () => {
                const report = AppState.walletAnalysis.report;
                if (!report || !report.success) return alert('Analysis data not available.');
                report.analysis.executiveSummary = Logic.generateExecutiveSummary(report);
                const btn = document.getElementById('pdf-print-btn');
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                GAS.run('generateWalletForensicsPdf', report)
                    .then(response => {
                        if (response && response.success) {
                            const link = document.createElement('a');
                            link.href = `data:application/pdf;base64,${response.pdfData}`;
                            link.download = response.fileName;
                            link.click();
                        } else throw new Error(response.message || 'Server failed to generate PDF.');
                    }).catch(err => alert(`PDF Generation Failed: ${err.message}`))
                    .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Export PDF'; });
            },
            getExplorerUrl: (wallet, txHash = '') => {
                const urls = { BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' }, ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' }, TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' } };
                const explorer = urls[wallet.type];
                return explorer ? (txHash ? explorer.tx + txHash : explorer.addr + wallet.address) : '#';
            },
            copyToClipboard: (text, element) => navigator.clipboard.writeText(text).then(() => { const fb = element.querySelector('.copied-feedback'); if (fb) { fb.style.opacity = '1'; setTimeout(() => fb.style.opacity = '0', 1500); } }),
            generateExecutiveSummary: (report) => {
                const { analysis, wallet, provenance } = report; let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="${Utils.getRiskClass(analysis.riskLevel)} text-risk-color">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `; const uControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN'))]; if (provenance.records.length > 0) { summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `; if (uControllers.length > 1) summary += `<strong class="text-risk-CRITICAL">Critically, it has ${uControllers.length} conflicting alleged controllers.</strong> `; else if (uControllers.length === 1) summary += `A single controller, <strong>${uControllers[0]}</strong>, is consistently reported. `; } else { summary += `There is <strong class="text-risk-HIGH">no provenance history</strong> in the GECAN Ledger. `; } if (analysis.redFlags.length > 0) { const critFlags = analysis.redFlags.filter(f => f.level === 'CRITICAL').length; summary += `The analysis identified <strong class="${critFlags > 0 ? 'text-risk-CRITICAL' : 'text-warning-color'}">${critFlags > 0 ? critFlags : analysis.redFlags.length} ${critFlags > 0 ? 'CRITICAL' : ''} flag(s)</strong>. `; } else { summary += `<strong class="text-success-color">No major compliance flags</strong> were detected. `; } summary += `Final recommendation is to proceed with caution.`; return summary;
            },
            // ===== END: STRICTLY RETAINED WALLET FORENSICS LOGIC =====
            
            // ===== START: SEVERELY UPGRADED INSTITUTIONAL MODELER LOGIC v37.0 =====
            // ... other functions inside Logic object ...

bindInstitutionalModelerEvents: () => {
    Logic.updateModelerUI(true); // Initial render
    
    // This robustly attaches listeners to the container
    const inputContainer = document.getElementById('modeler-input-container');
    if (inputContainer) {
        // This is the superior event delegation that listens for all changes within the container
        inputContainer.addEventListener('input', Utils.debounce((e) => {
            if (e.target.matches('[data-path]')) {
                Logic.handleModelerInputChange(e);
            }
        }, 250)); // 250ms debounce for smooth typing experience
    }
},

// ... other functions ...
            handleDealTypeChange: (newDealType) => {
                if (AppState.modeler.activeDealType === newDealType) return;
                AppState.modeler.activeDealType = newDealType;
                UI.renderActiveToolkit();
            },
            handleModelerInputChange: (e) => {
                const { dataset, value, type } = e.target;
                const path = dataset.path;
                if (!path) return;

                // CRITICAL FIX: This prevents a race condition by delegating the complex update for this specific field to a dedicated handler.
                if (path === 'commodityTrade.assetKey') {
                    Logic.handleCommodityChange(value);
                    return; 
                }

                const keys = path.split(/[\.\[\]]+/).filter(Boolean);
                let current = AppState.modeler;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (current[keys[i]] === undefined) return;
                    current = current[keys[i]];
                }
                const finalKey = keys[keys.length - 1];
                let processedValue = value;
                if(type === 'text' && current[finalKey] && typeof current[finalKey] === 'number') {
                    processedValue = parseFloat(value.replace(/,/g, '')) || 0;
                } else if (type === 'number' || type === 'range') {
                    processedValue = parseFloat(value) || 0;
                } else if (typeof current[finalKey] === 'boolean') {
                    processedValue = (value === 'true');
                }
                current[finalKey] = processedValue;
                Logic.updateModelerUI(false);
            },

            // THIS IS THE NEW INTELLIGENT HANDLER FUNCTION
            handleCommodityChange: (assetKey) => {
    const commodityState = AppState.modeler.commodityTrade;
    commodityState.assetKey = assetKey;

    // Intelligent UoM Parsing
    const keyParts = assetKey.split('-');
    if (keyParts.length >= 2) {
        const uomCode = keyParts[1].toUpperCase();
        // Expansive map for robust matching
        const uomMap = {
            'BBL': 'Barrel', 'MT': 'Metric Ton', 'TONNE': 'Tonne', 'KG': 'Kilogram',
            'GAL': 'Gallon', 'L': 'Liter', 'OZ': 'Troy Ounce', 'LB': 'Pound', 'MMBTU': 'MMBtu',
            'CBM': 'Cubic Meter'
        };
        
        // Find a full name match, or fallback to the code itself if it's a direct key
        const matchedUoM = Object.values(uomMap).find(val => val.toUpperCase().startsWith(uomCode)) || uomMap[uomCode];
        if (matchedUoM) {
            commodityState.unitOfMeasure = matchedUoM;
        }
    }
    // Trigger a full, clean re-render to update all dependent UI elements
    Logic.updateModelerUI(true);
},

// =======================================================================
// === PINNACLE UPGRADE: INSTITUTIONAL ANALYSIS LAUNCHER (v1.0) ===
// This function is the refined and correctly integrated version of your script.
// =======================================================================
launchInstitutionalAnalysis: () => {
    // Check if a valid deal is structured
    if (!AppState.modeler || !AppState.modeler.commodityTrade.assetKey) {
        Logic.showNotification(
            "Please structure a deal first before launching the analysis suite.",
            'error',
            'Deal Parameters Required'
        );
        return;
    }

    const dealType = AppState.modeler.activeDealType;
    console.log('Opening Institutional Analysis Suite for:', dealType);

    // Use the premium notification system instead of a standard alert
    Logic.showNotification(
        `The full Institutional Analysis Suite for this ${dealType} deal would be launched here. This panel would provide deep-dive analytics, counterparty risk assessment, market volatility charts, and regulatory compliance checklists.`,
        'info',
        'Institutional Analysis Suite'
    );
    
    // In a full implementation, this would likely open a new, dedicated modal.
    // e.g., document.getElementById('institutional-analysis-modal').showModal();
},


            updateModelerUI: (isFullRefresh = false) => {
                if (isFullRefresh) {
                    const inputContainer = document.getElementById('modeler-input-container');
                    if(inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
                }
                const calculation = Logic.calculateModel();
                const outputContainer = document.getElementById('modeler-output-container');
                if(outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);

                if (isFullRefresh) { 
                    document.querySelectorAll('#modeler-input-container [data-path]').forEach(el => {
                        const eventType = el.tagName === 'SELECT' || el.type === 'range' ? 'change' : 'input';
                        el.addEventListener(eventType, Utils.debounce(Logic.handleModelerInputChange, 250));
                    });
                }
            },
            calculateModel: () => {
                const { activeDealType, pricingConfig } = AppState.modeler;
                const calculationFunc = Logic[`calculate${activeDealType}`];
                if (!calculationFunc) return null;

                const dealCalc = calculationFunc();
                const { baseValueUSD } = dealCalc;

                const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (pricingConfig.grossValue / 100) : pricingConfig.grossValue;
                const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (pricingConfig.netValue / 100) : pricingConfig.netValue;
                
                let finalValueToBuyerUSD, totalCommissionPool;
                if(pricingConfig.offerType === 'discount') {
                    finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer;
                    totalCommissionPool = grossOffer - netToBuyerOffer;
                } else {
                    finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer;
                    totalCommissionPool = grossOffer - netToBuyerOffer;
                }
                totalCommissionPool = Math.max(0, totalCommissionPool);
                AppState.modeler.legal.totalCommission = totalCommissionPool;

                return {
                    ...dealCalc,
                    baseValueUSD,
                    finalValueToBuyerUSD,
                    totalCommissionPool,
                    netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`,
                    grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}`
                };
            },
            calculateAssetSwap: () => {
                const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
                const fromAsset = Utils.getAssetByKey(fromAssetKey);
                const toAsset = Utils.getAssetByKey(toAssetKey);
                const baseValueUSD = amount * fromAsset.price;
                const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0;
                const dealTitle = `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset} for ${toAsset.baseAsset}`;
                return { baseValueUSD, fromAsset, toAsset, rate, dealTitle };
            },
            // THIS IS THE NEW, ADVANCED CALCULATION ENGINE
            calculateCommodityTrade: () => {
                const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey } = AppState.modeler.commodityTrade;
                const asset = Utils.getAssetByKey(assetKey);
                const settlementAsset = Utils.getAssetByKey(settlementAssetKey);
                
                let effectivePricePerUnit = 0;
                let priceDerivation = '';

                switch(pricingModel) {
                    case 'Fixed':
                        effectivePricePerUnit = fixedPrice;
                        priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`;
                        break;
                    case 'Premium':
                        effectivePricePerUnit = asset.price + discountPremiumValue;
                        priceDerivation = `Market + ${Utils.formatPrice(discountPremiumValue)} premium`;
                        break;
                    case 'Discount':
                    default:
                        effectivePricePerUnit = asset.price - discountPremiumValue;
                        priceDerivation = `Market - ${Utils.formatPrice(discountPremiumValue)} discount`;
                        break;
                }

                const baseValueUSD = quantity * effectivePricePerUnit;
                const dealTitle = `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`;
                
                let settlementAmount = 0;
                if (settlementAsset && settlementAsset.price > 0) {
                    settlementAmount = baseValueUSD / settlementAsset.price;
                }

                return { 
                    baseValueUSD, 
                    dealTitle, 
                    priceDerivation,
                    effectivePricePerUnit,
                    settlementAmount,
                    settlementAsset
                };
            },
            calculateCryptoLoan: () => {
                const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
                const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
                const collateralValueUSD = collateralAmount * collateralAsset.price;
                const loanPrincipal = collateralValueUSD * (ltv / 100);
                const totalInterest = loanPrincipal * (interestRateValue / 100) * ((tenureMonths || 1) / 12);
                const totalRepayment = loanPrincipal + totalInterest;
                return { baseValueUSD: loanPrincipal, loanPrincipal, totalRepayment, loanCurrency, tenureMonths, interestRateValue, dealTitle: `Loan against ${collateralAsset.baseAsset}` };
            },
            calculateSBLCMonetization: () => {
                const { faceValue, ltv } = AppState.modeler.sblcMonetization;
                const baseValueUSD = faceValue * (ltv / 100);
                return { baseValueUSD, dealTitle: `LTV on ${Utils.formatPrice(faceValue)} SBLC` };
            },
            resetModelerState: () => {
                // DEFINITIVE FIX: The defaultState object is now perfectly aligned with the universal
                // 'AssetSwap' architecture, eradicating the 'CryptoSwap' ghost state.
                const defaultState = {
                    activeDealType: 'AssetSwap',
                    assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
                    // REPLACE the old `commodityTrade` object with this severely upgraded version.
                
                // In AppState.modeler
commodityTrade: {
    assetKey: 'WTI-BBL-USD',
    quantity: 100000,
    unitOfMeasure: 'Barrel',
    qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%',
    origin: 'United States',
    port: 'Houston',
    incoterms: 'FOB',
    procedures: `• Standard TTV (Tank-to-Vessel) Procedures
• Inspection by SGS, Intertek, or equivalent at loading port.
• Seller provides CIQ (or equivalent) for customs clearance.
• Buyer issues Dip Test Authorization (DTA) upon successful documentary review.
• Payment via Irrevocable Documentary Letter of Credit (IDLC) from a prime bank.`,
    pricingModel: 'Discount', // Can be 'Fixed' or 'Premium'
    fixedPrice: 0,
    discountPremiumValue: 0, // Represents the value for discount/premium
    settlementAssetKey: 'USD', // Default settlement currency
},


                    cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                    sblcMonetization: { faceValue: 100000000, ltv: 80 },
                    pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                    legal: { isModalOpen: false, jurisdiction: 'England and Wales', totalCommission: 0, groups: [] }
                };
                AppState.modeler = JSON.parse(JSON.stringify(defaultState));
                
                // Re-run the dynamic initialization to populate the asset swap keys correctly after reset.
                const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
                if (allSwappableAssets.length >= 2) {
                    AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key;
                    AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key;
                }
                Logic.updateModelerUI(true);
            },
                        swapAssets: () => {
                const swapState = AppState.modeler.assetSwap;
                const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey);
                const toAsset = Utils.getAssetByKey(swapState.toAssetKey);

                // SEVERE UPGRADE: The swap logic is now profoundly accurate. It preserves
                // the total USD value of the transaction instead of just swapping keys.
                if (fromAsset.price > 0 && toAsset.price > 0) {
                    const totalUsdValue = swapState.amount * fromAsset.price;
                    // Calculate the new amount based on the value and the new 'from' asset's price.
                    swapState.amount = totalUsdValue / toAsset.price;
                }
                
                // Swap the asset keys *after* calculations are complete.
                [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
                
                // Animate the icon for visual feedback.
                const icon = document.getElementById('swap-icon');
                if (icon) {
                    icon.style.animation = 'none';
                    void icon.offsetWidth;
                    icon.style.animation = 'swap-icon-spin 0.5s ease-in-out';
                }
                
                // Force a full re-render to update all fields with the new, accurate data.
                Logic.updateModelerUI(true);
            },
            togglePricingConfig: () => { AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible; Logic.updateModelerUI(true); },
            
            // IMFPA/NCNDA Logic
            openImfpaModal: () => { document.getElementById('imfpa-modal-content').innerHTML = UI.renderImfpaModal(); Logic.refreshImfpaModalUI(); document.getElementById('imfpa-modal').showModal(); },
            refreshImfpaModalUI: () => {
                const { legal } = AppState.modeler;
                document.getElementById('imfpa-groups-container').innerHTML = UI.renderImfpaGroups();
                document.getElementById('imfpa-legal-parties').innerHTML = legal.groups.flatMap(g => g.parties).map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') || '<p class="text-xs text-text-muted">No parties defined in allocation groups.</p>';
                document.querySelectorAll('#imfpa-modal-content [data-path]').forEach(el => {
                    const eventType = el.tagName === 'SELECT' || el.type === 'range' ? 'change' : 'input';
                    el.addEventListener(eventType, Utils.debounce(Logic.handleModelerInputChangeInModal, 250));
                });
            },
                        // ----- In the Logic Controller Object -----

            // SEVERE FIX: This function is now surgically targeted. It NO LONGER performs a full, disruptive re-render.
            // Instead, it calls the new `updateImfpaCalculations` function for a smooth user experience while typing.
            handleModelerInputChangeInModal: (e) => {
                Logic.handleModelerInputChange(e);
                Logic.updateImfpaCalculations();
            },

            // SEVERE FIX (NEW FUNCTION): This new function is the heart of the fix.
            // It updates ONLY the calculated values in the DOM without rebuilding the form inputs,
            // thus preserving focus and providing an instantaneous, non-disruptive update.
            updateImfpaCalculations: () => {
                const { legal } = AppState.modeler;
                const { groups, totalCommission } = legal;

                // 1. Update overall total allocation percentage
                const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
                if (totalAllocatedEl) {
                    totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
                    totalAllocatedEl.className = `text-right font-mono text-sm ${totalGroupPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}`;
                }

                // 2. Update individual group values and their internal party percentages
                groups.forEach((g, groupIndex) => {
                    const groupValue = totalCommission * (g.percentage / 100);
                    const groupValueEl = document.getElementById(`imfpa-group-value-${groupIndex}`);
                    if (groupValueEl) {
                        groupValueEl.textContent = Utils.formatPrice(groupValue);
                    }

                    const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
                    if (groupTotalEl) {
                        groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
                        groupTotalEl.className = `text-right font-mono text-xs ${totalPartyPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}`;
                    }
                });

                // 3. Update the list of signatory parties (their names)
                const legalPartiesEl = document.getElementById('imfpa-legal-parties');
                if (legalPartiesEl) {
                    legalPartiesEl.innerHTML = legal.groups.flatMap(g => g.parties).map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') || '<p class="text-xs text-text-muted">No parties defined in allocation groups.</p>';
                }
            },

            // NOTE: These functions correctly continue to use `refreshImfpaModalUI` because they
            // perform structural changes (adding/removing elements) which require a full DOM rebuild of the list.
            addImfpaGroup: () => { AppState.modeler.legal.groups.push({ name: `Group ${AppState.modeler.legal.groups.length + 1}`, percentage: 0, parties: [] }); Logic.refreshImfpaModalUI(); },
            removeImfpaGroup: (i) => { AppState.modeler.legal.groups.splice(i, 1); Logic.refreshImfpaModalUI(); },
            addImfpaParty: (groupIndex) => { AppState.modeler.legal.groups[groupIndex].parties.push({ legalName: `New Party`, role: 'Intermediary', percentage: 0, detailsVisible: true, email: '', contactNumber: '', passport: { number: '', issueDate: '', expiryDate: '', authority: '' }, payment: {method: 'Bank Wire', currency: 'USD', details: ''} }); Logic.refreshImfpaModalUI(); },
            removeImfpaParty: (groupIndex, partyIndex) => { AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1); Logic.refreshImfpaModalUI(); },
            togglePartyDetails: (groupIndex, partyIndex) => { const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex]; party.detailsVisible = !party.detailsVisible; Logic.refreshImfpaModalUI(); },
            
                        generateContract: () => {
    const { legal } = AppState.modeler;
    const calc = Logic.calculateModel();
    if (!calc) { 
        Logic.showNotification("Cannot generate contract. Please define the core deal parameters first.", 'error');
        return; 
    }

    // Enhanced recitals with elevated legal language
    let recitalsText = '';
    switch(AppState.modeler.activeDealType) {
        case 'AssetSwap':
            recitalsText = `WHEREAS, the Contracting Parties have entered into preliminary negotiations concerning a sophisticated digital and/or physical asset exchange transaction contemplating the bilateral swap of approximately ${Utils.formatNumber(AppState.modeler.assetSwap.amount)} units of ${calc.fromAsset.baseAsset} in consideration for equivalent value in ${calc.toAsset.baseAsset}, subject to market valuations and regulatory compliance;`;
            break;
        case 'CommodityTrade':
            const ct = AppState.modeler.commodityTrade;
            recitalsText = `WHEREAS, the Contracting Parties are engaged in commercial negotiations for the procurement, sale, and delivery of physical commodities, specifically ${Utils.formatNumber(ct.quantity)} ${ct.unitOfMeasure} of premium-grade ${Utils.getAssetByKey(ct.assetKey).baseAsset}, in accordance with international trade conventions and applicable commodity exchange regulations;`;
            break;
        case 'CryptoLoan':
            const cl = AppState.modeler.cryptoLoan;
            recitalsText = `WHEREAS, the Contracting Parties seek to establish a sophisticated credit facility secured by digital asset collateral, encompassing a principal loan amount of ${Utils.formatPrice(calc.loanPrincipal, cl.loanCurrency)} against pledged collateral consisting of ${Utils.formatNumber(cl.collateralAmount)} units of ${Utils.getAssetByKey(cl.collateralAssetKey).baseAsset}, subject to regulatory compliance and risk management protocols;`;
            break;
        case 'SBLCMonetization':
            const sblc = AppState.modeler.sblcMonetization;
            recitalsText = `WHEREAS, the Contracting Parties are collaborating on the monetization and financial optimization of a Standby Letter of Credit (SBLC) instrument bearing a face value of ${Utils.formatPrice(sblc.faceValue)}, issued by a prime banking institution and compliant with ICC UCP 600 standards;`;
            break;
        default:
            recitalsText = `WHEREAS, the Contracting Parties have established a framework for cooperation in connection with a substantial international financial transaction of significant commercial value and strategic importance;`;
    }

        // --- SEVERELY UPGRADED FEE DISTRIBUTION SCHEDULE (PREMIUM TABLE FORMAT) ---
    const feeClauses = legal.groups.map((g) => {
        const groupPayout = legal.totalCommission * (g.percentage / 100);

        const partiesRows = g.parties.map((p) => {
            const partyValue = groupPayout * (p.percentage / 100);
            const settlementDetailsText = p.payment.details || 'To be furnished through separate, encrypted KYC/KYB documentation exchange pursuant to regulatory requirements';

            return `
            <tr>
                <td>
                    <div class="beneficiary-name">${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'}</div>
                    <div class="beneficiary-role">${p.role || '[ROLE NOT DESIGNATED]'}</div>
                </td>
                <td>
                    <div class="allocation-value">${p.percentage}%</div>
                    <div class="text-muted">${Utils.formatPrice(partyValue, 'USD')}</div>
                </td>
                <td>
                    <div class="settlement-method">${p.payment.method?.toUpperCase() || '[METHOD]'} (${p.payment.currency || 'N/A'})</div>
                    <div class="settlement-details">${settlementDetailsText}</div>
                </td>
            </tr>`;
        }).join('');

        const tableBody = g.parties.length > 0
            ? partiesRows
            : `<tr class="no-parties-row"><td colspan="3">(No designated beneficiaries specified for this distribution group)</td></tr>`;

        return `
        <div class="fee-group-container">
            <div class="fee-group-header">
                <span class="fee-group-header-title">Distribution Group: "${g.name.toUpperCase()}"</span>
                <span class="fee-group-header-value">${g.percentage}% (${Utils.formatPrice(groupPayout, 'USD')})</span>
            </div>
            <table class="fee-distribution-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Beneficiary & Role</th>
                        <th style="width: 20%;">Allocation</th>
                        <th style="width: 40%;">Remittance Instructions</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableBody}
                </tbody>
            </table>
        </div>`;
    }).join('');

    // Enhanced party signature blocks
    // --- UPGRADED: ENHANCED PARTY SIGNATURE BLOCKS WITH UNIQUE IDENTIFIERS ---
const signatureBlocks = legal.groups.flatMap(g => g.parties).map((p, i) => `
<div class="signature-block" data-signature-id="party-${i}">
    <div class="signature-line">
        <strong>CONTRACTING PARTY ${i+1}:</strong> ${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'}
    </div>
    <div class="signature-details">
        <div class="signature-field">
            <span class="field-label">Authorized Signature:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Printed Name & Title:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Date of Execution:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Corporate Seal (if applicable):</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
    </div>
</div>`).join('\n');

    // Enhanced party details table
    const partyDetailsTable = legal.groups.flatMap(g => g.parties).map((p, i) => `
<div class="party-details-section">
    <h4>CONTRACTING PARTY ${i+1} - COMPREHENSIVE DETAILS</h4>
    <table class="party-details-table">
        <tbody>
            <tr>
                <td class="detail-label">Legal Entity Name:</td>
                <td class="detail-value">${p.legalName || '[REQUIRED - NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Functional Role & Capacity:</td>
                <td class="detail-value">${p.role || '[ROLE NOT DESIGNATED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Primary Contact Email:</td>
                <td class="detail-value">${p.email || '[EMAIL ADDRESS REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Direct Contact Number:</td>
                <td class="detail-value">${p.contactNumber || '[CONTACT NUMBER REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Passport/ID Number:</td>
                <td class="detail-value">${p.passport.number || '[IDENTIFICATION REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Document Issue Date:</td>
                <td class="detail-value">${p.passport.issueDate || '[DATE REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Document Expiry Date:</td>
                <td class="detail-value">${p.passport.expiryDate || '[DATE REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Issuing Authority:</td>
                <td class="detail-value">${p.passport.authority || '[AUTHORITY REQUIRED]'}</td>
            </tr>
        </tbody>
    </table>
    
    <h5>REMITTANCE & SETTLEMENT COORDINATES</h5>
    <table class="payment-details-table">
        <tbody>
            <tr>
                <td class="detail-label">Fee Allocation Percentage:</td>
                <td class="detail-value">(As specified in Article 3 - Fee Distribution Schedule)</td>
            </tr>
            <tr>
                <td class="detail-label">Preferred Payment Method:</td>
                <td class="detail-value">${p.payment.method || '[METHOD NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Settlement Currency:</td>
                <td class="detail-value">${p.payment.currency || '[CURRENCY NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Banking/Payment Details:</td>
                <td class="detail-value">${p.payment.details || 'To be furnished through separate, secure KYC/KYB documentation exchange in compliance with AML/CTF regulations'}</td>
            </tr>
        </tbody>
    </table>
</div>`).join('\n\n');

    const agreementReference = `GECAN-IMFPA-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
    const effectiveDate = new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Add this line right before `const contractHTML`
const generatedDateTime = new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });

    const contractHTML = `
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

        /* =========================================================
   === PREMIUM FEE DISTRIBUTION TABLE STYLES (v2.0) ===
   ========================================================= */
.fee-group-container {
    margin-top: 25px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    background: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
}

.fee-group-header {
    background: #f7fafc;
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.fee-group-header-title {
    font-size: 13px;
    font-weight: 600;
    color: #2d3748;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.fee-group-header-value {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: 600;
    color: #2c5282;
}

.fee-distribution-table {
    width: 100%;
    border-collapse: collapse;
}

.fee-distribution-table th, 
.fee-distribution-table td {
    padding: 12px 16px;
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid #e2e8f0;
    font-size: 11px;
    line-height: 1.5;
}

.fee-distribution-table th {
    font-weight: 600;
    font-size: 10px;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background-color: #f8f9ff;
}

.fee-distribution-table tr:last-child td {
    border-bottom: none;
}

.beneficiary-name {
    font-weight: 600;
    font-size: 12px;
    color: #1a202c;
}

.beneficiary-role {
    font-style: italic;
    color: #4a5568;
}

.allocation-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: #2c5282;
}

.settlement-method {
    font-weight: 600;
    text-transform: uppercase;
}

.settlement-details {
    font-family: 'Courier New', monospace;
    font-size: 10px;
    color: #4a5568;
    word-break: break-all;
}

.no-parties-row td {
    text-align: center;
    font-style: italic;
    color: #718096;
    padding: 20px;
}
        
        .contract-document {
            font-family: 'Crimson Text', 'Times New Roman', serif;
            line-height: 1.6;
            color: #1a1a1a;
            max-width: 8.5in;
            margin: 0 auto;
            padding: 1in;
            background: #ffffff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .document-header {
            text-align: center;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .classification-banner {
            background: linear-gradient(135deg, #2c5282, #3182ce);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }
        
        .document-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c5282;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 15px 0;
        }
        
        .agreement-metadata {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .metadata-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .metadata-label {
            font-weight: 600;
            color: #2d3748;
        }
        
        .metadata-value {
            color: #4a5568;
            font-family: 'Courier New', monospace;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #2c5282;
            text-transform: uppercase;
            border-bottom: 2px solid #2c5282;
            padding-bottom: 5px;
            margin: 30px 0 20px 0;
            letter-spacing: 0.5px;
        }
        
        .article-header {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 25px 0 15px 0;
            text-transform: uppercase;
        }
        
        .clause-text {
            text-align: justify;
            margin: 12px 0;
            text-indent: 0.5in;
        }
        
        .whereas-clause {
            margin: 15px 0;
            padding-left: 20px;
            text-align: justify;
            font-style: italic;
        }
        
        .fee-distribution {
            background: #f8f9ff;
            border-left: 4px solid #2c5282;
            padding: 15px;
            margin: 20px 0;
            font-size: 11px;
        }
        
        .party-details-section {
            margin: 25px 0;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .party-details-section h4 {
            background: #2c5282;
            color: white;
            padding: 12px;
            margin: 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .party-details-section h5 {
            background: #e2e8f0;
            color: #2d3748;
            padding: 8px 12px;
            margin: 0;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .party-details-table, .payment-details-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .party-details-table td, .payment-details-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
        }
        
        .detail-label {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            width: 35%;
            vertical-align: top;
        }
        
        .detail-value {
            color: #4a5568;
            font-family: 'Courier New', monospace;
        }
        
        .signature-block {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #2c5282;
            border-radius: 5px;
            background: #f8f9ff;
        }
        
        .signature-line {
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .signature-field {
            margin: 12px 0;
            display: flex;
            align-items: center;
        }
        
        .field-label {
            font-weight: 600;
            color: #2d3748;
            width: 200px;
            font-size: 11px;
        }
        
        .signature-line-border {
            flex: 1;
            border-bottom: 1px solid #2d3748;
            margin-left: 10px;
            height: 20px;
        }
        

        
        .page-break {
            page-break-before: always;
        }

                /* This rule styles the re-instated legal footer */
.legal-footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid #2c5282;
    font-size: 9px;
    color: #4a5568;
    text-align: center;
    page-break-inside: avoid; /* Prevents the footer from being split across pages */
}
        
        @media print {

          /* --- CORE PRINT ISOLATION (THE FIX) --- */
    /* 1. Hide all application UI elements that have the 'print-hide' class. */
    .print-hide {
        display: none !important;
    }
    
    /* 2. Make the master print container visible. */
    #print-area {
        display: block !important;
    }
            .contract-document {
                box-shadow: none;
                border: none;
                padding: 0.75in;
            }
            
            @page {
                margin: 0.75in;
                @top-left {
                    content: "${agreementReference}";
                    font-size: 9px;
                    color: #666;
                }
                @top-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 9px;
                    color: #666;
                }
                @bottom-center {
                    content: "CONFIDENTIAL & PROPRIETARY - This document contains legally privileged and confidential information";
                    font-size: 8px;
                    color: #666;
                }
            }
            
            .page-break {
                page-break-before: always;
            }
        }
    </style>
    
    <div class="contract-document">
        <div class="classification-banner">
            CONFIDENTIAL & PROPRIETARY - FOR AUTHORIZED CONTRACTING PARTIES EXCLUSIVELY
        </div>
        
        <div class="document-header">
            <div class="document-title">
                IRREVOCABLE MASTER FEE PROTECTION AGREEMENT<br>
                & NON-CIRCUMVENTION NON-DISCLOSURE COVENANT<br>
                (IMFPA-NCNDA)
            </div>
            <div style="height: 2px; background: linear-gradient(to right, #2c5282, #3182ce); margin: 15px 0;"></div>
        </div>
        
        <div class="agreement-metadata">
            <div class="metadata-row">
                <span class="metadata-label">AGREEMENT REFERENCE CODE:</span>
                <span class="metadata-value">${agreementReference}</span>
            </div>
            ${legal.spaReferenceCode ? `
            <div class="metadata-row" style="background-color: #fef3c7;">
                <span class="metadata-label" style="color: #92400e;">CROSS-REFERENCED SPA:</span>
                <span class="metadata-value" style="font-weight: bold; color: #92400e;">${legal.spaReferenceCode}</span>
            </div>
            ` : ''}
            <div class="metadata-row">
                <span class="metadata-label">EFFECTIVE DATE:</span>
                <span class="metadata-value">${effectiveDate}</span>
            </div>
            <div class="metadata-row">
                <span class="metadata-label">TRANSACTION IDENTIFIER:</span>
                <span class="metadata-value">[TO BE ASSIGNED UPON DEFINITIVE CLOSING]</span>
            </div>
            <div class="metadata-row">
                <span class="metadata-label">GOVERNING FRAMEWORK:</span>
                <span class="metadata-value">ICC Pubs. 769, UCP 600, URDG 758, Incoterms® 2020; FATF AML/CTF Standards</span>
            </div>
        </div>
        
                <div class="clause-text">
            This <strong>Irrevocable Master Fee Protection Agreement & Non-Circumvention Non-Disclosure Covenant</strong> (hereinafter referred to as this "Agreement") constitutes a legally binding and enforceable contract executed by and among the undersigned Contracting Parties (collectively referred to as "the Parties") acting with full corporate authority, fiduciary responsibility, and legal capacity. This Agreement is structured in accordance with, and shall be interpreted under, the highest standards of international commercial practice. This includes, but is not limited to, principles promulgated by the International Chamber of Commerce (ICC), Paris, France, such as ICC Publication No. 769 (IMFPA), the Uniform Customs and Practice for Documentary Credits (UCP 600), the Uniform Rules for Demand Guarantees (URDG 758), and Incoterms® 2020. Furthermore, all activities and remittances hereunder are subject to strict compliance with international Anti-Money Laundering (AML) and Counter-Terrorist Financing (CTF) regulations, including the standards set forth by the Financial Action Task Force (FATF).
        </div>
        
        <div class="section-header">PRELIMINARY RECITALS & FOUNDATIONAL WHEREAS CLAUSES</div>
        
        <div class="whereas-clause">
            ${recitalsText}
        </div>
        
        <div class="whereas-clause">
            WHEREAS, the Contracting Parties have entered into comprehensive discussions and negotiations for the purpose of establishing a mutually beneficial commercial relationship and have determined that their collective expertise, resources, and strategic positioning warrant collaborative participation in the aforementioned transaction;
        </div>
        
        <div class="whereas-clause">
            WHEREAS, in consideration of their respective contributions, efforts, and professional services rendered in connection with the successful negotiation, structuring, and consummation of the contemplated transaction, the Parties have established an aggregate commission fee pool to be distributed in accordance with the terms and conditions set forth herein;
        </div>
        
        <div class="whereas-clause">
            WHEREAS, all intermediary parties and facilitators are hereby classified and designated as "Professional Consultants" and their compensation shall be characterized as "Consultancy Fees" or "Professional Commissions," which compensation shall be protected under the irrevocable provisions of this Agreement;
        </div>
        
        <div class="whereas-clause">
            NOW, THEREFORE, in consideration of the mutual covenants, agreements, representations, and warranties contained herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged by all Parties, the Contracting Parties hereby agree to be legally bound by the following terms and conditions:
        </div>
        
        <div class="article-header">ARTICLE I: TRANSACTION DEFINITION & SCOPE</div>
        <div class="clause-text">
            <strong>1.1 Transaction Description:</strong> The subject matter of this Agreement encompasses a sophisticated financial transaction (hereinafter referred to as the "Principal Transaction" or "Project") with an estimated aggregate base value of ${Utils.formatPrice(calc.baseValueUSD)}, subject to final due diligence, regulatory approvals, and definitive documentation.
        </div>
        <div class="clause-text">
            <strong>1.2 Commission Pool Establishment:</strong> The Principal Transaction is contractually structured to generate an Aggregate Total Commission Pool in the amount of ${Utils.formatPrice(legal.totalCommission)} (the "Fee Pool"). This Fee Pool represents the gross commission spread established within the Principal Transaction's definitive commercial agreements and shall be distributed in accordance with the irrevocable allocation schedule detailed in Article III hereof.
        </div>
        <div class="clause-text">
            <strong>1.3 Legal Characterization:</strong> The Fee Pool constitutes earned professional compensation for consultancy services, transaction facilitation, and commercial intermediation rendered by the Parties in their respective professional capacities.
        </div>
        
        <div class="article-header">ARTICLE II: CONTRACTING PARTIES & BENEFICIAL OWNERSHIP</div>
        <div class="clause-text">
            <strong>2.1 Party Identification:</strong> The following natural persons and legal entities constitute the complete universe of Contracting Parties and beneficial recipients under this Agreement. Each Party hereby represents and warrants that they possess full legal authority, corporate capacity, and fiduciary authorization to bind their respective organizations and principals to the terms, conditions, and obligations contained herein.
        </div>
        
        <div class="clause-text">
            <strong>2.2 Comprehensive Party Registry:</strong>
            <ul style="padding-left: 30px; margin: 15px 0;">
                ${legal.groups.flatMap(g => g.parties).map((p, i) => 
                    `<li><strong>CONTRACTING PARTY ${i+1}:</strong> ${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'} - ${p.role || 'Professional Consultant'}</li>`
                ).join('')}
            </ul>
        </div>
        
        <div class="clause-text">
            <strong>2.3 Detailed Party Information:</strong> Comprehensive identification, contact, and remittance details for each Contracting Party are set forth in Annex A to this Agreement, which Annex forms an integral and binding component of this Agreement.
        </div>
        
        <div class="article-header">ARTICLE III: IRREVOCABLE FEE DISTRIBUTION & PAYMENT OBLIGATIONS</div>
        <div class="clause-text">
            <strong>3.1 Irrevocable Distribution Covenant:</strong> The Contracting Parties hereby irrevocably and unconditionally agree that the Aggregate Fee Pool shall be distributed directly, immediately, and without offset, deduction, or withholding (except as required by applicable law) from the designated Payer's transactional settlement account(s) to the respective Beneficiaries' designated receiving accounts as detailed in Annex A hereto.
        </div>
        
        <div class="clause-text">
            <strong>3.2 Payment Timeline & Method:</strong> Fee distribution shall be executed via authenticated SWIFT wire transfer or alternative internationally recognized electronic funds transfer method within a maximum of three (3) international banking days from the date of closing, settlement, and funds availability for each tranche or installment of the Principal Transaction.
        </div>
        
        <div class="clause-text">
    <strong>3.3 Detailed Distribution Schedule:</strong> The Aggregate Fee Pool distribution shall be allocated as follows:
</div>
        
        <div class="fee-distribution">
            ${feeClauses || '<div class="fee-group-container"><p class="p-4 text-center text-text-muted">(No fee distribution schedule has been defined in this draft version)</p></div>'}
        </div>
        
        <div class="page-break"></div>
        
        <div class="article-header">ARTICLE IV: NON-CIRCUMVENTION & NON-DISCLOSURE COVENANTS</div>
        <div class="clause-text">
            <strong>4.1 Absolute Non-Circumvention:</strong> The Contracting Parties hereby covenant and irrevocably agree not to, whether directly, indirectly, or through any affiliated entity, agent, representative, or third-party intermediary, circumvent, avoid, bypass, or exclude any other Contracting Party from participation in any commercial transaction with any corporation, financial institution, funding source, or individual person introduced by another Party during the term of this Agreement.
        </div>
        
        <div class="clause-text">
            <strong>4.2 Temporal Scope:</strong> This non-circumvention covenant shall remain in full force and effect for a period of five (5) years from the Effective Date and shall be binding upon the Parties, their principals, agents, affiliates, successors, and assigns.
        </div>
        
        <div class="clause-text">
            <strong>4.3 Comprehensive Non-Disclosure:</strong> The Contracting Parties acknowledge that they may have access to proprietary, confidential, and sensitive commercial information ("Confidential Information") including, but not limited to, the identity of the Parties, transaction procedures, financial data, commercial terms, and the existence of this Agreement itself.
        </div>
        
        <div class="clause-text">
            <strong>4.4 Confidentiality Obligations:</strong> All Confidential Information shall be held in absolute and strict confidence. Disclosure is expressly prohibited absent prior, unanimous written consent of all Contracting Parties, except as may be compelled by court order or applicable law, in which case immediate written notification shall be provided to all other Parties.
        </div>
        
        <div class="article-header">ARTICLE V: GOVERNING LAW, JURISDICTION & DISPUTE RESOLUTION</div>
        <div class="clause-text">
            <strong>5.1 Governing Law:</strong> This Agreement shall be governed by, construed, and enforced in accordance with the substantive laws of ${legal.jurisdiction || '[JURISDICTION TO BE SPECIFIED]'}, without regard to conflict of law principles.
        </div>
        
        <div class="clause-text">
            <strong>5.2 Dispute Resolution Mechanism:</strong> Any controversy, claim, or dispute arising out of or relating to this Agreement, or the breach, termination, enforcement, interpretation, or validity thereof, shall be resolved exclusively through binding arbitration administered by the International Chamber of Commerce (ICC) International Court of Arbitration pursuant to the ICC Rules of Arbitration then in effect.
        </div>
        
        <div class="clause-text">
            <strong>5.3 Arbitration Procedures:</strong> The seat of arbitration shall be [City, Country corresponding to Governing Law Jurisdiction]. The arbitration shall be conducted by a panel of three (3) arbitrators, with each Party selecting one arbitrator and the third arbitrator being selected by mutual agreement or, failing such agreement, by the ICC.
        </div>
        
        <div class="article-header">ARTICLE VI: INDEMNIFICATION & LIMITATION OF LIABILITY</div>
        <div class="clause-text">
            <strong>6.1 Mutual Indemnification:</strong> Each Contracting Party agrees to indemnify, defend, and hold harmless all other Parties from and against any and all claims, damages, losses, costs, and expenses (including reasonable attorneys' fees and costs) arising from or related to such Party's material breach of this Agreement or willful misconduct.
        </div>
        
        <div class="clause-text">
            <strong>6.2 Limitation of Liability:</strong> Except in cases of willful misconduct or fraud, each Party's liability shall be limited to direct damages and shall expressly exclude consequential, punitive, incidental, or special damages.
        </div>
        
        <div class="article-header">ARTICLE VII: GENERAL PROVISIONS & MISCELLANEOUS TERMS</div>
        <div class="clause-text">
            <strong>7.1 Binding Authority & Legal Effect:</strong> This Agreement constitutes a full recourse, legally binding, and enforceable contract. Any unauthorized circumvention, breach of confidentiality, or material default shall entitle the aggrieved Party(ies) to monetary damages equal to the maximum fee such Party would have realized from the Principal Transaction, plus all associated legal expenses and costs.
        </div>
        
        <div class="clause-text">
            <strong>7.2 Force Majeure:</strong> No Contracting Party shall be held liable for any failure or delay in performance under this Agreement if such failure or delay results from causes beyond such Party's reasonable control, including but not limited to acts of God, war, terrorism, pandemic, government action, or regulatory changes.
        </div>
        
        <div class="clause-text">
            <strong>7.3 Entire Agreement & Modification:</strong> This Agreement, together with all Annexes attached hereto, constitutes the entire understanding and agreement between the Parties and supersedes all prior negotiations, discussions, representations, and agreements relating to the subject matter hereof. This Agreement may only be modified by written amendment executed by all Contracting Parties.
        </div>
        
        <div class="clause-text">
            <strong>7.4 Execution & Delivery:</strong> This Agreement may be executed in multiple counterparts, each of which shall be deemed an original, and all of which together shall constitute one and the same instrument. Transmission of an executed signature page by electronic means (including PDF) shall be deemed equivalent to delivery of a manually executed original.
        </div>
        
        <div class="clause-text">
            <strong>7.5 Severability:</strong> If any provision of this Agreement is held to be invalid, illegal, or unenforceable, the validity, legality, and enforceability of the remaining provisions shall not be affected or impaired thereby.
        </div>
        
        <div class="section-header">EXECUTION & AUTHENTICATION</div>
        
        <div class="clause-text">
            <strong>IN WITNESS WHEREOF,</strong> the Contracting Parties have caused this Agreement to be executed by their respective duly authorized representatives as of the Effective Date first written above.
        </div>
        
        ${signatureBlocks}
        
        <div class="page-break"></div>
        
        <div class="section-header">ANNEX A: COMPREHENSIVE PARTY IDENTIFICATION & REMITTANCE DETAILS</div>
        
        <div class="clause-text">
            This Annex A forms an integral, binding, and enforceable component of the foregoing Agreement and contains comprehensive identification and payment coordination details for all Contracting Parties.
        </div>
        
        ${partyDetailsTable}
        
        <div class="legal-footer">
            <strong>CONFIDENTIAL & PROPRIETARY DOCUMENT</strong><br>
            This document contains legally privileged and confidential commercial information protected by attorney-client privilege and work product doctrine. Unauthorized disclosure,
            reproduction, or distribution is strictly prohibited and may result in civil and criminal penalties.
            <br><br>
            Document Reference: ${agreementReference} | Generated: ${generatedDateTime}
        </div>
        </div>
    </div>`;

    // Enhanced container setup with premium styling
    const container = document.getElementById('contract-preview-container');
    const printContainerContent = document.getElementById('print-content');
    
    if (container && printContainerContent) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: white; font-size: 18px; font-weight: 600; margin: 0 0 10px 0; text-align: center;">
                    <i class="fas fa-file-contract" style="margin-right: 10px;"></i>Premium Legal Contract Generated
                </h3>
                <p style="color: rgba(255,255,255,0.9); margin: 0; text-align: center; font-size: 14px;">
                    Professional-grade IMFPA-NCNDA document ready for legal review and execution
                </p>
            </div>
            
            
<!-- UPGRADED: DOCUMENT EXECUTION SUITE v3 (AUDIT-READY) -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="contract-execution-suite">
    <!-- Action Buttons -->
    <div class="md:col-span-2 flex gap-4">
         <button onclick="window.print()" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-print mr-2"></i>Print / Save PDF Draft</button>
         <button onclick="navigator.clipboard.writeText(document.querySelector('.contract-document').outerHTML)" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-copy mr-2"></i>Copy HTML</button>
         <button onclick="const container = document.getElementById('contract-preview-container'); container.classList.add('hidden'); container.innerHTML = '';" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-times mr-2"></i>Close Preview</button>
    </div>

    <!-- Signing Initiation Panel -->
    <div id="signing-initiation-panel" class="md:col-span-2 mt-4 p-4 border-t-2 border-blue-500/50 bg-blue-500/10 rounded-lg text-center">
        <p class="font-bold text-white mb-2">Step 1: Prepare Document & Apply Signatures</p>
        <p class="text-sm text-text-secondary mb-4">Apply all known signatures and corporate seals on behalf of the parties. This prepares the document for the final, binding workflow.</p>
        <button id="initiate-signing-btn" onclick="Logic.initiateSigningProcess()" class="btn-primary bg-gradient-to-r from-blue-500 to-indigo-600 border-blue-500 w-full md:w-auto px-8 py-3 font-bold">
            <i class="fas fa-pen-fancy mr-2"></i>Launch Signature Suite
        </button>
    </div>

    <!-- UPGRADED: Finalization & Workflow Panel -->
    <div id="signature-workflow-panel" class="md:col-span-2 mt-4 p-4 border-t-2 border-purple-500/50 bg-purple-500/10 rounded-lg text-center hidden">
         <p class="font-bold text-white mb-2">Step 2: Finalize & Initiate Secure Workflow</p>
         <p class="text-sm text-text-secondary mb-4">The document is prepared. This will lock the current version, generate a cryptographic fingerprint, and dispatch secure signing links to all remaining parties.</p>
         <button id="send-for-signature-btn" onclick="Logic.sendForSignature()" class="btn-primary bg-gradient-to-r from-purple-500 to-indigo-600 border-purple-500 w-full md:w-auto px-8 py-3 font-bold">
            <i class="fas fa-paper-plane mr-2"></i>Lock Document & Send to Parties
         </button>
    </div>
</div>
            
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 10px; font-size: 18px;"></i>
                    <h4 style="margin: 0; color: #1e40af; font-size: 16px; font-weight: 600;">Legal Notice & Professional Review Required</h4>
                </div>
                <p style="margin: 8px 0; color: #4b5563; line-height: 1.6;">
                    This document has been generated using premium legal templates and industry-standard language. However, 
                    <strong>professional legal counsel review is mandatory</strong> before execution. This contract contains 
                    binding obligations and should be customized to reflect specific jurisdictional requirements and 
                    transaction particulars.
                </p>
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-top: 15px; border-radius: 0 6px 6px 0;">
                    <p style="margin: 0; color: #92400e; font-size: 14px;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        <strong>Disclaimer:</strong> This generated contract is for reference purposes and requires professional 
                        legal review, jurisdictional customization, and regulatory compliance verification prior to execution.
                    </p>
                </div>
            </div>
            
            <div style="max-height: 800px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 10px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                ${contractHTML}
            </div>`;
        
        container.classList.remove('hidden');
        printContainerContent.innerHTML = contractHTML;
        
        // Add smooth scroll to contract after generation
        setTimeout(() => {
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        // Add notification for successful generation
        if (typeof showNotification === 'function') {
            showNotification('Premium legal contract generated successfully! Please review with legal counsel before execution.', 'success');
        }
    } else {
        console.error('Contract preview containers not found in DOM');
        alert('Error: Contract preview containers not found. Please ensure the page is properly loaded.');
    }
},

// ============================================================================================
// === SEVERE UPGRADE: PROPRIETARY DOCUMENT EXECUTION & MULTI-SIGNATURE SUITE v3.0 ===
// ============================================================================================
            // DEFINITIVE FIX v4.2 - This function now lists ALL parties to allow for modification.
            initiateSigningProcess: () => {
                const sigBlocks = document.querySelectorAll('#contract-preview-container .signature-block');
                const selectEl = document.getElementById('signature-target-select');
                
                selectEl.innerHTML = ''; // Always clear the list first

                if (sigBlocks.length === 0) {
                    return alert("Error: No signature blocks found in the contract. Please define at least one party and generate the contract.");
                }

                // THE FIX: Loop through ALL signature blocks and add them to the dropdown.
                // This removes the filter that prevented modification of already-signed parties.
                sigBlocks.forEach((block, index) => {
                    const partyName = block.querySelector('.signature-line strong').nextSibling.textContent.trim();
                    const option = new Option(`${index + 1}: ${partyName}`, index);
                    selectEl.add(option);
                });

                document.getElementById('signature-modal').showModal();
                Logic.switchSignatureMode('draw'); 
                
                document.getElementById('signature-timestamp').textContent = new Date().toISOString();
                document.getElementById('signature-location').textContent = 'Fetching...';
                fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
                    document.getElementById('signature-location').textContent = `${data.city}, ${data.country_name} (IP: ${data.ip})`;
                }).catch(() => { document.getElementById('signature-location').textContent = 'Location Not Available'; });
            },

// UPGRADED FUNCTION (v3.7) - Manages visibility of Draw, Upload, and Seal panels.
            switchSignatureMode: (mode) => {
                const panels = { draw: 'draw-mode-panel', upload: 'upload-mode-panel', seal: 'seal-mode-panel' };
                const tabs = { draw: 'draw-tab-btn', upload: 'upload-tab-btn', seal: 'seal-tab-btn' };

                Object.keys(panels).forEach(key => {
                    document.getElementById(panels[key]).classList.add('hidden');
                    document.getElementById(tabs[key]).classList.remove('border-green-500', 'text-white');
                });

                document.getElementById(panels[mode]).classList.remove('hidden');
                document.getElementById(tabs[mode]).classList.add('border-green-500', 'text-white');
                
                document.getElementById('signature-modal').dataset.activeMode = mode;

                if (mode === 'draw') Logic.setupSignaturePad();
                if (mode === 'upload') Logic.setupSignatureUpload('signature');
                if (mode === 'seal') Logic.setupSignatureUpload('seal');
            },

            // UPGRADED FUNCTION (v3.7) - Resets all signature/seal inputs for a clean state.
            resetSignatureInputs: () => {
                if (window.signaturePad) window.signaturePad.clear();
                ['signature-upload', 'seal-upload'].forEach(id => {
                    const input = document.getElementById(`${id}-input`);
                    const preview = document.getElementById(`${id}-preview`);
                    const promptEl = document.getElementById(id.replace('upload', 'prompt'));
                    if(input) input.value = '';
                    if(preview) { preview.src = ''; preview.classList.add('hidden'); }
                    if(promptEl) promptEl.classList.remove('hidden');
                });
            },

                        // DEFINITIVE FIX v4.1 - This function now uses a premium dark blue pen color for a realistic signature.
            setupSignaturePad: () => {
                const canvas = document.getElementById('signature-canvas');
                
                const resizeCanvas = () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
                        console.warn("Canvas dimensions are zero, resize delayed or failed.");
                        return;
                    }
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    const context = canvas.getContext("2d");
                    context.scale(ratio, ratio);
                    if (window.signaturePad) {
                        window.signaturePad.clear();
                    }
                };
                
                // Use a premium, deep navy blue color that matches the document's header styles.
                const premiumBlueColor = "#1A237E";

                if (!window.signaturePad) {
                    // THE FIX: The penColor is changed to the premium dark blue.
                    window.signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        penColor: premiumBlueColor 
                    });
                } else {
                    // Also update the color if the pad already exists.
                    window.signaturePad.penColor = premiumBlueColor;
                }
                
                // Use a minimal delay to ensure the modal is fully rendered before sizing the canvas.
                setTimeout(resizeCanvas, 50);
            },

clearSignaturePad: () => { window.signaturePad.clear(); },

            // UPGRADED FUNCTION (v3.8) - This function was missing and is now correctly implemented.
            setupSignatureUpload: (type) => { // type is 'signature' or 'seal'
                // Define the correct element IDs based on the provided type
                const inputId = (type === 'signature') ? 'signature-upload-input' : 'seal-upload-input';
                const previewId = (type === 'signature') ? 'signature-upload-preview' : 'seal-upload-preview';
                const promptId = (type === 'signature') ? 'upload-prompt' : 'seal-prompt';

                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const prompt = document.getElementById(promptId);
                
                // A crucial safety check to prevent silent errors if the HTML is ever changed.
                if (!input || !preview || !prompt) {
                    console.error(`CRITICAL ERROR: Could not find all necessary elements for upload type: '${type}'. Check HTML IDs.`);
                    return;
                }

                // This attaches the event handler that opens the file dialog and shows the preview.
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.remove('hidden');
                            prompt.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };
            },



             // DEFINITIVE FIX v4.2 - This function contains corrected counting logic and allows re-selection.
            applySignature: async () => {
                const modal = document.getElementById('signature-modal');
                const mode = modal.dataset.activeMode;
                const targetSelect = document.getElementById('signature-target-select');
                const selectedPartyIndex = targetSelect.value;
                const applyBtn = modal.querySelector('.btn-primary');
                
                if (selectedPartyIndex === null || selectedPartyIndex === '') {
                    return Logic.showNotification("No signatory selected. Please choose a party to apply the signature/seal for.", 'error', 'Selection Required');
                }

                let dataUrl = '';
                
                if (applyBtn) {
                    applyBtn.disabled = true;
                    applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                }

                try {
                    if (mode === 'draw') {
                        if (window.signaturePad.isEmpty()) throw new Error("Please provide a signature by drawing it on the canvas.");
                        dataUrl = window.signaturePad.toDataURL('image/png');
                    } else {
                        const previewImg = document.getElementById(mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview');
                        if (!previewImg || !previewImg.src || previewImg.src.startsWith('http') || previewImg.classList.contains('hidden')) {
                            const item = mode === 'upload' ? 'signature image' : 'corporate seal';
                            throw new Error(`Please upload a ${item} before applying.`);
                        }
                        dataUrl = await Logic.processImageForTransparency(previewImg.src);
                    }
                    
                    const containersToUpdate = [
                        document.getElementById('contract-preview-container'),
                        document.getElementById('print-content')
                    ];
                    let itemAppliedSuccessfully = false;
                    const dateOfExecution = new Date(document.getElementById('signature-timestamp').textContent).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    containersToUpdate.forEach(container => {
                        if (!container) return;
                        
                        const signatureBlocksInContainer = container.querySelectorAll('.signature-block');
                        const targetBlock = signatureBlocksInContainer[selectedPartyIndex];

                        if (targetBlock) {
                            if (mode === 'draw' || mode === 'upload') {
                                const signatureLine = targetBlock.querySelector('.signature-field .signature-line-border');
                                const dateLine = targetBlock.querySelectorAll('.signature-field .signature-line-border')[2];
                                if (signatureLine) signatureLine.innerHTML = `<img src="${dataUrl}" alt="Digital Signature" style="height: 50px; object-fit: contain; margin-top: -15px; margin-left: 5px;">`;
                                if (dateLine) dateLine.innerHTML = `<span style="font-family: 'Courier New', monospace; font-size: 11pt; padding-left: 5px;">${dateOfExecution}</span>`;
                                itemAppliedSuccessfully = true;
                            } else if (mode === 'seal') {
                                const targetField = targetBlock.querySelectorAll('.signature-field .signature-line-border')[3];
                                if (targetField) {
                                    targetField.innerHTML = `<img src="${dataUrl}" alt="Corporate Seal" style="height: 60px; width: 60px; object-fit: contain; margin-left: 5px; opacity: 0.8;">`;
                                    itemAppliedSuccessfully = true;
                                }
                            }

                            if (container.id === 'contract-preview-container') {
                                targetBlock.style.borderColor = 'var(--success-color)';
                                targetBlock.style.backgroundColor = 'rgba(34, 197, 94, 0.05)';
                            }
                        }
                    });
                    
                    if (!itemAppliedSuccessfully) {
                        throw new Error("Critical Error: Could not find the target signature/seal block in the document.");
                    }

                    modal.close();
                    Logic.resetSignatureInputs(); 
                    document.getElementById('signature-workflow-panel').classList.remove('hidden');
                    
                    // THE FIX for the incorrect count.
                    let remainingUnsignedParties = 0;
                    const allPartyBlocks = document.querySelectorAll('#contract-preview-container .signature-block');
                    allPartyBlocks.forEach(block => {
                        // A party is considered "unsigned" if their primary signature line (the first one) is empty.
                        const mainSignatureField = block.querySelector('.signature-field .signature-line-border');
                        if (mainSignatureField && !mainSignatureField.querySelector('img')) {
                            remainingUnsignedParties++;
                        }
                    });

                    const launchBtn = document.getElementById('initiate-signing-btn');
                    if (launchBtn) {
                        // THE FIX: The button is no longer disabled, allowing for re-selection and modification.
                        launchBtn.disabled = false;
                        if (remainingUnsignedParties > 0) {
                            launchBtn.innerHTML = `<i class="fas fa-pen-fancy mr-2"></i>Sign for Another Party (${remainingUnsignedParties} remaining)`;
                        } else {
                            launchBtn.innerHTML = `<i class="fas fa-check-double mr-2"></i>All Parties Signed (Ready to Finalize)`;
                        }
                    }

                    const partyName = targetSelect.options[targetSelect.selectedIndex].text;
                    const action = (mode === 'seal') ? 'Corporate Seal' : 'Signature';
                    Logic.showNotification(`${action} successfully applied for ${partyName}. The document preview has been updated.`, 'success', 'Application Successful');

                } catch (error) {
                    console.error("Application failed:", error);
                    Logic.showNotification(error.message, 'error', 'Application Failed');
                } finally {
                    if (applyBtn) {
                        applyBtn.disabled = false;
                        applyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Apply to Document';
                    }
                }
            },


// This function simulates the "military-grade" hashing on the client for demonstration
simpleHash: async (str) => {
                const buffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

                        // DEFINITIVE UPGRADE v4.4 - This function has been refactored.
            // Its ONLY responsibility now is to display the premium confirmation modal.
            sendForSignature: () => {
                document.getElementById('finalization-modal').showModal();
            },

          // REPLACE the existing `executeFinalizationWorkflow` function with this upgraded version.

            // RE-ENGINEERED FUNCTION v5.1 - Client-centric PDF generation with embedded styles.
            // This version has NO Google Drive or Sheets dependency and ensures high-quality PDF output.
            executeFinalizationWorkflow: async () => {
                document.getElementById('finalization-modal').close();
                const btn = document.getElementById('send-for-signature-btn');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF & Dispatching...`;

                try {
                    // --- STEP 1: GATHER FINAL DOCUMENT DATA & STYLES ---
                    const contractElement = document.getElementById('print-content');
                    if (!contractElement || !contractElement.innerHTML) {
                        throw new Error("Could not find the printable contract content. Please generate the contract first.");
                    }
                    
                    // NEW: Call our helper to get all the high-quality print CSS rules as a string.
                    const premiumPrintStyles = Logic.getPrintStyles();
                    if (!premiumPrintStyles) {
                        console.warn("No print styles were extracted. The final PDF may not be styled correctly.");
                    }

                    const finalDocumentHTML = contractElement.innerHTML;
                    const documentFingerprint = await Logic.simpleHash(finalDocumentHTML);
                    const agreementReferenceMatch = finalDocumentHTML.match(/AGREEMENT REFERENCE CODE:<\/span>\s*<span class="metadata-value">([^<]+)<\/span>/);
                    const agreementReference = agreementReferenceMatch ? agreementReferenceMatch[1].trim() : `GECAN-DOC-${Date.now()}`;
                    
                    const allPartiesFromState = AppState.modeler.legal.groups.flatMap(g => g.parties);
                    const recipientEmails = allPartiesFromState
                        .map(p => p.email)
                        .filter(email => email && email.includes('@'));

                    if (recipientEmails.length === 0) {
                        throw new Error("No valid recipient email addresses found in the IMFPA party details. Please add them before finalizing.");
                    }

                    // --- STEP 2: BUILD THE FULLY-STYLED, SELF-CONTAINED HTML FOR PDF CONVERSION ---
                    // This is the crucial new step.
                    const fullyStyledHtmlForPdf = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>${agreementReference}</title>
                            <style>
                                /* 
                                 * All premium print styles are injected here, ensuring the back-end
                                 * PDF generator renders the document perfectly.
                                 */
                                ${premiumPrintStyles}
                            </style>
                        </head>
                        <body>
                            <!-- The exact, cleaned contract HTML is placed here. -->
                            ${finalDocumentHTML}
                        </body>
                        </html>
                    `;

                    // --- STEP 3: BUILD THE PREMIUM PAYLOAD & EMAIL ---
                    const payload = {
                        agreementReference,
                        documentFingerprint,
                        parties: allPartiesFromState,
                        recipientEmails: recipientEmails.join(','),
                        bccEmails: 'pennworthventures@gmail.com,punchisum@gmail.com',
                        emailSubject: `FULLY EXECUTED: GECAN™ Agreement Ref: ${agreementReference}`,
                        fileName: `${agreementReference}_EXECUTED.pdf`
                    };
                    
                    payload.emailBody = Logic.generatePremiumEmailTemplate(payload);

                    // --- STEP 4: CALL BACK-END TO GENERATE PDF AND SEND EMAIL ---
                    // MODIFIED: We now pass the 'fullyStyledHtmlForPdf' string to the back-end.
                    console.log("SENDING DISPATCH PAYLOAD TO BACK-END...");
                    const response = await GAS.run('generatePdfAndDispatchEmail', payload, fullyStyledHtmlForPdf);

                    if (!response.success) {
                        throw new Error(response.message || "The server failed to generate the PDF or dispatch the email.");
                    }
                    
                    btn.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Dispatched Successfully`;
                    Logic.showNotification(
                        `The finalized PDF has been generated and dispatched to all ${recipientEmails.length} parties. Please check your email.`,
                        'success',
                        'Document Dispatched'
                    );

                } catch (err) {
                    console.error("Dispatch Failed:", err);
                    Logic.showNotification(err.message, 'error', 'Dispatch Failed');
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i>Lock Document & Send to Parties`;
                }
            },
             // =======================================================================
            // === NEW FUNCTION: PREMIUM EMAIL TEMPLATE GENERATOR (v1.0) ===
            // This is the missing function that generates the final email body.
            // =======================================================================
            generatePremiumEmailTemplate: (payload) => {
                const nowSGT = new Date().toLocaleString("en-US", { timeZone: "Asia/Singapore", dateStyle: 'full', timeStyle: 'long' });
                const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');

                return `
                <html>
                <body style="font-family: Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px;">
                    <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;">
                            <h1 style="margin: 0; font-size: 24px;">GECAN™ | Executed Agreement Attached</h1>
                        </div>
                        <div style="padding: 30px;">
                            <p>Dear Contracting Parties,</p>
                            <p>Please find attached the fully executed legal document pertaining to the referenced transaction. This document has been finalized and its state has been cryptographically recorded for audit purposes.</p>
                            
                            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                                <h3 style="margin-top: 0; color: #0369a1;">Agreement Details</h3>
                                <p style="margin: 5px 0;"><strong>Agreement Reference:</strong> ${payload.agreementReference}</p>
                                <p style="margin: 5px 0;"><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px; color: #555;">${payload.documentFingerprint}</code></p>
                                <p style="margin: 5px 0;"><strong>Finalization Timestamp:</strong> ${nowSGT}</p>
                            </div>

                            <h3 style="color: #0369a1;">Parties to this Agreement:</h3>
                            <ul style="padding-left: 20px;">
                                ${partyListHTML}
                            </ul>

                            <p>All parties should retain a copy of the attached PDF for their records. No further action is required unless otherwise specified within the document's terms.</p>
                            <p>Thank you for your cooperation.</p>
                            <p style="margin-top: 25px;"><strong>Sincerely,<br>The GECAN™ Transactional Systems</strong></p>
                        </div>
                        <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                            <p style="margin: 0;"><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication and any attachments are strictly confidential, legally privileged, and intended solely for the authorized recipients. Any unauthorized review, use, disclosure, or distribution is strictly prohibited.</p>
                        </div>
                    </div>
                </body>
                </html>
                `;
            },

            // =======================================================================
            // === NEW FUNCTION: PREMIUM EMAIL TEMPLATE GENERATOR (v1.0) ===
            // This is the missing function that generates the final email body.
            // =======================================================================
            generatePremiumEmailTemplate: (payload) => {
                const nowSGT = new Date().toLocaleString("en-US", { timeZone: "Asia/Singapore", dateStyle: 'full', timeStyle: 'long' });
                const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');

                return `
                <html>
                <body style="font-family: Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px;">
                    <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;">
                            <h1 style="margin: 0; font-size: 24px;">GECAN™ | Executed Agreement Attached</h1>
                        </div>
                        <div style="padding: 30px;">
                            <p>Dear Contracting Parties,</p>
                            <p>Please find attached the fully executed legal document pertaining to the referenced transaction. This document has been finalized and its state has been cryptographically recorded for audit purposes.</p>
                            
                            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                                <h3 style="margin-top: 0; color: #0369a1;">Agreement Details</h3>
                                <p style="margin: 5px 0;"><strong>Agreement Reference:</strong> ${payload.agreementReference}</p>
                                <p style="margin: 5px 0;"><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px; color: #555;">${payload.documentFingerprint}</code></p>
                                <p style="margin: 5px 0;"><strong>Finalization Timestamp:</strong> ${nowSGT}</p>
                            </div>

                            <h3 style="color: #0369a1;">Parties to this Agreement:</h3>
                            <ul style="padding-left: 20px;">
                                ${partyListHTML}
                            </ul>

                            <p>All parties should retain a copy of the attached PDF for their records. No further action is required unless otherwise specified within the document's terms.</p>
                            <p>Thank you for your cooperation.</p>
                            <p style="margin-top: 25px;"><strong>Sincerely,<br>The GECAN™ Transactional Systems</strong></p>
                        </div>
                        <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                            <p style="margin: 0;"><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication and any attachments are strictly confidential, legally privileged, and intended solely for the authorized recipients. Any unauthorized review, use, disclosure, or distribution is strictly prohibited.</p>
                        </div>
                    </div>
                </body>
                </html>
                `;
            },

// ======================= START: INSERT THE NEW CODE HERE =======================
            // =======================================================================
            // === NEW FUNCTION: PRINT STYLE EXTRACTOR (v1.0) ===
            // This function captures the high-quality print CSS for back-end PDF generation.
            // =======================================================================
            getPrintStyles: () => {
                let printCss = '';
                // Iterate through all stylesheets loaded on the page
                for (const sheet of document.styleSheets) {
                    try {
                        // Iterate through all rules in a stylesheet
                        for (const rule of sheet.cssRules) {
                            // Check if the rule is an @media rule and if it's for 'print'
                            if (rule.type === CSSRule.MEDIA_RULE && rule.media.mediaText === 'print') {
                                // If it matches, iterate through the rules *inside* the @media block
                                for (const printRule of rule.cssRules) {
                                    // Append the text content of each rule to our string
                                    printCss += printRule.cssText + '\n';
                                }
                            }
                        }
                    } catch (e) {
                        // Catch and log potential security errors when accessing cross-origin stylesheets
                        console.warn("Could not access stylesheet for print styles:", sheet.href, e);
                    }
                }
                // Return the complete block of CSS text
                return printCss;
            },
// ======================== END: INSERT THE NEW CODE HERE ========================




            // ===== END: UPGRADED INSTITUTIONAL MODELER LOGIC =====
        };

        // --- SECTION 6: BOOTSTRAP ---
        document.addEventListener('DOMContentLoaded', Logic.init);
    </script>
</body>
</html>