<!DOCTYPE html>
<html>
<head>
    <!-- ======================================================= -->
    <!-- HEAD: CONFIGURATION, LOGIC & STYLING ENGINE             -->
    <!-- ======================================================= -->

    <!-- I. Core Metadata & External Libraries -->
    <base target="_top">
    <title>GECAN™ Commodities Exchange | XDealFlow Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- II. JavaScript Logic Engine -->
    <script>
        // --- A. GLOBAL CONSTANTS & API CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxhC2bk6LMz2muF5TY8TdIt3tiAl6ozBAvgi1TG91v9WX2x2mH2M3SvpHu0nn8XgyN4/exec";
        const DEFAULT_THEME_CONFIG = {"particles":{"number":{"value":120,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.6,"random":true,"anim":{"enable":true,"speed":0.5,"opacity_min":0.1,"sync":false}},"size":{"value":2.5,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#4a4a5a","opacity":0.2,"width":1},"move":{"enable":true,"speed":1.5,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"window","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"repulse"},"resize":true},"modes":{"grab":{"distance":250,"line_linked":{"opacity":0.8,"color":"#8b5cf6"}},"repulse":{"distance":350,"duration":0.4}}},"retina_detect":true};

        // --- B. CENTRALIZED STATE MANAGEMENT ---
        const AppState = {
        allOffers: [], allEnquiries: [], allCrowdfunding: [], allServices: [],
        allFeatured: [], allBulletins: [], marketMatrix: [],
        activeFilters: { type: 'offers', query: '', assetCategory: 'All', statuses: [], settlementProtocol: 'All', coreProcedure: 'All' },
        activeSort: 'date_desc', currentView: 'card',
        isDataLoading: { offers: true, enquiries: true, crowdfunding: true, services: true, featured: true, bulletins: true, marketMatrix: true },
        liveUpdateInterval: null,
        timezones: [
            {name: "Los Angeles (PST)", value: "America/Los_Angeles"}, {name: "New York (EST)", value: "America/New_York"}, {name: "London (GMT)", value: "Europe/London"}, {name: "Zurich (CET)", value: "Europe/Zurich"}, {name: "Dubai (GST)", value: "Asia/Dubai"}, {name: "Singapore (SGT)", value: "Asia/Singapore"}, {name: "Hong Kong (HKT)", value: "Asia/Hong_Kong"}, {name: "Tokyo (JST)", value: "Asia/Tokyo"}, {name: "Sydney (AEST)", value: "Australia/Sydney"}
        ],
        clockInterval: null, userCountInterval: null,
        previousMarketPrices: {}, lastUpdateTimes: { offers: null, featured: null, bulletins: null },
        referralInfo: { id: null, partnerName: null }, connectionStatus: 'connected', engagementTargetOfferId: null
    };

        // --- C. UTILITY FUNCTIONS ---
        const Utils = {
        debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; },
        formatNumber: (num) => { if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B'; if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M'; if (num >= 1e3) return (num / 1e3).toFixed(0) + 'K'; return num.toString(); },
        formatCurrency: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount),
        parseDate: (dateStr) => { if (!dateStr || typeof dateStr !== 'string') return new Date('1970-01-01'); const d = new Date(dateStr); return isNaN(d.getTime()) ? new Date('1970-01-01') : d; },
        getAssetClass: (asset) => `asset-color-${String(asset).replace(/[\s\(\)\/&,]+/g, '_').replace(/_+$/, '').toUpperCase()}`,
        closeModal: (modalId = 'modal-overlay') => { const modal = document.getElementById(modalId); if (!modal || modal.classList.contains('hidden')) return; const mc = modal.querySelector('#modal-content-wrapper, div[id^="engagement-suite"]'); if (mc) { mc.style.transform = 'scale(0.95)'; mc.style.opacity = '0'; } modal.style.opacity = '0'; setTimeout(() => { modal.classList.add('hidden'); if (mc) mc.innerHTML = ''; modal.style.opacity = '1'; document.body.classList.remove('modal-open'); }, 300); },
        showNotification: (message, type = 'info') => { const t = document.createElement('div'); const s = {s:'bg-green-600',e:'bg-red-600',w:'bg-yellow-600',i:'bg-blue-600'}; t.className = `fixed top-4 right-4 p-4 rounded-xl shadow-2xl z-50 text-white font-medium ${s[type.charAt(0)]} backdrop-blur-lg fade-in-up`; t.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i><span>${message}</span></div>`; document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 300); }, 3000); }
    };

        // --- D. UI RENDERING & COMPONENT ENGINE ---
const UI = {
    /**
     * Initializes all foundational UI components that do not require backend data.
     * This includes dynamic backgrounds, default particles, clocks, and user count.
     */
    init: () => {
        document.body.classList.add('repulsor-active');
        document.addEventListener('mousemove', (e) => {
            document.body.style.setProperty('--mouse-x', `${e.clientX}px`);
            document.body.style.setProperty('--mouse-y', `${e.clientY}px`);
        });
        initInteractiveBackground();
        UI.initParticles(DEFAULT_THEME_CONFIG);
        UI.populateTimezoneSelect();
        UI.initClocks(["America/New_York", "Europe/London", "Asia/Singapore"]);
        UI.initUserCount();
        Logic.populateNavLinks();
        document.getElementById('loading-spinner').classList.remove('hidden');
    },

    // --- Component Initializers ---
    
    initParticles: (config) => {
        const themeConfig = config || DEFAULT_THEME_CONFIG;
        particlesJS('particles-js', themeConfig);
    },

    initClocks: (initialTimezones = []) => {
        const container = document.getElementById('clock-container');
        const toggleBtn = document.getElementById('toggle-command-center-btn');
        const commandCenter = document.getElementById('world-clock-command-center');
        
        if (!container || !toggleBtn || !commandCenter) {
            console.error("Command Center UI elements not found. Aborting clock initialization.");
            return;
        }

        container.innerHTML = '';
        if (AppState.clockInterval) clearInterval(AppState.clockInterval);

        initialTimezones.forEach(tz => UI.createClock(tz));
        
        AppState.clockInterval = setInterval(UI.updateAllClocks, 1000);
        UI.updateAllClocks();

        const isMinimized = localStorage.getItem('commandCenterMinimized') === 'true';
        if (isMinimized) {
            commandCenter.style.maxHeight = '0px';
            commandCenter.classList.add('minimized');
            toggleBtn.querySelector('.expand-text').textContent = 'Expand';
            toggleBtn.querySelector('.expand-icon').style.transform = 'rotate(180deg)';
        } else {
             // Set max-height on load to ensure it's not null for the animation
             commandCenter.style.maxHeight = commandCenter.scrollHeight + 'px';
        }

        toggleBtn.addEventListener('click', () => {
            const isCurrentlyMinimized = commandCenter.classList.toggle('minimized');
            if (isCurrentlyMinimized) {
                commandCenter.style.maxHeight = '0px';
                toggleBtn.querySelector('.expand-text').textContent = 'Expand';
                toggleBtn.querySelector('.expand-icon').style.transform = 'rotate(180deg)';
                localStorage.setItem('commandCenterMinimized', 'true');
            } else {
                commandCenter.style.maxHeight = commandCenter.scrollHeight + 'px';
                toggleBtn.querySelector('.expand-text').textContent = 'Minimize';
                toggleBtn.querySelector('.expand-icon').style.transform = 'rotate(0deg)';
                localStorage.setItem('commandCenterMinimized', 'false');
            }
        });
    },

    initUserCount: () => {
        const element = document.getElementById('user-count-visual');
        const countElement = element ? element.querySelector('p.font-bold') : null;
        if (!countElement) return;

        let userCount = 3699;
        let lastUserCount = userCount;

        const updateUserCount = () => {
            const change = Math.floor(Math.random() * 21) - 10;
            userCount = Math.max(699, Math.min(3699, userCount + change));
            countElement.textContent = userCount.toLocaleString('en-US');
            if (userCount !== lastUserCount) {
                element.classList.add('glow-active');
                setTimeout(() => element.classList.remove('glow-active'), 1000);
            }
            lastUserCount = userCount;
        };

        if (AppState.userCountInterval) clearInterval(AppState.userCountInterval);
        AppState.userCountInterval = setInterval(updateUserCount, 2200); 
        updateUserCount();
    },
    
    // --- Component Creators & Renderers ---

    createClock: (timezone) => {
        const container = document.getElementById('clock-container');
        const tzData = AppState.timezones.find(t => t.value === timezone);
        if (!tzData || !container || document.querySelector(`.clock[data-timezone="${timezone}"]`)) return;

        const separator = document.getElementById('clock-separator');
        if(separator) separator.classList.remove('hidden');

        const clockWrapper = document.createElement('div');
        clockWrapper.className = 'text-center fade-in-up relative group';
        clockWrapper.innerHTML = `
            <div class="clock" data-timezone="${tzData.value}">
                ${UI.createClockMarkers()}
                <div class="hand hour-hand"></div>
                <div class="hand minute-hand"></div>
                <div class="hand second-hand"></div>
            </div>
            <div class="mt-3">
                <p class="text-sm font-bold text-white">${tzData.name.split(' (')[0]}</p>
                <p class="text-xs text-gray-400 clock-time" data-timezone="${tzData.value}">--:--:--</p>
            </div>
            <button class="absolute -top-2 -right-2 w-7 h-7 bg-red-600/80 backdrop-blur-sm border border-white/10 rounded-full text-white text-sm font-bold opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-red-500 hover:scale-110 active:scale-95" 
                    onclick="UI.removeClock('${timezone}')">×</button>
        `;
        container.appendChild(clockWrapper);
    },

    createClockMarkers: () => {
        let markers = '';
        for (let i = 0; i < 12; i++) {
            markers += `<div class="clock-marker ${i % 3 === 0 ? 'major' : ''}" style="transform: translateX(-50%) rotate(${i * 30}deg)"></div>`;
        }
        return markers;
    },
    
    renderMarketTickers: () => {
        const container = document.getElementById('market-ticker-container');
        if (!container) return;
        container.innerHTML = '';

        const assetsToDisplay = ['BTC-USD', 'XAU-OZ-USD'];
        const filteredAssets = AppState.marketMatrix.filter(asset => assetsToDisplay.includes(asset.key));

        if (filteredAssets.length === 0 && !AppState.isDataLoading.marketMatrix) return;

        filteredAssets.forEach(asset => {
            const prevPrice = AppState.previousMarketPrices[asset.key] || asset.price;
            let changeClass = 'stale', changeIcon = 'fa-minus';
            if (asset.price > prevPrice) { changeClass = 'up'; changeIcon = 'fa-arrow-up'; }
            else if (asset.price < prevPrice) { changeClass = 'down'; changeIcon = 'fa-arrow-down'; }
            
            const flashClass = (asset.price !== prevPrice) ? `price-flash-${changeClass}` : '';
            const logoHTML = UI.getPremiumTickerLogoHTML(asset.key);

            const tickerDiv = document.createElement('div');
            tickerDiv.className = `market-ticker-item fade-in-up ${flashClass}`;
            tickerDiv.dataset.assetKey = asset.key;
            tickerDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <p class="font-bold text-white text-lg">${asset.baseAsset}/${asset.quoteAsset}</p>
                        <p class="text-xs text-gray-400">${asset.name}</p>
                    </div>
                    ${logoHTML}
                </div>
                <div class="flex items-end gap-3">
                    <p class="price price-${changeClass}">$${asset.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    <i class="fas ${changeIcon} text-lg mb-2 price-${changeClass}"></i>
                </div>
                <p class="text-xs text-gray-500 font-mono mt-1">Last Updated: ${new Date(asset.lastUpdated).toLocaleTimeString()}</p>
            `;
            container.appendChild(tickerDiv);
        });

        filteredAssets.forEach(asset => { AppState.previousMarketPrices[asset.key] = asset.price; });
    },

    getPremiumTickerLogoHTML: (assetKey) => {
        let svgContent = '';
        switch (assetKey) {
            case 'BTC-USD':
                svgContent = `<svg class="premium-ticker-svg" viewBox="0 0 100 100"><defs><radialGradient id="btc-grad" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFB94A"/><stop offset="100%" stop-color="#F7931A"/></radialGradient></defs><circle cx="50" cy="50" r="48" fill="url(#btc-grad)"/><path d="M69.1,53.9c0.8-4.6-2.1-7.2-6.9-9.3l2.2-8.8l-5.3-1.3l-2.1,8.5c-0.6-0.1-1.2-0.3-1.8-0.4l2.1-8.5l-5.3-1.3l-2.2,8.8c-0.5-0.1-1-0.2-1.5-0.3l0,0l-7.3-1.8l-1.4,5.6c0,0,4,1,3.9,1.1c2.1,0.5,2.7,2.1,2.6,3.4l-2.6,10.3c0.1,0,0.2,0.1,0.4,0.1c-0.2-0.1-0.4-0.1-0.6-0.2l-1.7,6.7c-0.4,0.8-1.3,1.9-3.2,1.4c-0.1-0.1-3.9-1-3.9-1l-2.6,6.1l7,1.7c0.5,0.1,1,0.2,1.5,0.4l-2.2,8.9l5.3,1.3l2.2-8.8c0.6,0.2,1.2,0.3,1.8,0.4l-2.2,8.8l5.3,1.3l2.2-8.9c3.9,0.7,7,0,8.8-3.6c1.6-3.3,1.1-6.2-0.5-8.6C70.3,57,70.1,55.5,69.1,53.9z M61.7,63.1c-1,4.1-5.6,5.6-9.5,4.6l1.8-7.2c0.5,0.1,1,0.3,1.5,0.4l-0.1-0.4C60.2,61,62.3,60.1,61.7,63.1z M62.8,49.9c-0.9,3.6-4.9,5-8.2,4.2l1.7-6.7c0.5,0.1,0.9,0.2,1.4,0.3l-0.1-0.4C61.4,47.7,63.4,47.1,62.8,49.9z" fill="#FFFFFF"/></svg>`;
                break;
            case 'XAU-OZ-USD':
                svgContent = `<svg class="premium-ticker-svg" viewBox="0 0 100 100"><defs><linearGradient id="gold-grad-top" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FEF08A" /><stop offset="100%" stop-color="#FDE68A" /></linearGradient><linearGradient id="gold-grad-front" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FBBF24" /><stop offset="100%" stop-color="#D97706" /></linearGradient></defs><polygon points="15,30 85,30 75,50 25,50" fill="url(#gold-grad-top)" /><polygon points="25,50 75,50 75,70 25,70" fill="url(#gold-grad-front)" /><text x="50" y="65" font-family="Orbitron, monospace" font-size="8" fill="#000" text-anchor="middle" font-weight="bold" opacity="0.4">FINE GOLD</text></svg>`;
                break;
            default:
                svgContent = `<svg class="premium-ticker-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="var(--background-secondary)"/></svg>`;
        }
        return `<div class="ticker-logo-container"><div class="ticker-logo-flipper"><div class="logo-face-front">${svgContent}</div><div class="logo-face-back">${svgContent}</div></div></div>`;
    },

    renderHoloStream: () => {
        const track = document.querySelector('.holo-stream-track');
        if (!track) return;
        const featured = (AppState.allFeatured || []).map(item => ({ type: 'opportunity', icon: 'fa-star', color: 'var(--asset-gold)', title: item.TITLE, details: item.DETAILS }));
        const bulletins = (AppState.allBulletins || []).map(item => ({ type: 'bulletin', icon: 'fa-bullhorn', color: 'var(--primary-azure)', title: item.TYPE, details: item.MESSAGE }));
        const allItems = [...featured, ...bulletins];
        if (allItems.length === 0) {
            track.innerHTML = `<div class="holo-item" style="cursor: default;"><p class="text-gray-500">No active alerts.</p></div>`;
            return;
        }
        const itemsHtml = allItems.map(item => `
            <div class="holo-item" data-type="${item.type}">
                <div class="icon-container" style="color: ${item.color};"><i class="fas ${item.icon} fa-fw"></i></div>
                <div class="text-content"><p class="font-bold text-base">${item.title}</p><p class="text-sm text-gray-400">${item.details}</p></div>
            </div>`).join('');
        track.innerHTML = itemsHtml.repeat(4);
        Logic.initHoloStreamListeners();
    },

    renderCards: (items, type) => {
        const container = document.getElementById('card-container');
        if (!items || items.length === 0) {
            container.innerHTML = ''; return;
        }
        let cardHTML = '';
        switch (type) {
            case 'enquiries': cardHTML = items.map(UI.createEnquiryCardHTML).join(''); break;
            case 'crowdfunding': cardHTML = items.map(UI.createProjectCardHTML).join(''); break;
            case 'services': cardHTML = items.map(UI.createServiceCardHTML).join(''); break;
            default: cardHTML = items.map(UI.createOfferCardHTML).join(''); break;
        }
        container.innerHTML = cardHTML;
        container.querySelectorAll('.offer-card').forEach((card, index) => {
            setTimeout(() => { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, index * 50);
        });
    },

    createOfferCardHTML: (offer, index) => {
        const s = UI.getStatusClass(offer.OFFER_STATUS);
        const a = Utils.getAssetClass(offer.ASSET_CATEGORY);
        const stars = offer.GECAN_CONFIDENCE || 0;
        const v = parseFloat(String(offer.TOTAL_VOLUME_AVAILABLE || '0').replace(/,/g, '')) || 0;
        return `<div class="offer-card ${s.border} ${a}" style="animation-delay:${index*50}ms;opacity:0;transform:translateY(20px);" data-id="${offer.OFFER_ID}" data-type="offer"><div class="card-content h-full flex flex-col"><div class="flex-grow"><div class="flex justify-between items-start mb-6"><div><h2 class="asset-header text-2xl">${offer.ASSET_CATEGORY}</h2><p class="text-sm text-gray-400">${offer.ASSET_SUBTYPE}</p></div><span class="text-xs font-mono bg-black/30 px-2 py-1 rounded-lg border border-[var(--border-color)]">${offer.OFFER_ID}</span></div><h3 class="text-lg font-bold text-white mb-3 line-clamp-2">${offer.OFFER_DESCRIPTION}</h3><p class="text-sm text-gray-300 bg-black/20 p-4 rounded-xl border border-white/5 line-clamp-3 mb-4">${offer.EXECUTIVE_SUMMARY_AND_OVERVIEW}</p><div class="border-t border-[var(--border-color)] pt-4 grid grid-cols-2 gap-4 text-sm mb-4"><div><span class="text-xs text-gray-400 block">Status</span><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${s.dot}"></div><span class="font-medium text-white text-xs">${offer.OFFER_STATUS}</span></div></div><div><span class="text-xs text-gray-400 block">Venue</span><span class="font-medium text-white text-xs">${offer.TRANSACTION_VENUE}</span></div><div><span class="text-xs text-gray-400 block">Procedure</span><span class="font-semibold text-[var(--asset-color)] text-xs">${offer.CORE_PROCEDURE_TYPE}</span></div><div><span class="text-xs text-gray-400 block">Confidence</span><span class="text-yellow-400 text-sm">${'★'.repeat(stars)}<span class="text-gray-600">${'☆'.repeat(5 - stars)}</span></span></div></div><div class="bg-[var(--background-dark)] bg-opacity-50 backdrop-blur-sm rounded-xl p-4"><div class="flex justify-between items-center mb-2"><span class="text-xs font-medium text-gray-400">Volume</span><span class="text-sm font-bold text-[var(--asset-color)]">${Utils.formatNumber(v)} ${offer.UNITS_OF_MEASURE||'units'}</span></div><p class="text-xs font-mono text-gray-300 leading-relaxed line-clamp-2">${offer.DISCOUNT_COMMISSION_SUMMARY}</p></div></div><div class="mt-6 pt-4 border-t border-white/10 text-xs text-gray-400 flex justify-between items-center"><div class="flex items-center gap-2"><i class="fas fa-users text-[var(--primary-amethyst)]"></i><span>${offer.ENGAGED_BUYERS||0} Engaged</span></div><div class="flex items-center gap-2"><i class="fas fa-calendar-alt text-gray-500"></i><span>${offer.DATE_RECEIVED}</span></div></div></div></div>`;
    },

    createEnquiryCardHTML: (enquiry, index) => {
        const s = UI.getStatusClass(enquiry.ENQUIRY_STATUS);
        const a = Utils.getAssetClass(enquiry.TARGET_ASSET_CATEGORY);
        const stars = enquiry.GECAN_CONFIDENCE || 0;
        const v = parseFloat(String(enquiry.REQUIRED_TOTAL_VOLUME || '0').replace(/,/g, '')) || 0;
        return `<div class="offer-card ${s.border} ${a}" style="animation-delay:${index*50}ms;opacity:0;transform:translateY(20px);" data-id="${enquiry.ENQUIRY_ID}" data-type="enquiry"><div class="card-content h-full flex flex-col"><div class="flex-grow"><div class="flex justify-between items-start mb-6"><div><h2 class="asset-header text-2xl">${enquiry.TARGET_ASSET_CATEGORY}</h2><p class="text-sm text-gray-400">${enquiry.TARGET_ASSET_SUBTYPE}</p></div><span class="text-xs font-mono bg-black/30 px-2 py-1 rounded-lg border border-[var(--border-color)]">${enquiry.ENQUIRY_ID}</span></div><h3 class="text-lg font-bold text-white mb-3 line-clamp-2">${enquiry.ENQUIRY_DESCRIPTION}</h3><p class="text-sm text-gray-300 bg-black/20 p-4 rounded-xl border border-white/5 line-clamp-3 mb-4">${enquiry.BUYER_REQUIREMENT_SUMMARY}</p><div class="border-t border-[var(--border-color)] pt-4 grid grid-cols-2 gap-4 text-sm mb-4"><div><span class="text-xs text-gray-400 block">Status</span><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${s.dot}"></div><span class="font-medium text-white text-xs">${enquiry.ENQUIRY_STATUS}</span></div></div><div><span class="text-xs text-gray-400 block">Venue</span><span class="font-medium text-white text-xs">${enquiry.PREFERRED_TRANSACTION_VENUE}</span></div><div><span class="text-xs text-gray-400 block">Procedure</span><span class="font-semibold text-[var(--asset-color)] text-xs">${enquiry.CORE_PROCEDURE_TYPE}</span></div><div><span class="text-xs text-gray-400 block">Confidence</span><span class="text-yellow-400 text-sm">${'★'.repeat(stars)}<span class="text-gray-600">${'☆'.repeat(5 - stars)}</span></span></div></div><div class="bg-[var(--background-dark)] bg-opacity-50 backdrop-blur-sm rounded-xl p-4"><div class="flex justify-between items-center mb-2"><span class="text-xs font-medium text-gray-400">Volume</span><span class="text-sm font-bold text-[var(--asset-color)]">${Utils.formatNumber(v)} ${enquiry.UNITS_OF_MEASURE||'units'}</span></div><p class="text-xs font-mono text-gray-300 leading-relaxed line-clamp-2">Target Pricing: ${enquiry.TARGET_PRICING_STRUCTURE}</p></div></div><div class="mt-6 pt-4 border-t border-white/10 text-xs text-gray-400 flex justify-between items-center"><div class="flex items-center gap-2"><i class="fas fa-link text-[var(--primary-azure)]"></i><span>${enquiry.MATCHED_OFFERS_COUNT} Matched</span></div><div class="flex items-center gap-2"><i class="fas fa-calendar-alt text-gray-500"></i><span>${enquiry.DATE_RECEIVED}</span></div></div></div></div>`;
    },

    createProjectCardHTML: (project, index) => {
        const a = Utils.getAssetClass(project.PRIMARY_SECTOR);
        return `<div class="offer-card border-l-4 border-[var(--asset-primary)] ${a}" style="animation-delay:${index*50}ms;opacity:0;transform:translateY(20px);" data-id="${project.PROJECT_ID}" data-type="crowdfunding"><div class="card-content h-full flex flex-col"><div class="flex-grow"><div class="flex justify-between items-start mb-6"><div><p class="text-sm font-semibold text-[var(--asset-primary)]">${project.PRIMARY_SECTOR}</p><h2 class="asset-header text-2xl -ml-1">${project.PROJECT_NAME}</h2></div><span class="text-xs font-mono bg-black/30 px-2 py-1 rounded-lg border border-[var(--border-color)]">${project.PROJECT_ID}</span></div><p class="text-sm text-gray-300 bg-black/20 p-4 rounded-xl border border-white/5 line-clamp-3 mb-4">${project.EXECUTIVE_SUMMARY}</p><div class="grid grid-cols-3 gap-4 text-center mt-6"><div><p class="text-xs text-gray-400">Funding</p><p class="font-bold text-white text-lg">${Utils.formatCurrency(project.TOTAL_FUNDING_SOUGHT_USD)}</p></div><div><p class="text-xs text-gray-400">IRR</p><p class="font-bold text-green-400 text-lg">${project.PROJECTED_INTERNAL_RATE_OF_RETURN_IRR}%</p></div><div><p class="text-xs text-gray-400">Equity</p><p class="font-bold text-cyan-400 text-lg">${project.EQUITY_OFFERED}%</p></div></div></div><div class="mt-6 pt-4 border-t border-white/10 text-xs text-gray-400 flex justify-between items-center"><div class="flex items-center gap-2"><i class="fas fa-lightbulb text-yellow-400"></i><span>${project.PROJECT_STAGE}</span></div><div class="flex items-center gap-2"><i class="fas fa-calendar-alt text-gray-500"></i><span>${project.PROPOSAL_SUBMISSION_DATE}</span></div></div></div></div>`;
    },

    createServiceCardHTML: (service, index) => {
        const a = Utils.getAssetClass(service.SERVICE_CATEGORY);
        return `<div class="offer-card border-l-4 border-[var(--asset-primary)] ${a}" style="animation-delay:${index*50}ms;opacity:0;transform:translateY(20px);" data-id="${service.SERVICE_ID}" data-type="service"><div class="card-content h-full flex flex-col"><div class="flex-grow"><div class="flex justify-between items-start mb-6"><div><p class="text-sm font-semibold text-[var(--asset-primary)]">${service.SERVICE_CATEGORY}</p><h2 class="asset-header text-2xl -ml-1">${service.SERVICE_NAME}</h2></div><span class="text-xs font-mono bg-black/30 px-2 py-1 rounded-lg border border-[var(--border-color)]">${service.SERVICE_ID}</span></div><p class="text-sm text-gray-300 bg-black/20 p-4 rounded-xl border border-white/5 line-clamp-3 mb-4">${service.SERVICE_OVERVIEW_AND_VALUE_PROPOSITION}</p><div class="grid grid-cols-2 gap-4 text-sm mt-6"><div><span class="text-xs text-gray-400 block">Jurisdiction</span><span class="font-medium text-white">${service.PROVIDER_JURISDICTION}</span></div><div><span class="text-xs text-gray-400 block">Pricing</span><span class="font-medium text-white">${service.PRICING_MODEL}</span></div></div></div><div class="mt-6 pt-4 border-t border-white/10 text-xs text-gray-400 flex justify-between items-center"><div class="flex items-center gap-2"><i class="fas fa-tachometer-alt text-cyan-400"></i><span>Reliability: ${service.SERVICE_RELIABILITY_SCORE||0}/100</span></div><div class="flex items-center gap-2"><i class="fas fa-calendar-alt text-gray-500"></i><span>Onboarded: ${service.DATE_ONBOARDED}</span></div></div></div></div>`;
    },
    
    renderKanban: (offers) => {
        const container = document.getElementById('kanban-container');
        const statuses = ["ACTIVE", "ACTIVE-LIMITED BANDWIDTH", "PENDING REVIEW", "WITHDRAWN", "BLACKLISTED"];
        container.innerHTML = `<div class="kanban-board grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">${statuses.map(UI.createKanbanColumnHTML).join('')}</div>`;
        offers.forEach(offer => {
            const statusKey = offer.OFFER_STATUS.toLowerCase().replace(/[\s-]+/g, '');
            const column = document.getElementById(`col-${statusKey}`);
            if (column) column.innerHTML += UI.createKanbanCardHTML(offer);
        });
        statuses.forEach(status => {
            const statusKey = status.toLowerCase().replace(/[\s-]+/g, '');
            const column = document.getElementById(`col-${statusKey}`);
            if (column) {
                const count = column.children.length;
                const totalVolume = Array.from(column.children).reduce((acc, card) => {
                    const offer = AppState.allOffers.find(o => o.OFFER_ID === card.dataset.offerId);
                    return acc + (parseFloat(String(offer?.TOTAL_VOLUME_AVAILABLE || '0').replace(/,/g, '')) || 0);
                }, 0);
                document.getElementById(`count-${statusKey}`).innerText = count;
                document.getElementById(`volume-${statusKey}`).innerText = `${Utils.formatNumber(totalVolume)} units`;
            }
        });
    },

    createKanbanColumnHTML: (status) => {
        const statusKey = status.toLowerCase().replace(/[\s-]+/g, '');
        const s = UI.getStatusClass(status);
        return `<div class="kanban-column bg-gradient-to-b from-[var(--background-light)] to-[var(--background-accent)] p-4 rounded-2xl"><div class="mb-4"><h2 class="text-base font-bold text-white flex items-center gap-3 mb-2"><div class="w-3 h-3 rounded-full ${s.dot}"></div><span class="flex-1">${status}</span><span id="count-${statusKey}" class="text-sm font-normal bg-gray-700 text-gray-300 rounded-full px-3 py-1">0</span></h2><p class="text-xs text-gray-500 flex items-center gap-1"><i class="fas fa-cubes"></i><span id="volume-${statusKey}">0 units</span></p></div><div id="col-${statusKey}" class="kanban-cards-container space-y-3"></div></div>`;
    },

    createKanbanCardHTML: (offer) => {
        const a = Utils.getAssetClass(offer.ASSET_CATEGORY);
        const stars = offer.GECAN_CONFIDENCE || 0;
        const v = parseFloat(String(offer.TOTAL_VOLUME_AVAILABLE || '0').replace(/,/g, '')) || 0;
        return `<div class="kanban-card border-l-4 border-[var(--asset-color)] ${a}" data-id="${offer.OFFER_ID}" data-type="offer"><div class="mb-3"><h3 class="font-bold text-white text-sm line-clamp-2">${offer.OFFER_DESCRIPTION}</h3><p class="text-xs font-mono text-gray-500">${offer.OFFER_ID}</p></div><div class="flex justify-between items-center text-xs mb-3"><span class="font-semibold text-[var(--asset-color)] flex items-center gap-1"><i class="fas fa-tag"></i>${offer.ASSET_CATEGORY}</span><span class="text-gray-400 flex items-center gap-1"><i class="fas fa-map-marker-alt"></i>${offer.TRANSACTION_VENUE}</span></div><div class="flex justify-between items-center text-xs text-gray-400"><span class="text-yellow-400">${'★'.repeat(stars)}<span class="text-gray-600">${'☆'.repeat(5 - stars)}</span></span><span class="font-medium">${Utils.formatNumber(v)} units</span></div></div>`;
    },

    renderPlaceholderContent: (type) => {
        const placeholders = {
            enquiries: { icon: 'fas fa-bullseye', title: 'Buyer Mandate Nexus', text: 'This automated nexus will soon provide a live, curated feed of vetted buyer requirements and mandates...', tag: 'Coming Q4 2025' },
            crowdfunding: { icon: 'fas fa-layer-group', title: 'Syndicated Ventures Platform', text: 'A forthcoming capital gateway for sourcing and participating in GECAN-vetted syndicated ventures...', tag: 'Coming Q1 2026' },
            services: { icon: 'fas fa-cogs', title: 'Professional Services Matrix', text: 'Activate a network of elite service providers for seamless execution of complex global transactions.', tag: 'Coming Q2 2026' }
        };
        const p = placeholders[type];
        if (!p) {
            document.getElementById('placeholder-content').classList.add('hidden');
            return;
        }
        document.getElementById('placeholder-icon').className = p.icon;
        document.getElementById('placeholder-title').textContent = p.title;
        document.getElementById('placeholder-text').textContent = p.text;
        document.getElementById('placeholder-tag').textContent = p.tag;
        ['card-container', 'kanban-container', 'no-results'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('placeholder-content').classList.remove('hidden');
    },

    updateMetrics: (items) => {
        const metrics = Logic.calculateMetrics(items);
        const container = document.getElementById('metrics-bar');
        const metricsData = [
            { label: 'Total Items', value: metrics.totalItems, icon: 'fa-chart-bar', theme: '--primary-azure' },
            { label: 'Active Items', value: metrics.activeItems, icon: 'fa-check-circle', theme: '--status-active' },
            { label: 'Total Volume', value: Utils.formatNumber(metrics.totalVolume), icon: 'fa-cubes', theme: '--primary-amethyst' },
            { label: 'Avg. Confidence', value: metrics.avgConfidence.toFixed(1), icon: 'fa-star', theme: '--status-pending' }
        ];
        container.innerHTML = metricsData.map(m => `<div class="metrics-item" style="--metrics-color:var(${m.theme});--metrics-glow:var(${m.theme.replace('primary','glow').replace('status','glow')});"><div class="flex items-center justify-between w-full"><div><p class="font-orbitron font-bold text-3xl text-white">${m.value}</p><p class="text-sm text-gray-400">${m.label}</p></div><div class="metrics-icon-container"><div class="metrics-icon-3d"><div class="icon-face icon-front"><i class="fas ${m.icon}"></i></div><div class="icon-face icon-back"></div><div class="icon-glow-ring"></div></div></div></div></div>`).join('');
    },

    // --- Form & Filter UI ---
    
    populateTimezoneSelect: () => {
        const select = document.getElementById('add-clock-select');
        if (select) select.innerHTML = AppState.timezones.map(tz => `<option value="${tz.value}">${tz.name}</option>`).join('');
    },

    populateAdvancedFilterDropdowns: () => {
        const createOptions = (items) => ['All', ...new Set(items.filter(Boolean))].map(item => `<option value="${item}">${item}</option>`).join('');
        document.getElementById('asset-category-select').innerHTML = createOptions(AppState.allOffers.map(o => o.ASSET_CATEGORY));
        document.getElementById('settlement-select').innerHTML = createOptions(AppState.allOffers.map(o => o.SETTLEMENT_PROTOCOL));
        document.getElementById('procedure-select').innerHTML = createOptions(AppState.allOffers.map(o => o.CORE_PROCEDURE_TYPE));
    },

    populateStatusFilter: () => {
        const statuses = [{ name: "ACTIVE", dotClass: "status-dot-active" }, { name: "ACTIVE-LIMITED BANDWIDTH", dotClass: "status-dot-active-limited-bandwidth" }, { name: "PENDING REVIEW", dotClass: "status-dot-pending-review" }, { name: "WITHDRAWN", dotClass: "status-dot-withdrawn" }, { name: "BLACKLISTED", dotClass: "status-dot-blacklisted" }];
        const container = document.getElementById('status-filters-container');
        if(container) container.innerHTML = statuses.map(s => `<label class="status-checkbox-item"><input type="checkbox" class="status-checkbox" value="${s.name.toUpperCase()}"><span class="custom-checkbox"><i class="fas fa-check"></i></span><span class="flex items-center gap-3 text-gray-400"><span class="w-2.5 h-2.5 rounded-full ${s.dotClass}"></span><span class="text-sm">${s.name}</span></span></label>`).join('');
    },

    createSearchDropdownHTML: () => {
        const assets = ['All', ...new Set(AppState.allOffers.map(o => o.ASSET_CATEGORY))];
        let html = assets.map(asset => `<div class="suggestion-item" data-asset="${asset}"><i class="fas fa-tag text-gray-400"></i><span class="asset-label">${asset}</span><span class="asset-tag">Category</span></div>`).join('');
        html += `<div class="suggestion-item reset-search" data-action="reset"><i class="fas fa-undo text-red-400"></i><span class="asset-label text-red-400">Reset All Filters</span><span class="asset-tag">Action</span></div>`;
        return html;
    },

    // --- Modal UI ---

    renderEngagementSuiteModal: (offer, referralInfo) => {
        const title = `Intermediary Deal Submission Portal`;
        return `<div id="engagement-suite" class="rounded-3xl w-full max-w-2xl p-8 bg-[var(--background-secondary)] border-2 border-[var(--border-premium)] shadow-2xl"><div class="text-center mb-8"><h2 class="text-3xl font-bold text-white mb-2">${title}</h2><p class="text-gray-400">Enquiry Against Offer: ${offer.OFFER_ID}</p></div><div class="space-y-6"><div class="relative"><input type="text" id="referral-id-input" placeholder="e.g., GECAN-PARTNER-001" class="w-full p-4 rounded-xl text-white text-center font-mono bg-black/40 border-2 border-[var(--border-secondary)] focus:outline-none focus:border-[var(--primary-azure)]"></div><button id="validate-referral-btn" class="w-full bg-gradient-to-r from-[var(--primary-azure)] to-[var(--primary-amethyst)] text-white font-bold py-4 rounded-xl hover:scale-105 shadow-lg"><i class="fas fa-key mr-2"></i>Validate</button><div id="referral-error" class="hidden text-center p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400"></div><div class="text-center"><button onclick="Utils.closeModal('engagement-modal')" class="text-gray-400 hover:text-white"><i class="fas fa-times mr-2"></i>Cancel</button></div></div></div>`;
    },

    // --- UI State Updaters ---

    updateAllClocks: () => {
        const now = new Date();
        document.querySelectorAll('.clock').forEach(clock => {
            const timezone = clock.dataset.timezone;
            try {
                const time = new Date(now.toLocaleString("en-US", { timeZone: timezone }));
                const s = time.getSeconds(), m = time.getMinutes(), h = time.getHours();
                clock.querySelector('.second-hand').style.transform = `translateX(-50%) rotate(${(s/60)*360}deg)`;
                clock.querySelector('.minute-hand').style.transform = `translateX(-50%) rotate(${(m/60)*360+(s/60)*6}deg)`;
                clock.querySelector('.hour-hand').style.transform = `translateX(-50%) rotate(${(h/12)*360+(m/60)*30}deg)`;
                const timeDisplay = document.querySelector(`.clock-time[data-timezone="${timezone}"]`);
                if (timeDisplay) timeDisplay.textContent = time.toLocaleTimeString('en-US', { hour12: false });
            } catch (e) { console.warn('Clock update error:', e); }
        });
    },

    addClock: () => {
        const select = document.getElementById('add-clock-select');
        const timezone = select.value;
        if (!document.querySelector(`.clock[data-timezone="${timezone}"]`)) {
            UI.createClock(timezone);
            Utils.showNotification(`Added ${AppState.timezones.find(t=>t.value===timezone)?.name} clock`, 'success');
        } else {
            Utils.showNotification('Clock already exists', 'warning');
        }
    },

    removeClock: (timezone) => {
        const clockElement = document.querySelector(`.clock[data-timezone="${timezone}"]`)?.closest('.fade-in-up');
        if (clockElement) {
            clockElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            clockElement.style.opacity = '0';
            clockElement.style.transform = 'scale(0.8)';
            setTimeout(() => clockElement.remove(), 300);
        }
    },

    updateActiveFilterCount: () => {
        let count = 0;
        if (AppState.activeFilters.assetCategory !== 'All') count++;
        if (AppState.activeFilters.statuses.length > 0) count++;
        if (AppState.activeFilters.settlementProtocol !== 'All') count++;
        if (AppState.activeFilters.coreProcedure !== 'All') count++;
        const badge = document.getElementById('active-filter-count');
        if (badge) {
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }
    },

    toggleAdvancedFilters: () => {
        const container = document.getElementById('advanced-filters-container');
        const btn = document.getElementById('toggle-advanced-filters-btn');
        const content = container.querySelector('.filter-section');
        if (!container || !btn || !content) return;

        const isOpen = container.style.maxHeight && container.style.maxHeight !== '0px';
        btn.classList.toggle('active', !isOpen);

        container.style.maxHeight = isOpen ? '0px' : `${content.scrollHeight}px`;
    },

    closeAdvancedFilters: () => {
        const container = document.getElementById('advanced-filters-container');
        const btn = document.getElementById('toggle-advanced-filters-btn');
        if (container) container.style.maxHeight = '0px';
        if (btn) btn.classList.remove('active');
    },

    updateInlineResetButton: () => {
        const btn = document.getElementById('reset-filters-btn-inline');
        if (!btn) return;
        const isActive = Logic.areFiltersActive();
        btn.classList.toggle('hidden', !isActive);
        btn.classList.toggle('glow-active', isActive);
    },

    updateMainResetButtonVisibility: () => {
        const btn = document.getElementById('reset-filters');
        if (!btn) return;
        btn.classList.toggle('hidden', !Logic.areFiltersActive());
    },
    
    getStatusClass: (status) => {
        const s = String(status).toLowerCase().replace(/[\s-]+/g, '');
        if (s.includes('activelimited')) return { border: 'status-active-limited-bandwidth', dot: 'status-dot-active-limited-bandwidth' };
        if (s.includes('active')) return { border: 'status-active', dot: 'status-dot-active' };
        if (s.includes('pending')) return { border: 'status-pending-review', dot: 'status-dot-pending-review' };
        if (s.includes('withdrawn')) return { border: 'status-withdrawn', dot: 'status-dot-withdrawn' };
        if (s.includes('blacklisted')) return { border: 'status-blacklisted', dot: 'status-dot-blacklisted' };
        return { border: 'status-withdrawn', dot: 'status-dot-withdrawn' };
    }
};

        // --- E. CORE APPLICATION LOGIC & CONTROLLERS ---
const Logic = {
    /**
     * Initializes the entire application by orchestrating parallel data fetching
     * and sequential UI setup for a fast, robust user experience.
     */
    init: () => {
        UI.init(); // Initialize static UI first
        Promise.all([
            Logic.createApiRequest('getOfferData').then(d => { AppState.allOffers = d || []; AppState.isDataLoading.offers = false; }),
            Logic.createApiRequest('getEnquiryData').then(d => { AppState.allEnquiries = d || []; AppState.isDataLoading.enquiries = false; }),
            Logic.createApiRequest('getProjectProposalsData').then(d => { AppState.allCrowdfunding = d || []; AppState.isDataLoading.crowdfunding = false; }),
            Logic.createApiRequest('getServicesData').then(d => { AppState.allServices = d || []; AppState.isDataLoading.services = false; }),
            Logic.createApiRequest('getFeaturedData').then(d => { AppState.allFeatured = d || []; AppState.isDataLoading.featured = false; }),
            Logic.createApiRequest('getBulletinData').then(d => { AppState.allBulletins = d || []; AppState.isDataLoading.bulletins = false; }),
            Logic.createApiRequest('getMarketMatrixData').then(Logic.onMarketDataLoaded),
            Logic.createApiRequest('getActiveThemeConfig').then(json => { try { if (json) UI.initParticles(JSON.parse(json)); } catch (e) { console.error("Theme Error", e); } })
        ]).then(() => {
            document.getElementById('loading-spinner').classList.add('hidden');
            UI.populateAdvancedFilterDropdowns();
            UI.populateStatusFilter();
            UI.renderHoloStream();
            Logic.applyFiltersAndRender();
            Logic.setupEventListeners();
            Logic.initStickyFilters();
            Logic.initFixedBottomUI();
            Logic.initMobileUI();
            Logic.startLiveUpdates();
        }).catch(Logic.onDataError);
    },

    // --- API & Data Handling ---

    createApiRequest: async (action, method = 'GET', params = {}) => {
        method = method.toUpperCase();
        let url = `${API_URL}?action=${action}`;
        const options = { method: method, redirect: 'follow', muteHttpExceptions: true };

        if (method === 'GET') {
            Object.keys(params).forEach(key => url += `&${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
        } else if (method === 'POST') {
            options.body = JSON.stringify({ action: action, data: params });
            options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
            const result = await response.json();
            if (result.success === false) throw new Error(result.error || 'Server reported an unspecified error.');
            return result.data || result.message || result;
        } catch (error) {
            console.error(`API request failed for action '${action}':`, error);
            throw error;
        }
    },

    onDataError: (error) => {
        document.getElementById('loading-spinner').innerHTML = `<div class="text-center py-20"><i class="fas fa-exclamation-triangle fa-4x text-red-500 mb-4"></i><p class="text-xl font-medium text-red-400 mb-2">Error Loading Platform Data</p><p class="text-sm text-gray-500 mb-4">${error.message || 'Unknown error'}</p><button onclick="location.reload()" class="btn-primary">Retry</button></div>`;
        Utils.showNotification('Failed to load platform data', 'error');
    },

    onMarketDataLoaded: (data) => {
        AppState.isDataLoading.marketMatrix = false;
        if (!data) return;
        AppState.marketMatrix = data;
        UI.renderMarketTickers();
    },

    onOfferDataLoaded: (data) => {
        if (!data) return;
        const isFirstLoad = AppState.isDataLoading.offers;
        AppState.isDataLoading.offers = false;
        if (!isFirstLoad && JSON.stringify(AppState.allOffers) !== JSON.stringify(data)) {
            Utils.showNotification('Live offers have been updated!', 'info');
            AppState.allOffers = data;
            Logic.applyFiltersAndRender();
        }
        AppState.lastUpdateTimes.offers = new Date();
    },

    onFeaturedDataLoaded: (data) => {
        if (!data) return;
        const isFirstLoad = AppState.isDataLoading.featured;
        AppState.isDataLoading.featured = false;
        if (!isFirstLoad && JSON.stringify(AppState.allFeatured) !== JSON.stringify(data)) {
            Utils.showNotification('Featured opportunities updated.', 'success');
            AppState.allFeatured = data;
            UI.renderHoloStream();
        }
        AppState.lastUpdateTimes.featured = new Date();
    },

    onBulletinDataLoaded: (data) => {
        if (!data) return;
        const isFirstLoad = AppState.isDataLoading.bulletins;
        AppState.isDataLoading.bulletins = false;
        if (!isFirstLoad && JSON.stringify(AppState.allBulletins) !== JSON.stringify(data)) {
            Utils.showNotification('Network bulletins updated.', 'info');
            AppState.allBulletins = data;
            UI.renderHoloStream();
        }
        AppState.lastUpdateTimes.bulletins = new Date();
    },

    startLiveUpdates: () => {
        if (AppState.liveUpdateInterval) clearInterval(AppState.liveUpdateInterval);
        const updateAll = () => {
            Logic.createApiRequest('getOfferData').then(Logic.onOfferDataLoaded).catch(console.error);
            Logic.createApiRequest('getFeaturedData').then(Logic.onFeaturedDataLoaded).catch(console.error);
            Logic.createApiRequest('getBulletinData').then(Logic.onBulletinDataLoaded).catch(console.error);
            Logic.createApiRequest('getMarketMatrixData').then(Logic.onMarketDataLoaded).catch(console.error);
        };
        AppState.liveUpdateInterval = setInterval(updateAll, 30000);
    },

    // --- Filtering, Sorting, and Rendering Control ---

    applyFiltersAndRender: () => {
        AppState.activeFilters.query = document.getElementById('search-input').value.toLowerCase();
        const currentData = Logic.getCurrentData();
        const activeTab = AppState.activeFilters.type;
        const isLoading = AppState.isDataLoading[activeTab];

        if (isLoading) {
            document.getElementById('loading-spinner').classList.remove('hidden');
            ['card-container', 'kanban-container', 'no-results', 'placeholder-content'].forEach(id => document.getElementById(id).classList.add('hidden'));
            return;
        }
        document.getElementById('loading-spinner').classList.add('hidden');

        if (Logic.isPlaceholderView()) {
            UI.renderPlaceholderContent(activeTab);
            UI.updateMetrics([]);
            UI.updateActiveFilterCount();
            return;
        }

        let filteredItems = currentData.filter(item => {
            const f = AppState.activeFilters;
            const assetMatch = f.assetCategory === 'All' || item.ASSET_CATEGORY === f.assetCategory;
            const settlementMatch = f.settlementProtocol === 'All' || item.SETTLEMENT_PROTOCOL === f.settlementProtocol;
            const procedureMatch = f.coreProcedure === 'All' || item.CORE_PROCEDURE_TYPE === f.coreProcedure;
            const statusMatch = f.statuses.length === 0 || f.statuses.includes(String(item.OFFER_STATUS).toUpperCase());
            const searchMatch = Logic.searchMatch(item, f.query);
            return assetMatch && searchMatch && statusMatch && settlementMatch && procedureMatch;
        });
        
        filteredItems.sort((a, b) => Logic.sortItems(a, b, AppState.activeSort));
        
        const hasResults = filteredItems.length > 0;
        document.getElementById('placeholder-content').classList.add('hidden');
        document.getElementById('no-results').classList.toggle('hidden', hasResults);
        
        const isCardView = AppState.currentView === 'card';
        document.getElementById('card-container').classList.toggle('hidden', !isCardView || !hasResults);
        document.getElementById('kanban-container').classList.toggle('hidden', isCardView || !hasResults);
        
        if (hasResults) {
            isCardView ? UI.renderCards(filteredItems, activeTab) : UI.renderKanban(filteredItems);
        }

        UI.updateMetrics(filteredItems);
        UI.updateActiveFilterCount();
        UI.updateInlineResetButton();
        UI.updateMainResetButtonVisibility();
    },

    searchMatch: (item, query) => {
        if (!query) return true;
        return Object.values(item).some(value => String(value).toLowerCase().includes(query));
    },

    sortItems: (a, b, sortType) => {
        const parseNum = (item, key) => parseFloat(String(item[key] || '0').replace(/,/g, '')) || 0;
        const dateKeyA = a.DATE_RECEIVED || a.PROPOSAL_SUBMISSION_DATE || a.DATE_ONBOARDED;
        const dateKeyB = b.DATE_RECEIVED || b.PROPOSAL_SUBMISSION_DATE || b.DATE_ONBOARDED;

        switch (sortType) {
            case 'date_asc': return Utils.parseDate(dateKeyA) - Utils.parseDate(dateKeyB);
            case 'confidence_desc': return (b.GECAN_CONFIDENCE || 0) - (a.GECAN_CONFIDENCE || 0);
            case 'volume_desc': return parseNum(b, 'TOTAL_VOLUME_AVAILABLE') - parseNum(a, 'TOTAL_VOLUME_AVAILABLE');
            case 'funding_desc': return parseNum(b, 'TOTAL_FUNDING_SOUGHT_USD') - parseNum(a, 'TOTAL_FUNDING_SOUGHT_USD');
            case 'irr_desc': return parseNum(b, 'PROJECTED_INTERNAL_RATE_OF_RETURN_IRR') - parseNum(a, 'PROJECTED_INTERNAL_RATE_OF_RETURN_IRR');
            case 'reliability_desc': return parseNum(b, 'SERVICE_RELIABILITY_SCORE') - parseNum(a, 'SERVICE_RELIABILITY_SCORE');
            default: return Utils.parseDate(dateKeyB) - Utils.parseDate(dateKeyA);
        }
    },

    switchFilterType: (type) => {
        if (AppState.activeFilters.type === type) return;
        AppState.activeFilters.type = type;
        document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.type === type));
        
        const isOffersTab = type === 'offers';
        document.getElementById('sticky-filter-header').style.display = isOffersTab ? '' : 'none';
        document.getElementById('kanban-view-btn').style.display = isOffersTab ? '' : 'none';

        if (!isOffersTab && AppState.currentView === 'kanban') {
            Logic.switchView('card');
        }

        Logic.updateSortOptions(type);
        Logic.resetFilters(false);
        Logic.applyFiltersAndRender();
        Utils.showNotification(`Viewing ${type.charAt(0).toUpperCase() + type.slice(1)}`, 'info');
    },

    switchView: (view) => {
        if (AppState.currentView === view) return;
        AppState.currentView = view;
        const isCardActive = view === 'card';
        document.getElementById('card-view-btn').classList.toggle('active', isCardActive);
        document.getElementById('kanban-view-btn').classList.toggle('active', !isCardActive);
        Logic.applyFiltersAndRender();
        Utils.showNotification(`Switched to ${view.charAt(0).toUpperCase() + view.slice(1)} View`, 'success');
    },

    resetFilters: (showNotif = true) => {
        AppState.activeFilters = { type: AppState.activeFilters.type, query: '', assetCategory: 'All', statuses: [], settlementProtocol: 'All', coreProcedure: 'All' };
        AppState.activeSort = 'date_desc';
        document.getElementById('search-input').value = '';
        Logic.updateSortOptions(AppState.activeFilters.type);
        document.getElementById('sort-select').value = 'date_desc';
        if (AppState.activeFilters.type === 'offers') {
            UI.populateAdvancedFilterDropdowns(); // This resets selects to 'All'
            document.querySelectorAll('#status-filters-container .status-checkbox').forEach(cb => { cb.checked = false; });
        }
        Logic.applyFiltersAndRender();
        if (showNotif) Utils.showNotification('All Filters Reset', 'success');
    },

    // --- UI State & Event Logic ---

    initStickyFilters: () => {
        const sentinel = document.getElementById('sticky-sentinel');
        const filterElement = document.getElementById('sticky-filter-header');
        const mainPlaceholder = document.getElementById('desktop-filter-placeholder');
        const sidebarContainer = document.getElementById('sticky-filter-sidebar');
        if (!sentinel || !filterElement || !mainPlaceholder || !sidebarContainer) return;
        const observer = new IntersectionObserver( ([entry]) => {
            const isStuck = !entry.isIntersecting;
            sidebarContainer.classList.toggle('is-stuck', isStuck);
            if (isStuck && sidebarContainer.firstElementChild !== filterElement) {
                sidebarContainer.appendChild(filterElement);
            } else if (!isStuck && mainPlaceholder.firstElementChild !== filterElement) {
                mainPlaceholder.appendChild(filterElement);
            }
        }, { rootMargin: `-96px 0px 0px 0px`, threshold: [0] });
        observer.observe(sentinel);
    },

    initFixedBottomUI: () => {
        const holoStream = document.getElementById('holo-stream-container');
        const mainLayout = document.querySelector('.main-layout');
        if (!holoStream || !mainLayout) return;
        const observer = new ResizeObserver(entries => {
            mainLayout.style.paddingBottom = `${entries[0].contentRect.height + 40}px`;
        });
        observer.observe(holoStream);
    },

    initMobileUI: () => {
        const fab = document.getElementById('mobile-fab'), sidebar = document.getElementById('mobile-sidebar'), overlay = document.getElementById('mobile-sidebar-overlay'), closeBtn = document.getElementById('mobile-sidebar-close-btn');
        const openSidebar = () => { sidebar.classList.add('open'); overlay.classList.remove('hidden'); document.body.classList.add('mobile-sidebar-open'); };
        const closeSidebar = () => { sidebar.classList.remove('open'); overlay.classList.add('hidden'); document.body.classList.remove('mobile-sidebar-open'); };
        fab.addEventListener('click', openSidebar);
        overlay.addEventListener('click', closeSidebar);
        closeBtn.addEventListener('click', closeSidebar);
        fab.addEventListener('click', () => {
            const content = document.getElementById('mobile-sidebar-content');
            if (content.hasChildNodes()) return;
            const nav = document.getElementById('nav-container')?.cloneNode(true);
            const filters = document.querySelector('#sticky-sentinel')?.parentElement.cloneNode(true);
            if (nav) { nav.id='m-nav'; nav.classList.add('mobile-nav-clone'); nav.classList.remove('hidden'); content.appendChild(nav); }
            if (filters) { filters.id='m-filters'; filters.classList.add('mobile-filter-clone'); content.appendChild(filters); }
        }, { once: true });
    },

    initHoloStreamListeners: () => {
        const track = document.querySelector('.holo-stream-track');
        if (!track) return;
        track.addEventListener('mousemove', e => { const t = e.target.closest('.holo-item'); track.querySelectorAll('.holo-item').forEach(i => i.classList.toggle('focused', i === t)); });
        track.addEventListener('mouseleave', () => track.querySelectorAll('.holo-item').forEach(i => i.classList.remove('focused')));
        track.addEventListener('click', e => { const t = e.target.closest('.holo-item'); if (t && t.dataset.type === 'opportunity') Logic.openModal(t.dataset.id, 'offer'); });
    },

    setupEventListeners: () => {
        document.getElementById('search-input').addEventListener('keyup', Utils.debounce(() => Logic.applyFiltersAndRender(), 300));
        document.querySelectorAll('.filter-tab').forEach(tab => tab.addEventListener('click', () => Logic.switchFilterType(tab.dataset.type)));
        document.getElementById('card-view-btn').addEventListener('click', () => Logic.switchView('card'));
        document.getElementById('kanban-view-btn').addEventListener('click', () => Logic.switchView('kanban'));
        document.getElementById('toggle-advanced-filters-btn').addEventListener('click', UI.toggleAdvancedFilters);
        const cardClickHandler = e => { const c = e.target.closest('.offer-card, .kanban-card'); if (c) Logic.openModal(c.dataset.id, c.dataset.type); };
        document.getElementById('card-container').addEventListener('click', cardClickHandler);
        document.getElementById('kanban-container').addEventListener('click', cardClickHandler);
        document.getElementById('add-clock-btn').addEventListener('click', UI.addClock);
        document.getElementById('reset-filters-btn-inline').addEventListener('click', () => Logic.resetFilters(true));
        // Dynamic listeners are set up in `setupAdvancedFilterListeners`
    },

    setupAdvancedFilterListeners: () => {
        const addListener = (id, key) => { const el = document.getElementById(id); if (el) el.addEventListener('change', e => { AppState.activeFilters[key] = e.target.value; Logic.applyFiltersAndRender(); }); };
        addListener('asset-category-select', 'assetCategory');
        addListener('settlement-select', 'settlementProtocol');
        addListener('procedure-select', 'coreProcedure');
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) sortSelect.addEventListener('change', e => { AppState.activeSort = e.target.value; Logic.applyFiltersAndRender(); });
        const resetBtn = document.getElementById('reset-filters');
        if (resetBtn) resetBtn.addEventListener('click', () => Logic.resetFilters(true));
        const statusContainer = document.getElementById('status-filters-container');
        if (statusContainer) statusContainer.addEventListener('change', Logic.handleStatusFilterChange);
    },

    // --- Business Logic & User Flows ---

    getCurrentData: () => {
        const map = { offers: AppState.allOffers, enquiries: AppState.allEnquiries, crowdfunding: AppState.allCrowdfunding, services: AppState.allServices };
        return map[AppState.activeFilters.type] || [];
    },

    isPlaceholderView: () => ['enquiries', 'crowdfunding', 'services'].includes(AppState.activeFilters.type),

    areFiltersActive: () => {
        const f = AppState.activeFilters;
        return f.query !== '' || f.assetCategory !== 'All' || f.statuses.length > 0 || f.settlementProtocol !== 'All' || f.coreProcedure !== 'All';
    },

    handleStatusFilterChange: () => {
        AppState.activeFilters.statuses = Array.from(document.querySelectorAll('#status-filters-container .status-checkbox:checked')).map(cb => cb.value);
        Logic.applyFiltersAndRender();
    },

    updateSortOptions: (type) => {
        const select = document.getElementById('sort-select');
        let options = `<option value="date_desc">Date (Newest)</option><option value="date_asc">Date (Oldest)</option>`;
        if (type === 'offers') options += `<option value="confidence_desc">Confidence</option><option value="volume_desc">Volume</option>`;
        if (type === 'crowdfunding') options += `<option value="funding_desc">Funding</option><option value="irr_desc">IRR</option>`;
        if (type === 'services') options += `<option value="reliability_desc">Reliability</option>`;
        select.innerHTML = options;
        AppState.activeSort = 'date_desc';
    },

    /**
 * Opens the detailed modal view for a selected item. This function is a master router,
 * dynamically generating a rich, interactive modal based on the item's data type.
 * It is the definitive, unabridged implementation for all supported data types.
 * @param {string} id - The unique ID of the item (e.g., offerId, enquiryId).
 * @param {string} type - The data type of the item ('offer', 'enquiry', etc.).
 */
openModal: (id, type) => {
    const item = Logic.getCurrentData().find(d => (d.OFFER_ID || d.ENQUIRY_ID || d.PROJECT_ID || d.SERVICE_ID) === id);
    if (!item) {
        Utils.showNotification('Item details could not be found.', 'error');
        return;
    }

    const modalWrapper = document.getElementById('modal-content-wrapper');
    const modalOverlay = document.getElementById('modal-overlay');

    // --- Universal Helper for creating detailed grid items ---
    const createDetailItem = (label, value, icon) => {
        let valueHtml = String(value || 'N/A');
        const valueClass = 'font-semibold text-sm text-white print-text-black';

        if (label.includes('LINK') && value && value !== 'N/A') {
            valueHtml = `<a href="${value}" target="_blank" class="text-[var(--primary-azure)] hover:underline break-all">${value} <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>`;
        }
        
        if (label.includes('CONFIDENCE') || label.includes('SCORE')) {
            const stars = parseInt(value, 10) || 0;
            const scoreOutOf = label.includes('SCORE') ? 100 : 10;
            if (label.includes('CONFIDENCE')) {
                valueHtml = `<span class="text-yellow-400 text-lg">${'★'.repeat(stars)}<span class="text-gray-600">${'☆'.repeat(5-stars)}</span></span>`;
            } else {
                 valueHtml = `<span class="font-bold text-white">${stars} / ${scoreOutOf}</span>`;
            }
        }
        
        return `
            <div class="modal-grid-item">
                <p class="text-xs text-[var(--text-silver)] flex items-center mb-2">
                    <i class="fas ${icon} fa-fw mr-2 text-[var(--primary-azure)]"></i>${label}
                </p>
                <p class="${valueClass}">${valueHtml}</p>
            </div>
        `;
    };

    let headerContent, bodyContent, footerContent, pdfFooter;

    // --- Master Router for Different Modal Types ---
    switch (type) {
        case 'enquiry': {
            const enquiry = item;
            const assetClass = Utils.getAssetClass(enquiry.TARGET_ASSET_CATEGORY);
            
            headerContent = `
                <div class="py-6 px-8 flex justify-between items-center print-bg-white border-b border-[var(--border-color)]">
                    <div class="flex items-center gap-4"><span class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-indigo-600">GECAN™</span><div class="w-1 h-8 bg-gradient-to-b from-sky-400 to-indigo-600 rounded-full"></div><div><p class="font-bold text-xl text-white">Buyer Enquiry Dossier</p><p class="text-sm font-mono text-[var(--text-secondary)]">${enquiry.ENQUIRY_ID}</p></div></div>
                    <button onclick="Utils.closeModal('modal-overlay')" class="print-hide text-3xl text-gray-400 hover:text-white transition-colors duration-300 hover:rotate-90 transform"><i class="fas fa-times"></i></button>
                </div>`;
            
            bodyContent = `
                <div class="p-8 ${assetClass} print-bg-white">
                    <main id="printable-area">
                        <div class="mb-8 text-center"><div class="inline-flex items-center gap-3 bg-black/50 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/10"><span class="text-lg font-bold text-[var(--asset-primary)]">${enquiry.TARGET_ASSET_CATEGORY}</span><div class="w-1 h-6 bg-[var(--asset-primary)] rounded-full"></div><span class="text-sm text-gray-400">${enquiry.TARGET_ASSET_SUBTYPE}</span></div></div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 modal-section">
                            ${createDetailItem('ENQUIRY STATUS', enquiry.ENQUIRY_STATUS, 'fa-check-circle')}
                            ${createDetailItem('GECAN CONFIDENCE', enquiry.GECAN_CONFIDENCE, 'fa-star')}
                            ${createDetailItem('VETTING STAGE', enquiry.VETTING_STAGE_STATUS, 'fa-cogs')}
                            ${createDetailItem('BUYER JURISDICTION', enquiry.BUYER_JURISDICTION, 'fa-globe')}
                            ${createDetailItem('PREFERRED VENUE', enquiry.PREFERRED_TRANSACTION_VENUE, 'fa-map-marker-alt')}
                            ${createDetailItem('MATCHED OFFERS', enquiry.MATCHED_OFFERS_COUNT, 'fa-link')}
                            ${createDetailItem('DATE RECEIVED', enquiry.DATE_RECEIVED, 'fa-calendar-alt')}
                        </div>
                        <div class="mb-8 modal-section"><div class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 border border-white/10"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-file-alt text-[var(--primary-azure)] mr-3"></i>Buyer Requirement Summary</h3><p class="text-sm text-gray-300 leading-relaxed">${enquiry.BUYER_REQUIREMENT_SUMMARY}</p></div></div>
                        <div class="mb-8 modal-section"><div class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 border border-white/10"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-list-ol text-[var(--primary-azure)] mr-3"></i>Buyer SOP Outline</h3><div class="prose prose-invert max-w-none">${enquiry.FORMATTED_SOP_OUTLINE || 'Not specified.'}</div></div></div>
                        <div class="border-t border-white/10 pt-8 modal-section"><h3 class="text-xl font-bold mb-6 text-white"><i class="fas fa-shield-alt text-[var(--primary-azure)] mr-3"></i>GECAN Vetting Scorecard</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${createDetailItem('SOURCE CREDIBILITY SCORE', enquiry.BUYER_SOURCE_CREDIBILITY, 'fa-user-shield')}${createDetailItem('FINANCIAL CREDIBILITY SCORE', enquiry.BUYER_FINANCIAL_CREDIBILITY, 'fa-university')}${createDetailItem('ENQUIRY RELIABILITY SCORE', enquiry.ENQUIRY_RELIABILITY_SCORE, 'fa-tachometer-alt')}</div></div>
                    </main>
                </div>`;

            footerContent = `
                <div class="bg-gradient-to-r from-[var(--background-dark)] to-[var(--background-accent)] p-6 flex justify-between items-center rounded-b-2xl border-t border-[var(--border-color)] print-hide">
                    <a href="${enquiry.SUPPORTING_DOCS_LINK}" target="_blank" class="flex items-center gap-2 text-[var(--primary-azure)] hover:text-white font-medium"><i class="fas fa-folder-open text-lg"></i><span>Supporting Documents</span></a>
                    <div class="flex items-center gap-3">
                        <button onclick="window.print()" class="btn-primary px-4 py-2 rounded-lg"><i class="fas fa-print mr-2"></i>Print Summary</button>
                        <button onclick="Logic.findMatchingOffers('${enquiry.TARGET_ASSET_CATEGORY}')" class="btn-engagement bg-gradient-to-r from-green-500 to-emerald-500"><i class="fas fa-search-dollar mr-2"></i>Find Matching Offers</button>
                    </div>
                </div>`;
            pdfFooter = enquiry.PDF_FOOTER_HTML;
            break;
        }
        
        case 'project':
        case 'service':
            Utils.showNotification(`Detailed view for ${type} is in development.`, 'info');
            return;

        case 'offer':
        default: {
            const offer = item;
            const assetClass = Utils.getAssetClass(offer.ASSET_CATEGORY);

            headerContent = `
                <div class="py-6 px-8 flex justify-between items-center print-bg-white border-b border-[var(--border-color)]">
                    <div class="flex items-center gap-4"><span class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-indigo-600">GECAN™</span><div class="w-1 h-8 bg-gradient-to-b from-sky-400 to-indigo-600 rounded-full"></div><div><p class="font-bold text-xl text-white">${offer.OFFER_DESCRIPTION}</p><p class="text-sm font-mono text-[var(--text-secondary)]">${offer.OFFER_ID}</p></div></div>
                    <button onclick="Utils.closeModal('modal-overlay')" class="print-hide text-3xl text-gray-400 hover:text-white transition-colors duration-300 hover:rotate-90 transform"><i class="fas fa-times"></i></button>
                </div>`;

            bodyContent = `
                <div class="p-8 ${assetClass} print-bg-white">
                    <main id="printable-area">
                        <div class="mb-8 text-center"><div class="inline-flex items-center gap-3 bg-black/50 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/10"><span class="text-lg font-bold text-[var(--asset-primary)]">${offer.ASSET_CATEGORY}</span><div class="w-1 h-6 bg-[var(--asset-primary)] rounded-full"></div><span class="text-sm text-gray-400">${offer.ASSET_SUBTYPE}</span></div></div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 modal-section">${createDetailItem('OFFER STATUS', offer.OFFER_STATUS, 'fa-check-circle')}${createDetailItem('GECAN CONFIDENCE', offer.GECAN_CONFIDENCE, 'fa-star')}${createDetailItem('VETTING STAGE', offer.VETTING_STAGE_STATUS, 'fa-cogs')}${createDetailItem('ENGAGED BUYERS', offer.ENGAGED_BUYERS, 'fa-users')}${createDetailItem('SELLER JURISDICTION', offer.SELLER_JURISDICTION, 'fa-globe')}${createDetailItem('TRANSACTION VENUE', offer.TRANSACTION_VENUE, 'fa-map-marker-alt')}${createDetailItem('SELLER TIMEZONE', offer.SELLER_TIMEZONE, 'fa-clock')}${createDetailItem('DATE RECEIVED', offer.DATE_RECEIVED, 'fa-calendar-alt')}</div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 modal-section"><div class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 border border-white/10"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-file-alt text-[var(--primary-azure)] mr-3"></i>Executive Summary</h3><p class="text-sm text-gray-300 leading-relaxed">${offer.EXECUTIVE_SUMMARY_AND_OVERVIEW}</p></div><div class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 border border-white/10"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-handshake text-[var(--primary-azure)] mr-3"></i>Commercial Terms</h3><div class="space-y-4">${createDetailItem('TOTAL VOLUME', `${offer.TOTAL_VOLUME_AVAILABLE} ${offer.UNITS_OF_MEASURE}`, 'fa-coins')}${createDetailItem('SETTLEMENT PROTOCOL', offer.SETTLEMENT_PROTOCOL, 'fa-exchange-alt')}${createDetailItem('PRICE REFERENCE', offer.PRICE_REFERENCE_BASIS, 'fa-chart-line')}</div></div></div>
                        <div class="mb-8 modal-section"><div class="bg-gradient-to-r from-[var(--background-dark)] to-[var(--background-accent)] rounded-2xl p-6 border border-[var(--border-color)]"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-tags text-[var(--primary-azure)] mr-3"></i>Pricing & Commission</h3><div class="bg-black/50 rounded-xl p-4 font-mono text-sm"><pre class="text-gray-300 whitespace-pre-wrap">${offer.DISCOUNT_COMMISSION_SUMMARY}</pre></div></div></div>
                        <div class="mb-8 modal-section"><div class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 border border-white/10"><h3 class="text-xl font-bold mb-4 text-white"><i class="fas fa-list-ol text-[var(--primary-azure)] mr-3"></i>Core Procedure Summary</h3><div class="prose prose-invert max-w-none">${offer.FORMATTED_PROCEDURE_SUMMARY || 'Not provided.'}</div></div></div>
                        <div class="border-t border-white/10 pt-8 modal-section"><h3 class="text-xl font-bold mb-6 text-white"><i class="fas fa-shield-alt text-[var(--primary-azure)] mr-3"></i>Vetting & Source Details</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${createDetailItem('SOURCE CREDIBILITY SCORE', offer.SOURCE_CREDIBILITY, 'fa-user-shield')}${createDetailItem('ASSET CREDIBILITY SCORE', offer.ASSET_CREDIBILITY, 'fa-cube')}${createDetailItem('RELIABILITY SCORE', offer.OFFER_RELIABILITY_SCORE, 'fa-tachometer-alt')}${createDetailItem('ASSET LINK', offer.ASSET_LINK, 'fa-link')}${createDetailItem('GECAN INTRODUCER', offer.GECAN_INTRODUCER, 'fa-user-friends')}${createDetailItem('COMMUNICATION CHAIN', offer.COMMUNICATION_CHAIN_MAP, 'fa-sitemap')}</div></div>
                    </main>
                </div>`;
            
            footerContent = `
                <div class="bg-gradient-to-r from-[var(--background-dark)] to-[var(--background-accent)] p-6 flex justify-between items-center rounded-b-2xl border-t border-[var(--border-color)] print-hide">
                    <a href="${offer.SUPPORTING_DOCS_LINK}" target="_blank" class="flex items-center gap-2 text-[var(--primary-azure)] hover:text-white font-medium"><i class="fas fa-file-pdf text-lg"></i><span>Full Procedure Document</span></a>
                    <div class="flex items-center gap-3">
                        <button onclick="window.print()" class="btn-primary px-4 py-2 rounded-lg font-medium"><i class="fas fa-print mr-2"></i>Print Summary</button>
                        <button onclick="Logic.initiateEngagement('${offer.OFFER_ID}')" class="btn-engagement"><i class="fas fa-rocket mr-2"></i>Initiate Engagement</button>
                    </div>
                </div>`;
            pdfFooter = offer.PDF_FOOTER_HTML;
            break;
        }
    }

    // --- Universal Modal Assembly & Activation ---
    if (headerContent && bodyContent && footerContent) {
        modalWrapper.innerHTML = `<div class="flex-shrink-0">${headerContent}</div><div class="flex-grow overflow-y-auto">${bodyContent}</div><div class="flex-shrink-0">${footerContent}</div>`;
        document.getElementById('modal-pdf-header-content').innerHTML = headerContent;
        document.getElementById('modal-pdf-body-content').innerHTML = bodyContent;
        document.getElementById('modal-pdf-footer-content').innerHTML = pdfFooter || '';
        
        document.body.classList.add('modal-open');
        modalOverlay.classList.remove('hidden');
        modalWrapper.style.transform = 'scale(0.9)';
        modalWrapper.style.opacity = '0';
        setTimeout(() => {
            modalWrapper.style.transform = 'scale(1)';
            modalWrapper.style.opacity = '1';
        }, 50);
    }
},

    /**
 * Initiates the first step of the secure engagement process: the referral ID modal.
 * This function is the gateway to submitting a formal enquiry against a specific offer.
 * @param {string} offerId - The ID of the offer being engaged with.
 */
initiateEngagement: (offerId) => {
    AppState.engagementTargetOfferId = offerId;
    const modal = document.getElementById('engagement-modal');
    if (!modal) return;

    // Render the initial referral ID validation modal
    modal.innerHTML = `
        <div id="engagement-suite-referral" class="rounded-3xl w-full max-w-2xl p-8 bg-[var(--background-secondary)] border-2 border-[var(--border-premium)] shadow-2xl transform scale-95 opacity-0 transition-all duration-300">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">Secure Engagement Protocol</h2>
                <p class="text-gray-400">A valid Partner Referral ID is required to proceed.</p>
            </div>
            <div class="space-y-6">
                <div class="relative">
                    <input type="text" id="referral-id-input" placeholder="e.g., GECAN-PARTNER-001" class="w-full p-4 rounded-xl text-white text-center font-mono bg-black/40 border-2 border-[var(--border-secondary)] focus:outline-none focus:border-[var(--primary-azure)] transition-all">
                </div>
                <button id="validate-referral-btn" class="w-full bg-gradient-to-r from-[var(--primary-azure)] to-[var(--primary-amethyst)] text-white font-bold py-4 rounded-xl transition-all hover:scale-105 shadow-lg active:scale-100">
                    <i class="fas fa-key mr-2"></i>Validate & Proceed
                </button>
                <div id="referral-error" class="hidden text-center p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400"></div>
                <div class="text-center">
                    <button onclick="Utils.closeModal('engagement-modal')" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>`;
    
    modal.classList.remove('hidden');
    // Animate the modal into view
    setTimeout(() => {
        const suite = document.getElementById('engagement-suite-referral');
        if (suite) {
            suite.style.transform = 'scale(1)';
            suite.style.opacity = '1';
        }
    }, 50);

    document.getElementById('validate-referral-btn').addEventListener('click', Logic.validateReferralId);
    document.getElementById('referral-id-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') Logic.validateReferralId();
    });
},

/**
 * Validates the entered referral ID against the backend. On success, transitions
 * to the full engagement suite form. Handles UI feedback for loading and error states.
 */
validateReferralId: () => {
    const btn = document.getElementById('validate-referral-btn');
    const input = document.getElementById('referral-id-input');
    const errorDiv = document.getElementById('referral-error');
    const referralId = input.value.trim();

    if (!referralId) {
        errorDiv.textContent = 'Referral ID is required.';
        errorDiv.classList.remove('hidden');
        return;
    }
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';
    errorDiv.classList.add('hidden');

    Logic.createApiRequest('validateReferralId', 'POST', { referralId })
        .then(validationResult => {
            if (validationResult && validationResult.isValid) {
                AppState.referralInfo = { id: validationResult.referralId, partnerName: validationResult.partnerName };
                // Close the current modal before opening the next one for a smooth transition
                Utils.closeModal('engagement-modal');
                setTimeout(() => Logic.openEngagementSuite(AppState.engagementTargetOfferId, AppState.referralInfo), 350);
            } else {
                throw new Error('Invalid or inactive Referral ID. Please check the ID and try again.');
            }
        })
        .catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key mr-2"></i>Validate & Proceed';
        });
},

/**
 * Opens the main engagement suite modal after successful referral validation.
 * This renders the full submission form inside the primary modal overlay.
 * @param {string} offerId - The ID of the target offer.
 * @param {object} referralInfo - The validated referral information.
 */
openEngagementSuite: (offerId, referralInfo) => {
    const offer = AppState.allOffers.find(o => o.OFFER_ID === offerId);
    if (!offer) {
        Utils.showNotification('Could not load offer details to build the engagement form.', 'error');
        return;
    }
    const modalWrapper = document.getElementById('modal-content-wrapper');
    const modalOverlay = document.getElementById('modal-overlay');

    // The `renderEngagementSuiteModal` function from the UI object is now called here
    modalWrapper.innerHTML = UI.renderEngagementSuiteModal(offer, referralInfo);

    document.body.classList.add('modal-open');
    modalOverlay.classList.remove('hidden');
    modalWrapper.style.transform = 'scale(0.9)';
    modalWrapper.style.opacity = '0';
    setTimeout(() => {
        modalWrapper.style.transform = 'scale(1)';
        modalWrapper.style.opacity = '1';
        // Set up all the dynamic listeners for the newly created form
        Logic.setupEngagementFormListeners(offerId);
    }, 50);
},

/**
 * Attaches all dynamic event listeners to the engagement form elements, including
 * the feasibility scorer, dynamic wallet inputs, and file upload handler.
 * @param {string} offerId - The ID of the target offer.
 */
setupEngagementFormListeners: (offerId) => {
    document.getElementById('modal-form').addEventListener('submit', (e) => {
        e.preventDefault();
        Logic.submitEngagementForm(offerId);
    });

    // Logic for dynamic wallet address input based on settlement protocol
    const settlementInput = document.getElementById('modal-settlement-protocol');
    const walletArea = document.getElementById('wallet-input-area');
    const renderWalletInput = () => {
        if (!settlementInput || !walletArea) return;
        const protocol = settlementInput.value.toUpperCase();
        let placeholder = '';
        if (protocol.includes('USDT (TRC-20)')) placeholder = 'USDT (TRC-20) Wallet Address (Optional)';
        else if (protocol.includes('USDT (ERC-20)')) placeholder = 'USDT (ERC-20) Wallet Address (Optional)';
        else if (protocol.includes('BTC')) placeholder = 'Bitcoin Wallet Address (Optional)';
        walletArea.innerHTML = placeholder ? `<div class="relative group mt-4"><input type="text" id="modal-wallet-address" placeholder="${placeholder}" class="form-input p-3 text-white rounded-xl w-full"><p class="text-xs text-gray-500 mt-1 pl-1">Provide the relevant wallet address for settlement.</p></div>` : '';
    };
    if (settlementInput) settlementInput.addEventListener('input', renderWalletInput);
    renderWalletInput(); // Initial call

    // Logic for the real-time Engagement Feasibility Score
    const dealParams = document.querySelectorAll('.deal-param');
    const updateFeasibility = () => {
        let deviations = Array.from(dealParams).filter(input => input.value.trim() !== '' && input.value !== input.dataset.original).length;
        const score = dealParams.length > 0 ? ((dealParams.length - deviations) / dealParams.length) * 100 : 100;
        const scoreEl = document.getElementById('feasibility-score'), barEl = document.getElementById('feasibility-bar'), guidanceEl = document.getElementById('feasibility-guidance');
        if (scoreEl && barEl && guidanceEl) {
            scoreEl.textContent = `${Math.round(score)}%`;
            scoreEl.className = `text-3xl font-black transition-all duration-300 ${score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'}`;
            barEl.style.width = `${score}%`;
            barEl.className = `h-2.5 rounded-full transition-all duration-500 ${score >= 80 ? 'bg-gradient-to-r from-green-500 to-emerald-400' : score >= 50 ? 'bg-gradient-to-r from-yellow-500 to-amber-400' : 'bg-gradient-to-r from-red-500 to-rose-400'}`;
            guidanceEl.innerHTML = deviations > 0 ? `<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>You have proposed ${deviations} amendment(s). This may increase negotiation time.` : `<i class="fas fa-check-circle text-green-500 mr-1"></i>Your enquiry perfectly aligns with the seller's offer.`;
        }
    };
    dealParams.forEach(input => input.addEventListener('input', updateFeasibility));

    // Logic for the file upload component
    const fileInput = document.getElementById('modal-file-upload');
    const fileListContainer = document.getElementById('file-list-container');
    if (fileInput && fileListContainer) {
        let uploadedFiles = [];
        const renderFileList = () => {
            fileListContainer.innerHTML = uploadedFiles.map((file, index) => `<div class="flex items-center justify-between bg-gray-800 p-2 rounded-lg animate-fade-in-up" style="animation-duration: 0.3s;"><div class="flex items-center gap-2 overflow-hidden"><i class="fas fa-file-alt text-gray-400"></i><span class="text-white truncate">${file.name}</span><span class="text-gray-500 font-mono flex-shrink-0">${(file.size / 1024 / 1024).toFixed(2)} MB</span></div><button type="button" class="remove-file-btn text-red-500 hover:text-red-400 text-lg font-bold w-6 h-6 rounded-full flex-shrink-0" data-index="${index}">×</button></div>`).join('');
            fileListContainer.querySelectorAll('.remove-file-btn').forEach(btn => btn.addEventListener('click', (e) => {
                uploadedFiles.splice(parseInt(e.currentTarget.dataset.index), 1);
                const dt = new DataTransfer();
                uploadedFiles.forEach(file => dt.items.add(file));
                fileInput.files = dt.files;
                renderFileList();
            }));
        };
        fileInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(newFile => { if (!uploadedFiles.some(f => f.name === newFile.name && f.size === newFile.size)) uploadedFiles.push(newFile); });
            const dt = new DataTransfer();
            uploadedFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
            renderFileList();
        });
    }
},

/**
 * Gathers all engagement form data, processes files into Base64, and submits
 * the complete payload to the backend for processing and email dispatch.
 * @param {string} offerId - The ID of the target offer.
 */
submitEngagementForm: async (offerId) => {
    const btn = document.querySelector('#modal-form button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing Files...';

    const getVal = id => document.getElementById(id)?.value || '';
    const getAmend = id => { const el = document.getElementById(id); return { value: el.value, isAmended: el.dataset.original !== el.value, original: el.dataset.original }; };
    
    const payload = {
        userName: getVal('modal-user-name'), userEmail: getVal('modal-user-email'), userPhone: getVal('modal-user-phone'), userRelationship: getVal('modal-user-relationship'),
        buyerName: getVal('modal-buyer-name'), buyerEntity: getVal('modal-buyer-entity'), buyerJurisdiction: getVal('modal-buyer-jurisdiction'),
        volume: getVal('modal-required-volume'), targetPrice: getVal('modal-target-price'), comments: getVal('modal-comments'), walletAddress: getVal('modal-wallet-address'),
        referralId: AppState.referralInfo.id, timezone: getVal('modal-timezone'), files: [],
        amendments: { asset: getAmend('modal-asset-category'), settlement: getAmend('modal-settlement-protocol'), procedure: getAmend('modal-core-procedure'), venue: getAmend('modal-preferred-venue') }
    };
    
    try {
        const fileInput = document.getElementById('modal-file-upload');
        if (fileInput && fileInput.files.length > 0) {
            if (Array.from(fileInput.files).reduce((s, f) => s + f.size, 0) > 25 * 1024 * 1024) { // Apps Script Email Attachment Limit
                throw new Error(`Total file size exceeds the 25MB limit.`);
            }
            payload.files = await Promise.all(Array.from(fileInput.files).map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result.split(',')[1] });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            })));
        }
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting to GECAN...';
        
        const message = await Logic.createApiRequest('sendEngagementRequestEmail', 'POST', { offerId, userInfo: payload });
        Utils.showNotification(message || 'Submission successful! GECAN will be in contact shortly.', 'success');
        Utils.closeModal('modal-overlay');

    } catch (error) {
        Utils.showNotification(error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Submit Formal Enquiry';
    }
},
    /**
 * Orchestrates the generation and download of a PDF dossier for a specific offer.
 * It provides UI feedback, calls the backend API, and handles the response.
 * @param {string} offerId - The ID of the offer to generate a dossier for.
 */
generateAndDownloadDossier: (offerId) => {
    const btn = document.getElementById(`print-dossier-btn-${offerId}`);
    if (!btn) return;

    // --- PREMIUM UI FEEDBACK: Show loading state ---
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating Dossier...`;

    // Find the complete data for the selected offer from the application state
    const offerData = AppState.allOffers.find(o => o.OFFER_ID === offerId);
    if (!offerData) {
        Utils.showNotification('Error: Could not find offer data to generate PDF.', 'error');
        btn.disabled = false;
        btn.innerHTML = originalContent;
        return;
    }

    // --- API CALL: Request the PDF from the backend ---
    Logic.createApiRequest('generateOfferDossierPdf', 'POST', { offerData })
        .then(response => {
            // On success, trigger the download
            Logic.downloadPdf(response);
        })
        .catch(error => {
            // On failure, notify the user
            Utils.showNotification(error.message || 'PDF generation failed. Please try again.', 'error');
        })
        .finally(() => {
            // --- RESTORE UI: Always re-enable the button ---
            btn.disabled = false;
            btn.innerHTML = originalContent;
        });
},

/**
 * Handles the client-side download of the Base64 encoded PDF received from the backend.
 * This function creates a temporary link and simulates a click to trigger the browser's
 * download prompt.
 * @param {object} response - The success object from the backend API.
 * @param {string} response.pdfData - The Base64 encoded PDF content.
 * @param {string} response.fileName - The suggested filename for the download.
 */
downloadPdf: (response) => {
    // --- VALIDATION: Ensure the response from the server is valid ---
    if (!response || !response.pdfData || !response.fileName) {
        Utils.showNotification('Failed to receive valid PDF data from the server.', 'error');
        console.error("Invalid PDF response from backend:", response);
        return;
    }

    try {
        // --- DOWNLOAD LOGIC ---
        // Create an anchor element in memory
        const link = document.createElement('a');
        
        // Set the href to the Base64 data URI for the PDF
        link.href = `data:application/pdf;base64,${response.pdfData}`;
        
        // Set the suggested download filename
        link.download = response.fileName;
        
        // Append the link to the body (required for Firefox compatibility)
        document.body.appendChild(link);
        
        // Programmatically click the link to trigger the download
        link.click();
        
        // Remove the temporary link from the DOM
        document.body.removeChild(link);

        // Notify the user of success
        Utils.showNotification('Dossier download started successfully!', 'success');

    } catch (error) {
        Utils.showNotification('An error occurred while trying to download the file.', 'error');
        console.error("PDF download client-side error:", error);
    }
},

    // --- Navigation & Static Content ---

    /**
 * Dynamically generates and injects the main desktop navigation bar.
 * This function builds the navigation from a centralized array, making it easily
 * maintainable and scalable. It intelligently determines the active page
 * to apply the correct styling for a seamless user experience.
 */
populateNavLinks: () => {
    const navPlaceholder = document.getElementById('desktop-nav-placeholder');
    if (!navPlaceholder) {
        console.error("Critical Failure: Desktop navigation placeholder not found.");
        return;
    }

    // --- Centralized Navigation Configuration ---
    // This array is the single source of truth for the navigation bar.
    // To add, remove, or reorder links, simply edit this array.
    const links = [
        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
        { page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },
        { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },
        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }
    ];
    
    // --- Active Page Detection Logic ---
    // This robust method correctly identifies the current page even with complex paths.
    const path = window.location.pathname;
    const currentPageFile = path.substring(path.lastIndexOf('/') + 1).replace('.html', '');

    // --- Dynamic HTML Generation ---
    // This maps the links array into the full HTML structure, preserving all premium classes.
    const navHtml = `
        <div id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">
            ${links.map(link => {
                // Determine if the current link is the active one.
                // Handles the case where 'index.html' might be omitted from the URL.
                const isActive = (currentPageFile === link.page) || (currentPageFile === '' && link.page === 'index');
                
                return `
                    <a href="./${link.page}.html" class="nav-btn nav-link ${isActive ? 'active' : ''}">
                        <div class="nav-icon-wrapper">
                            <div class="nav-icon-flipper">
                                <div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div>
                                <div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div>
                            </div>
                        </div>
                        <span class="nav-text">${link.text}</span>
                    </a>
                `;
            }).join('')}
        </div>`;

    // --- DOM Injection ---
    navPlaceholder.innerHTML = navHtml;

    // Ensure the main logo also links back to the homepage correctly.
    const logoLink = document.getElementById('logo-link');
    if (logoLink) {
        logoLink.href = './index.html';
    }
},
};

        // --- F. INITIALIZATION & GLOBAL BINDINGS ---
        document.addEventListener('DOMContentLoaded', Logic.init);
        window.Utils = Utils;
        window.UI = UI;
        window.Logic = Logic;
    </script>
    
    <!-- III. Inline CSS Styling Engine -->
    <style>
        /* --- A. CORE THEME & VARIABLES --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap');
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300..700&display=swap');

:root {
    --brand-gecan-blue: #1c2e4a;
    --brand-gecan-gold: #b4975a;
    --primary-azure: #0ea5e9;
    --primary-sapphire: #3b82f6;
    --primary-royal: #6366f1;
    --primary-amethyst: #8b5cf6;
    --primary-diamond: #f8fafc;
    --background-primary: #0a0a0f;
    --background-secondary: #1e293b;
    --background-glass: rgba(15, 23, 42, 0.8);
    --background-glass-premium: rgba(15, 23, 42, 0.9);
    --border-color: rgba(148, 163, 184, 0.2);
    --border-secondary: rgba(148, 163, 184, 0.2);
    --border-premium: rgba(148, 163, 184, 0.3);
    --text-diamond: #f8fafc;
    --text-platinum: #e2e8f0;
    --text-silver: #cbd5e1;
    --text-muted: #94a3b8;
    --text-subtle: #64748b;
    --glow-azure: rgba(14, 165, 233, 0.8);
    --glow-sapphire: rgba(59, 130, 246, 0.9);
    --glow-royal: rgba(139, 92, 246, 0.8);
    --glow-amethyst: rgba(168, 85, 247, 0.7);
    --glow-gold: rgba(251, 191, 36, 0.6);
    --glow-diamond: rgba(248, 250, 252, 0.9);
    --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
    --gradient-luxury: linear-gradient(180deg, #0f172a, #1e293b, #334155);
    --shadow-standard: 0 4px 6px -1px rgba(0, 0, 0, 0.6);
    --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
    --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    --shadow-luxury: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
    --transform-hover: translateY(-8px) rotateX(5deg) scale(1.03);
    --transform-active: translateY(-12px) rotateX(8deg) scale(1.05);
    --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
    --status-active: #22c55e;
    --status-pending: #f59e0b;
    --status-blacklisted: #ef4444;
    --status-withdrawn: #6b7280;
    --status-limited: #3b82f6;
    --asset-bitcoin: #f7931a;
    --asset-gold: #ffd700;
    --asset-usdt: #26a17b;
}

        /* --- B. BASE STYLES & RESETS --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
*::before, *::after { box-sizing: border-box; }
html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    color: var(--text-platinum);
    background: transparent;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden; /* Prevents horizontal scroll on mobile */
}

body.modal-open { overflow: hidden; }

/* Particle canvas interactivity fix */
#particles-js {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1;
    pointer-events: none;
}

/* Custom scrollbar styling */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--background-secondary); }
::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { filter: brightness(1.2); }

/* Custom text selection styling */
::selection { background: var(--gradient-primary); color: var(--text-diamond); }
::-moz-selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. HIGH-LEVEL LAYOUT & STRUCTURE --- */

/* Main Header System */
.premium-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--background-glass-premium);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-bottom: 1px solid var(--border-premium);
    box-shadow: var(--shadow-ultra);
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    perspective: 1500px;
}
.premium-header:hover {
    transform: translateY(-4px) rotateX(5deg);
    box-shadow: var(--shadow-premium), 0 0 70px var(--glow-royal);
}
.gecan-logo-container { perspective: 800px; }
.gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
.gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
.logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
.logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
.logo-back { transform: rotateY(180deg); background: radial-gradient(ellipse at center, rgba(180, 151, 90, 0.1), transparent 70%); padding: 0.5rem; }
.logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); transition: all 0.8s ease; }
.gecan-logo-container:hover .logo-back img { filter: brightness(1.2) drop-shadow(0 0 20px var(--brand-gecan-gold)) drop-shadow(0 0 50px var(--brand-gecan-blue)); transform: scale(1.1); }
.logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; position: relative; overflow: hidden; }
.logo-separator::after { content: ''; position: absolute; top: -50%; left: 50%; transform: translateX(-50%); width: 200%; height: 60px; background: radial-gradient(ellipse, rgba(248, 250, 252, 0.9), rgba(14, 165, 233, 0.7), transparent 70%); border-radius: 50%; filter: blur(20px); z-index: 1; animation: vertical-energy-scan 4s ease-in-out infinite; }

/* Centralized Layout */
.main-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 2.5rem;
}

/* Footer & HoloStream Wrapper System (DEFINITIVE FIX) */
/* The footer is now a standard block element at the end of the body */
footer {
    background: var(--background-glass-premium);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-top: 1px solid var(--border-premium);
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(248, 250, 252, 0.1), 0 0 50px rgba(139, 92, 246, 0.15);
    position: relative;
    overflow: hidden;
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
footer:hover {
    transform: translateY(-4px);
    box-shadow: 0 -15px 50px rgba(0, 0, 0, 0.6), inset 0 2px 0 rgba(248, 250, 252, 0.15), 0 0 80px var(--glow-royal);
}
footer::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(110deg, transparent 30%, rgba(248, 250, 252, 0.08) 50%, transparent 70%);
    animation: premium-shimmer 5s ease-in-out infinite;
    opacity: 0;
    transition: opacity 0.5s;
}
footer:hover::before { opacity: 1; }
footer h3, footer h4 { font-family: 'Orbitron', monospace; color: var(--text-diamond); }

/* This wrapper ONLY contains the HoloStream and IS fixed */
#fixed-bottom-ui-wrapper {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 39;
    pointer-events: none; /* Allows clicks to pass through to content underneath */
}
#fixed-bottom-ui-wrapper > * {
    pointer-events: auto; /* Re-enables pointer events for its direct children (the HoloStream) */
}

/* Sticky Filter Side Panel System (SEVERE UPGRADE) */
#sticky-filter-sidebar {
    position: fixed;
    top: 120px; /* Sits below the main header */
    left: 24px;
    z-index: 45;
    width: 320px;
    transform: translateX(calc(-100% - 24px)); /* Starts fully off-screen */
    transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
#sticky-filter-sidebar.is-stuck {
    transform: translateX(0); /* Slides into view when active */
}
/* Styling for the filter block when it's inside the sidebar */
#sticky-filter-sidebar #sticky-filter-header {
    background: var(--background-glass-premium);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    box-shadow: var(--shadow-luxury);
    border: 1px solid var(--border-premium);
    border-radius: 1.5rem;
    padding: 1rem;
    margin-top: 0;
}
#sticky-filter-sidebar .filter-tabs {
    flex-direction: column;
    align-items: stretch;
}
#sticky-filter-sidebar #advanced-filters-container .grid {
    grid-template-columns: 1fr;
}

/* Mobile Optimization & Sidebar System */
@media (max-width: 1280px) { /* Tablet and smaller desktop */
    #sticky-filter-sidebar { display: none; } /* Disable sticky side panel on smaller screens */
    #sticky-filter-header { position: static !important; transform: none !important; }
    #desktop-filter-placeholder { display: block !important; }
    #desktop-filter-placeholder > * { margin-top: 0 !important; }
}
@media (max-width: 1024px) {
    body { padding-bottom: 2rem !important; }
    #fixed-bottom-ui-wrapper { position: static; }
    #holo-stream-container { margin-top: 2rem; }
    #mobile-fab { display: flex; }
    #desktop-nav-placeholder { display: none; }
    #user-count-visual.xl\:block { display: none; }
    #command-center-wrapper { margin-top: 2rem; margin-bottom: 2rem; }
    #world-clock-command-center .flex-col { gap: 1.5rem; }
}
.mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; border-bottom: 1px solid var(--border-premium); }
.mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
.mobile-filter-clone { padding: 1rem; }
.mobile-filter-clone .filter-tabs { flex-direction: column; align-items: stretch; background: transparent; border: none; padding: 0; }
.mobile-filter-clone .filter-section { background: rgba(0,0,0,0.2); margin-top: 1rem; }
/* Other mobile styles preserved... */

        /* --- D. DYNAMIC BACKGROUND & EFFECTS ENGINE --- */
#interactive-background { position: fixed; inset: 0; z-index: -2; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
#background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; transition: transform 0.1s linear, filter 0.2s linear; animation: vortex-spin 10s linear infinite; }
#background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
#background-vortex::after { content: ''; position: absolute; inset: 10%; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(248, 250, 252, 0.1) 0%, transparent 3%, transparent 97%, rgba(14, 165, 233, 0.2) 100%); animation: vortex-shimmer 6s ease-in-out infinite; }
body.repulsor-active::before { content: ''; position: fixed; width: 300px; height: 300px; background: radial-gradient(circle, rgba(14, 165, 233, 0.25) 0%, rgba(14, 165, 233, 0.1) 40%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); z-index: -1; pointer-events: none; top: var(--mouse-y, 0); left: var(--mouse-x, 0); transition: opacity 0.3s ease; filter: blur(10px); }

        /* --- E. CORE COMPONENT STYLING --- */

/* 3D Card System */
.offer-card { background: var(--background-glass); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); border: 1px solid var(--border-secondary); border-radius: 1.5rem; padding: 2rem; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; transform-style: preserve-3d; box-shadow: var(--shadow-standard); }
.offer-card:hover { transform: var(--transform-ultra); border-color: var(--asset-primary, var(--primary-royal)); box-shadow: var(--shadow-luxury), 0 0 60px var(--asset-glow, var(--glow-azure)); }
.offer-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 40%), radial-gradient(circle at 30% 20%, var(--asset-glow, var(--glow-azure)), transparent 70%); opacity: 0; transition: all 0.8s ease; border-radius: 1.5rem; pointer-events: none; }
.offer-card:hover::before { opacity: 0.2; transform: scale(1.5); }
.offer-card::after { content: ''; position: absolute; inset: 0; border-radius: 1.5rem; padding: 1px; background: var(--asset-gradient, var(--gradient-primary)); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask-composite: subtract; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: subtract; opacity: 0; transition: opacity 0.8s ease; }
.offer-card:hover::after { opacity: 0.3; }
.card-content { position: relative; transform-style: preserve-3d; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.offer-card:hover .card-content { transform: translateZ(30px); }
.asset-header { font-family: 'Orbitron', monospace; font-weight: 800; font-size: 1.5rem; background: var(--asset-gradient, var(--gradient-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; margin-bottom: 1rem; }
.offer-card:hover .asset-header { transform: translateZ(50px) scale(1.15) rotateY(5deg); text-shadow: 0 0 30px var(--asset-glow), 0 0 60px var(--asset-glow); filter: brightness(1.3); }

/* 3D Navigation & Filter Tabs */
.nav-btn, .filter-tab { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
.nav-btn:hover:not(.active), .filter-tab:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
.nav-btn.active, .filter-tab.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
.nav-btn.active { transform: translateY(-4px) scale(1.02); }
.filter-tab.active { transform: translateY(-4px) scale(1.05); }
.nav-icon-wrapper, .tab-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
.nav-icon-flipper, .tab-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
.nav-btn:hover:not(.active) .nav-icon-flipper, .filter-tab:hover:not(.active) .tab-icon-flipper { transform: rotateY(360deg); }
.nav-icon-face, .tab-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; transition: all 0.5s ease; }
.nav-icon-front, .tab-icon-front { color: var(--text-muted); }
.nav-icon-back, .tab-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }

/* 3D Metrics Bar */
.metrics-item { background: var(--background-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-secondary); border-radius: 1.5rem; padding: 1.5rem; position: relative; overflow: hidden; cursor: default; transform-style: preserve-3d; box-shadow: var(--shadow-subtle); transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.metrics-item:hover { transform: var(--transform-ultra); border-color: var(--metrics-color); box-shadow: var(--shadow-luxury), 0 0 80px var(--metrics-glow); background: var(--background-glass-premium); }
.metrics-icon-container { perspective: 800px; width: 64px; height: 64px; }
.metrics-icon-3d { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
.metrics-item:hover .metrics-icon-3d { transform: rotateY(360deg); }
.icon-face { position: absolute; inset: 0; display: grid; place-items: center; border-radius: 50%; backface-visibility: hidden; font-size: 28px; }
.icon-front { background: linear-gradient(135deg, var(--background-accent), var(--background-dark)); border: 2px solid var(--border-premium); color: var(--metrics-color); text-shadow: 0 0 15px var(--metrics-glow); }
.icon-back { transform: rotateY(180deg); background: radial-gradient(ellipse at center, var(--metrics-color) 0%, transparent 70%); box-shadow: 0 0 30px var(--metrics-glow); }

/* Live Market Ticker System */
.market-ticker-item { background: var(--background-glass); backdrop-filter: blur(25px); border: 1px solid var(--border-secondary); border-left: 4px solid var(--asset-color, var(--primary-azure)); border-radius: 1.5rem; padding: 1.25rem 1.5rem; min-width: 280px; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: default; transform-style: preserve-3d; }
.market-ticker-item:hover { transform: var(--transform-hover); border-color: var(--asset-color, var(--primary-azure)); box-shadow: var(--shadow-premium), 0 0 50px var(--asset-glow, var(--glow-azure)); }
.market-ticker-item .price { font-family: 'JetBrains Mono', monospace; font-size: 2.25rem; font-weight: 700; transition: all 0.3s ease-in-out; }
.price-up { color: #22c55e; text-shadow: 0 0 15px #22c55e; }
.price-down { color: #ef4444; text-shadow: 0 0 15px #ef4444; }
.price-stale { color: var(--text-silver); }
.price-flash-up { animation: price-flash-up 0.7s ease-out; }
.price-flash-down { animation: price-flash-down 0.7s ease-out; }
.ticker-logo-container { perspective: 800px; width: 60px; height: 60px; }
.ticker-logo-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
.market-ticker-item:hover .ticker-logo-flipper { transform: rotateY(360deg); }
.logo-face-front, .logo-face-back { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
.logo-face-back { transform: rotateY(180deg); }
.premium-ticker-svg { width: 100%; height: 100%; overflow: visible; }
.market-ticker-item[data-asset-key="BTC-USD"] { --asset-color: var(--asset-bitcoin); --asset-glow: rgba(247, 147, 26, 0.7); }
.market-ticker-item[data-asset-key="XAU-OZ-USD"] { --asset-color: var(--asset-gold); --asset-glow: rgba(255, 215, 0, 0.7); }

/* HoloStream Asteroid Surface & Ticker */
#holo-stream-container { perspective: 1200px; overflow: visible; position: relative; background: rgba(10, 10, 15, 0.6); backdrop-filter: blur(20px) saturate(150%); -webkit-backdrop-filter: blur(20px) saturate(150%); box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5); }
#holo-stream-container::before { content: ''; position: absolute; width: 100%; height: 18px; left: 0; bottom: 100%; z-index: 41; background-image: linear-gradient(135deg, var(--background-secondary) 45%, transparent 45%), linear-gradient(225deg, var(--background-secondary) 45%, transparent 45%); background-size: 16px 16px; background-color: var(--background-primary); }
#holo-stream-container::after { content: ''; position: absolute; width: 100%; height: 20px; left: 0; bottom: 100%; pointer-events: none; z-index: 42; background: repeating-linear-gradient(75deg, transparent, transparent 15px, rgba(14, 165, 233, 0.2) 15.5px, rgba(139, 92, 246, 0.1) 16px); opacity: 0.8; }
.holo-stream-track { display: flex; position: absolute; left: 0; top: 0; bottom: 0; align-items: center; transform-style: preserve-3d; animation: holo-scroll 120s linear infinite; }
#holo-stream-container:hover .holo-stream-track { animation-play-state: paused; }
.holo-item { flex-shrink: 0; display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1.5rem; margin: 0 1rem; color: var(--text-silver); background: var(--background-glass); border: 1px solid var(--border-secondary); border-radius: 1rem; transition: all 0.4s ease; transform: rotateX(15deg) scale(0.9); cursor: pointer; }
#holo-stream-container:hover .holo-item.focused { transform: rotateX(0deg) translateY(-25px) scale(1.1); background: var(--background-glass-premium); color: var(--text-diamond); box-shadow: var(--shadow-premium), 0 0 50px var(--item-glow-color, var(--glow-azure)); border-color: var(--item-glow-color, var(--primary-azure)); }
.holo-item[data-type="opportunity"] { --item-glow-color: var(--glow-gold); }
.holo-item[data-type="bulletin"] { --item-glow-color: var(--glow-azure); }

/* Kanban System */
.kanban-board { display: grid; } /* Grid handled by Tailwind classes */
.kanban-column { background: var(--background-glass); border: 1px solid var(--border-secondary); border-radius: 1.5rem; }
.kanban-card { background: var(--background-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-secondary); border-radius: 1rem; padding: 1.5rem; transition: all 0.5s ease; cursor: pointer; transform-style: preserve-3d; }
.kanban-card:hover { background: var(--background-glass-premium); transform: var(--transform-hover); box-shadow: var(--shadow-premium), 0 0 40px var(--glow-azure); border-color: var(--border-premium); }

/* World Clock System */
/* Styles for the clock are preserved from the original code */
#command-center-wrapper { background: var(--background-glass); border: 1px solid var(--border-secondary); border-radius: 1.5rem; padding: 1rem 1.5rem; box-shadow: var(--shadow-ultra); transition: all 0.5s ease; }
.clock, .premium-clock { width: 140px; height: 140px; border: 4px solid var(--border-secondary); border-radius: 50%; position: relative; background: radial-gradient(circle, var(--background-premium), var(--background-secondary)); box-shadow: inset 0 0 30px rgba(0,0,0,0.9); transition: all 0.6s ease; }
.clock:hover { border-color: var(--primary-azure); box-shadow: inset 0 0 30px rgba(0,0,0,0.9), 0 0 60px var(--glow-azure); transform: scale(1.1) rotateY(10deg); }
.clock::after { content: ''; position: absolute; width: 16px; height: 16px; background: var(--gradient-primary); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 15; box-shadow: 0 0 20px var(--glow-azure); }
.hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; border-radius: 4px; box-shadow: 0 0 12px rgba(0,0,0,0.6); }
.hour-hand { width: 8px; height: 40px; background: var(--text-diamond); z-index: 12; }
.minute-hand { width: 6px; height: 55px; background: var(--text-platinum); z-index: 13; }
.second-hand { width: 3px; height: 60px; background: var(--primary-azure); z-index: 14; filter: drop-shadow(0 0 8px var(--glow-azure)); }

/* Modal & Form System */
#modal-overlay, #engagement-modal { transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); background: rgba(0, 0, 0, 0.85); z-index: 60; }
#modal-content-wrapper { transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: var(--background-glass-premium); border: 1px solid var(--border-premium); border-radius: 2rem; box-shadow: var(--shadow-luxury); }
.form-input { background: var(--background-glass); border: 1px solid var(--border-secondary); border-radius: 0.75rem; padding: 0.75rem 1rem; color: var(--text-platinum); transition: all 0.4s ease; }
.form-input:focus { outline: none; border-color: var(--primary-azure); background: var(--background-glass-premium); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15); transform: translateY(-2px); }
select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em; padding-right: 2.5rem; }

/* "Coming Soon" Showcase Placeholder */
.placeholder-showcase { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4rem 2rem; background: var(--background-glass); border-radius: 1.5rem; border: 1px solid var(--border-secondary); }
.showcase-icon-wrapper { position: relative; width: 120px; height: 120px; margin-bottom: 2.5rem; animation: icon-float 8s ease-in-out infinite; }
.showcase-icon-3d { width: 100%; height: 100%; transform-style: preserve-3d; animation: icon-spin 25s linear infinite; }
.showcase-title { font-family: 'Orbitron', monospace; font-size: 2.5rem; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px var(--glow-azure); margin-bottom: 1rem; animation: text-glow-pulse 5s ease-in-out infinite; }
.showcase-subtitle { font-size: 1.1rem; color: var(--text-silver); max-width: 600px; margin-bottom: 2rem; }

/* Asset-Specific Theming System */
.asset-color-DIGITAL_ASSETS_GENERAL { --asset-primary: #8b5cf6; --asset-glow: rgba(139, 92, 246, 0.7); --asset-gradient: linear-gradient(135deg, #8b5cf6, #c084fc); }
.asset-color-BITCOIN_BTC { --asset-primary: #f7931a; --asset-glow: rgba(247, 147, 26, 0.7); --asset-gradient: linear-gradient(135deg, #f7931a, #fbbf24); }
.asset-color-ETHEREUM_ETH { --asset-primary: #627eea; --asset-glow: rgba(98, 126, 234, 0.7); --asset-gradient: linear-gradient(135deg, #627eea, #8A92B2); }
.asset-color-STABLECOINS_GENERAL { --asset-primary: #22c55e; --asset-glow: rgba(34, 197, 94, 0.7); --asset-gradient: linear-gradient(135deg, #22c55e, #4ade80); }
.asset-color-FINANCIAL_INSTRUMENTS_GENERAL { --asset-primary: #3b82f6; --asset-glow: rgba(59, 130, 246, 0.7); --asset-gradient: linear-gradient(135deg, #3b82f6, #60a5fa); }
.asset-color-ENERGY_GENERAL { --asset-primary: #44403c; --asset-glow: rgba(68, 64, 60, 0.9); --asset-gradient: linear-gradient(135deg, #292524, #57534e); }
.asset-color-METALS_MINING_GENERAL { --asset-primary: #a1a1aa; --asset-glow: rgba(161, 161, 170, 0.7); --asset-gradient: linear-gradient(135deg, #a1a1aa, #d4d4d8); }
.asset-color-GOLD_AU { --asset-primary: #ffd700; --asset-glow: rgba(255, 215, 0, 0.7); --asset-gradient: linear-gradient(135deg, #ffd700, #fef08a); }
.asset-color-AGRICULTURAL_GENERAL { --asset-primary: #ca8a04; --asset-glow: rgba(202, 138, 4, 0.7); --asset-gradient: linear-gradient(135deg, #ca8a04, #eab308); }
.asset-color-INVESTMENT_VERTICALS_GENERAL { --asset-primary: #4c1d95; --asset-glow: rgba(76, 29, 149, 0.7); --asset-gradient: linear-gradient(135deg, #4c1d95, #6d28d9); }
.asset-color-PROFESSIONAL_SERVICES_GENERAL { --asset-primary: #0369a1; --asset-glow: rgba(3, 105, 161, 0.7); --asset-gradient: linear-gradient(135deg, #0369a1, #0ea5e9); }
/* ... other specific asset styles can be added here ... */

        /* --- F. INTERACTIVITY & ANIMATIONS --- */

/* Used for active navigation buttons, filter tabs, and user count updates */
@keyframes premium-active-glow {
    0%, 100% {
        box-shadow: var(--shadow-premium), 0 0 30px var(--glow-azure);
        text-shadow: 0 0 7px rgba(255, 255, 255, 1), 0 0 15px var(--glow-azure);
    }
    50% {
        box-shadow: var(--shadow-luxury), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst);
        text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal), 0 0 50px var(--glow-amethyst);
    }
}

/* Used for the pulsing effect on the main header logo separator */
@keyframes premium-pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 30px var(--glow-azure);
    }
    100% {
        transform: scale(1.05);
        box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal);
    }
}

/* Used for the scanning light on the main header logo separator */
@keyframes vertical-energy-scan {
    0% { top: -50%; opacity: 0; }
    50% { top: 50%; opacity: 1; }
    100% { top: 150%; opacity: 0; }
}

/* Used for the shimmering light sweep effect on the footer */
@keyframes premium-shimmer {
    0% { transform: translateX(0); }
    100% { transform: translateX(100%); }
}

/* Used for the ambient rotation of the interactive background vortex */
@keyframes vortex-spin {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Used for the ambient pulsing of the interactive background vortex */
@keyframes vortex-pulse {
    from { transform: scale(0.9) rotate(0deg); opacity: 0.7; }
    to { transform: scale(1.1) rotate(15deg); opacity: 1; }
}

/* Used for the core shimmer of the interactive background vortex */
@keyframes vortex-shimmer {
    0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
    50% { transform: scale(1.05) rotate(-10deg); filter: brightness(1.5); }
    100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
}

/* Used for the glowing text on the main GECAN logo */
@keyframes premium-text-glow {
    0%, 100% { text-shadow: 0 0 40px var(--glow-azure); }
    50% { text-shadow: 0 0 70px var(--glow-royal); }
}

/* Used for the seamless scrolling of the HoloStream ticker */
@keyframes holo-scroll {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
}

/* Universal class for progressive loading of content blocks */
.fade-in-up {
    animation: premium-fade-in-up 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    opacity: 0;
}
@keyframes premium-fade-in-up {
    from { opacity: 0; transform: translateY(40px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Used for market ticker price change feedback */
@keyframes price-flash-up {
    0% { background-color: rgba(34, 197, 94, 0.3); }
    100% { background-color: transparent; }
}
@keyframes price-flash-down {
    0% { background-color: rgba(239, 68, 68, 0.3); }
    100% { background-color: transparent; }
}

/* Used for the "Coming Soon" showcase placeholder component */
@keyframes icon-float {
    0%, 100% { transform: translateY(0) rotateY(0deg); }
    50% { transform: translateY(-15px) rotateY(15deg); }
}
@keyframes icon-spin {
    from { transform: rotateY(0deg) rotateX(10deg); }
    to { transform: rotateY(360deg) rotateX(10deg); }
}
@keyframes text-glow-pulse {
    0%, 100% { text-shadow: 0 0 30px var(--glow-azure); filter: brightness(1); }
    50% { text-shadow: 0 0 50px var(--glow-royal); filter: brightness(1.2); }
}

/* Inline reset button active glow */
#reset-filters-btn-inline.glow-active {
    animation: premium-active-glow 2.5s ease-in-out infinite;
    color: var(--text-diamond);
    background: var(--background-glass);
    border-color: var(--primary-azure);
}
    </style>
</head>

<body>
    <!-- ======================================================= -->
    <!-- BODY: STRUCTURAL HTML & UI COMPONENTS                   -->
    <!-- ======================================================= -->

    <!-- I. Dynamic Background Layers (Positioned behind all content) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <!-- Header for the Sidebar -->
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-white">GECAN™ Menu</h2>
                <p class="text-xs text-gray-400 font-mono">Navigation & Filters</p>
            </div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <!-- Scrollable content area where JS clones elements -->
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>

    <!-- Floating Action Button for Mobile -->
    <button id="mobile-fab" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>

    <!-- III. Main Header -->
    <header class="premium-header p-4 md:p-6 print-hide">
        <div class="container mx-auto flex items-center justify-between gap-6">
            
            <!-- Item 1: 3D Animated Logo Section -->
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="#" id="logo-link" class="gecan-logo-container flex items-center gap-4">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back">
                            <img src="[BASE64_LOGO_PLACEHOLDER]" alt="GECAN Official Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">XDealFlow Dashboard</h1>
                        <p class="text-sm text-gray-400 font-mono">Premium Institutional Platform</p>
                    </div>
                </a>
            </div>
            
            <!-- Item 2: User Count Ticker -->
            <div id="user-count-visual" class="text-center min-w-[100px] flex-shrink-0 hidden xl:block">
                <p class="font-bold text-xl text-[var(--primary-azure)]" style="text-shadow: 0 0 10px var(--glow-azure);">3,699</p>
                <p class="text-xs text-gray-400 font-mono">Live Users</p>
            </div>

            <!-- Item 3: Desktop Navigation Placeholder -->
            <div id="desktop-nav-placeholder" class="flex-grow">
                <!-- JavaScript will populate the navigation bar here -->
            </div>
            
        </div>
    </header>

    <!-- IV. Main Content Layout -->
    <div class="container mx-auto main-layout px-4 md:px-6">
        <main>
            <!-- A. Command & Control Center (Upgraded & Collapsible) -->
            <div id="command-center-wrapper" class="relative mt-12 mb-12">
                <div class="command-center-header flex justify-between items-center mb-4 px-2">
                    <h2 class="text-lg font-bold text-white tracking-wider flex items-center gap-3">
                        <i class="fas fa-globe-americas text-[var(--primary-azure)]"></i>
                        <span>Global Command Center</span>
                    </h2>
                    <button id="toggle-command-center-btn" class="text-sm text-gray-400 hover:text-white transition-colors duration-300" title="Toggle View">
                        <span class="expand-text">Minimize</span><i class="fas fa-chevron-up ml-2 expand-icon transition-transform duration-300"></i>
                    </button>
                </div>
                <div id="world-clock-command-center" class="transition-all duration-500 ease-in-out max-h-[1000px] overflow-hidden">
                    <div class="flex flex-col xl:flex-row flex-wrap items-center justify-center gap-6">
                        <div id="clock-container" class="flex flex-wrap items-center justify-center gap-x-6 gap-y-6"></div>
                        <div id="clock-separator" class="hidden xl:block h-24 w-px bg-white/10 self-center"></div>
                        <div id="market-ticker-container" class="flex flex-wrap items-center justify-center gap-x-6 gap-y-6"></div>
                        <div class="flex-grow hidden xl:block"></div>
                        <div id="add-clock-controls" class="flex items-center gap-2 bg-black/20 backdrop-blur-sm border border-[var(--border-secondary)] p-2 rounded-xl self-center">
                            <select id="add-clock-select" class="form-input text-xs p-2 rounded-lg"></select>
                            <button id="add-clock-btn" class="btn-primary flex-shrink-0 w-10 h-10 rounded-full text-white font-bold text-lg hover:scale-110 active:scale-95 transition-all duration-300 flex items-center justify-center">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B. Sticky Filter System (Upgraded Architecture) -->
            <div class="relative">
                <!-- This invisible element triggers the sticky state change -->
                <div id="sticky-sentinel" class="absolute -top-24 h-px w-full"></div>

                <!-- This is the placeholder where the filters live in the normal document flow -->
                <div id="desktop-filter-placeholder">
                    <div id="sticky-filter-header" class="z-40 transition-all duration-300 -mt-4">
                        <div id="sticky-filter-content" class="pt-4 space-y-6">
                             <!-- Filter Tabs (3D Animated) -->
                            <div class="filter-tabs flex flex-wrap justify-center gap-2 md:gap-3">
                                <div class="filter-tab active" data-type="offers"><div class="tab-icon-wrapper"><div class="tab-icon-flipper"><div class="tab-icon-face tab-icon-front"><i class="fas fa-handshake"></i></div><div class="tab-icon-face tab-icon-back"><i class="fas fa-handshake"></i></div></div></div><span class="tab-text">Offers</span></div>
                                <div class="filter-tab" data-type="enquiries"><div class="tab-icon-wrapper"><div class="tab-icon-flipper"><div class="tab-icon-face tab-icon-front"><i class="fas fa-search-dollar"></i></div><div class="tab-icon-face tab-icon-back"><i class="fas fa-search-dollar"></i></div></div></div><span class="tab-text">Buyer Enquiries</span></div>
                                <div class="filter-tab" data-type="crowdfunding"><div class="tab-icon-wrapper"><div class="tab-icon-flipper"><div class="tab-icon-face tab-icon-front"><i class="fas fa-rocket"></i></div><div class="tab-icon-face tab-icon-back"><i class="fas fa-rocket"></i></div></div></div><span class="tab-text">Investment Projects</span></div>
                                <div class="filter-tab" data-type="services"><div class="tab-icon-wrapper"><div class="tab-icon-flipper"><div class="tab-icon-face tab-icon-front"><i class="fas fa-cogs"></i></div><div class="tab-icon-face tab-icon-back"><i class="fas fa-cogs"></i></div></div></div><span class="tab-text">Professional Services</span></div>
                            </div>
                            <!-- Main Filter Controls -->
                            <div class="filter-section rounded-2xl p-4 md:p-6">
                                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                                    <div class="relative w-full md:flex-1 group" id="search-container">
                                        <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-[var(--primary-azure)] transition-colors duration-300"></i>
                                        <input type="text" id="search-input" placeholder="Search by ID, Asset, Venue, Procedure..." class="form-input w-full py-3 pl-12 pr-28 text-sm">
                                        <button id="reset-filters-btn-inline" class="hidden absolute right-4 top-1/2 -translate-y-1/2 z-10 flex items-center gap-2 px-3 py-1.5 bg-sky-500/20 text-sky-300 border border-sky-500/30 rounded-lg text-xs hover:bg-sky-500/40 hover:text-white transition-all">
                                            <i class="fas fa-undo"></i><span>Reset</span>
                                        </button>
                                        <div id="search-suggestions" class="absolute top-full left-0 right-0 mt-2 z-50 rounded-xl overflow-hidden shadow-2xl transition-all duration-300 opacity-0 transform scale-95 pointer-events-none"></div>
                                    </div>
                                    <div class="flex items-center gap-2 md:gap-4 flex-wrap justify-center">
                                        <button id="toggle-advanced-filters-btn" class="btn-secondary px-4 py-2.5 rounded-xl text-sm font-medium flex items-center gap-2"><i class="fas fa-sliders-h"></i><span>Advanced Filters</span><span id="active-filter-count" class="hidden bg-[var(--primary-azure)] text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span></button>
                                        <button id="reset-filters" class="btn-secondary hidden px-4 py-2.5 rounded-xl text-sm"><i class="fas fa-undo"></i>Reset All</button>
                                        <div class="flex items-center gap-1 bg-[var(--background-dark)] border border-[var(--border-color)] p-1 rounded-xl">
                                            <button id="card-view-btn" class="btn-secondary active px-4 py-2 rounded-lg text-sm" title="Card View"><i class="fa fa-th-large"></i></button>
                                            <button id="kanban-view-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm" title="Kanban View"><i class="fa fa-columns"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- This is the container for the sticky side panel on desktop -->
                <div id="sticky-filter-sidebar"></div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="advanced-filters-container" class="transition-all duration-500 ease-in-out max-h-0 overflow-hidden relative z-30">
                <div class="filter-section rounded-2xl p-6 -mt-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Asset Category</label><select id="asset-category-select" class="form-input w-full p-3 text-sm"></select></div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Offer Status</label><div id="status-filters-container" class="space-y-2"></div></div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Settlement Protocol</label><select id="settlement-select" class="form-input w-full p-3 text-sm"></select></div>
                        <div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Core Procedure</label><select id="procedure-select" class="form-input w-full p-3 text-sm"></select></div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-[var(--border-color)] flex justify-between items-center">
                        <select id="sort-select" class="form-input p-3 text-sm"></select>
                    </div>
                </div>
            </div>

            <!-- C. Metrics & Data Display -->
            <div id="metrics-bar" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"></div>
            
            <div id="content-display">
                <div id="loading-spinner" class="text-center py-20">
                    <div class="relative inline-block"><i class="fas fa-spinner fa-spin fa-4x text-[var(--primary-azure)]"></i><div class="absolute inset-0 rounded-full animate-ping bg-[var(--primary-azure)] opacity-20"></div></div>
                    <p class="mt-6 text-xl">Loading Enhanced Institutional Offers...</p>
                </div>
                <div id="card-container" class="hidden grid grid-cols-1 md:grid-cols-2 3xl:grid-cols-5 gap-8"></div>
                <div id="kanban-container" class="hidden"></div>
                <div id="placeholder-content" class="hidden placeholder-showcase fade-in-up">
                    <div class="showcase-icon-wrapper"><div class="showcase-icon-3d"><div class="showcase-icon-base"><i id="placeholder-icon" class="fas fa-search-dollar"></i></div></div></div>
                    <h2 id="placeholder-title" class="showcase-title"></h2>
                    <p id="placeholder-text" class="showcase-subtitle"></p>
                    <span id="placeholder-tag" class="showcase-tag"></span>
                </div>
                <div id="no-results" class="hidden text-center py-20">
                    <i class="fas fa-search fa-4x text-gray-600 mb-6"></i>
                    <p class="text-xl font-medium text-gray-400">No offers found matching your criteria</p>
                    <p class="text-sm text-gray-500">Try adjusting your search terms or filters</p>
                </div>
            </div>
        </main>
    </div>

    <!-- V. Modals & Overlays -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 print-hide">
        <div id="modal-content-wrapper" class="rounded-2xl w-full max-w-6xl max-h-[90vh] shadow-2xl relative flex flex-col">
            <!-- Modal content is dynamically injected here by JavaScript -->
        </div>
    </div>
    
    <div id="engagement-modal" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4">
        <!-- Engagement suite content is dynamically injected here by JavaScript -->
    </div>
    
    <div id="live-update-toast" class="hidden fixed bottom-20 left-1/2 transform -translate-x-1/2 text-white font-bold py-3 px-8 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/20 bg-gradient-to-r from-[var(--primary-sapphire)] to-[var(--primary-amethyst)] backdrop-filter backdrop-blur-lg">
        <div class="flex items-center gap-3">
            <div class="relative"><i class="fas fa-sync-alt fa-spin text-xl"></i><div class="absolute inset-0 rounded-full animate-ping bg-white opacity-30"></div></div>
            <span class="text-lg">New Offer Data Available</span>
        </div>
        <button id="refresh-now-btn" class="font-bold text-white bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-all">Refresh Now</button>
    </div>
    
    <!-- VI. Fixed Bottom UI & Standard Footer -->

    <!-- This wrapper is FIXED and ONLY contains the HoloStream Ticker -->
    <div id="fixed-bottom-ui-wrapper" class="print-hide">
        <div id="holo-stream-container" class="h-28">
            <div class="holo-stream-track">
                <!-- HoloStream items are dynamically injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- This is the standard Legal Footer that flows at the natural end of the page -->
    <footer class="print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Financial.</p>
                    <p class="text-xs text-gray-500">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECAN™ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECAN™ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- VII. Print-Only Container (Hidden from view) -->
    <div id="printable-container" class="hidden print:block">
        <!-- PDF/Print content is dynamically injected here by JavaScript -->
        <div id="modal-pdf-header-content"></div>
        <div id="modal-pdf-body-content"></div>
        <div id="modal-pdf-footer-content"></div>
    </div>
</body>
</html>
