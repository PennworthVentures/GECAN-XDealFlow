<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE KILL BOX | OPTIMIZED EXTRACTION ENGINE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Playfair+Display:wght@700&display=swap');

        :root {
            --felt-color: #0f1f16; /* Deep extraction green */
            --felt-texture: radial-gradient(circle at center, #1a2e22 0%, #050a07 100%);
            --gold: #d4af37;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --silver: #c0c0c0;
            --red-alert: #ff3333;
            --card-width: 100px;
            --card-height: 140px;
            --chip-size: 60px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        /* --- THE TABLE ENVIRONMENT --- */
        #table-container {
            width: 100%;
            height: 100%;
            background: var(--felt-texture);
            position: relative;
            box-shadow: inset 0 0 150px #000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .felt-branding {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0.3;
            pointer-events: none;
        }

        .felt-branding h1 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 3rem;
            margin: 0;
            letter-spacing: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .felt-branding p {
            color: #fff;
            font-size: 0.9rem;
            letter-spacing: 2px;
            margin-top: 5px;
            font-weight: 700;
        }

        /* --- HUD --- */
        .hud-bar {
            width: 100%;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.6);
            border-bottom: 1px solid #333;
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
        }
        .stat-label { font-size: 0.7rem; color: #aaa; letter-spacing: 1px; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--gold); }

        /* --- ZONES --- */
        .dealer-zone, .player-zone {
            height: 200px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .dealer-zone { margin-top: 40px; }
        .player-zone { margin-bottom: 120px; }

        .score-bubble {
            position: absolute;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s;
            opacity: 0;
        }
        .dealer-score { top: -20px; }
        .player-score { bottom: -20px; }

        /* --- CARDS --- */
        .hand-container {
            display: flex;
            gap: 15px; /* Compressed for mobile, handled in JS */
        }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: #fff;
            border-radius: 8px;
            position: relative;
            box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), margin 0.3s;
            transform-style: preserve-3d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Playfair Display', serif;
        }

        .card.dealing {
            animation: flyIn 0.4s ease-out forwards;
            opacity: 0;
        }

        @keyframes flyIn {
            from { transform: translateY(-200px) scale(0.5) rotateY(180deg); opacity: 0; }
            to { transform: translateY(0) scale(1) rotateY(0deg); opacity: 1; }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            font-weight: bold;
            font-size: 1.4rem;
        }

        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #b22222 25%, #800000 25%, #800000 50%, #b22222 50%, #b22222 75%, #800000 75%, #800000 100%);
            background-size: 20px 20px;
            border-radius: 8px;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            border: 2px solid #fff;
        }

        .card.flipped { transform: rotateY(180deg); }

        .suit-red { color: #d00; }
        .suit-black { color: #111; }
        
        .card-center { font-size: 3rem; align-self: center; margin-top: -10px; }
        .card-corner-br { transform: rotate(180deg); }

        /* --- CONTROLS --- */
        .controls-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #000 0%, rgba(0,0,0,0) 100%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 200;
        }

        .betting-ui {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .chip {
            width: var(--chip-size);
            height: var(--chip-size);
            border-radius: 50%;
            background: conic-gradient(#fff 0deg 20deg, var(--chip-color) 20deg 70deg, #fff 70deg 90deg, var(--chip-color) 90deg 200deg, #fff 200deg 220deg, var(--chip-color) 220deg 270deg, #fff 270deg 290deg, var(--chip-color) 290deg 360deg);
            border: 4px dashed #fff;
            box-shadow: 0 5px 10px rgba(0,0,0,0.8), inset 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 1px 2px #000;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
        }
        
        .chip:active { transform: scale(0.9); }
        .chip::after {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .chip-red { --chip-color: #d00; }
        .chip-green { --chip-color: #008000; }
        .chip-black { --chip-color: #222; border-color: var(--gold); color: var(--gold); }

        .side-bets-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .side-bet-slot {
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.6rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .side-bet-slot.active {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .side-bet-val { font-size: 1rem; font-weight: bold; color: var(--gold); }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; }
        .btn:active { transform: scale(0.95); }

        .btn-hit { background: var(--gold-gradient); color: #222; }
        .btn-stand { background: #b30000; color: #fff; }
        .btn-double { background: #333; color: var(--gold); border: 1px solid var(--gold); }
        .btn-deal { 
            background: var(--gold-gradient); 
            color: #000; 
            font-size: 1.2rem; 
            width: 200px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: #111;
            border: 2px solid var(--gold);
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }

        .modal h2 { color: var(--gold); margin-top: 0; }
        
        .insurance-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-ins-yes { background: #00b300; color: white; padding: 15px; font-size: 1.1rem; }
        .btn-ins-no { background: #333; color: #aaa; padding: 10px; font-size: 0.8rem; }

        .notification {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px var(--gold);
            opacity: 0;
            pointer-events: none;
            z-index: 500;
            font-family: 'Playfair Display', serif;
            text-align: center;
        }

        @keyframes popFade {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

    <!-- NOTIFICATIONS -->
    <div id="notification" class="notification">BLACKJACK!</div>

    <!-- INSURANCE MODAL -->
    <div id="insurance-modal" class="modal-overlay">
        <div class="modal">
            <h2>INSURANCE?</h2>
            <p>Dealer shows Ace. Protect your hand (2:1).</p>
            <div class="insurance-btn-group">
                <button class="btn btn-ins-yes" onclick="game.takeInsurance(true)">YES - PROTECT MY BET</button>
                <button class="btn btn-ins-no" onclick="game.takeInsurance(false)">No thanks</button>
            </div>
        </div>
    </div>

    <div id="table-container">
        
        <!-- HUD -->
        <div class="hud-bar">
            <div class="stat-box">
                <span class="stat-label">BALANCE</span>
                <span class="stat-value" id="balance">$5,000</span>
            </div>
            <div class="stat-box" style="align-items: flex-end;">
                <span class="stat-label">TOTAL BET</span>
                <span class="stat-value" id="total-bet">$0</span>
            </div>
        </div>

        <!-- BRANDING -->
        <div class="felt-branding">
            <h1>SUPREME</h1>
            <p>BLACKJACK PAYS 6:5 • DEALER HITS SOFT 17</p>
        </div>

        <!-- DEALER AREA -->
        <div class="dealer-zone">
            <div class="score-bubble dealer-score" id="dealer-score">0</div>
            <div class="hand-container" id="dealer-hand">
                <!-- Cards go here -->
            </div>
        </div>

        <!-- PLAYER AREA -->
        <div class="player-zone">
            <div class="score-bubble player-score" id="player-score">0</div>
            <div class="hand-container" id="player-hand">
                <!-- Cards go here -->
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="controls-area">
            
            <!-- SIDE BETS -->
            <div class="side-bets-container" id="side-bet-ui">
                <div class="side-bet-slot" id="sb-pairs" onclick="game.toggleSideBet('pairs')">
                    <div>PERFECT<br>PAIRS</div>
                    <div class="side-bet-val" id="val-pairs">$0</div>
                    <div style="font-size: 0.5rem; color: #888; margin-top:2px;">UP TO 25:1</div>
                </div>
                <div class="side-bet-slot" id="sb-213" onclick="game.toggleSideBet('rummy')">
                    <div>21 + 3</div>
                    <div class="side-bet-val" id="val-213">$0</div>
                    <div style="font-size: 0.5rem; color: #888; margin-top:2px;">UP TO 100:1</div>
                </div>
            </div>

            <!-- BETTING CHIPS (Visible in Betting Phase) -->
            <div class="betting-ui" id="betting-controls">
                <div class="chip chip-red" onclick="game.addChip(5)">5</div>
                <div class="chip chip-green" onclick="game.addChip(25)">25</div>
                <div class="chip chip-black" onclick="game.addChip(100)">100</div>
                <button class="btn" style="background: #333; color: #fff; min-width: auto; font-size: 0.8rem;" onclick="game.clearBet()">CLEAR</button>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="action-buttons" id="game-controls">
                <!-- Injected via JS -->
            </div>

        </div>
    </div>

<script>
/**
 * THE KILL BOX ENGINE
 * Architecture: Singleton Game Controller
 * Rules: 6:5 BJ, H17, No DAS, No Surrender, Restricted Double (9-11), 8 Decks, CSM.
 */

const SETTINGS = {
    decks: 8,
    bjPayout: 1.2, // 6:5
    dealerH17: true,
    animationSpeed: 300, // ms
    turbo: true
};

class Card {
    constructor(suit, value) {
        this.suit = suit;
        this.value = value;
        this.id = Math.random().toString(36).substr(2, 9);
    }

    getScore() {
        if (['J', 'Q', 'K'].includes(this.value)) return 10;
        if (this.value === 'A') return 11;
        return parseInt(this.value);
    }

    getHTML(hidden = false) {
        const suitIcon = { 'H': '♥', 'D': '♦', 'S': '♠', 'C': '♣' }[this.suit];
        const suitClass = (this.suit === 'H' || this.suit === 'D') ? 'suit-red' : 'suit-black';
        
        // If hidden, we render the back face logic
        const cardDiv = document.createElement('div');
        cardDiv.className = `card ${hidden ? 'flipped' : 'dealing'}`;
        cardDiv.id = this.id;
        
        const faceDiv = document.createElement('div');
        faceDiv.className = `card-face ${suitClass}`;
        faceDiv.innerHTML = `
            <div class="card-corner-tl">${this.value}<div>${suitIcon}</div></div>
            <div class="card-center">${suitIcon}</div>
            <div class="card-corner-br">${this.value}<div>${suitIcon}</div></div>
        `;

        const backDiv = document.createElement('div');
        backDiv.className = 'card-back';

        cardDiv.appendChild(faceDiv);
        cardDiv.appendChild(backDiv);

        return cardDiv;
    }
}

class Deck {
    constructor(numDecks) {
        this.cards = [];
        const suits = ['H', 'D', 'S', 'C'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        for (let i = 0; i < numDecks; i++) {
            for (let s of suits) {
                for (let v of values) {
                    this.cards.push(new Card(s, v));
                }
            }
        }
        this.shuffle();
    }

    shuffle() {
        // Fisher-Yates
        for (let i = this.cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
        }
    }

    draw() {
        return this.cards.pop();
    }
}

class GameEngine {
    constructor() {
        this.balance = 5000;
        this.currentBet = 0;
        this.sideBets = { pairs: 0, rummy: 0 };
        this.deck = null;
        this.playerHand = [];
        this.dealerHand = [];
        this.phase = 'BETTING'; // BETTING, PLAYER_TURN, DEALER_TURN, RESOLVE
        this.insuranceOpen = false;
        
        this.ui = {
            balance: document.getElementById('balance'),
            totalBet: document.getElementById('total-bet'),
            dealerHand: document.getElementById('dealer-hand'),
            playerHand: document.getElementById('player-hand'),
            dealerScore: document.getElementById('dealer-score'),
            playerScore: document.getElementById('player-score'),
            gameControls: document.getElementById('game-controls'),
            bettingControls: document.getElementById('betting-controls'),
            sideBetUI: document.getElementById('side-bet-ui'),
            notification: document.getElementById('notification')
        };

        this.renderControls();
        this.updateHUD();
    }

    // --- CORE LOGIC ---

    initDeck() {
        // CSM: New shuffled deck every round to eliminate counting
        this.deck = new Deck(SETTINGS.decks); 
    }

    addChip(amount) {
        if (this.phase !== 'BETTING') return;
        if (this.balance >= amount) {
            this.balance -= amount;
            this.currentBet += amount;
            this.updateHUD();
            this.renderControls();
        }
    }

    toggleSideBet(type) {
        if (this.phase !== 'BETTING') return;
        const amount = 5; // Fixed side bet unit for speed
        if (this.sideBets[type] > 0) {
            // Remove
            this.balance += this.sideBets[type];
            this.sideBets[type] = 0;
            document.getElementById(type === 'pairs' ? 'sb-pairs' : 'sb-213').classList.remove('active');
        } else {
            // Add
            if (this.balance >= amount) {
                this.balance -= amount;
                this.sideBets[type] = amount;
                document.getElementById(type === 'pairs' ? 'sb-pairs' : 'sb-213').classList.add('active');
            }
        }
        this.updateValues();
    }

    clearBet() {
        if (this.phase !== 'BETTING') return;
        this.balance += this.currentBet;
        this.balance += this.sideBets.pairs;
        this.balance += this.sideBets.rummy;
        this.currentBet = 0;
        this.sideBets = { pairs: 0, rummy: 0 };
        
        document.querySelectorAll('.side-bet-slot').forEach(el => el.classList.remove('active'));
        this.updateHUD();
        this.renderControls();
    }

    async deal() {
        if (this.currentBet === 0) return;
        
        this.phase = 'DEALING';
        this.initDeck(); // Infinite Shoe Logic
        this.playerHand = [];
        this.dealerHand = [];
        this.ui.playerHand.innerHTML = '';
        this.ui.dealerHand.innerHTML = '';
        this.ui.dealerScore.style.opacity = 0;
        this.ui.playerScore.style.opacity = 0;
        this.renderControls(); // Hide betting chips

        // Resolve Side Bets immediately (The Trap)
        const p1 = this.deck.draw();
        const d1 = this.deck.draw();
        const p2 = this.deck.draw();
        const d2 = this.deck.draw(); // Hole card

        // Animation Sequence
        await this.animateCard(p1, this.ui.playerHand);
        await this.animateCard(d1, this.ui.dealerHand);
        await this.animateCard(p2, this.ui.playerHand);
        await this.animateCard(d2, this.ui.dealerHand, true); // Hidden

        this.playerHand = [p1, p2];
        this.dealerHand = [d1, d2];

        this.updateScores();
        this.checkSideBets(p1, p2, d1);

        // Check for Dealer Blackjack / Insurance
        if (d1.value === 'A') {
            this.offerInsurance();
            return;
        }

        if (this.calculateScore(this.dealerHand) === 21) {
            // Dealer BJ (No Peek check visually, but logic resolves here if not Ace)
            // But if dealer up is 10, standard rules usually peek. 
            // European No Peek means we play, then lose all. 
            // For this webapp UX, we will check immediately if it's 10 to save time (Turbo).
            if (d1.getScore() === 10) {
                await this.revealHoleCard();
                this.endRound();
                return;
            }
        }

        // Check Player Blackjack
        if (this.calculateScore(this.playerHand) === 21) {
            this.phase = 'RESOLVE';
            this.endRound();
            return;
        }

        this.phase = 'PLAYER_TURN';
        this.renderControls();
    }

    offerInsurance() {
        this.insuranceOpen = true;
        document.getElementById('insurance-modal').style.display = 'flex';
    }

    async takeInsurance(decision) {
        document.getElementById('insurance-modal').style.display = 'none';
        this.insuranceOpen = false;

        if (decision) {
            const cost = this.currentBet / 2;
            if (this.balance >= cost) {
                this.balance -= cost;
                // Check Dealer BJ
                if (this.calculateScore(this.dealerHand) === 21) {
                    this.notify("INSURANCE PAYS");
                    this.balance += cost * 3; // Return stake + 2:1 win
                    await this.revealHoleCard();
                    this.endRound();
                    return;
                } else {
                    this.notify("NO BLACKJACK");
                }
            }
        } else {
            // Check dealer BJ immediately if insurance declined
             if (this.calculateScore(this.dealerHand) === 21) {
                await this.revealHoleCard();
                this.endRound();
                return;
            }
        }
        
        // Continue if no BJ
        if (this.calculateScore(this.playerHand) === 21) {
            this.endRound();
        } else {
            this.phase = 'PLAYER_TURN';
            this.renderControls();
        }
    }

    // --- ACTIONS ---

    async hit() {
        const card = this.deck.draw();
        this.playerHand.push(card);
        await this.animateCard(card, this.ui.playerHand);
        
        const score = this.calculateScore(this.playerHand);
        this.updateScores();

        if (score > 21) {
            this.endRound();
        } else {
            // Double is disabled after hit
            this.renderControls();
        }
    }

    async stand() {
        this.phase = 'DEALER_TURN';
        this.renderControls();
        await this.playDealer();
    }

    async double() {
        const cost = this.currentBet;
        if (this.balance >= cost) {
            this.balance -= cost;
            this.currentBet += cost;
            this.updateHUD();
            
            const card = this.deck.draw();
            this.playerHand.push(card);
            await this.animateCard(card, this.ui.playerHand);
            this.updateScores();
            
            const score = this.calculateScore(this.playerHand);
            if (score > 21) {
                this.endRound();
            } else {
                await this.stand();
            }
        }
    }

    // --- DEALER AI (H17) ---

    async playDealer() {
        await this.revealHoleCard();
        
        // H17 Rule: Hit on Soft 17
        while (true) {
            let score = this.calculateScore(this.dealerHand);
            let isSoft = this.isSoft(this.dealerHand);

            if (score < 17 || (score === 17 && isSoft && SETTINGS.dealerH17)) {
                const card = this.deck.draw();
                this.dealerHand.push(card);
                await this.animateCard(card, this.ui.dealerHand);
                this.updateScores();
            } else {
                break;
            }
        }
        this.endRound();
    }

    async revealHoleCard() {
        const holeCard = this.ui.dealerHand.children[1];
        holeCard.classList.remove('flipped');
        this.updateScores();
        await new Promise(r => setTimeout(r, 500));
    }

    // --- MATH ---

    calculateScore(hand) {
        let score = 0;
        let aces = 0;
        hand.forEach(c => {
            score += c.getScore();
            if (c.value === 'A') aces++;
        });
        while (score > 21 && aces > 0) {
            score -= 10;
            aces--;
        }
        return score;
    }

    isSoft(hand) {
        let score = 0;
        let aces = 0;
        hand.forEach(c => {
            score += c.getScore();
            if (c.value === 'A') aces++;
        });
        return (aces > 0 && score <= 21 && (score + 10 > 21) === false); // Simple check: if we treated an ace as 1, would logic differ?
        // Better check: Calculate raw sum. If raw sum <= 11 and has ace, it's soft.
        // Actually, easiest: 
        let rawScore = 0;
        let hasAce = false;
        hand.forEach(c => {
             if(c.value === 'A') hasAce = true;
             rawScore += (c.value === 'A' ? 1 : c.getScore());
        });
        // If we have an Ace and treating one as 11 keeps us <= 21.
        // Logic in calculateScore handles value reduction. 
        // If calculateScore result implies an Ace is being used as 11.
        // If Score - 10 is valid sum of cards where A=1.
        // Let's stick to the loop logic:
        let s = 0; let a = 0;
        hand.forEach(c => { s += c.getScore(); if(c.value==='A') a++; });
        // if s <= 21 and a > 0, it's soft 21/20/etc? No.
        // Correct Soft Logic: 
        // Calculate with Aces = 1. If <= 11 AND has Ace, it is Soft.
        let minScore = 0;
        let aceCount = 0;
        hand.forEach(c => {
            let val = c.getScore();
            if(val === 11) { val = 1; aceCount++; }
            minScore += val;
        });
        return (aceCount > 0 && minScore <= 11);
    }

    // --- SIDE BET CALCULATOR ---
    checkSideBets(p1, p2, d1) {
        // Perfect Pairs (P1 + P2)
        let pairWin = 0;
        if (p1.value === p2.value) {
            if (p1.suit === p2.suit) pairWin = 25; // Perfect
            else if ((['H','D'].includes(p1.suit) && ['H','D'].includes(p2.suit)) || 
                     (['S','C'].includes(p1.suit) && ['S','C'].includes(p2.suit))) pairWin = 12; // Colored
            else pairWin = 6; // Mixed
        }

        if (this.sideBets.pairs > 0 && pairWin > 0) {
            const win = this.sideBets.pairs * pairWin + this.sideBets.pairs;
            this.notify(`PAIRS WIN $${Math.floor(win)}`);
            this.balance += win;
        }

        // 21+3 (P1, P2, D1)
        // Flush, Straight, Trips, Straight Flush, Suited Trips
        // Simplified Rummy check for this demo
        // (Just checking Flush or Trips for brevity in this single file constraint)
        let rummyWin = 0;
        const suits = [p1.suit, p2.suit, d1.suit];
        const vals = [p1.getScore(), p2.getScore(), d1.getScore()].sort((a,b)=>a-b); // Rough val approximation
        
        // Flush (5:1)
        if (suits[0] === suits[1] && suits[1] === suits[2]) rummyWin = 5;
        
        // Trips (30:1)
        if (p1.value === p2.value && p2.value === d1.value) rummyWin = 30;

        if (this.sideBets.rummy > 0 && rummyWin > 0) {
            const win = this.sideBets.rummy * rummyWin + this.sideBets.rummy;
            setTimeout(() => this.notify(`21+3 WIN $${Math.floor(win)}`), 1500);
            this.balance += win;
        }
    }

    // --- RESOLUTION ---

    endRound() {
        const pScore = this.calculateScore(this.playerHand);
        const dScore = this.calculateScore(this.dealerHand);

        let message = "";
        let winAmount = 0;

        if (pScore > 21) {
            message = "BUST";
        } else if (dScore > 21) {
            message = "DEALER BUST - YOU WIN";
            winAmount = this.currentBet * 2;
        } else if (pScore > dScore) {
            // Blackjack Check (2 cards = 21)
            if (pScore === 21 && this.playerHand.length === 2) {
                message = "BLACKJACK";
                winAmount = this.currentBet + (this.currentBet * SETTINGS.bjPayout);
            } else {
                message = "YOU WIN";
                winAmount = this.currentBet * 2;
            }
        } else if (pScore === dScore) {
             // BJ vs 21 Check
             const pBJ = (pScore === 21 && this.playerHand.length === 2);
             const dBJ = (dScore === 21 && this.dealerHand.length === 2);
             
             if (pBJ && !dBJ) {
                 message = "BLACKJACK";
                 winAmount = this.currentBet + (this.currentBet * SETTINGS.bjPayout);
             } else if (!pBJ && dBJ) {
                 message = "DEALER HAS BJ";
             } else {
                 message = "PUSH";
                 winAmount = this.currentBet;
             }
        } else {
            message = "DEALER WINS";
        }

        this.balance += winAmount;
        this.notify(message);
        
        this.phase = 'BETTING';
        this.currentBet = 0;
        this.updateValues();
        
        setTimeout(() => {
            this.updateHUD();
            this.renderControls();
            this.ui.sideBetUI.style.pointerEvents = 'all';
        }, 2000);
    }

    // --- UI UPDATES ---

    animateCard(card, container, hidden=false) {
        return new Promise(resolve => {
            const el = card.getHTML(hidden);
            container.appendChild(el);
            setTimeout(resolve, SETTINGS.animationSpeed);
        });
    }

    updateHUD() {
        this.ui.balance.innerText = `$${this.balance.toLocaleString()}`;
        this.updateValues();
    }

    updateValues() {
        this.ui.totalBet.innerText = `$${(this.currentBet + this.sideBets.pairs + this.sideBets.rummy).toLocaleString()}`;
        document.getElementById('val-pairs').innerText = `$${this.sideBets.pairs}`;
        document.getElementById('val-213').innerText = `$${this.sideBets.rummy}`;
    }

    updateScores() {
        const pScore = this.calculateScore(this.playerHand);
        this.ui.playerScore.innerText = pScore;
        this.ui.playerScore.style.opacity = 1;

        // Dealer score only shows upcard unless flipped
        if (this.dealerHand.length > 0) {
            const holeCardFlipped = !this.ui.dealerHand.children[1].classList.contains('flipped');
            if (holeCardFlipped) {
                this.ui.dealerScore.innerText = this.calculateScore(this.dealerHand);
            } else {
                const upCardVal = this.dealerHand[0].getScore();
                this.ui.dealerScore.innerText = upCardVal;
            }
            this.ui.dealerScore.style.opacity = 1;
        }
    }

    notify(msg) {
        const el = this.ui.notification;
        el.innerText = msg;
        el.style.animation = 'none';
        el.offsetHeight; /* trigger reflow */
        el.style.animation = 'popFade 2s forwards';
    }

    renderControls() {
        const container = this.ui.gameControls;
        const bettingUI = this.ui.bettingControls;
        const sbUI = this.ui.sideBetUI;
        container.innerHTML = '';

        if (this.phase === 'BETTING') {
            bettingUI.style.display = 'flex';
            sbUI.style.opacity = 1;
            sbUI.style.pointerEvents = 'all';
            
            const btnDeal = document.createElement('button');
            btnDeal.className = 'btn btn-deal';
            btnDeal.innerText = 'DEAL HAND';
            btnDeal.onclick = () => this.deal();
            if (this.currentBet === 0) btnDeal.disabled = true;
            container.appendChild(btnDeal);

        } else {
            bettingUI.style.display = 'none';
            sbUI.style.opacity = 0.5;
            sbUI.style.pointerEvents = 'none';

            if (this.phase === 'PLAYER_TURN') {
                // HIT
                const btnHit = document.createElement('button');
                btnHit.className = 'btn btn-hit';
                btnHit.innerText = 'HIT';
                btnHit.onclick = () => this.hit();
                container.appendChild(btnHit);

                // STAND
                const btnStand = document.createElement('button');
                btnStand.className = 'btn btn-stand';
                btnStand.innerText = 'STAND';
                btnStand.onclick = () => this.stand();
                container.appendChild(btnStand);

                // DOUBLE (RESTRICTED: 9, 10, 11 ONLY)
                const score = this.calculateScore(this.playerHand);
                // Also can only double on first two cards
                if (this.playerHand.length === 2 && (score >= 9 && score <= 11) && this.balance >= this.currentBet) {
                    const btnDouble = document.createElement('button');
                    btnDouble.className = 'btn btn-double';
                    btnDouble.innerText = 'DOUBLE';
                    btnDouble.onclick = () => this.double();
                    container.appendChild(btnDouble);
                }
            }
        }
    }
}

// START ENGINE
const game = new GameEngine();

</script>
</body>
</html>
