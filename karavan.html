<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ Karavan | Global Settlement Layer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                },
                extend: {
                    boxShadow: {
                        'inner-premium': 'inset 0 2px 8px 0 rgba(0, 0, 0, 0.5)',
                        'gold-glow': '0 0 25px rgba(180, 151, 90, 0.6)',
                        'azure-glow': '0 0 25px rgba(14, 165, 233, 0.5)',
                    },
                    keyframes: {
                        'vortex-pulse': {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.1)', opacity: '1' }
                        }
                    },
                    animation: {
                        'vortex-pulse': 'vortex-pulse 9s ease-in-out infinite alternate',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style id="pinnacle-styles">
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v6.1 (KARAVAN SUPREME EDITION) === */
        /* ========================================================================= */
        :root {
            --text-premium-gold: #EAE0C8;
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.25);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-gold: rgba(180, 151, 90, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --gradient-gold: linear-gradient(135deg, #fde047, #b4975a);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-gold); border-radius: 4px; }
        ::selection { background: var(--brand-gecan-gold); color: var(--background-dark); }
        
        /* --- SUPREME INTERACTIVE BACKGROUND ENGINE --- */
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(180, 151, 90, 0.1), rgba(99, 102, 241, 0.15), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(180, 151, 90, 0.2) 0%, rgba(99, 102, 241, 0.1) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- PREMIUM HEADER & NAVIGATION (BENCHMARKED) --- */
        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); transform: rotateY(180deg); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); }
        
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(180, 151, 90, 0.65), rgba(234, 179, 8, 0.5)), var(--background-glass); color: var(--text-premium-gold); font-weight: 700; border-color: var(--brand-gecan-gold); filter: brightness(1.1); animation: premium-gold-glow 2.5s ease-in-out infinite; }
        @keyframes premium-gold-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-gold), 0 0 80px var(--warning-color); text-shadow: 0 0 12px rgba(255, 223, 150, 1), 0 0 30px var(--glow-gold); } }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-gold); }

        /* --- KARAVAN-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        .glass-pane { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .role-selector-card { border: 2px solid var(--border-color); transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); transform-style: preserve-3d; position: relative; overflow: hidden; background: linear-gradient(145deg, var(--background-light), var(--background-dark)); }
        .role-selector-card:hover { transform: perspective(1000px) translateY(-10px) rotateX(5deg) scale(1.03); border-color: var(--brand-gecan-gold); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6), 0 0 30px var(--glow-gold); }
        .role-selector-card .icon-wrapper { transition: transform 0.4s ease; }
        .role-selector-card:hover .icon-wrapper { transform: scale(1.1) translateY(-5px) translateZ(20px); }

        .wizard-step-container { position: relative; perspective: 2000px; }
        .wizard-step { position: absolute; width: 100%; top: 0; left: 0; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.8s ease; backface-visibility: hidden; }
        .wizard-step.future { transform: translateX(50%) rotateY(-60deg) scale(0.8); opacity: 0; pointer-events: none; }
        .wizard-step.past { transform: translateX(-50%) rotateY(60deg) scale(0.8); opacity: 0; pointer-events: none; }
        .wizard-step.current { transform: translateX(0) rotateY(0) scale(1); opacity: 1; pointer-events: auto; position: relative; }
        
        .form-input, .form-select { background-color: var(--background-dark); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--brand-gecan-gold); box-shadow: 0 0 0 4px rgba(180, 151, 90, 0.2), inset 0 2px 4px rgba(0,0,0,0.3); }
        
        .btn-gold { background: var(--gradient-gold); border: 1px solid var(--brand-gecan-gold); color: var(--background-dark); text-shadow: 0 1px 1px rgba(255,255,255,0.2); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(180, 151, 90, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
        .btn-gold:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(180, 151, 90, 0.5); transform: translateY(-3px); filter: brightness(1.1); }
        .btn-gold:disabled { background: var(--background-secondary); border-color: var(--border-color); color: var(--text-muted); cursor: not-allowed; opacity: 0.5; box-shadow: none; }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    
    <!-- PREMIUM HEADER (BENCHMARKED & UNIFIED) -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back">
                             <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMywyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" alt="GECAN Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Karavan</h1>
                        <p class="text-sm text-gray-400 font-mono">Global Settlement Layer</p>
                    </div>
                </a>
            </div>
            <nav id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">
                <!-- Navigation is dynamically injected by JavaScript -->
            </nav>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-4 md:p-8">
        <!-- The entire UI is dynamically rendered here by the script -->
    </main>
    
    <footer class="mt-auto pt-16">
        <div class="container mx-auto p-6 md:p-10 border-t border-border-color">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-text-silver">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-text-muted">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">GECAN™ Karavan is a technology platform that facilitates connections between licensed liquidity providers and users. GECAN™ does not hold or transmit funds directly and is not a bank or licensed money transmitter in all jurisdictions.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions are subject to the AML/CTF regulations of both the originating and destination jurisdictions. Users must conduct their own due diligence. The use of digital assets carries inherent volatility risks.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- MODAL CONTAINER (Used for Onboarding/KYC) -->
    <div id="modal-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div id="modal-content-wrapper" class="rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl bg-gradient-to-br from-background-light to-background-accent border border-border-accent transform scale-95 opacity-0 transition-all duration-300">
            <!-- Modal content is dynamically rendered here -->
        </div>
    </div>

<script>
        // ====================================================================================
        // === GECAN™ KARAVAN ENGINE v2.0 (PROJECT KINESIS - PINNACLE STANDARD) ===
        // This single, unabridged script block contains the entire application logic for the
        // Global Settlement Layer. It is architected for military-grade compliance, performance,
        // and a supremely intuitive, state-driven user workflow, directly implementing the
        // definitive end-to-end specifications of Project Kinesis.
        // ====================================================================================
        
        (function() {
            'use strict';
            
            // SIMULATED BACKEND API ENDPOINT
            const API_URL = "https://script.google.com/macros/s/AKfycbyWkJxecP-hQE9pchTjojDT1qPCwRtofI7guey8z2DTr_LIOHnmiFxIzeYU2xjiR_qb/exec";

            // =========================================================================
            // === APPLICATION STATE MACHINE (CENTRAL NERVOUS SYSTEM) ===
            // =========================================================================
            const AppState = { 
                isAuthenticated: false,
                referralInfo: null, // { id, partnerName }
                currentView: 'auth', // 'auth', 'dashboard', 'new_tx_type', 'tx_wizard', 'tx_tracker'
                
                // Active transaction object, reflecting the Kinesis workflow
                transaction: null, // Holds the state of a single end-to-end transaction
                
                // Live market data and user-specific data
                marketData: {
                    marketMatrix: [], // Live asset prices vs USD
                    contacts: [ // Mocked contact list
                        { id: 'ben_reyes_ph', name: 'Ben Reyes', entity: 'Personal', country: 'PH', details: 'BPI Account ending 9876' },
                        { id: 'ph_supplier_acme', name: 'ACME Supplies Inc.', entity: 'Corporate', country: 'PH', details: 'BDO Corporate Account' },
                        { id: 'uae_supplier_oil', name: 'Emirates Oil & Gas LLC', entity: 'Corporate', country: 'AE', details: 'FAB Bank, Dubai' }
                    ],
                    availableCurrencies: ['USD', 'CAD', 'SGD', 'HKD', 'GBP', 'AED', 'PHP', 'USDT', 'USDC']
                },
                
                isLoading: false,
                ui: {
                    quoteTimer: null,
                    trackerInterval: null
                }
            };

            // =========================================================================
            // === UTILITY BELT (PERFORMANCE-TUNED HELPERS) ===
            // =========================================================================
            const Utils = {
                createApiRequest: async (action, method = 'POST', params = {}) => {
                    // In a real app, this would be a live fetch. For this pinnacle prototype,
                    // we simulate API calls to demonstrate the full workflow without a live backend.
                    console.log(`[API Request Fired] Action: ${action}`, params);
                    await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 800)); // Simulate network latency

                    switch (action) {
                        case 'validateReferralId':
                            if (params.referralId === 'GECANPARTNER2025') {
                                return { success: true, data: { referralId: 'GECANPARTNER2025', partnerName: 'Pennworth Ventures' }};
                            }
                            throw new Error('Invalid Partner ID. Access Denied.');
                        
                        case 'getMarketMatrixData':
                            // Simulate live, institutional-grade FX data vs USD
                            return { success: true, data: [
                                { baseAsset: 'SGD', quoteAsset: 'USD', price: 0.74005 }, { baseAsset: 'PHP', quoteAsset: 'USD', price: 0.01700 },
                                { baseAsset: 'CAD', quoteAsset: 'USD', price: 0.73150 }, { baseAsset: 'AED', quoteAsset: 'USD', price: 0.27229 },
                                { baseAsset: 'USDT', quoteAsset: 'USD', price: 1.0001 }, { baseAsset: 'USDC', quoteAsset: 'USD', price: 1.0000 },
                                { baseAsset: 'GBP', quoteAsset: 'USD', price: 1.27050 }, { baseAsset: 'HKD', quoteAsset: 'USD', price: 0.12810 },
                                { baseAsset: 'USD', quoteAsset: 'USD', price: 1.00000 },
                            ]};

                        case 'initiateTransaction':
                            // Simulate backend creating a transaction record (EnvelopeID)
                            const envelopeId = `GKN-TX-${Date.now().toString().slice(-6)}`;
                            let fundingDetails;
                            if (params.onRampMethod === 'fiat_paynow') {
                                fundingDetails = {
                                    type: 'PayNow VPA',
                                    label: 'PayNow VPA (Unique)',
                                    value: `gecan.${envelopeId.toLowerCase()}@paynow.sg-bank.com`,
                                    qrValue: `paynow://vpa=${`gecan.${envelopeId.toLowerCase()}@paynow.sg-bank.com`}&amount=${params.sendAmount.toFixed(2)}&currency=SGD`,
                                    instructions: 'Scan the QR code or copy the VPA into your Singapore banking app. Ensure the amount is exactly as stated.'
                                };
                            } else { // crypto
                                fundingDetails = {
                                    type: 'USDT TRC-20',
                                    label: 'USDT (TRC-20) Deposit Address',
                                    value: `T${Math.random().toString(36).substring(2, 35)}`,
                                    qrValue: `tron:T${Math.random().toString(36).substring(2, 35)}?amount=${params.sendAmount.toFixed(2)}`,
                                    instructions: `Send the exact amount of USDT (TRC-20) to this unique, single-use address. Do not send any other asset.`
                                };
                            }
                            return { success: true, data: { envelopeId, fundingDetails }};

                        default:
                            throw new Error(`Unknown API action: ${action}`);
                    }
                },
                showNotification: (message, type = 'info', duration = 4000) => {
                    const toast = document.createElement('div');
                    const colors = { success: 'from-green-500 to-emerald-600', error: 'from-red-500 to-rose-600', info: 'from-sky-500 to-blue-600', warning: 'from-amber-500 to-orange-600' };
                    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
                    toast.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[200] text-white font-medium bg-gradient-to-br ${colors[type]} transform translate-x-full transition-all duration-500 ease-out`;
                    toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icons[type]} text-lg"></i><span>${message}</span></div>`;
                    document.body.appendChild(toast);
                    requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
                    setTimeout(() => { toast.style.transform = 'translateX(120%)'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, duration);
                },
                formatCurrency: (amount, currency = 'USD', decimals = 2) => {
                    if (isNaN(parseFloat(amount)) || amount === null) return '...';
                    const maxDecimals = currency === 'USDT' || currency === 'USDC' ? 4 : decimals;
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: decimals, maximumFractionDigits: maxDecimals }).format(amount);
                },
                openModal: (content) => {
                    const overlay = document.getElementById('modal-overlay');
                    const wrapper = document.getElementById('modal-content-wrapper');
                    wrapper.innerHTML = content;
                    overlay.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        overlay.classList.remove('opacity-0');
                        wrapper.classList.remove('scale-95', 'opacity-0');
                    });
                    document.getElementById('modal-close-btn')?.addEventListener('click', Utils.closeModal);
                },
                closeModal: () => {
                    const overlay = document.getElementById('modal-overlay');
                    const wrapper = document.getElementById('modal-content-wrapper');
                    overlay.classList.add('opacity-0');
                    wrapper.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        wrapper.innerHTML = '';
                    }, 400);
                },
                debounce: (func, delay) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                }
            };
            
            // =========================================================================
            // === UI & COMPONENT ENGINE (PINNACLE-GRADE RENDERERS) ===
            // =========================================================================
            const UI = {
                init: () => {

                    // --- FIX ---
                    // Re-initialize the Pinnacle-Grade Particle Background
                    if (typeof particlesJS !== 'undefined') { 
                        particlesJS('interactive-background', {
                            "particles": {
                                "number": { "value": 60, "density": { "enable": true, "value_area": 800 } },
                                "color": { "value": "#b4975a" },
                                "shape": { "type": "circle" },
                                "opacity": { "value": 0.4, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1, "sync": false } },
                                "size": { "value": 2, "random": true },
                                "line_linked": { "enable": true, "distance": 150, "color": "#64748b", "opacity": 0.1, "width": 1 },
                                "move": { "enable": true, "speed": 0.8, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false }
                            },
                            "interactivity": {
                                "detect_on": "canvas",
                                "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": false }, "resize": true }
                            },
                            "retina_detect": true
                        });
                    }
                    // --- END FIX ---
                    UI.populateNavLinks();
                    Logic.checkForAutoAuth();
                },
                populateNavLinks: () => {
                    const navContainer = document.getElementById('nav-container');
                    if (!navContainer) return;
                    const links = [
                        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow' },
                        { page: 'about', icon: 'fas fa-landmark', text: 'The Alliance' },
                        { page: 'toolkits', icon: 'fas fa-tools', text: 'Toolkits' },
                        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect' },
                        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Intelligence' },
                    ];
                    const moreLinks = [
                        { page: 'nexus', icon: 'fas fa-layer-group', text: 'Capital Nexus' },
                        { page: 'karavan', icon: 'fas fa-gem', text: 'Karavan' },
                        { page: 'privacy', icon: 'fas fa-user-secret', text: 'Privacy Policy' },
                        { page: 'terms', icon: 'fas fa-gavel', text: 'Terms & Conditions' }
                    ];

                    let navHtml = links.map(link => `<a href="./${link.page}.html" class="nav-btn"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div><div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div></div></div><span class="nav-text">${link.text}</span></a>`).join('');

                    navHtml += `
                        <div class="relative group">
                            <button class="nav-btn ${window.location.pathname.includes('karavan') ? 'active' : ''}"><i class="fas fa-ellipsis-h"></i></button>
                            <div class="absolute top-full right-0 mt-2 w-56 bg-background-secondary border border-border-accent rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform group-hover:translate-y-0 translate-y-2 z-50">
                                ${moreLinks.map(link => `<a href="./${link.page}.html" class="flex items-center gap-3 px-4 py-3 text-sm transition-colors ${window.location.pathname.includes(link.page) ? 'text-white bg-primary-azure' : 'text-text-secondary hover:bg-primary-azure/50 hover:text-white'}">${link.icon ? `<i class="fas ${link.icon} fa-fw w-5"></i>` : ''}<span>${link.text}</span></a>`).join('')}
                            </div>
                        </div>`;
                    navContainer.innerHTML = navHtml;
                },
                renderView: (viewName, options = {}) => {
                    const mainContent = document.getElementById('main-content');
                    if (!mainContent) return;
                    AppState.currentView = viewName;
                    
                    let html = '';
                    switch(viewName) {
                        case 'auth': html = ComponentBuilders.renderAuthGate(); break;
                        case 'dashboard': html = ComponentBuilders.renderDashboard(); break;
                        case 'new_tx_type': html = ComponentBuilders.renderTxTypeSelector(); break;
                        case 'tx_wizard': html = ComponentBuilders.renderTransactionWizard(); break;
                        case 'tx_tracker': html = ComponentBuilders.renderTransactionTracker(); break;
                        case 'loading': html = ComponentBuilders.renderLoadingScreen(options.message || "Please wait..."); break;
                    }
                    mainContent.innerHTML = html;
                    Logic.bindEventListenersForView(viewName);
                },
                updateDispatchQuote: () => {
                    const quoteContainer = document.getElementById('quote-container');
                    if (!quoteContainer) return;
                    
                    const tx = AppState.transaction;
                    if (!tx || !tx.quote || new Date() > tx.quote.expiresAt) {
                        quoteContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-text-muted italic p-4 text-center"><i class="fas fa-calculator fa-2x mb-4"></i><span>Enter an amount to get a live, institutional-grade quote.</span></div>`;
                        const nextBtn = document.getElementById('wizard-next-btn');
                        if (nextBtn) nextBtn.disabled = true;
                        return;
                    }
                    
                    const { quote, details } = tx;
                    quoteContainer.innerHTML = `
                        <div class="p-4 h-full flex flex-col bg-background-dark rounded-xl shadow-inner-premium border border-border-secondary relative overflow-hidden">
                            <h4 class="text-sm font-bold text-text-secondary mb-3 text-center uppercase tracking-wider">Pinnacle Quote Analysis</h4>
                            <div class="space-y-3 flex-grow text-sm">
                                <div class="flex justify-between items-baseline"><span class="text-text-muted">You Send</span><strong class="font-mono text-xl text-primary-azure">${Utils.formatCurrency(quote.sendAmount, details.fromCurrency)}</strong></div>
                                <div class="flex justify-between items-baseline"><span class="text-text-muted">GECAN™ Fee (${quote.feePercentage}%)</span><strong class="font-mono text-warning-color">- ${Utils.formatCurrency(quote.feeAmount, details.fromCurrency)}</strong></div>
                                <div class="flex justify-between items-baseline"><span class="text-text-muted">Amount to Convert</span><strong class="font-mono text-text-platinum">${Utils.formatCurrency(quote.netSendAmount, details.fromCurrency)}</strong></div>
                                <div class="border-t border-border-secondary my-2"></div>
                                <div class="flex justify-between items-baseline"><span class="text-text-muted">Institutional Rate</span><strong class="font-mono text-text-platinum">1 ${details.fromCurrency} ≈ ${quote.rate.toFixed(5)} ${details.toCurrency}</strong></div>
                                <div class="border-t border-border-secondary my-2"></div>
                                <div class="flex justify-between items-center"><span class="font-semibold text-text-primary">Recipient Receives</span><strong class="text-2xl font-bold text-success-color">${Utils.formatCurrency(quote.receiveAmount, details.toCurrency)}</strong></div>
                            </div>
                            <div class="text-center text-xs text-text-muted mt-3">This guaranteed rate is locked for <span id="quote-countdown">30</span> seconds.</div>
                            <div id="quote-timer-bar" class="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-brand-gecan-gold to-warning-color" style="width: 100%;"></div>
                        </div>`;

                    Logic.startQuoteTimer();
                    const nextBtn = document.getElementById('wizard-next-btn');
                    if (nextBtn) nextBtn.disabled = false;
                }
            };
            
            // =========================================================================
            // === COMPONENT BUILDER LIBRARY (DYNAMIC HTML GENERATORS) ===
            // =========================================================================
            const ComponentBuilders = {
                renderAuthGate: () => `
                    <div id="referral-gate" class="glass-pane rounded-2xl p-6 md:p-10 max-w-lg mx-auto shadow-2xl fade-in-up text-center">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-brand-gecan-gold/10 to-brand-gecan-gold/0 border-2 border-brand-gecan-gold/50 flex items-center justify-center mb-6 shadow-gold-glow animate-vortex-pulse"><i class="fas fa-gem text-5xl text-brand-gecan-gold" style="text-shadow: 0 0 15px var(--glow-gold);"></i></div>
                        <h2 class="text-3xl font-bold text-white mb-2 font-mono">GECAN™ <span class="text-premium-gold">KARAVAN</span></h2>
                        <p class="text-text-secondary mb-8">Please authenticate with your Partner ID to access the Global Settlement Layer.</p>
                        <div class="space-y-4">
                            <input type="password" id="referral-id-input" placeholder="Enter Partner ID" class="form-input p-3 text-lg font-mono tracking-wider text-center">
                            <button id="validate-id-btn" class="btn-gold font-bold py-3 px-6 rounded-xl w-full disabled:opacity-50">Authenticate</button>
                        </div>
                        <p id="referral-error" class="text-sm text-error-color mt-3 h-5"></p>
                    </div>`,
                renderDashboard: () => `
                    <div class="fade-in-up text-center">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Welcome, ${AppState.referralInfo.partnerName}</h2>
                        <p class="text-text-secondary mb-10 max-w-3xl mx-auto">You are connected to the GECAN™ Global Settlement Layer.</p>
                        <div class="max-w-md mx-auto">
                            <button id="new-transaction-btn" class="w-full btn-gold font-bold py-4 px-10 rounded-xl text-lg shadow-gold-glow transform hover:scale-105 transition-transform duration-300">
                                <i class="fas fa-paper-plane mr-3"></i>Initiate New Karavan
                            </button>
                        </div>
                        <div class="mt-12">
                            <h3 class="text-xl font-semibold text-text-platinum mb-4">Recent Activity</h3>
                            <div class="glass-pane rounded-xl p-6 text-left max-w-4xl mx-auto">
                                <p class="text-text-muted text-center">No recent Karavan activity found.</p>
                                <!-- Transaction history would be rendered here -->
                            </div>
                        </div>
                    </div>`,
                renderLoadingScreen: (message) => `
                    <div class="text-center py-20 fade-in-up flex flex-col items-center justify-center">
                        <div class="relative w-16 h-16"><i class="fas fa-spinner fa-spin text-4xl text-primary-azure drop-shadow-[0_0_15px_rgba(14,165,233,0.5)]"></i><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div>
                        <p class="mt-6 text-xl font-medium text-text-secondary">${message}</p>
                    </div>`,
                renderTxTypeSelector: () => `
                    <div class="text-center fade-in-up max-w-4xl mx-auto">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Select Transaction Type</h2>
                        <p class="text-text-secondary mb-10">Choose the workflow that best suits your settlement objective.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div id="tx-type-remit" class="role-selector-card p-8 rounded-2xl cursor-pointer">
                                <div class="icon-wrapper w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-primary-azure to-primary-royal flex items-center justify-center mb-4 shadow-lg shadow-azure-glow/20"><i class="fas fa-wallet fa-2x text-white"></i></div>
                                <h3 class="text-2xl font-bold text-white">GECAN™ Remit</h3>
                                <p class="text-text-secondary mt-2">For retail remittances and personal transfers. Simplified, high-speed, low-cost.</p>
                            </div>
                            <div id="tx-type-pay" class="role-selector-card p-8 rounded-2xl cursor-pointer">
                                <div class="icon-wrapper w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-brand-gecan-gold to-warning-color flex items-center justify-center mb-4 shadow-lg shadow-gold-glow/40"><i class="fas fa-file-invoice-dollar fa-2x text-background-dark"></i></div>
                                <h3 class="text-2xl font-bold text-white">GECAN™ Pay</h3>
                                <p class="text-text-secondary mt-2">For B2B payments and institutional settlements. Invoice-driven and compliance-focused.</p>
                            </div>
                        </div>
                    </div>`,
                renderTransactionWizard: () => {
                    const tx = AppState.transaction;
                    const isRemit = tx.type === 'remit';
                    const currencyOptions = (selected) => AppState.marketData.availableCurrencies.map(c => `<option value="${c}" ${c === selected ? 'selected': ''}>${c}</option>`).join('');
                    const contactOptions = (selected) => AppState.marketData.contacts.map(c => `<option value="${c.id}" ${c.id === selected ? 'selected' : ''}>${c.name} (${c.entity})</option>`).join('');

                    return `
                    <div class="max-w-5xl mx-auto fade-in-up">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">${isRemit ? 'New Remittance' : 'New B2B Payment'}</h2>
                            <p class="text-text-secondary max-w-3xl mx-auto">${isRemit ? 'A guided process for secure, personal fund transfers.' : 'A guided process for invoice settlement and institutional value transfer.'}</p>
                        </div>
                        <div class="glass-pane rounded-2xl shadow-2xl p-6 md:p-8">
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                                <!-- Input Panel -->
                                <div class="lg:col-span-3 space-y-6">
                                    <div>
                                        <label class="text-sm font-medium text-text-secondary block mb-2">Beneficiary</label>
                                        <select id="recipient-select" class="form-select">${contactOptions(tx.details.recipientId)}</select>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm font-medium text-text-secondary block mb-2">You Send</label>
                                            <div class="flex">
                                                <input type="number" id="send-amount" class="form-input rounded-r-none" value="${tx.details.amount || ''}">
                                                <select id="send-currency" class="form-select rounded-l-none w-32">${currencyOptions(tx.details.fromCurrency)}</select>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-text-secondary block mb-2">Recipient Receives</label>
                                             <div class="flex">
                                                <input type="number" id="receive-amount" class="form-input rounded-r-none" placeholder="0.00">
                                                <select id="receive-currency" class="form-select rounded-l-none w-32">${currencyOptions(tx.details.toCurrency)}</select>
                                            </div>
                                        </div>
                                    </div>
                                    ${!isRemit ? `
                                    <div>
                                        <label class="text-sm font-medium text-text-secondary block mb-2">Invoice Reference & Document</label>
                                        <div class="flex gap-4">
                                            <input type="text" id="invoice-ref" placeholder="e.g., INV-2025-08-24" class="form-input flex-grow" value="${tx.details.invoiceRef || ''}">
                                            <button class="btn-secondary px-4 whitespace-nowrap"><i class="fas fa-upload mr-2"></i>Upload PDF</button>
                                        </div>
                                    </div>` : ''}
                                     <div>
                                        <label class="text-sm font-medium text-text-secondary block mb-2">On-Ramp Method (How you will pay)</label>
                                        <select id="onramp-method-select" class="form-select">
                                            <option value="fiat_paynow">Fiat via PayNow (Singapore)</option>
                                            <option value="crypto_usdt">Crypto via USDT (TRC-20)</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Analysis Panel -->
                                <div id="quote-container" class="lg:col-span-2">
                                    <!-- Quote will be rendered here by UI.updateDispatchQuote -->
                                </div>
                            </div>
                            <div class="mt-12 flex justify-between items-center">
                                <button class="btn-secondary py-3 px-8 rounded-lg" onclick="Logic.cancelTransaction()"><i class="fas fa-times mr-2"></i>Cancel</button>
                                <button id="wizard-next-btn" class="btn-gold font-bold py-3 px-10 rounded-lg text-lg" onclick="Logic.confirmAndFund()" disabled>Confirm & Proceed to Funding <i class="fas fa-arrow-right ml-2"></i></button>
                            </div>
                        </div>
                    </div>`;
                },
                renderFundingModal: () => {
                    const { envelopeId, fundingDetails } = AppState.transaction;
                    return `
                        <div class="p-8 relative">
                            <button id="modal-close-btn" class="absolute top-4 right-4 text-text-muted hover:text-white transition-colors"><i class="fas fa-times fa-lg"></i></button>
                            <div class="text-center">
                                <h3 class="text-2xl font-bold text-white mb-2">Proceed with Funding</h3>
                                <p class="text-text-secondary mb-6">Your transaction <strong class="font-mono text-premium-gold">${envelopeId}</strong> is ready for funding.</p>
                            </div>
                            <div class="bg-background-dark p-6 rounded-xl border border-border-secondary text-center space-y-4">
                                <p class="text-text-muted">${fundingDetails.instructions}</p>
                                <div class="text-center">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(fundingDetails.qrValue)}" alt="QR Code" class="mx-auto rounded-lg border-4 border-white shadow-lg">
                                </div>
                                <div>
                                    <label class="text-sm font-semibold text-text-secondary">${fundingDetails.label}</label>
                                    <div class="mt-1 flex items-center justify-center bg-background-primary p-3 rounded-lg border border-border-color">
                                        <span class="font-mono text-text-platinum break-all">${fundingDetails.value}</span>
                                        <button class="ml-4 text-primary-azure hover:text-white" onclick="navigator.clipboard.writeText('${fundingDetails.value}'); Utils.showNotification('Copied to clipboard!', 'success');"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 text-center">
                                <p class="text-sm text-text-muted">Once payment is sent, we will automatically detect it and proceed. This window can be closed.</p>
                            </div>
                        </div>`;
                },
                renderTransactionTracker: () => {
                    const { type, envelopeId, details, quote, status, statusHistory } = AppState.transaction;
                    
                    const getStatusIcon = (s) => {
                        if (s.completed) return '<i class="fas fa-check-circle text-success-color"></i>';
                        if (s.active) return '<i class="fas fa-spinner fa-spin text-primary-azure"></i>';
                        return '<i class="far fa-circle text-text-muted"></i>';
                    };
                    
                    const getStatusClass = (s) => {
                        if (s.completed) return 'text-text-platinum';
                        if (s.active) return 'font-bold text-white';
                        return 'text-text-muted';
                    };

                    const steps = [
                        { name: "Initiated", state: statusHistory.initiated },
                        { name: "Awaiting Payment", state: statusHistory.funding },
                        { name: "Compliance Firewall", state: statusHistory.compliance },
                        { name: "Settlement in Progress", state: statusHistory.settling },
                        { name: "Completed", state: statusHistory.complete },
                    ];

                    return `
                    <div class="max-w-4xl mx-auto fade-in-up">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Karavan Tracker</h2>
                            <p class="text-text-secondary">Live status for Envelope ID: <strong class="font-mono text-premium-gold">${envelopeId}</strong></p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Status -->
                            <div class="lg:col-span-1 glass-pane p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4 text-white">Live Status</h3>
                                <ul class="space-y-4">
                                    ${steps.map((step, index) => `
                                        <li class="flex items-center gap-4 ${getStatusClass(step.state)}">
                                            <div class="w-6 h-6 flex items-center justify-center text-lg">${getStatusIcon(step.state)}</div>
                                            <span>${step.name}</span>
                                            ${index < steps.length - 1 ? '<div class="absolute left-3 top-7 h-5 w-px bg-border-accent"></div>' : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <!-- Details -->
                            <div class="lg:col-span-2 glass-pane p-6 rounded-2xl">
                                <h3 class="font-bold text-lg mb-4 text-white">Transaction Summary</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span class="text-text-muted">You Sent</span><strong class="font-mono text-primary-azure">${Utils.formatCurrency(quote.sendAmount, details.fromCurrency)}</strong></div>
                                    <div class="flex justify-between"><span class="text-text-muted">Recipient Received</span><strong class="font-mono text-success-color">${Utils.formatCurrency(quote.receiveAmount, details.toCurrency)}</strong></div>
                                    <div class="border-t border-border-color my-3"></div>
                                    <div class="flex justify-between"><span class="text-text-muted">Beneficiary</span><strong class="text-right">${details.recipient.name}</strong></div>
                                    <div class="flex justify-between"><span class="text-text-muted">Destination</span><strong>${details.recipient.country}</strong></div>
                                    ${type === 'pay' ? `<div class="flex justify-between"><span class="text-text-muted">Invoice Ref</span><strong class="font-mono">${details.invoiceRef}</strong></div>` : ''}
                                </div>
                                ${status === 'complete' ? `
                                <div class="mt-8 text-center">
                                    <button class="btn-gold font-bold py-3 px-8 rounded-lg"><i class="fas fa-file-download mr-2"></i>Download Proof of Settlement</button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                         <div class="mt-8 text-center">
                            <button class="btn-secondary py-2 px-6 rounded-lg" onclick="UI.renderView('dashboard')"><i class="fas fa-tachometer-alt mr-2"></i>Return to Dashboard</button>
                        </div>
                    </div>`;
                }
            };

            // =========================================================================
            // === LOGIC & WORKFLOW ENGINE (PROJECT KINESIS IMPLEMENTATION) ===
            // =========================================================================
            const Logic = {
                init: () => {
                    UI.init();
                },
                checkForAutoAuth: async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const referralId = urlParams.get('referralId');
                    if (referralId) {
                        const input = document.getElementById('referral-id-input');
                        if (input) input.value = referralId;
                        await Logic.validateReferralId();
                    } else {
                         UI.renderView('auth');
                    }
                },
                validateReferralId: async () => {
                    const btn = document.getElementById('validate-id-btn');
                    const input = document.getElementById('referral-id-input');
                    const errorEl = document.getElementById('referral-error');
                    if (!btn || !input || !errorEl) return;

                    const referralId = input.value.trim().toUpperCase();
                    if (!referralId) { errorEl.textContent = 'Partner ID cannot be empty.'; return; }
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
                    errorEl.textContent = '';
                    
                    try {
                        const { data } = await Utils.createApiRequest('validateReferralId', 'POST', { referralId });
                        AppState.isAuthenticated = true;
                        AppState.referralInfo = { id: data.referralId, partnerName: data.partnerName };
                        Utils.showNotification(`Authentication Successful. Welcome, ${data.partnerName}.`, 'success');
                        
                        UI.renderView('loading', { message: 'Fetching Market Data...' });
                        const marketDataResponse = await Utils.createApiRequest('getMarketMatrixData', 'GET');
                        AppState.marketData.marketMatrix = marketDataResponse.data;
                        
                        UI.renderView('dashboard');
                    } catch (error) {
                        errorEl.textContent = error.message;
                        btn.disabled = false;
                        btn.innerHTML = 'Authenticate';
                    }
                },
                startNewTransaction: () => {
                    UI.renderView('new_tx_type');
                },
                selectTransactionType: (type) => {
                    AppState.transaction = {
                        type, // 'remit' or 'pay'
                        envelopeId: null,
                        status: 'draft', // draft -> funding -> compliance -> settling -> complete
                        statusHistory: {
                            initiated: { active: false, completed: false },
                            funding: { active: false, completed: false },
                            compliance: { active: false, completed: false },
                            settling: { active: false, completed: false },
                            complete: { active: false, completed: false },
                        },
                        details: {
                            recipientId: AppState.marketData.contacts[0].id,
                            fromCurrency: 'SGD',
                            toCurrency: 'PHP',
                            amount: type === 'remit' ? 500 : 10000,
                            amountType: 'send', // 'send' or 'receive'
                            invoiceRef: '',
                            onRampMethod: 'fiat_paynow',
                        },
                        quote: null,
                        fundingDetails: null
                    };
                    UI.renderView('tx_wizard');
                    Logic.getLiveQuote();
                },
                cancelTransaction: () => {
                    AppState.transaction = null;
                    if(AppState.ui.trackerInterval) clearInterval(AppState.ui.trackerInterval);
                    Utils.showNotification('Transaction Cancelled', 'info');
                    UI.renderView('dashboard');
                },
                updateTransactionDetails: () => {
                    if (!AppState.transaction) return;
                    const tx = AppState.transaction;

                    tx.details.recipientId = document.getElementById('recipient-select')?.value || tx.details.recipientId;
                    tx.details.fromCurrency = document.getElementById('send-currency')?.value || tx.details.fromCurrency;
                    tx.details.toCurrency = document.getElementById('receive-currency')?.value || tx.details.toCurrency;
                    tx.details.invoiceRef = document.getElementById('invoice-ref')?.value || tx.details.invoiceRef;
                    tx.details.onRampMethod = document.getElementById('onramp-method-select')?.value || tx.details.onRampMethod;
                    
                    Logic.getLiveQuote();
                },
                getLiveQuote: async () => {
                    if (!AppState.transaction) return;
                    const { details } = AppState.transaction;
                    const sendAmountEl = document.getElementById('send-amount');
                    const receiveAmountEl = document.getElementById('receive-amount');
                    
                    const amount = parseFloat(details.amountType === 'send' ? sendAmountEl.value : receiveAmountEl.value) || 0;
                    details.amount = amount;

                    if (amount <= 0 || details.fromCurrency === details.toCurrency) {
                        AppState.transaction.quote = null;
                        if(details.amountType === 'send') receiveAmountEl.value = ''; else sendAmountEl.value = '';
                        UI.updateDispatchQuote();
                        return;
                    }
                    
                    try {
                        const fromAsset = AppState.marketData.marketMatrix.find(a => a.baseAsset === details.fromCurrency);
                        const toAsset = AppState.marketData.marketMatrix.find(a => a.baseAsset === details.toCurrency);
                        if (!fromAsset || !toAsset) throw new Error(`Pricing for ${details.fromCurrency}/${details.toCurrency} is unavailable.`);

                        const institutionalRate = fromAsset.price / toAsset.price;
                        
                        // Dynamic Fee from Project Kinesis Business Model
                        const getFeePercentage = () => {
                            const valueUSD = (details.amountType === 'send' ? amount : amount / institutionalRate) * fromAsset.price;
                            if (AppState.transaction.type === 'remit') return 0.60; // Flat 0.6% for Remit
                            if (valueUSD > 1000000) return 0.15;
                            if (valueUSD > 100000) return 0.25;
                            return 0.35; // B2B Pay default tier
                        };
                        const feePercentage = getFeePercentage();

                        let sendAmount, receiveAmount, feeAmount, netSendAmount;
                        if (details.amountType === 'send') {
                            sendAmount = amount;
                            feeAmount = sendAmount * (feePercentage / 100);
                            netSendAmount = sendAmount - feeAmount;
                            receiveAmount = netSendAmount * institutionalRate;
                            receiveAmountEl.value = receiveAmount.toFixed(2);
                        } else { // receive
                            receiveAmount = amount;
                            netSendAmount = receiveAmount / institutionalRate;
                            sendAmount = netSendAmount / (1 - (feePercentage / 100));
                            feeAmount = sendAmount - netSendAmount;
                            sendAmountEl.value = sendAmount.toFixed(2);
                        }

                        AppState.transaction.quote = {
                            rate: institutionalRate,
                            feePercentage: feePercentage.toFixed(2),
                            feeAmount: feeAmount,
                            sendAmount: sendAmount,
                            netSendAmount: netSendAmount,
                            receiveAmount: receiveAmount,
                            expiresAt: new Date(Date.now() + 30000)
                        };

                        UI.updateDispatchQuote();
                    } catch (error) {
                        Utils.showNotification(error.message, 'error');
                        AppState.transaction.quote = null;
                        UI.updateDispatchQuote();
                    }
                },
                startQuoteTimer: () => {
                    if (AppState.ui.quoteTimer) clearInterval(AppState.ui.quoteTimer);
                    const timerBar = document.getElementById('quote-timer-bar');
                    const countdownEl = document.getElementById('quote-countdown');
                    if (!timerBar || !countdownEl) return;

                    const duration = 30000;
                    let remaining = duration;

                    AppState.ui.quoteTimer = setInterval(() => {
                        remaining -= 100;
                        const width = Math.max(0, (remaining / duration) * 100);
                        timerBar.style.width = `${width}%`;
                        countdownEl.textContent = Math.ceil(remaining / 1000);

                        if (width <= 0) {
                            clearInterval(AppState.ui.quoteTimer);
                            AppState.transaction.quote = null;
                            UI.updateDispatchQuote();
                            Utils.showNotification('Quote expired due to market volatility. Please recalculate.', 'warning');
                        }
                    }, 100);
                },
                confirmAndFund: async () => {
                    const tx = AppState.transaction;
                    if (!tx || !tx.quote) {
                        Utils.showNotification('Please generate a valid quote first.', 'error');
                        return;
                    }
                    
                    UI.renderView('loading', { message: 'Initiating Secure Envelope...' });
                    try {
                        const { data } = await Utils.createApiRequest('initiateTransaction', 'POST', {
                            type: tx.type,
                            fromCurrency: tx.details.fromCurrency,
                            toCurrency: tx.details.toCurrency,
                            sendAmount: tx.quote.sendAmount,
                            receiveAmount: tx.quote.receiveAmount,
                            onRampMethod: tx.details.onRampMethod
                        });
                        
                        tx.envelopeId = data.envelopeId;
                        tx.fundingDetails = data.fundingDetails;
                        tx.status = 'funding';
                        tx.details.recipient = AppState.marketData.contacts.find(c => c.id === tx.details.recipientId);

                        Logic.updateStatus('initiated', true);
                        Logic.updateStatus('funding', false, true);
                        
                        Utils.openModal(ComponentBuilders.renderFundingModal());
                        UI.renderView('tx_tracker');
                        Logic.startTransactionTracker();

                    } catch(error) {
                        Utils.showNotification(`Error initiating transaction: ${error.message}`, 'error');
                        UI.renderView('tx_wizard');
                    }
                },
                updateStatus: (statusKey, completed, active = false) => {
                    const tx = AppState.transaction;
                    if (tx && tx.statusHistory[statusKey]) {
                        tx.statusHistory[statusKey].completed = completed;
                        tx.statusHistory[statusKey].active = active;
                    }
                },
                startTransactionTracker: () => {
                    if (AppState.ui.trackerInterval) clearInterval(AppState.ui.trackerInterval);

                    const tx = AppState.transaction;
                    const sequence = ['funding', 'compliance', 'settling', 'complete'];
                    let currentStepIndex = 0;

                    AppState.ui.trackerInterval = setInterval(() => {
                        const currentStep = sequence[currentStepIndex];
                        Logic.updateStatus(currentStep, true, false);

                        currentStepIndex++;
                        if (currentStepIndex >= sequence.length) {
                            clearInterval(AppState.ui.trackerInterval);
                            tx.status = 'complete';
                            Utils.showNotification(`Karavan ${tx.envelopeId} Completed!`, 'success');
                            UI.renderView('tx_tracker');
                            return;
                        }

                        const nextStep = sequence[currentStepIndex];
                        tx.status = nextStep;
                        Logic.updateStatus(nextStep, false, true);
                        
                        UI.renderView('tx_tracker'); // Re-render to show progress
                    }, 4000); // Simulate each step taking 4 seconds
                },
                bindEventListenersForView: (view) => {
                    if (view === 'auth') {
                        document.getElementById('validate-id-btn')?.addEventListener('click', Logic.validateReferralId);
                        document.getElementById('referral-id-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') Logic.validateReferralId(); });
                    }
                    if (view === 'dashboard') {
                        document.getElementById('new-transaction-btn')?.addEventListener('click', Logic.startNewTransaction);
                    }
                    if (view === 'new_tx_type') {
                        document.getElementById('tx-type-remit')?.addEventListener('click', () => Logic.selectTransactionType('remit'));
                        document.getElementById('tx-type-pay')?.addEventListener('click', () => Logic.selectTransactionType('pay'));
                    }
                    if (view === 'tx_wizard') {
                        const debouncedQuote = Utils.debounce(Logic.getLiveQuote, 500);
                        const sendAmountEl = document.getElementById('send-amount');
                        const receiveAmountEl = document.getElementById('receive-amount');

                        sendAmountEl?.addEventListener('input', () => { AppState.transaction.details.amountType = 'send'; receiveAmountEl.value = ''; debouncedQuote(); });
                        receiveAmountEl?.addEventListener('input', () => { AppState.transaction.details.amountType = 'receive'; sendAmountEl.value = ''; debouncedQuote(); });

                        ['recipient-select', 'send-currency', 'receive-currency', 'invoice-ref', 'onramp-method-select'].forEach(id => {
                            document.getElementById(id)?.addEventListener('change', Logic.updateTransactionDetails);
                        });
                    }
                }
            };
            
            // =========================================================================
            // === APPLICATION ENTRY POINT ===
            // =========================================================================
            document.addEventListener('DOMContentLoaded', () => {
                // Expose core modules to window for debugging if needed
                window.GECAN = { Logic, UI, Utils, ComponentBuilders, AppState };
                Logic.init();
            });
        })();
    </script>
</body>
</html>
