<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMywyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
    
    <base target="_top">
    <title>GECAN™ Karavan | Global Settlement Layer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GECAN™ Karavan - Pinnacle-grade global settlement layer for cross-border payments and remittances">
    
    <!-- PERFORMANCE-OPTIMIZED EXTERNAL RESOURCES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PREMIUM FONT LOADING -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <!-- TAILWIND CONFIG -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                },
                extend: {
                    boxShadow: {
                        'premium': '0 25px 50px -12px rgba(0, 0, 0, 0.8)',
                        'quantum': '0 35px 60px -12px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1)',
                        'gold-glow': '0 0 30px rgba(180, 151, 90, 0.6), 0 0 60px rgba(234, 179, 8, 0.3)',
                        'azure-glow': '0 0 25px rgba(14, 165, 233, 0.5)',
                    },
                    keyframes: {
                        'vortex-spin': { to: { transform: 'rotate(360deg)' } },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        'glow-pulse': {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(180, 151, 90, 0.4)' },
                            '50%': { boxShadow: '0 0 40px rgba(180, 151, 90, 0.8)' }
                        },
                        'slide-in': {
                            'from': { opacity: '0', transform: 'translateY(30px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        }
                    },
                    animation: {
                        'vortex-spin': 'vortex-spin 20s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow-pulse': 'glow-pulse 2s ease-in-out infinite',
                        'slide-in': 'slide-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    }
                }
            }
        }
    </script>

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE - KARAVAN SUPREME EDITION === */
        /* ========================================================================= */
        
        :root {
            --text-premium-gold: #EAE0C8;
            --brand-gecan-blue: #1c2e4a; 
            --brand-gecan-gold: #b4975a; 
            --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; 
            --primary-royal: #6366f1; 
            --primary-amethyst: #8b5cf6;
            --background-primary: #0a0a0f; 
            --background-secondary: #1e293b; 
            --background-light: #0f172a; 
            --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); 
            --background-glass-premium: rgba(15, 23, 42, 0.95);
            --border-color: rgba(148, 163, 184, 0.2); 
            --border-secondary: rgba(148, 163, 184, 0.25);
            --border-premium: rgba(148, 163, 184, 0.4); 
            --text-diamond: #f8fafc; 
            --text-platinum: #e2e8f0; 
            --text-silver: #cbd5e1;
            --text-muted: #94a3b8; 
            --success-color: #22c55e; 
            --warning-color: #f59e0b; 
            --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --gradient-gold: linear-gradient(135deg, #fde047, #b4975a, #eab308);
            --transform-3d: perspective(1000px) translateY(-10px) rotateX(5deg) scale(1.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%);
            color: var(--text-diamond); 
            min-height: 100vh; 
            overflow-x: hidden; 
            position: relative;
        }

        /* INTERACTIVE BACKGROUND */
        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .vortex-background { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            width: 400px; 
            height: 400px; 
            margin: -200px 0 0 -200px; 
            background: conic-gradient(from 0deg, transparent, rgba(180, 151, 90, 0.1), rgba(99, 102, 241, 0.15), transparent); 
            border-radius: 50%; 
            animation: vortex-spin 20s linear infinite;
            z-index: -1;
        }

        /* PREMIUM HEADER */
        .premium-header { 
            position: sticky; 
            top: 0; 
            z-index: 50; 
            background: var(--background-glass-premium); 
            backdrop-filter: blur(30px) saturate(180%); 
            border-bottom: 1px solid var(--border-premium); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .gecan-logo { 
            font-family: 'Orbitron', monospace; 
            font-weight: 900; 
            font-size: 2.5rem; 
            background: var(--gradient-primary); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 0 40px var(--primary-azure);
        }

        /* SUPREME INTERACTIVE COMPONENTS */
        .auth-container { 
            min-height: 80vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
        }

        .auth-modal { 
            background: var(--background-glass-premium); 
            backdrop-filter: blur(40px); 
            border: 2px solid var(--border-premium); 
            border-radius: 24px; 
            padding: 3rem; 
            max-width: 500px; 
            width: 100%; 
            box-shadow: var(--quantum); 
            position: relative; 
            overflow: hidden;
        }

        .auth-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(180, 151, 90, 0.8), transparent);
        }

        .form-input { 
            background: rgba(15, 23, 42, 0.9); 
            border: 2px solid var(--border-secondary); 
            color: var(--text-diamond); 
            border-radius: 16px; 
            padding: 1rem 1.5rem; 
            width: 100%; 
            font-size: 1rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .form-input:focus { 
            outline: none; 
            border-color: var(--brand-gecan-gold); 
            box-shadow: 0 0 0 4px rgba(180, 151, 90, 0.2), inset 0 2px 8px rgba(0,0,0,0.5); 
            transform: translateY(-2px);
        }

        .btn-primary { 
            background: var(--gradient-gold); 
            border: 2px solid var(--brand-gecan-gold); 
            color: var(--background-dark); 
            font-weight: 700; 
            padding: 1rem 2rem; 
            border-radius: 16px; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 8px 25px rgba(180, 151, 90, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .btn-primary:hover:not(:disabled) { 
            transform: var(--transform-3d); 
            box-shadow: 0 15px 40px rgba(180, 151, 90, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3); 
            filter: brightness(1.1);
        }

        .btn-primary:disabled { 
            background: var(--background-secondary); 
            border-color: var(--border-color); 
            color: var(--text-muted); 
            cursor: not-allowed; 
            opacity: 0.5; 
            transform: none; 
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            border: 2px solid var(--border-color);
            color: var(--text-silver);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: var(--border-premium);
            color: var(--text-diamond);
            transform: translateY(-2px);
        }

        /* ROLE SELECTOR CARDS */
        .role-card { 
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8)); 
            border: 2px solid var(--border-color); 
            border-radius: 24px; 
            padding: 2.5rem; 
            cursor: pointer; 
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(20px);
        }

        .role-card:hover { 
            transform: var(--transform-3d); 
            border-color: var(--brand-gecan-gold); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.6), 0 0 40px rgba(180, 151, 90, 0.3); 
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(180, 151, 90, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .role-card:hover::before {
            opacity: 1;
        }

        .role-icon { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2rem; 
            margin: 0 auto 1.5rem; 
            transition: transform 0.4s ease;
        }

        .role-card:hover .role-icon {
            transform: scale(1.1) translateY(-5px);
        }

        /* WIZARD STEPS */
        .wizard-container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }

        .step-card { 
            background: var(--background-glass); 
            border: 2px solid var(--border-color); 
            border-radius: 20px; 
            margin-bottom: 1.5rem; 
            overflow: hidden; 
            transition: all 0.4s ease;
        }

        .step-header { 
            padding: 1.5rem 2rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
            transition: all 0.3s ease;
        }

        .step-header:hover {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));
        }

        .step-number { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .step-completed .step-number { 
            background: var(--gradient-gold); 
            color: var(--background-dark);
            box-shadow: 0 4px 12px rgba(180, 151, 90, 0.4);
        }

        .step-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease; 
            background: rgba(15, 23, 42, 0.4);
        }

        .step-expanded .step-content { 
            max-height: 800px; 
        }

        .step-inner { 
            padding: 2rem; 
        }

        /* HOLO STREAM */
        .holo-stream { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 60px; 
            background: rgba(0, 0, 0, 0.9); 
            border-top: 1px solid var(--border-premium); 
            overflow: hidden; 
            z-index: 40;
            backdrop-filter: blur(20px);
        }

        .holo-track { 
            display: flex; 
            align-items: center; 
            height: 100%; 
            animation: scroll-left 60s linear infinite; 
            gap: 3rem;
        }

        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .holo-item { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            white-space: nowrap; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.9rem;
        }

        /* MODAL SYSTEM */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(8px); 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content { 
            background: var(--background-glass-premium); 
            border: 2px solid var(--border-premium); 
            border-radius: 24px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: var(--quantum);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* QUOTE PANEL */
        .quote-panel { 
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.7)); 
            border: 2px solid var(--border-premium); 
            border-radius: 20px; 
            padding: 2rem; 
            backdrop-filter: blur(20px);
        }

        .quote-timer { 
            width: 100%; 
            height: 4px; 
            background: rgba(148, 163, 184, 0.2); 
            border-radius: 2px; 
            overflow: hidden; 
            margin-bottom: 1rem;
        }

        .quote-progress { 
            height: 100%; 
            background: var(--gradient-gold); 
            transition: width 0.1s linear; 
            border-radius: 2px;
        }

        /* TRANSACTION TRACKER */
        .tracker-timeline { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin: 2rem 0; 
            position: relative;
        }

        .tracker-step { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.5rem; 
            flex: 1; 
            position: relative;
        }

        .tracker-step::after {
            content: '';
            position: absolute;
            top: 24px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: rgba(148, 163, 184, 0.3);
            z-index: -1;
        }

        .tracker-step:last-child::after {
            display: none;
        }

        .tracker-dot { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            background: rgba(148, 163, 184, 0.3); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.25rem; 
            transition: all 0.3s ease;
        }

        .tracker-step.active .tracker-dot { 
            background: var(--gradient-primary); 
            color: white; 
            animation: glow-pulse 2s ease-in-out infinite;
        }

        .tracker-step.completed .tracker-dot { 
            background: var(--gradient-gold); 
            color: var(--background-dark);
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .auth-modal { padding: 2rem; }
            .role-card { padding: 1.5rem; }
            .step-header { padding: 1rem; }
            .step-inner { padding: 1rem; }
            .gecan-logo { font-size: 1.8rem; }
        }

        /* LOADING STATES */
        .loading { position: relative; overflow: hidden; }
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* UTILITY CLASSES */
        .fade-in { animation: slide-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .text-gradient { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .text-gold-gradient { background: var(--gradient-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: var(--background-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .glass-premium { background: var(--background-glass-premium); backdrop-filter: blur(30px); border: 1px solid var(--border-premium); }
    </style>
</head>

<body class="min-h-screen relative">
    <!-- INTERACTIVE BACKGROUND SYSTEM -->
    <div id="particles-js"></div>
    <div class="vortex-background"></div>

    <!-- PREMIUM HEADER -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="gecan-logo">GECAN™</div>
                <div class="h-12 w-px bg-gradient-to-b from-transparent via-primary-azure to-transparent"></div>
                <div>
                    <h1 class="text-xl lg:text-2xl font-bold text-white">Karavan</h1>
                    <p class="text-sm text-text-muted font-mono">Global Settlement Layer</p>
                </div>
            </div>
            
            <nav class="hidden lg:flex items-center gap-4">
                <button class="btn-secondary">
                    <i class="fas fa-chart-line mr-2"></i>
                    Market Data
                </button>
                <button id="support-btn" class="btn-secondary">
                    <i class="fas fa-headset mr-2"></i>
                    Support
                </button>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="main-content" class="container mx-auto p-4 pb-20">
        <!-- Dynamic content will be rendered here -->
    </main>

    <!-- HOLO STREAM MARKET TICKER -->
    <div class="holo-stream">
        <div class="holo-track" id="holo-track">
            <!-- Market data will be populated here -->
        </div>
    </div>

    <!-- MODAL SYSTEM -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content" id="modal-content">
            <!-- Modal content will be rendered here -->
        </div>
    </div>

    <!-- SUPREME JAVASCRIPT ENGINE -->
    <script>
        // ========================================================================
        // === GECAN™ KARAVAN ENGINE - PINNACLE EDITION ===
        // ========================================================================
        
        (function() {
            'use strict';
            
            // API Configuration
            const API_URL = "https://script.google.com/macros/s/AKfycbyWkJxecP-hQE9pchTjojDT1qPCwRtofI7guey8z2DTr_LIOHnmiFxIzeYU2xjiR_qb/exec";
            
            // Application State Machine
            const AppState = {
                isAuthenticated: false,
                currentUser: null,
                currentView: 'auth',
                transaction: null,
                marketData: {
                    rates: [],
                    beneficiaries: [],
                    availableCurrencies: ['USD', 'CAD', 'SGD', 'HKD', 'GBP', 'AED', 'PHP', 'MYR', 'THB', 'USDT', 'USDC']
                },
                ui: {
                    quoteTimer: null,
                    trackingInterval: null,
                    activeModal: null,
                    onboardingStep: 1
                }
            };

            // Utility Functions
            const Utils = {
                createApiRequest: async (action, method = 'GET', params = {}) => {
                    const url = new URL(API_URL);
                    const options = { method: method.toUpperCase(), redirect: 'follow' };
                    
                    if (method === 'GET') {
                        url.searchParams.append('action', action);
                        Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
                    } else {
                        options.body = JSON.stringify({ action, data: params });
                        options.headers = { 'Content-Type': 'application/json' };
                    }
                    
                    try {
                        console.log(`[API] ${action}:`, params);
                        const response = await fetch(url, options);
                        const result = await response.json();
                        
                        if (result.success === false) {
                            throw new Error(result.error || 'API request failed');
                        }
                        
                        return result.data || result;
                    } catch (error) {
                        console.error(`[API Error] ${action}:`, error);
                        // Return mock data for demonstration
                        return Utils.getMockData(action);
                    }
                },

                getMockData: (action) => {
                    const mockData = {
                        getMarketMatrixData: [
                            { baseAsset: 'USD', quoteAsset: 'PHP', price: 58.45, type: 'FX', status: 'OK' },
                            { baseAsset: 'SGD', quoteAsset: 'PHP', price: 42.15, type: 'FX', status: 'OK' },
                            { baseAsset: 'CAD', quoteAsset: 'PHP', price: 43.22, type: 'FX', status: 'OK' },
                            { baseAsset: 'AED', quoteAsset: 'PHP', price: 15.91, type: 'FX', status: 'OK' },
                            { baseAsset: 'GBP', quoteAsset: 'PHP', price: 73.82, type: 'FX', status: 'OK' },
                            { baseAsset: 'USDT', quoteAsset: 'USD', price: 1.0001, type: 'Crypto', status: 'OK' },
                            { baseAsset: 'USDC', quoteAsset: 'USD', price: 0.9998, type: 'Crypto', status: 'OK' }
                        ],
                        getBeneficiaries: [
                            { id: 'ben_001', name: 'Maria Santos', country: 'Philippines', accountType: 'Bank', bank: 'BPI' },
                            { id: 'ben_002', name: 'John Chen', country: 'Singapore', accountType: 'Bank', bank: 'DBS' }
                        ],
                        authenticate: { success: true, user: { karavanId: 'GECAN001', partnerName: 'Miguel Rodriguez', email: 'miguel@example.com', persona: 'remit' } }
                    };
                    return mockData[action] || {};
                },

                showNotification: (message, type = 'info', duration = 4000) => {
                    const toast = document.createElement('div');
                    const colors = {
                        success: 'from-green-500 to-emerald-600',
                        error: 'from-red-500 to-rose-600',
                        info: 'from-sky-500 to-blue-600',
                        warning: 'from-amber-500 to-orange-600'
                    };
                    const icons = {
                        success: 'fa-check-circle',
                        error: 'fa-times-circle',
                        info: 'fa-info-circle',
                        warning: 'fa-exclamation-triangle'
                    };

                    toast.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[200] text-white font-medium bg-gradient-to-br ${colors[type]} transform translate-x-full transition-all duration-500 ease-out max-w-sm`;
                    toast.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas ${icons[type]} text-lg"></i>
                            <span>${message}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto">
                                <i class="fas fa-times opacity-70 hover:opacity-100"></i>
                            </button>
                        </div>
                    `;

                    document.body.appendChild(toast);
                    requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
                    
                    setTimeout(() => {
                        toast.style.transform = 'translateX(120%)';
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, duration);
                },

                formatCurrency: (amount, currency = 'USD', decimals = 2) => {
                    if (isNaN(parseFloat(amount)) || amount === null) return 'Loading...';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency,
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    }).format(amount);
                },

                openModal: (content) => {
                    const overlay = document.getElementById('modal-overlay');
                    const modalContent = document.getElementById('modal-content');
                    modalContent.innerHTML = content;
                    overlay.classList.add('active');
                },

                closeModal: () => {
                    const overlay = document.getElementById('modal-overlay');
                    overlay.classList.remove('active');
                },

                debounce: (func, wait) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func(...args), wait);
                    };
                }
            };

            // UI Rendering Engine
            const UI = {
                init: async () => {
                    try {
                        // Initialize particles.js
                        if (typeof particlesJS !== 'undefined') {
                            particlesJS('particles-js', {
                                particles: {
                                    number: { value: 50, density: { enable: true, value_area: 800 } },
                                    color: { value: '#b4975a' },
                                    shape: { type: 'circle' },
                                    opacity: { value: 0.3, random: true },
                                    size: { value: 2, random: true },
                                    line_linked: { enable: true, distance: 150, color: '#b4975a', opacity: 0.1, width: 1 },
                                    move: { enable: true, speed: 1, direction: 'none', random: true }
                                },
                                interactivity: {
                                    detect_on: 'canvas',
                                    events: { onhover: { enable: true, mode: 'grab' } }
                                },
                                retina_detect: true
                            });
                        }

                        // Load market data and render initial view
                        await Logic.loadMarketData();
                        UI.renderView('auth');
                        UI.startHoloStream();
                    } catch (error) {
                        console.error('UI initialization error:', error);
                        UI.renderView('auth');
                    }
                },

                renderView: (viewName) => {
                    const mainContent = document.getElementById('main-content');
                    AppState.currentView = viewName;
                    
                    const views = {
                        auth: UI.renderAuthView,
                        role_select: UI.renderRoleSelectView,
                        tx_wizard: UI.renderTransactionWizard,
                        lp_dashboard: UI.renderLPDashboard,
                        tx_tracker: UI.renderTransactionTracker
                    };

                    const renderFunction = views[viewName];
                    if (renderFunction) {
                        mainContent.innerHTML = renderFunction();
                        mainContent.className = 'container mx-auto p-4 pb-20 fade-in';
                        Logic.bindEventListeners(viewName);
                    } else {
                        mainContent.innerHTML = `<div class="text-center py-20"><h2 class="text-2xl text-red-400">View '${viewName}' not found</h2></div>`;
                    }
                },

                renderAuthView: () => `
                    <div class="auth-container">
                        <div class="auth-modal">
                            <div class="text-center mb-8">
                                <div class="inline-block p-4 rounded-full bg-gradient-to-br from-primary-azure to-primary-royal mb-4 animate-float">
                                    <i class="fas fa-shield-alt text-3xl text-white"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-white mb-2">Secure Access Portal</h2>
                                <p class="text-text-muted">Authenticate to enter the GECAN™ Karavan Global Settlement Layer</p>
                            </div>

                            <form id="auth-form" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Karavan ID</label>
                                    <input type="text" id="karavan-id" class="form-input" placeholder="Enter your Karavan ID" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Password</label>
                                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                                </div>
                                <button type="submit" id="login-btn" class="btn-primary w-full">
                                    <i class="fas fa-key mr-2"></i>
                                    Authenticate & Enter
                                </button>
                            </form>

                            <div id="auth-error" class="text-error-color text-sm mt-4 text-center hidden"></div>

                            <div class="text-center mt-6">
                                <p class="text-sm text-text-muted">
                                    New to GECAN™? 
                                    <button id="show-signup" class="text-primary-azure hover:text-primary-sapphire font-semibold">
                                        Create Account
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                `,

                renderRoleSelectView: () => `
                    <div class="max-w-6xl mx-auto text-center fade-in">
                        <div class="mb-12">
                            <h2 class="text-4xl lg:text-5xl font-bold text-white mb-4">
                                Welcome, <span class="text-gold-gradient">${AppState.currentUser?.partnerName}</span>
                            </h2>
                            <p class="text-xl text-text-platinum max-w-4xl mx-auto leading-relaxed">
                                From the ancient Silk Road to the digital frontier, a Karavan has always signified the secure transport of value across borders. Choose your mission:
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div id="role-remit" class="role-card">
                                <div class="role-icon bg-gradient-to-br from-primary-azure to-primary-sapphire">
                                    <i class="fas fa-paper-plane text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3">GECAN™ Remit</h3>
                                <p class="text-text-silver mb-4">Send money to family and friends with lightning speed and minimal fees</p>
                                <div class="text-sm text-text-muted">
                                    <div class="flex justify-between mb-1">
                                        <span>Speed:</span>
                                        <span class="text-success-color">Sub-5 minutes</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Fees:</span>
                                        <span class="text-success-color">0.5% - 1.0%</span>
                                    </div>
                                </div>
                            </div>

                            <div id="role-pay" class="role-card">
                                <div class="role-icon bg-gradient-to-br from-brand-gecan-gold to-warning-color">
                                    <i class="fas fa-building text-background-dark"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3">GECAN™ Pay</h3>
                                <p class="text-text-silver mb-4">Execute B2B payments and trade settlements with institutional precision</p>
                                <div class="text-sm text-text-muted">
                                    <div class="flex justify-between mb-1">
                                        <span>Volume:</span>
                                        <span class="text-primary-azure">$1K - $10M+</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Fees:</span>
                                        <span class="text-success-color">0.15% - 0.35%</span>
                                    </div>
                                </div>
                            </div>

                            ${AppState.currentUser?.persona === 'lp' ? `
                            <div id="role-lp" class="role-card">
                                <div class="role-icon bg-gradient-to-br from-primary-royal to-primary-amethyst">
                                    <i class="fas fa-network-wired text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3">LP Dashboard</h3>
                                <p class="text-text-silver mb-4">Manage liquidity pools and monitor network performance</p>
                                <div class="text-sm text-text-muted">
                                    <div class="flex justify-between mb-1">
                                        <span>Role:</span>
                                        <span class="text-warning-color">Liquidity Provider</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Yield:</span>
                                        <span class="text-success-color">2% - 4% APY</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `,

                renderTransactionWizard: () => {
                    const { transaction } = AppState;
                    if (!transaction) return '<div class="text-center py-20"><h2 class="text-xl text-red-400">No transaction initiated</h2></div>';

                    return `
                        <div class="wizard-container fade-in">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl lg:text-4xl font-bold text-white mb-2">
                                    New Karavan Dispatch
                                </h2>
                                <p class="text-lg text-text-silver">
                                    ${transaction.type === 'remit' ? 'Personal Remittance' : 'Institutional Payment'} • 
                                    Guided Secure Transfer Protocol
                                </p>
                            </div>

                            ${UI.renderWizardStep('destination', 'Define Destination', 'fa-map-marker-alt')}
                            ${UI.renderWizardStep('amount', 'Define Amount & Currency', 'fa-calculator')}
                            ${UI.renderWizardStep('review', 'Review & Dispatch', 'fa-rocket')}
                        </div>
                    `;
                },

                renderWizardStep: (stepId, title, icon) => {
                    const { transaction } = AppState;
                    const step = transaction.steps[stepId];
                    const isActive = transaction.activeStep === stepId;
                    const isCompleted = step?.completed || false;
                    const isDisabled = UI.isStepDisabled(stepId);

                    return `
                        <div class="step-card ${isActive ? 'step-expanded' : ''} ${isCompleted ? 'step-completed' : ''} ${isDisabled ? 'opacity-50' : ''}">
                            <div class="step-header" onclick="${isDisabled ? '' : `Logic.setActiveStep('${stepId}')`}">
                                <div class="step-number">
                                    ${isCompleted ? '<i class="fas fa-check"></i>' : `<i class="fas ${icon}"></i>`}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-white">${title}</h3>
                                    ${isCompleted ? '<p class="text-sm text-success-color">Completed</p>' : ''}
                                </div>
                                <div class="text-text-muted">
                                    <i class="fas fa-chevron-${isActive ? 'up' : 'down'}"></i>
                                </div>
                            </div>
                            <div class="step-content">
                                <div class="step-inner">
                                    ${UI.renderStepContent(stepId)}
                                </div>
                            </div>
                        </div>
                    `;
                },

                renderStepContent: (stepId) => {
                    const { transaction } = AppState;
                    
                    switch (stepId) {
                        case 'destination':
                            const beneficiaries = AppState.marketData.beneficiaries;
                            return `
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        <div class="lg:col-span-2">
                                            <label class="block text-sm font-medium text-text-silver mb-2">Select Beneficiary</label>
                                            <select id="beneficiary-select" class="form-input">
                                                <option value="">Choose a recipient...</option>
                                                ${beneficiaries.map(b => `
                                                    <option value="${b.id}" ${transaction.recipientId === b.id ? 'selected' : ''}>
                                                        ${b.name} (${b.country})
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="flex items-end">
                                            <button id="add-beneficiary-btn" class="btn-secondary w-full">
                                                <i class="fas fa-user-plus mr-2"></i>Add New
                                            </button>
                                        </div>
                                    </div>

                                    ${transaction.type === 'pay' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Invoice Reference</label>
                                        <input type="text" id="invoice-ref" class="form-input" placeholder="e.g., INV-2025-001" 
                                               value="${transaction.invoiceRef || ''}">
                                    </div>
                                    ` : ''}

                                    <button id="confirm-destination" class="btn-primary w-full lg:w-auto">
                                        <i class="fas fa-check mr-2"></i>Confirm Destination
                                    </button>
                                </div>
                            `;

                        case 'amount':
                            return `
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="glass-premium p-6 rounded-xl">
                                            <h4 class="text-lg font-bold text-white mb-4">You Send</h4>
                                            <div class="space-y-4">
                                                <input type="number" id="send-amount" class="form-input text-xl text-center font-mono" 
                                                       placeholder="0.00" value="${transaction.sendAmount || ''}" 
                                                       oninput="Logic.updateQuote()">
                                                <select id="send-currency" class="form-input" onchange="Logic.updateQuote()">
                                                    ${AppState.marketData.availableCurrencies.map(c => `
                                                        <option value="${c}" ${transaction.sendCurrency === c ? 'selected' : ''}>${c}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                        </div>

                                        <div class="glass-premium p-6 rounded-xl">
                                            <h4 class="text-lg font-bold text-white mb-4">Recipient Receives</h4>
                                            <div class="space-y-4">
                                                <div class="form-input text-xl text-center font-mono bg-gray-800 cursor-not-allowed">
                                                    <span id="receive-amount">${transaction.receiveAmount || '0.00'}</span>
                                                </div>
                                                <select id="receive-currency" class="form-input" onchange="Logic.updateQuote()">
                                                    ${AppState.marketData.availableCurrencies.map(c => `
                                                        <option value="${c}" ${transaction.receiveCurrency === c ? 'selected' : ''}>${c}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="quote-panel" class="quote-panel hidden">
                                        <div class="quote-timer mb-4">
                                            <div class="quote-progress" id="quote-progress" style="width: 100%"></div>
                                        </div>
                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
                                            <div>
                                                <span class="text-text-muted">Exchange Rate:</span>
                                                <div class="font-mono text-white" id="exchange-rate">Loading...</div>
                                            </div>
                                            <div>
                                                <span class="text-text-muted">GECAN™ Fee:</span>
                                                <div class="font-mono text-warning-color" id="fee-amount">Loading...</div>
                                            </div>
                                            <div>
                                                <span class="text-text-muted">Total Time:</span>
                                                <div class="font-mono text-success-color">Sub-5 minutes</div>
                                            </div>
                                        </div>
                                    </div>

                                    <button id="confirm-amount" class="btn-primary w-full lg:w-auto" disabled>
                                        <i class="fas fa-check mr-2"></i>Lock Quote & Continue
                                    </button>
                                </div>
                            `;

                        case 'review':
                            return `
                                <div class="space-y-6">
                                    <div class="glass-premium p-6 rounded-xl">
                                        <h4 class="text-lg font-bold text-white mb-4">Transaction Summary</h4>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span class="text-text-silver">Recipient:</span>
                                                <span class="text-white font-medium" id="summary-recipient">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-text-silver">You Send:</span>
                                                <span class="text-white font-mono" id="summary-send">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-text-silver">They Receive:</span>
                                                <span class="text-white font-mono" id="summary-receive">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-text-silver">Exchange Rate:</span>
                                                <span class="text-white font-mono" id="summary-rate">-</span>
                                            </div>
                                            <div class="flex justify-between border-t border-border-color pt-3">
                                                <span class="text-text-silver">Total Fee:</span>
                                                <span class="text-warning-color font-mono" id="summary-fee">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="glass-premium p-6 rounded-xl">
                                        <h4 class="text-lg font-bold text-white mb-4">Payment Method</h4>
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="payment-methods">
                                            <div class="p-4 border-2 border-border-color rounded-xl cursor-pointer hover:border-brand-gecan-gold transition-colors" 
                                                 onclick="Logic.selectPaymentMethod('crypto')">
                                                <div class="flex items-center gap-3">
                                                    <i class="fas fa-coins text-primary-azure"></i>
                                                    <div>
                                                        <div class="font-semibold text-white">Crypto Transfer</div>
                                                        <div class="text-sm text-text-muted">USDT/USDC (0.25% fee)</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="p-4 border-2 border-border-color rounded-xl cursor-pointer hover:border-brand-gecan-gold transition-colors"
                                                 onclick="Logic.selectPaymentMethod('bank')">
                                                <div class="flex items-center gap-3">
                                                    <i class="fas fa-university text-brand-gecan-gold"></i>
                                                    <div>
                                                        <div class="font-semibold text-white">Bank Transfer</div>
                                                        <div class="text-sm text-text-muted">Local banking (0.75% fee)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <button id="dispatch-karavan" class="btn-primary w-full text-xl py-4 animate-glow-pulse" disabled>
                                        <i class="fas fa-rocket mr-2"></i>Dispatch Karavan
                                    </button>
                                </div>
                            `;

                        default:
                            return '<p class="text-text-muted">Step content not available</p>';
                    }
                },

                isStepDisabled: (stepId) => {
                    const { transaction } = AppState;
                    const stepOrder = ['destination', 'amount', 'review'];
                    const currentIndex = stepOrder.indexOf(stepId);
                    
                    for (let i = 0; i < currentIndex; i++) {
                        const prevStepId = stepOrder[i];
                        if (!transaction.steps[prevStepId]?.completed) {
                            return true;
                        }
                    }
                    return false;
                },

                startHoloStream: () => {
                    const track = document.getElementById('holo-track');
                    if (!track || !AppState.marketData.rates.length) return;

                    const items = AppState.marketData.rates
                        .filter(rate => rate.status === 'OK')
                        .map(rate => {
                            const isUp = Math.random() > 0.5;
                            const colorClass = isUp ? 'text-green-400' : 'text-red-400';
                            const icon = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
                            return `
                                <div class="holo-item">
                                    <span class="text-white font-bold">${rate.baseAsset}/${rate.quoteAsset}</span>
                                    <span class="ml-2 ${colorClass}">${rate.price.toFixed(4)}</span>
                                    <i class="fas ${icon} text-xs ml-1 ${colorClass}"></i>
                                </div>
                            `;
                        }).join('');

                    track.innerHTML = items.repeat(3);
                }
            };

            // Logic Engine
            const Logic = {
                init: async () => {
                    try {
                        await UI.init();
                        Logic.bindGlobalEventListeners();
                    } catch (error) {
                        console.error('Application initialization failed:', error);
                        Utils.showNotification('Application failed to initialize. Some features may not work correctly.', 'error');
                    }
                },

                bindGlobalEventListeners: () => {
                    // Modal close on overlay click
                    document.getElementById('modal-overlay').addEventListener('click', (e) => {
                        if (e.target.id === 'modal-overlay') {
                            Utils.closeModal();
                        }
                    });

                    // Support button
                    document.getElementById('support-btn')?.addEventListener('click', () => {
                        Utils.showNotification('Support feature coming soon. Please contact support@gecan.com for assistance.', 'info');
                    });
                },

                bindEventListeners: (viewName) => {
                    switch (viewName) {
                        case 'auth':
                            Logic.bindAuthListeners();
                            break;
                        case 'role_select':
                            Logic.bindRoleSelectListeners();
                            break;
                        case 'tx_wizard':
                            Logic.bindWizardListeners();
                            break;
                    }
                },

                bindAuthListeners: () => {
                    const form = document.getElementById('auth-form');
                    const showSignup = document.getElementById('show-signup');

                    form?.addEventListener('submit', Logic.handleLogin);
                    showSignup?.addEventListener('click', Logic.showSignupModal);
                },

                bindRoleSelectListeners: () => {
                    document.getElementById('role-remit')?.addEventListener('click', () => Logic.selectRole('remit'));
                    document.getElementById('role-pay')?.addEventListener('click', () => Logic.selectRole('pay'));
                    document.getElementById('role-lp')?.addEventListener('click', () => Logic.selectRole('lp'));
                },

                bindWizardListeners: () => {
                    document.getElementById('confirm-destination')?.addEventListener('click', Logic.confirmDestination);
                    document.getElementById('confirm-amount')?.addEventListener('click', Logic.confirmAmount);
                    document.getElementById('dispatch-karavan')?.addEventListener('click', Logic.dispatchKaravan);
                    document.getElementById('add-beneficiary-btn')?.addEventListener('click', Logic.showAddBeneficiaryModal);
                },

                loadMarketData: async () => {
                    try {
                        const rates = await Utils.createApiRequest('getMarketMatrixData');
                        const beneficiaries = await Utils.createApiRequest('getBeneficiaries', 'POST', {
                            ownerKaravanId: AppState.currentUser?.karavanId || 'demo'
                        });

                        AppState.marketData.rates = rates || [];
                        AppState.marketData.beneficiaries = beneficiaries || [];
                    } catch (error) {
                        console.error('Failed to load market data:', error);
                    }
                },

                handleLogin: async (e) => {
                    e.preventDefault();
                    const karavanId = document.getElementById('karavan-id').value;
                    const password = document.getElementById('password').value;
                    const errorDiv = document.getElementById('auth-error');
                    const loginBtn = document.getElementById('login-btn');

                    if (!karavanId || !password) {
                        Logic.showAuthError('Please enter both Karavan ID and password');
                        return;
                    }

                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Authenticating...';
                    errorDiv.classList.add('hidden');

                    try {
                        const response = await Utils.createApiRequest('authenticate', 'POST', {
                            karavanId,
                            password
                        });

                        if (response.success || response.user) {
                            AppState.isAuthenticated = true;
                            AppState.currentUser = response.user || {
                                karavanId,
                                partnerName: 'Demo User',
                                email: 'demo@gecan.com',
                                persona: 'remit'
                            };

                            Utils.showNotification(`Welcome back, ${AppState.currentUser.partnerName}!`, 'success');
                            await Logic.loadMarketData();
                            UI.renderView('role_select');
                        } else {
                            Logic.showAuthError('Invalid credentials. Please check your Karavan ID and password.');
                        }
                    } catch (error) {
                        Logic.showAuthError('Authentication failed. Please try again.');
                    } finally {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-key mr-2"></i>Authenticate & Enter';
                    }
                },

                showAuthError: (message) => {
                    const errorDiv = document.getElementById('auth-error');
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                },

                showSignupModal: () => {
                    const signupContent = `
                        <div class="p-8">
                            <div class="text-center mb-6">
                                <h3 class="text-2xl font-bold text-white mb-2">Join GECAN™ Karavan</h3>
                                <p class="text-text-silver">Create your account to access the Global Settlement Layer</p>
                            </div>

                            <form id="signup-form" class="space-y-4">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Full Name</label>
                                        <input type="text" id="signup-name" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Email Address</label>
                                        <input type="email" id="signup-email" class="form-input" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Password</label>
                                    <input type="password" id="signup-password" class="form-input" required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Account Type</label>
                                    <select id="signup-persona" class="form-input" required>
                                        <option value="">Choose account type...</option>
                                        <option value="remit">Individual (Personal Remittances)</option>
                                        <option value="pay">Institution (B2B Payments)</option>
                                    </select>
                                </div>

                                <div class="flex gap-3 pt-4">
                                    <button type="button" onclick="Utils.closeModal()" class="btn-secondary flex-1">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn-primary flex-1">
                                        <i class="fas fa-user-plus mr-2"></i>Create Account
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    Utils.openModal(signupContent);
                    
                    setTimeout(() => {
                        document.getElementById('signup-form')?.addEventListener('submit', Logic.handleSignup);
                    }, 100);
                },

                handleSignup: async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('signup-name').value;
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const persona = document.getElementById('signup-persona').value;

                    if (!name || !email || !password || !persona) {
                        Utils.showNotification('Please fill in all fields', 'error');
                        return;
                    }

                    try {
                        const response = await Utils.createApiRequest('createAccount', 'POST', {
                            name, email, password, persona
                        });

                        const karavanId = response.karavanId || `GECAN${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
                        
                        Utils.closeModal();
                        Utils.showNotification(`Account created successfully! Your Karavan ID is: ${karavanId}`, 'success', 8000);
                        
                        // Auto-fill login form
                        document.getElementById('karavan-id').value = karavanId;
                    } catch (error) {
                        Utils.showNotification('Account creation failed. Please try again.', 'error');
                    }
                },

                selectRole: async (roleType) => {
                    if (roleType === 'lp') {
                        UI.renderView('lp_dashboard');
                        return;
                    }

                    Utils.showNotification('Initializing secure transaction environment...', 'info');

                    AppState.transaction = {
                        type: roleType,
                        activeStep: 'destination',
                        steps: {
                            destination: { completed: false, data: {} },
                            amount: { completed: false, data: {} },
                            review: { completed: false, data: {} }
                        },
                        recipientId: null,
                        sendAmount: null,
                        sendCurrency: roleType === 'remit' ? 'CAD' : 'USD',
                        receiveCurrency: 'PHP',
                        receiveAmount: null,
                        exchangeRate: null,
                        fee: null,
                        paymentMethod: null,
                        invoiceRef: null
                    };

                    await Logic.loadMarketData();
                    UI.renderView('tx_wizard');
                },

                setActiveStep: (stepId) => {
                    if (UI.isStepDisabled(stepId)) {
                        Utils.showNotification('Please complete the previous step first', 'warning');
                        return;
                    }
                    
                    AppState.transaction.activeStep = stepId;
                    UI.renderView('tx_wizard');
                },

                confirmDestination: () => {
                    const recipientId = document.getElementById('beneficiary-select').value;
                    const invoiceRef = document.getElementById('invoice-ref')?.value;

                    if (!recipientId) {
                        Utils.showNotification('Please select a beneficiary', 'error');
                        return;
                    }

                    if (AppState.transaction.type === 'pay' && !invoiceRef) {
                        Utils.showNotification('Invoice reference is required for B2B payments', 'error');
                        return;
                    }

                    AppState.transaction.recipientId = recipientId;
                    AppState.transaction.invoiceRef = invoiceRef;
                    AppState.transaction.steps.destination.completed = true;
                    AppState.transaction.activeStep = 'amount';

                    Utils.showNotification('Destination confirmed successfully', 'success');
                    UI.renderView('tx_wizard');
                },

                confirmAmount: () => {
                    const sendAmount = parseFloat(document.getElementById('send-amount').value);
                    
                    if (!sendAmount || sendAmount <= 0) {
                        Utils.showNotification('Please enter a valid amount', 'error');
                        return;
                    }

                    if (!AppState.transaction.exchangeRate) {
                        Utils.showNotification('Please wait for quote to load', 'warning');
                        return;
                    }

                    AppState.transaction.steps.amount.completed = true;
                    AppState.transaction.activeStep = 'review';

                    Logic.updateReviewSummary();
                    Utils.showNotification('Amount locked successfully', 'success');
                    UI.renderView('tx_wizard');
                },

                updateQuote: Utils.debounce(() => {
                    const sendAmount = parseFloat(document.getElementById('send-amount').value);
                    const sendCurrency = document.getElementById('send-currency').value;
                    const receiveCurrency = document.getElementById('receive-currency').value;

                    if (!sendAmount || sendAmount <= 0 || !sendCurrency || !receiveCurrency) {
                        document.getElementById('quote-panel')?.classList.add('hidden');
                        document.getElementById('confirm-amount').disabled = true;
                        return;
                    }

                    Logic.calculateQuote(sendAmount, sendCurrency, receiveCurrency);
                }, 500),

                calculateQuote: (sendAmount, sendCurrency, receiveCurrency) => {
                    // Find exchange rate from market data
                    let exchangeRate = 1;
                    const rates = AppState.marketData.rates;
                    
                    const directRate = rates.find(r => 
                        r.baseAsset === sendCurrency && r.quoteAsset === receiveCurrency
                    );
                    
                    if (directRate) {
                        exchangeRate = directRate.price;
                    } else {
                        // Try cross-rate via USD
                        const sendToUSD = rates.find(r => r.baseAsset === sendCurrency && r.quoteAsset === 'USD');
                        const usdToReceive = rates.find(r => r.baseAsset === 'USD' && r.quoteAsset === receiveCurrency);
                        
                        if (sendToUSD && usdToReceive) {
                            exchangeRate = sendToUSD.price * usdToReceive.price;
                        } else {
                            exchangeRate = 1.2; // Fallback rate for demo
                        }
                    }

                    const feePercentage = AppState.transaction.type === 'remit' ? 0.006 : 0.0035; // 0.6% or 0.35%
                    const fee = sendAmount * feePercentage;
                    const netAmount = sendAmount - fee;
                    const receiveAmount = netAmount * exchangeRate;

                    // Update transaction state
                    AppState.transaction.sendAmount = sendAmount;
                    AppState.transaction.sendCurrency = sendCurrency;
                    AppState.transaction.receiveCurrency = receiveCurrency;
                    AppState.transaction.receiveAmount = receiveAmount;
                    AppState.transaction.exchangeRate = exchangeRate;
                    AppState.transaction.fee = fee;

                    // Update UI
                    document.getElementById('receive-amount').textContent = receiveAmount.toFixed(2);
                    document.getElementById('exchange-rate').textContent = `1 ${sendCurrency} = ${exchangeRate.toFixed(4)} ${receiveCurrency}`;
                    document.getElementById('fee-amount').textContent = Utils.formatCurrency(fee, sendCurrency);
                    
                    document.getElementById('quote-panel')?.classList.remove('hidden');
                    document.getElementById('confirm-amount').disabled = false;

                    // Start quote timer
                    Logic.startQuoteTimer();
                },

                startQuoteTimer: () => {
                    if (AppState.ui.quoteTimer) {
                        clearInterval(AppState.ui.quoteTimer);
                    }

                    let timeLeft = 30;
                    const progressBar = document.getElementById('quote-progress');

                    AppState.ui.quoteTimer = setInterval(() => {
                        timeLeft--;
                        const percentage = (timeLeft / 30) * 100;
                        
                        if (progressBar) {
                            progressBar.style.width = `${percentage}%`;
                        }

                        if (timeLeft <= 0) {
                            clearInterval(AppState.ui.quoteTimer);
                            Utils.showNotification('Quote expired. Please refresh your quote.', 'warning');
                            document.getElementById('confirm-amount').disabled = true;
                        }
                    }, 1000);
                },

                updateReviewSummary: () => {
                    const { transaction } = AppState;
                    const beneficiary = AppState.marketData.beneficiaries.find(b => b.id === transaction.recipientId);

                    setTimeout(() => {
                        const elements = {
                            'summary-recipient': beneficiary?.name || 'Unknown',
                            'summary-send': Utils.formatCurrency(transaction.sendAmount, transaction.sendCurrency),
                            'summary-receive': Utils.formatCurrency(transaction.receiveAmount, transaction.receiveCurrency),
                            'summary-rate': `1 ${transaction.sendCurrency} = ${transaction.exchangeRate.toFixed(4)} ${transaction.receiveCurrency}`,
                            'summary-fee': Utils.formatCurrency(transaction.fee, transaction.sendCurrency)
                        };

                        Object.entries(elements).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element) element.textContent = value;
                        });
                    }, 100);
                },

                selectPaymentMethod: (method) => {
                    AppState.transaction.paymentMethod = method;
                    
                    // Update UI to show selected method
                    document.querySelectorAll('#payment-methods > div').forEach(div => {
                        div.classList.remove('border-brand-gecan-gold', 'bg-brand-gecan-gold', 'bg-opacity-10');
                        div.classList.add('border-border-color');
                    });

                    const selectedDiv = document.querySelector(`#payment-methods > div[onclick*="${method}"]`);
                    if (selectedDiv) {
                        selectedDiv.classList.remove('border-border-color');
                        selectedDiv.classList.add('border-brand-gecan-gold', 'bg-brand-gecan-gold', 'bg-opacity-10');
                    }

                    document.getElementById('dispatch-karavan').disabled = false;
                },

                dispatchKaravan: async () => {
                    const { transaction } = AppState;
                    
                    if (!transaction.paymentMethod) {
                        Utils.showNotification('Please select a payment method', 'error');
                        return;
                    }

                    const dispatchBtn = document.getElementById('dispatch-karavan');
                    dispatchBtn.disabled = true;
                    dispatchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Dispatching Karavan...';

                    try {
                        const response = await Utils.createApiRequest('initiateTransfer', 'POST', {
                            transaction: transaction,
                            userId: AppState.currentUser.karavanId
                        });

                        const transactionId = response.transactionId || `TXN${Date.now()}`;
                        Utils.showNotification('Karavan dispatched successfully!', 'success');
                        
                        AppState.activeTransaction = {
                            id: transactionId,
                            ...transaction,
                            status: 'initiated',
                            timestamp: new Date().toISOString()
                        };

                        UI.renderView('tx_tracker');
                    } catch (error) {
                        Utils.showNotification('Failed to dispatch Karavan. Please try again.', 'error');
                        dispatchBtn.disabled = false;
                        dispatchBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Dispatch Karavan';
                    }
                },

                showAddBeneficiaryModal: () => {
                    const modalContent = `
                        <div class="p-8">
                            <div class="text-center mb-6">
                                <h3 class="text-2xl font-bold text-white mb-2">Add New Beneficiary</h3>
                                <p class="text-text-silver">Add a trusted recipient for your transfers</p>
                            </div>

                            <form id="beneficiary-form" class="space-y-4">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Full Name</label>
                                        <input type="text" id="ben-name" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Country</label>
                                        <select id="ben-country" class="form-input" required>
                                            <option value="">Select country...</option>
                                            <option value="Philippines">Philippines</option>
                                            <option value="Singapore">Singapore</option>
                                            <option value="Malaysia">Malaysia</option>
                                            <option value="Thailand">Thailand</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Mobile Number</label>
                                    <input type="tel" id="ben-mobile" class="form-input" placeholder="+63 9XX XXX XXXX" required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-text-silver mb-2">Payout Method</label>
                                    <select id="ben-method" class="form-input" required>
                                        <option value="">Select method...</option>
                                        <option value="bank">Bank Transfer</option>
                                        <option value="ewallet">Digital Wallet</option>
                                        <option value="cash">Cash Pickup</option>
                                    </select>
                                </div>

                                <div id="bank-details" class="hidden">
                                    <label class="block text-sm font-medium text-text-silver mb-2">Bank Account Number</label>
                                    <input type="text" id="ben-account" class="form-input">
                                </div>

                                <div class="flex gap-3 pt-4">
                                    <button type="button" onclick="Utils.closeModal()" class="btn-secondary flex-1">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn-primary flex-1">
                                        <i class="fas fa-user-plus mr-2"></i>Add Beneficiary
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;

                    Utils.openModal(modalContent);

                    setTimeout(() => {
                        const form = document.getElementById('beneficiary-form');
                        const methodSelect = document.getElementById('ben-method');
                        
                        methodSelect?.addEventListener('change', (e) => {
                            const bankDetails = document.getElementById('bank-details');
                            if (e.target.value === 'bank') {
                                bankDetails.classList.remove('hidden');
                            } else {
                                bankDetails.classList.add('hidden');
                            }
                        });

                        form?.addEventListener('submit', Logic.handleAddBeneficiary);
                    }, 100);
                },

                handleAddBeneficiary: async (e) => {
                    e.preventDefault();
                    
                    const beneficiary = {
                        name: document.getElementById('ben-name').value,
                        country: document.getElementById('ben-country').value,
                        mobile: document.getElementById('ben-mobile').value,
                        payoutMethod: document.getElementById('ben-method').value,
                        accountNumber: document.getElementById('ben-account')?.value
                    };

                    if (!beneficiary.name || !beneficiary.country || !beneficiary.mobile || !beneficiary.payoutMethod) {
                        Utils.showNotification('Please fill in all required fields', 'error');
                        return;
                    }

                    try {
                        const response = await Utils.createApiRequest('addBeneficiary', 'POST', {
                            beneficiary,
                            ownerKaravanId: AppState.currentUser.karavanId
                        });

                        const newBeneficiary = {
                            id: response.id || `ben_${Date.now()}`,
                            ...beneficiary
                        };

                        AppState.marketData.beneficiaries.push(newBeneficiary);
                        Utils.closeModal();
                        Utils.showNotification('Beneficiary added successfully!', 'success');
                        
                        // Refresh the wizard view if we're in it
                        if (AppState.currentView === 'tx_wizard') {
                            UI.renderView('tx_wizard');
                        }
                    } catch (error) {
                        Utils.showNotification('Failed to add beneficiary. Please try again.', 'error');
                    }
                }
            };

            // Transaction Tracker
            UI.renderTransactionTracker = () => {
                const { activeTransaction } = AppState;
                if (!activeTransaction) {
                    return '<div class="text-center py-20"><h2 class="text-xl text-red-400">No active transaction</h2></div>';
                }

                const stages = [
                    { id: 'initiated', label: 'Initiated', icon: 'fa-play-circle' },
                    { id: 'payment', label: 'Awaiting Payment', icon: 'fa-credit-card' },
                    { id: 'compliance', label: 'Compliance Check', icon: 'fa-shield-alt' },
                    { id: 'settlement', label: 'Settlement', icon: 'fa-exchange-alt' },
                    { id: 'completed', label: 'Completed', icon: 'fa-check-circle' }
                ];

                return `
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white mb-2">Karavan Dispatch Tracker</h2>
                            <p class="text-lg text-text-silver">Transaction ID: ${activeTransaction.id}</p>
                        </div>

                        <div class="glass-premium p-8 rounded-2xl mb-8">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-white">${Utils.formatCurrency(activeTransaction.sendAmount, activeTransaction.sendCurrency)}</div>
                                    <div class="text-text-muted">Amount Sent</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary-azure">${Utils.formatCurrency(activeTransaction.receiveAmount, activeTransaction.receiveCurrency)}</div>
                                    <div class="text-text-muted">Amount Received</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-success-color">Sub-5 minutes</div>
                                    <div class="text-text-muted">Estimated Time</div>
                                </div>
                            </div>

                            <div class="tracker-timeline">
                                ${stages.map((stage, index) => `
                                    <div class="tracker-step ${index === 0 ? 'active' : ''}">
                                        <div class="tracker-dot">
                                            <i class="fas ${stage.icon}"></i>
                                        </div>
                                        <div class="text-sm text-center mt-2">
                                            <div class="font-medium text-white">${stage.label}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="text-center">
                            <button onclick="UI.renderView('role_select')" class="btn-primary mr-4">
                                <i class="fas fa-plus mr-2"></i>New Transaction
                            </button>
                            <button onclick="Logic.downloadProof()" class="btn-secondary">
                                <i class="fas fa-download mr-2"></i>Download Proof
                            </button>
                        </div>
                    </div>
                `;
            };

            // LP Dashboard
            UI.renderLPDashboard = () => `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-white mb-2">Liquidity Partner Dashboard</h2>
                        <p class="text-lg text-text-silver">Manage your liquidity pools and monitor network performance</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="glass-premium p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white">Available Liquidity</h3>
                                <i class="fas fa-wallet text-primary-azure text-xl"></i>
                            </div>
                            <div class="text-2xl font-bold text-success-color mb-2">$2.5M USD</div>
                            <div class="text-sm text-text-muted">Across all currencies</div>
                        </div>

                        <div class="glass-premium p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white">24H Volume</h3>
                                <i class="fas fa-chart-line text-brand-gecan-gold text-xl"></i>
                            </div>
                            <div class="text-2xl font-bold text-primary-azure mb-2">$487K</div>
                            <div class="text-sm text-success-color">+12.5% vs yesterday</div>
                        </div>

                        <div class="glass-premium p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white">Fees Earned</h3>
                                <i class="fas fa-coins text-warning-color text-xl"></i>
                            </div>
                            <div class="text-2xl font-bold text-warning-color mb-2">$1,247</div>
                            <div class="text-sm text-text-muted">This month</div>
                        </div>
                    </div>

                    <div class="glass-premium p-6 rounded-xl">
                        <h3 class="text-xl font-bold text-white mb-4">Recent Settlement Requests</h3>
                        <div class="space-y-3">
                            ${[1,2,3,4,5].map(i => `
                                <div class="flex items-center justify-between p-4 bg-background-dark rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-success-color"></div>
                                        <div>
                                            <div class="font-medium text-white">SGD ${(Math.random() * 10000).toFixed(0)} → PHP</div>
                                            <div class="text-sm text-text-muted">${Math.floor(Date.now() / 1000) - (i * 300)} seconds ago</div>
                                        </div>
                                    </div>
                                    <div class="text-success-color font-medium">Completed</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Additional Logic functions
            Logic.downloadProof = () => {
                Utils.showNotification('Proof of Settlement certificate downloaded successfully', 'success');
            };

            // Global error handling
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                Utils.showNotification('An unexpected error occurred. Please refresh the page.', 'error');
            });

            // Initialize application
            document.addEventListener('DOMContentLoaded', Logic.init);

            // Expose Logic to global scope for onclick handlers
            window.Logic = Logic;
            window.Utils = Utils;
            window.UI = UI;

        })();
    </script>
</body>
</html>
