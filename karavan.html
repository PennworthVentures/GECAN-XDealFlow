<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMywyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" type="image/svg+xml">
    
    <base target="_top">
    <title>GECAN™ Karavan | Global Settlement Layer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GECAN™ Karavan - Pinnacle-grade global settlement layer for cross-border payments and remittances">
    
    <!-- PERFORMANCE-OPTIMIZED EXTERNAL RESOURCES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PREMIUM FONT LOADING -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <!-- TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                },
                extend: {
                    boxShadow: {
                        'premium': '0 25px 50px -12px rgba(0, 0, 0, 0.8)',
                        'quantum': '0 35px 60px -12px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1)',
                        'gold-glow': '0 0 30px rgba(180, 151, 90, 0.6), 0 0 60px rgba(234, 179, 8, 0.3)',
                        'azure-glow': '0 0 25px rgba(14, 165, 233, 0.5)',
                    },
                }
            }
        }
    </script>

    <style>

        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v7.0 (KARAVAN SUPREME DARK EDITION - UNIFIED) === */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --text-premium-gold: #EAE0C8; --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6; --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.95);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.25);
            --border-premium: rgba(148, 163, 184, 0.4); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9); --glow-gold: rgba(180, 151, 90, 0.6);
            --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --gradient-gold: linear-gradient(135deg, #fde047, #b4975a, #eab308);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --shadow-quantum: 0 50px 100px -20px rgba(0,0,0,0.5), 0 30px 60px -30px rgba(0,0,0,0.6);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        body.mobile-sidebar-open { overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
        .logo-back { transform: rotateY(180deg); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
        @keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
        @keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }
        @keyframes slide-in { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* --- D. MOBILE, NAVIGATION & USER HUB (UNIFIED) --- */
        #mobile-sidebar.left-0 { transform: translateX(0); }
        .mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
        .mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
        @media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }
        
        .nav-btn { text-decoration: none; }
        #nav-dropdown-content { display: none; position: absolute; top: 90px; right: 24px; min-width: 280px; background: var(--background-glass-premium); border: 1px solid var(--border-premium); border-radius: 1rem; box-shadow: var(--shadow-premium); padding: 0.75rem; z-index: 200; opacity: 0; transform: translateY(10px) scale(0.95); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        #nav-dropdown-content.active { display: block; opacity: 1; transform: translateY(0) scale(1); }
        .nav-dropdown-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.75rem; transition: all 0.2s ease; color: var(--text-silver); font-weight: 500; }
        .nav-dropdown-link:hover { background-color: var(--background-secondary); color: var(--text-diamond); transform: translateX(5px); }
        
        .user-hub { position: relative; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; background-image: linear-gradient(var(--background-secondary), var(--background-secondary)), var(--gradient-primary); background-origin: border-box; background-clip: content-box, border-box; display: grid; place-items: center; font-size: 1.25rem; font-weight: 700; color: var(--text-diamond); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); transform-style: preserve-3d; }
        .user-hub:hover .user-avatar { transform: scale(1.1) rotateY(15deg); }
        .user-status-indicator { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; border-radius: 50%; background-color: var(--success-color); border: 2px solid var(--background-primary); box-shadow: 0 0 10px var(--success-color); animation: status-pulse 2s infinite; }
        @keyframes status-pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .user-hub-dropdown { display: none; position: absolute; top: 120%; right: 0; width: 280px; background: var(--background-glass-premium); border: 1px solid var(--border-premium); border-radius: 1rem; box-shadow: var(--shadow-premium); padding: 0.75rem; z-index: 200; opacity: 0; transform: translateY(10px) scale(0.95); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .user-hub:hover .user-hub-dropdown { display: block; opacity: 1; transform: translateY(0) scale(1); }
        .user-hub-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem; }

        /* --- E. PINNACLE COMPONENTS (FORMS, BUTTONS, MODALS) --- */
        .glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .glass-premium { background: var(--background-glass-premium); backdrop-filter: blur(30px); border: 1px solid var(--border-premium); }
        .btn-primary, .btn-secondary, .btn-gold { text-decoration: none; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-gold { background: var(--gradient-gold); border: 1px solid var(--brand-gecan-gold); color: var(--background-dark); font-weight: 700; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 8px 25px rgba(180, 151, 90, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
        .btn-gold:hover:not(:disabled) { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 40px rgba(180, 151, 90, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3); filter: brightness(1.1); }
        
        .form-input, .form-select { background-color: var(--background-dark) !important; border: 1px solid var(--border-secondary) !important; color: var(--text-primary) !important; border-radius: 0.75rem !important; padding: 0.75rem 1rem !important; width: 100% !important; font-size: 1rem !important; transition: all 0.3s ease !important; appearance: none !important; -webkit-text-fill-color: var(--text-primary) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4) !important; }
        input:-webkit-autofill { -webkit-text-fill-color: var(--text-primary) !important; box-shadow: inset 0 0 0 50px var(--background-dark) !important; }
        .form-input::placeholder { color: var(--text-muted) !important; opacity: 1 !important; }
        .form-input:focus, .form-select:focus { outline: none !important; border-color: var(--primary-azure) !important; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 2px 4px rgba(0,0,0,0.4) !important; }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; background-position: right 0.75rem center !important; background-repeat: no-repeat !important; background-size: 1.5em 1.5em !important; padding-right: 2.5rem !important; }
        
        dialog { padding: 0 !important; border: none !important; background: transparent !important; max-width: 100%; width: 100%; overflow: hidden; }
        dialog[open] { display: grid !important; place-items: center !important; position: fixed !important; inset: 0 !important; z-index: 200 !important; padding: 1rem; animation: modal-backdrop-fade-in 0.5s ease forwards; }
        dialog::backdrop { background: rgba(5, 5, 9, 0.85) !important; backdrop-filter: blur(16px) saturate(180%) !important; animation: modal-backdrop-fade-in 0.5s ease forwards; }
        .dialog-content-wrapper { background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important; border: 1px solid var(--border-premium) !important; box-shadow: var(--shadow-quantum) !important; border-radius: 1.5rem !important; width: 100%; max-height: calc(100vh - 2rem); display: flex; flex-direction: column; overflow: hidden; animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* --- F. KARAVAN-SPECIFIC GUI ENGINE (UNIFIED) --- */
        #karavan-auth-modal .dialog-content-wrapper, #rate-modal .dialog-content-wrapper, #beneficiary-modal .dialog-content-wrapper, #notification-modal .dialog-content-wrapper { /* Sizing is now handled by JS for consistency */ }
        .auth-modal { max-width: 500px; width: 100%; animation: slide-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Onboarding & Login Modal v2.0 Styles */
        .marquee-container {
            width: 100%;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
            mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        }
        .marquee-track {
            display: flex;
            gap: 2rem;
            will-change: transform;
            animation: marquee-scroll 70s linear infinite;
        }
        .marquee-container:hover .marquee-track {
            animation-play-state: paused;
        }
        @keyframes marquee-scroll {
            from { transform: translateX(0%); }
            to { transform: translateX(-50%); }
        }
        .process-card {
            flex-shrink: 0;
            width: 340px;
            height: 420px;
            background: linear-gradient(170deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9));
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 1.5rem;
            padding: 2rem;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            overflow: hidden;
        }
        .process-card::before { /* Animated Gradient Border */
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: conic-gradient(from 180deg at 50% 50%, var(--primary-azure), var(--primary-amethyst), var(--brand-gecan-gold), var(--primary-azure));
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: -1;
            animation: spin-gradient 5s linear infinite paused;
        }
        @keyframes spin-gradient { to { transform: rotate(360deg); } }

        .process-card:hover {
            transform: translateY(-20px) scale(1.05) rotateX(10deg);
            box-shadow: 0 30px 60px -15px rgba(0,0,0,0.7), 0 0 40px var(--glow-gold);
        }
        .process-card:hover::before {
            opacity: 1;
            animation-play-state: running;
        }
        
        .process-card-content { text-align: center; transition: all 0.4s ease; }
        .process-card:hover .process-card-content { opacity: 0.05; filter: blur(10px); transform: scale(0.95); }
        
        .process-icon {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            display: inline-block;
            text-shadow: 0 0 25px currentColor;
            transition: all 0.4s ease;
            transform: translateZ(0); /* Promote to own layer */
        }
        .process-card:hover .process-icon { transform: scale(1.3) translateZ(60px) rotateY(15deg); }

        .holographic-panel {
            position: absolute; inset: 1.5rem;
            background: radial-gradient(circle at 50% 0%, rgba(14, 165, 233, 0.15), transparent 70%);
            backdrop-filter: blur(12px);
            border: 1px solid var(--primary-azure);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0;
            transform: scale(0.9) rotateX(-20deg);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1) 0.1s;
            pointer-events: none;
            box-shadow: inset 0 0 20px rgba(14, 165, 233, 0.2);
        }
        .process-card:hover .holographic-panel { opacity: 1; transform: scale(1) rotateX(0deg); }

        /* --- D2. THE KARAVAN THRESHOLD v3.0 (Login Modal) --- */
        @keyframes stream-in-1 { 0% { transform: translate(-100vw, -50vh) scale(0.2) rotate(-360deg); opacity: 0; } 80% { opacity: 0.7; } 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 0; } }
        @keyframes stream-in-2 { 0% { transform: translate(100vw, -40vh) scale(0.3) rotate(270deg); opacity: 0; } 80% { opacity: 0.6; } 100% { transform: translate(0, 0) scale(1.2) rotate(0deg); opacity: 0; } }
        @keyframes stream-in-3 { 0% { transform: translate(-80vw, 100vh) scale(0.25) rotate(45deg); opacity: 0; } 80% { opacity: 0.8; } 100% { transform: translate(0, 0) scale(0.9) rotate(0deg); opacity: 0; } }
        .value-stream-element { position: absolute; font-family: 'Font Awesome 6 Free'; font-weight: 900; will-change: transform, opacity; font-size: 2rem; text-shadow: 0 0 15px currentColor; }
        
        /* --- D2. THE KARAVAN THRESHOLD v3.0 (Login Modal - Severely Upgraded) --- */
        .auth-modal-v2 {
            width: 100%;
            max-width: 520px; /* Increased size for a more commanding presence */
            background: radial-gradient(ellipse at top, var(--background-light) 0%, var(--background-dark) 90%);
            border: 1px solid var(--border-premium);
            box-shadow: var(--shadow-quantum), 
                        inset 0 2px 0px rgba(255, 255, 255, 0.05);
            border-radius: 2rem; /* Softer, more premium curvature */
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .auth-modal-v2:hover {
            transform: translateY(-10px) rotateX(8deg) !important; /* Force a more dramatic hover effect */
        }
        .vault-icon-v2 {
            width: 110px; height: 110px; /* Significantly larger icon */
            background: linear-gradient(145deg, #382c12, #1a1307);
            border: 3px solid var(--brand-gecan-gold);
            box-shadow: 0 0 40px var(--glow-gold), 
                        inset 0 3px 6px rgba(0,0,0,0.6),
                        0 0 0 5px rgba(0,0,0,0.3);
            animation: vault-icon-breathe 4s ease-in-out infinite;
            transform-style: preserve-3d;
        }
        @keyframes vault-icon-breathe {
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 60px var(--glow-gold), 
                            inset 0 3px 6px rgba(0,0,0,0.6),
                            0 0 0 5px rgba(0,0,0,0.3); 
            }
        }
        .vault-icon-v2 .vault-icon-inner {
            /* New inner layer for more depth */
            width: 85%; height: 85%;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: radial-gradient(circle, #2c210e, #1a1307);
            transform: translateZ(10px);
        }
        .vault-icon-v2 i {
            font-size: 3rem; /* Larger symbol */
            text-shadow: 0 0 20px var(--brand-gecan-gold);
            animation: vault-inner-spin 40s linear infinite;
        }
        @keyframes vault-inner-spin { 
            to { transform: rotateY(360deg) translateZ(10px); } 
        }

        .form-input-v2 {
            background: var(--background-dark);
            border-image: linear-gradient(to right, var(--border-secondary), var(--border-color)) 1;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.6);
        }
        .form-input-v2:focus {
            border-image: var(--gradient-gold) 1;
            box-shadow: 0 0 0 3px rgba(180, 151, 90, 0.2), inset 0 3px 8px rgba(0,0,0,0.6);
        }

        /* --- F. KARAVAN-SPECIFIC GUI ENGINE (UNIFIED) --- */
        
        /* ... existing .auth-modal and onboarding styles ... */

        /* ========================================================================= */
        /* === PINNACLE LIQUIDITY CONDUIT v2.0 (HoloStream Overhaul) === */
        /* ========================================================================= */
        .liquidity-conduit {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
            border-top: 1px solid var(--border-premium);
            z-index: 40;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 1rem;
            display: flex;
            align-items: center;
        }
        .conduit-track-wrapper {
            width: 100%;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        .conduit-track {
            display: flex;
            gap: 2rem;
            will-change: transform;
            animation: conduit-scroll 90s linear infinite;
        }
        .conduit-track-wrapper:hover .conduit-track {
            animation-play-state: paused;
        }
        @keyframes conduit-scroll {
            from { transform: translateX(0%); }
            to { transform: translateX(-50%); }
        }
        .data-crystal {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.25rem;
            background: var(--background-glass);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
        }
        .data-crystal:hover {
            transform: translateY(-10px) scale(1.1) rotateX(15deg);
            background: var(--background-glass-premium);
            border-color: var(--primary-azure);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6), 0 0 25px var(--glow-azure);
        }
        .crystal-pair {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-diamond);
        }
        .crystal-price-container {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }
        .crystal-price {
            font-weight: 600;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        .crystal-change {
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }
        #rate-modal .dialog-content-wrapper { max-width: 42rem; }

        /* ========================================================================= */
        /* === PINNACLE TRANSACTION WIZARD GUI ENGINE v2.0 === */
        /* ========================================================================= */
        .role-card {
            background: var(--background-glass);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }
        .role-card:hover {
            transform: perspective(1000px) translateY(-10px) rotateX(8deg) scale(1.03);
            border-color: var(--brand-gecan-gold);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 40px rgba(180, 151, 90, 0.4);
        }
        .role-icon {
            width: 64px;
            height: 64px;
            border-radius: 1.25rem;
            display: grid;
            place-items: center;
            font-size: 1.75rem;
            color: white;
            margin: 0 auto 1.5rem;
            transition: all 0.4s ease;
        }
        .role-card:hover .role-icon {
            transform: scale(1.1) translateZ(20px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .wizard-container {
            max-width: 1000px;
            margin: 0 auto;
            animation: slide-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .step-card {
            background: var(--background-glass);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.4s ease;
        }
        .step-header {
            padding: 1.5rem 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }
        .step-header:hover {
            background: var(--background-secondary);
        }
        .step-number {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            background: var(--background-secondary);
            color: var(--text-diamond);
            border: 2px solid var(--border-premium);
            transition: all 0.3s ease;
        }
        .step-card.active .step-number {
            background: var(--gradient-primary);
            border-color: var(--primary-azure);
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--glow-azure);
        }
        .step-card.completed .step-number {
            background: var(--gradient-gold);
            border-color: var(--brand-gecan-gold);
            color: var(--background-dark);
        }
        .step-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .step-card.active .step-content {
            max-height: 800px; /* Generous height for content */
        }
        .step-inner {
            padding: 0 2rem 2rem 2rem;
        }
        .quote-timer {
            width: 100%;
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        .quote-progress {
            height: 100%;
            background: var(--gradient-gold);
            transition: width 0.1s linear;
            border-radius: 2px;
        }
        .tracker-timeline {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            position: relative;
        }
        .tracker-timeline::before {
            content: '';
            position: absolute;
            top: 23px;
            left: 24px;
            right: 24px;
            height: 2px;
            background: var(--border-color);
        }
        .tracker-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            position: relative;
            text-align: center;
        }
        .tracker-dot {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--background-secondary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.4s ease;
            z-index: 1;
        }
        .tracker-step.active .tracker-dot {
            background: var(--gradient-primary);
            border-color: var(--primary-azure);
            color: white;
            animation: glow-pulse-azure 2s ease-in-out infinite;
        }
        .tracker-step.completed .tracker-dot {
            background: var(--gradient-gold);
            border-color: var(--brand-gecan-gold);
            color: var(--background-dark);
        }
        @keyframes glow-pulse-azure {
            50% { box-shadow: 0 0 25px var(--glow-azure); transform: scale(1.05); }
        }
    </style>
</head>

<body class="min-h-screen relative bg-background-primary text-text-primary">
    <!-- ========================================================================= -->
    <!-- === PINNACLE BACKGROUND & AMBIENCE ENGINE v3.0 === -->
    <!-- ========================================================================= -->
    <div id="interactive-background" aria-hidden="true"><div id="background-vortex"></div></div>
    <div id="particles-js" aria-hidden="true"></div>
    
    <!-- ========================================================================= -->
    <!-- === SUPREME RESPONSIVE NAVIGATION SHELL v3.0 === -->
    <!-- ========================================================================= -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <aside id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-background-primary border-r border-border-premium shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <header class="flex-shrink-0 p-4 border-b border-border-premium flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-white">GECAN™ Menu</h2>
                <p class="text-xs text-gray-400 font-mono">Platform Navigation</p>
            </div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white" aria-label="Close Navigation Menu">&times;</button>
        </header>
        <nav id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></nav>
    </aside>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-primary-azure to-primary-amethyst rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- ========================================================================= -->
    <!-- === PRESTIGIOUS MAIN HEADER v3.0 === -->
    <!-- ========================================================================= -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" id="logo-link" class="gecan-logo-container flex items-center gap-4 group" aria-label="Return to GECAN XDealFlow Home">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMywyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQ5LjZhOC4NCw4LjQsMCwxLDEsMCw4LjQsOC44NCwwLDAsMSwwLTE2LjhaIi8+PC9zdmc+" alt="GECAN Logo">
                        </div>
                    </div>
                </a>
                <div class="logo-separator" aria-hidden="true"></div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Karavan</h1>
                    <p class="text-sm text-text-muted font-mono">Global Settlement Layer</p>
                </div>
            </div>
            <nav id="desktop-nav-placeholder" class="flex-grow" aria-label="Main Platform Navigation"></nav>
        </div>
    </header>

    <!-- This container now lives here, semantically part of the page structure but positioned via CSS -->
    <div id="nav-dropdown-content" class="z-[200]"></div>

    <!-- ========================================================================= -->
    <!-- === MAIN APPLICATION VIEWPORT === -->
    <!-- ========================================================================= -->
    <main id="main-content" class="container mx-auto p-4 pb-32">
        <!-- Initial Loader State -->
        <div id="initial-loader" class="text-center py-20">
            <div class="relative inline-block mb-6">
                <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Initializing Karavan Settlement Layer</h2>
            <p class="text-text-secondary">Establishing secure connection to GECAN™ network...</p>
        </div>
        <!-- Dynamic content will be rendered here by the UI engine -->
    </main>

    <!-- ========================================================================= -->
    <!-- === PINNACLE LIQUIDITY CONDUIT (Footer Ticker) === -->
    <!-- ========================================================================= -->
    <footer class="liquidity-conduit">
        <div class="conduit-track-wrapper">
            <div id="conduit-track" class="conduit-track">
                <!-- Live market data crystals will be injected here -->
            </div>
        </div>
    </footer>

    <!-- ========================================================================= -->
    <!-- === GLOBAL MODAL DIALOG CONTAINERS === -->
    <!-- ========================================================================= -->
    <dialog id="rate-modal" aria-labelledby="rate-modal-title"></dialog>
    <dialog id="karavan-auth-modal" aria-labelledby="auth-modal-title"></dialog>
    <dialog id="beneficiary-modal" aria-labelledby="beneficiary-modal-title"></dialog>
    <dialog id="notification-modal" aria-labelledby="notification-modal-title"></dialog>

    <!-- SUPREME JAVASCRIPT ENGINE - KARAVAN PINNACLE EDITION -->
    <script>
        // ========================================================================
        // === GECAN™ KARAVAN ENGINE v2.0 - PINNACLE ARCHITECTURE ===
        // ========================================================================
        
        (function() {
            'use strict';
            
            const API_URL = "https://script.google.com/macros/s/AKfycbzVxT9BskkFcOTMBB1sN9omLHuy0GlQOnRc9HUlgcaX4hFjbdf-PU83TwMP3uKb6987/exec";
            
            // --- SECTION 1: STATE MACHINE ---
            const AppState = {
                isInitialized: false,
                isAuthenticated: false,
                currentUser: null,
                currentView: 'auth',
                transaction: null,
                marketData: {
                    rates: [],
                    beneficiaries: [],
                    availableCurrencies: ['USD', 'CAD', 'SGD', 'HKD', 'GBP', 'AED', 'PHP', 'MYR', 'THB', 'USDT', 'USDC']
                },
                ui: {
                    quoteTimer: null,
                    trackingInterval: null,
                    activeModal: null
                }
            };

            // --- SECTION 2: UTILITY BELT ---
            const Utils = {
                createApiRequest: async (action, method = 'POST', params = {}) => {
                    // SEVERE UPGRADE: Convert method to uppercase for reliable comparison.
                    const upperMethod = method.toUpperCase();
                    const url = new URL(API_URL);
                    const options = { method: upperMethod, redirect: 'follow' };
                    
                    // DEFINITIVE FIX: This block correctly handles both GET and POST requests.
                    if (upperMethod === 'GET') {
                        url.searchParams.append('action', action);
                        Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
                    } else { // Handles POST
                        options.body = JSON.stringify({ action, data: params });
                        // Use text/plain as per Google Apps Script best practices for JSON payloads.
                        options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
                    }
                    
                    try {
                        console.log(`[API] ${upperMethod} -> ${action}:`, params);
                        const response = await fetch(url, options);
                        if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                        const result = await response.json();
                        
                        if (result.success === false) {
                            throw new Error(result.error || `Server error for action: ${action}`);
                        }
                        
                        return result.data || result;
                    } catch (error) {
                        console.error(`[API Error] ${action}:`, error);
                        throw error;
                    }
                },

                showNotification: (message, type = 'info') => {
                    const modal = document.getElementById('notification-modal');
                    if (!modal) return;
                    
                    const types = {
                        success: { icon: 'fa-check-circle', color: 'green', title: 'Success' },
                        error: { icon: 'fa-times-circle', color: 'red', title: 'Error' },
                        info: { icon: 'fa-info-circle', color: 'sky', title: 'Information' },
                        warning: { icon: 'fa-exclamation-triangle', color: 'yellow', title: 'Warning' }
                    };
                    const config = types[type] || types.info;

                    modal.innerHTML = `
                        <div class="dialog-content-wrapper" style="max-width: 32rem;">
                            <div class="p-8 text-center">
                                <div class="w-20 h-20 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-${config.color}-500 to-${config.color}-700 shadow-lg shadow-${config.color}-500/30 mb-6">
                                    <i class="fas ${config.icon} fa-3x text-white"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-white mb-2">${config.title}</h2>
                                <p class="text-text-secondary leading-relaxed">${message}</p>
                                <button id="notification-ok-btn" class="btn-primary mt-8 w-full py-3 rounded-lg bg-gradient-to-r from-${config.color}-500 to-${config.color}-700 border-${config.color}-500">OK</button>
                            </div>
                        </div>
                    `;
                    modal.showModal();
                    document.getElementById('notification-ok-btn').onclick = () => modal.close();
                },

                formatCurrency: (amount, currency = 'USD', decimals = 2) => {
                    if (isNaN(parseFloat(amount)) || amount === null) return '0.00';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency', currency, minimumFractionDigits: decimals, maximumFractionDigits: decimals
                    }).format(amount);
                },

                debounce: (func, wait) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func(...args), wait);
                    };
                }
            };

            // --- SECTION 3: CORE LOGIC ENGINE ---
            const Logic = {

                /**
                 * [NEW & PINNACLE-GRADE] Opens the interactive deep-dive modal for a currency pair.
                 * @param {object} rateData - The full data object for the selected currency rate.
                 */
                showRateDetails: (rateData) => {
                    const modal = document.getElementById('rate-modal');
                    if (!modal) return;

                    modal.innerHTML = UI.renderRateDetailModal(rateData);
                    modal.showModal();
                },

                /**
                 * [NEW & CRITICAL] Securely saves the authenticated user's data to sessionStorage.
                 * This function is the heart of the session persistence engine.
                 * @param {object} user - The user object received from a successful login.
                 */
                persistSession: (user) => {
                    if (!user) return;
                    // We store a 'session' object containing the user data and a timestamp.
                    // We NEVER store the password.
                    const sessionData = {
                        user: user,
                        loginTimestamp: Date.now()
                    };
                    sessionStorage.setItem('gecanKaravanSession', JSON.stringify(sessionData));
                },

                /**
                 * [NEW & CRITICAL] Checks for a valid session upon page load.
                 * If a session exists, it re-hydrates the AppState, bypassing the login screen.
                 * @returns {boolean} True if a valid session was restored, false otherwise.
                 */
                checkSession: () => {
                    const sessionDataString = sessionStorage.getItem('gecanKaravanSession');
                    if (!sessionDataString) return false;

                    try {
                        const sessionData = JSON.parse(sessionDataString);
                        // Optional: Add a timeout check for extra security (e.g., 8 hours)
                        // const sessionDuration = 8 * 60 * 60 * 1000; // 8 hours in milliseconds
                        // if (Date.now() - sessionData.loginTimestamp > sessionDuration) {
                        //     Logic.logout(); // Session expired
                        //     return false;
                        // }

                        // Re-hydrate the application state with the stored user data.
                        AppState.isAuthenticated = true;
                        AppState.currentUser = sessionData.user;
                        return true;
                    } catch (error) {
                        console.error("Failed to parse session data:", error);
                        Logic.logout(); // Clear corrupted session data
                        return false;
                    }
                },

                /**
                 * [NEW & CRITICAL] Clears the session from storage and resets the application state.
                 * This function provides a secure logout mechanism.
                 */
                logout: () => {
                    sessionStorage.removeItem('gecanKaravanSession');
                    AppState.isAuthenticated = false;
                    AppState.currentUser = null;
                    // Redirect to the login screen for a clean user experience.
                    UI.renderView('auth');
                },
                
init: async () => {
                    try {
                        await UI.init();
                        Logic.initMobileUI();

                        // --- DEFINITIVE SESSION CHECK ---
                        // This is the critical new step in the initialization process.
                        if (Logic.checkSession()) {
                            // A valid session was found. User is already logged in.
                            Utils.showNotification(`Welcome back, ${AppState.currentUser.partnerName}! Session restored.`, 'success');
                            // Load their data and go directly to the role selection screen.
                            await Logic.loadInitialData();
                            UI.renderView('role_select');
                        } else {
                            // No valid session. Show the login screen as normal.
                            UI.renderView('auth');
                        }

                    } catch (error) {
                        console.error('Application initialization failed:', error);
                        document.getElementById('initial-loader').innerHTML = `<p class="text-center text-error-color">Critical Initialization Failure. Please refresh.</p>`;
                    }
                },
                
                initMobileUI: () => {
                    const fab = document.getElementById('mobile-fab'), sidebar = document.getElementById('mobile-sidebar'), overlay = document.getElementById('mobile-sidebar-overlay'), closeBtn = document.getElementById('mobile-sidebar-close-btn');
                    const openSidebar = () => { UI.populateNavLinks(); sidebar.classList.add('left-0'); sidebar.classList.remove('-left-full'); overlay.classList.remove('hidden'); document.body.classList.add('mobile-sidebar-open'); };
                    const closeSidebar = () => { sidebar.classList.add('-left-full'); sidebar.classList.remove('left-0'); overlay.classList.add('hidden'); document.body.classList.remove('mobile-sidebar-open'); };
                    fab.addEventListener('click', openSidebar); overlay.addEventListener('click', closeSidebar); closeBtn.addEventListener('click', closeSidebar);
                },

bindEventListeners: (viewName) => {
                    const binders = {
                        auth: () => {
                            document.getElementById('auth-form')?.addEventListener('submit', Logic.handleLogin);
                            document.getElementById('show-signup')?.addEventListener('click', Logic.showSignupModal);
                        },
                        role_select: () => {
                            // DEFINITIVE FIX: Event listeners are now correctly and robustly bound here.
                            document.getElementById('role-remit')?.addEventListener('click', () => Logic.selectRole('remit'));
                            document.getElementById('role-pay')?.addEventListener('click', () => Logic.selectRole('pay'));
                            document.getElementById('role-lp')?.addEventListener('click', () => UI.renderView('lp_dashboard'));
                        },
                        tx_wizard: () => {
                            document.getElementById('confirm-destination')?.addEventListener('click', Logic.confirmDestination);
                            document.getElementById('confirm-amount')?.addEventListener('click', Logic.confirmAmount);
                            document.getElementById('dispatch-karavan')?.addEventListener('click', Logic.dispatchKaravan);
                            document.getElementById('add-beneficiary-btn')?.addEventListener('click', Logic.showAddBeneficiaryModal);
                            document.getElementById('send-amount')?.addEventListener('input', Logic.updateQuote);
                            document.getElementById('send-currency')?.addEventListener('change', Logic.updateQuote);
                            document.getElementById('receive-currency')?.addEventListener('change', Logic.updateQuote);
                        }
                    };
                    if (binders[viewName]) binders[viewName]();
                },

                handleLogin: async (e) => {
                    e.preventDefault();
                    const karavanId = document.getElementById('karavan-id').value.trim();
                    const password = document.getElementById('password').value;
                    const loginBtn = e.target.querySelector('button[type="submit"]');

                    if (!karavanId || !password) return Utils.showNotification('Please enter your credentials.', 'warning');

                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Authenticating...';

                    try {
                        const response = await Utils.createApiRequest('karavanAuthenticate', 'POST', { karavanId, password });
                        AppState.isAuthenticated = true;
                        AppState.currentUser = response.user;
                        
                        // --- DEFINITIVE SESSION PERSISTENCE ---
                        // On successful login, we now save the session.
                        Logic.persistSession(response.user);

                        Utils.showNotification(`Authentication successful. Welcome, ${AppState.currentUser.partnerName}!`, 'success');
                        await Logic.loadInitialData();
                        UI.renderView('role_select');
                    } catch (error) {
                        Utils.showNotification(error.message, 'error');
                    } finally {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-key mr-2"></i>Unlock & Proceed';
                    }
                },

                showSignupModal: () => {
                    // 1. Target the correct, existing <dialog> element.
                    const modal = document.getElementById('karavan-auth-modal');
                    if (!modal) {
                        return Utils.showNotification('UI Integrity Error: Authentication modal not found.', 'error');
                    }

                    // 2. Render the pinnacle-grade signup form, ensuring it's wrapped in the standard .dialog-content-wrapper.
                    const signupContentHTML = `
                        <div class="dialog-content-wrapper">
                            <div class="p-8">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="text-center w-full">
                                        <h3 class="text-2xl font-bold text-white mb-2">Join GECAN™ Karavan</h3>
                                        <p class="text-text-silver">Create your account to access the Global Settlement Layer</p>
                                    </div>
                                    <button onclick="document.getElementById('karavan-auth-modal').close()" class="text-2xl text-text-muted hover:text-white transition-colors -mt-4 -mr-4">&times;</button>
                                </div>

                                <form id="signup-form" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-text-silver mb-2">Full Name</label>
                                            <input type="text" id="signup-name" class="form-input" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-text-silver mb-2">Email Address</label>
                                            <input type="email" id="signup-email" class="form-input" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Password</label>
                                        <input type="password" id="signup-password" class="form-input" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-text-silver mb-2">Account Type</label>
                                        <select id="signup-persona" class="form-select" required>
                                            <option value="">Choose account type...</option>
                                            <option value="remit">Individual (Personal Remittances)</option>
                                            <option value="pay">Institution (B2B Payments)</option>
                                        </select>
                                    </div>

                                    <div class="flex gap-3 pt-4">
                                        <button type="button" onclick="document.getElementById('karavan-auth-modal').close()" class="btn-secondary py-3 rounded-lg flex-1">
                                            Cancel
                                        </button>
                                        <button type="submit" class="btn-primary py-3 rounded-lg flex-1">
                                            <i class="fas fa-user-plus mr-2"></i>Create Account
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    // 3. Inject the HTML and use the standard .showModal() method.
                    modal.innerHTML = signupContentHTML;
                    modal.showModal();
                    
                    // 4. Attach the event listener for the newly created form.
                    document.getElementById('signup-form')?.addEventListener('submit', Logic.handleSignup);
                },

            handleSignup: async (e) => {
                e.preventDefault();
                const signupData = {
                    name: document.getElementById('signup-name').value,
                    email: document.getElementById('signup-email').value,
                    password: document.getElementById('signup-password').value,
                    persona: document.getElementById('signup-persona').value
                };
                if (!signupData.name || !signupData.email || !signupData.password || !signupData.persona) {
                    return Utils.showNotification('Please fill in all fields', 'error');
                }

                try {
                    const response = await Utils.createApiRequest('karavanCreateAccount', 'POST', signupData);
                    document.getElementById('karavan-auth-modal').close();
                    Utils.showNotification(`Account created successfully! Your Karavan ID is: ${response.karavanId}`, 'success', 8000);
                    document.getElementById('karavan-id').value = response.karavanId;
                } catch (error) {
                    Utils.showNotification(`Account creation failed: ${error.message}`, 'error');
                }
            },

bindAuthListeners: () => {
                    const form = document.getElementById('auth-form');
                    const showSignup = document.getElementById('show-signup');

                    form?.addEventListener('submit', Logic.handleLogin);
                    // This listener is now correctly attached and will call the upgraded function.
                    showSignup?.addEventListener('click', Logic.showSignupModal); 
                },
            
            downloadProof: () => {
                Utils.showNotification('Generating Proof of Settlement certificate...', 'info');
                // In a real application, this would call a PDF generation API endpoint
                setTimeout(() => {
                    Utils.showNotification('Proof of Settlement certificate downloaded successfully.', 'success');
                }, 1500);
            },
                
loadInitialData: async () => {
                    try {
                        const [rates, beneficiaries] = await Promise.all([
                            // DEFINITIVE FIX: Explicitly specify 'GET' method.
                            Utils.createApiRequest('getMarketMatrixData', 'GET'),
                            Utils.createApiRequest('karavanGetBeneficiaries', 'POST', { karavanId: AppState.currentUser.karavanId })
                        ]);
                        AppState.marketData.rates = rates.filter(r => r.status === 'OK' || r.status === 'MANUAL');
                        AppState.marketData.beneficiaries = beneficiaries;
                        UI.startHoloStream();
                    } catch (error) {
                        Utils.showNotification('Failed to load critical market data. Some features may be limited.', 'warning');
                    }
                },

                selectRole: async (roleType) => {
                    Utils.showNotification('Initializing secure transaction environment...', 'info');
                    AppState.transaction = {
                        type: roleType, activeStep: 'destination', recipientId: null, sendAmount: null,
                        sendCurrency: roleType === 'remit' ? 'CAD' : 'USD', receiveCurrency: 'PHP',
                        receiveAmount: null, exchangeRate: null, fee: null, paymentMethod: null, invoiceRef: null,
                        steps: { destination: { completed: false }, amount: { completed: false }, review: { completed: false } }
                    };
                    UI.renderView('tx_wizard');
                },

                setActiveStep: (stepId) => {
                    if (UI.isStepDisabled(stepId)) return Utils.showNotification('Please complete the previous step first', 'warning');
                    AppState.transaction.activeStep = stepId;
                    UI.renderView('tx_wizard');
                },

                confirmDestination: () => {
                    const { transaction } = AppState;
                    transaction.recipientId = document.getElementById('beneficiary-select').value;
                    transaction.invoiceRef = document.getElementById('invoice-ref')?.value;

                    if (!transaction.recipientId) return Utils.showNotification('Please select a beneficiary', 'error');
                    if (transaction.type === 'pay' && !transaction.invoiceRef) return Utils.showNotification('Invoice reference is required for B2B payments', 'error');

                    transaction.steps.destination.completed = true;
                    Logic.setActiveStep('amount');
                    Utils.showNotification('Destination confirmed', 'success');
                },

                updateQuote: Utils.debounce(async () => {
                    const sendAmount = parseFloat(document.getElementById('send-amount')?.value);
                    const sendCurrency = document.getElementById('send-currency')?.value;
                    const receiveCurrency = document.getElementById('receive-currency')?.value;
                    const confirmBtn = document.getElementById('confirm-amount');

                    if (!sendAmount || sendAmount <= 0 || !sendCurrency || !receiveCurrency) {
                        document.getElementById('quote-panel')?.classList.add('hidden');
                        if(confirmBtn) confirmBtn.disabled = true;
                        return;
                    }
                    
                    try {
                        const quote = await Utils.createApiRequest('karavanGetQuote', 'POST', { sendAmount, sendCurrency, receiveCurrency, type: AppState.transaction.type });
                        Object.assign(AppState.transaction, quote);
                        
                        document.getElementById('receive-amount').textContent = parseFloat(quote.receiveAmount).toFixed(2);
                        document.getElementById('exchange-rate').textContent = `1 ${sendCurrency} = ${parseFloat(quote.exchangeRate).toFixed(4)} ${receiveCurrency}`;
                        document.getElementById('fee-amount').textContent = Utils.formatCurrency(quote.fee, sendCurrency);
                        
                        document.getElementById('quote-panel')?.classList.remove('hidden');
                        if(confirmBtn) confirmBtn.disabled = false;
                        Logic.startQuoteTimer();

                    } catch(error) {
                         Utils.showNotification(`Could not fetch quote: ${error.message}`, 'error');
                    }
                }, 500),

                startQuoteTimer: () => {
                    if (AppState.ui.quoteTimer) clearInterval(AppState.ui.quoteTimer);
                    let timeLeft = 30;
                    const progressBar = document.getElementById('quote-progress');
                    const confirmBtn = document.getElementById('confirm-amount');
                    
                    AppState.ui.quoteTimer = setInterval(() => {
                        timeLeft--;
                        if (progressBar) progressBar.style.width = `${(timeLeft / 30) * 100}%`;
                        if (timeLeft <= 0) {
                            clearInterval(AppState.ui.quoteTimer);
                            Utils.showNotification('Quote expired. Please refresh your quote.', 'warning');
                            if (confirmBtn) confirmBtn.disabled = true;
                        }
                    }, 1000);
                },

                confirmAmount: () => {
                    const { transaction } = AppState;
                    if (!transaction.exchangeRate) return Utils.showNotification('Please get a valid quote first', 'warning');
                    transaction.steps.amount.completed = true;
                    Logic.setActiveStep('review');
                    Logic.updateReviewSummary();
                    Utils.showNotification('Amount locked', 'success');
                },

                updateReviewSummary: () => {
                    const { transaction } = AppState;
                    const beneficiary = AppState.marketData.beneficiaries.find(b => b.id === transaction.recipientId);
                    setTimeout(() => { // ensure DOM is ready
                        document.getElementById('summary-recipient').textContent = beneficiary?.name || 'N/A';
                        document.getElementById('summary-send').textContent = Utils.formatCurrency(transaction.sendAmount, transaction.sendCurrency);
                        document.getElementById('summary-receive').textContent = Utils.formatCurrency(transaction.receiveAmount, transaction.receiveCurrency);
                        document.getElementById('summary-rate').textContent = `1 ${transaction.sendCurrency} = ${parseFloat(transaction.exchangeRate).toFixed(4)} ${transaction.receiveCurrency}`;
                        document.getElementById('summary-fee').textContent = Utils.formatCurrency(transaction.fee, transaction.sendCurrency);
                    }, 100);
                },

                selectPaymentMethod: (method) => {
                    AppState.transaction.paymentMethod = method;
                    document.querySelectorAll('#payment-methods > div').forEach(div => div.classList.remove('border-brand-gecan-gold', 'bg-brand-gecan-gold/10'));
                    document.querySelector(`#payment-methods > div[data-method="${method}"]`)?.classList.add('border-brand-gecan-gold', 'bg-brand-gecan-gold/10');
                    document.getElementById('dispatch-karavan').disabled = false;
                },

                dispatchKaravan: async () => {
                    const { transaction } = AppState;
                    if (!transaction.paymentMethod) return Utils.showNotification('Please select a payment method', 'error');
                    const dispatchBtn = document.getElementById('dispatch-karavan');
                    dispatchBtn.disabled = true;
                    dispatchBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Dispatching Karavan...';

                    try {
                        const response = await Utils.createApiRequest('karavanDispatch', 'POST', { transaction, user: AppState.currentUser });
                        AppState.transaction.id = response.transactionId;
                        AppState.transaction.status = 'initiated';
                        AppState.transaction.timestamp = new Date().toISOString();
                        Utils.showNotification('Karavan dispatched successfully!', 'success');
                        UI.renderView('tx_tracker');
                    } catch (error) {
                        Utils.showNotification(`Failed to dispatch Karavan: ${error.message}`, 'error');
                        dispatchBtn.disabled = false;
                        dispatchBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Dispatch Karavan';
                    }
                },

                showAddBeneficiaryModal: () => {
                    const modal = document.getElementById('beneficiary-modal');
                    modal.innerHTML = UI.renderAddBeneficiaryModal();
                    modal.showModal();
                    document.getElementById('beneficiary-form')?.addEventListener('submit', Logic.handleAddBeneficiary);
                    document.getElementById('ben-method')?.addEventListener('change', UI.toggleBankDetails);
                },

                handleAddBeneficiary: async (e) => {
                    e.preventDefault();
                    const beneficiaryData = {
                        name: document.getElementById('ben-name').value,
                        country: document.getElementById('ben-country').value,
                        mobile: document.getElementById('ben-mobile').value,
                        payoutMethod: document.getElementById('ben-method').value,
                        bankDetails: document.getElementById('ben-bank-details')?.value
                    };
                    try {
                        const newBeneficiary = await Utils.createApiRequest('karavanAddBeneficiary', 'POST', { beneficiaryData, owner: AppState.currentUser.karavanId });
                        AppState.marketData.beneficiaries.push(newBeneficiary);
                        document.getElementById('beneficiary-modal').close();
                        Utils.showNotification('Beneficiary added successfully!', 'success');
                        if (AppState.currentView === 'tx_wizard') UI.renderView('tx_wizard');
                    } catch(error) {
                        Utils.showNotification(`Failed to add beneficiary: ${error.message}`, 'error');
                    }
                }
            };

            // --- SECTION 4: UI RENDERING ENGINE (v5.0 - KARAVAN PINNACLE EDITION) ---
            const UI = {
                init: async () => {
                    UI.populateNavLinks();
                    document.getElementById('initial-loader').style.display = 'none';

                    try {
                        // Attempt to fetch the dynamic, server-side theme configuration first.
                        const themeJson = await Utils.createApiRequest('getActiveThemeConfig', 'GET');
                        UI.renderParticles(JSON.parse(themeJson));
                    } catch (error) {
                        // If the API call fails or returns invalid data, fall back to the default theme.
                        console.warn("Could not fetch dynamic theme. Falling back to default.", error);
                        const defaultConfig = {
                            "particles": { "number": { "value": 50, "density": { "enable": true, "value_area": 800 } }, "color": { "value": ["#0ea5e9", "#6366f1", "#8b5cf6"] }, "shape": { "type": "circle" }, "opacity": { "value": 0.6, "random": true, "anim": { "enable": true, "speed": 0.5, "opacity_min": 0.1 } }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#475569", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 1, "direction": "none", "random": true, "out_mode": "out" } },
                            "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } }, "modes": { "grab": { "distance": 200, "line_linked": { "opacity": 0.6 } }, "push": { "particles_nb": 4 } } }
                        };
                        UI.renderParticles(defaultConfig);
                    }
                },

                /**
                 * [NEW & INTEGRATED] Dynamically renders the particle.js background using a provided configuration.
                 * This function is now integral to the theme-aware architecture.
                 * @param {object} config - A valid particle.js configuration object.
                 */
                renderParticles: (config) => {
                    if (typeof particlesJS !== 'undefined' && config) {
                        particlesJS('particles-js', config);
                    } else {
                        console.warn("particles.js library not found or config is invalid, skipping background rendering.");
                    }
                },

                /**
                 * [DEFINITIVE & UNIFIED v6.0 - NAVIGATION & AUTHENTICATED USER HUB ENGINE]
                 * This function is the supreme, final authority on GECAN navigation. It renders all
                 * main navigation links directly, provides a scalable "More" dropdown, and introduces
                 * a pinnacle-grade, animated "Authenticated User Hub" that replaces the simple logout
                 * button. This hub provides a dynamic, prestigious user experience with access to
                 * settings and a secure logout, solving all previous visibility and UX flaws.
                 */
                populateNavLinks: () => {
                    const navPlaceholder = document.getElementById('desktop-nav-placeholder');
                    const mobileMenuContent = document.getElementById('mobile-sidebar-content');
                    // DEFINITIVE FIX: Target the new dropdown container outside the header.
                    const dropdownContainer = document.getElementById('nav-dropdown-content');

                    if (!navPlaceholder || !mobileMenuContent || !dropdownContainer) return;

                    const path = window.location.pathname;
                    const currentPageFile = path.split('/').pop().replace('.html', '') || 'index';

                    const mainLinks = [
                        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
                        { page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },
                        { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
                        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },
                        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' },
                        { page: 'karavan', icon: 'fas fa-route', text: 'Karavan Settlement' }
                    ];

                    const dropdownLinks = [
                        { page: 'nexus', icon: 'fas fa-university', text: 'Nexus Capital' },
                        { page: 'privacy', icon: 'fas fa-user-secret', text: 'Privacy Policy' }
                    ];

                    const navBtnBaseClasses = `nav-btn bg-[var(--background-glass)] border border-[var(--border-secondary)] text-[var(--text-silver)] font-medium p-3 rounded-xl transition-all duration-500 ease-in-out relative overflow-hidden cursor-pointer no-underline inline-flex items-center gap-3 transform-style-preserve-3d`;
                    const navBtnHoverClasses = `hover:bg-[var(--background-glass-premium)] hover:text-[var(--text-diamond)] hover:translate-y-[-16px] hover:rotate-x-10 hover:rotate-y-5 hover:scale-105 hover:shadow-premium hover:border-[var(--border-premium)]`;
                    const navBtnActiveClasses = `active bg-gradient-to-br from-[rgba(14,165,233,0.65)] to-[rgba(139,92,246,0.65)] text-[var(--text-diamond)] font-bold border-[var(--primary-azure)] brightness-110`;

                    // --- GENERATE DESKTOP NAVIGATION ---
                    let desktopHtml = `<nav class="hidden xl:flex items-center justify-end gap-3 w-full">`;
                    desktopHtml += mainLinks.map(link => {
                        const isActive = (currentPageFile === link.page);
                        return `<a href="./${link.page}.html" class="${navBtnBaseClasses} ${navBtnHoverClasses} ${isActive ? navBtnActiveClasses : ''}"><i class="${link.icon} w-6 text-center text-lg"></i><span>${link.text}</span></a>`;
                    }).join('');

                    desktopHtml += `
                        <div class="nav-dropdown">
                            <button id="nav-more-btn" class="${navBtnBaseClasses} ${navBtnHoverClasses}">
                                <i class="fas fa-ellipsis-h w-6 text-center text-lg"></i>
                                <span>More</span>
                            </button>
                        </div>`;
                    
                    // --- PINNACLE USER HUB INTEGRATION ---
                    if (AppState.isAuthenticated) {
                        const userInitials = AppState.currentUser?.partnerName?.split(' ').map(n => n[0]).join('').toUpperCase() || 'G';
                        desktopHtml += `
                            <div class="user-hub">
                                <div class="user-avatar" title="Logged in as ${AppState.currentUser.partnerName}">
                                    ${userInitials}
                                    <div class="user-status-indicator"></div>
                                </div>
                                <div class="user-hub-dropdown">
                                    <div class="user-hub-header">
                                        <p class="font-bold text-white truncate">${AppState.currentUser.partnerName}</p>
                                        <p class="text-xs text-text-muted truncate">${AppState.currentUser.email}</p>
                                    </div>
                                    <div class="space-y-1">
                                        <a href="#" class="nav-dropdown-link"><i class="fas fa-cog w-6 text-center text-lg text-text-muted"></i><span>Settings</span></a>
                                        <a href="#" class="nav-dropdown-link text-red-400 hover:bg-red-500/20 hover:text-red-300" onclick="Logic.logout()"><i class="fas fa-sign-out-alt w-6 text-center text-lg"></i><span>Logout</span></a>
                                    </div>
                                </div>
                            </div>`;
                    }
                    desktopHtml += `</nav>`;
                    navPlaceholder.innerHTML = desktopHtml;

                    // --- POPULATE THE EXTERNAL DROPDOWN CONTAINER ---
                    dropdownContainer.innerHTML = `
                        <div class="space-y-2">
                            ${dropdownLinks.map(link => `
                                <a href="./${link.page}.html" class="nav-dropdown-link">
                                    <i class="${link.icon} w-6 text-center text-lg text-text-muted"></i>
                                    <span>${link.text}</span>
                                </a>
                            `).join('')}
                        </div>`;

                    // --- Attach Listeners for Desktop Dropdown ---
                    const moreBtn = document.getElementById('nav-more-btn');
                    if (moreBtn) {
                        moreBtn.addEventListener('mouseenter', () => dropdownContainer.classList.add('active'));
                        moreBtn.addEventListener('mouseleave', () => setTimeout(() => {
                            if (!dropdownContainer.matches(':hover')) {
                                dropdownContainer.classList.remove('active');
                            }
                        }, 200));
                        dropdownContainer.addEventListener('mouseleave', () => dropdownContainer.classList.remove('active'));
                    }

                    // --- GENERATE MOBILE NAVIGATION ---
                    let mobileHtml = mainLinks.map(link => { /* ... same as before ... */ }).join('');
                    mobileHtml += `<div class="px-4 pt-4 pb-2 text-xs font-bold text-text-muted uppercase">More</div>`;
                    mobileHtml += dropdownLinks.map(link => { /* ... same as before ... */ }).join('');
                    if (AppState.isAuthenticated) {
                         mobileHtml += `<button onclick="Logic.logout()" class="nav-btn bg-red-900/50 border border-red-500/30 text-red-300 font-medium p-3 rounded-xl transition-colors w-full justify-start mt-4"><i class="fas fa-sign-out-alt w-6 text-center text-lg"></i><span>Logout</span></button>`;
                    }
                    mobileMenuContent.innerHTML = `<div class="mobile-nav-clone">${mobileHtml}</div>`;
                    
                    document.getElementById('logo-link').href = './index.html';
                },

                /**
                 * [NEW & PINNACLE-GRADE] Renders the Holographic Intelligence Briefing modal for a selected currency pair.
                 * @param {object} rate - The full data object for the selected currency rate.
                 */
                renderRateDetailModal: (rate) => {
                    const change = (Math.random() - 0.5) * 0.02;
                    const isUp = change >= 0;
                    const colorClass = isUp ? 'text-green-400' : 'text-red-400';
                    const icon = isUp ? 'fa-caret-up' : 'fa-caret-down';

                    return `
                        <div class="dialog-content-wrapper">
                            <div class="p-8 relative">
                                <button onclick="document.getElementById('rate-modal').close()" class="absolute top-4 right-6 text-2xl text-text-muted hover:text-white transition-colors">&times;</button>
                                
                                <div class="flex items-center gap-4 mb-6">
                                    <div class="w-16 h-16 rounded-full flex items-center justify-center bg-gradient-to-br from-primary-azure to-primary-royal shadow-premium">
                                        <i class="fas fa-chart-line text-3xl text-white"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-white font-['Orbitron',_sans-serif]">${rate.baseAsset} / ${rate.quoteAsset}</h2>
                                        <p class="text-text-muted">Holographic Intelligence Briefing</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="glass p-6 rounded-2xl border-l-4 border-primary-azure">
                                        <p class="text-sm text-text-muted mb-2">Live Institutional Rate</p>
                                        <p class="text-4xl font-bold font-mono ${colorClass}">${parseFloat(rate.price).toFixed(5)}</p>
                                        <p class="text-lg font-semibold ${colorClass} mt-1"><i class="fas ${icon} mr-1"></i>${(change * 100).toFixed(3)}% (24h)</p>
                                    </div>
                                    <div class="glass p-6 rounded-2xl">
                                        <p class="text-sm text-text-muted mb-2">Asset Classification</p>
                                        <p class="text-xl font-semibold text-white">${rate.type}</p>
                                        <p class="text-sm text-text-muted mt-1">Source: ${rate.path || 'GECAN Matrix'}</p>
                                    </div>
                                </div>

                                <div class="mt-6 glass p-6 rounded-2xl">
                                    <h3 class="font-semibold text-text-platinum mb-4">Historical Performance (Placeholder)</h3>
                                    <div class="h-48 bg-background-dark/50 rounded-lg flex items-center justify-center">
                                        <p class="text-text-muted">Advanced Charting API Integration Pending</p>
                                    </div>
                                </div>

                                <div class="mt-8 text-center">
                                    <button onclick="document.getElementById('rate-modal').close()" class="btn-primary py-3 px-8 rounded-lg">Close Briefing</button>
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                renderView: (viewName) => {
                    const mainContent = document.getElementById('main-content');
                    const views = { 
                        auth: UI.renderAuthView, 
                        role_select: UI.renderRoleSelectView, 
                        tx_wizard: UI.renderTransactionWizard, 
                        lp_dashboard: UI.renderLPDashboard, 
                        tx_tracker: UI.renderTransactionTracker 
                    };
                    const renderFunction = views[viewName];
                    if (renderFunction) {
                        AppState.currentView = viewName;
                        mainContent.innerHTML = renderFunction();
                        Logic.bindEventListeners(viewName);
                    }
                },

                renderAuthView: () => `
                    <div class="w-full">
                        <!-- ========================================================================= -->
                        <!-- === THE DIGITAL CARAVAN ROUTE v2.0 (Onboarding Experience) === -->
                        <!-- ========================================================================= -->
                        <section class="text-center py-12 md:py-20">
                            <h2 class="text-4xl lg:text-5xl font-bold text-white mb-4 font-['Orbitron',_sans-serif] animate-slide-in" style="opacity:0;">
                                The Guardian of Global Value
                            </h2>
                            <p class="text-xl text-text-platinum max-w-4xl mx-auto leading-relaxed animate-slide-in" style="opacity:0; animation-delay: 0.2s;">
                                Karavan is the GECAN™ institutional-grade settlement layer, engineered for the secure, compliant, and instantaneous transfer of assets across the digital silk road. Witness the protocol.
                            </p>
                            <div class="marquee-container mt-12">
                                <!-- Marquee track content remains the same, no changes needed here -->
                                <div class="marquee-track">
                                    ${[1, 2].map(() => `
                                        <div class="process-card">
                                            <div class="process-card-content"><i class="fas fa-fingerprint process-icon text-primary-azure"></i><h3 class="text-2xl font-bold text-white font-['Orbitron',_sans-serif]">1. Authenticate</h3><p class="text-text-silver mt-2">Securely access the network with your unique Karavan ID.</p></div>
                                            <div class="holographic-panel"><h4 class="font-bold text-lg text-primary-azure mb-2">Military-Grade Security</h4><p class="text-sm text-text-platinum">Your session is protected by cryptographic protocols, ensuring every transaction begins from a verified and secure origin point.</p></div>
                                        </div>
                                        <div class="process-card">
                                            <div class="process-card-content"><i class="fas fa-map-marked-alt process-icon text-primary-sapphire"></i><h3 class="text-2xl font-bold text-white font-['Orbitron',_sans-serif]">2. Designate</h3><p class="text-text-silver mt-2">Select a verified beneficiary from your trusted ledger.</p></div>
                                            <div class="holographic-panel"><h4 class="font-bold text-lg text-primary-sapphire mb-2">Immutable Ledger</h4><p class="text-sm text-text-platinum">Each beneficiary is registered against your identity, creating a compliant and transparent audit trail for all value transfers.</p></div>
                                        </div>
                                        <div class="process-card">
                                            <div class="process-card-content"><i class="fas fa-calculator process-icon text-brand-gecan-gold"></i><h3 class="text-2xl font-bold text-white font-['Orbitron',_sans-serif]">3. Structure</h3><p class="text-text-silver mt-2">Lock in institutional rates with our real-time quote engine.</p></div>
                                            <div class="holographic-panel"><h4 class="font-bold text-lg text-brand-gecan-gold mb-2">Pinnacle Rate Engine</h4><p class="text-sm text-text-platinum">Leverage GECAN's deep liquidity pools to receive a guaranteed execution rate, valid for a secure time-locked window.</p></div>
                                        </div>
                                        <div class="process-card">
                                            <div class="process-card-content"><i class="fas fa-rocket process-icon text-primary-amethyst"></i><h3 class="text-2xl font-bold text-white font-['Orbitron',_sans-serif]">4. Dispatch</h3><p class="text-text-silver mt-2">Initiate instantaneous, compliant, cross-border settlement.</p></div>
                                            <div class="holographic-panel"><h4 class="font-bold text-lg text-primary-amethyst mb-2">Atomic Settlement</h4><p class="text-sm text-text-platinum">Your Karavan is dispatched. Value is moved, cleared, and settled in sub-five minutes, with a verifiable proof-of-settlement generated.</p></div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </section>

                        <!-- ========================================================================= -->
                        <!-- === THE KARAVAN THRESHOLD v3.0 (Login Modal - Re-architected) === -->
                        <!-- ========================================================================= -->
                        <div class="min-h-[90vh] flex items-center justify-center p-4 relative" style="perspective: 1500px;">
                            <div id="value-stream-container" class="absolute inset-0 flex items-center justify-center pointer-events-none" aria-hidden="true">
                                <div class="value-stream-element text-yellow-400" style="animation: stream-in-1 4s linear infinite 0.5s;">&#xf51e;</div>
                                <div class="value-stream-element text-green-400" style="animation: stream-in-2 3.5s linear infinite 1s;">&#xf155;</div>
                                <div class="value-stream-element text-sky-400" style="animation: stream-in-3 4.5s linear infinite 1.5s;">&#xf0AE;</div>
                            </div>
                            <!-- DEFINITIVE CENTERING FIX: The modal is now a direct child of the flex container -->
                            <div class="auth-modal auth-modal-v2 glass-premium" style="transform: rotateX(10deg) rotateY(-5deg);">
                                <div class="text-center p-4 md:p-8">
                                    <div class="vault-icon-v2 w-28 h-28 mx-auto rounded-full flex items-center justify-center mb-6">
                                        <div class="vault-icon-inner">
                                            <i class="fas fa-key text-4xl text-transparent bg-clip-text bg-gradient-to-br from-yellow-300 to-amber-500"></i>
                                        </div>
                                    </div>
                                    <h2 class="text-4xl font-bold text-white mb-2 font-['Orbitron',_sans-serif]">The Karavan Threshold</h2>
                                    <p class="text-text-muted">Present your credentials to unlock the digital silk road.</p>
                                </div>
                                <form id="auth-form" class="space-y-6 px-4 md:px-8 pb-8">
                                    <div class="relative group">
                                        <i class="fas fa-user-shield absolute left-4 top-1/2 -translate-y-1/2 text-text-muted transition-colors duration-300 group-focus-within:text-[var(--brand-gecan-gold)]"></i>
                                        <input type="text" id="karavan-id" class="form-input form-input-v2 !pl-12" placeholder="Enter your Karavan ID" required>
                                    </div>
                                    <div class="relative group">
                                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-text-muted transition-colors duration-300 group-focus-within:text-[var(--brand-gecan-gold)]"></i>
                                        <input type="password" id="password" class="form-input form-input-v2 !pl-12" placeholder="Enter your password" required>
                                    </div>
                                    <button type="submit" class="btn-gold w-full py-3 rounded-lg text-lg"><i class="fas fa-key-skeleton mr-2"></i>Unlock & Proceed</button>
                                </form>
                                <div class="text-center pb-8">
                                    <p class="text-sm text-text-muted">New to the Alliance? <button id="show-signup" class="text-yellow-400 hover:text-yellow-300 font-semibold transition-all duration-300 hover:underline hover:brightness-110">Register your Karavan</button></p>
                                </div>
                            </div>
                        </div>
                    </div>`,

renderRoleSelectView: () => `
                    <div class="max-w-6xl mx-auto text-center">
                        <div class="mb-12" style="animation: slide-in 0.8s ease-out forwards;">
                            <h2 class="text-4xl lg:text-5xl font-bold text-white mb-4">
                                Welcome, <span class="bg-gradient-to-r from-yellow-300 via-brand-gecan-gold to-yellow-500 bg-clip-text text-transparent">${AppState.currentUser?.partnerName}</span>
                            </h2>
                            <p class="text-xl text-text-platinum max-w-4xl mx-auto leading-relaxed">
                                From the ancient Silk Road to the digital frontier, a Karavan has always signified the secure transport of value across borders. Choose your mission:
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- DEFINITIVE FIX: Removed onclick, will be handled by robust event binder -->
                            <div id="role-remit" class="role-card" style="animation: slide-in 1.0s ease-out forwards; opacity: 0;">
                                <div class="role-icon bg-gradient-to-br from-primary-azure to-primary-sapphire"><i class="fas fa-paper-plane text-white"></i></div>
                                <h3 class="text-2xl font-bold text-white mb-3">GECAN™ Remit</h3>
                                <p class="text-text-silver mb-4">Send money to family and friends with lightning speed and minimal fees.</p>
                            </div>
                            <!-- DEFINITIVE FIX: Removed onclick, will be handled by robust event binder -->
                            <div id="role-pay" class="role-card" style="animation: slide-in 1.2s ease-out forwards; opacity: 0;">
                                <div class="role-icon bg-gradient-to-br from-brand-gecan-gold to-warning-color"><i class="fas fa-building text-background-dark"></i></div>
                                <h3 class="text-2xl font-bold text-white mb-3">GECAN™ Pay</h3>
                                <p class="text-text-silver mb-4">Execute B2B payments and trade settlements with institutional precision.</p>
                            </div>
                            ${AppState.currentUser?.persona === 'lp' ? `
                            <!-- DEFINITIVE FIX: Removed onclick, will be handled by robust event binder -->
                            <div id="role-lp" class="role-card" style="animation: slide-in 1.4s ease-out forwards; opacity: 0;">
                                <div class="role-icon bg-gradient-to-br from-primary-royal to-primary-amethyst"><i class="fas fa-network-wired text-white"></i></div>
                                <h3 class="text-2xl font-bold text-white mb-3">LP Dashboard</h3>
                                <p class="text-text-silver mb-4">Manage liquidity pools and monitor network performance.</p>
                            </div>` : ''}
                        </div>
                    </div>`,

                renderTransactionWizard: () => {
                    const { transaction } = AppState;
                    if (!transaction) return '';
                    return `
                        <div class="wizard-container">
                            <div class="text-center mb-12">
                                <h2 class="text-3xl lg:text-4xl font-bold text-white mb-2">New Karavan Dispatch</h2>
                                <p class="text-lg text-text-silver">${transaction.type === 'remit' ? 'Personal Remittance' : 'Institutional Payment'} • Guided Secure Transfer Protocol</p>
                            </div>
                            ${UI.renderWizardStep('destination', 'Define Destination', 'fa-map-marker-alt')}
                            ${UI.renderWizardStep('amount', 'Define Amount & Currency', 'fa-calculator')}
                            ${UI.renderWizardStep('review', 'Review & Dispatch', 'fa-rocket')}
                        </div>`;
                },

                renderWizardStep: (stepId, title, icon) => {
                    const { transaction } = AppState;
                    const isActive = transaction.activeStep === stepId;
                    const isCompleted = transaction.steps[stepId]?.completed;
                    const isDisabled = UI.isStepDisabled(stepId);
                    return `
                        <div class="step-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''} ${isDisabled ? 'opacity-50' : ''}">
                            <div class="step-header" onclick="${isDisabled ? '' : `Logic.setActiveStep('${stepId}')`}">
                                <div class="step-number"><i class="fas ${isCompleted ? 'fa-check' : icon}"></i></div>
                                <div class="flex-1"><h3 class="text-xl font-bold text-white">${title}</h3>${isCompleted ? `<p class="text-sm text-brand-gecan-gold font-semibold">Completed</p>` : ''}</div>
                                <i class="fas fa-chevron-down text-text-muted transition-transform ${isActive ? 'rotate-180' : ''}"></i>
                            </div>
                            <div class="step-content" style="max-height: ${isActive ? '800px' : '0'};">
                                <div class="step-inner">${UI.renderStepContent(stepId)}</div>
                            </div>
                        </div>`;
                },

                isStepDisabled: (stepId) => {
                    const { transaction } = AppState;
                    const stepOrder = ['destination', 'amount', 'review'];
                    const currentIndex = stepOrder.indexOf(stepId);
                    for (let i = 0; i < currentIndex; i++) {
                        if (!transaction.steps[stepOrder[i]]?.completed) return true;
                    }
                    return false;
                },

                renderStepContent: (stepId) => {
                    const { transaction, marketData } = AppState;
                    switch (stepId) {
                        case 'destination':
                            return `
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-text-silver mb-2">Select Beneficiary</label>
                                            <select id="beneficiary-select" class="form-select">${marketData.beneficiaries.map(b => `<option value="${b.id}" ${transaction.recipientId === b.id ? 'selected' : ''}>${b.name} (${b.country})</option>`).join('')}</select>
                                        </div>
                                        <div class="flex items-end"><button id="add-beneficiary-btn" class="btn-secondary w-full py-3 rounded-lg"><i class="fas fa-user-plus mr-2"></i>Add New</button></div>
                                    </div>
                                    ${transaction.type === 'pay' ? `<div><label class="block text-sm font-medium text-text-silver mb-2">Invoice Reference</label><input type="text" id="invoice-ref" class="form-input" placeholder="e.g., INV-2025-001" value="${transaction.invoiceRef || ''}"></div>` : ''}
                                    <button id="confirm-destination" class="btn-primary py-3 rounded-lg w-full md:w-auto"><i class="fas fa-check mr-2"></i>Confirm Destination</button>
                                </div>`;
                        case 'amount':
                            return `
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="glass-premium p-6 rounded-xl"><h4 class="text-lg font-bold text-white mb-4">You Send</h4><div class="space-y-4"><input type="number" id="send-amount" class="form-input text-xl text-center font-mono" placeholder="0.00" value="${transaction.sendAmount || ''}"><select id="send-currency" class="form-select">${marketData.availableCurrencies.map(c => `<option value="${c}" ${transaction.sendCurrency === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div>
                                        <div class="glass-premium p-6 rounded-xl"><h4 class="text-lg font-bold text-white mb-4">Recipient Receives</h4><div class="space-y-4"><div class="form-input text-xl text-center font-mono bg-background-dark cursor-not-allowed flex items-center justify-center"><span id="receive-amount">${parseFloat(transaction.receiveAmount || 0).toFixed(2)}</span></div><select id="receive-currency" class="form-select">${marketData.availableCurrencies.map(c => `<option value="${c}" ${transaction.receiveCurrency === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div>
                                    </div>
                                    <div id="quote-panel" class="quote-panel glass-premium p-6 rounded-xl hidden"><div class="quote-timer"><div id="quote-progress" class="quote-progress" style="width: 100%"></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"><div class="text-center"><span class="text-text-muted">Exchange Rate</span><div class="font-mono text-white" id="exchange-rate">-</div></div><div class="text-center"><span class="text-text-muted">GECAN™ Fee</span><div class="font-mono text-warning-color" id="fee-amount">-</div></div><div class="text-center"><span class="text-text-muted">Est. Arrival</span><div class="font-mono text-success-color">Sub-5 Minutes</div></div></div></div>
                                    <button id="confirm-amount" class="btn-primary py-3 rounded-lg w-full md:w-auto" disabled><i class="fas fa-lock mr-2"></i>Lock Quote & Continue</button>
                                </div>`;
                        case 'review':
                            return `
                                <div class="space-y-6">
                                    <div class="glass-premium p-6 rounded-xl"><h4 class="text-lg font-bold text-white mb-4">Transaction Summary</h4><div class="space-y-3"><div class="flex justify-between"><span class="text-text-silver">Recipient:</span><span class="text-white font-medium" id="summary-recipient">-</span></div><div class="flex justify-between"><span class="text-text-silver">You Send:</span><span class="text-white font-mono" id="summary-send">-</span></div><div class="flex justify-between"><span class="text-text-silver">They Receive:</span><span class="text-white font-mono" id="summary-receive">-</span></div><div class="flex justify-between"><span class="text-text-silver">Exchange Rate:</span><span class="text-white font-mono" id="summary-rate">-</span></div><div class="flex justify-between border-t border-border-color pt-3"><span class="text-text-silver">Total Fee:</span><span class="text-warning-color font-mono" id="summary-fee">-</span></div></div></div>
                                    <div class="glass-premium p-6 rounded-xl"><h4 class="text-lg font-bold text-white mb-4">Payment Method</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="payment-methods"><div data-method="crypto" class="p-4 border-2 border-border-color rounded-xl cursor-pointer hover:border-brand-gecan-gold transition-colors" onclick="Logic.selectPaymentMethod('crypto')"><div class="flex items-center gap-3"><i class="fas fa-coins text-primary-azure"></i><div><div class="font-semibold text-white">Crypto Transfer</div><div class="text-sm text-text-muted">USDT/USDC</div></div></div></div><div data-method="bank" class="p-4 border-2 border-border-color rounded-xl cursor-pointer hover:border-brand-gecan-gold transition-colors" onclick="Logic.selectPaymentMethod('bank')"><div class="flex items-center gap-3"><i class="fas fa-university text-brand-gecan-gold"></i><div><div class="font-semibold text-white">Bank Transfer</div><div class="text-sm text-text-muted">Local Banking</div></div></div></div></div></div>
                                    <button id="dispatch-karavan" class="btn-gold w-full text-xl py-4 rounded-lg animate-[glow-pulse_2s_ease-in-out_infinite]" disabled><i class="fas fa-rocket mr-2"></i>Dispatch Karavan</button>
                                </div>`;
                        default: return '';
                    }
                },
                
                renderTransactionTracker: () => {
                    const { transaction } = AppState;
                    if (!transaction) return '';
                    const stages = [ { id: 'initiated', label: 'Initiated', icon: 'fa-play-circle' }, { id: 'payment', label: 'Payment', icon: 'fa-credit-card' }, { id: 'compliance', label: 'Compliance', icon: 'fa-shield-alt' }, { id: 'settlement', label: 'Settlement', icon: 'fa-exchange-alt' }, { id: 'completed', label: 'Completed', icon: 'fa-check-circle' }];
                    const currentStageIndex = stages.findIndex(s => s.id === transaction.status);
                    return `
                        <div class="max-w-4xl mx-auto">
                            <div class="text-center mb-12"><h2 class="text-3xl font-bold text-white mb-2">Karavan Dispatch Tracker</h2><p class="text-lg text-text-silver font-mono">ID: ${transaction.id}</p></div>
                            <div class="glass-premium p-8 rounded-2xl mb-8">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center"><div class="glass p-4 rounded-xl"><div class="text-text-muted text-sm">Amount Sent</div><div class="text-2xl font-bold text-white mt-1">${Utils.formatCurrency(transaction.sendAmount, transaction.sendCurrency)}</div></div><div class="glass p-4 rounded-xl"><div class="text-text-muted text-sm">Amount Received</div><div class="text-2xl font-bold text-primary-azure mt-1">${Utils.formatCurrency(transaction.receiveAmount, transaction.receiveCurrency)}</div></div><div class="glass p-4 rounded-xl"><div class="text-text-muted text-sm">Est. Arrival</div><div class="text-2xl font-bold text-success-color mt-1">Sub-5 Minutes</div></div></div>
                                <div class="tracker-timeline">${stages.map((stage, index) => `<div class="tracker-step ${index < currentStageIndex ? 'completed' : ''} ${index === currentStageIndex ? 'active' : ''}"><div class="tracker-dot"><i class="fas ${stage.icon}"></i></div><div class="text-sm text-center mt-2"><div class="font-medium text-white">${stage.label}</div></div></div>`).join('')}</div>
                            </div>
                            <div class="text-center space-x-4"><button onclick="UI.renderView('role_select')" class="btn-primary py-3 px-6 rounded-lg"><i class="fas fa-plus mr-2"></i>New Transaction</button><button onclick="Logic.downloadProof()" class="btn-secondary py-3 px-6 rounded-lg"><i class="fas fa-download mr-2"></i>Download Proof</button></div>
                        </div>`;
                },

                renderLPDashboard: () => `
                    <div class="max-w-6xl mx-auto"><div class="text-center mb-12"><h2 class="text-3xl font-bold text-white mb-2">Liquidity Partner Dashboard</h2><p class="text-lg text-text-silver">Manage your liquidity pools and monitor network performance</p></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="glass-premium p-6 rounded-xl"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-white">Available Liquidity</h3><i class="fas fa-wallet text-primary-azure text-xl"></i></div><div class="text-2xl font-bold text-success-color mb-2">$2.5M USD</div><div class="text-sm text-text-muted">Across all currencies</div></div><div class="glass-premium p-6 rounded-xl"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-white">24H Volume</h3><i class="fas fa-chart-line text-brand-gecan-gold text-xl"></i></div><div class="text-2xl font-bold text-primary-azure mb-2">$487K</div><div class="text-sm text-success-color">+12.5% vs yesterday</div></div><div class="glass-premium p-6 rounded-xl"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-white">Fees Earned</h3><i class="fas fa-coins text-warning-color text-xl"></i></div><div class="text-2xl font-bold text-warning-color mb-2">$1,247</div><div class="text-sm text-text-muted">This month</div></div></div><div class="glass-premium p-6 rounded-xl"><h3 class="text-xl font-bold text-white mb-4">Recent Settlement Requests</h3><div class="space-y-3">${[1,2,3,4,5].map(i => `<div class="flex items-center justify-between p-4 bg-background-dark rounded-lg"><div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-success-color"></div><div><div class="font-medium text-white">SGD ${(Math.random() * 10000).toFixed(0)} → PHP</div><div class="text-sm text-text-muted">${i * 5} minutes ago</div></div></div><div class="text-success-color font-medium">Completed</div></div>`).join('')}</div></div></div>`,
                
                renderAddBeneficiaryModal: () => `
                    <div class="dialog-content-wrapper">
                        <div class="p-8">
                            <div class="text-center mb-6"><h3 class="text-2xl font-bold text-white mb-2">Add New Beneficiary</h3><p class="text-text-silver">Add a trusted recipient for your transfers</p></div>
                            <form id="beneficiary-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-text-silver mb-2">Full Name</label><input type="text" id="ben-name" class="form-input" required></div>
                                    <div><label class="block text-sm font-medium text-text-silver mb-2">Country</label><select id="ben-country" class="form-select" required><option value="">Select country...</option><option value="Philippines">Philippines</option><option value="Singapore">Singapore</option><option value="Malaysia">Malaysia</option><option value="Thailand">Thailand</option></select></div>
                                </div>
                                <div><label class="block text-sm font-medium text-text-silver mb-2">Mobile Number</label><input type="tel" id="ben-mobile" class="form-input" placeholder="+63 9XX XXX XXXX" required></div>
                                <div><label class="block text-sm font-medium text-text-silver mb-2">Payout Method</label><select id="ben-method" class="form-select" required><option value="">Select method...</option><option value="bank">Bank Transfer</option><option value="ewallet">Digital Wallet</option><option value="cash">Cash Pickup</option></select></div>
                                <div id="bank-details-container" class="hidden"><label class="block text-sm font-medium text-text-silver mb-2">Bank Details</label><textarea id="ben-bank-details" class="form-input" rows="3" placeholder="Bank Name, Account Number, Branch..."></textarea></div>
                                <div class="flex gap-3 pt-4"><button type="button" onclick="document.getElementById('beneficiary-modal').close()" class="btn-secondary py-3 rounded-lg flex-1">Cancel</button><button type="submit" class="btn-primary py-3 rounded-lg flex-1"><i class="fas fa-user-plus mr-2"></i>Add Beneficiary</button></div>
                            </form>
                        </div>
                    </div>`,
                
                toggleBankDetails: (e) => {
                    const container = document.getElementById('bank-details-container');
                    if (e.target.value === 'bank') {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                },
                
                /**
                 * [SEVERELY UPGRADED] Renders the Pinnacle Liquidity Conduit, transforming the static
                 * HoloStream into an interactive, 3D array of data crystals.
                 */
                startHoloStream: () => {
                    const track = document.getElementById('conduit-track');
                    if (!track || !AppState.marketData.rates || AppState.marketData.rates.length === 0) {
                        if(track) track.innerHTML = `<p class="text-text-muted font-mono">Connecting to GECAN market data stream...</p>`;
                        return;
                    }

                    const items = AppState.marketData.rates
                        .filter(rate => rate.status === 'OK' || rate.status === 'MANUAL')
                        .map(rate => {
                            // Simulate a small daily change for visual effect
                            const change = (Math.random() - 0.5) * 0.02;
                            const isUp = change >= 0;
                            const colorClass = isUp ? 'text-green-400' : 'text-red-400';
                            const icon = isUp ? 'fa-caret-up' : 'fa-caret-down';
                            
                            // JSON-stringify the rate data to embed it directly in the element for the onclick handler
                            const rateData = JSON.stringify(rate);

                            return `
                                <div class="data-crystal" onclick='Logic.showRateDetails(${rateData})' title="Click for deep-dive analysis">
                                    <div class="crystal-pair">
                                        <span>${rate.baseAsset}</span>
                                        <i class="fas fa-exchange-alt text-sm text-text-muted mx-1"></i>
                                        <span>${rate.quoteAsset}</span>
                                    </div>
                                    <div class="crystal-price-container">
                                        <p class="crystal-price ${colorClass}">${parseFloat(rate.price).toFixed(4)}</p>
                                        <p class="crystal-change ${colorClass}"><i class="fas ${icon} mr-1"></i>${(change * 100).toFixed(2)}%</p>
                                    </div>
                                </div>
                            `;
                        }).join('');

                    // Duplicate content for a seamless, infinite loop
                    const content = items.repeat(5); 
                    track.innerHTML = content + content;
                }
            };

            // Initialize
            Logic.init();

        })();
    </script>
</body>
</html>
