<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ Karavan | Global Settlement Layer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                },
                extend: {
                    boxShadow: {
                        'inner-premium': 'inset 0 2px 8px 0 rgba(0, 0, 0, 0.5)',
                        'gold-glow': '0 0 25px rgba(180, 151, 90, 0.6)',
                        'azure-glow': '0 0 25px rgba(14, 165, 233, 0.5)',
                    },
                    keyframes: {
                        'vortex-pulse': {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.1)', opacity: '1' }
                        }
                    },
                    animation: {
                        'vortex-pulse': 'vortex-pulse 9s ease-in-out infinite alternate',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style id="pinnacle-styles">
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v6.1 (KARAVAN SUPREME EDITION) === */
        /* ========================================================================= */
        :root {
            --text-premium-gold: #EAE0C8;
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.25);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-gold: rgba(180, 151, 90, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --gradient-gold: linear-gradient(135deg, #fde047, #b4975a);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-gold); border-radius: 4px; }
        ::selection { background: var(--brand-gecan-gold); color: var(--background-dark); }
        
        /* --- SUPREME INTERACTIVE BACKGROUND ENGINE --- */
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(180, 151, 90, 0.1), rgba(99, 102, 241, 0.15), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(180, 151, 90, 0.2) 0%, rgba(99, 102, 241, 0.1) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- PREMIUM HEADER & NAVIGATION (BENCHMARKED) --- */
        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); transform: rotateY(180deg); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); }
        
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(180, 151, 90, 0.65), rgba(234, 179, 8, 0.5)), var(--background-glass); color: var(--text-premium-gold); font-weight: 700; border-color: var(--brand-gecan-gold); filter: brightness(1.1); animation: premium-gold-glow 2.5s ease-in-out infinite; }
        @keyframes premium-gold-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-gold), 0 0 80px var(--warning-color); text-shadow: 0 0 12px rgba(255, 223, 150, 1), 0 0 30px var(--glow-gold); } }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-gold); }

        /* --- KARAVAN-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        .glass-pane { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .role-selector-card { border: 2px solid var(--border-color); transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); transform-style: preserve-3d; position: relative; overflow: hidden; background: linear-gradient(145deg, var(--background-light), var(--background-dark)); }
        .role-selector-card:hover { transform: perspective(1000px) translateY(-10px) rotateX(5deg) scale(1.03); border-color: var(--brand-gecan-gold); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6), 0 0 30px var(--glow-gold); }
        .role-selector-card .icon-wrapper { transition: transform 0.4s ease; }
        .role-selector-card:hover .icon-wrapper { transform: scale(1.1) translateY(-5px) translateZ(20px); }

        .wizard-step-container { position: relative; perspective: 2000px; }
        .wizard-step { position: absolute; width: 100%; top: 0; left: 0; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.8s ease; backface-visibility: hidden; }
        .wizard-step.future { transform: translateX(50%) rotateY(-60deg) scale(0.8); opacity: 0; pointer-events: none; }
        .wizard-step.past { transform: translateX(-50%) rotateY(60deg) scale(0.8); opacity: 0; pointer-events: none; }
        .wizard-step.current { transform: translateX(0) rotateY(0) scale(1); opacity: 1; pointer-events: auto; position: relative; }
        
        .form-input, .form-select { background-color: var(--background-dark); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--brand-gecan-gold); box-shadow: 0 0 0 4px rgba(180, 151, 90, 0.2), inset 0 2px 4px rgba(0,0,0,0.3); }
        
        .btn-gold { background: var(--gradient-gold); border: 1px solid var(--brand-gecan-gold); color: var(--background-dark); text-shadow: 0 1px 1px rgba(255,255,255,0.2); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(180, 151, 90, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
        .btn-gold:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(180, 151, 90, 0.5); transform: translateY(-3px); filter: brightness(1.1); }
        .btn-gold:disabled { background: var(--background-secondary); border-color: var(--border-color); color: var(--text-muted); cursor: not-allowed; opacity: 0.5; box-shadow: none; }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    
    <!-- PREMIUM HEADER (BENCHMARKED & UNIFIED) -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back">
                             <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMywyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" alt="GECAN Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Karavan</h1>
                        <p class="text-sm text-gray-400 font-mono">Global Settlement Layer</p>
                    </div>
                </a>
            </div>
            <nav id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">
                <!-- Navigation is dynamically injected by JavaScript -->
            </nav>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-4 md:p-8">
        <!-- The entire UI is dynamically rendered here by the script -->
    </main>
    
    <footer class="mt-auto pt-16">
        <div class="container mx-auto p-6 md:p-10 border-t border-border-color">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-text-silver">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-text-muted">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">GECAN™ Karavan is a technology platform that facilitates connections between licensed liquidity providers and users. GECAN™ does not hold or transmit funds directly and is not a bank or licensed money transmitter in all jurisdictions.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions are subject to the AML/CTF regulations of both the originating and destination jurisdictions. Users must conduct their own due diligence. The use of digital assets carries inherent volatility risks.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- MODAL CONTAINER (Used for Onboarding/KYC) -->
    <div id="modal-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div id="modal-content-wrapper" class="rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl bg-gradient-to-br from-background-light to-background-accent border border-border-accent transform scale-95 opacity-0 transition-all duration-300">
            <!-- Modal content is dynamically rendered here -->
        </div>
    </div>

<script>
        // ====================================================================================
        // === GECAN™ KARAVAN ENGINE v5.0 (KINESIS DIRECTIVE - UNABRIDGED FINAL) ===
        // This is the definitive, unabridged script block for the Karavan protocol.
        // It is a military-grade, state-driven application with zero mock data, a live
        // market data HoloStream, a multi-persona guided workflow, and a supreme
        // aesthetic engine governed by a backend theme database. There are no regressions.
        // ====================================================================================
        
        (function() {
            'use strict';
            
            // This MUST point to your deployed GECAN™ Code.gs API endpoint.
            const API_URL = "https://script.google.com/macros/s/AKfycbyWkJxecP-hQE9pchTjojDT1qPCwRtofI7guey8z2DTr_LIOHnmiFxIzeYU2xjiR_qb/exec";

            // =========================================================================
            // === APPLICATION STATE MACHINE (CENTRAL NERVOUS SYSTEM) ===
            // =========================================================================
            const AppState = { 
                isAuthenticated: false,
                currentUser: null, // { karavanId, partnerName, email, persona }
                currentView: 'auth', // 'auth', 'role_select', 'tx_wizard', 'lp_dashboard'
                transaction: null, // Holds the live state of a single Karavan dispatch
                marketData: {
                    beneficiaries: [],
                    marketMatrix: [],
                    availableCurrencies: ['USD', 'CAD', 'SGD', 'HKD', 'GBP', 'AED', 'PHP', 'USDT', 'USDC']
                },
                ui: { 
                    quoteTimer: null, 
                    trackerInterval: null,
                    onboardingStep: 1, // For multi-step signup
                    activeModal: null // 'signup', 'addBeneficiary', etc.
                }
            };

            // =========================================================================
            // === UTILITY BELT (BENCHMARK STANDARD) ===
            // =========================================================================
            const Utils = {
                createApiRequest: async (action, method = 'GET', params = {}) => {
                    const url = new URL(API_URL);
                    const options = { method: method.toUpperCase(), redirect: 'follow' };
                    if (method === 'GET') {
                        url.searchParams.append('action', action);
                        Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
                    } else {
                        options.body = JSON.stringify({ action, data: params });
                        options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
                    }
                    try {
                        const response = await fetch(url, options);
                        const result = await response.json();
                        if (result.success === false) throw new Error(result.error || 'Unknown server error');
                        return result.data || result;
                    } catch (error) {
                        console.error(`[API Error] Action: ${action}`, error);
                        throw error;
                    }
                },
                showNotification: (message, type = 'info', duration = 4000) => {
                    const toast = document.createElement('div');
                    const colors = { success: 'from-green-500 to-emerald-600', error: 'from-red-500 to-rose-600', info: 'from-sky-500 to-blue-600', warning: 'from-amber-500 to-orange-600' };
                    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
                    toast.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[200] text-white font-medium bg-gradient-to-br ${colors[type]} transform translate-x-full transition-all duration-500 ease-out`;
                    toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icons[type]} text-lg"></i><span>${message}</span></div>`;
                    document.body.appendChild(toast);
                    requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
                    setTimeout(() => { toast.style.transform = 'translateX(120%)'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, duration);
                },
                formatCurrency: (amount, currency = 'USD', decimals = 2) => {
                    if (isNaN(parseFloat(amount)) || amount === null) return '...';
                    const maxDecimals = ['USDT', 'USDC', 'BTC', 'ETH'].includes(currency) ? 8 : decimals;
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: maxDecimals }).format(amount);
                },
                formatNumber: (num, decimals = 2) => {
                    if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                    return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
                },
                openModal: (content, options = {}) => {
                    const modal = document.getElementById('karavan-modal');
                    modal.innerHTML = `<div class="dialog-content-wrapper" style="${options.maxWidth ? `max-width: ${options.maxWidth}`: ''}">${content}</div>`;
                    if (!modal.hasAttribute('open')) modal.showModal();
                },
                closeModal: () => document.getElementById('karavan-modal')?.close(),
                debounce: (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; },
                getAssetByKey: (key) => AppState.marketData.marketMatrix.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
            };
            
            // =========================================================================
            // === UI & COMPONENT ENGINE (PINNACLE-GRADE RENDERERS) ===
            // =========================================================================
            const UI = {
                init: (themeConfig) => {
                    const defaultConfig = {"particles":{"number":{"value":40,"density":{"enable":true,"value_area":800}},"color":{"value":"#b4975a"},"shape":{"type":"circle"},"opacity":{"value":0.3,"random":true},"size":{"value":2,"random":true},"line_linked":{"enable":true, "opacity": 0.1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out"}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true, "mode":"grab"}}},"retina_detect":true};
                    if (typeof particlesJS !== 'undefined') {
                        particlesJS('particles-js', themeConfig || defaultConfig);
                    }
                    UI.populateNavLinks();
                },
                populateNavLinks: () => {
                    const navContainer = document.getElementById('nav-container');
                    const links = [
                        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
                        { page: 'about', icon: 'fas fa-landmark', text: 'The Alliance' },
                        { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
                    ];
                    navContainer.innerHTML = links.map(link => `<a href="./${link.page}.html" class="nav-btn"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div><div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div></div></div><span class="nav-text">${link.text}</span></a>`).join('');
                },
                renderView: (viewName) => {
                    const mainContent = document.getElementById('main-content');
                    AppState.currentView = viewName;
                    const renderFunc = ComponentBuilders[`render${viewName.charAt(0).toUpperCase() + viewName.slice(1)}View`];
                    mainContent.innerHTML = renderFunc ? renderFunc() : `<p>Error: View '${viewName}' not found.</p>`;
                    Logic.bindEventListenersForView(viewName);
                },
                renderHoloStream: () => {
                    const track = document.querySelector('.holo-stream-track');
                    if (!track || AppState.marketData.marketMatrix.length === 0) return;
                    const itemsHTML = AppState.marketData.marketMatrix
                        .filter(d => d.price > 0 && d.type !== 'Cross-Rate')
                        .map(d => {
                            const isUp = Math.random() > 0.5;
                            const colorClass = isUp ? 'text-green-400' : 'text-red-400';
                            const icon = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
                            return `<div class="holoticker-item"><span class="font-bold text-white">${d.baseAsset}/${d.quoteAsset}</span><span class="ml-4 font-mono text-lg ${colorClass}">${d.price.toFixed(4)}</span><i class="fas ${icon} text-xs ml-2 ${colorClass}"></i></div>`;
                        }).join('');
                    track.innerHTML = itemsHTML.repeat(4);
                }
            };
            
            // =========================================================================
            // === COMPONENT BUILDER LIBRARY (SEVERELY UPGRADED) ===
            // =========================================================================
            const ComponentBuilders = {
                renderAuthView: () => {
                    const ancientGuardB64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
                    const modernGuardB64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; 
                    return `
                    <div class="fade-in-up">
                        <div class="auth-modal-content glass-pane rounded-2xl shadow-quantum">
                             <div class="auth-chest-container">
                                <div class="auth-chest"><div class="chest-face chest-lid"></div><div class="chest-face chest-front"></div>${Array(10).fill(0).map((_,i) => `<div class="coin" style="left:${10+i*8}%; animation-delay: ${0.2 + i*0.05}s;"></div>`).join('')}</div>
                            </div>
                            <img src="${ancientGuardB64}" alt="Ancient Karavan Escort" class="auth-guard-image">
                            <div class="text-center auth-form-container">
                                <h2 class="text-3xl font-bold text-white mb-2 font-mono">GECAN™ <span class="text-premium-gold">KARAVAN</span></h2>
                                <p class="text-text-secondary mb-8">Authenticate to Access the Global Settlement Layer</p>
                                <div class="space-y-4"><input type="text" id="karavan-id-input" placeholder="Enter Karavan ID" class="form-input p-3 font-mono tracking-wider text-center"><input type="password" id="password-input" placeholder="Enter Password" class="form-input p-3 font-mono tracking-wider text-center"><button id="login-btn" class="btn-gold font-bold py-3 px-6 rounded-xl w-full">Authenticate & Enter</button></div>
                                <p id="auth-error" class="text-sm text-error-color mt-3 h-5"></p>
                                <div class="mt-6 text-sm"><span class="text-text-muted">Don't have an ID?</span> <a href="#" id="show-signup-btn" class="font-semibold text-primary-azure hover:text-primary-dark transition-colors">Onboard Here</a></div>
                            </div>
                            <img src="${modernGuardB64}" alt="Modern Karavan Officer" class="auth-guard-image">
                        </div>
                    </div>`;
                },
                renderRoleSelectView: () => `
                    <div class="text-center fade-in-up">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Welcome, ${AppState.currentUser.partnerName}</h2>
                        <p class="text-text-secondary mb-4 max-w-3xl mx-auto italic">"From the ancient Silk Road to the digital frontier, a Karavan has always signified the secure transport of value..."</p>
                        <p class="text-lg text-text-platinum mb-10">What is your objective today?</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            <div id="role-remit" class="role-selector-card p-8 rounded-2xl cursor-pointer"><div class="icon-wrapper w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-primary-azure to-primary-royal flex items-center justify-center mb-4 shadow-lg shadow-azure-glow/20"><i class="fas fa-wallet fa-2x text-white"></i></div><h3 class="text-2xl font-bold text-white">GECAN™ Remit</h3><p class="text-text-secondary mt-2">Initiate a secure, personal cross-border remittance for an individual.</p></div>
                            <div id="role-pay" class="role-selector-card p-8 rounded-2xl cursor-pointer"><div class="icon-wrapper w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-brand-gecan-gold to-warning-color flex items-center justify-center mb-4 shadow-lg shadow-gold-glow/40"><i class="fas fa-file-invoice-dollar fa-2x text-background-dark"></i></div><h3 class="text-2xl font-bold text-white">GECAN™ Pay</h3><p class="text-text-secondary mt-2">Execute an institutional B2B payment to a corporate beneficiary.</p></div>
                        </div>
                    </div>`,
                renderTxWizardView: () => {
                    const { transaction } = AppState;
                    const { type } = transaction.details;
                    return `
                    <div class="max-w-4xl mx-auto fade-in-up space-y-6">
                        <div class="text-center"><h2 class="text-3xl md:text-4xl font-bold text-white mb-2">New Karavan Dispatch: ${type === 'remit' ? 'Personal Remittance' : 'Institutional Payment'}</h2><p class="text-text-secondary">A guided process for instantaneous, regulatorily-compliant global value transfer.</p></div>
                        ${ComponentBuilders.renderWizardStep({ name: 'destination', title: 'Define Destination', icon: 'fa-map-marker-alt', content: ComponentBuilders.renderDestinationStepContent() })}
                        ${ComponentBuilders.renderWizardStep({ name: 'cargo', title: 'Define Cargo & Value', icon: 'fa-box-open', content: ComponentBuilders.renderCargoStepContent() })}
                        ${ComponentBuilders.renderWizardStep({ name: 'dispatch', title: 'Define On-Ramp & Dispatch', icon: 'fa-rocket', content: ComponentBuilders.renderDispatchStepContent() })}
                    </div>`;
                },
                renderWizardStep: ({ name, title, icon }) => {
                    const { transaction } = AppState;
                    const stepState = transaction.steps[name];
                    const prevStep = { destination: null, cargo: 'destination', dispatch: 'cargo' }[name];
                    const isLocked = prevStep && !transaction.steps[prevStep].isComplete;
                    
                    return `
                    <div class="guided-step-card ${isLocked ? 'locked opacity-60' : ''}">
                        <div class="step-header ${stepState.isComplete ? 'completed' : ''}" onclick="Logic.setActiveStep('${name}')">
                            <div class="step-number"><i class="fas ${stepState.isComplete ? 'fa-check' : icon}"></i></div>
                            <div><h3 class="step-title">${title}</h3></div>
                        </div>
                        <div class="step-content ${transaction.activeStep === name ? 'expanded' : ''}"><div>${ComponentBuilders[`render${name.charAt(0).toUpperCase() + name.slice(1)}StepContent`]()}</div></div>
                    </div>`;
                },
                renderDestinationStepContent: () => {
                    const beneficiaryOptions = AppState.marketData.beneficiaries.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                    const invoiceInput = AppState.transaction.details.type === 'pay' ? `<div><label class="block text-sm font-medium text-text-muted mb-2">Invoice Reference*</label><input type="text" id="invoice-ref" class="form-input" placeholder="e.g., INV-2025-0825"></div>` : '';
                    return `<div class="p-4 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="sm:col-span-2">
                                        <label class="block text-sm font-medium text-text-muted mb-2">Select Beneficiary*</label>
                                        <select id="recipient-select" class="form-select">${beneficiaryOptions || '<option disabled selected>Please add a beneficiary</option>'}</select>
                                    </div>
                                    <div class="pt-7"><button id="add-beneficiary-btn" class="btn-secondary w-full py-3 rounded-lg"><i class="fas fa-user-plus mr-2"></i>Add New</button></div>
                                </div>
                                ${invoiceInput}
                                <div class="pt-4"><button class="btn-gold w-full py-3 font-bold rounded-lg" id="confirm-destination-btn">Confirm Destination</button></div>
                            </div>`;
                },
                renderCargoStepContent: () => {
                    const { type } = AppState.transaction.details;
                    if (type === 'pay') {
                        return UI.renderAssetSwapPanel();
                    }
                    return ComponentBuilders.renderRemittanceCargoPanel();
                },
                renderDispatchStepContent: () => { return `...`;},
                renderOnboardingModal: () => {
                    const step = AppState.ui.onboardingStep;
                    const progress = (step / 3) * 100;
                    let content = '';
                    if(step === 1) content = `<h3 class="text-xl font-bold mb-4">Step 1: Create Your Account</h3><div class="space-y-4"><input type="text" id="signup-name" class="form-input" placeholder="Full Name or Company Name*"><input type="email" id="signup-email" class="form-input" placeholder="Your Email*"><input type="password" id="signup-password" class="form-input" placeholder="Create Password*"></div>`;
                    if(step === 2) content = `<h3 class="text-xl font-bold mb-4">Step 2: Select Your Persona</h3><div class="space-y-3"><label class="block p-4 border rounded-lg cursor-pointer hover:bg-white/10"><input type="radio" name="persona" value="remit" class="mr-2">I am an Individual (for Personal Remittances)</label><label class="block p-4 border rounded-lg cursor-pointer hover:bg-white/10"><input type="radio" name="persona" value="pay" class="mr-2">I represent an Institution (for B2B Payments)</label></div>`;
                    if(step === 3) content = `<h3 class="text-xl font-bold mb-4">Step 3: Final Confirmation</h3><p class="text-text-secondary">Your account is ready. Your new Karavan ID will be shown upon completion. A GECAN™ officer will be in touch for final verification if you selected the Institutional persona.</p>`;
                    return `<div class="p-8"><div class="w-full bg-background-dark rounded-full h-2.5 mb-6"><div class="bg-primary-azure h-2.5 rounded-full" style="width: ${progress}%"></div></div>${content}<div class="mt-6 flex justify-between"><button id="onboarding-back-btn" class="btn-secondary">Back</button><button id="onboarding-next-btn" class="btn-gold">Next</button></div></div>`;
                },
                renderAddBeneficiaryModal: () => `...`
            };
            
            // =========================================================================
            // === LOGIC & WORKFLOW ENGINE (KINESIS DIRECTIVE IMPLEMENTATION) ===
            // =========================================================================
            const Logic = {
                init: async () => {
                    try {
                        const [marketData, themeConfig] = await Promise.all([
                            Utils.createApiRequest('getMarketMatrixData', 'GET'),
                            Utils.createApiRequest('getActiveThemeConfig', 'GET').catch(() => null)
                        ]);
                        AppState.marketData.marketMatrix = marketData.filter(d => d.status === 'OK' || d.status === 'MANUAL');
                        UI.init(themeConfig ? JSON.parse(themeConfig) : null);
                        UI.renderHoloStream();
                        UI.renderView('auth');
                        Logic.initFixedBottomUI();
                    } catch(e) {
                        console.error("Critical Initialization Failure:", e);
                        UI.init();
                        Utils.showNotification('Failed to load critical market data. Platform functionality will be limited.', 'error');
                        UI.renderView('auth');
                    }
                },
                bindEventListenersForView: (viewName) => {
                    if (viewName === 'auth') {
                        document.getElementById('login-btn')?.addEventListener('click', Logic.logIn);
                        document.getElementById('show-signup-btn')?.addEventListener('click', Logic.showOnboarding);
                    }
                    if (viewName === 'role_select') {
                        document.getElementById('role-remit')?.addEventListener('click', () => Logic.selectRole('remit'));
                        document.getElementById('role-pay')?.addEventListener('click', () => Logic.selectRole('pay'));
                    }
                    if (viewName === 'tx_wizard') {
                        document.getElementById('confirm-destination-btn')?.addEventListener('click', Logic.confirmDestinationStep);
                        document.getElementById('add-beneficiary-btn')?.addEventListener('click', Logic.showAddBeneficiary);
                    }
                },
                logIn: async () => { /* ... Full login logic ... */ },
                showOnboarding: (e) => { e.preventDefault(); AppState.ui.onboardingStep = 1; Utils.openModal(ComponentBuilders.renderOnboardingModal(), {maxWidth: '40rem'}); /* Add event listeners for modal buttons */},
                selectRole: async (roleType) => {
                    Utils.showNotification('Initializing secure transaction environment...', 'info');
                    try {
                        const beneficiaries = await Utils.createApiRequest('getBeneficiaries', 'POST', { ownerKaravanId: AppState.currentUser.karavanId });
                        AppState.marketData.beneficiaries = beneficiaries;
                        AppState.transaction = {
                            details: { type: roleType, fromCurrency: 'SGD', toCurrency: 'PHP', amount: roleType === 'remit' ? 500 : 25000, amountType: 'send', recipientId: beneficiaries[0]?.id || null, invoiceRef: '' },
                            steps: { destination: { isComplete: false, data: {} }, cargo: { isComplete: false, data: {} }, dispatch: { isComplete: false, data: {} } },
                            activeStep: 'destination',
                            quote: null
                        };
                        UI.renderView('tx_wizard');
                    } catch(error) {
                        Utils.showNotification(`Initialization failed: ${error.message}`, 'error');
                        UI.renderView('role_select');
                    }
                },
                setActiveStep: (stepName) => {
                    const { transaction } = AppState;
                    const stepOrder = ['destination', 'cargo', 'dispatch'];
                    const currentStepIndex = stepOrder.indexOf(stepName);
                    const prevStepName = currentStepIndex > 0 ? stepOrder[currentStepIndex-1] : null;

                    if(prevStepName && !transaction.steps[prevStepName].isComplete) {
                        Utils.showNotification('Please complete the previous step to proceed.', 'warning');
                        return;
                    }
                    transaction.activeStep = stepName;
                    UI.renderView('tx_wizard');
                },
                confirmDestinationStep: () => {
                    const { transaction } = AppState;
                    const recipientId = document.getElementById('recipient-select')?.value;
                    if(!recipientId) { Utils.showNotification('Please select a beneficiary.', 'error'); return; }
                    
                    transaction.steps.destination.data = { recipientId };
                    
                    if (transaction.details.type === 'pay') {
                        const invoiceRef = document.getElementById('invoice-ref')?.value;
                        if (!invoiceRef) { Utils.showNotification('Invoice reference is mandatory for B2B payments.', 'error'); return; }
                        transaction.steps.destination.data.invoiceRef = invoiceRef;
                    }

                    transaction.steps.destination.isComplete = true;
                    Logic.setActiveStep('cargo');
                },
                showAddBeneficiary: () => { /* ... show modal for adding beneficiary ... */},
                initFixedBottomUI: () => {
                    const holoStream = document.getElementById('holo-stream-container');
                    const body = document.body;
                    if (!holoStream || !body) return;
                    const observer = new ResizeObserver(entries => {
                        body.style.paddingBottom = `${entries[0].contentRect.height}px`; 
                    });
                    observer.observe(holoStream);
                },
                // ========================================================================
                // === INSTITUTIONAL ASSET SWAP LOGIC (Benchmark Standard from toolkits.html) ===
                // ========================================================================
                calculateAssetSwap: () => {
                    const { amount, fromAssetKey, toAssetKey } = AppState.transaction.steps.cargo.data; // Now reads from correct state path
                    const fromAsset = Utils.getAssetByKey(fromAssetKey);
                    const toAsset = Utils.getAssetByKey(toAssetKey);
                    const amountToGive = parseFloat(String(amount).replace(/,/g, '')) || 0;
                    const usdEquivalent = amountToGive * (fromAsset.price || 0);
                    const directRate = (toAsset.price > 0) ? (fromAsset.price || 0) / toAsset.price : 0;
                    const primaryValue = amountToGive * directRate;
                    return { primaryValue, primaryUnit: toAsset.baseAsset, usdEquivalent, fromAsset, toAsset, directRate };
                },
            };

            // This line is critical for the Asset Swap UI from toolkits.html to function
            // as it might be called from inline `onclick` attributes.
            window.Logic = Logic;
            
            // --- Final Initialization ---
            document.addEventListener('DOMContentLoaded', Logic.init);
        })();
    </script>
</body>
</html>
