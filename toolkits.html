<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v4.0 (BENCHMARKED & UNIFIED) === */
        /* This stylesheet is the definitive standard for the Toolkits page, */
        /* ensuring visual consistency with the entire GECAN platform. */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
            --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        body.mobile-sidebar-open { overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
        .logo-back { transform: rotateY(180deg); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
        @keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
        @keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }

        /* BENCHMARKED NAVIGATION & MOBILE MENU */
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }
        @keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }
        
        #mobile-sidebar.left-0 { transform: translateX(0); }
        .mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
        .mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
        @media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }

        /* --- D. TOOLKIT-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        /* Universal Glass Container */
        .glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        /* Universal Buttons */
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
        /* Universal Forms */
        /* ========================================================================= */
/* === DEFINITIVE FORM STYLES (PINNACLE STANDARD v5.2 - TEXT COLOR FIX) === */
/* This is the SINGLE SOURCE OF TRUTH for all form elements. */
/* ========================================================================= */

.form-input, .form-select {
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
    /* DEFINITIVE TEXT COLOR FIX: Ensures text is always bright white */
    color: var(--text-primary); 
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    width: 100%;
    font-size: 1rem;
    transition: all 0.3s ease;
    appearance: none;
    /* CRITICAL FOR CHROME AUTOFILL: Overrides the browser's default text color */
    -webkit-text-fill-color: var(--text-primary);
    box-shadow: inset 0 0 0 30px var(--background-light); /* Prevents autofill background color change */
}

.form-input::placeholder {
    color: var(--text-muted);
    opacity: 1; /* Ensure placeholder is visible */
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-azure);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25), inset 0 0 0 30px var(--background-secondary);
    background-color: var(--background-secondary); /* Darken on focus for contrast */
}

/* Readonly styles for a premium, disabled look */
.form-input:read-only {
    background-color: var(--background-dark);
    color: var(--text-muted);
    cursor: not-allowed;
    box-shadow: none;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}
        /* Toolkit Content Cards */
        .report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
        .report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(-2px); }
        .gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes float { 50% { transform: translateY(-8px); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .animate-scale-in { animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

        /* Wallet Forensics Report Specific Styles */
        .risk-LOW { --risk-color: var(--success-color); } .risk-MEDIUM { --risk-color: var(--warning-color); }
        .risk-HIGH { --risk-color: var(--error-color); } .risk-CRITICAL { --risk-color: var(--critical-color); }
        .text-risk-color { color: var(--risk-color); } .border-risk-color { border-color: var(--risk-color); } .bg-risk-color { background-color: var(--risk-color); }
        .score-gauge-bg { stroke: var(--background-secondary); stroke-width: 2.5; }
        .score-gauge-fg { stroke-width: 3.5; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); transition: stroke-dasharray 1.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .gauge-low { color: var(--success-color); } .gauge-medium { color: var(--warning-color); }
        .gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 20px; border-left: 2px solid var(--border-color); }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--background-secondary); display: grid; place-items: center; }
        .timeline-dot-inner { width: 8px; height: 8px; border-radius: 50%; }

        /* Institutional Modeler Specific Styles */
        .deal-type-card { background: var(--background-glass); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s ease; text-align: left; }
        .deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-azure); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
        .deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.05); }
        .deal-type-icon { transition: all 0.3s ease; } .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
        @keyframes icon-glow-rotate { 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }
        
        .output-metric-card { background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
        .output-metric-card .label { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .output-metric-card .value { font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .output-metric-card .sub-value { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
        .output-metric-card.base-value .value { color: var(--primary-azure); } .output-metric-card.net .value { color: var(--success-color); } .output-metric-card.commission .value { color: var(--warning-color); }
        
        /* IMFPA/NCNDA Modal Styles */
        #imfpa-modal-content { border: 1px solid var(--border-premium); box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75), 0 0 0 1px rgba(139, 92, 246, 0.2); background: linear-gradient(180deg, var(--background-light) 0%, var(--background-primary) 100%); }
        .imfpa-section-title { font-family: 'Orbitron', monospace; font-size: 1.25rem; font-weight: bold; color: var(--text-diamond); }
        .allocation-group-card { background: var(--background-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
        .allocation-party-card { background: var(--background-light); border: 1px solid var(--border-secondary); border-radius: 0.75rem; padding: 0.75rem; }
        .party-details-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.75rem; padding-top: 1rem; margin-top: 0.75rem; border-top: 1px solid var(--border-secondary); }
        .party-detail-label { font-size: 0.65rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s ease; }
        .collapsible-content.expanded { grid-template-rows: 1fr; }
        .collapsible-content > div { overflow: hidden; }

        /* Dialog & Modal Base Styles */
       /* ========================================================================= */
/* === DEFINITIVE MODAL & FORM STYLES (PINNACLE STANDARD v5.1) === */
/* This is the SINGLE SOURCE OF TRUTH for all dialogs and modals. */
/* REMOVE ALL OTHER 'dialog' STYLES TO PREVENT CONFLICTS. */
/* ========================================================================= */

/* --- A. UNIVERSAL DIALOG & BACKDROP STYLES (POSITIONING FIX) --- */
dialog {
    /* Base resets */
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    overflow: visible !important;
    max-width: 90vw; /* Responsive max-width */
    width: auto;
}

/* The [open] state is the key to perfect centering */
dialog[open] {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: fixed !important; 
    inset: 0 !important; 
    animation: modal-backdrop-fade-in 0.5s ease forwards;
    z-index: 200 !important; /* Highest z-index */
}

dialog::backdrop {
    background: rgba(5, 5, 9, 0.85) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    animation: modal-backdrop-fade-in 0.5s ease forwards;
}

/* --- B. DIALOG CONTENT WRAPPER --- */
/* This is the visible modal box that gets centered by the parent dialog */
.dialog-content-wrapper {
    background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
    border: 1px solid var(--border-premium) !important;
    box-shadow: var(--shadow-quantum) !important;
    border-radius: 1.5rem !important;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* --- C. SPECIFIC MODAL WIDTHS --- */
/* Control the width of specific modals by targeting their ID */
#imfpa-modal { max-width: 80vw !important; }
#submission-modal { max-width: 640px !important; }
#signature-modal { max-width: 560px !important; }


/* --- D. KEYFRAME ANIMATIONS --- */
@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}
@keyframes scaleIn { 
    from { opacity: 0; transform: scale(0.95); } 
    to { opacity: 1; transform: scale(1); } 
}

        @keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* ========================================================================= */
/* === DEFINITIVE FORM TEXT & LEGEND STYLES (PINNACLE STANDARD v5.4) === */
/* This block specifically targets form labels and legends for perfect text color. */
/* ========================================================================= */

/* --- A. Fieldset & Legend Enhancement --- */
fieldset {
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem;
    position: relative; /* Required for legend positioning */
    margin-top: 1rem; /* Add space for the legend */
}

legend {
    /* Styling for "Transaction Context", "Your Details", etc. */
    padding: 0 0.5rem; /* Horizontal padding */
    margin-left: 0.5rem; /* Indent from the left edge */
    font-size: 1.125rem; /* 18px for better hierarchy */
    font-weight: 600; /* Semibold */
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--primary-azure);
    
    /* Ensures it sits correctly on top of the fieldset border */
    position: relative;
    top: -0.5rem;
    display: inline-block;
    width: auto;
}

/* --- B. Label Enhancement --- */
label.form-label,
/* Target labels within the submission form specifically for robustness */
#wallet-submission-form label {
    display: block;
    margin-bottom: 0.25rem; /* 4px space below the label */
    font-size: 0.875rem; /* 14px */
    font-weight: 500; /* Medium weight */
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-platinum); /* Use a slightly softer white for labels for better contrast against pure white input text */
}

/* --- C. Recommendation Box Text Enhancement --- */
.recommendation-box {
    margin-top: 1rem;
    padding: 1rem;
    background-color: rgba(245, 158, 11, 0.05); /* --warning-color with low opacity */
    border-left: 4px solid var(--warning-color);
    border-radius: 0 0.5rem 0.5rem 0;
}

.recommendation-box h4 {
    font-weight: 600;
    color: var(--warning-color);
}

.recommendation-box p {
    font-size: 0.875rem;
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-secondary); /* A clear, readable grey */
    margin-top: 0.25rem;
}

.recommendation-box strong {
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-diamond); /* Pure white for emphasis */
    font-weight: 600;
}

/* ========================================================================= */
/* === PINNACLE SUBMISSION SUITE ENGINE v2.0 (ISOLATED & HARDENED) === */
/* This is the definitive, self-contained style block that governs ONLY */
/* the #submission-modal for conflict-free, pinnacle-grade performance. */
/* ========================================================================= */

/* --- A. MODAL CONTAINER & CENTERING --- */
#submission-modal {
    max-width: 640px;
    width: calc(100% - 2rem);
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    overflow: visible !important;
}

#submission-modal[open] {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: fixed !important; 
    inset: 0 !important; 
    animation: submission-backdrop-fade-in 0.5s ease forwards;
    z-index: 200 !important;
}

#submission-modal::backdrop {
    background: rgba(10, 10, 15, 0.85) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    animation: submission-backdrop-fade-in 0.5s ease forwards;
}

/* --- B. MODAL CONTENT WRAPPER --- */
#submission-modal .submission-dialog-content {
    background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
    border: 1px solid var(--border-premium) !important;
    box-shadow: var(--shadow-quantum) !important;
    border-radius: 1.5rem !important;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: submission-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* --- C. HARDENED FORM STYLES (ISOLATED) --- */
#submission-modal .submission-form-input, 
#submission-modal .submission-form-select {
    background-color: var(--background-dark) !important;
    border: 1px solid var(--border-secondary) !important;
    color: var(--text-primary) !important; 
    border-radius: 0.75rem !important;
    padding: 0.75rem 1rem !important;
    width: 100% !important;
    font-size: 1rem !important;
    transition: all 0.3s ease !important;
    appearance: none !important;
    -webkit-text-fill-color: var(--text-primary) !important;
    box-shadow: inset 0 0 0 50px var(--background-dark) !important;
}

#submission-modal input:-webkit-autofill, 
#submission-modal input:-webkit-autofill:hover, 
#submission-modal input:-webkit-autofill:focus, 
#submission-modal input:-webkit-autofill:active {
    -webkit-text-fill-color: var(--text-primary) !important;
    box-shadow: inset 0 0 0 50px var(--background-dark) !important;
    caret-color: var(--text-primary) !important;
}

#submission-modal .submission-form-input::placeholder { color: var(--text-muted) !important; opacity: 1 !important; }
#submission-modal .submission-form-input:focus, 
#submission-modal .submission-form-select:focus { 
    outline: none !important; 
    border-color: var(--primary-azure) !important; 
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary) !important; 
    background-color: var(--background-secondary) !important; 
}

#submission-modal .submission-form-input:read-only { 
    background-color: var(--background-dark) !important; 
    color: var(--text-muted) !important; 
    cursor: not-allowed !important; 
    border-style: dashed; 
}

#submission-modal .submission-form-select { 
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; 
    background-position: right 0.75rem center !important; 
    background-repeat: no-repeat !important; 
    background-size: 1.5em 1.5em !important; 
    padding-right: 2.5rem !important; 
}

/* --- D. HARDENED TEXT & LAYOUT STYLES (ISOLATED) --- */
#submission-modal h2 { color: var(--text-diamond) !important; }
#submission-modal p { color: var(--text-secondary) !important; }
#submission-modal fieldset { border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; position: relative; margin-top: 1rem; }
#submission-modal legend { padding: 0 0.5rem; margin-left: 0.5rem; font-size: 1.125rem; font-weight: 600; color: var(--primary-azure) !important; background: var(--background-light); position: relative; top: -0.5rem; display: inline-block; width: auto; }
#submission-modal label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-platinum) !important; }
#submission-modal .recommendation-box { margin-top: 1rem; padding: 1rem; background-color: rgba(245, 158, 11, 0.05); border-left: 4px solid var(--warning-color); border-radius: 0 0.5rem 0.5rem 0; }
#submission-modal .recommendation-box h4 { font-weight: 600; color: var(--warning-color) !important; }
#submission-modal .recommendation-box p { font-size: 0.875rem; color: var(--text-secondary) !important; margin-top: 0.25rem; }
#submission-modal .recommendation-box strong { color: var(--text-diamond) !important; font-weight: 600; }
#submission-modal #referral-error { color: var(--error-color) !important; }

/* --- E. KEYFRAME ANIMATIONS --- */
@keyframes submission-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes submission-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

/* =================================================================================== */
/* === G. PINNACLE NCNDA/IMFPA & DOCUMENT EXECUTION SUITE CSS (v9.0 SEVERE OVERHAUL) === */
/* =================================================================================== */

/* --- A. PREMIUM MODAL ENVIRONMENT (FLAWLESS CENTERING & PRESTIGE PALETTE) --- */
#imfpa-modal .dialog-content-wrapper {
    --premium-gold: #D4AF37; --premium-gold-glow: rgba(212, 175, 55, 0.4);
    --premium-bg-dark: #0a0f1c; --premium-bg-light: #161d31; --premium-border: #2a3552;
    --premium-text-primary: #f0f4ff; --premium-text-secondary: #a0aec0;
    
    background: radial-gradient(circle at top left, var(--premium-bg-light), var(--premium-bg-dark) 70%);
    border: 1px solid var(--premium-border); 
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.75), 0 0 0 1px var(--premium-gold-glow);
    color: var(--premium-text-primary);
}

#contract-live-preview {
    background-color: #fcfcff; color: #1a202c; font-family: 'Garamond', 'Times New Roman', serif;
    border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--premium-border);
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.2); overflow-y: auto; transition: all 0.3s ease;
}
.preview-h1 { font-size: 1.2rem; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 0.5rem; margin-bottom: 1rem; }
.preview-p { font-size: 0.9rem; line-height: 1.6; text-align: justify; margin-bottom: 1rem; }
.preview-strong { font-weight: bold; color: #283593; }

/* --- B. HIGH-CONTRAST, PREMIUM FORM ELEMENTS --- */
#imfpa-modal .form-input, #imfpa-modal .form-select {
    background-color: var(--premium-bg-dark) !important; border: 1px solid var(--premium-border) !important;
    color: var(--premium-text-primary) !important; box-shadow: none !important; transition: all 0.3s ease;
}
#imfpa-modal .form-input:focus, #imfpa-modal .form-select:focus {
    border-color: var(--premium-gold) !important; box-shadow: 0 0 0 3px var(--premium-gold-glow) !important;
    background-color: var(--premium-bg-light) !important;
}

/* --- C. INTELLIGENT AGREEMENT TOGGLE (3D ANIMATION) --- */
.agreement-toggle { display: flex; align-items: center; cursor: pointer; user-select: none; }
.toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; transform-style: preserve-3d; transition: transform 0.3s ease; }
.toggle-switch:hover { transform: scale(1.05); }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--premium-border); transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
.toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
input:checked + .toggle-slider { background-color: var(--premium-gold); box-shadow: 0 0 15px var(--premium-gold-glow); }
input:checked + .toggle-slider:before { transform: translateX(26px); }
.toggle-label { font-weight: 700; transition: all 0.4s; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.toggle-label.active { color: var(--premium-gold); transform: scale(1.05); }

/* --- D. AESTHETIC & HIERARCHICAL UPGRADES (ANIMATED ICONS) --- */
.imfpa-header h2 { font-family: 'Orbitron', monospace; background: linear-gradient(90deg, var(--premium-text-primary), var(--premium-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: flicker 5s linear infinite; }
@keyframes flicker { 0%, 100% { opacity: 1; text-shadow: 0 0 5px var(--premium-gold-glow); } 50% { opacity: 0.9; text-shadow: 0 0 15px var(--premium-gold-glow); } }
.imfpa-section-title { font-size: 1.25rem; font-weight: 700; color: var(--premium-text-primary); border-left: 3px solid var(--premium-gold); padding-left: 1rem; margin-bottom: 1.5rem; }
.imfpa-section-title i { animation: icon-pulse 3s infinite ease-in-out; }
@keyframes icon-pulse { 50% { transform: scale(1.1); color: var(--premium-gold); } }

/* --- E. PREMIUM, INTERACTIVE ALLOCATION CARDS (3D HOVER) --- */
.allocation-group-card {
    background: linear-gradient(145deg, var(--premium-bg-light), var(--premium-bg-dark));
    border: 1px solid var(--premium-border); border-radius: 1rem; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative; overflow: hidden; perspective: 1000px;
}
.allocation-group-card:before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at 100% 100%, transparent, var(--premium-gold-glow) 250%);
    opacity: 0; transition: opacity 0.5s; pointer-events: none;
}
.allocation-group-card:hover {
    transform: translateY(-8px) rotateX(5deg) scale(1.03); border-color: var(--premium-gold);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6), 0 0 25px var(--premium-gold-glow);
}
.allocation-group-card:hover:before { opacity: 1; }
.allocation-party-card { background: rgba(0,0,0,0.3); border: 1px solid var(--premium-border); border-radius: 0.75rem; transition: all 0.3s; }
.allocation-party-card:hover { background-color: var(--premium-bg-light); border-color: var(--premium-text-secondary); transform: translateX(4px); }

/* --- F. CONTRACT PREVIEW & EXECUTION SUITE --- */
#contract-preview-container { animation: fadeInUp 0.5s ease-out; }
#execution-suite { background: var(--background-glass); border: 1px solid var(--border-premium); border-radius: 1.5rem; padding: 1.5rem; margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
#execution-suite .step-panel { background: rgba(var(--rgb-color, 59, 130, 246), 0.1); border: 1px solid rgba(var(--rgb-color, 59, 130, 246), 0.2); border-left: 4px solid rgb(var(--rgb-color, 59, 130, 246)); border-radius: 1rem; padding: 1.25rem; text-align: center; transition: all 0.3s ease; }
#execution-suite .step-panel.step-1 { --rgb-color: 59, 130, 246; }
#execution-suite .step-panel.step-2 { --rgb-color: 139, 92, 246; }
.step-panel h4 { color: rgb(var(--rgb-color)); font-weight: 700; font-size: 1.125rem; }
.execution-btn { background: linear-gradient(135deg, rgb(var(--rgb-color)), rgba(var(--rgb-color), 0.7)); border: 1px solid rgb(var(--rgb-color)); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(var(--rgb-color), 0.2); padding: 0.75rem 1.5rem; font-weight: 700; border-radius: 0.75rem; }
.execution-btn:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(var(--rgb-color), 0.4); transform: translateY(-3px); }

/* --- G. GENERATED CONTRACT DOCUMENT --- */
#contract-document-wrapper { background: #f8fafc; border-radius: 1rem; padding: 1rem; margin-top: 1.5rem; max-height: 70vh; overflow-y: auto; box-shadow: inset 0 2px 10px rgba(0,0,0,0.1); }
.contract-document { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.5; color: #1a202c; background: white; padding: 2cm; margin: 0 auto; max-width: 21cm; min-height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }

/* --- H. SIGNATURE & FINALIZATION SUITES (PREMIUM SPINNING ICON) --- */
#finalization-icon-container { background: linear-gradient(135deg, var(--primary-amethyst), var(--primary-royal)); animation: pulse-glow 3s ease-in-out infinite; }
@keyframes pulse-glow { 50% { transform: scale(1.05); box-shadow: 0 0 35px var(--glow-amethyst); } }
.btn-spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.75s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- I. PINNACLE PRINTING STYLES --- */
#print-area { display: none; }
@media print {
    .print-hide { display: none !important; }
    #print-area { display: block !important; }
    body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0 !important; padding: 0 !important; }
    @page {
        size: A4; margin: 2cm;
        @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @top-right { content: "GECAN™ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
    }
    .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; }
    .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
    .p-text { text-align: justify; margin-bottom: 11pt; }
    .p-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
    .p-table th, .p-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
    .p-table th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
    .p-table tr:nth-child(even) td { background-color: #f9f9f9; }
    .p-signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; }
    .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
    .p-signature-label { font-size: 9pt; color: #555; }
    .p-signature-img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
    .p-seal-img { max-height: 80px; max-width: 80px; object-fit: contain; mix-blend-mode: darken; }
    .p-annex-start { page-break-before: always; }
    .p-watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
}
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECAN™ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & CORRECTED) -->
<header class="premium-header p-4 lg:px-6 print-hide">
    <div class="container mx-auto flex items-center justify-between gap-6">
        <div class="flex items-center gap-6 flex-shrink-0">
            <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                <div class="gecan-logo-flipper">
                    <div class="logo-face logo-front">GECAN™</div>
                    <div class="logo-face logo-back">
                        <!-- Placeholder for Base64 image -->
                        <img src="" alt="GECAN Logo">
                    </div>
                </div>
                <div class="logo-separator"></div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                    <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                </div>
            </a>
        </div>
        <!-- DEFINITIVE FIX: The navigation placeholder is restored here -->
        <div id="desktop-nav-placeholder" class="flex-grow">
            <!-- Navigation will be dynamically injected by JavaScript -->
        </div>
    </div>
</header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    

    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FIX: RESTORE THE SUBMISSION MODAL CONTAINER === -->
    <!-- This is the container the JavaScript is trying to open. -->
    <!-- ========================================================================= -->
    <dialog id="submission-modal"></dialog>
    
    <!-- PREMIUM FOOTER (BENCHMARKED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECAN™ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECAN™ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- MODAL & DIALOG CONTAINERS -->
    <dialog id="imfpa-modal" class="p-0 bg-transparent max-w-7xl w-full print-hide"></dialog>
    <!-- II. RE-ENGINEERED MODAL HTML CONTAINERS (ADD THESE TO YOUR MAIN HTML BODY) -->
<dialog id="signature-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="signature-modal-content" class="text-white flex-grow flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-[var(--border-premium)] flex-shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                        <p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p>
                    </div>
                    <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">×</button>
                </div>
                <div>
                    <label for="signature-target-select" class="block text-sm font-semibold text-text-secondary mb-2">Apply signature/seal for:</label>
                    <select id="signature-target-select" class="form-select w-full"></select>
                </div>
            </div>

            <!-- Signing Area -->
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex border-b border-[var(--border-premium)] mb-4">
                    <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                    <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                    <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
                </div>
                <!-- Panels -->
                <div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
                <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div>
                <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex-shrink-0">
                <div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div>
                <button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button>
            </div>
        </div>
    </div>
</dialog>

    
    <!-- ==================================================================================== -->
<!-- === DEFINITIVE NOTIFICATION MODAL (v5.1 - UNIVERSAL REPLACEMENT) === -->
<!-- This is the complete, benchmark-standard modal required for all platform notifications. -->
<!-- ==================================================================================== -->
<dialog id="notification-modal" class="p-0 bg-transparent max-w-lg w-full print-hide">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="notification-modal-content" class="text-white flex flex-col">
            <!-- Dynamic Header: Color changes based on message type -->
            <div id="notification-header" class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)]">
                <div id="notification-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400">
                    <i id="notification-icon" class="fas fa-2x"></i>
                </div>
                <div>
                    <h2 id="notification-title" class="text-2xl font-bold">Notification</h2>
                    <p id="notification-subtitle" class="text-sm text-text-secondary">Please review this message.</p>
                </div>
            </div>

            <!-- Dynamic Content -->
            <div class="p-8 flex-grow">
                <p id="notification-message" class="text-text-secondary leading-relaxed">Message content goes here.</p>
            </div>
            
            <!-- Footer & Action -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end">
                <button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg">OK</button>
            </div>
        </div>
    </div>
</dialog>
   
    
    <dialog id="finalization-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="finalization-modal-content" class="flex flex-col text-white">
             <!-- Header -->
            <div class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)] bg-[var(--background-dark)]/50">
                <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Finalize & Lock Document</h2>
                    <p class="text-sm text-text-secondary">Please confirm this critical, irreversible action.</p>
                </div>
                 <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors ml-auto">×</button>
            </div>
            <!-- Content -->
            <div class="p-8 flex-grow">
                <p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action will:</p>
                <ul class="space-y-4 text-text-primary">
                    <li class="flex items-start gap-3"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Lock Document State:</strong> The current version will be cryptographically fingerprinted to prevent edits.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-project-diagram text-purple-400 mt-1"></i><div><strong>Generate Secure Audit Trail:</strong> An immutable record will be created for all actions.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-paper-plane text-purple-400 mt-1"></i><div><strong>Dispatch to All Parties:</strong> A finalized PDF will be emailed to all signatories.</div></li>
                </ul>
            </div>
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end items-center gap-4">
                <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-red-500/30 px-8 py-2 font-bold shadow-lg shadow-purple-500/20"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button>
            </div>
        </div>
    </div>
</dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
<div id="print-area"></div>

    <script>
        // ====================================================================================
        // === PINNACLE SCRIPT ENGINE v4.0 (BENCHMARKED, RE-ARCHITECTED, & UNABRIDGED) ===
        // This engine is the definitive, production-grade standard for the Toolkits page.
        // ====================================================================================
        
        const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";
        
        // ====================================================================================
        // === SECTION 1: STATE & MODELS (v4.0 - DEFINITIVE & SEVERELY ENHANCED) ===
        // ====================================================================================
        const AppState = {
            isInitialized: false, 
            activeToolkit: 'Dashboard', 
            marketData: [],

            toolkits: {
                Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECAN™ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
                WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Execute advanced on-chain due diligence, risk assessment, and provenance analysis.', color: 'from-sky-500 to-indigo-600' },
                InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
            },
            walletAnalysis: { address: null, report: null, isLoading: false },
            modeler: {
                activeDealType: 'AssetSwap', 
                assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
                commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: '• Standard TTV Procedures\n• SGS/Intertek Inspection\n• Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' },
                cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                sblcMonetization: { faceValue: 100000000, ltv: 80 },
                pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                legal: { totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }
            }
        };

        const commodityData = {
            unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
            incoterms: [
                { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' }, { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
                { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' }, { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
                { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
                { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
            ],
            countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
            ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
        };

        // ====================================================================================
        // === SECTION 2: UTILITIES (v4.0 - DEFINITIVE & BENCHMARKED) ===
        // ====================================================================================
        const Utils = {
            showNotification: (message, type = 'info', title = null) => {
    const modal = document.getElementById('notification-modal');
    if (!modal) {
        console.error("Notification modal not found in DOM!");
        // Fallback for critical errors when the modal itself is missing.
        alert(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
        return;
    }

    const content = document.getElementById('notification-modal-content');
    const header = document.getElementById('notification-header');
    const iconContainer = document.getElementById('notification-icon-container');
    const icon = document.getElementById('notification-icon');
    const titleEl = document.getElementById('notification-title');
    const subtitleEl = document.getElementById('notification-subtitle');
    const messageEl = document.getElementById('notification-message');
    const okBtn = document.getElementById('notification-ok-btn');

    // A single source of truth for notification types.
    const types = {
        success: { iconClass: 'fa-check-circle', defaultTitle: 'Success', subtitle: 'The operation completed successfully.', baseClass: 'green' },
        error: { iconClass: 'fa-exclamation-triangle', defaultTitle: 'Error', subtitle: 'An error has occurred.', baseClass: 'red' },
        warning: { iconClass: 'fa-exclamation-circle', defaultTitle: 'Warning', subtitle: 'Please review this message.', baseClass: 'yellow' },
        info: { iconClass: 'fa-info-circle', defaultTitle: 'Information', subtitle: 'System Notification.', baseClass: 'blue' }
    };

    const config = types[type] || types.info;

    // Apply dynamic content
    titleEl.textContent = title || config.defaultTitle;
    subtitleEl.textContent = config.subtitle;
    messageEl.textContent = message;
    icon.className = `fas ${config.iconClass} fa-2x`;

    // Apply dynamic styling using Tailwind classes for consistency and maintainability.
    const colorClasses = {
        header: `bg-${config.baseClass}-500/10 border-${config.baseClass}-500/20`,
        icon: `bg-gradient-to-br from-${config.baseClass}-400 to-${config.baseClass}-600`,
        button: `bg-gradient-to-r from-${config.baseClass}-500 to-${config.baseClass}-700 border-${config.baseClass}-500`
    };

    // Remove old color classes before adding new ones
    header.className = `p-6 flex items-center gap-4 border-b ${colorClasses.header}`;
    iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400 ${colorClasses.icon}`;
    okBtn.className = `btn-primary px-8 py-2 font-bold shadow-lg ${colorClasses.button}`;
    
    // Attach a one-time event listener to the OK button to close the modal.
    okBtn.onclick = () => modal.close();
    
    // Show the modal.
    if (!modal.hasAttribute('open')) {
        modal.showModal();
    }
},
            formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
            formatNumber: (num, decimals = 2) => {
                if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
                if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
                return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            },
            debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
            getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
            getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
            getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
            calculateTimeAgo: (timestamp) => {
                const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Just now'; if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`;
                return new Date(timestamp).toLocaleDateString();
            }
        };

        // ====================================================================================
        // === SECTION 3: CORE LOGIC CONTROLLER (v4.0 - DEFINITIVE & UNABRIDGED) ===
        // ====================================================================================
        const Logic = {
            createApiRequest: async (action, method = 'GET', params = {}) => {
                const url = new URL(API_URL); url.searchParams.append('action', action);
                const options = { method: method.toUpperCase(), redirect: 'follow' };
                if (options.method === 'GET') { Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v)); } 
                else { options.body = JSON.stringify({ action, data: params }); options.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                    const result = await response.json();
                    if (result.success === false) throw new Error(result.error || 'Server error.');
                    return result.data || result.message || result;
                } catch (error) { console.error(`API Error for '${action}':`, error); throw error; }
            },

            init: async () => {
    UI.init();
    // DEFINITIVE FIX: Restore the call to populate navigation links on page load.
    UI.populateNavLinks(); 
    Logic.initMobileUI();
    Logic.setupEventListeners();
    try {
        const [marketData, themeJson] = await Promise.all([
            Logic.createApiRequest('getMarketMatrixData'),
            Logic.createApiRequest('getActiveThemeConfig').catch(() => null)
        ]);
        if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) {} }
        if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
        AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
        const swappable = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
        if (swappable.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = swappable[0].key; AppState.modeler.assetSwap.toAssetKey = swappable[1].key; }
        
        AppState.isInitialized = true;
        document.getElementById('initial-loader').style.display = 'none';
        UI.renderActiveToolkit();
    } catch (err) { Logic.onDataError(err); }
},
            onDataError: (error) => {
                console.error("CRITICAL FAILURE:", error);
                Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
                document.getElementById('initial-loader').innerHTML = `<div class="text-center text-red-400">Platform Initialization Failed.</div>`;
            },
            initMobileUI: () => {
    const fab = document.getElementById('mobile-fab'), 
          sidebar = document.getElementById('mobile-sidebar'), 
          overlay = document.getElementById('mobile-sidebar-overlay'), 
          closeBtn = document.getElementById('mobile-sidebar-close-btn');
          
    const openSidebar = () => { 
        // DEFINITIVE FIX: Ensure nav links are populated every time the mobile menu is opened.
        UI.populateNavLinks(); 
        sidebar.classList.remove('-left-full'); 
        sidebar.classList.add('left-0'); 
        overlay.classList.remove('hidden'); 
        document.body.classList.add('mobile-sidebar-open'); 
    };
    const closeSidebar = () => { 
        sidebar.classList.add('-left-full'); 
        sidebar.classList.remove('left-0'); 
        overlay.classList.add('hidden'); 
        document.body.classList.remove('mobile-sidebar-open'); 
    };
    
    fab.addEventListener('click', openSidebar); 
    overlay.addEventListener('click', closeSidebar); 
    closeBtn.addEventListener('click', closeSidebar);
},
            setupEventListeners: () => {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'WalletForensics','3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } }
                });
            },
            setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
            bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
            
            // --- Wallet Forensics Logic (Unabridged) ---
            // --- Wallet Forensics Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Wallet Forensics toolkit.
 * This function is called once when the toolkit becomes active.
 */
bindWalletForensicsEvents: () => {
    const checkBtn = document.getElementById('check-wallet-btn');
    const addressInput = document.getElementById('wallet-address-input');
    
    // Robustness: Ensure elements exist before binding to prevent runtime errors.
    if(checkBtn) {
        checkBtn.addEventListener('click', Logic.runWalletForensics);
    }
    if(addressInput) {
        addressInput.addEventListener('keypress', e => { 
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission if it's inside a form
                Logic.runWalletForensics(); 
            }
        });
    }
},

/**
 * Orchestrates the entire wallet analysis process, from user input to displaying the final report.
 * It manages application state, provides premium loading feedback, and handles all API communication.
 */
runWalletForensics: () => {
    const addressInput = document.getElementById('wallet-address-input');
    if (!addressInput) return; // Safeguard
    
    const address = addressInput.value.trim();
    if (!address) {
        return Utils.showNotification("Please enter a wallet address to analyze.", 'warning', 'Input Required');
    }
    
    // 1. Set application state to loading and trigger a UI re-render.
    AppState.walletAnalysis = { address, report: null, isLoading: true };
    UI.renderActiveToolkit();

    // 2. Initialize the premium, multi-stage loading text spinner.
    const spinnerTexts = [
        "Connecting to blockchain networks...", 
        "Fetching on-chain transaction history...", 
        "Querying GECAN proprietary intelligence ledger...", 
        "Running institutional compliance checks...", 
        "Synthesizing on-chain and proprietary intel...", 
        "Calculating multi-vector risk scores...", 
        "Generating definitive wallet classification..."
    ];
    let textIndex = 0;
    
    // This interval provides dynamic feedback to the user during the analysis process.
    const textInterval = setInterval(() => {
        const spinnerEl = document.getElementById('spinner-text');
        // The interval only updates the text if the spinner is still visible and the app is loading.
        if (spinnerEl && AppState.walletAnalysis.isLoading) {
            spinnerEl.style.opacity = '0';
            setTimeout(() => { 
                spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; 
                spinnerEl.style.opacity = '1';
            }, 300); // Wait for fade-out before changing text and fading in.
        } else {
            clearInterval(textInterval); // Stop the interval if loading is complete.
        }
    }, 2500);

    // 3. Execute the API request to the backend.
    Logic.createApiRequest('getWalletForensicsReport', 'GET', { address })
        .then(report => {
            // On success, update the state with the complete report.
            AppState.walletAnalysis.report = report;
        })
        .catch(err => {
            // On failure, create a structured error object in the state.
            AppState.walletAnalysis.report = { 
                success: false, 
                error: { message: err.message || 'An unknown analysis error occurred.' } 
            };
        })
        .finally(() => {
            // This block runs regardless of success or failure.
            AppState.walletAnalysis.isLoading = false;
            clearInterval(textInterval); // CRITICAL: Ensure the interval is always cleared.
            UI.renderActiveToolkit(); // Re-render the UI to display the report or error message.
            
            // If the report is successful, trigger the animations for the score gauges.
            if (AppState.walletAnalysis.report && AppState.walletAnalysis.report.success) {
                Logic.animateReportElements();
            }
        });
},

/**
 * Triggers the CSS animation for the SVG score gauges after they are rendered.
 */
animateReportElements: () => {
    // A short delay ensures elements are fully in the DOM before animation starts.
    setTimeout(() => {
        document.querySelectorAll('.score-gauge-fg').forEach(gauge => {
            if (gauge.dataset.score) {
                gauge.style.strokeDasharray = `${gauge.dataset.score}, 100`;
            }
        });
    }, 200);
},

/**
 * Generates the correct block explorer URL for a given wallet type and address/transaction.
 * @param {object} wallet - The wallet object from the report, containing address and type.
 * @param {string} [txHash=''] - An optional transaction hash.
 * @returns {string} The full URL to the block explorer.
 */
getExplorerUrl: (wallet, txHash = '') => {
    if (!wallet || !wallet.type) return '#';
    
    const explorers = {
        BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' },
        ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' },
        TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' }
    };

    const explorer = explorers[wallet.type.toUpperCase()];
    if (!explorer) return '#'; // Fallback for unknown types.

    return txHash ? explorer.tx + txHash : explorer.addr + wallet.address;
},

/**
 * Copies text to the user's clipboard and provides instant visual feedback.
 * @param {string} text - The text to copy.
 * @param {HTMLElement} element - The button element that was clicked, used to find the feedback span.
 */
copyToClipboard: (text, element) => {
    navigator.clipboard.writeText(text).then(() => {
        const feedback = element.querySelector('.copied-feedback');
        if (feedback) {
            feedback.style.opacity = '1';
            setTimeout(() => { feedback.style.opacity = '0'; }, 1500);
        }
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        Utils.showNotification('Could not copy to clipboard.', 'error');
    });
},

/**
 * Generates a dynamic, human-readable executive summary from the raw report data.
 * This is the definitive, pinnacle-grade implementation.
 * @param {object} report - The full report object from the backend.
 * @returns {string} An HTML string containing the formatted summary.
 */
generateExecutiveSummary: (report) => {
    if (!report || !report.analysis || !report.wallet) {
        return '<p class="text-error-color">Could not generate summary due to incomplete report data.</p>';
    }

    const { analysis, wallet, provenance } = report;
    let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="${Utils.getRiskClass(analysis.riskLevel)} text-risk-color">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `;
    
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN' && c.toUpperCase() !== 'CONFIDENTIAL'))];

    if (provenance.records && provenance.records.length > 0) {
        summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `;
        if (uniqueControllers.length > 1) {
            summary += `<strong class="text-critical-color">Critically, it has ${uniqueControllers.length} conflicting alleged controllers: ${uniqueControllers.slice(0, 2).join(', ')}${uniqueControllers.length > 2 ? '...' : ''}.</strong> `;
        } else if (uniqueControllers.length === 1) {
            summary += `A single controller, <strong>${uniqueControllers[0]}</strong>, is consistently reported. `;
        } else {
            summary += `However, no specific controller name is consistently recorded. `;
        }
    } else {
        summary += `There is <strong class="text-error-color">no provenance history</strong> in the GECAN Ledger, making ownership unverifiable. `;
    }

    if (analysis.redFlags && analysis.redFlags.length > 0) {
        const criticalFlagsCount = analysis.redFlags.filter(f => f.level === 'CRITICAL').length;
        if (criticalFlagsCount > 0) {
            summary += `The analysis identified <strong class="text-critical-color">${criticalFlagsCount} CRITICAL flag(s)</strong> requiring immediate attention. `;
        } else {
            summary += `The analysis identified <strong class="text-warning-color">${analysis.redFlags.length} minor flag(s)</strong>. `;
        }
    } else {
        summary += `<strong class="text-success-color">No major compliance flags</strong> were detected during on-chain analysis. `;
    }

    const isCompliant = analysis.redFlags.every(flag => flag.category !== 'INSTITUTIONAL');
    if (wallet.type !== 'BITCOIN') {
        summary += isCompliant
            ? `The wallet <strong class="text-success-color">meets</strong> the GECAN institutional requirements for balance and transaction history. `
            : `The wallet <strong class="text-error-color">does not meet</strong> GECAN institutional requirements. `;
    }
    
    summary += `Final recommendation is to proceed with ${analysis.riskLevel === 'LOW' ? 'standard due diligence' : '<strong>enhanced caution and verification</strong>'}.`;
    return summary;
},

            /**
     * [NEW & SEVERELY UPGRADED] Handles the premium PDF generation and download workflow.
     */
    generateAndDownloadForensicsPDF: () => {
        const btn = document.getElementById('pdf-export-btn');
        if (!btn || btn.disabled) return;

        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating...`;

        const reportData = AppState.walletAnalysis.report;
        if (!reportData || !reportData.success) {
            Utils.showNotification('Error: Could not find valid report data to generate PDF.', 'error');
            btn.disabled = false; btn.innerHTML = originalContent;
            return;
        }

        Logic.createApiRequest('generateWalletForensicsPdf', 'POST', { report: reportData })
            .then(Logic.downloadPdf)
            .catch(error => Utils.showNotification(error.message || 'PDF generation failed.', 'error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    },

    /**
     * [NEW & BENCHMARKED] Helper function to trigger a browser download from Base64 data.
     */
    downloadPdf: (response) => {
        if (!response || !response.pdfData) {
            throw new Error('Failed to receive valid PDF data from server.');
        }
        const link = document.createElement('a');
        link.href = `data:application/pdf;base64,${response.pdfData}`;
        link.download = response.fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        Utils.showNotification('Report downloaded successfully!', 'success');
    },

    /**
     * [NEW & BENCHMARKED] Initiates the first step of the official submission process: the referral ID modal.
     */
    initiateWalletSubmission: () => {
    // Target the correct modal ID. This ID must exist in your HTML body.
    const modal = document.getElementById('submission-modal');
    if (!modal) {
        console.error("CRITICAL FAILURE: The #submission-modal container is missing from the HTML body.");
        Utils.showNotification("UI Error: Cannot open submission suite.", "error");
        return;
    }
    
    // Render the first step (Referral Validation) into the modal.
    modal.innerHTML = UI.renderReferralValidationSuite(
        'Secure Submission Protocol', 
        'A valid Partner Referral ID is required to submit this wallet to the GECAN ledger for official review.'
    );
    
    // Show the modal.
    modal.showModal();
    
    // Attach the event listener to the "Validate" button inside the newly rendered modal.
    document.getElementById('validate-referral-btn').addEventListener('click', Logic.validateSubmissionReferralId);
},


    /**
     * [NEW & BENCHMARKED] Validates the entered referral ID. On success, transitions to the full engagement suite.
     */
    validateSubmissionReferralId: () => {
    const btn = document.getElementById('validate-referral-btn');
    const input = document.getElementById('referral-id-input');
    const errorDiv = document.getElementById('referral-error');
    if (!btn || !input || !errorDiv) return;

    const referralId = input.value.trim();
    if (!referralId) {
        errorDiv.textContent = 'Referral ID cannot be empty.';
        errorDiv.classList.remove('hidden');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';
    Utils.showNotification('Validating Referral ID with GECAN servers...', 'info');

    Logic.createApiRequest('validateReferralId', 'POST', { referralId })
        .then(validationResult => {
            if (validationResult.isValid) {
                Utils.showNotification('Referral ID Validated Successfully!', 'success');
                const modal = document.getElementById('submission-modal');
                // On success, render the full submission suite inside the same modal.
                modal.innerHTML = UI.renderWalletSubmissionSuite(validationResult);
                Logic.populateOfferIdDropdown();
                document.getElementById('wallet-submission-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    Logic.submitWalletForReview(validationResult);
                });
            } else {
                throw new Error('Invalid or inactive Referral ID. Please check the code and try again.');
            }
        })
        .catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key mr-2"></i>Validate & Proceed';
        });
},

            /**
     * [NEW] Fetches the list of active offers and populates the dropdown in the submission form.
     */
    populateOfferIdDropdown: async () => {
        const select = document.getElementById('submission-offer-id');
        if (!select) return;
        try {
            const offers = await Logic.createApiRequest('getOfferListForNcnda', 'GET');
            select.innerHTML = '<option value="GENERAL">General Submission (Not for a specific offer)</option>' +
                offers.map(offer => `<option value="${offer.offerId}">${offer.offerId} - ${offer.description}</option>`).join('');
        } catch (error) {
            console.error("Failed to fetch offer list for submission form:", error);
            select.innerHTML = '<option value="">Error loading offers</option>';
        }
    },
    

    /**
     * [NEW & BENCHMARKED] Gathers all submission form data and sends it to the backend.
     */
    submitWalletForReview: (referralInfo) => {
    const submitBtn = document.getElementById('confirm-submission-btn');
    if (!submitBtn) return;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting to GECAN Compliance...';

    // 1. Gather all data from the detailed form.
    const submissionData = {
        report: AppState.walletAnalysis.report, // Attach the full forensics report.
        referralInfo: referralInfo,
        targetOfferId: document.getElementById('submission-offer-id').value,
        submitter: {
            name: document.getElementById('submitter-name').value,
            role: document.getElementById('submitter-role').value,
            email: document.getElementById('submitter-email').value,
            phone: document.getElementById('submitter-phone').value,
        },
        controller: {
            name: document.getElementById('controller-name').value,
        },
        // In a future version, you could add file processing logic here.
    };

    // 2. DEFINITIVE FIX: Call the new backend API endpoint.
    Logic.createApiRequest('submitWalletForReview', 'POST', submissionData)
        .then(successMessage => {
            // On success, show the confirmation from the server and close the modal.
            Utils.showNotification(successMessage, 'success', 'Submission Sent');
            document.getElementById('submission-modal').close();
        })
        .catch(error => {
            // On failure, show a detailed error message.
            Utils.showNotification(error.message, 'error', 'Submission Failed');
        })
        .finally(() => {
            // Always re-enable the button, regardless of outcome.
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm & Submit to Ledger';
        });
},
            
            // --- Institutional Modeler Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Institutional Modeler toolkit.
 * This function is called once when the toolkit becomes active, using efficient
 * event delegation on the main input container to handle all dynamic changes.
 */
bindInstitutionalModelerEvents: () => {
    Logic.updateModelerUI(true);
    const inputContainer = document.getElementById('modeler-input-container');
    if (inputContainer) {
        inputContainer.addEventListener('input', Utils.debounce((e) => {
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        }, 250));
        inputContainer.addEventListener('change', (e) => { // For selects and radios
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        });
    }
},

/**
 * Handles the logic for switching between different deal types (e.g., Asset Swap, Commodity Trade).
 * It updates the application state and triggers a full re-render of the toolkit UI.
 * @param {string} newDealType - The ID of the toolkit to activate (e.g., 'AssetSwap').
 */
handleDealTypeChange: (newDealType) => {
    if (AppState.modeler.activeDealType === newDealType) return;
    AppState.modeler.activeDealType = newDealType;
    UI.renderActiveToolkit();
},

/**
 * Master handler for all user input within the modeler. It uses a `data-path`
 * attribute on form elements to dynamically and safely update the nested `AppState.modeler` object.
 * @param {Event} e - The input or change event object.
 */
handleModelerInputChange: (e) => {
    const { dataset, value, type, checked } = e.target;
    const path = dataset.path;
    if (!path) return;

    if (path === 'commodityTrade.assetKey') {
        Logic.handleCommodityChange(value);
        return;
    }

    try {
        const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean);
        let targetObject = AppState.modeler;
        for (let i = 0; i < pathKeys.length - 1; i++) {
            targetObject = targetObject[pathKeys[i]];
        }
        const finalKey = pathKeys[pathKeys.length - 1];
        let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
        targetObject[finalKey] = processedValue;
        Logic.updateModelerUI(false);
    } catch (error) {
        console.error(`Failed to update modeler state for path: ${path}`, error);
        Utils.showNotification("An internal error occurred while updating the model.", 'error');
    }
},

/**
 * A specialized handler that triggers when the main commodity asset is changed.
 * It intelligently updates related fields like 'Unit of Measure' to maintain data consistency.
 * @param {string} assetKey - The new commodity asset key (e.g., 'WTI-BBL-USD').
 */
handleCommodityChange: (assetKey) => {
    const commodityState = AppState.modeler.commodityTrade;
    commodityState.assetKey = assetKey;
    const spec = commodityData.specifications[assetKey];
    if (spec) {
        commodityState.unitOfMeasure = spec.uom;
        commodityState.qualitySpec = spec.spec;
        commodityState.incoterms = spec.incoterm;
        commodityState.origin = spec.origin;
    }
    Logic.updateModelerUI(true);
},

/**
 * Placeholder for launching a future deep-dive analysis suite. For now, it provides
 * a premium, user-friendly notification about the feature's status.
 */
launchInstitutionalAnalysis: () => {
    Utils.showNotification(
        `The full Institutional Analysis Suite is in development. This panel will provide deep-dive analytics, counterparty risk assessment, and regulatory compliance checklists for the structured deal.`,
        'info',
        'Feature Coming Soon'
    );
},
            /**
 * Updates the Institutional Modeler's UI. Can perform a full refresh of the input panel
 * or a more performant partial refresh of only the output panel.
 * @param {boolean} [isFullRefresh=false] - If true, re-renders the entire input panel.
 */
updateModelerUI: (isFullRefresh = false) => {
    if (isFullRefresh) {
        const inputContainer = document.getElementById('modeler-input-container');
        if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
    }
    const calculation = Logic.calculateModel();
    const outputContainer = document.getElementById('modeler-output-container');
    if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
},

/**
 * Master calculation engine. It acts as a router, calling the specific calculation
 * function for the active deal type and then layering on the universal pricing
 * and commission calculations.
 * @returns {object|null} A comprehensive object with all calculated deal metrics, or null if calculation fails.
 */
calculateModel: () => {
    const { activeDealType, pricingConfig } = AppState.modeler;
    const calculationFunc = Logic[`calculate${activeDealType}`];
    if (!calculationFunc) return null;
    const dealCalc = calculationFunc();
    if (!dealCalc) return null;
    const { baseValueUSD } = dealCalc;
    const grossValue = parseFloat(pricingConfig.grossValue) || 0;
    const netValue = parseFloat(pricingConfig.netValue) || 0;
    const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (grossValue / 100) : grossValue;
    const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (netValue / 100) : netValue;
    let finalValueToBuyerUSD, totalCommissionPool;
    if(pricingConfig.offerType === 'discount') { finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; } 
    else { finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; }
    totalCommissionPool = Math.max(0, totalCommissionPool);
    AppState.modeler.legal.totalCommission = totalCommissionPool;
    return { ...dealCalc, baseValueUSD, finalValueToBuyerUSD, totalCommissionPool, netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`, grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}` };
},

/**
 * Calculates the specifics for an Asset Swap deal.
 * @returns {object} An object containing the calculated metrics for the swap.
 */
calculateAssetSwap: () => {
    const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
    const fromAsset = Utils.getAssetByKey(fromAssetKey);
    const toAsset = Utils.getAssetByKey(toAssetKey);
    const baseValueUSD = (parseFloat(amount) || 0) * (fromAsset.price || 0);
    const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0;
    const dealTitle = `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset} for ${toAsset.baseAsset}`;
    return { baseValueUSD, fromAsset, toAsset, rate, dealTitle };
},

/**
 * Calculates the specifics for a physical Commodity Trade deal.
 * @returns {object} An object containing the calculated metrics for the trade.
 */
calculateCommodityTrade: () => {
    const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey, discountPremiumIsInPercent } = AppState.modeler.commodityTrade;
    const asset = Utils.getAssetByKey(assetKey);
    const settlementAsset = Utils.getAssetByKey(settlementAssetKey);
    let effectivePricePerUnit = asset.price || 0, priceDerivation = 'Market Price';
    const discPremVal = parseFloat(discountPremiumValue) || 0;
    if (pricingModel === 'Fixed') { effectivePricePerUnit = parseFloat(fixedPrice) || 0; priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`; }
    else if (pricingModel === 'Premium') { const premiumAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit += premiumAmount; priceDerivation = `Market + ${Utils.formatPrice(premiumAmount)}`; }
    else if (pricingModel === 'Discount') { const discountAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit -= discountAmount; priceDerivation = `Market - ${Utils.formatPrice(discountAmount)}`; }
    const baseValueUSD = (parseFloat(quantity) || 0) * effectivePricePerUnit;
    const dealTitle = `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`;
    let settlementAmount = baseValueUSD / (settlementAsset.price || 1);
    return { baseValueUSD, dealTitle, priceDerivation, effectivePricePerUnit, settlementAmount, settlementAsset };
},

/**
 * Calculates the specifics for a Crypto-Collateralized Loan.
 * @returns {object} An object containing the calculated metrics for the loan.
 */
calculateCryptoLoan: () => {
    const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
    
    const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
    
    // Calculate the total value of the collateral in USD.
    const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0);
    
    // Calculate the loan principal based on the Loan-to-Value (LTV) percentage.
    const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100);
    
    // Calculate the total simple interest over the loan term.
    const totalInterest = loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12);
    
    const totalRepayment = loanPrincipal + totalInterest;

    return {
        baseValueUSD: loanPrincipal, // For consistency, the base value of a loan is its principal.
        loanPrincipal,
        totalRepayment,
        loanCurrency,
        tenureMonths,
        interestRateValue,
        dealTitle: `Loan against ${collateralAsset.baseAsset}`
    };
},
            /**
 * Calculates the specifics for SBLC Monetization.
 * @returns {object} An object containing the calculated metrics for the monetization deal.
 */
calculateSBLCMonetization: () => {
    const { faceValue, ltv } = AppState.modeler.sblcMonetization;
    
    // Calculate the monetized value based on the instrument's face value and the Loan-to-Value (LTV) percentage.
    const baseValueUSD = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
    
    const dealTitle = `LTV on ${Utils.formatPrice(faceValue)} SBLC`;

    return { 
        baseValueUSD, // For consistency, the base value is the total capital unlocked.
        dealTitle 
    };
},

/**
 * Resets the entire Institutional Modeler state to its default configuration.
 * This function performs a deep-clone reset to prevent any reference-related bugs
 * and ensures a clean slate for the user.
 */
resetModelerState: () => {
    // Define the pristine, default state of the entire modeler.
    const defaultState = {
        activeDealType: 'AssetSwap',
        assetSwap: { 
            amount: 1000000, 
            fromAssetKey: '', 
            toAssetKey: '' 
        },
        commodityTrade: { 
        assetKey: 'WTI-BBL-USD',
        quantity: 100000,
        unitOfMeasure: 'Barrel',
        qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%',
        origin: 'United States',
        port: 'Houston',
        incoterms: 'FOB',
        procedures: '• Standard TTV Procedures\n• SGS/Intertek Inspection\n• Payment via SBLC/DLC',
        pricingModel: 'Discount',
        fixedPrice: 0,
        discountPremiumValue: 4,
        discountPremiumIsInPercent: true,
        settlementAssetKey: 'USD' 
    },
        cryptoLoan: { 
            collateralAssetKey: 'BTC-USD', 
            collateralAmount: 10, 
            loanCurrency: 'USD', 
            ltv: 60, 
            interestRateType: 'fixed', 
            interestRateValue: 5.5, 
            tenureMonths: 12 
        },
        sblcMonetization: { 
            faceValue: 100000000, 
            ltv: 80 
        },
        pricingConfig: { 
            isVisible: false, 
            offerType: 'discount', 
            grossValue: 0, 
            netValue: 0, 
            isValueInPercent: true 
        },
        legal: { 
            totalCommission: 0, 
            jurisdiction: 'Singapore, Dubai, England, Wales', 
            spaReferenceCode: '', 
            groups: [] 
        }
    };

    // Perform a deep clone to ensure no lingering references. This is the most robust way to reset.
    AppState.modeler = JSON.parse(JSON.stringify(defaultState));
    
    // Intelligence: After resetting, re-populate the Asset Swap fields with the first two
    // available assets from the market data, providing a sensible default.
    const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
    if (allSwappableAssets.length >= 2) {
        AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key;
        AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key;
    }
    
    // Trigger a full UI re-render to reflect the reset state.
    Logic.updateModelerUI(true);
    
    // Provide user feedback.
    Utils.showNotification('Institutional Modeler has been reset to its default state.', 'info', 'Modeler Reset');
},

/**
 * Swaps the 'from' and 'to' assets in the Asset Swap modeler.
 * It intelligently recalculates the 'from' amount to preserve the total USD value of the deal.
 */
swapAssets: () => {
    const swapState = AppState.modeler.assetSwap;
    
    // Retrieve full asset data to ensure prices are current.
    const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey);
    const toAsset = Utils.getAssetByKey(swapState.toAssetKey);

    // Recalculate the 'amount' field to maintain the same total USD value after the swap.
    if (fromAsset.price > 0 && toAsset.price > 0) {
        const totalUsdValue = (parseFloat(swapState.amount) || 0) * fromAsset.price;
        // The new 'amount' will be what the total USD value can buy of the *new* 'from' asset.
        swapState.amount = totalUsdValue / toAsset.price; 
    }

    // Perform the actual swap of the asset keys in the state.
    [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
    
    // Trigger the premium 3D icon animation for visual feedback.
    const icon = document.getElementById('swap-icon');
    if (icon) {
        // This technique forces a CSS animation restart.
        icon.style.animation = 'none';
        void icon.offsetWidth; // Trigger reflow
        icon.style.animation = 'swap-icon-spin 0.5s ease-in-out';
    }
    
    // Trigger a full UI update to reflect the swapped assets and recalculated amount.
    Logic.updateModelerUI(true);
},

/**
 * Toggles the visibility of the advanced pricing configuration panel in the UI.
 */
togglePricingConfig: () => {
    // Directly mutate the state.
    AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible;
    
    // Trigger a full UI update (`true`) to re-render the input panel with the
    // now-visible (or hidden) pricing configuration section. This ensures
    // the collapsible animation works correctly.
    Logic.updateModelerUI(true);
},
            
// ========================================================================================
// === PINNACLE NCNDA/IMFPA & DOCUMENT EXECUTION SUITE ENGINE (v10.0 - FINAL & UNABRIDGED) ===
// This is the definitive, military-grade logic and UI for the entire contract workflow.
// ========================================================================================

// --- A. SEVERELY OVERHAULED LOGIC ---
            openImfpaModal: () => { document.getElementById('imfpa-modal-content').innerHTML = UI.renderImfpaModal(); Logic.refreshImfpaModalUI(); document.getElementById('imfpa-modal').showModal(); },
            refreshImfpaModalUI: () => {
                const { legal } = AppState.modeler;
                document.getElementById('imfpa-groups-container').innerHTML = UI.renderImfpaGroups();
                document.getElementById('imfpa-legal-parties').innerHTML = legal.groups.flatMap(g => g.parties).map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') || '<p class="text-xs text-text-muted">No parties defined in allocation groups.</p>';
                document.querySelectorAll('#imfpa-modal-content [data-path]').forEach(el => {
                    const eventType = el.tagName === 'SELECT' || el.type === 'range' ? 'change' : 'input';
                    el.addEventListener(eventType, Utils.debounce(Logic.handleModelerInputChangeInModal, 250));
                });
            },
                        // ----- In the Logic Controller Object -----

            // SEVERE FIX: This function is now surgically targeted. It NO LONGER performs a full, disruptive re-render.
            // Instead, it calls the new `updateImfpaCalculations` function for a smooth user experience while typing.
            handleModelerInputChangeInModal: (e) => {
                Logic.handleModelerInputChange(e);
                Logic.updateImfpaCalculations();
            },

            // SEVERE FIX (NEW FUNCTION): This new function is the heart of the fix.
            // It updates ONLY the calculated values in the DOM without rebuilding the form inputs,
            // thus preserving focus and providing an instantaneous, non-disruptive update.
            updateImfpaCalculations: () => {
                const { legal } = AppState.modeler;
                const { groups, totalCommission } = legal;

                // 1. Update overall total allocation percentage
                const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
                if (totalAllocatedEl) {
                    totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
                    totalAllocatedEl.className = `text-right font-mono text-sm ${totalGroupPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}`;
                }

                // 2. Update individual group values and their internal party percentages
                groups.forEach((g, groupIndex) => {
                    const groupValue = totalCommission * (g.percentage / 100);
                    const groupValueEl = document.getElementById(`imfpa-group-value-${groupIndex}`);
                    if (groupValueEl) {
                        groupValueEl.textContent = Utils.formatPrice(groupValue);
                    }

                    const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
                    if (groupTotalEl) {
                        groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
                        groupTotalEl.className = `text-right font-mono text-xs ${totalPartyPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}`;
                    }
                });

                // 3. Update the list of signatory parties (their names)
                const legalPartiesEl = document.getElementById('imfpa-legal-parties');
                if (legalPartiesEl) {
                    legalPartiesEl.innerHTML = legal.groups.flatMap(g => g.parties).map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') || '<p class="text-xs text-text-muted">No parties defined in allocation groups.</p>';
                }
            },

            // NOTE: These functions correctly continue to use `refreshImfpaModalUI` because they
            // perform structural changes (adding/removing elements) which require a full DOM rebuild of the list.
            addImfpaGroup: () => { AppState.modeler.legal.groups.push({ name: `Group ${AppState.modeler.legal.groups.length + 1}`, percentage: 0, parties: [] }); Logic.refreshImfpaModalUI(); },
            removeImfpaGroup: (i) => { AppState.modeler.legal.groups.splice(i, 1); Logic.refreshImfpaModalUI(); },
            addImfpaParty: (groupIndex) => { AppState.modeler.legal.groups[groupIndex].parties.push({ legalName: `New Party`, role: 'Intermediary', percentage: 0, detailsVisible: true, email: '', contactNumber: '', passport: { number: '', issueDate: '', expiryDate: '', authority: '' }, payment: {method: 'Bank Wire', currency: 'USD', details: ''} }); Logic.refreshImfpaModalUI(); },
            removeImfpaParty: (groupIndex, partyIndex) => { AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1); Logic.refreshImfpaModalUI(); },
            togglePartyDetails: (groupIndex, partyIndex) => { const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex]; party.detailsVisible = !party.detailsVisible; Logic.refreshImfpaModalUI(); },
            
                        generateContract: () => {
    const { legal } = AppState.modeler;
    const calc = Logic.calculateModel();
    if (!calc) { 
        Logic.showNotification("Cannot generate contract. Please define the core deal parameters first.", 'error');
        return; 
    }

    // Enhanced recitals with elevated legal language
    let recitalsText = '';
    switch(AppState.modeler.activeDealType) {
        case 'AssetSwap':
            recitalsText = `WHEREAS, the Contracting Parties have entered into preliminary negotiations concerning a sophisticated digital and/or physical asset exchange transaction contemplating the bilateral swap of approximately ${Utils.formatNumber(AppState.modeler.assetSwap.amount)} units of ${calc.fromAsset.baseAsset} in consideration for equivalent value in ${calc.toAsset.baseAsset}, subject to market valuations and regulatory compliance;`;
            break;
        case 'CommodityTrade':
            const ct = AppState.modeler.commodityTrade;
            recitalsText = `WHEREAS, the Contracting Parties are engaged in commercial negotiations for the procurement, sale, and delivery of physical commodities, specifically ${Utils.formatNumber(ct.quantity)} ${ct.unitOfMeasure} of premium-grade ${Utils.getAssetByKey(ct.assetKey).baseAsset}, in accordance with international trade conventions and applicable commodity exchange regulations;`;
            break;
        case 'CryptoLoan':
            const cl = AppState.modeler.cryptoLoan;
            recitalsText = `WHEREAS, the Contracting Parties seek to establish a sophisticated credit facility secured by digital asset collateral, encompassing a principal loan amount of ${Utils.formatPrice(calc.loanPrincipal, cl.loanCurrency)} against pledged collateral consisting of ${Utils.formatNumber(cl.collateralAmount)} units of ${Utils.getAssetByKey(cl.collateralAssetKey).baseAsset}, subject to regulatory compliance and risk management protocols;`;
            break;
        case 'SBLCMonetization':
            const sblc = AppState.modeler.sblcMonetization;
            recitalsText = `WHEREAS, the Contracting Parties are collaborating on the monetization and financial optimization of a Standby Letter of Credit (SBLC) instrument bearing a face value of ${Utils.formatPrice(sblc.faceValue)}, issued by a prime banking institution and compliant with ICC UCP 600 standards;`;
            break;
        default:
            recitalsText = `WHEREAS, the Contracting Parties have established a framework for cooperation in connection with a substantial international financial transaction of significant commercial value and strategic importance;`;
    }

        // --- SEVERELY UPGRADED FEE DISTRIBUTION SCHEDULE (PREMIUM TABLE FORMAT) ---
    const feeClauses = legal.groups.map((g) => {
        const groupPayout = legal.totalCommission * (g.percentage / 100);

        const partiesRows = g.parties.map((p) => {
            const partyValue = groupPayout * (p.percentage / 100);
            const settlementDetailsText = p.payment.details || 'To be furnished through separate, encrypted KYC/KYB documentation exchange pursuant to regulatory requirements';

            return `
            <tr>
                <td>
                    <div class="beneficiary-name">${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'}</div>
                    <div class="beneficiary-role">${p.role || '[ROLE NOT DESIGNATED]'}</div>
                </td>
                <td>
                    <div class="allocation-value">${p.percentage}%</div>
                    <div class="text-muted">${Utils.formatPrice(partyValue, 'USD')}</div>
                </td>
                <td>
                    <div class="settlement-method">${p.payment.method?.toUpperCase() || '[METHOD]'} (${p.payment.currency || 'N/A'})</div>
                    <div class="settlement-details">${settlementDetailsText}</div>
                </td>
            </tr>`;
        }).join('');

        const tableBody = g.parties.length > 0
            ? partiesRows
            : `<tr class="no-parties-row"><td colspan="3">(No designated beneficiaries specified for this distribution group)</td></tr>`;

        return `
        <div class="fee-group-container">
            <div class="fee-group-header">
                <span class="fee-group-header-title">Distribution Group: "${g.name.toUpperCase()}"</span>
                <span class="fee-group-header-value">${g.percentage}% (${Utils.formatPrice(groupPayout, 'USD')})</span>
            </div>
            <table class="fee-distribution-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Beneficiary & Role</th>
                        <th style="width: 20%;">Allocation</th>
                        <th style="width: 40%;">Remittance Instructions</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableBody}
                </tbody>
            </table>
        </div>`;
    }).join('');

    // Enhanced party signature blocks
    // --- UPGRADED: ENHANCED PARTY SIGNATURE BLOCKS WITH UNIQUE IDENTIFIERS ---
const signatureBlocks = legal.groups.flatMap(g => g.parties).map((p, i) => `
<div class="signature-block" data-signature-id="party-${i}">
    <div class="signature-line">
        <strong>CONTRACTING PARTY ${i+1}:</strong> ${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'}
    </div>
    <div class="signature-details">
        <div class="signature-field">
            <span class="field-label">Authorized Signature:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Printed Name & Title:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Date of Execution:</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
        <div class="signature-field">
            <span class="field-label">Corporate Seal (if applicable):</span>
            <span class="signature-line-border">_________________________________________________</span>
        </div>
    </div>
</div>`).join('\n');

    // Enhanced party details table
    const partyDetailsTable = legal.groups.flatMap(g => g.parties).map((p, i) => `
<div class="party-details-section">
    <h4>CONTRACTING PARTY ${i+1} - COMPREHENSIVE DETAILS</h4>
    <table class="party-details-table">
        <tbody>
            <tr>
                <td class="detail-label">Legal Entity Name:</td>
                <td class="detail-value">${p.legalName || '[REQUIRED - NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Functional Role & Capacity:</td>
                <td class="detail-value">${p.role || '[ROLE NOT DESIGNATED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Primary Contact Email:</td>
                <td class="detail-value">${p.email || '[EMAIL ADDRESS REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Direct Contact Number:</td>
                <td class="detail-value">${p.contactNumber || '[CONTACT NUMBER REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Passport/ID Number:</td>
                <td class="detail-value">${p.passport.number || '[IDENTIFICATION REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Document Issue Date:</td>
                <td class="detail-value">${p.passport.issueDate || '[DATE REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Document Expiry Date:</td>
                <td class="detail-value">${p.passport.expiryDate || '[DATE REQUIRED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Issuing Authority:</td>
                <td class="detail-value">${p.passport.authority || '[AUTHORITY REQUIRED]'}</td>
            </tr>
        </tbody>
    </table>
    
    <h5>REMITTANCE & SETTLEMENT COORDINATES</h5>
    <table class="payment-details-table">
        <tbody>
            <tr>
                <td class="detail-label">Fee Allocation Percentage:</td>
                <td class="detail-value">(As specified in Article 3 - Fee Distribution Schedule)</td>
            </tr>
            <tr>
                <td class="detail-label">Preferred Payment Method:</td>
                <td class="detail-value">${p.payment.method || '[METHOD NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Settlement Currency:</td>
                <td class="detail-value">${p.payment.currency || '[CURRENCY NOT SPECIFIED]'}</td>
            </tr>
            <tr>
                <td class="detail-label">Banking/Payment Details:</td>
                <td class="detail-value">${p.payment.details || 'To be furnished through separate, secure KYC/KYB documentation exchange in compliance with AML/CTF regulations'}</td>
            </tr>
        </tbody>
    </table>
</div>`).join('\n\n');

    const agreementReference = `GECAN-IMFPA-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
    const effectiveDate = new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Add this line right before `const contractHTML`
const generatedDateTime = new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });

    const contractHTML = `
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

        /* =========================================================
   === PREMIUM FEE DISTRIBUTION TABLE STYLES (v2.0) ===
   ========================================================= */
.fee-group-container {
    margin-top: 25px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    background: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
}

.fee-group-header {
    background: #f7fafc;
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.fee-group-header-title {
    font-size: 13px;
    font-weight: 600;
    color: #2d3748;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.fee-group-header-value {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: 600;
    color: #2c5282;
}

.fee-distribution-table {
    width: 100%;
    border-collapse: collapse;
}

.fee-distribution-table th, 
.fee-distribution-table td {
    padding: 12px 16px;
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid #e2e8f0;
    font-size: 11px;
    line-height: 1.5;
}

.fee-distribution-table th {
    font-weight: 600;
    font-size: 10px;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background-color: #f8f9ff;
}

.fee-distribution-table tr:last-child td {
    border-bottom: none;
}

.beneficiary-name {
    font-weight: 600;
    font-size: 12px;
    color: #1a202c;
}

.beneficiary-role {
    font-style: italic;
    color: #4a5568;
}

.allocation-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: #2c5282;
}

.settlement-method {
    font-weight: 600;
    text-transform: uppercase;
}

.settlement-details {
    font-family: 'Courier New', monospace;
    font-size: 10px;
    color: #4a5568;
    word-break: break-all;
}

.no-parties-row td {
    text-align: center;
    font-style: italic;
    color: #718096;
    padding: 20px;
}
        
        .contract-document {
            font-family: 'Crimson Text', 'Times New Roman', serif;
            line-height: 1.6;
            color: #1a1a1a;
            max-width: 8.5in;
            margin: 0 auto;
            padding: 1in;
            background: #ffffff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .document-header {
            text-align: center;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .classification-banner {
            background: linear-gradient(135deg, #2c5282, #3182ce);
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }
        
        .document-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c5282;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 15px 0;
        }
        
        .agreement-metadata {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .metadata-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .metadata-label {
            font-weight: 600;
            color: #2d3748;
        }
        
        .metadata-value {
            color: #4a5568;
            font-family: 'Courier New', monospace;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #2c5282;
            text-transform: uppercase;
            border-bottom: 2px solid #2c5282;
            padding-bottom: 5px;
            margin: 30px 0 20px 0;
            letter-spacing: 0.5px;
        }
        
        .article-header {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin: 25px 0 15px 0;
            text-transform: uppercase;
        }
        
        .clause-text {
            text-align: justify;
            margin: 12px 0;
            text-indent: 0.5in;
        }
        
        .whereas-clause {
            margin: 15px 0;
            padding-left: 20px;
            text-align: justify;
            font-style: italic;
        }
        
        .fee-distribution {
            background: #f8f9ff;
            border-left: 4px solid #2c5282;
            padding: 15px;
            margin: 20px 0;
            font-size: 11px;
        }
        
        .party-details-section {
            margin: 25px 0;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .party-details-section h4 {
            background: #2c5282;
            color: white;
            padding: 12px;
            margin: 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .party-details-section h5 {
            background: #e2e8f0;
            color: #2d3748;
            padding: 8px 12px;
            margin: 0;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .party-details-table, .payment-details-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .party-details-table td, .payment-details-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
        }
        
        .detail-label {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            width: 35%;
            vertical-align: top;
        }
        
        .detail-value {
            color: #4a5568;
            font-family: 'Courier New', monospace;
        }
        
        .signature-block {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #2c5282;
            border-radius: 5px;
            background: #f8f9ff;
        }
        
        .signature-line {
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .signature-field {
            margin: 12px 0;
            display: flex;
            align-items: center;
        }
        
        .field-label {
            font-weight: 600;
            color: #2d3748;
            width: 200px;
            font-size: 11px;
        }
        
        .signature-line-border {
            flex: 1;
            border-bottom: 1px solid #2d3748;
            margin-left: 10px;
            height: 20px;
        }
        

        
        .page-break {
            page-break-before: always;
        }

                /* This rule styles the re-instated legal footer */
.legal-footer {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid #2c5282;
    font-size: 9px;
    color: #4a5568;
    text-align: center;
    page-break-inside: avoid; /* Prevents the footer from being split across pages */
}
        
        @media print {

          /* --- CORE PRINT ISOLATION (THE FIX) --- */
    /* 1. Hide all application UI elements that have the 'print-hide' class. */
    .print-hide {
        display: none !important;
    }
    
    /* 2. Make the master print container visible. */
    #print-area {
        display: block !important;
    }
            .contract-document {
                box-shadow: none;
                border: none;
                padding: 0.75in;
            }
            
            @page {
                margin: 0.75in;
                @top-left {
                    content: "${agreementReference}";
                    font-size: 9px;
                    color: #666;
                }
                @top-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 9px;
                    color: #666;
                }
                @bottom-center {
                    content: "CONFIDENTIAL & PROPRIETARY - This document contains legally privileged and confidential information";
                    font-size: 8px;
                    color: #666;
                }
            }
            
            .page-break {
                page-break-before: always;
            }
        }
    </style>
    
    <div class="contract-document">
        <div class="classification-banner">
            CONFIDENTIAL & PROPRIETARY - FOR AUTHORIZED CONTRACTING PARTIES EXCLUSIVELY
        </div>
        
        <div class="document-header">
            <div class="document-title">
                IRREVOCABLE MASTER FEE PROTECTION AGREEMENT<br>
                & NON-CIRCUMVENTION NON-DISCLOSURE COVENANT<br>
                (IMFPA-NCNDA)
            </div>
            <div style="height: 2px; background: linear-gradient(to right, #2c5282, #3182ce); margin: 15px 0;"></div>
        </div>
        
        <div class="agreement-metadata">
            <div class="metadata-row">
                <span class="metadata-label">AGREEMENT REFERENCE CODE:</span>
                <span class="metadata-value">${agreementReference}</span>
            </div>
            ${legal.spaReferenceCode ? `
            <div class="metadata-row" style="background-color: #fef3c7;">
                <span class="metadata-label" style="color: #92400e;">CROSS-REFERENCED SPA:</span>
                <span class="metadata-value" style="font-weight: bold; color: #92400e;">${legal.spaReferenceCode}</span>
            </div>
            ` : ''}
            <div class="metadata-row">
                <span class="metadata-label">EFFECTIVE DATE:</span>
                <span class="metadata-value">${effectiveDate}</span>
            </div>
            <div class="metadata-row">
                <span class="metadata-label">TRANSACTION IDENTIFIER:</span>
                <span class="metadata-value">[TO BE ASSIGNED UPON DEFINITIVE CLOSING]</span>
            </div>
            <div class="metadata-row">
                <span class="metadata-label">GOVERNING FRAMEWORK:</span>
                <span class="metadata-value">ICC Pubs. 769, UCP 600, URDG 758, Incoterms® 2020; FATF AML/CTF Standards</span>
            </div>
        </div>
        
                <div class="clause-text">
            This <strong>Irrevocable Master Fee Protection Agreement & Non-Circumvention Non-Disclosure Covenant</strong> (hereinafter referred to as this "Agreement") constitutes a legally binding and enforceable contract executed by and among the undersigned Contracting Parties (collectively referred to as "the Parties") acting with full corporate authority, fiduciary responsibility, and legal capacity. This Agreement is structured in accordance with, and shall be interpreted under, the highest standards of international commercial practice. This includes, but is not limited to, principles promulgated by the International Chamber of Commerce (ICC), Paris, France, such as ICC Publication No. 769 (IMFPA), the Uniform Customs and Practice for Documentary Credits (UCP 600), the Uniform Rules for Demand Guarantees (URDG 758), and Incoterms® 2020. Furthermore, all activities and remittances hereunder are subject to strict compliance with international Anti-Money Laundering (AML) and Counter-Terrorist Financing (CTF) regulations, including the standards set forth by the Financial Action Task Force (FATF).
        </div>
        
        <div class="section-header">PRELIMINARY RECITALS & FOUNDATIONAL WHEREAS CLAUSES</div>
        
        <div class="whereas-clause">
            ${recitalsText}
        </div>
        
        <div class="whereas-clause">
            WHEREAS, the Contracting Parties have entered into comprehensive discussions and negotiations for the purpose of establishing a mutually beneficial commercial relationship and have determined that their collective expertise, resources, and strategic positioning warrant collaborative participation in the aforementioned transaction;
        </div>
        
        <div class="whereas-clause">
            WHEREAS, in consideration of their respective contributions, efforts, and professional services rendered in connection with the successful negotiation, structuring, and consummation of the contemplated transaction, the Parties have established an aggregate commission fee pool to be distributed in accordance with the terms and conditions set forth herein;
        </div>
        
        <div class="whereas-clause">
            WHEREAS, all intermediary parties and facilitators are hereby classified and designated as "Professional Consultants" and their compensation shall be characterized as "Consultancy Fees" or "Professional Commissions," which compensation shall be protected under the irrevocable provisions of this Agreement;
        </div>
        
        <div class="whereas-clause">
            NOW, THEREFORE, in consideration of the mutual covenants, agreements, representations, and warranties contained herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged by all Parties, the Contracting Parties hereby agree to be legally bound by the following terms and conditions:
        </div>
        
        <div class="article-header">ARTICLE I: TRANSACTION DEFINITION & SCOPE</div>
        <div class="clause-text">
            <strong>1.1 Transaction Description:</strong> The subject matter of this Agreement encompasses a sophisticated financial transaction (hereinafter referred to as the "Principal Transaction" or "Project") with an estimated aggregate base value of ${Utils.formatPrice(calc.baseValueUSD)}, subject to final due diligence, regulatory approvals, and definitive documentation.
        </div>
        <div class="clause-text">
            <strong>1.2 Commission Pool Establishment:</strong> The Principal Transaction is contractually structured to generate an Aggregate Total Commission Pool in the amount of ${Utils.formatPrice(legal.totalCommission)} (the "Fee Pool"). This Fee Pool represents the gross commission spread established within the Principal Transaction's definitive commercial agreements and shall be distributed in accordance with the irrevocable allocation schedule detailed in Article III hereof.
        </div>
        <div class="clause-text">
            <strong>1.3 Legal Characterization:</strong> The Fee Pool constitutes earned professional compensation for consultancy services, transaction facilitation, and commercial intermediation rendered by the Parties in their respective professional capacities.
        </div>
        
        <div class="article-header">ARTICLE II: CONTRACTING PARTIES & BENEFICIAL OWNERSHIP</div>
        <div class="clause-text">
            <strong>2.1 Party Identification:</strong> The following natural persons and legal entities constitute the complete universe of Contracting Parties and beneficial recipients under this Agreement. Each Party hereby represents and warrants that they possess full legal authority, corporate capacity, and fiduciary authorization to bind their respective organizations and principals to the terms, conditions, and obligations contained herein.
        </div>
        
        <div class="clause-text">
            <strong>2.2 Comprehensive Party Registry:</strong>
            <ul style="padding-left: 30px; margin: 15px 0;">
                ${legal.groups.flatMap(g => g.parties).map((p, i) => 
                    `<li><strong>CONTRACTING PARTY ${i+1}:</strong> ${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'} - ${p.role || 'Professional Consultant'}</li>`
                ).join('')}
            </ul>
        </div>
        
        <div class="clause-text">
            <strong>2.3 Detailed Party Information:</strong> Comprehensive identification, contact, and remittance details for each Contracting Party are set forth in Annex A to this Agreement, which Annex forms an integral and binding component of this Agreement.
        </div>
        
        <div class="article-header">ARTICLE III: IRREVOCABLE FEE DISTRIBUTION & PAYMENT OBLIGATIONS</div>
        <div class="clause-text">
            <strong>3.1 Irrevocable Distribution Covenant:</strong> The Contracting Parties hereby irrevocably and unconditionally agree that the Aggregate Fee Pool shall be distributed directly, immediately, and without offset, deduction, or withholding (except as required by applicable law) from the designated Payer's transactional settlement account(s) to the respective Beneficiaries' designated receiving accounts as detailed in Annex A hereto.
        </div>
        
        <div class="clause-text">
            <strong>3.2 Payment Timeline & Method:</strong> Fee distribution shall be executed via authenticated SWIFT wire transfer or alternative internationally recognized electronic funds transfer method within a maximum of three (3) international banking days from the date of closing, settlement, and funds availability for each tranche or installment of the Principal Transaction.
        </div>
        
        <div class="clause-text">
    <strong>3.3 Detailed Distribution Schedule:</strong> The Aggregate Fee Pool distribution shall be allocated as follows:
</div>
        
        <div class="fee-distribution">
            ${feeClauses || '<div class="fee-group-container"><p class="p-4 text-center text-text-muted">(No fee distribution schedule has been defined in this draft version)</p></div>'}
        </div>
        
        <div class="page-break"></div>
        
        <div class="article-header">ARTICLE IV: NON-CIRCUMVENTION & NON-DISCLOSURE COVENANTS</div>
        <div class="clause-text">
            <strong>4.1 Absolute Non-Circumvention:</strong> The Contracting Parties hereby covenant and irrevocably agree not to, whether directly, indirectly, or through any affiliated entity, agent, representative, or third-party intermediary, circumvent, avoid, bypass, or exclude any other Contracting Party from participation in any commercial transaction with any corporation, financial institution, funding source, or individual person introduced by another Party during the term of this Agreement.
        </div>
        
        <div class="clause-text">
            <strong>4.2 Temporal Scope:</strong> This non-circumvention covenant shall remain in full force and effect for a period of five (5) years from the Effective Date and shall be binding upon the Parties, their principals, agents, affiliates, successors, and assigns.
        </div>
        
        <div class="clause-text">
            <strong>4.3 Comprehensive Non-Disclosure:</strong> The Contracting Parties acknowledge that they may have access to proprietary, confidential, and sensitive commercial information ("Confidential Information") including, but not limited to, the identity of the Parties, transaction procedures, financial data, commercial terms, and the existence of this Agreement itself.
        </div>
        
        <div class="clause-text">
            <strong>4.4 Confidentiality Obligations:</strong> All Confidential Information shall be held in absolute and strict confidence. Disclosure is expressly prohibited absent prior, unanimous written consent of all Contracting Parties, except as may be compelled by court order or applicable law, in which case immediate written notification shall be provided to all other Parties.
        </div>
        
        <div class="article-header">ARTICLE V: GOVERNING LAW, JURISDICTION & DISPUTE RESOLUTION</div>
        <div class="clause-text">
            <strong>5.1 Governing Law:</strong> This Agreement shall be governed by, construed, and enforced in accordance with the substantive laws of ${legal.jurisdiction || '[JURISDICTION TO BE SPECIFIED]'}, without regard to conflict of law principles.
        </div>
        
        <div class="clause-text">
            <strong>5.2 Dispute Resolution Mechanism:</strong> Any controversy, claim, or dispute arising out of or relating to this Agreement, or the breach, termination, enforcement, interpretation, or validity thereof, shall be resolved exclusively through binding arbitration administered by the International Chamber of Commerce (ICC) International Court of Arbitration pursuant to the ICC Rules of Arbitration then in effect.
        </div>
        
        <div class="clause-text">
            <strong>5.3 Arbitration Procedures:</strong> The seat of arbitration shall be [City, Country corresponding to Governing Law Jurisdiction]. The arbitration shall be conducted by a panel of three (3) arbitrators, with each Party selecting one arbitrator and the third arbitrator being selected by mutual agreement or, failing such agreement, by the ICC.
        </div>
        
        <div class="article-header">ARTICLE VI: INDEMNIFICATION & LIMITATION OF LIABILITY</div>
        <div class="clause-text">
            <strong>6.1 Mutual Indemnification:</strong> Each Contracting Party agrees to indemnify, defend, and hold harmless all other Parties from and against any and all claims, damages, losses, costs, and expenses (including reasonable attorneys' fees and costs) arising from or related to such Party's material breach of this Agreement or willful misconduct.
        </div>
        
        <div class="clause-text">
            <strong>6.2 Limitation of Liability:</strong> Except in cases of willful misconduct or fraud, each Party's liability shall be limited to direct damages and shall expressly exclude consequential, punitive, incidental, or special damages.
        </div>
        
        <div class="article-header">ARTICLE VII: GENERAL PROVISIONS & MISCELLANEOUS TERMS</div>
        <div class="clause-text">
            <strong>7.1 Binding Authority & Legal Effect:</strong> This Agreement constitutes a full recourse, legally binding, and enforceable contract. Any unauthorized circumvention, breach of confidentiality, or material default shall entitle the aggrieved Party(ies) to monetary damages equal to the maximum fee such Party would have realized from the Principal Transaction, plus all associated legal expenses and costs.
        </div>
        
        <div class="clause-text">
            <strong>7.2 Force Majeure:</strong> No Contracting Party shall be held liable for any failure or delay in performance under this Agreement if such failure or delay results from causes beyond such Party's reasonable control, including but not limited to acts of God, war, terrorism, pandemic, government action, or regulatory changes.
        </div>
        
        <div class="clause-text">
            <strong>7.3 Entire Agreement & Modification:</strong> This Agreement, together with all Annexes attached hereto, constitutes the entire understanding and agreement between the Parties and supersedes all prior negotiations, discussions, representations, and agreements relating to the subject matter hereof. This Agreement may only be modified by written amendment executed by all Contracting Parties.
        </div>
        
        <div class="clause-text">
            <strong>7.4 Execution & Delivery:</strong> This Agreement may be executed in multiple counterparts, each of which shall be deemed an original, and all of which together shall constitute one and the same instrument. Transmission of an executed signature page by electronic means (including PDF) shall be deemed equivalent to delivery of a manually executed original.
        </div>
        
        <div class="clause-text">
            <strong>7.5 Severability:</strong> If any provision of this Agreement is held to be invalid, illegal, or unenforceable, the validity, legality, and enforceability of the remaining provisions shall not be affected or impaired thereby.
        </div>
        
        <div class="section-header">EXECUTION & AUTHENTICATION</div>
        
        <div class="clause-text">
            <strong>IN WITNESS WHEREOF,</strong> the Contracting Parties have caused this Agreement to be executed by their respective duly authorized representatives as of the Effective Date first written above.
        </div>
        
        ${signatureBlocks}
        
        <div class="page-break"></div>
        
        <div class="section-header">ANNEX A: COMPREHENSIVE PARTY IDENTIFICATION & REMITTANCE DETAILS</div>
        
        <div class="clause-text">
            This Annex A forms an integral, binding, and enforceable component of the foregoing Agreement and contains comprehensive identification and payment coordination details for all Contracting Parties.
        </div>
        
        ${partyDetailsTable}
        
        <div class="legal-footer">
            <strong>CONFIDENTIAL & PROPRIETARY DOCUMENT</strong><br>
            This document contains legally privileged and confidential commercial information protected by attorney-client privilege and work product doctrine. Unauthorized disclosure,
            reproduction, or distribution is strictly prohibited and may result in civil and criminal penalties.
            <br><br>
            Document Reference: ${agreementReference} | Generated: ${generatedDateTime}
        </div>
        </div>
    </div>`;

    // Enhanced container setup with premium styling
    const container = document.getElementById('contract-preview-container');
    const printContainerContent = document.getElementById('print-content');
    
    if (container && printContainerContent) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: white; font-size: 18px; font-weight: 600; margin: 0 0 10px 0; text-align: center;">
                    <i class="fas fa-file-contract" style="margin-right: 10px;"></i>Premium Legal Contract Generated
                </h3>
                <p style="color: rgba(255,255,255,0.9); margin: 0; text-align: center; font-size: 14px;">
                    Professional-grade IMFPA-NCNDA document ready for legal review and execution
                </p>
            </div>
            
            
<!-- UPGRADED: DOCUMENT EXECUTION SUITE v3 (AUDIT-READY) -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="contract-execution-suite">
    <!-- Action Buttons -->
    <div class="md:col-span-2 flex gap-4">
         <button onclick="window.print()" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-print mr-2"></i>Print / Save PDF Draft</button>
         <button onclick="navigator.clipboard.writeText(document.querySelector('.contract-document').outerHTML)" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-copy mr-2"></i>Copy HTML</button>
         <button onclick="const container = document.getElementById('contract-preview-container'); container.classList.add('hidden'); container.innerHTML = '';" class="btn-secondary flex-1 py-2 text-sm"><i class="fas fa-times mr-2"></i>Close Preview</button>
    </div>

    <!-- Signing Initiation Panel -->
    <div id="signing-initiation-panel" class="md:col-span-2 mt-4 p-4 border-t-2 border-blue-500/50 bg-blue-500/10 rounded-lg text-center">
        <p class="font-bold text-white mb-2">Step 1: Prepare Document & Apply Signatures</p>
        <p class="text-sm text-text-secondary mb-4">Apply all known signatures and corporate seals on behalf of the parties. This prepares the document for the final, binding workflow.</p>
        <button id="initiate-signing-btn" onclick="Logic.initiateSigningProcess()" class="btn-primary bg-gradient-to-r from-blue-500 to-indigo-600 border-blue-500 w-full md:w-auto px-8 py-3 font-bold">
            <i class="fas fa-pen-fancy mr-2"></i>Launch Signature Suite
        </button>
    </div>

    <!-- UPGRADED: Finalization & Workflow Panel -->
    <div id="signature-workflow-panel" class="md:col-span-2 mt-4 p-4 border-t-2 border-purple-500/50 bg-purple-500/10 rounded-lg text-center hidden">
         <p class="font-bold text-white mb-2">Step 2: Finalize & Initiate Secure Workflow</p>
         <p class="text-sm text-text-secondary mb-4">The document is prepared. This will lock the current version, generate a cryptographic fingerprint, and dispatch secure signing links to all remaining parties.</p>
         <button id="send-for-signature-btn" onclick="Logic.sendForSignature()" class="btn-primary bg-gradient-to-r from-purple-500 to-indigo-600 border-purple-500 w-full md:w-auto px-8 py-3 font-bold">
            <i class="fas fa-paper-plane mr-2"></i>Lock Document & Send to Parties
         </button>
    </div>
</div>
            
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 10px; font-size: 18px;"></i>
                    <h4 style="margin: 0; color: #1e40af; font-size: 16px; font-weight: 600;">Legal Notice & Professional Review Required</h4>
                </div>
                <p style="margin: 8px 0; color: #4b5563; line-height: 1.6;">
                    This document has been generated using premium legal templates and industry-standard language. However, 
                    <strong>professional legal counsel review is mandatory</strong> before execution. This contract contains 
                    binding obligations and should be customized to reflect specific jurisdictional requirements and 
                    transaction particulars.
                </p>
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-top: 15px; border-radius: 0 6px 6px 0;">
                    <p style="margin: 0; color: #92400e; font-size: 14px;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        <strong>Disclaimer:</strong> This generated contract is for reference purposes and requires professional 
                        legal review, jurisdictional customization, and regulatory compliance verification prior to execution.
                    </p>
                </div>
            </div>
            
            <div style="max-height: 800px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 10px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                ${contractHTML}
            </div>`;
        
        container.classList.remove('hidden');
        printContainerContent.innerHTML = contractHTML;
        
        // Add smooth scroll to contract after generation
        setTimeout(() => {
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        // Add notification for successful generation
        if (typeof showNotification === 'function') {
            showNotification('Premium legal contract generated successfully! Please review with legal counsel before execution.', 'success');
        }
    } else {
        console.error('Contract preview containers not found in DOM');
        alert('Error: Contract preview containers not found. Please ensure the page is properly loaded.');
    }
},

// ============================================================================================
// === SEVERE UPGRADE: PROPRIETARY DOCUMENT EXECUTION & MULTI-SIGNATURE SUITE v3.0 ===
// ============================================================================================
            // DEFINITIVE FIX v4.2 - This function now lists ALL parties to allow for modification.
            initiateSigningProcess: () => {
                const sigBlocks = document.querySelectorAll('#contract-preview-container .signature-block');
                const selectEl = document.getElementById('signature-target-select');
                
                selectEl.innerHTML = ''; // Always clear the list first

                if (sigBlocks.length === 0) {
                    return alert("Error: No signature blocks found in the contract. Please define at least one party and generate the contract.");
                }

                // THE FIX: Loop through ALL signature blocks and add them to the dropdown.
                // This removes the filter that prevented modification of already-signed parties.
                sigBlocks.forEach((block, index) => {
                    const partyName = block.querySelector('.signature-line strong').nextSibling.textContent.trim();
                    const option = new Option(`${index + 1}: ${partyName}`, index);
                    selectEl.add(option);
                });

                document.getElementById('signature-modal').showModal();
                Logic.switchSignatureMode('draw'); 
                
                document.getElementById('signature-timestamp').textContent = new Date().toISOString();
                document.getElementById('signature-location').textContent = 'Fetching...';
                fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
                    document.getElementById('signature-location').textContent = `${data.city}, ${data.country_name} (IP: ${data.ip})`;
                }).catch(() => { document.getElementById('signature-location').textContent = 'Location Not Available'; });
            },

// UPGRADED FUNCTION (v3.7) - Manages visibility of Draw, Upload, and Seal panels.
            switchSignatureMode: (mode) => {
                const panels = { draw: 'draw-mode-panel', upload: 'upload-mode-panel', seal: 'seal-mode-panel' };
                const tabs = { draw: 'draw-tab-btn', upload: 'upload-tab-btn', seal: 'seal-tab-btn' };

                Object.keys(panels).forEach(key => {
                    document.getElementById(panels[key]).classList.add('hidden');
                    document.getElementById(tabs[key]).classList.remove('border-green-500', 'text-white');
                });

                document.getElementById(panels[mode]).classList.remove('hidden');
                document.getElementById(tabs[mode]).classList.add('border-green-500', 'text-white');
                
                document.getElementById('signature-modal').dataset.activeMode = mode;

                if (mode === 'draw') Logic.setupSignaturePad();
                if (mode === 'upload') Logic.setupSignatureUpload('signature');
                if (mode === 'seal') Logic.setupSignatureUpload('seal');
            },

            // UPGRADED FUNCTION (v3.7) - Resets all signature/seal inputs for a clean state.
            resetSignatureInputs: () => {
                if (window.signaturePad) window.signaturePad.clear();
                ['signature-upload', 'seal-upload'].forEach(id => {
                    const input = document.getElementById(`${id}-input`);
                    const preview = document.getElementById(`${id}-preview`);
                    const promptEl = document.getElementById(id.replace('upload', 'prompt'));
                    if(input) input.value = '';
                    if(preview) { preview.src = ''; preview.classList.add('hidden'); }
                    if(promptEl) promptEl.classList.remove('hidden');
                });
            },

                        // DEFINITIVE FIX v4.1 - This function now uses a premium dark blue pen color for a realistic signature.
            setupSignaturePad: () => {
                const canvas = document.getElementById('signature-canvas');
                
                const resizeCanvas = () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
                        console.warn("Canvas dimensions are zero, resize delayed or failed.");
                        return;
                    }
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    const context = canvas.getContext("2d");
                    context.scale(ratio, ratio);
                    if (window.signaturePad) {
                        window.signaturePad.clear();
                    }
                };
                
                // Use a premium, deep navy blue color that matches the document's header styles.
                const premiumBlueColor = "#1A237E";

                if (!window.signaturePad) {
                    // THE FIX: The penColor is changed to the premium dark blue.
                    window.signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        penColor: premiumBlueColor 
                    });
                } else {
                    // Also update the color if the pad already exists.
                    window.signaturePad.penColor = premiumBlueColor;
                }
                
                // Use a minimal delay to ensure the modal is fully rendered before sizing the canvas.
                setTimeout(resizeCanvas, 50);
            },

clearSignaturePad: () => { window.signaturePad.clear(); },

            // UPGRADED FUNCTION (v3.8) - This function was missing and is now correctly implemented.
            setupSignatureUpload: (type) => { // type is 'signature' or 'seal'
                // Define the correct element IDs based on the provided type
                const inputId = (type === 'signature') ? 'signature-upload-input' : 'seal-upload-input';
                const previewId = (type === 'signature') ? 'signature-upload-preview' : 'seal-upload-preview';
                const promptId = (type === 'signature') ? 'upload-prompt' : 'seal-prompt';

                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const prompt = document.getElementById(promptId);
                
                // A crucial safety check to prevent silent errors if the HTML is ever changed.
                if (!input || !preview || !prompt) {
                    console.error(`CRITICAL ERROR: Could not find all necessary elements for upload type: '${type}'. Check HTML IDs.`);
                    return;
                }

                // This attaches the event handler that opens the file dialog and shows the preview.
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.remove('hidden');
                            prompt.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };
            },



             // DEFINITIVE FIX v4.2 - This function contains corrected counting logic and allows re-selection.
            applySignature: async () => {
                const modal = document.getElementById('signature-modal');
                const mode = modal.dataset.activeMode;
                const targetSelect = document.getElementById('signature-target-select');
                const selectedPartyIndex = targetSelect.value;
                const applyBtn = modal.querySelector('.btn-primary');
                
                if (selectedPartyIndex === null || selectedPartyIndex === '') {
                    return Logic.showNotification("No signatory selected. Please choose a party to apply the signature/seal for.", 'error', 'Selection Required');
                }

                let dataUrl = '';
                
                if (applyBtn) {
                    applyBtn.disabled = true;
                    applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                }

                try {
                    if (mode === 'draw') {
                        if (window.signaturePad.isEmpty()) throw new Error("Please provide a signature by drawing it on the canvas.");
                        dataUrl = window.signaturePad.toDataURL('image/png');
                    } else {
                        const previewImg = document.getElementById(mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview');
                        if (!previewImg || !previewImg.src || previewImg.src.startsWith('http') || previewImg.classList.contains('hidden')) {
                            const item = mode === 'upload' ? 'signature image' : 'corporate seal';
                            throw new Error(`Please upload a ${item} before applying.`);
                        }
                        dataUrl = await Logic.processImageForTransparency(previewImg.src);
                    }
                    
                    const containersToUpdate = [
                        document.getElementById('contract-preview-container'),
                        document.getElementById('print-content')
                    ];
                    let itemAppliedSuccessfully = false;
                    const dateOfExecution = new Date(document.getElementById('signature-timestamp').textContent).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    containersToUpdate.forEach(container => {
                        if (!container) return;
                        
                        const signatureBlocksInContainer = container.querySelectorAll('.signature-block');
                        const targetBlock = signatureBlocksInContainer[selectedPartyIndex];

                        if (targetBlock) {
                            if (mode === 'draw' || mode === 'upload') {
                                const signatureLine = targetBlock.querySelector('.signature-field .signature-line-border');
                                const dateLine = targetBlock.querySelectorAll('.signature-field .signature-line-border')[2];
                                if (signatureLine) signatureLine.innerHTML = `<img src="${dataUrl}" alt="Digital Signature" style="height: 50px; object-fit: contain; margin-top: -15px; margin-left: 5px;">`;
                                if (dateLine) dateLine.innerHTML = `<span style="font-family: 'Courier New', monospace; font-size: 11pt; padding-left: 5px;">${dateOfExecution}</span>`;
                                itemAppliedSuccessfully = true;
                            } else if (mode === 'seal') {
                                const targetField = targetBlock.querySelectorAll('.signature-field .signature-line-border')[3];
                                if (targetField) {
                                    targetField.innerHTML = `<img src="${dataUrl}" alt="Corporate Seal" style="height: 60px; width: 60px; object-fit: contain; margin-left: 5px; opacity: 0.8;">`;
                                    itemAppliedSuccessfully = true;
                                }
                            }

                            if (container.id === 'contract-preview-container') {
                                targetBlock.style.borderColor = 'var(--success-color)';
                                targetBlock.style.backgroundColor = 'rgba(34, 197, 94, 0.05)';
                            }
                        }
                    });
                    
                    if (!itemAppliedSuccessfully) {
                        throw new Error("Critical Error: Could not find the target signature/seal block in the document.");
                    }

                    modal.close();
                    Logic.resetSignatureInputs(); 
                    document.getElementById('signature-workflow-panel').classList.remove('hidden');
                    
                    // THE FIX for the incorrect count.
                    let remainingUnsignedParties = 0;
                    const allPartyBlocks = document.querySelectorAll('#contract-preview-container .signature-block');
                    allPartyBlocks.forEach(block => {
                        // A party is considered "unsigned" if their primary signature line (the first one) is empty.
                        const mainSignatureField = block.querySelector('.signature-field .signature-line-border');
                        if (mainSignatureField && !mainSignatureField.querySelector('img')) {
                            remainingUnsignedParties++;
                        }
                    });

                    const launchBtn = document.getElementById('initiate-signing-btn');
                    if (launchBtn) {
                        // THE FIX: The button is no longer disabled, allowing for re-selection and modification.
                        launchBtn.disabled = false;
                        if (remainingUnsignedParties > 0) {
                            launchBtn.innerHTML = `<i class="fas fa-pen-fancy mr-2"></i>Sign for Another Party (${remainingUnsignedParties} remaining)`;
                        } else {
                            launchBtn.innerHTML = `<i class="fas fa-check-double mr-2"></i>All Parties Signed (Ready to Finalize)`;
                        }
                    }

                    const partyName = targetSelect.options[targetSelect.selectedIndex].text;
                    const action = (mode === 'seal') ? 'Corporate Seal' : 'Signature';
                    Logic.showNotification(`${action} successfully applied for ${partyName}. The document preview has been updated.`, 'success', 'Application Successful');

                } catch (error) {
                    console.error("Application failed:", error);
                    Logic.showNotification(error.message, 'error', 'Application Failed');
                } finally {
                    if (applyBtn) {
                        applyBtn.disabled = false;
                        applyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Apply to Document';
                    }
                }
            },


// This function simulates the "military-grade" hashing on the client for demonstration
simpleHash: async (str) => {
                const buffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

                        // DEFINITIVE UPGRADE v4.4 - This function has been refactored.
            // Its ONLY responsibility now is to display the premium confirmation modal.
            sendForSignature: () => {
                document.getElementById('finalization-modal').showModal();
            },

          // REPLACE the existing `executeFinalizationWorkflow` function with this upgraded version.

            // RE-ENGINEERED FUNCTION v5.1 - Client-centric PDF generation with embedded styles.
            // This version has NO Google Drive or Sheets dependency and ensures high-quality PDF output.
            executeFinalizationWorkflow: async () => {
                document.getElementById('finalization-modal').close();
                const btn = document.getElementById('send-for-signature-btn');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF & Dispatching...`;

                try {
                    // --- STEP 1: GATHER FINAL DOCUMENT DATA & STYLES ---
                    const contractElement = document.getElementById('print-content');
                    if (!contractElement || !contractElement.innerHTML) {
                        throw new Error("Could not find the printable contract content. Please generate the contract first.");
                    }
                    
                    // NEW: Call our helper to get all the high-quality print CSS rules as a string.
                    const premiumPrintStyles = Logic.getPrintStyles();
                    if (!premiumPrintStyles) {
                        console.warn("No print styles were extracted. The final PDF may not be styled correctly.");
                    }

                    const finalDocumentHTML = contractElement.innerHTML;
                    const documentFingerprint = await Logic.simpleHash(finalDocumentHTML);
                    const agreementReferenceMatch = finalDocumentHTML.match(/AGREEMENT REFERENCE CODE:<\/span>\s*<span class="metadata-value">([^<]+)<\/span>/);
                    const agreementReference = agreementReferenceMatch ? agreementReferenceMatch[1].trim() : `GECAN-DOC-${Date.now()}`;
                    
                    const allPartiesFromState = AppState.modeler.legal.groups.flatMap(g => g.parties);
                    const recipientEmails = allPartiesFromState
                        .map(p => p.email)
                        .filter(email => email && email.includes('@'));

                    if (recipientEmails.length === 0) {
                        throw new Error("No valid recipient email addresses found in the IMFPA party details. Please add them before finalizing.");
                    }

                    // --- STEP 2: BUILD THE FULLY-STYLED, SELF-CONTAINED HTML FOR PDF CONVERSION ---
                    // This is the crucial new step.
                    const fullyStyledHtmlForPdf = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>${agreementReference}</title>
                            <style>
                                /* 
                                 * All premium print styles are injected here, ensuring the back-end
                                 * PDF generator renders the document perfectly.
                                 */
                                ${premiumPrintStyles}
                            </style>
                        </head>
                        <body>
                            <!-- The exact, cleaned contract HTML is placed here. -->
                            ${finalDocumentHTML}
                        </body>
                        </html>
                    `;

                    // --- STEP 3: BUILD THE PREMIUM PAYLOAD & EMAIL ---
                    const payload = {
                        agreementReference,
                        documentFingerprint,
                        parties: allPartiesFromState,
                        recipientEmails: recipientEmails.join(','),
                        bccEmails: 'pennworthventures@gmail.com,punchisum@gmail.com',
                        emailSubject: `FULLY EXECUTED: GECAN™ Agreement Ref: ${agreementReference}`,
                        fileName: `${agreementReference}_EXECUTED.pdf`
                    };
                    
                    payload.emailBody = Logic.generatePremiumEmailTemplate(payload);

                    // --- STEP 4: CALL BACK-END TO GENERATE PDF AND SEND EMAIL ---
                    // MODIFIED: We now pass the 'fullyStyledHtmlForPdf' string to the back-end.
                    console.log("SENDING DISPATCH PAYLOAD TO BACK-END...");
                    const response = await GAS.run('generatePdfAndDispatchEmail', payload, fullyStyledHtmlForPdf);

                    if (!response.success) {
                        throw new Error(response.message || "The server failed to generate the PDF or dispatch the email.");
                    }
                    
                    btn.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Dispatched Successfully`;
                    Logic.showNotification(
                        `The finalized PDF has been generated and dispatched to all ${recipientEmails.length} parties. Please check your email.`,
                        'success',
                        'Document Dispatched'
                    );

                } catch (err) {
                    console.error("Dispatch Failed:", err);
                    Logic.showNotification(err.message, 'error', 'Dispatch Failed');
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i>Lock Document & Send to Parties`;
                }
            },
             // =======================================================================
            // === NEW FUNCTION: PREMIUM EMAIL TEMPLATE GENERATOR (v1.0) ===
            // This is the missing function that generates the final email body.
            // =======================================================================
            generatePremiumEmailTemplate: (payload) => {
                const nowSGT = new Date().toLocaleString("en-US", { timeZone: "Asia/Singapore", dateStyle: 'full', timeStyle: 'long' });
                const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');

                return `
                <html>
                <body style="font-family: Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px;">
                    <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;">
                            <h1 style="margin: 0; font-size: 24px;">GECAN™ | Executed Agreement Attached</h1>
                        </div>
                        <div style="padding: 30px;">
                            <p>Dear Contracting Parties,</p>
                            <p>Please find attached the fully executed legal document pertaining to the referenced transaction. This document has been finalized and its state has been cryptographically recorded for audit purposes.</p>
                            
                            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                                <h3 style="margin-top: 0; color: #0369a1;">Agreement Details</h3>
                                <p style="margin: 5px 0;"><strong>Agreement Reference:</strong> ${payload.agreementReference}</p>
                                <p style="margin: 5px 0;"><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px; color: #555;">${payload.documentFingerprint}</code></p>
                                <p style="margin: 5px 0;"><strong>Finalization Timestamp:</strong> ${nowSGT}</p>
                            </div>

                            <h3 style="color: #0369a1;">Parties to this Agreement:</h3>
                            <ul style="padding-left: 20px;">
                                ${partyListHTML}
                            </ul>

                            <p>All parties should retain a copy of the attached PDF for their records. No further action is required unless otherwise specified within the document's terms.</p>
                            <p>Thank you for your cooperation.</p>
                            <p style="margin-top: 25px;"><strong>Sincerely,<br>The GECAN™ Transactional Systems</strong></p>
                        </div>
                        <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                            <p style="margin: 0;"><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication and any attachments are strictly confidential, legally privileged, and intended solely for the authorized recipients. Any unauthorized review, use, disclosure, or distribution is strictly prohibited.</p>
                        </div>
                    </div>
                </body>
                </html>
                `;
            },

            // =======================================================================
            // === NEW FUNCTION: PREMIUM EMAIL TEMPLATE GENERATOR (v1.0) ===
            // This is the missing function that generates the final email body.
            // =======================================================================
            generatePremiumEmailTemplate: (payload) => {
                const nowSGT = new Date().toLocaleString("en-US", { timeZone: "Asia/Singapore", dateStyle: 'full', timeStyle: 'long' });
                const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');

                return `
                <html>
                <body style="font-family: Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px;">
                    <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;">
                            <h1 style="margin: 0; font-size: 24px;">GECAN™ | Executed Agreement Attached</h1>
                        </div>
                        <div style="padding: 30px;">
                            <p>Dear Contracting Parties,</p>
                            <p>Please find attached the fully executed legal document pertaining to the referenced transaction. This document has been finalized and its state has been cryptographically recorded for audit purposes.</p>
                            
                            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                                <h3 style="margin-top: 0; color: #0369a1;">Agreement Details</h3>
                                <p style="margin: 5px 0;"><strong>Agreement Reference:</strong> ${payload.agreementReference}</p>
                                <p style="margin: 5px 0;"><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px; color: #555;">${payload.documentFingerprint}</code></p>
                                <p style="margin: 5px 0;"><strong>Finalization Timestamp:</strong> ${nowSGT}</p>
                            </div>

                            <h3 style="color: #0369a1;">Parties to this Agreement:</h3>
                            <ul style="padding-left: 20px;">
                                ${partyListHTML}
                            </ul>

                            <p>All parties should retain a copy of the attached PDF for their records. No further action is required unless otherwise specified within the document's terms.</p>
                            <p>Thank you for your cooperation.</p>
                            <p style="margin-top: 25px;"><strong>Sincerely,<br>The GECAN™ Transactional Systems</strong></p>
                        </div>
                        <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                            <p style="margin: 0;"><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication and any attachments are strictly confidential, legally privileged, and intended solely for the authorized recipients. Any unauthorized review, use, disclosure, or distribution is strictly prohibited.</p>
                        </div>
                    </div>
                </body>
                </html>
                `;
            },

// ======================= START: INSERT THE NEW CODE HERE =======================
            // =======================================================================
            // === NEW FUNCTION: PRINT STYLE EXTRACTOR (v1.0) ===
            // This function captures the high-quality print CSS for back-end PDF generation.
            // =======================================================================
            getPrintStyles: () => {
                let printCss = '';
                // Iterate through all stylesheets loaded on the page
                for (const sheet of document.styleSheets) {
                    try {
                        // Iterate through all rules in a stylesheet
                        for (const rule of sheet.cssRules) {
                            // Check if the rule is an @media rule and if it's for 'print'
                            if (rule.type === CSSRule.MEDIA_RULE && rule.media.mediaText === 'print') {
                                // If it matches, iterate through the rules *inside* the @media block
                                for (const printRule of rule.cssRules) {
                                    // Append the text content of each rule to our string
                                    printCss += printRule.cssText + '\n';
                                }
                            }
                        }
                    } catch (e) {
                        // Catch and log potential security errors when accessing cross-origin stylesheets
                        console.warn("Could not access stylesheet for print styles:", sheet.href, e);
                    }
                }
                // Return the complete block of CSS text
                return printCss;
            },
// ======================== END: INSERT THE NEW CODE HERE ========================




            // ===== END: UPGRADED INSTITUTIONAL MODELER LOGIC =====
        };

        // --- SECTION 6: BOOTSTRAP ---
        document.addEventListener('DOMContentLoaded', Logic.init);
    </script>
</body>
</html>
