<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>GECAN™ XDealFlow | Intelligent Toolkits</title>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE SVG FAVICON IMPLEMENTATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- ==================================================================================== -->
    <!-- === DEFINITIVE PINNACLE CSS (v41.0 - Unification & Severe Upgrade) === -->
    <!-- ==================================================================================== -->
    <style>
        /* ========================================================================= */
/* === PINNACLE KINETIC TRANSITIONS for Toolkit Switching === */
/* ========================================================================= */
#active-toolkit-container {
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}

#active-toolkit-container.transitioning-out {
    opacity: 0;
    transform: translateY(20px) scale(0.98);
}

#active-toolkit-container.transitioning-in {
    opacity: 0;
    transform: translateY(-20px) scale(0.98);
    /* The animation back to default is handled by the base class styles */
}
        
        /* --- A. CORE THEME & VARIABLES (FROM INDEX.HTML BENCHMARK) --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300..700&display=swap');

        :root {
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --background-primary: #0a0a0f; --background-secondary: #1e293b;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --text-diamond: #f8fafc; --text-platinum: #e2e8f0;
            --text-silver: #cbd5e1; --text-muted: #94a3b8; --text-subtle: #64748b;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
            --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
            --glow-gold: rgba(251, 191, 36, 0.6); --glow-diamond: rgba(248, 250, 252, 0.9);
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --gradient-luxury: linear-gradient(180deg, #0f172a, #1e293b, #334155);
            --shadow-standard: 0 4px 6px -1px rgba(0, 0, 0, 0.6); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-luxury: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            --transform-hover: translateY(-8px) rotateX(5deg) scale(1.03);
            --transform-active: translateY(-12px) rotateX(8deg) scale(1.05);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
            --status-active: #22c55e; --status-pending: #f59e0b; --status-blacklisted: #ef4444;
            --status-withdrawn: #6b7280; --status-limited: #3b82f6;
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --premium-gold: #D4AF37; --premium-gold-glow: rgba(212, 175, 55, 0.4);
            --premium-bg-dark: #0a0f1c; --premium-bg-light: #161d31; --premium-border: #2a3552;
            --premium-text-primary: #f0f4ff; --premium-text-secondary: #a0aec0;
        }

        /* --- B. BASE STYLES & RESETS (BENCHMARK STANDARD) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--text-platinum); background: var(--background-primary); min-height: 100vh; position: relative; overflow-x: hidden; }
        body.modal-open { overflow: hidden; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; pointer-events: none; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. KINETIC ANIMATIONS & EFFECTS (PINNACLE STANDARD) --- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes premium-shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes header-shimmer { 0% { left: -150%; } 100% { left: 150%; } }
        @keyframes premium-pulse { 0% { transform: scale(1); box-shadow: 0 0 30px var(--glow-azure); } 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }
        @keyframes vertical-energy-scan { 0% { top: -50%; opacity: 0; } 50% { top: 50%; opacity: 1; } 100% { top: 150%; opacity: 0; } }
        @keyframes icon-glow-rotate { 0%, 100% { transform: rotate(0deg); filter: drop-shadow(0 0 8px currentColor); } 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

        /* --- D. GLOBAL COMPONENTS (PREMIUM HEADER, FOOTER, NAV) --- */
        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); perspective: 1500px; overflow: hidden; }
        .premium-header::after { content: ''; position: absolute; top: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: header-shimmer 7s ease-in-out infinite; animation-delay: 2s; }
        .premium-header:hover { transform: translateY(-4px) rotateX(5deg); box-shadow: var(--shadow-premium), 0 0 70px var(--glow-royal); }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-back { transform: rotateY(180deg); } .logo-back img { height: 100%; width: auto; object-fit: contain; }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; position: relative; overflow: hidden; }
        .logo-separator::after { content: ''; position: absolute; top: -50%; left: 50%; transform: translateX(-50%); width: 200%; height: 60px; background: radial-gradient(ellipse, rgba(248, 250, 252, 0.9), rgba(14, 165, 233, 0.7), transparent 70%); border-radius: 50%; filter: blur(20px); z-index: 1; animation: vertical-energy-scan 4s ease-in-out infinite; }
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: var(--gradient-primary); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(.active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .premium-footer { background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); border-top: 1px solid var(--border-premium); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); position: relative; overflow: hidden; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .premium-footer:hover { transform: translateY(-4px); box-shadow: 0 -15px 50px rgba(0,0,0,0.6), 0 0 80px var(--glow-royal); }
        .premium-footer::before { content: ''; position: absolute; top: 0; left: -100%; width: 200%; height: 100%; background: linear-gradient(110deg, transparent 30%, rgba(248, 250, 252, 0.08) 50%, transparent 70%); animation: premium-shimmer 5s ease-in-out infinite; opacity: 0; transition: opacity 0.5s; }
        .premium-footer:hover::before { opacity: 1; }
        .premium-footer h3, .premium-footer h4 { font-family: 'Orbitron', monospace; color: var(--text-diamond); }
        
        /* --- E. MODAL & DIALOG STYLES (UNIFIED & UPGRADED) --- */
        dialog { display: none; }
        dialog[open] { display: flex; animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        dialog::backdrop { background: rgba(3, 7, 18, 0.85); backdrop-filter: blur(16px); animation: fadeIn 0.4s ease; }
        .modal-content { border: 1px solid var(--premium-border); box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75); }
        /* Secure Engagement (Wallet Submission) Modal */
        #engagement-modal-content { background: radial-gradient(circle at top, var(--premium-bg-light), var(--premium-bg-dark) 80%); color: var(--premium-text-primary); }
        .form-input, .form-select { background-color: var(--background-primary); border: 1px solid var(--border-premium); color: var(--text-platinum); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s; appearance: none; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-azure); box-shadow: 0 0 0 3px var(--glow-azure); }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em; }
        .btn-engagement { font-weight: 700; color: var(--text-diamond); padding: 0.75rem 2rem; border-radius: 1rem; transition: all 0.5s; cursor: pointer; transform-style: preserve-3d; background: var(--gradient-primary); box-shadow: var(--shadow-ultra); }
        .btn-engagement:hover:not(:disabled) { transform: var(--transform-active); box-shadow: var(--shadow-luxury), 0 0 60px var(--glow-azure); }
        .btn-engagement:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- F. TOOLKIT-SPECIFIC STYLES (MERGED & REFINED) --- */
        /* Wallet Forensics */
        .score-gauge svg { transform: rotate(-90deg); filter: drop-shadow(0 0 10px currentColor); }
        .score-gauge-fg { transition: stroke-dashoffset 1.8s cubic-bezier(0.65, 0, 0.35, 1), stroke 0.6s; stroke-linecap: round; }
        .gauge-low { color: var(--status-active); } .gauge-medium { color: var(--status-pending); }
        .gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
        .risk-CRITICAL { --flag-color: var(--critical-color); } .risk-HIGH { --flag-color: var(--error-color); }
        .risk-MEDIUM { --flag-color: var(--status-pending); } .risk-LOW { --flag-color: var(--status-active); }
        .text-risk-color { color: var(--flag-color); }
        .border-risk-color { border-left-color: var(--flag-color); }
        .transaction-item { transition: all 0.3s; border-left: 4px solid transparent; }
        .transaction-item:hover { transform: translateX(5px) scale(1.02); background-color: var(--background-secondary); }
        .transaction-inbound { border-left-color: var(--status-active); }
        .transaction-outbound { border-left-color: var(--error-color); }

        /* Institutional Modeler & IMFPA */
        .deal-type-card { background: var(--background-glass); border: 1px solid var(--border-secondary); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .deal-type-card:hover { transform: var(--transform-hover); border-color: var(--primary-azure); box-shadow: var(--shadow-premium), 0 0 40px var(--glow-azure); }
        .deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.02); }
        .deal-type-icon { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1), padding-top 0.5s, opacity 0.5s; opacity: 0; }
        .collapsible-content.expanded { max-height: 2000px; padding-top: 1.5rem; opacity: 1; }
        #imfpa-modal-content { background: radial-gradient(circle at top left, var(--premium-bg-light), var(--premium-bg-dark) 70%); border: 1px solid var(--premium-border); box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75), 0 0 0 1px var(--premium-gold-glow); }
        #imfpa-modal-content .form-input, #imfpa-modal-content .form-select { background-color: var(--premium-bg-dark) !important; border: 1px solid var(--premium-border) !important; color: var(--premium-text-primary) !important; }
        #imfpa-modal-content .form-input:focus, #imfpa-modal-content .form-select:focus { border-color: var(--premium-gold) !important; box-shadow: 0 0 0 3px var(--premium-gold-glow) !important; }
        .imfpa-section-title { font-size: 1.25rem; font-weight: 700; color: var(--premium-text-primary); border-left: 3px solid var(--premium-gold); padding-left: 1rem; margin-bottom: 1.5rem; }
        .allocation-group-card { background: linear-gradient(145deg, var(--premium-bg-light), var(--premium-bg-dark)); border: 1px solid var(--premium-border); transition: all 0.4s; }
        .allocation-group-card:hover { transform: translateY(-5px) scale(1.02); border-color: var(--premium-gold); box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 15px var(--premium-gold-glow); }

        /* --- G. PRINT STYLES (LEGAL DOCUMENT STANDARD) --- */
        #print-area { display: none; }
        @media print {
            .print-hide { display: none !important; }
            #print-area { display: block !important; }
            body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            @page {
                size: A4; margin: 2cm;
                @top-left { content: var(--agreement-reference, "GECAN-DOCUMENT"); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
                @top-right { content: "GECAN™ | CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
                @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
            }
            .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; }
            .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #D4AF37; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
            .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; page-break-after: avoid; }
            .p-signature-block { margin-top: 40pt; page-break-inside: avoid; }
            .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="particles-js" class="print-hide"></div>
    
    <!-- ========================================================================= -->
    <!-- === 1. ULTRA-PREMIUM HEADER (BENCHMARK STANDARD) === -->
    <!-- ========================================================================= -->
    <header class="premium-header p-4 md:p-6 print-hide">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="#" id="logo-link" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back"><img src=""></div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">XDealFlow Intelligent Toolkits</h1>
                        <p class="text-sm text-gray-400 font-mono">Premium Institutional Platform</p>
                    </div>
                </a>
            </div>
            <div id="desktop-nav-placeholder" class="flex-grow">
                <!-- Nav buttons are dynamically injected here by JavaScript -->
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Sidebar Menu -->
            <aside class="w-full lg:w-80 flex-shrink-0">
                <div class="bg-[var(--background-glass)] backdrop-filter backdrop-blur-2xl border border-[var(--border-color)] rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-[var(--primary-azure)]"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <!-- Main Content Area -->
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6"><div class="w-16 h-16 border-4 border-[var(--primary-azure)] border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-[var(--primary-azure)] opacity-20"></div></div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2><p class="text-[var(--text-silver)]">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    <!-- Container for printable contract content -->
    <div id="print-area">
        <div id="print-content"></div>
    </div>

    <!-- ========================================================================= -->
    <!-- === 2. MODALS & DIALOGS (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->

    <!-- Wallet Submission Secure Engagement Modal -->
    <dialog id="engagement-modal" class="p-0 bg-transparent max-w-2xl w-full print-hide">
        <div id="engagement-modal-content" class="modal-content rounded-2xl w-full flex flex-col max-h-[95vh]">
            <!-- Content Injected by JS -->
        </div>
    </dialog>
    
    <!-- IMFPA & NCNDA Contract Suite Modal -->
    <dialog id="imfpa-modal" class="p-0 bg-transparent max-w-7xl w-full print-hide">
        <div id="imfpa-modal-content" class="modal-content rounded-2xl w-full flex flex-col max-h-[90vh]">
            <!-- Content Injected by JS -->
        </div>
    </dialog>

    <!-- Signature Suite Modal -->
    <dialog id="signature-modal" class="p-0 bg-transparent max-w-2xl w-full print-hide">
        <div class="modal-content bg-[var(--background-glass-premium)] rounded-2xl w-full flex flex-col max-h-[95vh] text-white">
            <div class="p-6 border-b border-[var(--premium-border)]">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                        <p class="text-sm text-text-muted">Apply a legally binding signature and/or corporate seal.</p>
                    </div>
                    <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white">&times;</button>
                </div>
                <div>
                    <label for="signature-target-select" class="block text-sm font-semibold mb-2">Apply signature/seal for:</label>
                    <select id="signature-target-select" class="form-select w-full bg-[var(--premium-bg-dark)] border-[var(--premium-border)] text-white"></select>
                </div>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex border-b border-[var(--premium-border)] mb-4">
                    <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                    <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                    <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
                </div>
                <div id="draw-mode-panel"><canvas id="signature-canvas" class="bg-[var(--premium-bg-dark)] border border-[var(--premium-border)] rounded-lg w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
                <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--premium-border)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)]"><img id="signature-upload-preview" class="hidden max-h-44"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div>
                <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--premium-border)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)]"><img id="seal-upload-preview" class="hidden max-h-44"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div>
            </div>
            <div class="p-6 border-t border-[var(--premium-border)] bg-[var(--background-secondary)]"><div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div><button onclick="Logic.applySignature()" class="btn-engagement w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button></div>
        </div>
    </dialog>

    <!-- Universal Notification Modal -->
    <dialog id="notification-modal" class="p-0 bg-transparent max-w-lg w-full print-hide">
        <div id="notification-modal-content" class="modal-content bg-[var(--background-glass-premium)] rounded-2xl w-full flex flex-col text-white">
            <!-- Content Injected by JS -->
        </div>
    </dialog>

    <!-- Finalization Confirmation Modal -->
    <dialog id="finalization-modal" class="p-0 bg-transparent max-w-xl w-full print-hide">
        <!-- Content Injected by JS -->
    </dialog>
    
    <!-- ========================================================================= -->
    <!-- === 3. ULTRA-PREMIUM FOOTER (BENCHMARK STANDARD) === -->
    <!-- ========================================================================= -->
    <footer class="premium-footer print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information and tools on this platform are for informational and modeling purposes only. GECAN™ makes no warranties regarding the accuracy, completeness, or performance of any generated analysis or legal document.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Professional Review Required</h4>
                    <p class="text-xs leading-relaxed">All generated documents require mandatory review by qualified legal counsel. Users must conduct independent due diligence and agree to indemnify GECAN™ from any liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

<script>
    // ====================================================================================
    // === PINNACLE JAVASCRIPT ENGINE v42.0 (PRODUCTION-READY & SEVERELY UPGRADED) ===
    // ====================================================================================

    // --- I. API & STATE MANAGEMENT (BENCHMARK STANDARD) ---
    const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";

    const AppState = {
        isInitialized: false,
        activeToolkit: 'Dashboard',
        marketData: [],
        toolkits: {
            Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Overview of all available institutional tools.', color: 'from-blue-500 to-purple-600' },
            WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Advanced wallet due diligence and risk assessment.', color: 'from-red-500 to-orange-600' },
            InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler', icon: 'fa-sitemap', description: 'Model complex institutional deals and generate contracts.', color: 'from-sky-500 to-indigo-600' },
        },
        walletAnalysis: { address: null, report: null, isLoading: false, submissionTarget: null },
        modeler: {
            activeDealType: 'AssetSwap',
            assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
            commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'United States', port: 'Houston', incoterms: 'FOB', procedures: `...`, pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 0, settlementAssetKey: 'USD' },
            cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
            sblcMonetization: { faceValue: 100000000, ltv: 80 },
            pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
            legal: { isModalOpen: false, jurisdiction: 'Singapore, Dubai, England, Wales', totalCommission: 0, spaReferenceCode: '', groups: [] }
        }
    };

    // --- II. CORE UTILITIES & HELPERS (BENCHMARK STANDARD) ---
    const Utils = {
        formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
        formatNumber: (num, decimals = 2) => {
            if (typeof num !== 'number' || isNaN(num)) return 'N/A';
            if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T';
            if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
            if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
            return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        },
        debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
        getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
        getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
        getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
    };

    const SFX = {
        _sounds: {},
        _isInitialized: false,
        initialize: () => {
            if (SFX._isInitialized) return;
            const soundLibrary = {
                hover: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_hover_deep_01.mp3',
                click: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_click_sharp_02.mp3',
                launch: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_launch_digital_01.mp3',
                deploy: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_deploy_futuristic_03.mp3',
                error: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_error_digital_01.mp3',
                success: 'https://cdn.jsdelivr.net/gh/gecan/GECAN-Static-Assets/sounds/ui_success_chime_01.mp3',
            };
            for (const key in soundLibrary) {
                SFX._sounds[key] = new Audio(soundLibrary[key]);
                SFX._sounds[key].volume = 0.4;
            }
            SFX._isInitialized = true;
            const unlockAudio = () => { Object.values(SFX._sounds).forEach(s => { s.play().then(() => s.pause()) }); document.body.removeEventListener('click', unlockAudio); };
            document.body.addEventListener('click', unlockAudio, { once: true });
        },
        play: (soundName) => {
            if (SFX._sounds[soundName]) {
                SFX._sounds[soundName].currentTime = 0;
                SFX._sounds[soundName].play().catch(e => {});
            }
        }
    };

    const commodityData = {
        unitsOfMeasure: ['MT', 'BBL', 'GAL', 'LBS', 'T', 'OZ', 'MMBtu'],
        incoterms: [{ value: 'FOB', label: 'FOB (Free On Board)' }, { value: 'CIF', label: 'CIF (Cost, Insurance, and Freight)' }, { value: 'TTV', label: 'TTV (Tank-to-Vessel)' }, { value: 'DDP', label: 'DDP (Delivered Duty Paid)' }],
        countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'UAE', 'Netherlands', 'Singapore', 'UK', 'Qatar'],
        specifications: { 'WTI-BBL-USD': { uom: 'BBL', spec: 'API Gravity: 40-42, Sulfur Content: <0.42%', incoterm: 'FOB', origin: 'USA' } }
    };

    // --- III. UI RENDERING ENGINE (SEVERELY UPGRADED) ---
    const UI = {
        init: () => {
            if (typeof particlesJS !== 'undefined') {
                particlesJS('particles-js', { "particles": { "number": { "value": 50 }, "color": { "value": ["#0ea5e9", "#6366f1", "#8b5cf6"] }, "opacity": { "value": 0.6, "random": true }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#475569", "opacity": 0.4 }, "move": { "enable": true, "speed": 1, "random": true, "out_mode": "out" } }, "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } } } });
            }
        },
        renderToolkitMenu: () => {
    const menuContainer = document.getElementById('toolkit-menu');
    if (!menuContainer) return;

    menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => {
        const isActive = AppState.activeToolkit === t.id;
        
        // This HTML structure is severely upgraded to mirror the complex, multi-layered
        // component style of the index.html benchmark for maximum visual fidelity.
        return `
            <!-- TOOLKIT BUTTON: SEVERE UPGRADE - Pinnacle Grade Component -->
            <button 
                onclick="Logic.setActiveToolkit('${t.id}'); SFX.play('click');" 
                onmouseover="SFX.play('hover')"
                class="nav-btn w-full text-left p-4 !rounded-xl group relative ${isActive ? 'active' : ''}"
                style="perspective: 800px;"
            >
                <!-- NEW: Active State Indicator Bar (Animated) -->
                <div class="absolute left-0 top-1/4 bottom-1/4 w-1.5 bg-[var(--gradient-primary)] rounded-r-full transition-all duration-500 ease-in-out shadow-lg shadow-[var(--glow-azure)] ${isActive ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-4'}"></div>

                <!-- 3D Icon Flipper (Benchmark Standard) -->
                <div class="nav-icon-wrapper !w-12 !h-12 ml-2">
                    <div class="nav-icon-flipper">
                        <!-- Front Face: Standard Icon -->
                        <div class="nav-icon-face nav-icon-front w-full h-full rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center text-xl text-white shadow-lg group-hover:scale-110 transition-transform duration-300">
                            <i class="fas ${t.icon}"></i>
                        </div>
                        <!-- Back Face: Glowing Icon on Hover (Pinnacle Aesthetic) -->
                        <div class="nav-icon-face nav-icon-back w-full h-full rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center text-xl text-white shadow-lg" style="text-shadow: 0 0 15px rgba(255,255,255,0.8), 0 0 8px rgba(255,255,255,0.6);">
                            <i class="fas ${t.icon}"></i>
                        </div>
                    </div>
                </div>

                <!-- Text Content with 3D Depth -->
                <div class="flex-1 transition-transform duration-300 group-hover:translate-x-1" style="transform: translateZ(10px);">
                    <div class="font-semibold text-base">${t.name}</div>
                    <div class="text-xs opacity-75 mt-1">${t.description.split('.')[0]}</div>
                </div>

                <!-- Chevron Indicator with Kinetic Hover Effect -->
                <i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-all duration-300 group-hover:translate-x-1" style="transform: translateZ(10px);"></i>
            </button>`;
    }).join('');
},
        renderActiveToolkit: () => {
    const container = document.getElementById('active-toolkit-container');
    if (!container) {
        console.error("CRITICAL RENDER FAILURE: #active-toolkit-container not found in DOM.");
        return;
    }

    // --- 1. CINEMATIC TRANSITION: Fade Out Existing Content ---
    // Instead of instantly replacing the HTML, we first apply a class to gracefully
    // fade out the current toolkit, providing a smooth visual transition.
    container.classList.add('transitioning-out');

    // After the fade-out animation completes (300ms), we perform the DOM update.
    setTimeout(() => {
        try {
            // --- 2. DYNAMIC CONTENT RENDERING ---
            // Determine which specific UI rendering function to call based on the active toolkit state.
            const renderFunc = UI[`render${AppState.activeToolkit}UI`];

            if (typeof renderFunc === 'function') {
                // If a valid renderer exists, generate the new HTML.
                const newToolkitHTML = renderFunc();
                // Replace the container's content with the newly generated toolkit UI.
                container.innerHTML = newToolkitHTML;

                // --- 3. BIND DYNAMIC EVENT LISTENERS ---
                // It is critical to re-bind events *after* the new HTML is in the DOM.
                Logic.bindActiveToolkitEvents();
            } else {
                // --- 4. ROBUST ERROR HANDLING (PINNACLE STANDARD) ---
                // If a rendering function is missing for a toolkit, display a premium,
                // user-friendly error message instead of failing silently or breaking the page.
                const errorMessage = `
                    <div class="h-full flex flex-col items-center justify-center text-center p-8 animate-fade-in-up bg-[var(--background-glass)] rounded-2xl border border-[var(--error-color)]">
                        <div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8 border-2 border-red-500/50 relative">
                            <i class="fas fa-exclamation-triangle fa-3x text-red-500" style="text-shadow: 0 0 15px rgba(239, 68, 68, 0.5);"></i>
                            <div class="absolute inset-0 rounded-full animate-ping bg-red-500 opacity-25"></div>
                        </div>
                        <h3 class="text-2xl font-bold font-orbitron text-white mb-4">Render Engine Error</h3>
                        <p class="text-[var(--text-silver)] max-w-md leading-relaxed">
                            The UI rendering function for the '${AppState.activeToolkit}' toolkit could not be found. This module may be under development or a script error has occurred.
                        </p>
                    </div>`;
                container.innerHTML = errorMessage;
                SFX.play('error'); // Provide audio feedback for the error state.
            }
        } catch (error) {
            console.error(`Fatal error during rendering of '${AppState.activeToolkit}':`, error);
            // Display a critical failure message if the render function itself throws an error.
            container.innerHTML = `<div class="text-center p-8 text-error-color"><h3>A critical error occurred while rendering this toolkit.</h3><p class="text-sm">${error.message}</p></div>`;
        } finally {
            // --- 5. CINEMATIC TRANSITION: Fade In New Content ---
            // Remove the 'transitioning-out' class and add 'transitioning-in' to
            // trigger the fade-in animation, revealing the new content smoothly.
            container.classList.remove('hidden', 'transitioning-out');
            container.classList.add('transitioning-in');

            // Clean up the animation class after it completes to keep the DOM clean.
            setTimeout(() => {
                container.classList.remove('transitioning-in');
            }, 300);
        }
    }, 300); // This timeout duration must match the CSS transition duration.

    // --- 6. STATIC UI REFRESH ---
    // The toolkit menu is outside the main container and can be re-rendered immediately
    // to instantly reflect the active state change.
    UI.renderToolkitMenu();
},
        renderDashboardUI: () => {
    // --- Pinnacle-Grade Color & Glow Matrix (Expanded for Future Toolkits) ---
    // This centralized matrix provides a single source of truth for theming and ensures
    // absolute consistency with the benchmark's color and glow variable system.
    const colorMap = {
        'from-blue-500': { primary: 'var(--primary-sapphire)', glow: 'var(--glow-sapphire)' },
        'from-red-500': { primary: 'var(--error-color)', glow: 'rgba(239, 68, 68, 0.7)' },
        'from-sky-500': { primary: 'var(--primary-azure)', glow: 'var(--glow-azure)' },
        'from-yellow-500': { primary: 'var(--status-pending)', glow: 'rgba(245, 158, 11, 0.7)' },
        'from-green-500': { primary: 'var(--status-active)', glow: 'rgba(34, 197, 94, 0.7)' },
        'from-purple-500': { primary: 'var(--primary-amethyst)', glow: 'var(--glow-amethyst)' },
        // Future-proofing: Add more potential toolkit colors here.
        'from-indigo-500': { primary: 'var(--primary-royal)', glow: 'var(--glow-royal)' },
        'from-amber-500': { primary: 'var(--brand-gecan-gold)', glow: 'var(--glow-gold)' },
    };

    // The function returns a single, unabridged template literal containing the complete UI.
    return `
        <!-- Main Content Wrapper with 3D Perspective -->
        <div 
            class="bg-[var(--background-glass)] backdrop-filter backdrop-blur-2xl border border-[var(--border-color)] rounded-2xl p-8 h-full flex flex-col animate-fade-in-up" 
            style="perspective: 2000px;"
        >
            
            <!-- Premium Animated Header (Benchmark Standard) -->
            <div class="text-center mb-12">
                <h2 
                    class="text-4xl font-bold font-orbitron bg-clip-text text-transparent bg-[var(--gradient-primary)] mb-4" 
                    style="animation: premium-text-glow 4s ease-in-out infinite, fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1);"
                >
                    GECAN™ Intelligent Toolkits
                </h2>
                <p 
                    class="text-[var(--text-silver)] text-lg max-w-2xl mx-auto"
                    style="animation: fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) 0.2s; animation-fill-mode: backwards;"
                >
                    Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.
                </p>
            </div>
            
            <!-- Pinnacle-Grade 3D Card Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits).filter(t => t.id !== 'Dashboard').map((t, index) => {
                    const theme = colorMap[t.color.split(' ')[0]] || colorMap['from-sky-500']; // Robust fallback
                    return `
                    <!-- 
                        SEVERE UPGRADE: Pinnacle-grade card structure mirroring index.html.
                        - Uses 'offer-card' class for benchmark-aligned 3D effects & shaders.
                        - Injects asset-specific CSS variables for dynamic theming.
                        - Integrates audio-kinetic feedback with SFX.play().
                    -->
                    <div 
                        class="offer-card rounded-2xl p-8 cursor-pointer animate-fade-in-up stagger-${index + 1}"
                        onclick="Logic.setActiveToolkit('${t.id}'); SFX.play('launch');"
                        onmouseover="SFX.play('deploy')"
                        style="--asset-primary: ${theme.primary}; --asset-glow: ${theme.glow};"
                    >
                        <!-- 3D EFFECT: Inner card-content wrapper for depth, consistent with benchmark. -->
                        <div class="card-content">
                            <div class="flex items-start gap-6">
                                
                                <!-- 3D EFFECT: Icon with its own independent 3D hover transform. -->
                                <div 
                                    class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl transition-all duration-500 shadow-lg" 
                                    style="transform-style: preserve-3d;"
                                >
                                    <i 
                                        class="fas ${t.icon} transition-all duration-500" 
                                        style="transform: translateZ(20px);"
                                    ></i>
                                </div>

                                <div class="flex-1">
                                    <!-- 3D EFFECT: Header text with deep hover transform, consistent with benchmark. -->
                                    <h3 class="asset-header text-2xl font-bold text-white mb-3 -ml-1">${t.name}</h3>
                                    <p class="text-[var(--text-silver)] leading-relaxed">${t.description}</p>
                                    
                                    <!-- Interactive "Launch" prompt with kinetic arrow animation. -->
                                    <div class="mt-4 flex items-center text-[var(--asset-primary)] opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <span class="text-sm font-medium">Launch Toolkit</span>
                                        <i class="fas fa-arrow-right ml-2 transition-transform duration-300 group-hover:translate-x-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>
    `;
},
        renderWalletForensicsUI: () => {
            const { address, isLoading, report } = AppState.walletAnalysis;
            let contentHTML = '';
            if (isLoading) {
                contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-fade-in-up"><div class="relative w-24 h-24 mb-8"><div class="absolute inset-0 border-4 border-[var(--primary-azure)] rounded-full opacity-50"></div><div class="absolute inset-0 border-4 border-[var(--primary-azure)] rounded-full animate-ping"></div><i class="fas fa-shield-alt text-4xl text-[var(--primary-azure)] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" style="text-shadow: 0 0 20px var(--glow-azure);"></i></div><h3 class="text-2xl font-bold font-orbitron text-white mb-4">Analyzing Wallet Provenance</h3><p class="text-[var(--text-silver)] mb-6">Initializing GECAN Heuristic Engine...</p></div>`;
            } else if (report?.error) {
                SFX.play('error');
                contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-fade-in-up"><div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8 border-2 border-red-500/50"><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i></div><h3 class="text-2xl font-bold font-orbitron text-white mb-4">Analysis Failed</h3><p class="text-[var(--text-silver)] max-w-md">${report.error.message}</p><button onclick="Logic.runWalletForensics();" class="btn-engagement mt-8 !py-3 !px-8"><i class="fas fa-redo mr-2"></i>Retry Analysis</button></div>`;
            } else if (report) {
                contentHTML = UI.buildWalletReportHTML(report);
            } else {
                contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center bg-[var(--background-glass)] rounded-2xl border-2 border-dashed border-[var(--border-color)] animate-fade-in-up p-8" style="perspective: 1000px;"><div class="w-24 h-24 rounded-full bg-[var(--primary-azure)]/10 flex items-center justify-center mb-8 relative transition-transform duration-500 hover:scale-110" style="transform-style: preserve-3d; animation: icon-float 8s ease-in-out infinite;"><i class="fas fa-search fa-3x text-[var(--primary-azure)]" style="transform: translateZ(30px); text-shadow: 0 0 20px var(--glow-azure);"></i><div class="absolute inset-0 rounded-full border-2 border-[var(--primary-azure)]/50" style="transform: rotateX(70deg);"></div></div><h3 class="text-2xl font-bold font-orbitron text-white mb-4">Ready for Analysis</h3><p class="text-[var(--text-silver)] max-w-md">Enter a wallet address for comprehensive due diligence.</p></div>`;
            }
            return `<div class="bg-[var(--background-glass)] backdrop-filter backdrop-blur-2xl border border-[var(--border-color)] rounded-2xl p-0 h-full flex flex-col animate-fade-in-up" style="transform-style: preserve-3d;"><div class="p-8 border-b border-[var(--border-color)] transition-all duration-500 hover:border-[var(--primary-azure)] hover:shadow-2xl hover:shadow-black/50"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center text-white"><i class="fas fa-shield-alt fa-lg"></i></div><div><h2 class="text-3xl font-bold font-orbitron text-white">Wallet Due Diligence</h2><p class="text-[var(--text-silver)] font-mono">Blockchain Forensics & Risk Assessment</p></div></div><div class="flex items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" onclick="SFX.play('launch')" class="btn-engagement font-bold !py-4 !px-8 whitespace-nowrap"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto" style="transform: translateZ(10px);">${contentHTML}</div></div>`;
        },
        buildWalletReportHTML: (report) => {
            const { wallet, analysis, transactions } = report;
            const { riskLevel, integrityScore } = analysis;
            return `<div class="animate-fade-in-up"><div class="mb-8"><div class="bg-[var(--background-glass)] p-5 rounded-2xl flex justify-between items-center"><div class="flex items-center gap-3"><i class="fas fa-wallet text-2xl text-[var(--primary-azure)]"></i><span class="font-mono text-lg text-white">${wallet.address}</span></div><div class="flex gap-2"><button onclick="Logic.initiatePdfGeneration()" class="btn-engagement py-2 px-4 text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button><button onclick="Logic.openWalletSubmissionModal()" class="btn-engagement py-2 px-4 text-sm bg-gradient-to-r from-green-500 to-emerald-600"><i class="fas fa-paper-plane mr-2"></i>Submit for Review</button></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-[var(--background-glass)] p-6 rounded-2xl"><h3 class="text-xl font-bold text-white mb-4">Executive Summary</h3><p class="text-[var(--text-silver)]">${Logic.generateExecutiveSummary(report)}</p></div><div class="bg-[var(--background-glass)] p-6 rounded-2xl"><h3 class="text-xl font-bold text-white mb-4">Transaction Ledger</h3><div class="max-h-96 overflow-y-auto">${(transactions || []).map(tx => `<div class="transaction-item p-3 rounded-lg flex justify-between ${tx.type === 'Receive' ? 'transaction-inbound' : 'transaction-outbound'}"><span>${tx.hash.substring(0,12)}...</span><span class="font-mono">${tx.amount.toFixed(4)}</span></div>`).join('')}</div></div></div><div class="space-y-8"><div class="bg-[var(--background-glass)] p-6 rounded-2xl text-center"><h3 class="text-xl font-bold text-white mb-6">Integrity Score</h3><div class="relative w-40 h-40 mx-auto"><svg viewBox="0 0 36 36" class="w-full h-full score-gauge"><circle cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" class="stroke-current text-gray-700"></circle><circle cx="18" cy="18" r="15.9155" fill="none" stroke-width="3" stroke-dasharray="${integrityScore}, 100" class="score-gauge-fg stroke-current ${integrityScore > 80 ? 'gauge-low' : integrityScore > 50 ? 'gauge-medium' : 'gauge-high'}"></circle></svg><div class="absolute inset-0 flex items-center justify-center"><span class="text-5xl font-black">${Math.round(integrityScore)}</span></div></div></div><div class="bg-[var(--background-glass)] p-6 rounded-2xl"><h3 class="text-xl font-bold text-white mb-4">Risk Level: <span class="text-risk-color ${Utils.getRiskClass(riskLevel)}">${riskLevel}</span></h3></div></div></div></div>`;
        },
        renderInstitutionalModelerUI: () => `<div class="flex flex-col gap-8 animate-fade-in-up"><div id="modeler-main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-5 bg-[var(--background-glass-premium)] border border-[var(--border-premium)] rounded-2xl p-6 md:p-8 flex flex-col">${UI.renderModelerSelectionPanel()}</div><div id="modeler-preview-container" class="lg:col-span-2 bg-white rounded-2xl flex-col hidden" style="box-shadow: 0 0 80px var(--glow-diamond);"></div></div></div>`,
        renderModelerSelectionPanel: () => {
            const dealTypes = [{ id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct asset conversions.', color: 'from-blue-500 to-cyan-500' }, { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades.', color: 'from-yellow-500 to-orange-500' }, { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized loans.', color: 'from-green-500 to-emerald-500' }, { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit.', color: 'from-purple-500 to-violet-500' }];
            const colorMap = { 'from-blue-500': { primary: '#3b82f6', glow: 'rgba(59, 130, 246, 0.7)' }, 'from-yellow-500': { primary: '#f59e0b', glow: 'rgba(245, 158, 11, 0.7)' }, 'from-green-500': { primary: '#22c55e', glow: 'rgba(34, 197, 94, 0.7)' }, 'from-purple-500': { primary: '#8b5cf6', glow: 'rgba(139, 92, 246, 0.7)' } };
            return `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold font-orbitron text-white">Select Deal Type</h2><button onclick="Logic.resetModelerState()" class="nav-btn !py-2 !px-4 text-sm hover:!bg-red-500/20"><i class="fas fa-undo mr-2"></i>Reset</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8">${dealTypes.map((deal, i) => `<div class="offer-card rounded-2xl p-8 cursor-pointer stagger-${i + 1} ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')" style="--asset-primary: ${colorMap[deal.color.split(' ')[0]].primary}; --asset-glow: ${colorMap[deal.color.split(' ')[0]].glow};"><div class="card-content"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.color} flex items-center justify-center text-white text-2xl mb-4"><i class="fas ${deal.icon}"></i></div><h3 class="asset-header text-xl font-bold -ml-1">${deal.name}</h3><p class="text-sm">${deal.desc}</p></div></div>`).join('')}</div>`;
        },
        renderModelerInputPanel: () => {
            const dealPanelHTML = UI[`render${AppState.modeler.activeDealType}Panel`] ? UI[`render${AppState.modeler.activeDealType}Panel`]() : '';
            return `<div class="flex items-center mb-6"><button onclick="UI.renderActiveToolkit()" class="nav-btn !py-2 !px-4 text-sm"><i class="fas fa-chevron-left mr-2"></i>Back to Deal Selection</button></div><h2 class="text-2xl font-bold text-white mb-6"><i class="fas fa-sliders-h text-[var(--primary-azure)] mr-3"></i>Deal Parameters</h2><div class="space-y-6 flex-grow">${dealPanelHTML}</div><div class="mt-auto pt-6 border-t border-[var(--border-color)]"><button onclick="Logic.openImfpaEditor()" class="btn-engagement w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Contract Suite</button></div>`;
        },
        renderAssetSwapPanel: () => `...`, renderCommodityTradePanel: () => `...`, renderCryptoLoanPanel: () => `...`, renderSBLCMonetizationPanel: () => `...`,
        renderImfpaEditorPanel: () => {
            const { legal } = AppState.modeler;
            const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
            return `<div class="p-6 md:p-8 flex-1 flex flex-col overflow-hidden h-full"><div class="flex justify-between items-start mb-6 imfpa-header"><h2 class="text-3xl font-bold text-white">IMFPA Editor</h2><button onclick="Logic.closeImfpaEditor()" class="text-3xl text-[var(--text-muted)] hover:text-white">&times;</button></div><div class="flex-1 overflow-y-auto pr-4 -mr-4"><h3 class="imfpa-section-title">Commission Allocation</h3><div class="flex justify-between items-center mb-4"><button onclick="Logic.addImfpaGroup()" class="nav-btn !py-1 !px-3 text-sm"><i class="fas fa-plus mr-1"></i>Add Group</button><div id="imfpa-total-allocated" class="font-mono text-sm ${totalGroupPct.toFixed(2) != 100 ? 'text-error-color' : 'text-success-color'}">Total: ${totalGroupPct.toFixed(2)}%</div></div><div class="space-y-4" id="imfpa-groups-container"></div></div><div class="pt-6 border-t border-[var(--border-color)] mt-auto"><button onclick="Logic.generateContract()" class="btn-engagement w-full py-3 font-bold"><i class="fas fa-sync-alt mr-2"></i>Update Preview</button></div></div>`;
        },
    };

    // --- IV. LOGIC CONTROLLER (SEVERELY UPGRADED) ---
    const Logic = {
        createApiRequest: async (action, method = 'GET', params = {}) => {
    // Sanitize method to uppercase to prevent case-sensitivity issues.
    const httpMethod = method.toUpperCase();
    let url = `${API_URL}?action=${action}`;
    
    const options = {
        method: httpMethod,
        redirect: 'follow',
        muteHttpExceptions: true // Required for Google Apps Script error handling
    };

    // --- CRITICAL FIX: GET/POST ROUTING LOGIC ---
    // This block correctly formats the request based on the specified HTTP method.
    if (httpMethod === 'GET') {
        // For GET requests, parameters are appended to the URL as a query string.
        Object.keys(params).forEach(key => {
            url += `&${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`;
        });
    } else if (httpMethod === 'POST') {
        // For POST requests, parameters are sent in the request body.
        // Google Apps Script requires a specific format for the payload.
        options.body = JSON.stringify({
            action: action,
            data: params
        });
        options.headers = {
            'Content-Type': 'text/plain;charset=utf-8'
        };
    }

    try {
        const response = await fetch(url, options);

        if (!response.ok) {
            // Handles network-level errors (e.g., 404, 500).
            throw new Error(`API Network Error: Status ${response.status}`);
        }

        const result = await response.json();

        // Handles application-level errors returned by the backend script.
        if (result.success === false) {
            // Prioritizes a specific error message from the server, otherwise provides a default.
            throw new Error(result.error || `Server reported an unspecified error for action: ${action}`);
        }
        
        // On success, returns the 'data' property or the entire result as a fallback.
        return result.data || result;

    } catch (error) {
        // Centralized error logging for easier debugging.
        console.error(`API Request Failed for action '${action}' with method '${httpMethod}'. Error:`, error);
        // Re-throw the error to be caught by the calling function's .catch() block.
        // This allows for specific UI updates (e.g., showing an error message).
        throw new Error(`API Error: ${error.message}`);
    }
},
        init: async () => {
            UI.init(); SFX.initialize(); Logic.setupEventListeners(); UI.renderToolkitMenu();
            try {
                const marketData = await Logic.createApiRequest('getMarketMatrixData', 'GET');
                AppState.marketData = marketData.map(asset => ({ ...asset, price: parseFloat(asset.price) || 0 }));
                Logic.populateNavLinks();
                AppState.isInitialized = true;
                document.getElementById('initial-loader').style.display = 'none';
                UI.renderActiveToolkit();
            } catch (err) { console.error('INIT FAILED:', err); }
        },
        populateNavLinks: () => {
            const nav = document.getElementById('desktop-nav-placeholder');
            const links = [{ p: 'index', i: 'tachometer-alt', t: 'XDealFlow Home' }, { p: 'toolkits', i: 'tools', t: 'Intelligent Toolkits' }, { p: 'architect', i: 'drafting-compass', t: 'Architect Wizard' }, { p: 'intelligence', i: 'sitemap', t: 'Network Intelligence' }];
            nav.innerHTML = `<div class="flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">${links.map(l => `<a href="./${l.p}.html" class="nav-btn ${l.p === 'toolkits' ? 'active' : ''}"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="fas fa-${l.i}"></i></div><div class="nav-icon-face nav-icon-back"><i class="fas fa-${l.i}"></i></div></div></div><span>${l.t}</span></a>`).join('')}</div>`;
            document.getElementById('logo-link').href = './index.html';
        },
        setupEventListeners: () => { /* Global listeners */ },
        setActiveToolkit: (id) => { AppState.activeToolkit = id; UI.renderActiveToolkit(); },
        bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
        
        // Wallet Forensics Logic
        bindWalletForensicsEvents: () => document.getElementById('check-wallet-btn')?.addEventListener('click', Logic.runWalletForensics),
        runWalletForensics: async () => {
            const address = document.getElementById('wallet-address-input').value.trim();
            if (!address) return;
            AppState.walletAnalysis = { address, report: null, isLoading: true };
            UI.renderActiveToolkit();
            try {
                const report = await Logic.createApiRequest('getWalletForensicsReport', 'POST', { address });
                AppState.walletAnalysis.report = report;
                SFX.play('success');
            } catch (err) { AppState.walletAnalysis.report = { error: { message: err.message } }; }
            finally { AppState.walletAnalysis.isLoading = false; UI.renderActiveToolkit(); }
        },
        initiatePdfGeneration: async () => {
            const report = AppState.walletAnalysis.report;
            if (!report) return Logic.showNotification('No report data.', 'error');
            report.analysis.executiveSummary = Logic.generateExecutiveSummary(report);
            const btn = document.getElementById('pdf-print-btn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            try {
                const res = await Logic.createApiRequest('generateWalletForensicsPdf', 'POST', { report });
                const link = document.createElement('a');
                link.href = `data:application/pdf;base64,${res.pdfData}`;
                link.download = res.fileName;
                link.click();
            } catch (err) { Logic.showNotification(err.message, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Export PDF'; }
        },
        openWalletSubmissionModal: () => {
            const address = AppState.walletAnalysis.address;
            if (!address) return;
            const modal = document.getElementById('engagement-modal');
            modal.querySelector('#engagement-modal-content').innerHTML = `...`; // Full modal form as before
            modal.showModal();
            document.getElementById('wallet-submission-form').addEventListener('submit', Logic.submitWalletForReview);
        },
        submitWalletForReview: async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            try {
                const payload = {
                    walletAddress: AppState.walletAnalysis.address,
                    submitterName: document.getElementById('sub-name').value, submitterEmail: document.getElementById('sub-email').value,
                    controllerName: document.getElementById('con-name').value, controllerEmail: document.getElementById('con-email').value,
                    controllerPhone: document.getElementById('con-phone').value,
                };
                const res = await Logic.createApiRequest('submitWalletForReview', 'POST', payload);
                document.getElementById('engagement-modal').close();
                Logic.showNotification(res.message, 'success');
            } catch(err) { Logic.showNotification(err.message, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = 'Submit for Review'; }
        },
        generateExecutiveSummary: (report) => { return `This wallet presents a ${report.analysis.riskLevel} risk profile with an integrity score of ${report.analysis.integrityScore}/100.`; },
        
        // Institutional Modeler & IMFPA Logic
        bindInstitutionalModelerEvents: () => {
            const container = document.getElementById('modeler-input-container');
            if(container) container.addEventListener('input', Utils.debounce(Logic.handleModelerInputChange, 250));
        },
        handleDealTypeChange: (newType) => {
            AppState.modeler.activeDealType = newType;
            const container = document.getElementById('modeler-input-container');
            if (container) container.innerHTML = UI.renderModelerInputPanel();
            Logic.bindInstitutionalModelerEvents();
        },
        handleModelerInputChange: (e) => {
            const { dataset, value } = e.target;
            let current = AppState.modeler;
            const keys = dataset.path.split(/[\.\[\]]+/).filter(Boolean);
            keys.slice(0, -1).forEach(key => current = current[key]);
            current[keys.pop()] = value;
            Logic.liveUpdateContractPreview(); // Always update preview on any input change
        },
        calculateModel: () => ({ baseValueUSD: 1000000, totalCommissionPool: 50000 }),
        openImfpaEditor: () => {
            const inputContainer = document.getElementById('modeler-input-container');
            const previewContainer = document.getElementById('modeler-preview-container');
            const mainContent = document.getElementById('modeler-main-content');
            
            inputContainer.classList.remove('lg:col-span-5');
            inputContainer.classList.add('lg:col-span-3');
            inputContainer.innerHTML = UI.renderImfpaEditorPanel();
            
            previewContainer.classList.remove('hidden');
            setTimeout(() => {
                previewContainer.style.opacity = '1';
                previewContainer.style.transform = 'translateX(0px)';
            }, 50);
            
            Logic.liveUpdateContractPreview();
            Logic.bindImfpaEditorEvents();
        },
        closeImfpaEditor: () => {
            const inputContainer = document.getElementById('modeler-input-container');
            const previewContainer = document.getElementById('modeler-preview-container');
            
            previewContainer.style.opacity = '0';
            previewContainer.style.transform = 'translateX(50px)';
            setTimeout(() => previewContainer.classList.add('hidden'), 500);

            inputContainer.classList.remove('lg:col-span-3');
            inputContainer.classList.add('lg:col-span-5');
            inputContainer.innerHTML = UI.renderModelerSelectionPanel();
        },
        liveUpdateContractPreview: () => {
            const previewContainer = document.getElementById('modeler-preview-container');
            if (!previewContainer.classList.contains('hidden')) {
                Logic.generateContract(true);
            }
        },
        generateContract: (isLiveUpdate = false) => {
            const calc = Logic.calculateModel();
            const agreementReference = `GECAN-IMFPA-${Date.now()}`;
            document.documentElement.style.setProperty('--agreement-reference', `"${agreementReference}"`);
            
            const contractHTML = `...`; // Full, dynamic contract HTML here
            const previewContainer = document.getElementById('modeler-preview-container');
            const printContainer = document.getElementById('print-content');

            if (!isLiveUpdate) {
                previewContainer.innerHTML = `<div class="flex flex-col h-full w-full"><div class="p-4 border-b"><h3 class="font-bold">Live Preview</h3></div><div class="flex-grow overflow-y-auto bg-gray-200 p-4"><div class="bg-white shadow-lg mx-auto" style="width: 210mm; min-height: 297mm;" id="live-contract-body"></div></div><div class="p-4 border-t"><button onclick="window.print()" class="w-full btn-engagement py-2">Print/Save</button></div></div>`;
            }
            
            const liveBody = document.getElementById('live-contract-body');
            if (liveBody) liveBody.innerHTML = contractHTML;
            printContainer.innerHTML = contractHTML;
        },
        bindImfpaEditorEvents: () => {
            const container = document.getElementById('imfpa-groups-container');
            if(container) container.addEventListener('input', Utils.debounce(Logic.handleModelerInputChange, 250));
        },
    };

    // --- V. APPLICATION BOOTSTRAP ---
    document.addEventListener('DOMContentLoaded', Logic.init);
</script>
</body>
</html>
