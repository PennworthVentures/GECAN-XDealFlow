<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
/* ========================================================================= */
/* === PINNACLE CSS ENGINE v5.0 (SEVERELY UPGRADED & SYNTHESIZED) === */
/* This stylesheet is the definitive standard for the Toolkits page, */
/* ensuring visual consistency with the entire GECAN platform. */
/* ========================================================================= */

/* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
:root {
    --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
    --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
    --primary-diamond: #f8fafc; --primary-dark: #0369a1;
    --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
    --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
    --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
    --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
    --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
    --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
    --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
    --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
    --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
    --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
    --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
    --shadow-quantum: 0 50px 100px -20px rgba(0,0,0,0.5), 0 30px 60px -30px rgba(0,0,0,0.6);
    --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
}

/* --- B. BASE STYLES & RESETS --- */
* { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
body.mobile-sidebar-open { overflow: hidden; }
.font-mono { font-family: 'JetBrains Mono', monospace; }
::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
::selection { background: var(--gradient-primary); color: var(--text-diamond); }

/* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
#particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
#interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
#background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
#background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
@keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
@keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

.premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
.gecan-logo-container { perspective: 800px; }
.gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
.gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
.logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
.logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
.logo-back { transform: rotateY(180deg); }
.logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
.logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
@keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
@keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }

/* BENCHMARKED NAVIGATION & MOBILE MENU */
.nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
.nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
.nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
.nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
.nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
.nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
.nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
.nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }
@keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }

#mobile-sidebar.left-0 { transform: translateX(0); }
.mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
.mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
@media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }

/* --- D. TOOLKIT-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
.glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
.btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
.btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
.btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
.btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
.report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
.report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(-2px); }
.gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

/* Animations */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes float { 50% { transform: translateY(-8px); } }
.animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
.stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

/* Institutional Modeler Specific Styles */
.deal-type-card { background: var(--background-glass); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s ease; text-align: left; }
.deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-azure); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
.deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.05); }
.deal-type-icon { transition: all 0.3s ease; } .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
@keyframes icon-glow-rotate { 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }

.output-metric-card { background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
.output-metric-card .label { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.output-metric-card .value { font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
.output-metric-card .sub-value { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
.output-metric-card.base-value .value { color: var(--primary-azure); } .output-metric-card.net .value { color: var(--success-color); } .output-metric-card.commission .value { color: var(--warning-color); }

/* ========================================================================= */
/* === DEFINITIVE MODAL & CENTERING ENGINE (MILITARY-GRADE v7.0) === */
/* ========================================================================= */
dialog { padding: 0 !important; border: none !important; background: transparent !important; max-width: 100%; width: 100%; overflow: hidden; }
dialog[open] { display: grid !important; place-items: center !important; position: fixed !important; inset: 0 !important; z-index: 200 !important; padding: 2rem; animation: modal-backdrop-fade-in 0.5s ease forwards; }
@media (max-width: 768px) { dialog[open] { padding: 0; } }
dialog::backdrop { background: rgba(5, 5, 9, 0.85) !important; backdrop-filter: blur(16px) saturate(180%) !important; -webkit-backdrop-filter: blur(16px) saturate(180%) !important; animation: modal-backdrop-fade-in 0.5s ease forwards; }
.dialog-content-wrapper { background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important; border: 1px solid var(--border-premium) !important; box-shadow: var(--shadow-quantum) !important; border-radius: 1.5rem !important; width: 100%; max-height: calc(100vh - 4rem); display: flex; flex-direction: column; overflow: hidden; animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@media (max-width: 768px) { .dialog-content-wrapper { max-height: 100vh; border-radius: 0 !important; } }

#imfpa-modal .dialog-content-wrapper { max-width: 90rem; }
#signature-modal .dialog-content-wrapper { max-width: 35rem; }
#finalization-modal .dialog-content-wrapper { max-width: 35rem; }
#notification-modal .dialog-content-wrapper { max-width: 32rem; }

@keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.form-input, .form-select { background-color: var(--background-dark) !important; border: 1px solid var(--border-secondary) !important; color: var(--text-primary) !important; border-radius: 0.75rem !important; padding: 0.75rem 1rem !important; width: 100% !important; font-size: 1rem !important; transition: all 0.3s ease !important; appearance: none !important; -webkit-text-fill-color: var(--text-primary) !important; box-shadow: inset 0 0 0 50px var(--background-dark) !important; }
input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active { -webkit-text-fill-color: var(--text-primary) !important; box-shadow: inset 0 0 0 50px var(--background-dark) !important; caret-color: var(--text-primary) !important; }
.form-input::placeholder { color: var(--text-muted) !important; opacity: 1 !important; }
.form-input:focus, .form-select:focus { outline: none !important; border-color: var(--primary-azure) !important; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary) !important; background-color: var(--background-secondary) !important; }
.form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; background-position: right 0.75rem center !important; background-repeat: no-repeat !important; background-size: 1.5em 1.5em !important; padding-right: 2.5rem !important; }
.collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s ease; }
.collapsible-content.expanded { grid-template-rows: 1fr; }
.collapsible-content > div { overflow: hidden; }

/* =================================================================================== */
/* === PINNACLE NCNDA/IMFPA WORKSPACE ENGINE v10.0 (SEVERELY UPGRADED) === */
/* This engine GUARANTEES a maximized, dual-column interactive contract suite */
/* with a fully responsive, premium mobile-first architecture. */
/* =================================================================================== */
#imfpa-modal .dialog-content-wrapper {
    --premium-gold: #D4AF37; --premium-gold-glow: rgba(212, 175, 55, 0.4);
    --premium-bg-dark: #0a0f1c; --premium-bg-light: #161d31; --premium-border: #2a3552;
    --premium-text-primary: #f0f4ff; --premium-text-secondary: #a0aec0;
    background: radial-gradient(circle at top left, var(--premium-bg-light), var(--premium-bg-dark) 70%);
    border: 1px solid var(--premium-border); color: var(--premium-text-primary);
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.75), 0 0 0 1px var(--premium-gold-glow);
    /* NEW: Full screen height for responsive layout */
    min-height: 100vh;
    border-radius: 0 !important; /* Full screen on mobile */
}
@media (min-width: 1024px) {
    #imfpa-modal .dialog-content-wrapper {
        min-height: auto;
        border-radius: 1.5rem !important;
    }
}
.imfpa-header h2 { font-family: 'Orbitron', monospace; background: linear-gradient(90deg, var(--premium-text-primary), var(--premium-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.imfpa-section-title { font-size: 1.25rem; font-weight: 700; color: var(--premium-text-primary); border-left: 3px solid var(--premium-gold); padding-left: 1rem; margin-bottom: 1.5rem; }
.imfpa-section-title i { animation: icon-pulse 3s infinite ease-in-out; }
@keyframes icon-pulse { 50% { transform: scale(1.1); color: var(--premium-gold); } }

/* Workspace Grid & Columns (New Responsive Logic) */
.workspace-grid { display: grid; grid-template-columns: 1fr; }
@media (min-width: 1024px) { .workspace-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
.editor-panel, .preview-panel { height: 100%; display: flex; flex-direction: column; }
.editor-content, .preview-content { flex-grow: 1; overflow-y: auto; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: var(--premium-border); border-radius: 3px; }
.custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--premium-border) transparent; }

/* Mobile Preview Toggling */
@media (max-width: 1023px) {
    .preview-panel {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 60;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }
    body[data-mobile-preview="visible"] .preview-panel {
        transform: translateX(0);
    }
}

/* Agreement Toggle Switch (New Premium Version) */
.agreement-toggle-switch .toggle-track { position: relative; }
.agreement-toggle-switch .toggle-thumb { box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

/* Party & Group Cards (New Premium Styles) */
.allocation-group-card, .party-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
.allocation-group-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 0 15px var(--premium-gold-glow); border-color: var(--premium-gold); }
.party-card:hover { background-color: rgba(255,255,255,0.05); }

/* Execution Suite & Buttons (New Premium Styles) */
#execution-suite-footer .execution-btn {
    font-weight: 700;
    padding: 0.8rem 1.5rem;
    border-radius: 0.75rem;
    border-width: 2px;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#execution-suite-footer .execution-btn:hover:not(:disabled) {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* Synthesize & Finalization Buttons (New Premium Styles) */
.synthesis-button-container, .execution-suite-container.hidden { display: none; }
#imfpa-modal.synthesis-complete .synthesis-button-container { display: none; }
#imfpa-modal.synthesis-complete .execution-suite-container { display: block; }

/* Signature & Finalization Modals */
#signature-modal .signature-tab.active { border-color: var(--success-color); color: var(--text-diamond); }
#signature-canvas { border: 1px solid var(--border-premium); border-radius: 0.5rem; background-color: var(--background-dark); cursor: crosshair; }
#finalization-icon-container { background: linear-gradient(135deg, var(--primary-amethyst), var(--primary-royal)); animation: pulse-glow 3s ease-in-out infinite; }
@keyframes pulse-glow { 50% { transform: scale(1.05); box-shadow: 0 0 35px var(--glow-amethyst); } }

/* =================================================================================== */
/* === PINNACLE PRINTING STYLES v2.0 (SEVERELY UPGRADED) === */
/* =================================================================================== */
#print-area { display: none; }
@media print {
    .print-hide { display: none !important; }
    #print-area { display: block !important; }
    body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0 !important; padding: 0 !important; }
    @page {
        size: A4; margin: 2cm;
        @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @top-right { content: "GECAN™ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
    }
    .contract-document { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; background: #fff !important; }
    .document-title { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .section-title { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
    .text-gray-700 { color: #000 !important; }
    .p-text, .text-gray-700, .text-gray-600 { text-align: justify; margin-bottom: 11pt; }
    .members-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
    .members-table th, .members-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
    .members-table th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
    .members-table tr:nth-child(even) td { background-color: #f9f9f9; }
    .signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; border: 1px solid #ccc; padding: 1cm; background: #f9f9f9; }
    .signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
    .signature-label { font-size: 9pt; color: #555; }
    .signature-fields img.p-signature-img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
    .seal-area img.p-seal-img { max-height: 80px; max-width: 80px; object-fit: contain; mix-blend-mode: darken; }
    .commission-section, .signature-section { page-break-before: always; }
    .watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
}
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECAN™ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & MAINTAINED) -->
<header class="premium-header p-4 lg:px-6 print-hide">
    <div class="container mx-auto flex items-center justify-between gap-6">
        <div class="flex items-center gap-6 flex-shrink-0">
            <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                <div class="gecan-logo-flipper">
                    <div class="logo-face logo-front">GECAN™</div>
                    <div class="logo-face logo-back">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImdROCIgeDE9IjAuNSIgeDI9IjAuNSIgeTE9IjAiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2Q0YWYzNyIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNiNDk3NWEiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxwYXRoIGQ9Ik0xMDAgMTBDNTAuMyAxMCAxMCA1MC4zIDEwIDEwMHM0MC4zIDkwIDkwIDkwIDkwLTQwLjMgOTAtOTBTMTQ5LjcgMTAgMTAwIDEweiIgZmlsbD0iIzFjMmU0YSIvPgogIDxwYXRoIGQ9Ik0xMDAgMjVDNTguNiAyNSAyNSA1OC42IDI1IDEwMHMzMy42IDc1IDc1IDc1IDc1LTMzLjYgNzUtNzVTMTE0MS40IDI1IDEwMCAyNXoiIGZpbGw9IiMwYzA5MWUiLz4KICA8cGF0aCBkPSJNNzUgNTBMMTAwIDc1IDc1IDEwMFoiIGZpbGw9InVybCgjZ1E4KSIvPgogIDxwYXRoIGQ9Ik0xMjUgNTBMMTAwIDc1IDEyNSAxMDBaIiBmaWxsPSJ1cmwoI2dROCkiLz4KICA8cGF0aCBkPSJNNzUgMTUwTDEwMCAxMjUgNzUgMTAwWiIgZmlsbD0idXJsKCNnUTgpIi8+CiAgPHBhdGggZD0iTTEyNSAxNTBMMTAwIDEyNSAxMjUgMTAwWiIgZmlsbD0idXJsKCNnUTgpIi8+Cjwvc3ZnPg==" alt="GECAN Logo">
                    </div>
                </div>
                <div class="logo-separator"></div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                    <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                </div>
            </a>
        </div>
        <div id="desktop-nav-placeholder" class="flex-grow">
            <!-- Navigation will be dynamically injected by JavaScript -->
        </div>
    </div>
</header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- MODAL & DIALOG CONTAINERS -->
    <dialog id="imfpa-modal" class="p-0 bg-transparent w-full print-hide"></dialog>

    <dialog id="signature-modal"></dialog>
    
    <dialog id="notification-modal"></dialog>
    
    <dialog id="finalization-modal"></dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
    <div id="print-area"></div>
    
    <!-- PREMIUM FOOTER (BENCHMARKED & MAINTAINED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECAN™ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECAN™ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
// ====================================================================================
// === PINNACLE SCRIPT ENGINE v5.0 (SEVERELY UPGRADED & SYNTHESIZED) ===
// This engine is the definitive, production-grade standard for the Toolkits page,
// with the Institutional Modeler as the primary focus.
// ====================================================================================
const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";

// ====================================================================================
// === SECTION 1: STATE & MODELS (v5.0 - DEFINITIVE & REFINED) ===
// ====================================================================================
const AppState = {
    isInitialized: false, 
    activeToolkit: 'Dashboard', 
    marketData: [],

    toolkits: {
        Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECAN™ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
        InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
    },
    modeler: {
        activeDealType: 'AssetSwap', 
        assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
        commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: '• Standard TTV Procedures\n• SGS/Intertek Inspection\n• Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' },
        cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
        sblcMonetization: { faceValue: 100000000, ltv: 80 },
        pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
        legal: { agreementType: 'NCNDA', autoBalance: false, totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }
    }
};

const commodityData = {
    unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
    incoterms: [
        { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' }, { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
        { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' }, { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
        { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
        { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
    ],
    countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
    ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
};

// ====================================================================================
// === SECTION 2: UTILITIES (v5.0 - DEFINITIVE & BENCHMARKED) ===
// ====================================================================================
const Utils = {
    showNotification: (message, type = 'info', title = null) => {
        const modal = document.getElementById('notification-modal');
        if (!modal) return alert(`[${type.toUpperCase()}] ${title || ''}: ${message}`);
        modal.innerHTML = UI.renderNotificationModal(message, type, title);
        modal.showModal();
        document.getElementById('notification-ok-btn').onclick = () => modal.close();
    },
    formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
    formatNumber: (num, decimals = 2) => {
        if (typeof num !== 'number' || isNaN(num)) return 'N/A';
        if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
        if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
        return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    },
    debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
    getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
};

// ====================================================================================
// === SECTION 3: CORE LOGIC CONTROLLER (v5.0 - DEFINITIVE & UPGRADED) ===
// ====================================================================================
const Logic = {
    init: async () => {
        UI.init();
        UI.populateNavLinks(); 
        Logic.initMobileUI();
        Logic.setupEventListeners();
        try {
            const [marketData, themeJson] = await Promise.all([
                Logic.createApiRequest('getMarketMatrixData'),
                Logic.createApiRequest('getActiveThemeConfig').catch(() => null)
            ]);
            if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) {} }
            if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
            AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
            const swappable = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
            if (swappable.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = swappable[0].key; AppState.modeler.assetSwap.toAssetKey = swappable[1].key; }
            
            AppState.isInitialized = true;
            document.getElementById('initial-loader').style.display = 'none';
            UI.renderActiveToolkit();
        } catch (err) { Logic.onDataError(err); }
    },
    onDataError: (error) => {
        console.error("CRITICAL FAILURE:", error);
        Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
        document.getElementById('initial-loader').innerHTML = `<div class="text-center text-red-400">Platform Initialization Failed.</div>`;
    },
    initMobileUI: () => {
        const fab = document.getElementById('mobile-fab'), 
              sidebar = document.getElementById('mobile-sidebar'), 
              overlay = document.getElementById('mobile-sidebar-overlay'), 
              closeBtn = document.getElementById('mobile-sidebar-close-btn');
        const openSidebar = () => { UI.populateNavLinks(); sidebar.classList.remove('-left-full'); sidebar.classList.add('left-0'); overlay.classList.remove('hidden'); document.body.classList.add('mobile-sidebar-open'); };
        const closeSidebar = () => { sidebar.classList.add('-left-full'); sidebar.classList.remove('left-0'); overlay.classList.add('hidden'); document.body.classList.remove('mobile-sidebar-open'); };
        fab.addEventListener('click', openSidebar); overlay.addEventListener('click', closeSidebar); closeBtn.addEventListener('click', closeSidebar);
    },
    setupEventListeners: () => {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } }
        });
    },
    setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
    bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
    
    // --- Institutional Modeler Logic (v5.0 - Definitive & Unabridged) ---
    bindInstitutionalModelerEvents: () => {
        Logic.updateModelerUI(true);
        const inputContainer = document.getElementById('modeler-input-container');
        if (inputContainer) {
            inputContainer.addEventListener('input', Utils.debounce((e) => {
                if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
            }, 250));
            inputContainer.addEventListener('change', (e) => {
                if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
            });
        }
    },
    handleDealTypeChange: (newDealType) => {
        if (AppState.modeler.activeDealType === newDealType) return;
        AppState.modeler.activeDealType = newDealType;
        UI.renderActiveToolkit();
    },
    handleModelerInputChange: (e) => {
        const { dataset, value, type, checked } = e.target;
        const path = dataset.path;
        if (!path) return;
        try {
            const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean);
            let targetObject = AppState.modeler;
            for (let i = 0; i < pathKeys.length - 1; i++) { targetObject = targetObject[pathKeys[i]]; }
            const finalKey = pathKeys[pathKeys.length - 1];
            let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
            targetObject[finalKey] = processedValue;
            Logic.updateModelerUI(false);
        } catch (error) { console.error(`Failed to update modeler state for path: ${path}`, error); Utils.showNotification("An internal error occurred while updating the model.", 'error'); }
    },
    updateModelerUI: (isFullRefresh = false) => {
        if (isFullRefresh) {
            const inputContainer = document.getElementById('modeler-input-container');
            if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
        }
        const calculation = Logic.calculateModel();
        const outputContainer = document.getElementById('modeler-output-container');
        if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
    },
    calculateModel: () => {
        const { activeDealType, pricingConfig } = AppState.modeler;
        const calculationFunc = Logic[`calculate${activeDealType}`];
        if (!calculationFunc) return null;
        const dealCalc = calculationFunc();
        if (!dealCalc) return null;
        const { baseValueUSD } = dealCalc;
        const grossValue = parseFloat(pricingConfig.grossValue) || 0;
        const netValue = parseFloat(pricingConfig.netValue) || 0;
        const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (grossValue / 100) : grossValue;
        const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (netValue / 100) : netValue;
        let finalValueToBuyerUSD, totalCommissionPool;
        if(pricingConfig.offerType === 'discount') { finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; } 
        else { finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; }
        totalCommissionPool = Math.max(0, totalCommissionPool);
        AppState.modeler.legal.totalCommission = totalCommissionPool;
        return { ...dealCalc, baseValueUSD, finalValueToBuyerUSD, totalCommissionPool, netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`, grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}` };
    },
    calculateAssetSwap: () => {
        const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
        const fromAsset = Utils.getAssetByKey(fromAssetKey);
        const toAsset = Utils.getAssetByKey(toAssetKey);
        const baseValueUSD = (parseFloat(amount) || 0) * (fromAsset.price || 0);
        const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0;
        const dealTitle = `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset} for ${toAsset.baseAsset}`;
        return { baseValueUSD, fromAsset, toAsset, rate, dealTitle };
    },
    calculateCommodityTrade: () => {
        const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey, discountPremiumIsInPercent } = AppState.modeler.commodityTrade;
        const asset = Utils.getAssetByKey(assetKey);
        const settlementAsset = Utils.getAssetByKey(settlementAssetKey);
        let effectivePricePerUnit = asset.price || 0, priceDerivation = 'Market Price';
        const discPremVal = parseFloat(discountPremiumValue) || 0;
        if (pricingModel === 'Fixed') { effectivePricePerUnit = parseFloat(fixedPrice) || 0; priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`; }
        else if (pricingModel === 'Premium') { const premiumAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit += premiumAmount; priceDerivation = `Market + ${Utils.formatPrice(premiumAmount)}`; }
        else if (pricingModel === 'Discount') { const discountAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit -= discountAmount; priceDerivation = `Market - ${Utils.formatPrice(discountAmount)}`; }
        const baseValueUSD = (parseFloat(quantity) || 0) * effectivePricePerUnit;
        const dealTitle = `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`;
        let settlementAmount = baseValueUSD / (settlementAsset.price || 1);
        return { baseValueUSD, dealTitle, priceDerivation, effectivePricePerUnit, settlementAmount, settlementAsset };
    },
    calculateCryptoLoan: () => {
        const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
        const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
        const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0);
        const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100);
        const totalInterest = loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12);
        const totalRepayment = loanPrincipal + totalInterest;
        return { baseValueUSD: loanPrincipal, loanPrincipal, totalRepayment, loanCurrency, tenureMonths, interestRateValue, dealTitle: `Loan against ${collateralAsset.baseAsset}` };
    },
    calculateSBLCMonetization: () => {
        const { faceValue, ltv } = AppState.modeler.sblcMonetization;
        const baseValueUSD = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
        return { baseValueUSD, dealTitle: `LTV on ${Utils.formatPrice(faceValue)} SBLC` };
    },
    resetModelerState: () => {
        const defaultState = { activeDealType: 'AssetSwap', assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' }, commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'United States', port: 'Houston', incoterms: 'FOB', procedures: '• Standard TTV Procedures\n• SGS/Intertek Inspection\n• Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' }, cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 }, sblcMonetization: { faceValue: 100000000, ltv: 80 }, pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true }, legal: { agreementType: 'NCNDA', autoBalance: false, totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] } };
        AppState.modeler = JSON.parse(JSON.stringify(defaultState));
        const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
        if (allSwappableAssets.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key; AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key; }
        Logic.updateModelerUI(true);
        Utils.showNotification('Institutional Modeler has been reset to its default state.', 'info', 'Modeler Reset');
    },
    swapAssets: () => {
        const swapState = AppState.modeler.assetSwap;
        const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey); const toAsset = Utils.getAssetByKey(swapState.toAssetKey);
        if (fromAsset.price > 0 && toAsset.price > 0) { const totalUsdValue = (parseFloat(swapState.amount) || 0) * fromAsset.price; swapState.amount = totalUsdValue / toAsset.price; }
        [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
        const icon = document.getElementById('swap-icon'); if (icon) { icon.style.animation = 'none'; void icon.offsetWidth; icon.style.animation = 'swap-icon-spin 0.5s ease-in-out'; }
        Logic.updateModelerUI(true);
    },
    togglePricingConfig: () => { AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible; Logic.updateModelerUI(true); },

    // ========================================================================================
    // === PINNACLE NCNDA/IMFPA & DOCUMENT EXECUTION SUITE ENGINE (v11.0 - UPGRADED) ===
    // ========================================================================================
    openImfpaModal: () => {
        const modal = document.getElementById('imfpa-modal'); if (!modal) return;
        modal.innerHTML = UI.renderImfpaModal();
        modal.showModal();
        UI.refreshImfpaModalUI();
    },
    refreshImfpaModalUI: () => {
        UI.renderImfpaGroups();
        Logic.updateImfpaCalculations();
        Logic.updateContractPreview();
    },
    toggleAgreementType: (isImfpa) => {
        const { legal } = AppState.modeler;
        legal.agreementType = isImfpa ? 'IMFPA' : 'NCNDA';
        if (!isImfpa && legal.groups.length > 1) {
            const allParties = legal.groups.flatMap(g => g.parties);
            legal.groups = [{ name: 'NCNDA Signatories', percentage: 100, parties: allParties }];
        } else if (isImfpa && legal.groups.length === 0) {
            legal.groups.push({ name: 'Group 1', percentage: 100, parties: [] });
        }
        UI.openImfpaModal();
    },
    updateImfpaCalculations: () => {
        const { legal } = AppState.modeler;
        const { groups, totalCommission, autoBalance } = legal;
        const totalPoolEl = document.getElementById('imfpa-total-commission-pool'); if (totalPoolEl) totalPoolEl.textContent = Utils.formatPrice(totalCommission);
        if (autoBalance && legal.agreementType === 'IMFPA') {
            let totalSetGroupPct = 0; const zeroGroups = [];
            groups.forEach(g => { const pct = parseFloat(g.percentage) || 0; if (pct > 0) totalSetGroupPct += pct; else zeroGroups.push(g); });
            if (zeroGroups.length > 0 && totalSetGroupPct < 100) {
                const share = (100 - totalSetGroupPct) / zeroGroups.length; zeroGroups.forEach(g => g.percentage = share);
            }
        }
        const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
        const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
        if (totalAllocatedEl) {
            const isBalanced = Math.abs(totalGroupPct - 100) < 0.01;
            totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
            totalAllocatedEl.className = `allocation-status text-sm font-mono px-3 py-1 rounded-lg ${isBalanced ? 'bg-green-500/10 text-green-400 border border-green-500/30' : 'bg-red-500/10 text-red-400 border border-red-500/30 animate-pulse'}`;
        }
        groups.forEach((group, groupIndex) => {
            const groupValueEl = document.getElementById(`imfpa-group-value-${groupIndex}`);
            if (groupValueEl) groupValueEl.textContent = Utils.formatPrice(totalCommission * ((parseFloat(group.percentage) || 0) / 100));
            if (autoBalance && legal.agreementType === 'IMFPA') {
                let totalSetPartyPct = 0; const zeroParties = [];
                group.parties.forEach(p => { const pct = parseFloat(p.percentage) || 0; if (pct > 0) totalSetPartyPct += pct; else zeroParties.push(p); });
                if (zeroParties.length > 0 && totalSetPartyPct < 100) { const share = (100 - totalSetPartyPct) / zeroParties.length; zeroParties.forEach(p => p.percentage = share); }
            }
            const totalPartyPct = group.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
            const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
            if (groupTotalEl) {
                const isBalanced = Math.abs(totalPartyPct - 100) < 0.01;
                groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
                groupTotalEl.className = `group-total mt-4 p-3 rounded-lg text-right font-mono text-sm ${isBalanced ? 'bg-green-500/10 text-green-400 border border-green-500/30' : 'bg-red-500/10 text-red-400 border border-red-500/30'}`;
            }
        });
        if(document.getElementById('editor-content-dynamic')) UI.refreshImfpaModalUI();
    },
    updateContractPreview: () => {
        const isReady = Logic.validateImfpaData();
        const wrapper = document.getElementById('contract-document-wrapper'); if(!wrapper) return;
        if(isReady) {
            const { legal } = AppState.modeler;
            const ref = `GECAN-${legal.agreementType}-${Date.now().toString().slice(-6)}`;
            document.documentElement.style.setProperty('--agreement-reference', `"${ref}"`);
            wrapper.innerHTML = UI.renderContractDocument(ref);
        } else {
            wrapper.innerHTML = UI.renderContractPreviewPlaceholder();
        }
    },
    validateImfpaData: () => {
        const { legal } = AppState.modeler;
        const allParties = legal.groups.flatMap(g => g.parties);
        if (!legal.jurisdiction || allParties.length < 1 || !allParties.every(p => p.legalName && p.email && p.contactNumber)) return false;
        if (legal.agreementType === 'IMFPA') {
            if (legal.groups.length === 0) return false;
            const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
            if (Math.abs(totalGroupPct - 100) > 0.01) return false;
            for (const group of legal.groups) {
                if (group.parties.length === 0) return false;
                const totalPartyPct = group.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                if (Math.abs(totalPartyPct - 100) > 0.01) return false;
            }
        }
        return true;
    },
    addImfpaGroup: () => {
        AppState.modeler.legal.groups.push({ name: `Group ${AppState.modeler.legal.groups.length + 1}`, percentage: 0, parties: [] });
        UI.refreshImfpaModalUI();
    },
    removeImfpaGroup: (groupIndex) => { AppState.modeler.legal.groups.splice(groupIndex, 1); UI.refreshImfpaModalUI(); },
    addImfpaParty: (groupIndex) => {
        if (!AppState.modeler.legal.groups[groupIndex]) AppState.modeler.legal.groups[groupIndex] = { name: 'NCNDA Signatories', percentage: 100, parties: [] };
        AppState.modeler.legal.groups[groupIndex].parties.push({ legalName: ``, role: 'Signatory', percentage: 0, detailsVisible: true, email: '', contactNumber: '', passport: {}, payment: { method: 'Bank Wire', currency: 'USD' } });
        UI.refreshImfpaModalUI();
    },
    removeImfpaParty: (groupIndex, partyIndex) => { AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1); UI.refreshImfpaModalUI(); },
    togglePartyDetails: (groupIndex, partyIndex) => {
        const party = AppState.modeler.legal.groups?.[groupIndex]?.parties?.[partyIndex];
        if (party) { party.detailsVisible = !party.detailsVisible; UI.refreshImfpaModalUI(); }
    },
    generateContract: () => {
        if (!Logic.validateImfpaData()) { Utils.showNotification("Cannot synthesize. Please complete all required fields (*).", 'error'); return; }
        const modal = document.getElementById('imfpa-modal'); if (!modal) return;
        const finalHtml = document.querySelector('#contract-document-wrapper .contract-document')?.outerHTML;
        document.getElementById('print-area').innerHTML = finalHtml;
        modal.classList.add('synthesis-complete');
        document.getElementById('synthesis-state').classList.add('hidden');
        document.getElementById('execution-suite-footer').classList.remove('hidden');
        Utils.showNotification("Document Synthesized & Finalized for Execution.", 'success', 'Synthesis Complete');
    },

    initiateSigningProcess: () => {
        const modal = document.getElementById('signature-modal'); if (!modal) return;
        modal.innerHTML = UI.renderSignatureModal();
        const sigBlocks = document.querySelectorAll('#contract-document-wrapper .signature-block');
        const selectEl = document.getElementById('signature-target-select'); if (!selectEl) return;
        selectEl.innerHTML = '<option value="">-- Select a Signatory --</option>';
        sigBlocks.forEach((block, index) => selectEl.add(new Option(`${index + 1}: ${block.dataset.partyName}`, block.dataset.partyName)));
        modal.showModal();
        Logic.switchSignatureMode('draw');
    },
    switchSignatureMode: (mode) => {
        ['draw', 'upload', 'seal'].forEach(m => {
            document.getElementById(`${m}-mode-panel`).classList.toggle('hidden', m !== mode);
            document.getElementById(`${m}-tab-btn`).classList.toggle('active', m === mode);
            document.getElementById(`${m}-tab-btn`).classList.toggle('text-green-400', m === mode);
            document.getElementById(`${m}-tab-btn`).classList.toggle('border-green-400', m === mode);
        });
        document.getElementById('signature-modal').dataset.activeMode = mode;
        if (mode === 'draw') Logic.setupSignaturePad();
    },
    setupSignaturePad: () => {
        const canvas = document.getElementById('signature-canvas'); if (!canvas) return;
        const resizeCanvas = () => { const ratio = Math.max(window.devicePixelRatio || 1, 1); const rect = canvas.getBoundingClientRect(); canvas.width = rect.width * ratio; canvas.height = rect.height * ratio; const ctx = canvas.getContext("2d"); ctx.scale(ratio, ratio); if (window.signaturePad) window.signaturePad.clear(); };
        if (!window.signaturePad) window.signaturePad = new SignaturePad(canvas);
        setTimeout(resizeCanvas, 100); window.addEventListener('resize', resizeCanvas);
    },
    clearSignaturePad: () => { if (window.signaturePad) window.signaturePad.clear(); },
    applySignature: async () => {
        const modal = document.getElementById('signature-modal'); const mode = modal.dataset.activeMode;
        const targetPartyName = document.getElementById('signature-target-select').value; if (!targetPartyName) { Utils.showNotification("Please select a signatory.", 'error'); return; }
        let dataUrl = '';
        try {
            if (mode === 'draw') { if (!window.signaturePad || window.signaturePad.isEmpty()) throw new Error("Please draw a signature."); dataUrl = window.signaturePad.toDataURL('image/png'); }
            else { const preview = document.getElementById(mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview'); if (!preview.src) throw new Error(`Please upload an image.`); dataUrl = preview.src; }
            ['#contract-document-wrapper', '#print-area'].forEach(container => {
                const targetBlock = document.querySelector(`${container} .signature-block[data-party-name="${targetPartyName}"]`); if (!targetBlock) return;
                const imgClass = mode === 'seal' ? 'p-seal-img' : 'p-signature-img';
                const targetElement = targetBlock.querySelector(mode === 'seal' ? '[data-sig-type="seal"]' : '[data-sig-type="signature"]');
                if (targetElement) targetElement.innerHTML = `<img src="${dataUrl}" class="${imgClass}" alt="Digital Signature">`;
            });
            modal.close();
            Utils.showNotification("Signature applied successfully.", 'success');
        } catch (error) { Utils.showNotification(error.message, 'error'); }
    },
    sendForSignature: () => { const modal = document.getElementById('finalization-modal'); if(modal) { modal.innerHTML = UI.renderFinalizationModal(); modal.showModal(); } },

    // === PREMIUM FINALIZATION WORKFLOW (NEW & UPGRADED) ===
    executeFinalizationWorkflow: async () => {
        const modal = document.getElementById('finalization-modal');
        if (modal) {
            modal.style.transition = 'all 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53)';
            modal.style.opacity = '0';
            modal.style.transform = 'scale(0.95)';
            setTimeout(() => modal.close(), 400);
        }
        Utils.showNotification("Initiating premium document finalization and dispatch workflow...", 'info', 'Processing');
        try {
            const finalHtml = document.getElementById('print-area').innerHTML;
            if (!finalHtml) throw new Error("No document content available for processing");
            const documentFingerprint = await Logic.simpleHash(finalHtml + Date.now());
            const agreementReference = finalHtml.match(/Reference:<\/strong>\s*([^<]+)/)?.[1]?.trim() || 'GECAN-DOC-FINAL';
            const recipientEmails = [...new Set(AppState.modeler.legal.groups.flatMap(g => g.parties).map(p => p.email).filter(Boolean))];
            if (recipientEmails.length === 0) throw new Error("No valid recipient email addresses found");
            const emailBody = Logic.generatePremiumEmailTemplate({ agreementReference, documentFingerprint, parties: AppState.modeler.legal.groups.flatMap(g => g.parties) });
            const printStyles = Logic.getPrintStyles();
            const payload = { agreementReference, documentFingerprint, recipientEmails: recipientEmails.join(','), emailBody, fileName: `${agreementReference}_EXECUTED.pdf`, htmlContent: `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>${printStyles}</style></head><body>${finalHtml}</body></html>` };
            const response = await Logic.createApiRequest('generatePdfAndDispatchEmail', 'POST', payload);
            Utils.showNotification("Document successfully finalized and dispatched to all parties with premium encryption.", 'success', 'Dispatch Complete');
        } catch (error) {
            console.error("Premium finalization workflow error:", error);
            Utils.showNotification(error.message || "An error occurred during the finalization process.", 'error', 'Dispatch Failed');
        }
    },
    generatePremiumEmailTemplate: (payload) => {
        const partyListHTML = payload.parties.map(p => `<li style="padding: 8px 0; border-bottom: 1px solid #f1f5f9;"><strong style="color: #1e293b;">${p.legalName || 'N/A'}</strong><span style="color: #64748b; margin-left: 10px;">(${p.role || 'Signatory'})</span>${p.email ? `<br><span style="color: #0369a1; font-size: 14px;">${p.email}</span>` : ''}</li>`).join('');
        return `<!DOCTYPE html><html><body style="font-family: 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; padding: 20px; margin: 0;"><div style="max-width: 800px; margin: 0 auto; background: #ffffff; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);"><div style="background: linear-gradient(135deg, #0369a1 0%, #1e40af 100%); color: white; padding: 40px 30px;"><h1 style="margin: 0; font-size: 32px;">GECAN™ Legal Systems</h1><p style="margin: 10px 0 0 0; font-size: 18px;">Executed Agreement - Premium Dispatch</p></div><div style="padding: 40px 30px;"><h2 style="color: #0369a1; font-size: 24px;">Distinguished Contracting Parties,</h2><p style="font-size: 16px; line-height: 1.6;">We are pleased to confirm the successful execution and finalization of your legal agreement.</p><div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 25px; margin: 30px 0;"><strong style="color: #0369a1; text-transform: uppercase;">Reference ID</strong><div style="font-family: 'Courier New', monospace; font-size: 18px;">${payload.agreementReference}</div><strong style="color: #0369a1; text-transform: uppercase; margin-top:15px; display:block;">Cryptographic Fingerprint (SHA-256)</strong><div style="font-family: 'Courier New', monospace; font-size: 12px; color: #64748b; word-break: break-all;">${payload.documentFingerprint}</div></div><h3 style="color: #0369a1;">Contracting Parties</h3><ul style="list-style: none; padding: 0; margin: 0;">${partyListHTML}</ul></div><div style="background: #f1f5f9; color: #64748b; padding: 25px 30px; font-size: 12px; border-top: 1px solid #e2e8f0;"><p style="text-align:center;"><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication is strictly confidential.</p></div></div></body></html>`;
    },
    getPrintStyles: () => {
        let css = '';
        for (const sheet of document.styleSheets) { try { if (sheet.cssRules) { for (const rule of sheet.cssRules) { if (rule.type === CSSRule.MEDIA_RULE && rule.media.mediaText.includes('print')) { for (const printRule of rule.cssRules) { css += printRule.cssText + '\n'; } } } } } catch (e) { console.warn("Stylesheet access restricted by CORS.", sheet.href); } }
        return css;
    },
    createApiRequest: async (action, method = 'POST', params = {}) => {
        const url = new URL(API_URL); url.searchParams.append('action', action);
        const options = { method: method.toUpperCase(), redirect: 'follow', body: JSON.stringify({ action, data: params }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }};
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
            const result = await response.json();
            if (result.success === false) throw new Error(result.error || 'Server error.');
            return result.data || result.message || result;
        } catch (error) { console.error(`API Error for '${action}':`, error); throw error; }
    },
    simpleHash: async (str) => {
        const buffer = new TextEncoder().encode(str); const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    },
};

// ====================================================================================
// === SECTION 4: UI RENDERERS (v5.0 - DEFINITIVE & SEVERELY UPGRADED) ===
// ====================================================================================
const UI = {
    init: () => {
        const defaultConfig = {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":["#0ea5e9","#6366f1","#8b5cf6"]},"shape":{"type":"circle"},"opacity":{"value":0.6,"random":true,"anim":{"enable":true,"speed":0.5,"opacity_min":0.1}},"size":{"value":3,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#475569","opacity":0.4,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"out_mode":"out"}},"interactivity":{"events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"}},"modes":{"grab":{"distance":200,"line_linked":{"opacity":0.6}},"push":{"particles_nb":4}}}};
        if (typeof particlesJS !== 'undefined') particlesJS('particles-js', defaultConfig);
    },
    renderParticles: (config) => { if (typeof particlesJS !== 'undefined') particlesJS('particles-js', config); },
    populateNavLinks: () => {
        const navPlaceholder = document.getElementById('desktop-nav-placeholder'), mobileMenuContent = document.getElementById('mobile-sidebar-content'); if (!navPlaceholder || !mobileMenuContent) return;
        const currentPageFile = window.location.pathname.split('/').pop().replace('.html', '') || 'index';
        const links = [{ page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },{ page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },{ page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },{ page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },{ page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }];
        const navHtml = (isMobile = false) => links.map(link => `<a href="./${link.page}.html" class="${isMobile ? 'nav-btn w-full justify-start' : 'nav-btn'} ${currentPageFile === link.page ? 'active' : ''}"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div><div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div></div></div><span class="nav-text">${link.text}</span></a>`).join('');
        navPlaceholder.innerHTML = `<div id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">${navHtml(false)}</div>`;
        mobileMenuContent.innerHTML = `<div class="mobile-nav-clone">${navHtml(true)}</div>`;
    },
    renderToolkitMenu: () => {
        const menuContainer = document.getElementById('toolkit-menu'); if (!menuContainer) return;
        menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => `<button onclick="Logic.setActiveToolkit('${t.id}')" class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${AppState.activeToolkit === t.id ? 'bg-gradient-to-r from-primary-azure to-primary-dark text-white shadow-lg shadow-primary-azure/20' : 'text-text-secondary hover:bg-background-secondary hover:text-white'}"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform"><i class="fas ${t.icon} text-white"></i></div><div class="flex-1 min-w-0"><div class="font-semibold truncate">${t.name}</div><div class="text-xs opacity-75 mt-1 truncate">${t.description.split('.')[0]}</div></div><i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity ml-auto"></i></button>`).join('');
    },
    renderActiveToolkit: () => {
        const container = document.getElementById('active-toolkit-container'); if (!container) return;
        const renderFunc = UI[`render${AppState.activeToolkit}UI`];
        if (typeof renderFunc === 'function') { container.innerHTML = renderFunc(); container.classList.remove('hidden'); Logic.bindActiveToolkitEvents(); }
        UI.renderToolkitMenu();
    },
    renderDashboardUI: () => `
        <div class="glass rounded-2xl p-8 h-full flex flex-col animate-fade-in-up">
            <div class="text-center mb-12"><h2 class="text-4xl font-bold gradient-text mb-4">GECAN™ Intelligent Toolkits</h2><p class="text-text-secondary text-lg max-w-2xl mx-auto leading-relaxed">Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits).filter(t => t.id !== 'Dashboard').map((t, index) => `<div class="report-section p-8 cursor-pointer group animate-scale-in stagger-${index + 1}" onclick="Logic.setActiveToolkit('${t.id}')"><div class="flex items-start gap-6"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform duration-300 ease-in-out"><i class="fas ${t.icon}"></i></div><div class="flex-1"><h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-azure transition-colors">${t.name}</h3><p class="text-text-secondary leading-relaxed">${t.description}</p><div class="mt-4 flex items-center text-primary-azure opacity-0 group-hover:opacity-100 transition-opacity duration-300"><span class="text-sm font-medium">Launch Toolkit</span><i class="fas fa-arrow-right ml-2"></i></div></div></div></div>`).join('')}
            </div>
        </div>`,
    renderInstitutionalModelerUI: () => {
        const dealTypes = [
            { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between assets in the GECAN matrix.', gradient: 'from-blue-500 to-cyan-500' },
            { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades with institutional-grade parameters.', gradient: 'from-yellow-500 to-orange-500' },
            { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized credit facilities with flexible terms.', gradient: 'from-green-500 to-emerald-500' },
            { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit to unlock institutional capital.', gradient: 'from-purple-500 to-violet-500' },
        ];
        return `<div class="flex flex-col gap-8 animate-fade-in-up"><div class="report-section p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-azure mr-3"></i>Institutional Deal Modeler</h2><button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-error-color/20 hover:border-error-color/50 hover:text-error-color whitespace-nowrap"><i class="fas fa-undo mr-2"></i>Reset All Parameters</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map((deal, index) => `<div class="deal-type-card glass p-6 text-center ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl deal-type-icon mx-auto"><i class="fas ${deal.icon}"></i></div><h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p></div>`).join('')}</div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-3 glass p-6 md:p-8 rounded-2xl flex flex-col"></div><div id="modeler-output-container" class="lg:col-span-2 glass p-6 md:p-8 rounded-2xl flex flex-col"></div></div></div>`;
    },
    renderModelerInputPanel: () => {
        const { activeDealType, pricingConfig } = AppState.modeler;
        const dealPanelRenderer = UI[`render${activeDealType}Panel`];
        const dealPanelHTML = dealPanelRenderer ? dealPanelRenderer() : `<p class="text-error-color">Error: Input panel for ${activeDealType} not found.</p>`;
        const pricingConfigHTML = `<div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}"><div class="grid grid-cols-2 gap-4 mb-4"><select data-path="pricingConfig.offerType" class="form-select">${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}</select><select data-path="pricingConfig.isValueInPercent" class="form-select">${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label><input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label><input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input"></div></div></div>`;
        return `<h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-sliders-h text-primary-azure"></i>Deal Parameters</h2><div class="space-y-6"><div class="p-4 rounded-lg bg-background-dark border border-border-color"><h4 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fas fa-file-contract text-primary-azure"></i>Transaction Core</h4><div class="space-y-4 mt-4">${dealPanelHTML}</div></div><div class="p-4 rounded-lg bg-background-dark border border-border-color"><div class="flex justify-between items-center cursor-pointer" onclick="Logic.togglePricingConfig()"><h4 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fas fa-percent text-primary-azure"></i>Pricing & Configuration</h4><i class="fas fa-chevron-down transition-transform ${pricingConfig.isVisible ? 'rotate-180' : ''}"></i></div>${pricingConfigHTML}</div></div>`;
    },
    renderAssetSwapPanel: () => {
        const state = AppState.modeler.assetSwap;
        const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0).sort((a, b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
        const fromAsset = Utils.getAssetByKey(state.fromAssetKey);
        return `<div class="flex items-center gap-4"><div class="flex-1"><label class="block text-sm font-medium text-text-muted mb-2">From Asset</label><select data-path="assetSwap.fromAssetKey" class="form-select">${assetOptions(state.fromAssetKey)}</select></div><div class="pt-8"><button onclick="Logic.swapAssets()" class="w-10 h-10 flex items-center justify-center rounded-full bg-primary-azure/20 text-primary-azure hover:bg-primary-azure/30 transition-all duration-300" title="Swap Assets"><i id="swap-icon" class="fas fa-exchange-alt"></i></button></div><div class="flex-1"><label class="block text-sm font-medium text-text-muted mb-2">To Asset</label><select data-path="assetSwap.toAssetKey" class="form-select">${assetOptions(state.toAssetKey)}</select></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Amount to Swap (<span class="font-bold text-white">${fromAsset.baseAsset || 'N/A'}</span>)</label><input type="text" data-path="assetSwap.amount" value="${(parseFloat(state.amount) || 0).toLocaleString()}" class="form-input text-lg font-bold"></div>`;
    },
    renderCommodityTradePanel: () => {
        const state = AppState.modeler.commodityTrade; const selectedIncoterm = commodityData.incoterms.find(i => i.value === state.incoterms) || commodityData.incoterms.find(i => i.value === 'FOB');
        const commodityOptions = (selectedKey) => AppState.marketData.filter(asset => ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Commodity', 'Energy'].some(term => asset.type?.includes(term))).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.key})</option>`).join('');
        const settlementOptions = (selectedKey) => AppState.marketData.filter(a => a.price > 0 && a.key !== state.assetKey).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset}</option>`).join('');
        const pricingModelInputs = () => { if (state.pricingModel === 'Fixed') { return `<div><label class="block text-sm font-medium text-text-muted mb-2">Fixed Price per Unit (USD)</label><input type="number" step="0.01" data-path="commodityTrade.fixedPrice" value="${state.fixedPrice}" class="form-input"></div>`; } if (state.pricingModel === 'Discount' || state.pricingModel === 'Premium') { return `<div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">${state.pricingModel} Value</label><input type="number" step="0.01" data-path="commodityTrade.discountPremiumValue" value="${state.discountPremiumValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Value Type</label><select data-path="commodityTrade.discountPremiumIsInPercent" class="form-select"><option value="true" ${state.discountPremiumIsInPercent ? 'selected':''}>Percentage (%)</option><option value="false" ${!state.discountPremiumIsInPercent ? 'selected':''}>Fixed Amount ($)</option></select></div></div>`; } return ''; };
        return `<div class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="md:col-span-2"><label class="block text-sm font-medium text-text-muted mb-2">Commodity Asset</label><select data-path="commodityTrade.assetKey" class="form-select">${commodityOptions(state.assetKey)}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Quantity</label><input type="number" data-path="commodityTrade.quantity" value="${state.quantity || ''}" class="form-input font-bold"></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Unit of Measure</label><select data-path="commodityTrade.unitOfMeasure" class="form-select"><option value="">Select unit...</option>${commodityData.unitsOfMeasure.map(u => `<option value="${u}" ${state.unitOfMeasure === u ? 'selected' : ''}>${u}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Origin Country</label><input list="countries-datalist" value="${state.origin || ''}" data-path="commodityTrade.origin" class="form-input"><datalist id="countries-datalist">${commodityData.countries.map(c => `<option value="${c}">`).join('')}</datalist></div><div><label class="block text-sm font-medium text-text-muted mb-2">${selectedIncoterm.port}</label><input list="ports-datalist" value="${state.port || ''}" data-path="commodityTrade.port" class="form-input"><datalist id="ports-datalist">${commodityData.ports.map(p => `<option value="${p}">`).join('')}</datalist></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Incoterms® 2020</label><select data-path="commodityTrade.incoterms" class="form-select">${commodityData.incoterms.map(i => `<option value="${i.value}" ${state.incoterms === i.value ? 'selected' : ''}>${i.label}</option>`).join('')}</select><p class="text-xs text-text-muted mt-2">Risk transfers to <strong>${selectedIncoterm.risk}</strong> • Cost responsibility: ${selectedIncoterm.cost}</p></div><div><label class="block text-sm font-medium text-text-muted mb-2">Pricing Model</label><div class="flex flex-wrap gap-2">${['Market', 'Discount', 'Premium', 'Fixed'].map(p => `<label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer ${state.pricingModel === p ? 'bg-primary-azure/20' : 'bg-background-light'}"><input type="radio" name="pricingModel" value="${p}" ${state.pricingModel === p ? 'checked' : ''} data-path="commodityTrade.pricingModel" class="hidden">${p}</label>`).join('')}</div></div>${pricingModelInputs()}<div><label class="block text-sm font-medium text-text-muted mb-2">Settlement Asset</label><select data-path="commodityTrade.settlementAssetKey" class="form-select"><option value="USD">USD (Default)</option>${settlementOptions(state.settlementAssetKey)}</select></div></div>`;
    },
    renderCryptoLoanPanel: () => {
        const state = AppState.modeler.cryptoLoan;
        const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type === 'Cryptocurrency').map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
        const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
        return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div></div>`;
    },
    renderSBLCMonetizationPanel: () => {
        const state = AppState.modeler.sblcMonetization;
        return `<div><label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label><input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div>`;
    },
    renderModelerOutputPanel: (calc) => {
        if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
        let customOutput = '';
        if (AppState.modeler.activeDealType === 'AssetSwap') {
            const { fromAsset, toAsset, rate } = calc; const rateDisplay = rate > 0 ? rate.toFixed(8) : 'N/A';
            customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-sync-alt"></i>Institutional Cross Rate</p><p class="value">${rateDisplay}</p><p class="sub-value">1 ${fromAsset.baseAsset} ≈ ${rateDisplay} ${toAsset.baseAsset}</p></div>`;
        } else if (AppState.modeler.activeDealType === 'CryptoLoan') {
            const monthlyPayment = calc.totalRepayment / (calc.tenureMonths || 1);
            customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-hand-holding-usd"></i>Loan Principal</p><p class="value">${Utils.formatPrice(calc.loanPrincipal, calc.loanCurrency)}</p><p class="sub-value">Total Repayment: ${Utils.formatPrice(calc.totalRepayment, calc.loanCurrency)}</p></div><div class="output-metric-card mt-4"><p class="label"><i class="fas fa-calendar-alt"></i>Monthly Repayment</p><p class="value">${Utils.formatPrice(monthlyPayment, calc.loanCurrency)}</p><p class="sub-value">${calc.tenureMonths}-month tenure @ ${calc.interestRateValue}% fixed</p></div>`;
        }
        return `<div class="flex flex-col h-full animate-fade-in-up"><h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-success-color"></i>Deal Analysis & Projections</h2><div class="space-y-4 flex-grow"><div class="output-metric-card base-value"><p class="label"><i class="fas fa-tags"></i>Base/Market Value</p><p class="value">${Utils.formatPrice(calc.baseValueUSD)}</p><p class="sub-value">${calc.dealTitle}</p></div><div class="output-metric-card net"><p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Value to Buyer</p><p class="value">${Utils.formatPrice(calc.finalValueToBuyerUSD)}</p><p class="sub-value">${calc.netValueDescription}</p></div><div class="output-metric-card commission"><p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p><p class="value">${Utils.formatPrice(calc.totalCommissionPool)}</p><p class="sub-value">${calc.grossValueDescription}</p></div>${customOutput}</div><div class="mt-auto pt-6 border-t border-border-color"><button onclick="Logic.openImfpaModal()" class="btn-primary w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Commission Manager</button></div></div>`;
    },

    // ========================================================
    // === PINNACLE MAIN MODAL RENDERER - ENHANCED RESPONSIVE ARCHITECTURE ===
    // ========================================================
    renderImfpaModal: () => {
        const { legal } = AppState.modeler;
        const isImfpa = legal.agreementType === 'IMFPA';
        const isReadyToSynthesize = Logic.validateImfpaData();
        const synthesizeButtonClass = isReadyToSynthesize ? 'from-premium-gold via-yellow-500 to-yellow-600 border-premium-gold hover:shadow-2xl hover:shadow-premium-gold-glow transform hover:scale-105 transition-all duration-300' : 'from-gray-700 via-gray-600 to-gray-800 border-gray-600 cursor-not-allowed opacity-75';
        const synthesizeButtonText = isReadyToSynthesize ? 'Synthesize & Generate Document' : 'Complete Required Fields (*) to Synthesize';
        return `<div class="dialog-content-wrapper"><header class="sticky top-0 z-50 bg-gradient-to-r from-slate-900/95 via-slate-800/95 to-slate-900/95 backdrop-blur-xl border-b border-premium-border shadow-2xl px-4 md:px-8 py-4"><div class="flex items-center justify-between"><div class="hidden md:block"><h1 class="text-2xl lg:text-3xl font-bold bg-gradient-to-r from-premium-gold to-yellow-400 bg-clip-text text-transparent">Interactive Contract Workspace</h1><p class="text-sm text-premium-text-secondary mt-1">Configure details on the left • Live preview on the right</p></div><div class="md:hidden"><h1 class="text-lg font-bold bg-gradient-to-r from-premium-gold to-yellow-400 bg-clip-text text-transparent">Contract Builder</h1></div><button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-premium-text-secondary hover:text-white transition-all duration-300 hover:rotate-90 transform">&times;</button></div><div class="mt-4 mb-2"><div class="bg-black/30 backdrop-blur-sm p-4 rounded-xl border border-premium-border/50"><div class="flex items-center justify-center gap-4 md:gap-8"><span class="toggle-label font-semibold ${!isImfpa ? 'text-primary-azure' : 'text-gray-500'}">NCNDA Only</span><label class="relative"><input type="checkbox" onchange="Logic.toggleAgreementType(this.checked)" ${isImfpa ? 'checked' : ''} class="sr-only"><div class="toggle-track w-16 h-8 bg-gray-600 rounded-full transition-colors duration-300 ${isImfpa ? 'bg-premium-gold' : ''}"><div class="toggle-thumb absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform duration-300 transform ${isImfpa ? 'translate-x-8' : 'translate-x-0'}"></div></div></label><span class="toggle-label font-semibold ${isImfpa ? 'text-premium-gold' : 'text-gray-500'}">Full IMFPA</span></div></div></div><div class="mobile-nav-pills md:hidden mt-4 flex gap-2 overflow-x-auto pb-2"><button onclick="UI.scrollToSection('editor')" class="nav-pill bg-primary-azure/20 text-primary-azure px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-edit mr-1"></i>Configure</button><button onclick="UI.scrollToSection('preview')" class="nav-pill bg-premium-gold/20 text-premium-gold px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-eye mr-1"></i>Preview</button></div></header><main class="flex-1"><div class="h-full"><div class="workspace-grid h-full grid grid-cols-1 lg:grid-cols-2 gap-0 lg:gap-6"><section id="editor-section" class="bg-gradient-to-b from-slate-900/50 to-slate-800/50 backdrop-blur-sm"><div class="h-full flex flex-col"><div class="sticky top-0 z-40 bg-gradient-to-r from-slate-800/90 to-slate-700/90 backdrop-blur-sm p-4 border-b border-premium-border/50"><div class="flex items-center justify-between"><h2 class="text-lg font-bold text-premium-text-primary flex items-center"><i class="fas fa-cogs text-primary-azure mr-3"></i>Configuration Panel</h2><button onclick="UI.toggleMobilePreview()" class="lg:hidden btn-secondary px-3 py-1.5 text-sm rounded-lg"><i class="fas fa-eye mr-1"></i>Preview</button></div></div><div class="editor-content flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6"><div id="editor-content-dynamic"></div></div></div></section><section id="preview-section" class="preview-panel bg-gradient-to-b from-slate-900/30 to-slate-800/30 backdrop-blur-sm lg:block hidden"><div class="h-full flex flex-col"><div class="preview-header sticky top-0 z-40 bg-gradient-to-r from-slate-800/90 to-slate-700/90 backdrop-blur-sm p-4 border-b border-premium-border/50"><div class="flex items-center justify-between"><h2 class="text-lg font-bold text-premium-text-primary flex items-center"><i class="fas fa-file-contract text-premium-gold mr-3"></i>Live Document Preview</h2><button onclick="UI.toggleMobilePreview()" class="lg:hidden btn-secondary px-3 py-1.5 text-sm rounded-lg"><i class="fas fa-arrow-left mr-1"></i>Back</button></div></div><div class="preview-content flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6"><div id="contract-document-wrapper"></div></div></div></section></div></div></main><footer class="sticky bottom-0 z-50 bg-gradient-to-r from-slate-900/95 via-slate-800/95 to-slate-900/95 backdrop-blur-xl border-t border-premium-border shadow-2xl p-4 md:p-6"><div id="synthesis-state"><button id="synthesize-btn" onclick="Logic.generateContract()" class="w-full py-3 md:py-4 font-bold text-sm md:text-base rounded-xl bg-gradient-to-r ${synthesizeButtonClass} border-2 transition-all duration-300 shadow-lg" ${!isReadyToSynthesize ? 'disabled' : ''}><i class="fas fa-wand-magic-sparkles mr-2"></i>${synthesizeButtonText}</button></div><div class="execution-suite-container hidden" id="execution-suite-footer"><div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4"><button onclick="UI.returnToEditor()" class="execution-btn bg-gradient-to-r from-blue-600 to-blue-700 border-blue-500 hover:shadow-lg hover:shadow-blue-500/25 transition-all duration-300"><i class="fas fa-edit mr-2"></i><span class="hidden sm:inline">Back to </span>Editor</button><button id="launch-signing-btn" onclick="Logic.initiateSigningProcess()" class="execution-btn bg-gradient-to-r from-green-600 to-green-700 border-green-500 hover:shadow-lg hover:shadow-green-500/25 transition-all duration-300"><i class="fas fa-pen-fancy mr-2"></i><span class="hidden sm:inline">Launch </span>Signing</button><button id="send-for-signature-btn" onclick="Logic.sendForSignature()" class="execution-btn bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-lg hover:shadow-purple-500/25 transition-all duration-300"><i class="fas fa-paper-plane mr-2"></i><span class="hidden sm:inline">Lock & </span>Send</button></div></div></footer></div>`;
    },
    renderImfpaGroups: () => {
        const { legal } = AppState.modeler;
        const { groups } = legal;
        if (AppState.modeler.legal.agreementType === 'IMFPA') {
            const imfpaContainer = document.getElementById('imfpa-groups-container'); if (!imfpaContainer) return;
            if (!groups || groups.length === 0) { imfpaContainer.innerHTML = `<div class="text-center py-8"><i class="fas fa-sitemap fa-3x text-premium-text-secondary/30 mb-4"></i><h4 class="font-bold text-premium-text-primary mb-2">No Allocation Groups</h4><p class="text-premium-text-secondary mb-4">Create your first commission allocation group to begin.</p><button onclick="Logic.addImfpaGroup()" class="btn-primary px-6 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Add First Group</button></div>`; return; }
            imfpaContainer.innerHTML = groups.map((group, groupIndex) => `<div class="allocation-group-card bg-gradient-to-br from-slate-800/50 to-slate-700/30 border border-premium-border/50 rounded-xl p-4 md:p-6 shadow-lg hover:shadow-xl transition-all duration-300"><div class="mb-4"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 bg-gradient-to-br from-primary-azure to-blue-600 rounded-lg flex items-center justify-center"><i class="fas fa-layer-group text-white text-sm"></i></div><input type="text" value="${group.name}" data-path="legal.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow text-lg font-bold text-premium-text-primary placeholder-premium-text-secondary/50 focus:ring-2 focus:ring-primary-azure/50" placeholder="Group Name"><button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-red-500 hover:text-red-400 hover:bg-red-500/10 w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300"><i class="fas fa-trash text-sm"></i></button></div><div class="grid grid-cols-3 gap-4"><div class="bg-black/20 rounded-lg p-3 text-center"><p class="text-xs text-premium-text-secondary mb-1">Parties</p><p class="text-lg font-bold text-primary-azure">${group.parties.length}</p></div><div class="bg-black/20 rounded-lg p-3 text-center relative"><p class="text-xs text-premium-text-secondary mb-1">Allocation</p><input type="number" value="${group.percentage}" data-path="legal.groups[${groupIndex}].percentage" class="form-input text-center font-bold text-lg bg-transparent border-0 focus:ring-2 focus:ring-premium-gold/50 w-full"><span class="absolute right-2 top-6 text-premium-text-secondary pointer-events-none">%</span></div><div class="bg-black/20 rounded-lg p-3 text-center"><p class="text-xs text-premium-text-secondary mb-1">Value</p><p id="imfpa-group-value-${groupIndex}" class="text-lg font-bold text-premium-gold font-mono"></p></div></div></div><div><div class="flex items-center justify-between mb-3"><h4 class="text-sm font-semibold text-premium-text-secondary flex items-center"><i class="fas fa-users mr-2"></i>Group Members</h4><button onclick="Logic.addImfpaParty(${groupIndex})" class="text-xs text-premium-gold hover:text-yellow-300 font-semibold px-3 py-1 rounded-lg hover:bg-premium-gold/10 transition-all duration-300"><i class="fas fa-user-plus mr-1"></i>Add Member</button></div><div class="space-y-3">${group.parties.length > 0 ? group.parties.map((party, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('') : `<div class="text-center py-4 text-premium-text-secondary/50"><i class="fas fa-user-plus fa-2x mb-2"></i><p class="text-sm">No members yet. Add your first party above.</p></div>`}</div><div id="imfpa-group-total-${groupIndex}" class="group-total mt-4 p-3 bg-black/20 rounded-lg text-right font-mono text-sm text-premium-text-secondary border border-premium-border/30"></div></div></div>`).join('');
            const ncndaContainer = document.getElementById('ncnda-parties-container'); if (ncndaContainer) ncndaContainer.innerHTML = '';
        } else {
            const ncndaContainer = document.getElementById('ncnda-parties-container'); if (!ncndaContainer) return;
            if (!groups || groups.length === 0) AppState.modeler.legal.groups.push({ name: 'NCNDA Signatories', percentage: 100, parties: [] });
            const signatoryList = AppState.modeler.legal.groups[0].parties;
            if (signatoryList.length === 0) { ncndaContainer.innerHTML = `<div class="text-center py-8"><i class="fas fa-user-friends fa-3x text-premium-text-secondary/30 mb-4"></i><h4 class="font-bold text-premium-text-primary mb-2">No Signatory Parties</h4><p class="text-premium-text-secondary mb-4">Add the parties who will sign this NCNDA.</p><button onclick="Logic.addImfpaParty(0)" class="btn-primary px-6 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Add First Party</button></div>`; } else { ncndaContainer.innerHTML = signatoryList.map((party, partyIndex) => UI.renderImfpaParty(0, partyIndex)).join(''); }
            const imfpaContainer = document.getElementById('imfpa-groups-container'); if (imfpaContainer) imfpaContainer.innerHTML = '';
        }
    },
    renderImfpaParty: (groupIndex, partyIndex) => {
        const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex]; const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`; const isImfpa = AppState.modeler.legal.agreementType === 'IMFPA';
        const coreComplete = !!party.legalName && !!party.email && !!party.contactNumber; const extendedComplete = !!party.role && !!party.passport?.number && !!party.passport?.authority && !!party.passport?.issueDate && !!party.passport?.expiryDate && !!party.payment?.method && !!party.payment?.details; const allComplete = coreComplete && extendedComplete;
        let validationStatus;
        if (allComplete) validationStatus = { badgeClass: 'bg-gradient-to-r from-green-500 to-emerald-600 text-white border border-green-400', badgeText: 'COMPLETE', badgeIcon: 'fa-check-double', indicatorClass: 'text-green-400', indicatorIcon: 'fa-shield-check', indicatorText: 'Fully Verified & Ready' };
        else if (coreComplete) validationStatus = { badgeClass: 'bg-gradient-to-r from-blue-500 to-cyan-600 text-white border border-blue-400', badgeText: 'SUFFICIENT', badgeIcon: 'fa-check-circle', indicatorClass: 'text-blue-400', indicatorIcon: 'fa-info-circle', indicatorText: 'Core Details Sufficient for Signing' };
        else validationStatus = { badgeClass: 'bg-gradient-to-r from-red-500 to-orange-600 text-white border border-red-400 animate-pulse', badgeText: 'INCOMPLETE', badgeIcon: 'fa-exclamation-triangle', indicatorClass: 'text-red-400', indicatorIcon: 'fa-exclamation-triangle', indicatorText: 'Required Core Details Missing' };
        return `<div class="party-card bg-gradient-to-br from-slate-800/40 to-slate-700/20 border border-premium-border/40 rounded-lg p-4 hover:shadow-lg transition-all duration-300"><div><div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 bg-gradient-to-br from-primary-amethyst to-purple-600 rounded-full flex items-center justify-center"><i class="fas fa-user text-white text-xs"></i></div><input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow text-sm font-semibold text-premium-text-primary placeholder-premium-text-secondary/60 focus:ring-2 focus:ring-primary-amethyst/50" placeholder="Full Legal Name *"><button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-red-500 hover:text-red-400 hover:bg-red-500/10 w-6 h-6 rounded-full flex items-center justify-center transition-all duration-300"><i class="fas fa-times text-xs"></i></button></div><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-2"><span class="status-badge text-xs font-bold px-2 py-1 rounded-full ${validationStatus.badgeClass}"><i class="fas ${validationStatus.badgeIcon} mr-1"></i>${validationStatus.badgeText}</span>${isImfpa ? `<div class="relative"><input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input w-16 text-xs text-right pr-6 py-1"><span class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-premium-text-secondary pointer-events-none">%</span></div>` : ''}</div><button onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-xs text-primary-amethyst hover:text-purple-300 font-medium px-2 py-1 rounded hover:bg-primary-amethyst/10 transition-all duration-300 flex items-center gap-1"><i class="fas fa-user-cog"></i><span class="hidden sm:inline">Details</span><i class="fas fa-chevron-down transition-transform duration-300 ${party.detailsVisible ? 'rotate-180' : ''}"></i></button></div><div class="flex items-center gap-2 text-xs ${validationStatus.indicatorClass}"><i class="fas ${validationStatus.indicatorIcon}"></i><span>${validationStatus.indicatorText}</span></div></div><div class="transition-all duration-300 overflow-hidden ${party.detailsVisible ? 'max-h-screen opacity-100 mt-4' : 'max-h-0 opacity-0'}">${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div></div>`;
    },
    renderImfpaPartyDetails: (groupIndex, partyIndex) => {
        const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex]; const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
        const getFieldClass = (value) => `form-input text-xs transition-all duration-300 ${value ? 'border-green-500/50 bg-green-500/5' : ''}`;
        const paymentPlaceholder = {'Bank Wire': 'Bank Name, SWIFT Code, Account Number...', 'USDT TRC-20': 'TRC-20 Wallet Address (starts with T...)', 'USDT ERC-20': 'ERC-20 Wallet Address (starts with 0x...)'}[party.payment.method] || 'Enter payment details...';
        return `<div class="bg-slate-900/30 rounded-lg p-4 border border-premium-border/30"><div class="mb-6"><div class="flex items-center gap-2 mb-4"><div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-600 rounded flex items-center justify-center"><i class="fas fa-id-card text-white text-xs"></i></div><h4 class="text-sm font-bold text-premium-text-primary">Core Information</h4><span class="text-xs text-red-400 font-medium">(Required)</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-envelope mr-1"></i>Email Address *</label><input type="email" class="${getFieldClass(party.email)}" value="${party.email || ''}" data-path="${base}.email" placeholder="professional@company.com"></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-phone mr-1"></i>Contact Number *</label><input type="tel" class="${getFieldClass(party.contactNumber)}" value="${party.contactNumber || ''}" data-path="${base}.contactNumber" placeholder="+1-555-123-4567"></div></div></div><div class="mb-6"><div class="flex items-center gap-2 mb-4"><div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-indigo-600 rounded flex items-center justify-center"><i class="fas fa-briefcase text-white text-xs"></i></div><h4 class="text-sm font-bold text-premium-text-primary">Professional Details</h4><span class="text-xs text-blue-400 font-medium">(Recommended)</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-user-tag mr-1"></i>Role/Title</label><input type="text" class="${getFieldClass(party.role)}" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate, Principal"></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-passport mr-1"></i>Passport/ID Number</label><input type="text" class="${getFieldClass(party.passport.number)}" value="${party.passport.number || ''}" data-path="${base}.passport.number" placeholder="As on document"></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-flag mr-1"></i>Issuing Authority</label><input type="text" class="${getFieldClass(party.passport.authority)}" value="${party.passport.authority || ''}" data-path="${base}.passport.authority" placeholder="e.g., USA"></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-calendar-alt mr-1"></i>Expiry Date</label><input type="date" class="${getFieldClass(party.passport.expiryDate)}" value="${party.passport.expiryDate || ''}" data-path="${base}.passport.expiryDate"></div></div></div><div><div class="flex items-center gap-2 mb-4"><div class="w-6 h-6 bg-gradient-to-br from-green-500 to-emerald-600 rounded flex items-center justify-center"><i class="fas fa-credit-card text-white text-xs"></i></div><h4 class="text-sm font-bold text-premium-text-primary">Payment Coordination</h4><span class="text-xs text-green-400 font-medium">(For IMFPA)</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-exchange-alt mr-1"></i>Payment Method</label><select class="form-select text-xs" data-path="${base}.payment.method"><option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected' : ''}>Bank Wire Transfer</option><option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected' : ''}>USDT (TRC-20)</option><option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected' : ''}>USDT (ERC-20)</option></select></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-dollar-sign mr-1"></i>Settlement Currency</label><select class="form-select text-xs" data-path="${base}.payment.currency"><option value="USD" ${party.payment.currency === 'USD' ? 'selected' : ''}>US Dollar (USD)</option><option value="USDT" ${party.payment.currency === 'USDT' ? 'selected' : ''}>Tether (USDT)</option><option value="EUR" ${party.payment.currency === 'EUR' ? 'selected' : ''}>Euro (EUR)</option></select></div></div><div><label class="block text-xs font-medium text-premium-text-secondary mb-2"><i class="fas fa-university mr-1"></i>Payment Details & Coordinates</label><textarea class="${getFieldClass(party.payment.details)} font-mono" data-path="${base}.payment.details" rows="3" placeholder="${paymentPlaceholder}">${party.payment.details || ''}</textarea><p class="text-xs text-premium-text-secondary/60 mt-1"><i class="fas fa-info-circle mr-1"></i>Provide complete details for secure remittance.</p></div></div></div>`;
    },
    renderImfpaEditorContent: () => {
        const { legal } = AppState.modeler;
        const isImfpa = legal.agreementType === 'IMFPA';
        return `<div class="space-y-8"><div id="commission-allocation-section" class="editor-section ${isImfpa ? 'block' : 'hidden'}"><div class="mb-6"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gradient-to-br from-premium-gold to-yellow-600 rounded-lg flex items-center justify-center"><i class="fas fa-chart-pie text-white"></i></div><div><h3 class="text-xl font-bold text-premium-text-primary">Commission Allocation</h3><p class="text-xs text-premium-text-secondary">Configure distribution groups and percentages</p></div></div><div class="text-right"><p class="text-xs text-premium-text-secondary mb-1">Total Commission Pool</p><p id="imfpa-total-commission-pool" class="text-2xl font-bold text-premium-gold font-mono"></p></div></div></div><div class="bg-black/20 rounded-xl p-4 mb-6 border border-premium-border/30"><div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><button onclick="Logic.addImfpaGroup()" class="btn-primary bg-gradient-to-r from-blue-600 to-cyan-600 border-blue-500 px-4 py-2 rounded-lg font-semibold hover:shadow-lg hover:shadow-blue-500/25 transition-all duration-300"><i class="fas fa-plus mr-2"></i>Add Allocation Group</button><div class="flex flex-col sm:flex-row items-start sm:items-center gap-4"><div class="flex items-center gap-2"><input type="checkbox" id="auto-balance-toggle" onchange="AppState.modeler.legal.autoBalance = this.checked; Logic.updateImfpaCalculations();" ${legal.autoBalance ? 'checked' : ''} class="w-4 h-4 rounded text-premium-gold focus:ring-premium-gold/50"><label for="auto-balance-toggle" class="text-sm text-premium-text-secondary cursor-pointer">Auto-Balance Percentages</label></div><div id="imfpa-total-allocated" class="text-sm font-mono px-3 py-1 rounded-lg bg-black/30 border border-premium-border/30"></div></div></div></div><div class="space-y-4" id="imfpa-groups-container"></div></div><div class="editor-section"><div class="mb-6"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gradient-to-br from-primary-amethyst to-purple-600 rounded-lg flex items-center justify-center"><i class="fas fa-users text-white"></i></div><div><h3 class="text-xl font-bold text-premium-text-primary">${isImfpa ? 'Allocation Members' : 'Signatory Parties'}</h3><p class="text-xs text-premium-text-secondary">${isImfpa ? 'Parties are managed within allocation groups above' : 'Add all parties who will sign this agreement'}</p></div></div></div></div><div id="ncnda-controls" class="${isImfpa ? 'hidden' : 'block'}"><div class="bg-black/20 rounded-xl p-4 mb-6 border border-premium-border/30"><button onclick="Logic.addImfpaParty(0)" class="btn-primary bg-gradient-to-r from-purple-600 to-indigo-600 border-purple-500 px-4 py-2 rounded-lg font-semibold hover:shadow-lg hover:shadow-purple-500/25 transition-all duration-300"><i class="fas fa-user-plus mr-2"></i>Add Signatory Party</button></div></div><div class="space-y-4" id="ncnda-parties-container"></div></div><div class="editor-section"><div class="mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gradient-to-br from-red-600 to-pink-600 rounded-lg flex items-center justify-center"><i class="fas fa-gavel text-white"></i></div><div><h3 class="text-xl font-bold text-premium-text-primary">Legal Framework</h3><p class="text-xs text-premium-text-secondary">Jurisdiction and regulatory compliance settings</p></div></div></div><div class="space-y-4"><div class="bg-black/20 rounded-xl p-4 border border-premium-border/30"><label class="flex items-center gap-2 mb-3"><i class="fas fa-globe text-red-400"></i><span class="text-sm font-semibold text-premium-text-primary">Governing Law & Jurisdiction</span><span class="text-xs text-red-400 font-medium">*Required</span></label><input value="${legal.jurisdiction}" data-path="legal.jurisdiction" class="form-input w-full ${legal.jurisdiction ? 'border-green-500/50 bg-green-500/5' : ''}" placeholder="e.g., Singapore, United Kingdom, New York USA"><p class="text-xs text-premium-text-secondary/60 mt-2"><i class="fas fa-info-circle mr-1"></i>Specify the legal jurisdiction that will govern this agreement.</p></div><div class="bg-black/20 rounded-xl p-4 border border-premium-border/30"><label class="flex items-center gap-2 mb-3"><i class="fas fa-link text-blue-400"></i><span class="text-sm font-semibold text-premium-text-primary">Cross-Referenced SPA</span><span class="text-xs text-blue-400 font-medium">Optional</span></label><input value="${legal.spaReferenceCode || ''}" data-path="legal.spaReferenceCode" class="form-input w-full font-mono ${legal.spaReferenceCode ? 'border-green-500/50 bg-green-500/5' : ''}" placeholder="e.g., SPA-2024-001"><p class="text-xs text-premium-text-secondary/60 mt-2"><i class="fas fa-info-circle mr-1"></i>Reference code for a related Sales & Purchase Agreement.</p></div></div></div></div>`;
    },
    renderContractDocument: (agreementReference) => {
        const { legal } = AppState.modeler; const allParties = legal.groups.flatMap(g => g.parties); const isImfpa = legal.agreementType === 'IMFPA';
        const feeClauses = isImfpa ? legal.groups.map((group, groupIndex) => `<div class="mb-8"><h3 class="text-lg font-bold text-black mb-4 flex items-center"><span class="w-6 h-6 bg-yellow-600 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${groupIndex + 1}</span>${group.name} (${group.percentage}%)</h3><div class="mb-4 p-4 bg-gray-100 rounded-lg"><p class="text-black font-semibold">Group Total: <span class="text-yellow-700 font-mono">${Utils.formatPrice(legal.totalCommission * (group.percentage / 100))}</span></p></div><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b-2 border-gray-400"><th class="text-left py-2 px-3 font-semibold">Beneficiary</th><th class="text-center py-2 px-3 font-semibold">Share</th><th class="text-right py-2 px-3 font-semibold">Value</th><th class="text-left py-2 px-3 font-semibold">Payment Method</th></tr></thead><tbody>${group.parties.map(party => `
        <tr class="border-b border-gray-200"><td class="py-3 px-3 font-medium">${party.legalName}</td><td class="py-3 px-3 text-center font-mono">${party.percentage}%</td><td class="py-3 px-3 text-right font-mono font-bold text-yellow-800">${Utils.formatPrice(legal.totalCommission * (group.percentage / 100) * (party.percentage / 100))}</td><td class="py-3 px-3 text-xs">${party.payment.method}</td></tr>`).join('')}</tbody></table></div></div>`).join('') : '';
        const signatureBlocks = allParties.map((party, index) => `<div class="signature-block bg-gray-50 rounded-lg p-6 border border-gray-200" data-party-id="party-${index}" data-party-name="${party.legalName}"><p class="text-lg font-bold text-black uppercase mb-4">FOR AND ON BEHALF OF: ${party.legalName}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="signature-field"><div class="signature-line h-16 border-b-2 border-gray-400 mb-2" data-sig-type="signature"></div><p class="text-sm font-medium">Authorized Signature</p></div><div class="signature-field"><div class="signature-line h-16 border-b-2 border-gray-400 mb-2" data-sig-type="print-name"></div><p class="text-sm font-medium">Print Name: ${party.legalName}</p><p class="text-sm text-gray-600">Title: ${party.role || 'Authorized Representative'}</p></div><div class="signature-field"><div class="signature-line h-16 border-b-2 border-gray-400 mb-2" data-sig-type="date"></div><p class="text-sm font-medium">Date of Execution</p></div><div class="signature-field"><div class="seal-area h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center" data-sig-type="seal"><span class="text-xs text-gray-500">Corporate Seal</span></div></div></div></div>`).join('');
        const title = isImfpa ? "Irrevocable Master Fee Protection Agreement & NCNDA" : "Non-Circumvention, Non-Disclosure Agreement (NCNDA)";
        const imfpaSection = isImfpa ? `<div class="mb-8"><div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-8"><h2 class="text-xl font-bold text-black mb-3 flex items-center"><i class="fas fa-coins text-yellow-600 mr-3"></i>Commission Structure Overview</h2><p class="text-black text-lg">This agreement establishes the commission distribution for a total pool of <span class="text-2xl font-bold text-yellow-700 font-mono">${Utils.formatPrice(legal.totalCommission)}</span></p></div><div><h2 class="section-title text-xl font-bold text-black mb-6 flex items-center"><i class="fas fa-sitemap text-yellow-600 mr-3"></i>ANNEX A: Fee Distribution Schedule</h2>${feeClauses}</div></div>` : '';
        return `<div class="contract-document bg-white text-black min-h-screen p-8"><div class="document-header text-center mb-8 pb-6 border-b-2 border-gray-300"><h1 class="document-title text-3xl font-bold mb-4 text-gray-900">${title}</h1><div class="text-sm text-gray-600 space-y-1"><p><strong>Reference:</strong> ${agreementReference}</p><p><strong>Effective Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p><p><strong>Jurisdiction:</strong> ${legal.jurisdiction || '[To be specified]'}</p></div></div><div class="space-y-8 mb-12">${imfpaSection}<div><h2 class="section-title text-xl font-bold text-gray-900 mb-4 flex items-center"><i class="fas fa-users text-blue-600 mr-3"></i>Agreement Parties</h2><div><p class="text-gray-700 mb-4">This agreement is entered into by and between the following parties:</p><ul class="space-y-2">${allParties.map((party, index) => `<li class="flex items-center"><span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span><div><span class="font-semibold">${party.legalName}</span>${party.role ? `<span class="text-gray-600 ml-2">(${party.role})</span>` : ''}</div></li>`).join('')}</ul></div></div></div><div class="signature-section"><h2 class="section-title text-xl font-bold text-gray-900 mb-6 flex items-center border-t-2 border-gray-300 pt-6"><i class="fas fa-pen-fancy text-green-600 mr-3"></i>Execution & Signatures</h2><p class="text-gray-700 mb-8">IN WITNESS WHEREOF, the Parties have executed this Agreement by their duly authorized representatives.</p><div class="space-y-8">${signatureBlocks}</div></div></div>`;
    },
    renderNotificationModal: (message, type, title) => {
        const config = { success: { i: 'fa-check-circle', c: 'green', bg: 'from-green-500/20 to-emerald-600/20' }, error: { i: 'fa-exclamation-triangle', c: 'red', bg: 'from-red-500/20 to-rose-600/20' }, warning: { i: 'fa-exclamation-circle', c: 'yellow', bg: 'from-yellow-500/20 to-amber-600/20' }, info: { i: 'fa-info-circle', c: 'blue', bg: 'from-blue-500/20 to-cyan-600/20' } }[type] || { i: 'fa-info-circle', c: 'blue', bg: 'from-blue-500/20 to-cyan-600/20' };
        const defaultTitle = { success: 'Success', error: 'Error', warning: 'Warning', info: 'Information' }[type] || 'Notification';
        return `<div class="dialog-content-wrapper"><div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col"><div class="bg-gradient-to-r ${config.bg} border-b border-premium-border p-6"><div class="flex items-center gap-4"><div class="w-16 h-16 bg-gradient-to-br from-${config.c}-400 to-${config.c}-600 rounded-full flex items-center justify-center shadow-lg"><i class="fas ${config.i} fa-2x text-white"></i></div><div class="flex-1"><h2 class="text-2xl font-bold text-premium-text-primary">${title || defaultTitle}</h2><p class="text-sm text-premium-text-secondary mt-1">Please review this important message</p></div></div></div><div class="flex-1 p-8"><div class="text-premium-text-primary leading-relaxed text-lg">${message}</div></div><div class="bg-black/20 border-t border-premium-border p-6 flex justify-end"><button id="notification-ok-btn" class="btn-primary bg-gradient-to-r from-${config.c}-500 to-${config.c}-700 border-${config.c}-500 px-8 py-3 font-bold text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300"><i class="fas fa-check mr-2"></i>Acknowledge</button></div></div></div>`;
    },
    renderSignatureModal: () => `
        <div class="dialog-content-wrapper"><div id="signature-modal-content" class="text-white flex flex-col"><div class="p-6 border-b border-premium-border"><div class="flex items-center justify-between"><h2 class="text-2xl font-bold bg-gradient-to-r from-green-300 to-emerald-400 bg-clip-text text-transparent">Document Execution Suite</h2><button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-premium-text-secondary hover:text-white">&times;</button></div><div class="mt-4"><label for="signature-target-select" class="block text-sm font-semibold mb-2">Apply signature to:</label><select id="signature-target-select" class="form-select w-full bg-black/30 border-premium-border"></select></div></div><div class="flex-1 overflow-y-auto p-6"><div class="flex border-b border-premium-border mb-6"><button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('draw')"><i class="fas fa-pencil-alt mr-2"></i>Draw Signature</button><button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('upload')"><i class="fas fa-upload mr-2"></i>Upload Image</button><button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent" onclick="Logic.switchSignatureMode('seal')"><i class="fas fa-stamp mr-2"></i>Corporate Seal</button></div><div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48 bg-white rounded"></canvas><button onclick="Logic.clearSignaturePad()" class="mt-2 text-xs text-muted hover:text-white">Clear</button></div><div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-premium-border rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-black/10"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-cloud-upload-alt fa-3x text-muted mb-4"></i><p>Click to upload</p></div></label></div><div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-premium-border rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-black/10"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-certificate fa-3x text-muted mb-4"></i><p>Upload corporate seal</p></div></label></div></div><div class="bg-black/20 border-t border-premium-border p-6"><button onclick="Logic.applySignature()" class="w-full bg-gradient-to-r from-green-600 to-emerald-700 border-green-500 text-white font-bold py-4 rounded-lg"><i class="fas fa-check-double mr-2"></i>Apply to Document</button></div></div></div>`,
    renderFinalizationModal: () => `
        <div class="dialog-content-wrapper"><div class="flex flex-col text-white"><div class="p-6 border-b border-premium-border bg-gradient-to-r from-red-600/20 to-purple-700/20"><div class="flex items-center gap-4"><div class="w-16 h-16 bg-gradient-to-br from-red-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg"><i class="fas fa-gavel fa-2x"></i></div><div><h2 class="text-2xl font-bold bg-gradient-to-r from-red-300 to-purple-400 bg-clip-text text-transparent">Finalize & Lock Document</h2><p class="text-sm text-premium-text-secondary mt-1">This action is irreversible</p></div><button onclick="document.getElementById('finalization-modal').close()" class="ml-auto text-3xl text-premium-text-secondary hover:text-white">&times;</button></div></div><div class="flex-1 p-8"><div class="bg-red-500/10 border border-red-500/30 rounded-xl p-6 mb-8"><h3 class="text-xl font-bold text-red-400 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Critical Action Warning</h3><p class="text-premium-text-secondary">You are about to finalize this contract. This action is <strong class="text-red-400">irreversible</strong> and will create a legally binding agreement.</p></div><h4 class="text-lg font-bold mb-4">Finalization Process</h4><ul class="space-y-4">
        <li class="flex items-start gap-4"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Document State Lock</strong><p class="text-sm text-muted">The current version will be cryptographically sealed.</p></div></li>
        <li class="flex items-start gap-4"><i class="fas fa-fingerprint text-blue-400 mt-1"></i><div><strong>Generate Audit Trail</strong><p class="text-sm text-muted">An immutable record of all actions will be created.</p></div></li>
        <li class="flex items-start gap-4"><i class="fas fa-paper-plane text-green-400 mt-1"></i><div><strong>Dispatch to All Parties</strong><p class="text-sm text-muted">The finalized PDF will be sent to all signatories.</p></div></li>
        </ul></div><div class="bg-black/20 border-t border-premium-border p-6 flex gap-4"><button onclick="document.getElementById('finalization-modal').close()" class="flex-1 btn-secondary py-3">Cancel</button><button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="flex-1 btn-primary bg-gradient-to-r from-red-600 to-purple-600 border-red-500 font-bold py-3"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button></div></div></div>`,
    isMobilePreviewVisible: () => document.body.getAttribute('data-mobile-preview') === 'visible',
    toggleMobilePreview: () => {
        const isVisible = UI.isMobilePreviewVisible();
        document.body.setAttribute('data-mobile-preview', isVisible ? 'hidden' : 'visible');
    },
    scrollToSection: (sectionId) => {
        const element = document.getElementById(`${sectionId}-section`);
        if (element) element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    },
    returnToEditor: () => {
        const modal = document.getElementById('imfpa-modal'); if (!modal) return;
        modal.classList.remove('synthesis-complete');
        document.getElementById('synthesis-state').classList.remove('hidden');
        document.getElementById('execution-suite-footer').classList.add('hidden');
        UI.refreshImfpaModalUI();
    },
    renderContractPreviewPlaceholder: () => `<div id="contract-live-preview-placeholder" class="text-center py-16"><div class="max-w-md mx-auto"><div class="mb-6"><i class="fas fa-file-contract fa-4x text-premium-text-secondary/20"></i></div><h3 class="text-xl font-bold text-premium-text-primary mb-4">Document Preview Ready</h3><p class="text-premium-text-secondary leading-relaxed mb-6">Complete the required fields (*), then click <span class="text-premium-gold font-semibold">"Synthesize"</span> to generate your contract.</p></div></div>`,
};

// --- SECTION 5: INITIALIZATION ---
const initInteractiveBackground = () => {
    const vortex = document.getElementById('background-vortex');
    if (!vortex) return;
    let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
    let currentX = targetX, currentY = targetY;
    document.addEventListener('mousemove', (e) => { targetX = e.clientX; targetY = e.clientY; });
    const animate = () => { currentX += (targetX - currentX) * 0.05; currentY += (targetY - currentY) * 0.05; vortex.style.transform = `translate(-50%, -50%) translate3d(${currentX}px, ${currentY}px, 0)`; requestAnimationFrame(animate); };
    animate();
};

document.addEventListener('DOMContentLoaded', Logic.init);
    </script>
</body>
</html>
