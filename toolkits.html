html
<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECANâ„¢ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&family=Garamond:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v5.0 (UNIFIED & DEFINITIVE) === */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
            --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        body.mobile-sidebar-open { overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
        .logo-back { transform: rotateY(180deg); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
        @keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
        @keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }

        /* BENCHMARKED NAVIGATION & MOBILE MENU */
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }
        @keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }
        
        #mobile-sidebar.left-0 { transform: translateX(0); }
        .mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
        .mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
        @media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }

        /* --- D. TOOLKIT-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        .glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
        
        .form-input, .form-select { background-color: var(--background-light); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s ease; appearance: none; -webkit-text-fill-color: var(--text-primary); box-shadow: inset 0 0 0 30px var(--background-light); }
        .form-input::placeholder { color: var(--text-muted); opacity: 1; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-azure); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25), inset 0 0 0 30px var(--background-secondary); background-color: var(--background-secondary); }
        .form-input:read-only { background-color: var(--background-dark); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        
        .report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
        .report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(-2px); }
        .gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes float { 50% { transform: translateY(-8px); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .animate-scale-in { animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

        .risk-LOW { --risk-color: var(--success-color); } .risk-MEDIUM { --risk-color: var(--warning-color); }
        .risk-HIGH { --risk-color: var(--error-color); } .risk-CRITICAL { --risk-color: var(--critical-color); }
        .text-risk-color { color: var(--risk-color); } .border-risk-color { border-color: var(--risk-color); } .bg-risk-color { background-color: var(--risk-color); }
        .score-gauge-bg { stroke: var(--background-secondary); stroke-width: 2.5; }
        .score-gauge-fg { stroke-width: 3.5; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); transition: stroke-dasharray 1.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .gauge-low { color: var(--success-color); } .gauge-medium { color: var(--warning-color); }
        .gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 20px; border-left: 2px solid var(--border-color); }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--background-secondary); display: grid; place-items: center; }
        .timeline-dot-inner { width: 8px; height: 8px; border-radius: 50%; }

        .deal-type-card { background: var(--background-glass); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s ease; text-align: left; }
        .deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-azure); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
        .deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.05); }
        .deal-type-icon { transition: all 0.3s ease; } .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
        @keyframes icon-glow-rotate { 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }
        
        .output-metric-card { background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
        .output-metric-card .label { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .output-metric-card .value { font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .output-metric-card .sub-value { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
        .output-metric-card.base-value .value { color: var(--primary-azure); } .output-metric-card.net .value { color: var(--success-color); } .output-metric-card.commission .value { color: var(--warning-color); }
        
        /* --- E. MODAL & DIALOG STYLES (UNIFIED) --- */
        dialog { padding: 0 !important; border: none !important; background: transparent !important; overflow: visible !important; max-width: 90vw; width: auto; }
        dialog[open] { display: flex !important; align-items: center !important; justify-content: center !important; position: fixed !important; inset: 0 !important; animation: modal-backdrop-fade-in 0.5s ease forwards; z-index: 200 !important; }
        dialog::backdrop { background: rgba(5, 5, 9, 0.85) !important; backdrop-filter: blur(16px) !important; -webkit-backdrop-filter: blur(16px) !important; animation: modal-backdrop-fade-in 0.5s ease forwards; }
        .dialog-content-wrapper { background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important; border: 1px solid var(--border-premium) !important; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6) !important; border-radius: 1.5rem !important; width: 100%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        #imfpa-modal { max-width: 80vw !important; }
        #submission-modal { max-width: 640px !important; }
        #signature-modal { max-width: 560px !important; }
        #notification-modal { max-width: 512px !important; }
        #finalization-modal { max-width: 640px !important; }
        @keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- F. SUBMISSION SUITE STYLES (UNIFIED) --- */
        fieldset { border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; position: relative; margin-top: 1rem; }
        legend { padding: 0 0.5rem; margin-left: 0.5rem; font-size: 1.125rem; font-weight: 600; color: var(--primary-azure); position: relative; top: -0.5rem; display: inline-block; width: auto; background: var(--background-light); }
        #wallet-submission-form label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-platinum); }
        .recommendation-box { margin-top: 1rem; padding: 1rem; background-color: rgba(245, 158, 11, 0.05); border-left: 4px solid var(--warning-color); border-radius: 0 0.5rem 0.5rem 0; }
        .recommendation-box h4 { font-weight: 600; color: var(--warning-color); }
        .recommendation-box p { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .recommendation-box strong { color: var(--text-diamond); font-weight: 600; }
        
        /* --- G. DOCUMENT EXECUTION SUITE CSS (UNIFIED & DEFINITIVE) --- */
        .imfpa-header { padding-bottom: 1rem; border-bottom: 1px solid var(--border-premium); }
        .imfpa-header h2 { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Orbitron', monospace; }
        #contract-preview-container { animation: fadeInUp 0.5s ease-out; }
        #execution-suite { background: var(--background-glass); border: 1px solid var(--border-premium); border-radius: 1.5rem; padding: 1.5rem; margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
        #execution-suite .step-panel { background: rgba(var(--rgb-color, 59, 130, 246), 0.1); border: 1px solid rgba(var(--rgb-color, 59, 130, 246), 0.2); border-left: 4px solid rgb(var(--rgb-color, 59, 130, 246)); border-radius: 1rem; padding: 1.25rem; text-align: center; transition: all 0.3s ease; }
        #execution-suite .step-panel.step-1 { --rgb-color: 59, 130, 246; } /* Sapphire */
        #execution-suite .step-panel.step-2 { --rgb-color: 139, 92, 246; } /* Amethyst */
        .step-panel h4 { color: rgb(var(--rgb-color)); font-weight: 700; font-size: 1.125rem; }
        .step-panel p { color: var(--text-secondary); }
        .execution-btn { background: linear-gradient(135deg, rgb(var(--rgb-color)), rgba(var(--rgb-color), 0.7)); border: 1px solid rgb(var(--rgb-color)); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(var(--rgb-color), 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); padding: 0.75rem 1.5rem; font-weight: 700; border-radius: 0.75rem; }
        .execution-btn:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(var(--rgb-color), 0.4); transform: translateY(-3px); }
        #contract-document-wrapper { background: #f8fafc; border-radius: 1rem; padding: 1rem; margin-top: 1.5rem; max-height: 70vh; overflow-y: auto; box-shadow: inset 0 2px 10px rgba(0,0,0,0.1); }
        .contract-document { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.5; color: #1a202c; background: white; padding: 2cm; margin: 0 auto; max-width: 21cm; min-height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .signature-tab.active { border-color: var(--success-color); color: var(--text-diamond); }
        #signature-canvas { background: var(--background-dark); border: 1px dashed var(--border-premium); border-radius: 0.75rem; cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg>') 4 20, crosshair; }
        #finalization-icon-container { background: linear-gradient(135deg, var(--primary-amethyst), var(--primary-royal)); animation: pulse-glow 3s ease-in-out infinite; }
        @keyframes pulse-glow { 50% { transform: scale(1.05); box-shadow: 0 0 35px var(--glow-amethyst); } }

        /* --- H. PINNACLE PRINTING STYLES (UNIFIED) --- */
        #print-area { display: none; }
        @media print {
            .print-hide { display: none !important; }
            #print-area { display: block !important; }
            body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0 !important; padding: 0 !important; }
            @page {
                size: A4; margin: 2cm;
                @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
                @top-right { content: "GECANâ„¢ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
                @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
            }
            .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; }
            .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
            .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
            .p-text { text-align: justify; margin-bottom: 11pt; }
            .p-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
            .p-table th, .p-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
            .p-table th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
            .p-table tr:nth-child(even) td { background-color: #f9f9f9; }
            .p-signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; }
            .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
            .p-signature-label { font-size: 9pt; color: #555; }
            .p-signature-img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
            .p-seal-img { max-height: 80px; max-width: 80px; object-fit: contain; mix-blend-mode: darken; }
            .p-annex-start { page-break-before: always; }
            .p-watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECANâ„¢ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & CORRECTED) -->
    <header class="premium-header p-4 lg:px-6 print-hide">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECANâ„¢</div>
                        <div class="logo-face logo-back">
                            <img src="https://i.ibb.co/CKG6s7Y/GECAN-LOGO-GLDN-DRGN-TRANSPARENT-WHITE-BG-1-1.png" alt="GECAN Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                        <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                    </div>
                </a>
            </div>
            <div id="desktop-nav-placeholder" class="flex-grow"></div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    <!-- MODAL & DIALOG CONTAINERS (CORRECTED & FINAL) -->
<!-- ==================================================================================== -->
<!-- === PINNACLE MODAL & DIALOG SUITE (v5.1 - UNABRIDGED & FULLY EXPANDED) === -->
<!-- This block contains the definitive, fully-structured HTML for ALL modals. -->
<!-- ==================================================================================== -->

<!-- 1. IMFPA & COMMISSION MANAGER MODAL (DYNAMIC CONTENT INJECTOR) -->
<!-- NOTE: This container is intentionally left sparse. Its complex content is dynamically generated by JavaScript to ensure data integrity. -->
<dialog id="imfpa-modal" class="p-0 bg-transparent print-hide"></dialog>

<!-- 2. SIGNATURE EXECUTION SUITE MODAL (STATIC SHELL) -->
<dialog id="signature-modal" class="p-0 bg-transparent print-hide">
    <div class="dialog-content-wrapper">
        <div id="signature-modal-content" class="text-white flex-grow flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-[var(--border-premium)] flex-shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                        <p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p>
                    </div>
                    <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">Ã—</button>
                </div>
                <div>
                    <label for="signature-target-select" class="block text-sm font-semibold text-text-secondary mb-2">Apply signature/seal for:</label>
                    <select id="signature-target-select" class="form-select w-full"></select>
                </div>
            </div>

            <!-- Signing Area -->
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex border-b border-[var(--border-premium)] mb-4">
                    <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                    <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                    <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
                </div>
                <!-- Panels -->
                <div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
                <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div>
                <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex-shrink-0">
                <div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div>
                <button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button>
            </div>
        </div>
    </div>
</dialog>

<!-- 3. UNIVERSAL NOTIFICATION MODAL (STATIC SHELL) -->
<dialog id="notification-modal" class="p-0 bg-transparent print-hide">
    <div class="dialog-content-wrapper">
        <div id="notification-modal-content" class="text-white flex flex-col">
            <!-- Dynamic Header -->
            <div id="notification-header" class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)]">
                <div id="notification-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400">
                    <i id="notification-icon" class="fas fa-2x"></i>
                </div>
                <div>
                    <h2 id="notification-title" class="text-2xl font-bold">Notification</h2>
                    <p id="notification-subtitle" class="text-sm text-text-secondary">Please review this message.</p>
                </div>
            </div>
            <!-- Dynamic Content -->
            <div class="p-8 flex-grow">
                <p id="notification-message" class="text-text-secondary leading-relaxed">Message content goes here.</p>
            </div>
            <!-- Footer & Action -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end">
                <button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg">OK</button>
            </div>
        </div>
    </div>
</dialog>

<!-- 4. FINALIZATION & DISPATCH MODAL (STATIC SHELL) -->
<dialog id="finalization-modal" class="p-0 bg-transparent print-hide">
    <div class="dialog-content-wrapper">
        <div id="finalization-modal-content" class="flex flex-col text-white">
             <!-- Header -->
            <div class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)] bg-[var(--background-dark)]/50">
                <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Finalize & Lock Document</h2>
                    <p class="text-sm text-text-secondary">Please confirm this critical, irreversible action.</p>
                </div>
                 <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors ml-auto">Ã—</button>
            </div>
            <!-- Content -->
            <div class="p-8 flex-grow">
                <p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action will:</p>
                <ul class="space-y-4 text-text-primary">
                    <li class="flex items-start gap-3"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Lock Document State:</strong> The current version will be cryptographically fingerprinted to prevent edits.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-project-diagram text-purple-400 mt-1"></i><div><strong>Generate Secure Audit Trail:</strong> An immutable record will be created for all actions.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-paper-plane text-purple-400 mt-1"></i><div><strong>Dispatch to All Parties:</strong> A finalized PDF will be emailed to all signatories.</div></li>
                </ul>
            </div>
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end items-center gap-4">
                <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-red-500/30 px-8 py-2 font-bold shadow-lg shadow-purple-500/20"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button>
            </div>
        </div>
    </div>
</dialog>

<!-- 5. WALLET SUBMISSION MODAL (DYNAMIC CONTENT INJECTOR) -->
<!-- NOTE: This container is also intentionally left empty, as its content is dynamically generated by the Wallet Forensics workflow. -->
<dialog id="submission-modal" class="p-0 bg-transparent print-hide"></dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
    <div id="print-area"></div>
    
    <!-- PREMIUM FOOTER (BENCHMARKED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECANâ„¢</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">Â© 2025 GECANâ„¢. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECANâ„¢ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECANâ„¢ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ====================================================================================
        // === PINNACLE SCRIPT ENGINE v5.0 (UNIFIED, CORRECTED, & UNABRIDGED) ===
        // ====================================================================================
        
        const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";
        
        // --- SECTION 1: STATE & MODELS ---
        const AppState = {
            isInitialized: false, 
            activeToolkit: 'Dashboard', 
            marketData: [],
            toolkits: {
                Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECANâ„¢ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
                WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Execute advanced on-chain due diligence, risk assessment, and provenance analysis.', color: 'from-sky-500 to-indigo-600' },
                InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
            },
            walletAnalysis: { address: null, report: null, isLoading: false },
            modeler: {
                activeDealType: 'AssetSwap', 
                assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
                commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' },
                cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                sblcMonetization: { faceValue: 100000000, ltv: 80 },
                pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                legal: { totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }
            }
        };

        const commodityData = {
            unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
            incoterms: [
                { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' }, { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
                { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' }, { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
                { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
                { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
            ],
            countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
            ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
        };

        // --- SECTION 2: UTILITIES ---
        const Utils = {
            showNotification: (message, type = 'info', title = null) => {
                const modal = document.getElementById('notification-modal');
                if (!modal) {
                    console.error("Notification modal not found in DOM!");
                    alert(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
                    return;
                }
                modal.innerHTML = UI.renderNotificationModal(message, type, title);
                modal.showModal();
                const okBtn = modal.querySelector('#notification-ok-btn');
                if(okBtn) okBtn.onclick = () => modal.close();
            },
            formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
            formatNumber: (num, decimals = 2) => {
                if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
                if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
                return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            },
            debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
            getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
            getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
            getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
            calculateTimeAgo: (timestamp) => {
                const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Just now'; if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`;
                return new Date(timestamp).toLocaleDateString();
            }
        };

        // --- SECTION 3: CORE LOGIC CONTROLLER ---
        const Logic = {
            createApiRequest: async (action, method = 'GET', params = {}) => {
                const url = new URL(API_URL); url.searchParams.append('action', action);
                const options = { method: method.toUpperCase(), redirect: 'follow' };
                if (options.method === 'GET') { Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v)); } 
                else { options.body = JSON.stringify({ action, data: params }); options.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                    const result = await response.json();
                    if (result.success === false) throw new Error(result.error || 'Server error.');
                    return result.data || result.message || result;
                } catch (error) { console.error(`API Error for '${action}':`, error); throw error; }
            },
            init: async () => {
                UI.init();
                UI.populateNavLinks(); 
                Logic.initMobileUI();
                Logic.setupEventListeners();
                try {
                    const [marketData, themeJson] = await Promise.all([
                        Logic.createApiRequest('getMarketMatrixData'),
                        Logic.createApiRequest('getActiveThemeConfig').catch(() => null)
                    ]);
                    if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) { console.warn("Failed to parse theme JSON.")} }
                    if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
                    AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
                    const swappable = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
                    if (swappable.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = swappable[0].key; AppState.modeler.assetSwap.toAssetKey = swappable[1].key; }
                    
                    AppState.isInitialized = true;
                    document.getElementById('initial-loader').style.display = 'none';
                    UI.renderActiveToolkit();
                } catch (err) { Logic.onDataError(err); }
            },
            onDataError: (error) => {
                console.error("CRITICAL FAILURE:", error);
                Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
                document.getElementById('initial-loader').innerHTML = `<div class="text-center text-red-400">Platform Initialization Failed.</div>`;
            },
            initMobileUI: () => {
                const fab = document.getElementById('mobile-fab'), sidebar = document.getElementById('mobile-sidebar'), overlay = document.getElementById('mobile-sidebar-overlay'), closeBtn = document.getElementById('mobile-sidebar-close-btn');
                const openSidebar = () => { UI.populateNavLinks(); sidebar.classList.remove('-left-full'); sidebar.classList.add('left-0'); overlay.classList.remove('hidden'); document.body.classList.add('mobile-sidebar-open'); };
                const closeSidebar = () => { sidebar.classList.add('-left-full'); sidebar.classList.remove('left-0'); overlay.classList.add('hidden'); document.body.classList.remove('mobile-sidebar-open'); };
                fab.addEventListener('click', openSidebar); overlay.addEventListener('click', closeSidebar); closeBtn.addEventListener('click', closeSidebar);
            },
            setupEventListeners: () => {
                document.addEventListener('keydown', (e) => { if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'WalletForensics','3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } } });
            },
            setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
            bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
            
            // --- Wallet Forensics Logic (Unabridged & Corrected) ---
            bindWalletForensicsEvents: () => {
                const checkBtn = document.getElementById('check-wallet-btn');
                const addressInput = document.getElementById('wallet-address-input');
                if(checkBtn) checkBtn.addEventListener('click', Logic.runWalletForensics);
                if(addressInput) addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); Logic.runWalletForensics(); } });
            },
            runWalletForensics: () => {
                const address = document.getElementById('wallet-address-input')?.value.trim();
                if (!address) return Utils.showNotification("Please enter a wallet address to analyze.", 'warning', 'Input Required');
                AppState.walletAnalysis = { address, report: null, isLoading: true };
                UI.renderActiveToolkit();
                const spinnerTexts = ["Connecting to blockchain networks...","Fetching on-chain transaction history...","Querying GECAN proprietary intelligence ledger...","Running institutional compliance checks...","Synthesizing on-chain and proprietary intel...","Calculating multi-vector risk scores...","Generating definitive wallet classification..."];
                let textIndex = 0;
                const textInterval = setInterval(() => {
                    const spinnerEl = document.getElementById('spinner-text');
                    if (spinnerEl && AppState.walletAnalysis.isLoading) {
                        spinnerEl.style.opacity = '0';
                        setTimeout(() => { spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; spinnerEl.style.opacity = '1'; }, 300);
                    } else { clearInterval(textInterval); }
                }, 2500);
                Logic.createApiRequest('getWalletForensicsReport', 'GET', { address })
                    .then(report => { AppState.walletAnalysis.report = report; })
                    .catch(err => { AppState.walletAnalysis.report = { success: false, error: { message: err.message || 'An unknown analysis error occurred.' } }; })
                    .finally(() => {
                        AppState.walletAnalysis.isLoading = false;
                        clearInterval(textInterval);
                        UI.renderActiveToolkit();
                        if (AppState.walletAnalysis.report?.success) Logic.animateReportElements();
                    });
            },
            animateReportElements: () => {
                setTimeout(() => { document.querySelectorAll('.score-gauge-fg').forEach(gauge => { if (gauge.dataset.score) gauge.style.strokeDasharray = `${gauge.dataset.score}, 100`; }); }, 200);
            },
            getExplorerUrl: (wallet, txHash = '') => {
                if (!wallet || !wallet.type) return '#';
                const explorers = { BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' }, ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' }, TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' } };
                const explorer = explorers[wallet.type.toUpperCase()];
                if (!explorer) return '#';
                return txHash ? explorer.tx + txHash : explorer.addr + wallet.address;
            },
            copyToClipboard: (text, element) => {
                navigator.clipboard.writeText(text).then(() => { const feedback = element.querySelector('.copied-feedback'); if (feedback) { feedback.style.opacity = '1'; setTimeout(() => { feedback.style.opacity = '0'; }, 1500); } }).catch(err => Utils.showNotification('Could not copy to clipboard.', 'error'));
            },
            generateExecutiveSummary: (report) => {
                if (!report?.analysis?.wallet) return '<p class="text-error-color">Incomplete report data.</p>';
                const { analysis, wallet, provenance } = report;
                let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="${Utils.getRiskClass(analysis.riskLevel)} text-risk-color">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `;
                const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN' && c.toUpperCase() !== 'CONFIDENTIAL'))];
                if (provenance.records?.length > 0) {
                    summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `;
                    if (uniqueControllers.length > 1) summary += `<strong class="text-critical-color">Critically, it has ${uniqueControllers.length} conflicting alleged controllers.</strong> `;
                    else if (uniqueControllers.length === 1) summary += `A single controller, <strong>${uniqueControllers[0]}</strong>, is consistently reported. `;
                } else { summary += `There is <strong class="text-error-color">no provenance history</strong> in the GECAN Ledger. `; }
                if (analysis.redFlags?.length > 0) {
                    const criticalFlagsCount = analysis.redFlags.filter(f => f.level === 'CRITICAL').length;
                    summary += `The analysis identified <strong class="${criticalFlagsCount > 0 ? 'text-critical-color' : 'text-warning-color'}">${criticalFlagsCount > 0 ? criticalFlagsCount + ' CRITICAL' : analysis.redFlags.length} flag(s)</strong>. `;
                } else { summary += `<strong class="text-success-color">No major compliance flags</strong> were detected. `; }
                summary += `Final recommendation is to proceed with ${analysis.riskLevel === 'LOW' ? 'standard due diligence' : '<strong>enhanced caution and verification</strong>'}.`;
                return summary;
            },
            generateAndDownloadForensicsPDF: () => {
                const btn = document.getElementById('pdf-export-btn');
                if (!btn || btn.disabled) return;
                const originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating...`;
                const reportData = AppState.walletAnalysis.report;
                if (!reportData?.success) { Utils.showNotification('Error: No valid report data to generate PDF.', 'error'); btn.disabled = false; btn.innerHTML = originalContent; return; }
                Logic.createApiRequest('generateWalletForensicsPdf', 'POST', { report: reportData }).then(Logic.downloadPdf).catch(error => Utils.showNotification(error.message || 'PDF generation failed.', 'error')).finally(() => { btn.disabled = false; btn.innerHTML = originalContent; });
            },
            downloadPdf: (response) => {
                if (!response?.pdfData) throw new Error('Failed to receive valid PDF data from server.');
                const link = document.createElement('a');
                link.href = `data:application/pdf;base64,${response.pdfData}`;
                link.download = response.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                Utils.showNotification('Report downloaded successfully!', 'success');
            },
            initiateWalletSubmission: () => {
                const modal = document.getElementById('submission-modal');
                if (!modal) { console.error("CRITICAL FAILURE: #submission-modal missing."); return Utils.showNotification("UI Error: Cannot open submission suite.", "error"); }
                modal.innerHTML = UI.renderReferralValidationSuite('Secure Submission Protocol', 'A valid Partner Referral ID is required to submit this wallet to the GECAN ledger for official review.');
                modal.showModal();
                document.getElementById('validate-referral-btn').addEventListener('click', Logic.validateSubmissionReferralId);
            },
            validateSubmissionReferralId: () => {
                const btn = document.getElementById('validate-referral-btn'), input = document.getElementById('referral-id-input'), errorDiv = document.getElementById('referral-error');
                if (!btn || !input || !errorDiv) return;
                const referralId = input.value.trim();
                if (!referralId) { errorDiv.textContent = 'Referral ID cannot be empty.'; errorDiv.classList.remove('hidden'); return; }
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';
                Logic.createApiRequest('validateReferralId', 'POST', { referralId })
                    .then(validationResult => {
                        if (validationResult.isValid) {
                            Utils.showNotification('Referral ID Validated Successfully!', 'success');
                            document.getElementById('submission-modal').innerHTML = UI.renderWalletSubmissionSuite(validationResult);
                            Logic.populateOfferIdDropdown();
                            document.getElementById('wallet-submission-form').addEventListener('submit', e => { e.preventDefault(); Logic.submitWalletForReview(validationResult); });
                        } else { throw new Error('Invalid or inactive Referral ID.'); }
                    })
                    .catch(error => { errorDiv.textContent = error.message; errorDiv.classList.remove('hidden'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-key mr-2"></i>Validate & Proceed'; });
            },
            populateOfferIdDropdown: async () => {
                const select = document.getElementById('submission-offer-id');
                if (!select) return;
                try {
                    const offers = await Logic.createApiRequest('getOfferListForNcnda', 'GET');
                    select.innerHTML = '<option value="GENERAL">General Submission (Not for a specific offer)</option>' + offers.map(offer => `<option value="${offer.offerId}">${offer.offerId} - ${offer.description}</option>`).join('');
                } catch (error) { console.error("Failed to fetch offer list:", error); select.innerHTML = '<option value="">Error loading offers</option>'; }
            },
            submitWalletForReview: (referralInfo) => {
                const submitBtn = document.getElementById('confirm-submission-btn');
                if (!submitBtn) return;
                submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
                const submissionData = { report: AppState.walletAnalysis.report, referralInfo: referralInfo, targetOfferId: document.getElementById('submission-offer-id').value, submitter: { name: document.getElementById('submitter-name').value, role: document.getElementById('submitter-role').value, email: document.getElementById('submitter-email').value, phone: document.getElementById('submitter-phone').value, }, controller: { name: document.getElementById('controller-name').value, } };
                Logic.createApiRequest('submitWalletForReview', 'POST', submissionData)
                    .then(successMessage => { Utils.showNotification(successMessage, 'success', 'Submission Sent'); document.getElementById('submission-modal').close(); })
                    .catch(error => { Utils.showNotification(error.message, 'error', 'Submission Failed'); })
                    .finally(() => { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm & Submit'; });
            },
            
            // --- Institutional Modeler Logic (Unabridged & Corrected) ---
            bindInstitutionalModelerEvents: () => {
                Logic.updateModelerUI(true);
                const inputContainer = document.getElementById('modeler-input-container');
                if (inputContainer) {
                    inputContainer.addEventListener('input', Utils.debounce(e => { if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e); }, 250));
                    inputContainer.addEventListener('change', e => { if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e); });
                }
            },
            handleDealTypeChange: (newDealType) => { if (AppState.modeler.activeDealType === newDealType) return; AppState.modeler.activeDealType = newDealType; UI.renderActiveToolkit(); },
            handleModelerInputChange: (e) => {
                const { dataset, value, type, checked } = e.target;
                const path = dataset.path; if (!path) return;
                if (path === 'commodityTrade.assetKey') { Logic.handleCommodityChange(value); return; }
                try {
                    const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean);
                    let targetObject = AppState.modeler;
                    for (let i = 0; i < pathKeys.length - 1; i++) { targetObject = targetObject[pathKeys[i]]; }
                    const finalKey = pathKeys[pathKeys.length - 1];
                    let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
                    targetObject[finalKey] = processedValue;
                    Logic.updateModelerUI(false);
                } catch (error) { console.error(`Failed to update state for path: ${path}`, error); }
            },
            handleCommodityChange: (assetKey) => {
                const commodityState = AppState.modeler.commodityTrade;
                commodityState.assetKey = assetKey;
                const spec = commodityData.specifications?.[assetKey];
                if (spec) { Object.assign(commodityState, { unitOfMeasure: spec.uom, qualitySpec: spec.spec, incoterms: spec.incoterm, origin: spec.origin }); }
                Logic.updateModelerUI(true);
            },
            updateModelerUI: (isFullRefresh = false) => {
                if (isFullRefresh) {
                    const inputContainer = document.getElementById('modeler-input-container');
                    if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
                }
                const calculation = Logic.calculateModel();
                const outputContainer = document.getElementById('modeler-output-container');
                if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
            },
            calculateModel: () => {
                const { activeDealType, pricingConfig } = AppState.modeler;
                const calculationFunc = Logic[`calculate${activeDealType}`];
                if (!calculationFunc) return null;
                const dealCalc = calculationFunc();
                if (!dealCalc) return null;
                const { baseValueUSD } = dealCalc;
                const grossValue = parseFloat(pricingConfig.grossValue) || 0;
                const netValue = parseFloat(pricingConfig.netValue) || 0;
                const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (grossValue / 100) : grossValue;
                const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (netValue / 100) : netValue;
                let finalValueToBuyerUSD, totalCommissionPool;
                if(pricingConfig.offerType === 'discount') { finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; } 
                else { finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; }
                totalCommissionPool = Math.max(0, totalCommissionPool);
                AppState.modeler.legal.totalCommission = totalCommissionPool;
                return { ...dealCalc, baseValueUSD, finalValueToBuyerUSD, totalCommissionPool, netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`, grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}` };
            },
            calculateAssetSwap: () => {
                const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
                const fromAsset = Utils.getAssetByKey(fromAssetKey); const toAsset = Utils.getAssetByKey(toAssetKey);
                const baseValueUSD = (parseFloat(amount) || 0) * (fromAsset.price || 0);
                const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0;
                return { baseValueUSD, fromAsset, toAsset, rate, dealTitle: `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset}` };
            },
            calculateCommodityTrade: () => {
                const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey, discountPremiumIsInPercent } = AppState.modeler.commodityTrade;
                const asset = Utils.getAssetByKey(assetKey); const settlementAsset = Utils.getAssetByKey(settlementAssetKey);
                let effectivePricePerUnit = asset.price || 0, priceDerivation = 'Market Price';
                const discPremVal = parseFloat(discountPremiumValue) || 0;
                if (pricingModel === 'Fixed') { effectivePricePerUnit = parseFloat(fixedPrice) || 0; priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`; }
                else if (pricingModel === 'Premium') { const premiumAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit += premiumAmount; priceDerivation = `Market + ${Utils.formatPrice(premiumAmount)}`; }
                else if (pricingModel === 'Discount') { const discountAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit -= discountAmount; priceDerivation = `Market - ${Utils.formatPrice(discountAmount)}`; }
                const baseValueUSD = (parseFloat(quantity) || 0) * effectivePricePerUnit;
                let settlementAmount = baseValueUSD / (settlementAsset.price || 1);
                return { baseValueUSD, dealTitle: `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`, priceDerivation, effectivePricePerUnit, settlementAmount, settlementAsset };
            },
            calculateCryptoLoan: () => {
                const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
                const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
                const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0);
                const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100);
                const totalInterest = loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12);
                const totalRepayment = loanPrincipal + totalInterest;
                return { baseValueUSD: loanPrincipal, loanPrincipal, totalRepayment, loanCurrency, tenureMonths, interestRateValue, dealTitle: `Loan against ${collateralAsset.baseAsset}` };
            },
            calculateSBLCMonetization: () => {
                const { faceValue, ltv } = AppState.modeler.sblcMonetization;
                const baseValueUSD = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
                return { baseValueUSD, dealTitle: `LTV on ${Utils.formatPrice(faceValue)} SBLC` };
            },
            resetModelerState: () => {
                const defaultState = { activeDealType: 'AssetSwap', assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' }, commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' }, cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 }, sblcMonetization: { faceValue: 100000000, ltv: 80 }, pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true }, legal: { totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] } };
                AppState.modeler = JSON.parse(JSON.stringify(defaultState));
                const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
                if (allSwappableAssets.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key; AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key; }
                Logic.updateModelerUI(true);
                Utils.showNotification('Institutional Modeler has been reset.', 'info', 'Modeler Reset');
            },
            swapAssets: () => {
                const swapState = AppState.modeler.assetSwap;
                const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey); const toAsset = Utils.getAssetByKey(swapState.toAssetKey);
                if (fromAsset.price > 0 && toAsset.price > 0) { const totalUsdValue = (parseFloat(swapState.amount) || 0) * fromAsset.price; swapState.amount = totalUsdValue / toAsset.price; }
                [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
                const icon = document.getElementById('swap-icon'); if (icon) { icon.style.animation = 'none'; void icon.offsetWidth; icon.style.animation = 'swap-icon-spin 0.5s ease-in-out'; }
                Logic.updateModelerUI(true);
            },
            togglePricingConfig: () => { AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible; Logic.updateModelerUI(true); },
            
            // --- IMFPA & Document Execution Suite (v5.1 - Pinnacle Unabridged & Corrected) ---
            openImfpaModal: () => {
                const modal = document.getElementById('imfpa-modal');
                if (!modal) return console.error("CRITICAL: IMFPA modal container not found.");
                modal.innerHTML = UI.renderImfpaModal();
                Logic.refreshImfpaModalUI();
                modal.showModal();
            },
            refreshImfpaModalUI: () => {
                const { legal } = AppState.modeler;
                const groupsContainer = document.getElementById('imfpa-groups-container');
                const legalPartiesContainer = document.getElementById('imfpa-legal-parties');
                if (groupsContainer) groupsContainer.innerHTML = UI.renderImfpaGroups();
                if (legalPartiesContainer) {
                    const allParties = legal.groups.flatMap(g => g.parties);
                    legalPartiesContainer.innerHTML = allParties.length > 0 ? allParties.map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') : '<p class="text-xs text-text-muted">No signatory parties defined.</p>';
                }
                const modalContent = document.getElementById('imfpa-modal');
                if (modalContent) {
                    modalContent.removeEventListener('input', Logic.handleModelerInputChangeInModal);
                    modalContent.removeEventListener('change', Logic.handleModelerInputChangeInModal);
                    modalContent.addEventListener('input', Logic.handleModelerInputChangeInModal);
                    modalContent.addEventListener('change', Logic.handleModelerInputChangeInModal);
                }
                Logic.updateImfpaCalculations();
            },
            handleModelerInputChangeInModal: (e) => {
                Logic.handleModelerInputChange(e);
                Logic.updateImfpaCalculations();
            },
            updateImfpaCalculations: () => {
                const { groups, totalCommission } = AppState.modeler.legal;
                const totalPoolEl = document.getElementById('imfpa-total-commission-pool');
                if (totalPoolEl) totalPoolEl.textContent = Utils.formatPrice(totalCommission);
                
                const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
                if (totalAllocatedEl) {
                    totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
                    const isBalanced = Math.abs(totalGroupPct - 100) < 0.01;
                    totalAllocatedEl.className = `text-right font-mono text-sm ${isBalanced ? 'text-success-color' : 'text-error-color'}`;
                }
                groups.forEach((g, groupIndex) => {
                    const groupValue = totalCommission * ((parseFloat(g.percentage) || 0) / 100);
                    const groupValueEl = document.getElementById(`imfpa-group-value-${groupIndex}`);
                    if(groupValueEl) groupValueEl.textContent = Utils.formatPrice(groupValue);
                    const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
                    if (groupTotalEl) {
                        groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
                        const isGroupBalanced = Math.abs(totalPartyPct - 100) < 0.01;
                        groupTotalEl.className = `text-right font-mono text-xs ${isGroupBalanced ? 'text-success-color' : 'text-error-color'}`;
                    }
                });
            },
            addImfpaGroup: () => { AppState.modeler.legal.groups.push({ name: `Group ${AppState.modeler.legal.groups.length + 1}`, percentage: 0, parties: [] }); Logic.refreshImfpaModalUI(); },
            removeImfpaGroup: (groupIndex) => { AppState.modeler.legal.groups.splice(groupIndex, 1); Logic.refreshImfpaModalUI(); },
            addImfpaParty: (groupIndex) => { if (!AppState.modeler.legal.groups[groupIndex]) return; AppState.modeler.legal.groups[groupIndex].parties.push({ legalName: `New Party`, role: 'Intermediary', percentage: 0, detailsVisible: true, email: '', contactNumber: '', passport: { number: '', issueDate: '', expiryDate: '', authority: '' }, payment: { method: 'Bank Wire', currency: 'USD', details: '' } }); Logic.refreshImfpaModalUI(); },
            removeImfpaParty: (groupIndex, partyIndex) => { if (AppState.modeler.legal.groups[groupIndex]?.parties[partyIndex]) { AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1); Logic.refreshImfpaModalUI(); } },
            togglePartyDetails: (groupIndex, partyIndex) => { const party = AppState.modeler.legal.groups?.[groupIndex]?.parties?.[partyIndex]; if (party) { party.detailsVisible = !party.detailsVisible; Logic.refreshImfpaModalUI(); } },
            generateContract: () => {
                const { legal } = AppState.modeler;
                const calc = Logic.calculateModel();
                if (!calc) return Utils.showNotification("Define core deal parameters first.", 'error', 'Prerequisite Error');
                
                // --- SEVERE VALIDATION ENGINE ---
                const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                if (Math.abs(totalGroupPct - 100) > 0.01) return Utils.showNotification("Total group allocation must equal exactly 100%.", 'error', 'Allocation Error');
                for (const group of legal.groups) {
                    const totalPartyPct = group.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    if (Math.abs(totalPartyPct - 100) > 0.01) return Utils.showNotification(`Party allocation within "${group.name}" must equal exactly 100%.`, 'error', 'Allocation Error');
                }
                const allParties = legal.groups.flatMap(g => g.parties);
                if (allParties.length < 2) return Utils.showNotification("At least two signatory parties are required.", 'error', 'Party Error');
                if (allParties.some(p => !p.legalName || !p.role || !p.email)) return Utils.showNotification("All parties must have a Legal Name, Role, and Email defined.", 'error', 'Data Incomplete');
                
                const agreementReference = `GECAN-IMFPA-${new Date().getTime()}`;
                document.documentElement.style.setProperty('--agreement-reference', `"${agreementReference}"`);
                const contractHTML = UI.renderContractDocument(agreementReference);

                const previewContainer = document.getElementById('contract-preview-container');
                const printContainer = document.getElementById('print-area');
                if (previewContainer && printContainer) {
                    previewContainer.innerHTML = UI.renderExecutionSuite(contractHTML);
                    printContainer.innerHTML = contractHTML; // Stage for printing
                    previewContainer.classList.remove('hidden');
                    previewContainer.scrollIntoView({ behavior: 'smooth' });
                    Utils.showNotification("Contract synthesized successfully. Ready for signing.", 'success');
                }
            },

            // 2. ADD this missing function inside your `Logic` object, after `generatePremiumEmailTemplate`.
            getPrintStyles: () => {
                let printCss = '';
                // Iterate through all stylesheets loaded on the page
                for (const sheet of document.styleSheets) {
                    try {
                        // Iterate through all rules in a stylesheet
                        for (const rule of sheet.cssRules) {
                            // Check if the rule is an @media rule and if it's for 'print'
                            if (rule.type === CSSRule.MEDIA_RULE && rule.media.mediaText === 'print') {
                                // If it matches, iterate through the rules *inside* the @media block
                                for (const printRule of rule.cssRules) {
                                    // Append the text content of each rule to our string
                                    printCss += printRule.cssText + '\n';
                                }
                            }
                        }
                    } catch (e) {
                        // Catch and log potential security errors when accessing cross-origin stylesheets
                        console.warn("Could not access stylesheet for print styles:", sheet.href, e);
                    }
                }
                return printCss;
            },
            
            initiateSigningProcess: () => {
                const modal = document.getElementById('signature-modal');
                if(!modal) return;
                modal.innerHTML = UI.renderSignatureModal();
                const sigBlocks = document.querySelectorAll('#contract-document-wrapper .p-signature-block');
                const selectEl = document.getElementById('signature-target-select');
                if (!selectEl) return;
                selectEl.innerHTML = '<option value="">-- Select a Signatory --</option>';
                sigBlocks.forEach(block => { selectEl.add(new Option(block.dataset.partyName, block.dataset.partyId)); });
                modal.showModal();
                Logic.switchSignatureMode('draw');
                document.getElementById('signature-timestamp').textContent = new Date().toISOString();
                document.getElementById('signature-location').textContent = 'Fetching...';
                fetch('https://ipapi.co/json/').then(res => res.json()).then(data => { document.getElementById('signature-location').textContent = `${data.city}, ${data.country_name} (IP: ${data.ip})`; }).catch(() => { document.getElementById('signature-location').textContent = 'Location Unavailable'; });
            },
            switchSignatureMode: (mode) => {
                const panels = { draw: 'draw-mode-panel', upload: 'upload-mode-panel', seal: 'seal-mode-panel' };
                const tabs = { draw: 'draw-tab-btn', upload: 'upload-tab-btn', seal: 'seal-tab-btn' };
                Object.values(panels).forEach(id => document.getElementById(id)?.classList.add('hidden'));
                Object.values(tabs).forEach(id => document.getElementById(id)?.classList.remove('active'));
                document.getElementById(panels[mode])?.classList.remove('hidden');
                document.getElementById(tabs[mode])?.classList.add('active');
                document.getElementById('signature-modal').dataset.activeMode = mode;
                if (mode === 'draw') Logic.setupSignaturePad();
                else Logic.setupFileUpload(mode);
            },
            setupSignaturePad: () => {
                const canvas = document.getElementById('signature-canvas');
                if (!canvas) return;
                const resizeCanvas = () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    window.signaturePad?.clear();
                };
                if (!window.signaturePad) window.signaturePad = new SignaturePad(canvas, { penColor: "#1A237E" });
                setTimeout(resizeCanvas, 50);
            },
            clearSignaturePad: () => window.signaturePad?.clear(),
            setupFileUpload: (type) => {
                const inputId = type === 'upload' ? 'signature-upload-input' : 'seal-upload-input';
                const previewId = type === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview';
                const promptId = type === 'upload' ? 'upload-prompt' : 'seal-prompt';
                const input = document.getElementById(inputId), preview = document.getElementById(previewId), prompt = document.getElementById(promptId);
                if (!input || !preview || !prompt) return;
                input.onchange = e => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { preview.src = event.target.result; preview.classList.remove('hidden'); prompt.classList.add('hidden'); }; reader.readAsDataURL(e.target.files[0]); } };
            },
            processImageForTransparency: (imageDataUrl, threshold = 240) => {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'), img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
                        try {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height), data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) { if (data[i] > threshold && data[i + 1] > threshold && data[i + 2] > threshold) data[i + 3] = 0; }
                            ctx.putImageData(imageData, 0, 0); resolve(canvas.toDataURL('image/png'));
                        } catch (e) { reject(new Error("Cannot process image due to security restrictions.")); }
                    };
                    img.onerror = () => reject(new Error("Failed to load image."));
                    img.src = imageDataUrl;
                });
            },
            applySignature: async () => {
                const modal = document.getElementById('signature-modal');
                const mode = modal.dataset.activeMode;
                const targetPartyId = document.getElementById('signature-target-select').value;
                if (!targetPartyId) return Utils.showNotification("Please select a signatory.", 'error');
                let dataUrl = '';
                try {
                    if (mode === 'draw') { if (window.signaturePad.isEmpty()) throw new Error("Please draw a signature."); dataUrl = window.signaturePad.toDataURL('image/png'); } 
                    else { const previewId = mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview'; const previewImg = document.getElementById(previewId); if (!previewImg.src || previewImg.classList.contains('hidden')) throw new Error(`Please upload a ${mode}.`); dataUrl = await Logic.processImageForTransparency(previewImg.src); }
                    
                    const dateOfExecution = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    ['#contract-document-wrapper', '#print-area'].forEach(containerSelector => {
                        const container = document.querySelector(containerSelector);
                        if (!container) return;
                        const targetBlock = container.querySelector(`.p-signature-block[data-party-id="${targetPartyId}"]`);
                        if (!targetBlock) return;
                        if (mode === 'draw' || mode === 'upload') {
                            targetBlock.querySelector('[data-sig-type="signature"]').innerHTML = `<img src="${dataUrl}" class="p-signature-img" alt="Digital Signature">`;
                            targetBlock.querySelector('[data-sig-type="date"]').innerHTML = `<span class="font-mono">${dateOfExecution}</span>`;
                        } else if (mode === 'seal') {
                            targetBlock.querySelector('[data-sig-type="seal"]').innerHTML = `<img src="${dataUrl}" class="p-seal-img" alt="Corporate Seal">`;
                        }
                    });
                    modal.close(); Logic.resetSignatureInputs();
                    document.querySelector('#finalization-step-panel')?.classList.remove('opacity-50', 'pointer-events-none');
                    Utils.showNotification("Signature/seal applied successfully.", 'success');
                } catch (error) { Utils.showNotification(error.message, 'error', 'Application Failed'); }
            },
            resetSignatureInputs: () => {
                window.signaturePad?.clear();
                ['signature-upload', 'seal-upload'].forEach(id => {
                    const input = document.getElementById(`${id}-input`), preview = document.getElementById(`${id}-preview`), promptEl = document.getElementById(id.replace('upload', 'prompt'));
                    if(input) input.value = ''; if(preview) { preview.src = ''; preview.classList.add('hidden'); } if(promptEl) promptEl.classList.remove('hidden');
                });
            },
            sendForSignature: () => {
                const modal = document.getElementById('finalization-modal');
                if(!modal) return;
                modal.innerHTML = UI.renderFinalizationModal();
                modal.showModal();
            },
            simpleHash: async (str) => {
                const buffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            },
            executeFinalizationWorkflow: async () => {
                document.getElementById('finalization-modal')?.close();
                Utils.showNotification("Finalizing and dispatching...", 'info', 'Processing');
                try {
                    const finalHtml = document.getElementById('print-area').innerHTML;
                    const documentFingerprint = await Logic.simpleHash(finalHtml);
                    const agreementReference = finalHtml.match(/Reference:<\/strong>\s*([^<]+)/)?.[1].trim() || 'GECAN-DOC-FINAL';
                    const recipientEmails = AppState.modeler.legal.groups.flatMap(g => g.parties).map(p => p.email).filter(Boolean);
                    const payload = {
                        agreementReference, documentFingerprint, recipientEmails: recipientEmails.join(','),
                        emailBody: Logic.generatePremiumEmailTemplate({ agreementReference, documentFingerprint, parties: AppState.modeler.legal.groups.flatMap(g => g.parties) }),
                        fileName: `${agreementReference}_EXECUTED.pdf`,
                        htmlContent: `<!DOCTYPE html><html><head><style>${Array.from(document.styleSheets).map(s => Array.from(s.rules || []).map(r => r.cssText).join('')).join('')}</style></head><body>${finalHtml}</body></html>`
                    };
                    const response = await Logic.createApiRequest('generatePdfAndDispatchEmail', 'POST', payload);
                    Utils.showNotification(response, 'success', 'Document Dispatched');
                } catch (error) { Utils.showNotification(error.message, 'error', 'Dispatch Failed'); }
            },
            generatePremiumEmailTemplate: (payload) => {
                const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');
                return `<body style="font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px;"><div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px;"><div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;"><h1>GECANâ„¢ | Executed Agreement Attached</h1></div><div style="padding: 30px;"><p>Dear Contracting Parties,</p><p>Please find attached the fully executed legal document. This document has been finalized and its state cryptographically recorded.</p><div style="background-color: #f9f9f9; padding: 20px; border-left: 5px solid #0ea5e9; margin: 25px 0;"><h3 style="color: #0369a1;">Agreement Details</h3><p><strong>Reference:</strong> ${payload.agreementReference}</p><p><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px;">${payload.documentFingerprint}</code></p></div><h3>Parties to this Agreement:</h3><ul>${partyListHTML}</ul><p>Thank you for your cooperation.<br><strong>The GECANâ„¢ Transactional Systems</strong></p></div><div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;"><p><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication is strictly confidential and intended solely for the authorized recipients.</p></div></div></body>`;
            },
        };

        // --- SECTION 4: UI RENDERERS ---
        const UI = {
            init: () => {
        const defaultConfig = { "particles": { "number": { "value": 50 }, "color": { "value": ["#0ea5e9", "#6366f1", "#8b5cf6"] }, "opacity": { "value": 0.6, "random": true }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#475569", "opacity": 0.4 }, "move": { "enable": true, "speed": 1, "random": true, "out_mode": "out" } }, "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } } } };
        if (typeof particlesJS !== 'undefined') particlesJS('particles-js', defaultConfig);
        const vortex = document.getElementById('background-vortex');
        if (!vortex) return;
        let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
        let currentX = targetX, currentY = targetY;
        document.addEventListener('mousemove', e => { targetX = e.clientX; targetY = e.clientY; });
        const animate = () => { currentX += (targetX - currentX) * 0.05; currentY += (targetY - currentY) * 0.05; vortex.style.transform = `translate(-50%, -50%) translate3d(${currentX}px, ${currentY}px, 0)`; requestAnimationFrame(animate); };
        animate();
            },
            renderParticles: (config) => { if (typeof particlesJS !== 'undefined') particlesJS('particles-js', config); },
            populateNavLinks: () => {
        const navPlaceholder = document.getElementById('desktop-nav-placeholder'), mobileMenuContent = document.getElementById('mobile-sidebar-content');
        if (!navPlaceholder || !mobileMenuContent) return;
        const currentPageFile = window.location.pathname.split('/').pop().replace('.html', '') || 'index';
        const links = [ { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' }, { page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' }, { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' }, { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' }, { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' } ];
        const navHtml = (isMobile = false) => links.map(link => `<a href="./${link.page}.html" class="${isMobile ? 'nav-btn w-full justify-start' : 'nav-btn'} ${currentPageFile === link.page ? 'active' : ''}"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div><div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div></div></div><span class="nav-text">${link.text}</span></a>`).join('');
        navPlaceholder.innerHTML = `<div id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">${navHtml(false)}</div>`;
        mobileMenuContent.innerHTML = `<div class="mobile-nav-clone">${navHtml(true)}</div>`;
    },
            renderToolkitMenu: () => {
        const menuContainer = document.getElementById('toolkit-menu');
        if (!menuContainer) return;
        menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => `<button onclick="Logic.setActiveToolkit('${t.id}')" class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${AppState.activeToolkit === t.id ? 'bg-gradient-to-r from-primary-azure to-primary-dark text-white shadow-lg shadow-primary-azure/20' : 'text-text-secondary hover:bg-background-secondary hover:text-white'}"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform"><i class="fas ${t.icon} text-white"></i></div><div class="flex-1 min-w-0"><div class="font-semibold truncate">${t.name}</div><div class="text-xs opacity-75 mt-1 truncate">${t.description.split('.')[0]}</div></div><i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity ml-auto"></i></button>`).join('');
    },
            renderActiveToolkit: () => {
        const container = document.getElementById('active-toolkit-container');
        if (!container) return;
        const renderFunc = UI[`render${AppState.activeToolkit}UI`];
        if (typeof renderFunc === 'function') { container.innerHTML = renderFunc(); container.classList.remove('hidden'); Logic.bindActiveToolkitEvents(); } 
        else { Utils.showNotification(`UI for '${AppState.activeToolkit}' not implemented.`, 'error'); container.innerHTML = `<p class="text-center text-error-color">UI Error: Component '${AppState.activeToolkit}' failed to load.</p>`; }
        UI.renderToolkitMenu();
    },
             // --- DASHBOARD UI ---
    renderDashboardUI: () => `
        <div class="glass rounded-2xl p-8 h-full flex flex-col animate-fade-in-up">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold gradient-text mb-4">GECANâ„¢ Intelligent Toolkits</h2>
                <p class="text-text-secondary text-lg max-w-2xl mx-auto">Select a proprietary tool from the sidebar to begin your institutional-grade analysis.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits).filter(t => t.id !== 'Dashboard').map((t, index) => `
                    <div class="report-section p-8 cursor-pointer group animate-scale-in stagger-${index + 1}" onclick="Logic.setActiveToolkit('${t.id}')">
                        <div class="flex items-start gap-6">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform"><i class="fas ${t.icon}"></i></div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-azure transition-colors">${t.name}</h3>
                                <p class="text-text-secondary">${t.description}</p>
                                <div class="mt-4 flex items-center text-primary-azure opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="text-sm font-medium">Launch Toolkit</span><i class="fas fa-arrow-right ml-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `,

    // --- WALLET FORENSICS UI & SUBMISSION SUITE RENDERERS ---
    renderWalletForensicsUI: () => {
        const { address, isLoading, report } = AppState.walletAnalysis;
        let contentHTML;
        if (isLoading) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center animate-fade-in-up"><div class="relative mb-8"><div class="w-24 h-24 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div><h3 class="text-2xl font-bold text-white mb-4">Analyzing Wallet On-Chain...</h3><p id="spinner-text" class="text-text-secondary mb-6 transition-opacity duration-300">Initializing GECAN Heuristic Engine v5.0...</p></div>`;
        } else if (report?.error || report?.success === false) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-scale-in"><div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8"><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i></div><h3 class="text-2xl font-bold text-white mb-4">Analysis Failed</h3><p class="text-text-secondary max-w-md">${report.error?.message || 'An unknown server error occurred.'}</p><button onclick="Logic.runWalletForensics()" class="btn-primary mt-6 px-6 py-3 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry</button></div>`;
        } else if (report) {
            contentHTML = UI.buildWalletReportHTML(report);
        } else {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center glass rounded-2xl border-2 border-dashed border-border-color animate-fade-in-up"><div class="w-24 h-24 rounded-full bg-primary-azure/10 flex items-center justify-center mb-8 animate-float"><i class="fas fa-search-dollar fa-3x text-primary-azure"></i></div><h3 class="text-2xl font-bold text-white mb-4">Ready for Analysis</h3><p class="text-text-secondary max-w-md">Enter a wallet address to begin comprehensive due diligence and provenance analysis.</p></div>`;
        }
        return `<div class="glass rounded-2xl p-0 h-full flex flex-col animate-fade-in-up"><div class="p-8 border-b border-border-color"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-shield-alt text-white fa-lg"></i></div><div><h2 class="text-3xl font-bold text-white">Wallet Due Diligence & Provenance</h2><p class="text-text-secondary">Advanced blockchain forensics and risk assessment</p></div></div><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" class="btn-primary font-bold py-4 px-8 rounded-xl whitespace-nowrap w-full sm:w-auto"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto">${contentHTML}</div></div>`;
    },
    buildWalletReportHTML: (report) => {
        const { wallet, analysis, provenance, transactions } = report;
        const { walletClassification, redFlags, riskLevel, integrityScore, scoreBreakdown } = analysis;
        const riskClass = `risk-${riskLevel}`;
        const reliableTransactionCount = transactions?.length || wallet.transactionCount || 0;
        const inboundCount = transactions?.filter(tx => tx.type === 'Receive').length || 0;
        const outboundCount = transactions?.filter(tx => tx.type === 'Send').length || 0;
        const lastActivityDate = transactions?.[0]?.time ? new Date(transactions[0].time) : new Date(wallet.firstTransaction);
        const daysSinceLastTx = Math.floor((new Date() - lastActivityDate) / 86400000);
        const transactionVelocity = wallet.ageInDays > 0 ? (reliableTransactionCount / wallet.ageInDays).toFixed(2) : '0.00';
        const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN'))];
        const headerTags = [];
        if (provenance.records.length > 0) headerTags.push({ text: 'GECAN LEDGER MATCH', class: 'bg-success-color/20 text-success-color' }); else headerTags.push({ text: 'UNVERIFIED IN LEDGER', class: 'bg-warning-color/20 text-warning-color' });
        headerTags.push({ text: `${riskLevel} RISK`, class: `bg-${riskClass.replace('risk-','')}-color/20 text-${riskClass.replace('risk-','')}-color` });
        if (uniqueControllers.length > 1) headerTags.push({ text: 'OWNERSHIP CONFLICT', class: 'bg-critical-color/20 text-critical-color' });
        if (walletClassification.type === 'BLACKLISTED') headerTags.push({ text: 'BLACKLISTED', class: 'bg-critical-color/20 text-critical-color font-bold' });
        const createScoreGauge = (score, label, size = 'w-40 h-40', isMain = false) => { let scoreClass = 'gauge-low'; if (score < 40) scoreClass = 'gauge-critical'; else if (score < 65) scoreClass = 'gauge-high'; else if (score < 80) scoreClass = 'gauge-medium'; return `<div class="text-center animate-scale-in"><div class="relative ${size} mx-auto mb-3 transition-transform duration-300 hover:scale-105"><svg viewBox="0 0 36 36" class="w-full h-full"><defs><linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%" gradientTransform="rotate(90)"><stop offset="0%" stop-color="var(--critical-color)" /><stop offset="65%" stop-color="var(--warning-color)" /><stop offset="100%" stop-color="var(--success-color)" /></linearGradient></defs><circle cx="18" cy="18" r="15.9155" class="score-gauge-bg"></circle><circle cx="18" cy="18" r="15.9155" class="score-gauge-fg" stroke="url(#scoreGradient)" data-score="${score}"></circle></svg><div class="absolute inset-0 flex flex-col items-center justify-center"><span class="score-display ${isMain ? 'text-5xl' : 'text-3xl'} font-black transition-colors duration-500 ${scoreClass}">${Math.round(score)}</span>${isMain ? `<span class="text-xs font-bold -mt-1 ${scoreClass}">/ 100</span>` : ''}</div></div><p class="text-sm font-semibold text-white">${label}</p></div>`; };
        const createTransactionLedgerHTML = (transactions, walletType, walletAddress) => { if (reliableTransactionCount === 0) return `<div class="text-center text-text-muted py-12"><i class="fas fa-exchange-alt fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No On-Chain Transactions Found</p></div>`; const currency = walletType === 'BITCOIN' ? 'BTC' : 'USDT'; return `<div class="grid grid-cols-3 gap-4 mb-6 text-center"><div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Total Txs</p><p class="text-xl font-bold">${reliableTransactionCount.toLocaleString()}</p></div><div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Inbound</p><p class="text-xl font-bold text-success-color">${inboundCount.toLocaleString()}</p></div><div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Outbound</p><p class="text-xl font-bold text-error-color">${outboundCount.toLocaleString()}</p></div></div><div class="space-y-3 max-h-[28rem] overflow-y-auto pr-2">${transactions.map((tx, index) => { const isInbound = tx.type === 'Receive'; return `<div class="glass p-3 rounded-lg flex items-center justify-between gap-4 animate-fade-in-up" style="animation-delay: ${index * 30}ms"><div class="flex items-center gap-3 min-w-0"><div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isInbound ? 'bg-success-color/10 text-success-color' : 'bg-error-color/10 text-error-color'}"><i class="fas ${isInbound ? 'fa-arrow-down' : 'fa-arrow-up'}"></i></div><div class="min-w-0"><a href="${Logic.getExplorerUrl({type: walletType, address: walletAddress}, tx.hash)}" target="_blank" class="font-mono text-sm text-white truncate block hover:underline" title="${tx.hash}">${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}</a><p class="text-xs text-text-muted">${Utils.calculateTimeAgo(tx.time)}</p></div></div><div class="text-right flex-shrink-0"><p class="font-mono font-semibold text-base ${isInbound ? 'text-success-color' : 'text-error-color'}">${isInbound ? '+' : '-'}${Utils.formatNumber(tx.amount, 6)} <span class="text-xs text-text-muted">${currency}</span></p></div></div>`; }).join('')}</div>`; };
        return `<div class="animate-fade-in-up"><div class="mb-8"><div class="glass p-5 rounded-2xl flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-4"><div class="flex-1 min-w-0"><div class="flex items-center gap-3"><i class="fas fa-wallet text-2xl text-primary-azure"></i><a href="${Logic.getExplorerUrl(wallet)}" target="_blank" class="font-mono text-lg text-white truncate hover:underline">${wallet.address}</a><button onclick="Logic.copyToClipboard('${wallet.address}', this)" class="text-text-muted hover:text-white relative group"><i class="fas fa-copy"></i><span class="copied-feedback absolute -top-8 left-1/2 -translate-x-1/2 text-xs bg-success-color text-white px-2 py-1 rounded-md opacity-0 pointer-events-none">Copied!</span></button></div><div class="flex flex-wrap items-center gap-2 mt-2">${headerTags.map(tag => `<span class="text-xs font-bold px-3 py-1 rounded-full ${tag.class}">${tag.text}</span>`).join('')}</div></div><div class="flex-shrink-0 flex items-center gap-3"><button id="pdf-export-btn" onclick="Logic.generateAndDownloadForensicsPDF()" class="btn-secondary px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button><button id="submit-review-btn" onclick="Logic.initiateWalletSubmission()" class="btn-primary font-semibold px-4 py-2 rounded-lg text-sm"><i class="fas fa-paper-plane mr-2"></i>Submit for Official Review</button></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="report-section p-6 stagger-1"><h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-file-invoice text-primary-azure mr-3"></i>Executive Summary</h3><p class="text-text-secondary leading-relaxed">${Logic.generateExecutiveSummary(report)}</p></div><div class="report-section p-6 stagger-3"><h3 class="text-xl font-bold text-white mb-6"><i class="fas fa-flag text-warning-color mr-3"></i>Compliance Risk Assessment</h3>${redFlags.length > 0 ? `<div class="space-y-4 max-h-[28rem] overflow-y-auto pr-2">${redFlags.map(flag => `<div class="glass p-4 rounded-xl border-l-4 border-${flag.level.toLowerCase()}-color"><div class="flex items-start gap-4"><i class="fas ${Utils.getRiskIcon(flag.level)} text-${flag.level.toLowerCase()}-color text-xl mt-1"></i><div><p class="font-bold text-${flag.level.toLowerCase()}-color">${flag.title}</p><p class="text-sm text-text-secondary mt-1">${flag.details}</p></div></div></div>`).join('')}</div>` : `<div class="text-center text-text-muted py-12"><i class="fas fa-check-circle text-success-color fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No Significant Compliance Flags Detected</p></div>`}</div><div class="report-section p-6 stagger-4"><h3 class="text-xl font-bold text-white mb-6"><i class="fas fa-exchange-alt text-primary-sapphire mr-3"></i>On-Chain Transaction Ledger</h3>${createTransactionLedgerHTML(transactions, wallet.type, wallet.address)}</div></div><div class="lg:col-span-1 space-y-8"><div class="report-section p-6 stagger-1"><h3 class="text-xl font-bold text-white mb-6 text-center">Scoring Dashboard</h3>${createScoreGauge(integrityScore, 'Overall Integrity Score', 'w-40 h-40', true)}<div class="mt-8 border-t border-border-color pt-6 grid grid-cols-2 gap-6">${createScoreGauge(scoreBreakdown.provenance.score, 'Provenance', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.behavioral.score, 'Behavioral', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.temporal.score, 'Temporal', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.compliance.score, 'Compliance', 'w-28 h-28')}</div></div><div class="report-section p-6 stagger-2"><h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-microchip text-primary-royal mr-3"></i>Wallet Snapshot</h3><dl class="space-y-3 text-sm"><div class="flex justify-between items-center"><dt class="text-text-muted">Balance (USD Eq.)</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${Utils.formatPrice(wallet.balance)}</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Classification</dt><dd class="font-semibold text-white">${walletClassification.type}</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Wallet Age</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${wallet.ageInDays} Days</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Last Activity</dt><dd class="font-semibold text-white">${daysSinceLastTx} days ago</dd></div><div class="flex justify-between items-center"><dt class="text-text-muted">Tx Velocity</dt><dd class="font-semibold text-white">${transactionVelocity} tx/day</dd></div></dl></div><div class="report-section p-6 stagger-4"><h3 class="text-xl font-bold text-white mb-6"><i class="fas fa-history text-primary-amethyst mr-3"></i>GECAN Provenance Timeline</h3><div class="relative">${provenance.records.length > 0 ? provenance.records.map(rec => `<div class="timeline-item"><div class="timeline-dot"><div class="timeline-dot-inner ${uniqueControllers.length > 1 ? 'bg-critical-color' : 'bg-primary-azure'}"></div></div><p class="text-xs font-mono text-text-muted mb-1">${rec.date}</p><p class="font-semibold text-white">Controller: <span class="text-primary-azure">${rec.controller}</span></p><p class="text-xs text-text-secondary mt-1">Purpose: ${rec.purpose || 'Not specified'}</p></div>`).join('') : `<div class="text-center text-text-muted py-8"><i class="fas fa-question-circle text-warning-color fa-2x mb-3"></i><p class="font-semibold text-text-secondary">No GECAN Ledger Records</p></div>`}</div></div></div></div></div>`;
    },
    renderReferralValidationSuite: (title, subtitle) => `
        <div class="dialog-content-wrapper"><div class="submission-dialog-content p-8 space-y-6"><div class="text-center"><h2 class="text-2xl font-bold">${title}</h2><p class="mt-2">${subtitle}</p></div><div><input type="text" id="referral-id-input" placeholder="Enter Partner Referral ID" class="submission-form-input text-center font-mono tracking-widest p-4"></div><div id="referral-error" class="text-center bg-red-500/10 p-3 rounded-lg hidden"></div><div class="flex flex-col sm:flex-row gap-4 pt-2"><button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel</button><button id="validate-referral-btn" class="btn-primary w-full py-3 font-semibold"><i class="fas fa-key mr-2"></i>Validate & Proceed</button></div></div></div>`,
    renderWalletSubmissionSuite: (referralInfo) => {
        const { report } = AppState.walletAnalysis;
        return `<div class="dialog-content-wrapper max-w-3xl"><form id="wallet-submission-form"><div class="p-6 border-b border-border-color flex justify-between items-start flex-shrink-0"><div><h2 class="text-2xl font-bold">Official Wallet Submission</h2><p class="mt-1">Confirm details for official GECAN ledger entry.</p></div><button type="button" onclick="document.getElementById('submission-modal').close()" class="text-2xl text-text-muted hover:text-white">&times;</button></div><div class="p-6 space-y-6 overflow-y-auto"><fieldset><legend>Transaction Context</legend><div class="space-y-4"><div><label>Wallet Address to be Submitted</label><input type="text" class="form-input" value="${report.wallet.address}" readonly></div><div><label>Target Offer ID (If Applicable)</label><select id="submission-offer-id" class="form-select"></select></div></div></fieldset><fieldset><legend>Your Details (Submitter)</legend><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label>Your Full Name*</label><input type="text" id="submitter-name" class="form-input" required></div><div><label>Your Role*</label><input type="text" id="submitter-role" class="form-input" required></div><div><label>Your Contact Email*</label><input type="email" id="submitter-email" class="form-input" required></div><div><label>Your Contact Phone*</label><input type="tel" id="submitter-phone" class="form-input" required></div></div></fieldset><fieldset><legend>Alleged Wallet Controller</legend><div class="space-y-4"><div><label>Principal / Entity Name*</label><input type="text" id="controller-name" class="form-input" required></div><div class="recommendation-box"><h4>Recommendation</h4><p>For expedited review, provide the controller's CIS and POF via secure email to <strong>compliance@gecan.co</strong> after submission.</p></div></div></fieldset><div><label>Referring Partner</label><input type="text" class="form-input" value="${referralInfo.partnerName} (${referralInfo.referralId})" readonly></div></div><div class="p-6 border-t border-border-color mt-auto flex flex-col sm:flex-row gap-4 flex-shrink-0"><button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel</button><button type="submit" id="confirm-submission-btn" class="btn-primary w-full py-3 font-semibold bg-gradient-to-r from-success-color to-emerald-600 border-success-color"><i class="fas fa-check-circle mr-2"></i>Confirm & Submit</button></div></form></div>`;
    },

    // --- INSTITUTIONAL MODELER UI RENDERERS ---
    renderInstitutionalModelerUI: () => {
        const dealTypes = [ { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between assets.', gradient: 'from-blue-500 to-cyan-500' }, { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades.', gradient: 'from-yellow-500 to-orange-500' }, { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized credit.', gradient: 'from-green-500 to-emerald-500' }, { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit.', gradient: 'from-purple-500 to-violet-500' }, ];
        return `<div class="flex flex-col gap-8 animate-fade-in-up"><div class="report-section p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-azure mr-3"></i>Institutional Deal Modeler</h2><button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-error-color/20 hover:border-error-color/50 hover:text-error-color"><i class="fas fa-undo mr-2"></i>Reset</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map(deal => `<div class="deal-type-card glass p-6 text-center ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl deal-type-icon mx-auto"><i class="fas ${deal.icon}"></i></div><h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p></div>`).join('')}</div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-3 glass p-6 md:p-8 rounded-2xl"></div><div id="modeler-output-container" class="lg:col-span-2 glass p-6 md:p-8 rounded-2xl"></div></div></div>`;
    },
    renderModelerInputPanel: () => {
        const { activeDealType, pricingConfig } = AppState.modeler;
        const dealPanelRenderer = UI[`render${activeDealType}Panel`];
        const dealPanelHTML = dealPanelRenderer ? dealPanelRenderer() : `<p class="text-error-color">Error: Input panel for ${activeDealType} not found.</p>`;
        const pricingConfigHTML = `<div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}"><div class="p-4 bg-background-dark/50 rounded-lg"><div class="grid grid-cols-2 gap-4 mb-4"><select data-path="pricingConfig.offerType" class="form-select">${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}</select><select data-path="pricingConfig.isValueInPercent" class="form-select">${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label><input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label><input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input"></div></div></div></div>`;
        return `<h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-sliders-h text-primary-azure"></i>Deal Parameters</h2><div class="space-y-6"><div class="p-4 rounded-lg bg-background-dark border border-border-color"><h4 class="text-lg font-semibold text-white"><i class="fas fa-file-contract text-primary-azure mr-2"></i>Transaction Core</h4><div class="space-y-4 mt-4">${dealPanelHTML}</div></div><div class="p-4 rounded-lg bg-background-dark border border-border-color"><div class="flex justify-between items-center cursor-pointer" onclick="Logic.togglePricingConfig()"><h4 class="text-lg font-semibold text-white"><i class="fas fa-percent text-primary-azure mr-2"></i>Pricing & Configuration</h4><i class="fas fa-chevron-down transition-transform ${pricingConfig.isVisible ? 'rotate-180' : ''}"></i></div>${pricingConfigHTML}</div></div>`;
    },
    renderAssetSwapPanel: () => {
    const state = AppState.modeler.assetSwap;
    const assetOptions = (selectedKey) => AppState.marketData
        .filter(a => a.type !== 'Cross-Rate' && a.price > 0)
        .sort((a, b) => a.baseAsset.localeCompare(b.baseAsset))
        .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const fromAsset = Utils.getAssetByKey(state.fromAssetKey);
    return `
        <div class="flex items-center gap-4">
            <div class="flex-1">
                <label class="block text-sm font-medium text-text-muted mb-2">From Asset</label>
                <select data-path="assetSwap.fromAssetKey" class="form-select">${assetOptions(state.fromAssetKey)}</select>
            </div>
            <div class="pt-8">
                <button onclick="Logic.swapAssets()" class="w-10 h-10 flex items-center justify-center rounded-full bg-primary-azure/20 text-primary-azure hover:bg-primary-azure/30 transition-all duration-300" title="Swap Assets">
                    <i id="swap-icon" class="fas fa-exchange-alt"></i>
                </button>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-text-muted mb-2">To Asset</label>
                <select data-path="assetSwap.toAssetKey" class="form-select">${assetOptions(state.toAssetKey)}</select>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Amount to Swap (<span class="font-bold text-white">${fromAsset.baseAsset || 'N/A'}</span>)</label>
            <input type="text" data-path="assetSwap.amount" value="${(parseFloat(state.amount) || 0).toLocaleString()}" class="form-input text-lg font-bold">
        </div>
    `;
},

renderCommodityTradePanel: () => {
    const state = AppState.modeler.commodityTrade;
    const commodityAsset = Utils.getAssetByKey(state.assetKey);
    const commodityOptions = (selectedKey) => AppState.marketData.filter(asset => ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Commodity', 'Energy'].some(term => asset.type?.includes(term))).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.key})</option>`).join('');
    const settlementOptions = (selectedKey) => AppState.marketData.filter(a => a.price > 0 && a.key !== state.assetKey).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset}</option>`).join('');
    const selectedIncoterm = commodityData.incoterms.find(i => i.value === state.incoterms) || commodityData.incoterms.find(i => i.value === 'FOB');
    const pricingModelInputs = () => {
        if (state.pricingModel === 'Fixed') {
            return `<div><label class="block text-sm font-medium text-text-muted mb-2">Fixed Price per Unit (USD)</label><input type="number" step="0.01" data-path="commodityTrade.fixedPrice" value="${state.fixedPrice}" class="form-input"></div>`;
        }
        if (state.pricingModel === 'Discount' || state.pricingModel === 'Premium') {
            return `<div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">${state.pricingModel} Value</label><input type="number" step="0.01" data-path="commodityTrade.discountPremiumValue" value="${state.discountPremiumValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Value Type</label><select data-path="commodityTrade.discountPremiumIsInPercent" class="form-select"><option value="true" ${state.discountPremiumIsInPercent ? 'selected':''}>Percentage (%)</option><option value="false" ${!state.discountPremiumIsInPercent ? 'selected':''}>Fixed Amount ($)</option></select></div></div>`;
        }
        return '';
    };
    return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2"><label class="block text-sm font-medium text-text-muted mb-2">Commodity Asset</label><select data-path="commodityTrade.assetKey" class="form-select">${commodityOptions(state.assetKey)}</select></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">Quantity</label><input type="number" data-path="commodityTrade.quantity" value="${state.quantity || ''}" class="form-input font-bold"></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Unit of Measure</label><select data-path="commodityTrade.unitOfMeasure" class="form-select"><option value="">Select unit...</option>${commodityData.unitsOfMeasure.map(u => `<option value="${u}" ${state.unitOfMeasure === u ? 'selected' : ''}>${u}</option>`).join('')}</select></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-text-muted mb-2">Origin Country</label><input list="countries-datalist" value="${state.origin || ''}" data-path="commodityTrade.origin" class="form-input"><datalist id="countries-datalist">${commodityData.countries.map(c => `<option value="${c}">`).join('')}</datalist></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">${selectedIncoterm.port}</label><input list="ports-datalist" value="${state.port || ''}" data-path="commodityTrade.port" class="form-input"><datalist id="ports-datalist">${commodityData.ports.map(p => `<option value="${p}">`).join('')}</datalist></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">IncotermsÂ® 2020</label><select data-path="commodityTrade.incoterms" class="form-select">${commodityData.incoterms.map(i => `<option value="${i.value}" ${state.incoterms === i.value ? 'selected' : ''}>${i.label}</option>`).join('')}</select><p class="text-xs text-text-muted mt-2">Risk transfers to <strong>${selectedIncoterm.risk}</strong> â€¢ Cost responsibility: ${selectedIncoterm.cost}</p></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Pricing Model</label><div class="flex flex-wrap gap-2">${['Market', 'Discount', 'Premium', 'Fixed'].map(p => `<label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer ${state.pricingModel === p ? 'bg-primary-azure/20' : 'bg-background-light'}"><input type="radio" name="pricingModel" value="${p}" ${state.pricingModel === p ? 'checked' : ''} data-path="commodityTrade.pricingModel" class="hidden">${p}</label>`).join('')}</div></div>
            ${pricingModelInputs()}
            <div><label class="block text-sm font-medium text-text-muted mb-2">Settlement Asset</label><select data-path="commodityTrade.settlementAssetKey" class="form-select"><option value="USD">USD (Default)</option>${settlementOptions(state.settlementAssetKey)}</select></div>
        </div>
    `;
},

renderCryptoLoanPanel: () => {
    const state = AppState.modeler.cryptoLoan;
    const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type === 'Cryptocurrency').map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
    return `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div>
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label>
            <div class="flex items-center gap-4">
                <input type="range" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer">
                <div class="relative w-28">
                    <input type="number" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div>
        </div>
    `;
},

renderSBLCMonetizationPanel: () => {
    const state = AppState.modeler.sblcMonetization;
    return `
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label>
            <input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold">
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label>
            <div class="flex items-center gap-4">
                <input type="range" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer">
                <div class="relative w-28">
                    <input type="number" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
            </div>
        </div>
    `;
},

renderModelerOutputPanel: (calc) => {
    if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
    let customOutput = '';
    if (AppState.modeler.activeDealType === 'AssetSwap') {
        const { fromAsset, toAsset, rate } = calc; const rateDisplay = rate > 0 ? rate.toFixed(8) : 'N/A';
        customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-sync-alt"></i>Institutional Cross Rate</p><p class="value">${rateDisplay}</p><p class="sub-value">1 ${fromAsset.baseAsset} â‰ˆ ${rateDisplay} ${toAsset.baseAsset}</p></div>`;
    } else if (AppState.modeler.activeDealType === 'CryptoLoan') {
        const monthlyPayment = calc.totalRepayment / (calc.tenureMonths || 1);
        customOutput = `
            <div class="output-metric-card"><p class="label"><i class="fas fa-hand-holding-usd"></i>Loan Principal</p><p class="value">${Utils.formatPrice(calc.loanPrincipal, calc.loanCurrency)}</p><p class="sub-value">Total Repayment: ${Utils.formatPrice(calc.totalRepayment, calc.loanCurrency)}</p></div>
            <div class="output-metric-card mt-4"><p class="label"><i class="fas fa-calendar-alt"></i>Monthly Repayment</p><p class="value">${Utils.formatPrice(monthlyPayment, calc.loanCurrency)}</p><p class="sub-value">${calc.tenureMonths}-month tenure @ ${calc.interestRateValue}% fixed</p></div>
            <div class="mt-4"><h4 class="text-sm font-semibold text-text-secondary mb-2">Projected Loan Balance Over Time</h4><div class="h-40">${UI.renderYieldGraph(calc)}</div></div>
        `;
    }
    return `
        <div class="flex flex-col h-full animate-fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-success-color"></i>Deal Analysis & Projections</h2>
            <div class="space-y-4 flex-grow">
                <div class="output-metric-card base-value"><p class="label"><i class="fas fa-tags"></i>Base/Market Value</p><p class="value">${Utils.formatPrice(calc.baseValueUSD)}</p><p class="sub-value">${calc.dealTitle}</p></div>
                <div class="output-metric-card net"><p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Value to Buyer</p><p class="value">${Utils.formatPrice(calc.finalValueToBuyerUSD)}</p><p class="sub-value">${calc.netValueDescription}</p></div>
                <div class="output-metric-card commission"><p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p><p class="value">${Utils.formatPrice(calc.totalCommissionPool)}</p><p class="sub-value">${calc.grossValueDescription}</p></div>
                ${customOutput}
            </div>
            <div class="mt-auto pt-6 border-t border-border-color">
                <button onclick="Logic.openImfpaModal()" class="btn-primary w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Commission Manager</button>
            </div>
        </div>
    `;
},

renderYieldGraph: (calc) => {
    const { loanPrincipal, totalRepayment, tenureMonths } = calc;
    if (tenureMonths <= 0) return '<p class="text-center text-text-muted text-sm">Invalid tenure for graph.</p>';
    const points = Array.from({length: tenureMonths + 1}, (_, i) => ({ month: i, value: loanPrincipal + ((totalRepayment - loanPrincipal) / tenureMonths * i) }));
    const width=300, height=120, marginY=20, marginX=30;
    const yMax = totalRepayment, yMin = loanPrincipal;
    const xScale = (width - marginX*2) / tenureMonths;
    const yScale = (yMax > yMin) ? (height - marginY*2) / (yMax - yMin) : 0;
    const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${(marginX + p.month * xScale).toFixed(2)} ${(height - marginY - ((p.value - yMin) * yScale)).toFixed(2)}`).join(' ');
    return `
        <svg viewBox="0 0 ${width} ${height}" class="w-full h-full">
            <line x1="${marginX}" y1="${height-marginY}" x2="${width-marginX}" y2="${height-marginY}" stroke="var(--border-color)"/>
            <text x="${marginX-5}" y="${marginY+5}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMax, 0)}</text>
            <text x="${marginX-5}" y="${height-marginY}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMin, 0)}</text>
            <path d="${pathData}" fill="none" stroke="var(--success-color)" stroke-width="2"/>
        </svg>
    `;
},
    
    // --- IMFPA & DOCUMENT EXECUTION SUITE RENDERERS ---
    renderImfpaModal: () => {
    const { legal } = AppState.modeler;
    return `
        <div class="dialog-content-wrapper">
            <div class="p-6 md:p-8 flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-start mb-6 imfpa-header print-hide">
                    <div>
                        <h2 class="text-3xl font-bold">Commission & Contract Suite</h2>
                        <p class="text-text-secondary">Synthesize the Irrevocable Master Fee Protection Agreement.</p>
                    </div>
                    <button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-text-muted hover:text-white">&times;</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 overflow-y-auto pr-4 -mr-4">
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="imfpa-section-title"><i class="fas fa-sitemap mr-3 text-primary-azure"></i>Commission Allocation</h3>
                            <div class="text-right">
                                <p class="text-xs text-text-muted">Total Pool</p>
                                <p id="imfpa-total-commission-pool" class="text-2xl font-bold text-primary-azure">${Utils.formatPrice(legal.totalCommission)}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <button onclick="Logic.addImfpaGroup()" class="btn-secondary px-3 py-1 text-sm rounded-lg"><i class="fas fa-plus mr-1"></i>Add Group</button>
                            <div id="imfpa-total-allocated" class="text-right font-mono text-sm"></div>
                        </div>
                        <div class="space-y-4" id="imfpa-groups-container"></div>
                    </div>
                    <div class="space-y-6">
                        <h3 class="imfpa-section-title"><i class="fas fa-gavel mr-3 text-primary-amethyst"></i>Legal Framework</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2">Governing Law & Jurisdiction</label>
                            <input value="${legal.jurisdiction}" data-path="legal.jurisdiction" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Signatory Parties</label>
                            <div id="imfpa-legal-parties" class="space-y-2 text-sm text-text-secondary p-4 bg-background-dark rounded-lg border border-border-color min-h-[50px]"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Cross-Referenced Contract / SPA</label>
                            <input value="${legal.spaReferenceCode || ''}" data-path="legal.spaReferenceCode" class="form-input font-mono">
                        </div>
                    </div>
                </div>
                <div class="pt-6 border-t border-border-color mt-auto print-hide">
                    <button onclick="Logic.generateContract()" class="btn-primary w-full py-3 font-bold">
                        <i class="fas fa-file-signature mr-2"></i>Synthesize & Preview Document
                    </button>
                    <div id="contract-preview-container" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    `;
},

renderImfpaGroups: () => {
    const { groups } = AppState.modeler.legal;
    if (!groups || groups.length === 0) {
        return `<p class="text-center text-text-muted py-4">No allocation groups defined. Click 'Add Group' to begin.</p>`;
    }
    return groups.map((g, groupIndex) => `
        <div class="allocation-group-card animate-fade-in-up">
            <div class="flex items-center gap-2 mb-3">
                <input type="text" value="${g.name}" data-path="legal.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow !p-1 focus:ring-0 font-semibold text-lg !text-text-primary">
                <div class="relative w-32">
                    <input type="number" value="${g.percentage}" data-path="legal.groups[${groupIndex}].percentage" class="form-input text-right font-bold">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
                <button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-red-500 hover:text-red-400 text-xl font-bold w-8 h-8 flex items-center justify-center transition">Ã—</button>
            </div>
            <p id="imfpa-group-value-${groupIndex}" class="text-right text-primary-azure font-mono text-lg mb-4"></p>
            <div class="space-y-2 pl-4 border-l-2 border-border-accent">
                ${g.parties.map((p, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('')}
                <div class="flex justify-between items-center pt-2">
                    <button onclick="Logic.addImfpaParty(${groupIndex})" class="text-primary-azure hover:text-white text-xs font-semibold">
                        <i class="fas fa-user-plus mr-1"></i>Add Party
                    </button>
                    <div id="imfpa-group-total-${groupIndex}" class="text-right font-mono text-xs"></div>
                </div>
            </div>
        </div>
    `).join('');
},

renderImfpaParty: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
    return `
        <div class="allocation-party-card">
            <div class="flex items-center gap-2">
                <input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow !p-1 !text-sm focus:ring-0 !text-text-primary" placeholder="Full Legal Name">
                <div class="relative w-24">
                    <input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input !text-sm text-right">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
                <button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-red-500 text-lg w-6 h-6 flex items-center justify-center transition">Ã—</button>
            </div>
            <div class="mt-2">
                <a onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-xs text-primary-amethyst cursor-pointer hover:underline flex items-center gap-1 w-full">
                    <i class="fas fa-user-cog"></i> Manage Details 
                    <i class="fas fa-chevron-down text-xs transition-transform ${party.detailsVisible ? 'rotate-180' : ''} ml-auto"></i>
                </a>
            </div>
            <div class="collapsible-content ${party.detailsVisible ? 'expanded' : ''}">
                <div>${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div>
            </div>
        </div>
    `;
},

renderImfpaPartyDetails: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
    const paymentDetailsPlaceholder = { 'Bank Wire': 'IBAN, SWIFT, Bank Info...', 'USDT TRC-20': 'TRC-20 Wallet Address', 'USDT ERC-20': 'ERC-20 Wallet Address' }[party.payment.method] || 'Details...';
    return `
        <div class="party-details-grid">
            <div><span class="party-detail-label">Role</span><input class="form-input !text-xs" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate"></div>
            <div><span class="party-detail-label">Email</span><input type="email" class="form-input !text-xs" value="${party.email || ''}" data-path="${base}.email" placeholder="contact@email.com"></div>
            <div><span class="party-detail-label">Contact Number</span><input class="form-input !text-xs" value="${party.contactNumber || ''}" data-path="${base}.contactNumber" placeholder="+1-555-123-4567"></div>
            <div><span class="party-detail-label">Passport No.</span><input class="form-input !text-xs" value="${party.passport.number || ''}" data-path="${base}.passport.number" placeholder="P12345678"></div>
            <div><span class="party-detail-label">Passport Issue Date</span><input type="date" class="form-input !text-xs" value="${party.passport.issueDate || ''}" data-path="${base}.passport.issueDate"></div>
            <div><span class="party-detail-label">Passport Expiry Date</span><input type="date" class="form-input !text-xs" value="${party.passport.expiryDate || ''}" data-path="${base}.passport.expiryDate"></div>
            <div class="col-span-2"><span class="party-detail-label">Passport Issuing Authority</span><input class="form-input !text-xs" value="${party.passport.authority || ''}" data-path="${base}.passport.authority" placeholder="USA"></div>
            <div class="col-span-2 pt-2 mt-2 border-t border-border-secondary"><span class="party-detail-label font-bold">Payment Method</span></div>
            <div><select class="form-select !text-xs" data-path="${base}.payment.method"><option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected':''}>Bank Wire</option><option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected':''}>USDT (TRC-20)</option><option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected':''}>USDT (ERC-20)</option></select></div>
            <div><select class="form-select !text-xs" data-path="${base}.payment.currency"><option value="USD" ${party.payment.currency === 'USD' ? 'selected':''}>USD</option><option value="USDT" ${party.payment.currency === 'USDT' ? 'selected':''}>USDT</option><option value="EUR" ${party.payment.currency === 'EUR' ? 'selected':''}>EUR</option></select></div>
            <div class="col-span-2"><span class="party-detail-label">Payment Coordinates</span><textarea class="form-input !text-xs font-mono" data-path="${base}.payment.details" rows="3" placeholder="${paymentDetailsPlaceholder}">${party.payment.details || ''}</textarea></div>
        </div>
    `;
},

renderExecutionSuite: (contractHTML) => `
    <div id="execution-suite">
        <div class="step-panel step-1">
            <h4>Step 1: Sign & Prepare Document</h4>
            <p class="text-sm mt-2 mb-4">Apply all known signatures and corporate seals on behalf of the parties. This prepares the document for the final, binding workflow.</p>
            <button id="launch-signing-btn" class="execution-btn" onclick="Logic.initiateSigningProcess()"><i class="fas fa-pen-fancy mr-2"></i>Launch Signature Suite</button>
        </div>
        <div id="finalization-step-panel" class="step-panel step-2 opacity-50 pointer-events-none">
            <h4>Step 2: Finalize & Dispatch</h4>
            <p class="text-sm mt-2 mb-4">This will lock the document, generate a cryptographic fingerprint, and dispatch the finalized PDF to all parties.</p>
            <button id="send-for-signature-btn" class="execution-btn" onclick="Logic.sendForSignature()"><i class="fas fa-paper-plane mr-2"></i>Lock & Send to Parties</button>
        </div>
    </div>
    <div id="contract-document-wrapper">${contractHTML}</div>
`,

renderContractDocument: (agreementReference) => {
    const { legal } = AppState.modeler;
    const calc = Logic.calculateModel();
    const allParties = legal.groups.flatMap(g => g.parties);
    const feeClauses = legal.groups.map(g => {
        const groupPayout = legal.totalCommission * (g.percentage / 100);
        return `
            <h2 class="p-h2">Distribution Group: ${g.name} (${g.percentage}%)</h2>
            <p class="p-text">Total value designated for this group: ${Utils.formatPrice(groupPayout)}</p>
            <table class="p-table">
                <thead><tr><th>Beneficiary</th><th>Role</th><th>Allocation</th><th>Value</th><th>Payment Details</th></tr></thead>
                <tbody>
                    ${g.parties.map(p => { 
                        const partyValue = groupPayout * (p.percentage / 100);
                        return `<tr><td>${p.legalName}</td><td>${p.role}</td><td>${p.percentage}%</td><td>${Utils.formatPrice(partyValue)}</td><td>${p.payment.method}: ${p.payment.details || 'To be furnished via secure KYC.'}</td></tr>` 
                    }).join('')}
                </tbody>
            </table>
        `;
    }).join('');
    const signatureBlocks = allParties.map((p, i) => `
        <div class="p-signature-block" data-party-id="party-${i}" data-party-name="${p.legalName}">
            <p class="p-strong">FOR AND ON BEHALF OF: ${p.legalName.toUpperCase()}</p>
            <div class="p-signature-line" data-sig-type="signature"></div>
            <p class="p-signature-label">By: (Authorized Signature)</p>
            <div class="p-signature-line" data-sig-type="print-name"></div>
            <p class="p-signature-label">Name/Title: ${p.legalName} / ${p.role}</p>
            <div class="p-signature-line" data-sig-type="date"></div>
            <p class="p-signature-label">Date of Execution:</p>
            <div data-sig-type="seal" style="position: relative; height: 100px;"></div>
        </div>
    `).join('');
    return `
        <div class="p-doc">
            <div class="p-watermark">DRAFT</div>
            <h1 class="p-h1">Irrevocable Master Fee Protection & NCND Agreement</h1>
            <p class="p-text"><strong>Reference:</strong> ${agreementReference}</p>
            <p class="p-text"><strong>Effective Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p class="p-text">This agreement concerns a transaction with a total commission pool of <strong>${Utils.formatPrice(legal.totalCommission)}</strong>.</p>
            <div class="p-annex-start">
                <h2 class="p-h2">ANNEX A: FEE DISTRIBUTION SCHEDULE</h2>
                ${feeClauses}
            </div>
            <div class="p-annex-start">
                <h2 class="p-h2">SIGNATURE PAGE</h2>
                <p class="p-text">IN WITNESS WHEREOF, the Parties have executed this Agreement by their duly authorized representatives as of the Effective Date.</p>
                ${signatureBlocks}
            </div>
        </div>
    `;
}
};

        // --- SECTION 5: INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', Logic.init);
    </script>
</body>
</html>
