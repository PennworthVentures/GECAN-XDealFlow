<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>

/* ========================================================================= */
/* === SUPREME COMMODITY WORKFLOW AESTHETICS (v5.0) === */
/* ========================================================================= */
.pricing-option, .commission-option {
    border: 1px solid var(--border-secondary);
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}
.pricing-option.selected, .commission-option.selected {
    background-image: linear-gradient(135deg, var(--primary-azure-t), var(--primary-royal-t));
    border-color: var(--primary-azure);
    color: var(--text-diamond);
}
.glow-selected {
    box-shadow: 0 0 25px var(--glow-azure), inset 0 1px 0 rgba(255,255,255,0.1);
}
.hover-lift-subtle:hover {
    transform: translateY(-3px);
    border-color: var(--border-accent);
}
        
/* ========================================================================= */
/* === PINNACLE GUIDED WORKFLOW & 3D UI ENGINE (v1.0) === */
/* ========================================================================= */
.guided-step-card {
    background: rgba(30, 41, 59, 0.7); /* bg-slate-800/70 */
    border: 1px solid var(--border-secondary);
    border-radius: 1.25rem; /* rounded-2xl */
    padding: 1.5rem; /* p-6 */
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform-style: preserve-3d;
    position: relative;
    overflow: hidden;
}

.guided-step-card:before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at 50% 0, rgba(14, 165, 233, 0.15), transparent 70%);
    opacity: 0;
    transition: opacity 0.5s ease;
    z-index: 1;
}

.guided-step-card:hover {
    transform: perspective(1000px) rotateX(5deg) rotateY(-3deg) scale(1.03);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border-color: var(--primary-azure);
}

.guided-step-card:hover:before {
    opacity: 1;
}

.step-header {
    display: flex;
    align-items: center;
    gap: 1rem; /* gap-4 */
    margin-bottom: 1rem; /* mb-4 */
    position: relative;
    z-index: 2;
}

.step-number {
    width: 2.5rem; /* w-10 */
    height: 2.5rem; /* h-10 */
    border-radius: 9999px; /* rounded-full */
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700; /* font-bold */
    font-size: 1.125rem; /* text-lg */
    color: var(--text-diamond);
    background: var(--background-secondary);
    border: 2px solid var(--border-premium);
    transition: all 0.4s ease;
}

.step-header.completed .step-number {
    background: linear-gradient(135deg, var(--success-color), #16a34a);
    border-color: var(--success-color);
    animation: pulse-success 2s infinite;
}

@keyframes pulse-success {
    0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
    100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
}

.step-title {
    font-size: 1.25rem; /* text-xl */
    font-weight: 700; /* font-bold */
    color: var(--text-platinum);
}

.step-content {
    position: relative;
    z-index: 2;
}

/* Intelligent Focus Highlighting */
.form-select.highlight-focus,
.form-input.highlight-focus {
    border-color: var(--primary-azure);
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), 
                inset 0 0 0 50px var(--background-secondary),
                0 0 25px rgba(14, 165, 233, 0.5);
    animation: focus-glow 1.5s ease-in-out infinite alternate;
}

@keyframes focus-glow {
    from { box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary), 0 0 15px rgba(14, 165, 233, 0.3); }
    to { box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary), 0 0 35px rgba(14, 165, 233, 0.6); }
}

.swap-icon-container {
    padding-top: 1.75rem; /* pt-7 to align with label */
    transition: transform 0.4s ease;
}

.swap-icon-container:hover {
    transform: scale(1.2) rotate(-15deg);
}

.swap-icon-button {
    width: 2.75rem; /* w-11 */
    height: 2.75rem; /* h-11 */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    background-color: rgba(14, 165, 233, 0.2);
    color: var(--primary-azure);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid var(--primary-azure);
}

.swap-icon-button:hover {
    background-color: rgba(14, 165, 233, 0.3);
    box-shadow: 0 0 20px var(--glow-azure);
}
        
/* ========================================================================= */
/* === PINNACLE CSS ENGINE v4.0 (BENCHMARKED & UNIFIED) === */
/* This stylesheet is the definitive standard for the Toolkits page, */
/* ensuring visual consistency with the entire GECAN platform. */
/* ========================================================================= */

/* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
:root {
    --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
    --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
    --primary-diamond: #f8fafc; --primary-dark: #0369a1;
    --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
    --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
    --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
    --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
    --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
    --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
    --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
    --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
    --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
    --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
    --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
    --shadow-quantum: 0 50px 100px -20px rgba(0,0,0,0.5), 0 30px 60px -30px rgba(0,0,0,0.6);
    --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
}

/* --- B. BASE STYLES & RESETS --- */
* { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
body.mobile-sidebar-open { overflow: hidden; }
.font-mono { font-family: 'JetBrains Mono', monospace; }
::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
::selection { background: var(--gradient-primary); color: var(--text-diamond); }

/* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
#particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
#interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
#background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
#background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
@keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
@keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

.premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
.gecan-logo-container { perspective: 800px; }
.gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
.gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
.logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
.logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
.logo-back { transform: rotateY(180deg); }
.logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
.logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
@keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
@keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }

/* BENCHMARKED NAVIGATION & MOBILE MENU */
.nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
.nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
.nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
.nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
.nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
.nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
.nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
.nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }
@keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }

#mobile-sidebar.left-0 { transform: translateX(0); }
.mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
.mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
@media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }

/* --- D. TOOLKIT-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
.glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
.btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
.btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
.btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
.btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
.report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
.report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(-2px); }
.gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

/* Animations */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes float { 50% { transform: translateY(-8px); } }
.animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
.stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

/* Wallet Forensics Specific Styles */
.risk-LOW { --risk-color: var(--success-color); } .risk-MEDIUM { --risk-color: var(--warning-color); }
.risk-HIGH { --risk-color: var(--error-color); } .risk-CRITICAL { --risk-color: var(--critical-color); }
.text-risk-color { color: var(--risk-color); } .border-risk-color { border-color: var(--risk-color); } .bg-risk-color { background-color: var(--risk-color); }
.score-gauge-bg { stroke: var(--background-secondary); stroke-width: 2.5; }
.score-gauge-fg { stroke-width: 3.5; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); stroke-dasharray: 0, 100; transition: stroke-dasharray 1.2s cubic-bezier(0.16, 1, 0.3, 1); }
.gauge-low { color: var(--success-color); } .gauge-medium { color: var(--warning-color); }
.gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
.timeline-item { position: relative; padding-left: 25px; padding-bottom: 20px; border-left: 2px solid var(--border-color); }
.timeline-item:last-child { border-left: 2px solid transparent; }
.timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--background-secondary); display: grid; place-items: center; }
.timeline-dot-inner { width: 8px; height: 8px; border-radius: 50%; }

/* Institutional Modeler Specific Styles */
.deal-type-card { background: var(--background-glass); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s ease; text-align: left; }
.deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-azure); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
.deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.05); }
.deal-type-icon { transition: all 0.3s ease; } .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
@keyframes icon-glow-rotate { 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }

.output-metric-card { background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
.output-metric-card .label { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.output-metric-card .value { font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
.output-metric-card .sub-value { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
.output-metric-card.base-value .value { color: var(--primary-azure); } .output-metric-card.net .value { color: var(--success-color); } .output-metric-card.commission .value { color: var(--warning-color); }

/* ========================================================================= */
/* === DEFINITIVE MODAL & CENTERING ENGINE (MILITARY-GRADE v7.0) === */
/* This is the SINGLE SOURCE OF TRUTH for all dialogs. */
/* It guarantees perfect centering and pinnacle-grade aesthetics. */
/* ========================================================================= */

/* --- A. UNIVERSAL DIALOG CONTAINER (THE CENTERING MECHANISM) --- */
dialog {
    /* Base resets for a clean slate */
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    max-width: 100%;
    width: 100%;
    overflow: hidden; /* Prevent scrollbars on the dialog itself */
}

dialog[open] {
    /* SUPREME CENTERING: Use Grid on the full-screen container */
    display: grid !important;
    place-items: center !important; /* Vertically and horizontally centers the child */
    position: fixed !important; 
    inset: 0 !important; 
    z-index: 200 !important;
    
    /* DEFINITIVE PADDING FIX: Creates a visual boundary on all sides */
    padding: 2rem;
    
    animation: modal-backdrop-fade-in 0.5s ease forwards;
}

/* On smaller screens, reduce the boundary padding */
@media (max-width: 768px) {
    dialog[open] {
        padding: 1rem;
    }
}

dialog::backdrop {
    background: rgba(5, 5, 9, 0.85) !important;
    backdrop-filter: blur(16px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
    animation: modal-backdrop-fade-in 0.5s ease forwards;
}

/* --- B. UNIVERSAL DIALOG CONTENT WRAPPER (THE VISIBLE MODAL) --- */
.dialog-content-wrapper {
    background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
    border: 1px solid var(--border-premium) !important;
    box-shadow: var(--shadow-quantum) !important;
    border-radius: 1.5rem !important;
    
    width: 100%; /* Takes up the full width of its parent dialog container */
    max-height: calc(100vh - 4rem); /* Respects the dialog's padding */
    
    display: flex;
    flex-direction: column;
    overflow: hidden; /* The wrapper handles its own boundaries */
    
    animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@media (max-width: 768px) {
    .dialog-content-wrapper {
        max-height: calc(100vh - 2rem);
    }
}

/* --- C. SPECIFIC MODAL WIDTHS (PINNACLE CONTROL) --- */
/* We set the max-width on the WRAPPER, not the dialog, for precision. */
#submission-modal .dialog-content-wrapper { max-width: 40rem; }
#signature-modal .dialog-content-wrapper { max-width: 35rem; }
#finalization-modal .dialog-content-wrapper { max-width: 35rem; }
#notification-modal .dialog-content-wrapper { max-width: 32rem; }

/* ========================================================================= */
/* === DEFINITIVE FIX: IMFPA Modal Sizing & Efficiency (USER REQUEST) === */
/* This rule is specifically enhanced to meet the requirement for a centered,
   max-efficiency view for the Commission & Contract Suite. */
/* ========================================================================= */
#imfpa-modal .dialog-content-wrapper { 
    /* 1. Increase max-width for better use of large screens. */
    max-width: 90rem; /* Increased from 80rem for superior viewing on widescreen monitors */
    
    /* 2. Ensure the modal uses as much vertical space as possible for an immersive feel. */
    height: 95%; /* Use 95% of the available vertical space inside the padded dialog */
}

/* --- D. PINNACLE ANIMATIONS --- */
@keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.form-input, .form-select {
    background-color: var(--background-dark) !important; border: 1px solid var(--border-secondary) !important;
    color: var(--text-primary) !important; border-radius: 0.75rem !important; padding: 0.75rem 1rem !important;
    width: 100% !important; font-size: 1rem !important; transition: all 0.3s ease !important;
    appearance: none !important; -webkit-text-fill-color: var(--text-primary) !important;
    box-shadow: inset 0 0 0 50px var(--background-dark) !important;
}
input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active {
    -webkit-text-fill-color: var(--text-primary) !important; box-shadow: inset 0 0 0 50px var(--background-dark) !important;
    caret-color: var(--text-primary) !important;
}
.form-input::placeholder { color: var(--text-muted) !important; opacity: 1 !important; }
.form-input:focus, .form-select:focus {
    outline: none !important; border-color: var(--primary-azure) !important;
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary) !important;
    background-color: var(--background-secondary) !important;
}
.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
    background-position: right 0.75rem center !important; background-repeat: no-repeat !important;
    background-size: 1.5em 1.5em !important; padding-right: 2.5rem !important;
}
.collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s ease; }
.collapsible-content.expanded { grid-template-rows: 1fr; }
.collapsible-content > div { overflow: hidden; }

/* =================================================================================== */
/* === G. PINNACLE NCNDA/IMFPA & DOCUMENT EXECUTION SUITE CSS (v9.0 SEVERE OVERHAUL) === */
/* =================================================================================== */
#imfpa-modal .dialog-content-wrapper {
    --premium-gold: #D4AF37; --premium-gold-glow: rgba(212, 175, 55, 0.4);
    --premium-bg-dark: #0a0f1c; --premium-bg-light: #161d31; --premium-border: #2a3552;
    --premium-text-primary: #f0f4ff; --premium-text-secondary: #a0aec0;
    background: radial-gradient(circle at top left, var(--premium-bg-light), var(--premium-bg-dark) 70%);
    border: 1px solid var(--premium-border); color: var(--premium-text-primary);
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.75), 0 0 0 1px var(--premium-gold-glow);
}
#contract-live-preview { background-color: #fcfcff; color: #1a202c; font-family: 'Garamond', serif; border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--premium-border); box-shadow: inset 0 2px 8px rgba(0,0,0,0.2); overflow-y: auto; transition: all 0.3s ease; }
.preview-h1 { font-size: 1.2rem; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 0.5rem; margin-bottom: 1rem; }
.preview-p { font-size: 0.9rem; line-height: 1.6; text-align: justify; margin-bottom: 1rem; }
.preview-strong { font-weight: bold; color: #283593; }
.agreement-toggle { display: flex; align-items: center; cursor: pointer; user-select: none; }
.toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; transform-style: preserve-3d; transition: transform 0.3s ease; }
.toggle-switch:hover { transform: scale(1.05); } .toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--premium-border); transition: .4s; border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
.toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
input:checked + .toggle-slider { background-color: var(--premium-gold); box-shadow: 0 0 15px var(--premium-gold-glow); }
input:checked + .toggle-slider:before { transform: translateX(26px); }
.toggle-label { font-weight: 700; transition: all 0.4s; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.toggle-label.active { color: var(--premium-gold); transform: scale(1.05); }
.imfpa-header h2 { font-family: 'Orbitron', monospace; background: linear-gradient(90deg, var(--premium-text-primary), var(--premium-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.imfpa-section-title { font-size: 1.25rem; font-weight: 700; color: var(--premium-text-primary); border-left: 3px solid var(--premium-gold); padding-left: 1rem; margin-bottom: 1.5rem; }
.imfpa-section-title i { animation: icon-pulse 3s infinite ease-in-out; }
@keyframes icon-pulse { 50% { transform: scale(1.1); color: var(--premium-gold); } }
.allocation-group-card { background: linear-gradient(145deg, var(--premium-bg-light), var(--premium-bg-dark)); border: 1px solid var(--premium-border); border-radius: 1rem; transition: all 0.4s; position: relative; overflow: hidden; perspective: 1000px; }
.allocation-group-card:hover { transform: translateY(-8px) rotateX(5deg) scale(1.03); border-color: var(--premium-gold); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6), 0 0 25px var(--premium-gold-glow); }
.allocation-party-card { background: rgba(0,0,0,0.3); border: 1px solid var(--premium-border); border-radius: 0.75rem; transition: all 0.3s; }
.allocation-party-card:hover { background-color: var(--premium-bg-light); border-color: var(--premium-text-secondary); transform: translateX(4px); }
#execution-suite { background: var(--background-glass); border: 1px solid var(--border-premium); border-radius: 1.5rem; padding: 1.5rem; margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
#execution-suite .step-panel { background: rgba(var(--rgb-color, 59, 130, 246), 0.1); border: 1px solid rgba(var(--rgb-color, 59, 130, 246), 0.2); border-left: 4px solid rgb(var(--rgb-color, 59, 130, 246)); border-radius: 1rem; padding: 1.25rem; text-align: center; transition: all 0.3s ease; }
#execution-suite .step-panel.step-1 { --rgb-color: 59, 130, 246; } #execution-suite .step-panel.step-2 { --rgb-color: 139, 92, 246; }
.step-panel h4 { color: rgb(var(--rgb-color)); font-weight: 700; font-size: 1.125rem; }
.execution-btn { background: linear-gradient(135deg, rgb(var(--rgb-color)), rgba(var(--rgb-color), 0.7)); border: 1px solid rgb(var(--rgb-color)); color: white; transition: all 0.3s; box-shadow: 0 4px 15px rgba(var(--rgb-color), 0.2); padding: 0.75rem 1.5rem; font-weight: 700; border-radius: 0.75rem; }
.execution-btn:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(var(--rgb-color), 0.4); transform: translateY(-3px); }
#contract-document-wrapper { background: #f8fafc; border-radius: 1rem; padding: 1rem; margin-top: 1.5rem; max-height: 70vh; overflow-y: auto; box-shadow: inset 0 2px 10px rgba(0,0,0,0.1); }
#finalization-icon-container { background: linear-gradient(135deg, var(--primary-amethyst), var(--primary-royal)); animation: pulse-glow 3s ease-in-out infinite; }
@keyframes pulse-glow { 50% { transform: scale(1.05); box-shadow: 0 0 35px var(--glow-amethyst); } }
#signature-modal .signature-tab.active { border-color: var(--success-color); color: var(--text-diamond); }
#signature-canvas { border: 1px solid var(--border-premium); border-radius: 0.5rem; background-color: var(--background-dark); cursor: crosshair; }
/* PINNACLE PRINTING STYLES */
#print-area { display: none; }
@media print {
    .print-hide { display: none !important; }
    #print-area { display: block !important; }
    body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0 !important; padding: 0 !important; }
    @page {
        size: A4; margin: 2cm;
        @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @top-right { content: "GECAN™ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
    }
    .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; }
    .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
    .p-text { text-align: justify; margin-bottom: 11pt; }
    .p-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
    .p-table th, .p-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
    .p-table th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
    .p-table tr:nth-child(even) td { background-color: #f9f9f9; }
    .p-signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; }
    .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
    .p-signature-label { font-size: 9pt; color: #555; }
    .p-signature-img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
    .p-seal-img { max-height: 80px; max-width: 80px; object-fit: contain; mix-blend-mode: darken; }
    .p-annex-start { page-break-before: always; }
    .p-watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
}
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECAN™ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & CORRECTED) -->
<header class="premium-header p-4 lg:px-6 print-hide">
    <div class="container mx-auto flex items-center justify-between gap-6">
        <div class="flex items-center gap-6 flex-shrink-0">
            <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                <div class="gecan-logo-flipper">
                    <div class="logo-face logo-front">GECAN™</div>
                    <div class="logo-face logo-back">
                        <!-- Placeholder for Base64 image -->
                        <img src="" alt="GECAN Logo">
                    </div>
                </div>
                <div class="logo-separator"></div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                    <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                </div>
            </a>
        </div>
        <!-- DEFINITIVE FIX: The navigation placeholder is restored here -->
        <div id="desktop-nav-placeholder" class="flex-grow">
            <!-- Navigation will be dynamically injected by JavaScript -->
        </div>
    </div>
</header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    

    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FIX: RESTORE THE SUBMISSION MODAL CONTAINER === -->
    <!-- This is the container the JavaScript is trying to open. -->
    <!-- ========================================================================= -->
    <dialog id="submission-modal"></dialog>

    <!-- MODAL & DIALOG CONTAINERS -->
    <dialog id="imfpa-modal"></dialog>
    <!-- II. RE-ENGINEERED MODAL HTML CONTAINERS (ADD THESE TO YOUR MAIN HTML BODY) -->
<dialog id="signature-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="signature-modal-content" class="text-white flex-grow flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-[var(--border-premium)] flex-shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                        <p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p>
                    </div>
                    <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">×</button>
                </div>
                <div>
                    <label for="signature-target-select" class="block text-sm font-semibold text-text-secondary mb-2">Apply signature/seal for:</label>
                    <select id="signature-target-select" class="form-select w-full"></select>
                </div>
            </div>

            <!-- Signing Area -->
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex border-b border-[var(--border-premium)] mb-4">
                    <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                    <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                    <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
                </div>
                <!-- Panels -->
                <div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
                <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div>
                <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex-shrink-0">
                <div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div>
                <button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button>
            </div>
        </div>
    </div>
</dialog>

    
    <!-- ==================================================================================== -->
<!-- === DEFINITIVE NOTIFICATION MODAL (v5.1 - UNIVERSAL REPLACEMENT) === -->
<!-- This is the complete, benchmark-standard modal required for all platform notifications. -->
<!-- ==================================================================================== -->
<dialog id="notification-modal" class="p-0 bg-transparent max-w-lg w-full print-hide">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="notification-modal-content" class="text-white flex flex-col">
            <!-- Dynamic Header: Color changes based on message type -->
            <div id="notification-header" class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)]">
                <div id="notification-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400">
                    <i id="notification-icon" class="fas fa-2x"></i>
                </div>
                <div>
                    <h2 id="notification-title" class="text-2xl font-bold">Notification</h2>
                    <p id="notification-subtitle" class="text-sm text-text-secondary">Please review this message.</p>
                </div>
            </div>

            <!-- Dynamic Content -->
            <div class="p-8 flex-grow">
                <p id="notification-message" class="text-text-secondary leading-relaxed">Message content goes here.</p>
            </div>
            
            <!-- Footer & Action -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end">
                <button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg">OK</button>
            </div>
        </div>
    </div>
</dialog>
   
    
    <dialog id="finalization-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="finalization-modal-content" class="flex flex-col text-white">
             <!-- Header -->
            <div class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)] bg-[var(--background-dark)]/50">
                <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Finalize & Lock Document</h2>
                    <p class="text-sm text-text-secondary">Please confirm this critical, irreversible action.</p>
                </div>
                 <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors ml-auto">×</button>
            </div>
            <!-- Content -->
            <div class="p-8 flex-grow">
                <p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action will:</p>
                <ul class="space-y-4 text-text-primary">
                    <li class="flex items-start gap-3"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Lock Document State:</strong> The current version will be cryptographically fingerprinted to prevent edits.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-project-diagram text-purple-400 mt-1"></i><div><strong>Generate Secure Audit Trail:</strong> An immutable record will be created for all actions.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-paper-plane text-purple-400 mt-1"></i><div><strong>Dispatch to All Parties:</strong> A finalized PDF will be emailed to all signatories.</div></li>
                </ul>
            </div>
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end items-center gap-4">
                <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-red-500/30 px-8 py-2 font-bold shadow-lg shadow-purple-500/20"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button>
            </div>
        </div>
    </div>
</dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
<div id="print-area"></div>
    
    <!-- PREMIUM FOOTER (BENCHMARKED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECAN™ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECAN™ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    

    <script>
        // ====================================================================================
        // === PINNACLE SCRIPT ENGINE v4.0 (BENCHMARKED, RE-ARCHITECTED, & UNABRIDGED) ===
        // This engine is the definitive, production-grade standard for the Toolkits page.
        // ====================================================================================
        
        const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";
        
        // ====================================================================================
        // === SECTION 1: STATE & MODELS (v4.0 - DEFINITIVE & SEVERELY ENHANCED) ===
        // ====================================================================================
        const AppState = {
            isInitialized: false, 
            activeToolkit: 'Dashboard', 
            marketData: [],

            toolkits: {
                Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECAN™ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
                WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Execute advanced on-chain due diligence, risk assessment, and provenance analysis.', color: 'from-sky-500 to-indigo-600' },
                InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
            },
            walletAnalysis: { address: null, report: null, isLoading: false },
            modeler: {
                activeDealType: 'AssetSwap', 
                assetSwap: { amount: 30000, fromAssetKey: 'BTC-USD', toAssetKey: 'USDT-USD' },
                commodityTrade: {
                    assetKey: 'EN590-1MT-USD',
                    quantity: 1, // As specified
                    unitOfMeasure: 'Metric Ton',
                    pricingModel: 'PlattsMinus',
                    priceAdjustmentValue: 0,
                    fixedPrice: 0,
                    isCommissionIncluded: false,
                    commissionValue: 0,
                    isMarkupInPercent: false,
                    markupValue: 0,
                    settlementAssetKey: 'USD'
                },
                cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                sblcMonetization: { faceValue: 100000000, ltv: 80 },
                pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                legal: { totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }
            }
        };

const commodityData = {
            specifications: {
                'EN590-1MT-USD': { uom: 'Metric Ton', spec: '10 PPM Sulphur Gasoil', category: 'Refined Fuel' },
                'D6-GAL-USD': { uom: 'Gallon', spec: 'Virgin D6 Fuel Oil', category: 'Refined Fuel' },
                'WTI-BBL-USD': { uom: 'Barrel', spec: 'West Texas Intermediate Crude', category: 'Crude Oil' },
                'JET-A1-MT-USD': { uom: 'Metric Ton', spec: 'Aviation Turbine Fuel', category: 'Refined Fuel' },
                'AU-KG-USD': { uom: 'Kilogram', spec: '99.99% Au Bullion', category: 'Precious Metal' },
                'GOLD-T-OZ-USD': { uom: 'Troy Ounce', spec: '99.99% Au Bullion', category: 'Precious Metal' },
            },
            pricingModels: {
                'PlattsMinus': { label: 'Market Minus', description: 'Discount Structure', icon: 'fa-minus-circle' },
                'PlattsPlus': { label: 'Market Plus', description: 'Premium Structure', icon: 'fa-plus-circle' },
                'Fixed': { label: 'Fixed Price', description: 'Absolute Value', icon: 'fa-lock' }
            },
            unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
            incoterms: [
                { value: 'EXW', label: 'EXW - Ex Works' }, { value: 'FCA', label: 'FCA - Free Carrier' },
                { value: 'FOB', label: 'FOB - Free on Board' }, { value: 'CFR', label: 'CFR - Cost & Freight' },
                { value: 'CIF', label: 'CIF - Cost, Insurance & Freight' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded' },
                { value: 'DDP', label: 'DDP - Delivered Duty Paid' }
            ],
            countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
            ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
        };

        // ====================================================================================
        // === SECTION 2: UTILITIES (v4.0 - DEFINITIVE & BENCHMARKED) ===
        // ====================================================================================
        const Utils = {
            showNotification: (message, type = 'info', title = null) => {
    const modal = document.getElementById('notification-modal');
    if (!modal) {
        console.error("Notification modal not found in DOM!");
        // Fallback for critical errors when the modal itself is missing.
        alert(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
        return;
    }

    const content = document.getElementById('notification-modal-content');
    const header = document.getElementById('notification-header');
    const iconContainer = document.getElementById('notification-icon-container');
    const icon = document.getElementById('notification-icon');
    const titleEl = document.getElementById('notification-title');
    const subtitleEl = document.getElementById('notification-subtitle');
    const messageEl = document.getElementById('notification-message');
    const okBtn = document.getElementById('notification-ok-btn');

    // A single source of truth for notification types.
    const types = {
        success: { iconClass: 'fa-check-circle', defaultTitle: 'Success', subtitle: 'The operation completed successfully.', baseClass: 'green' },
        error: { iconClass: 'fa-exclamation-triangle', defaultTitle: 'Error', subtitle: 'An error has occurred.', baseClass: 'red' },
        warning: { iconClass: 'fa-exclamation-circle', defaultTitle: 'Warning', subtitle: 'Please review this message.', baseClass: 'yellow' },
        info: { iconClass: 'fa-info-circle', defaultTitle: 'Information', subtitle: 'System Notification.', baseClass: 'blue' }
    };

    const config = types[type] || types.info;

    // Apply dynamic content
    titleEl.textContent = title || config.defaultTitle;
    subtitleEl.textContent = config.subtitle;
    messageEl.textContent = message;
    icon.className = `fas ${config.iconClass} fa-2x`;

    // Apply dynamic styling using Tailwind classes for consistency and maintainability.
    const colorClasses = {
        header: `bg-${config.baseClass}-500/10 border-${config.baseClass}-500/20`,
        icon: `bg-gradient-to-br from-${config.baseClass}-400 to-${config.baseClass}-600`,
        button: `bg-gradient-to-r from-${config.baseClass}-500 to-${config.baseClass}-700 border-${config.baseClass}-500`
    };

    // Remove old color classes before adding new ones
    header.className = `p-6 flex items-center gap-4 border-b ${colorClasses.header}`;
    iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400 ${colorClasses.icon}`;
    okBtn.className = `btn-primary px-8 py-2 font-bold shadow-lg ${colorClasses.button}`;
    
    // Attach a one-time event listener to the OK button to close the modal.
    okBtn.onclick = () => modal.close();
    
    // Show the modal.
    if (!modal.hasAttribute('open')) {
        modal.showModal();
    }
},
            formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
            formatNumber: (num, decimals = 2) => {
                if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
                if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
                return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            },
            debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
            getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
            getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
            getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
            calculateTimeAgo: (timestamp) => {
                const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Just now'; if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`;
                return new Date(timestamp).toLocaleDateString();
            }
        };

        // ====================================================================================
        // === SECTION 3: CORE LOGIC CONTROLLER (v4.0 - DEFINITIVE & UNABRIDGED) ===
        // ====================================================================================
        const Logic = {
            createApiRequest: async (action, method = 'GET', params = {}) => {
                const url = new URL(API_URL); url.searchParams.append('action', action);
                const options = { method: method.toUpperCase(), redirect: 'follow' };
                if (options.method === 'GET') { Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v)); } 
                else { options.body = JSON.stringify({ action, data: params }); options.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                    const result = await response.json();
                    if (result.success === false) throw new Error(result.error || 'Server error.');
                    return result.data || result.message || result;
                } catch (error) { console.error(`API Error for '${action}':`, error); throw error; }
            },

            init: async () => {
    UI.init();
    // DEFINITIVE FIX: Restore the call to populate navigation links on page load.
    UI.populateNavLinks(); 
    Logic.initMobileUI();
    Logic.setupEventListeners();
    try {
        const [marketData, themeJson] = await Promise.all([
            Logic.createApiRequest('getMarketMatrixData'),
            Logic.createApiRequest('getActiveThemeConfig').catch(() => null)
        ]);
        if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) {} }
        if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
        AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
const allAssets = AppState.marketData;
        const btcExists = allAssets.some(a => a.key === 'BTC-USD');
        const usdtExists = allAssets.some(a => a.key === 'USDT-USD');

        if (btcExists && usdtExists) {
            // If both required assets are available, we ensure the state is correctly set.
            // This is robust even if the AppState default was different.
            AppState.modeler.assetSwap.fromAssetKey = 'BTC-USD';
            AppState.modeler.assetSwap.toAssetKey = 'USDT-USD';
        } else {
            // Military-Grade Fallback: If BTC or USDT are not available in the API data,
            // fall back to the first two swappable assets to prevent a blank/broken state.
            const swappable = allAssets.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
            if (swappable.length >= 2) {
                AppState.modeler.assetSwap.fromAssetKey = swappable[0].key;
                AppState.modeler.assetSwap.toAssetKey = swappable[1].key;
            }
        }
        
        AppState.isInitialized = true;
        document.getElementById('initial-loader').style.display = 'none';
        UI.renderActiveToolkit();
    } catch (err) { Logic.onDataError(err); }
},
            onDataError: (error) => {
                console.error("CRITICAL FAILURE:", error);
                Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
                document.getElementById('initial-loader').innerHTML = `<div class="text-center text-red-400">Platform Initialization Failed.</div>`;
            },
            initMobileUI: () => {
    const fab = document.getElementById('mobile-fab'), 
          sidebar = document.getElementById('mobile-sidebar'), 
          overlay = document.getElementById('mobile-sidebar-overlay'), 
          closeBtn = document.getElementById('mobile-sidebar-close-btn');
          
    const openSidebar = () => { 
        // DEFINITIVE FIX: Ensure nav links are populated every time the mobile menu is opened.
        UI.populateNavLinks(); 
        sidebar.classList.remove('-left-full'); 
        sidebar.classList.add('left-0'); 
        overlay.classList.remove('hidden'); 
        document.body.classList.add('mobile-sidebar-open'); 
    };
    const closeSidebar = () => { 
        sidebar.classList.add('-left-full'); 
        sidebar.classList.remove('left-0'); 
        overlay.classList.add('hidden'); 
        document.body.classList.remove('mobile-sidebar-open'); 
    };
    
    fab.addEventListener('click', openSidebar); 
    overlay.addEventListener('click', closeSidebar); 
    closeBtn.addEventListener('click', closeSidebar);
},
            setupEventListeners: () => {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'WalletForensics','3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } }
                });
            },
            setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
            bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
            
            // --- Wallet Forensics Logic (Unabridged) ---
            // --- Wallet Forensics Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Wallet Forensics toolkit.
 * This function is called once when the toolkit becomes active.
 */
bindWalletForensicsEvents: () => {
    const checkBtn = document.getElementById('check-wallet-btn');
    const addressInput = document.getElementById('wallet-address-input');
    
    // Robustness: Ensure elements exist before binding to prevent runtime errors.
    if(checkBtn) {
        checkBtn.addEventListener('click', Logic.runWalletForensics);
    }
    if(addressInput) {
        addressInput.addEventListener('keypress', e => { 
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission if it's inside a form
                Logic.runWalletForensics(); 
            }
        });
    }
},

/**
 * Orchestrates the entire wallet analysis process, from user input to displaying the final report.
 * It manages application state, provides premium loading feedback, and handles all API communication.
 */
runWalletForensics: () => {
    const addressInput = document.getElementById('wallet-address-input');
    if (!addressInput) return; // Safeguard
    
    const address = addressInput.value.trim();
    if (!address) {
        return Utils.showNotification("Please enter a wallet address to analyze.", 'warning', 'Input Required');
    }
    
    // 1. Set application state to loading and trigger a UI re-render.
    AppState.walletAnalysis = { address, report: null, isLoading: true };
    UI.renderActiveToolkit();

    // 2. Initialize the premium, multi-stage loading text spinner.
    const spinnerTexts = [
        "Connecting to blockchain networks...", 
        "Fetching on-chain transaction history...", 
        "Querying GECAN proprietary intelligence ledger...", 
        "Running institutional compliance checks...", 
        "Synthesizing on-chain and proprietary intel...", 
        "Calculating multi-vector risk scores...", 
        "Generating definitive wallet classification..."
    ];
    let textIndex = 0;
    
    // This interval provides dynamic feedback to the user during the analysis process.
    const textInterval = setInterval(() => {
        const spinnerEl = document.getElementById('spinner-text');
        // The interval only updates the text if the spinner is still visible and the app is loading.
        if (spinnerEl && AppState.walletAnalysis.isLoading) {
            spinnerEl.style.opacity = '0';
            setTimeout(() => { 
                spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; 
                spinnerEl.style.opacity = '1';
            }, 300); // Wait for fade-out before changing text and fading in.
        } else {
            clearInterval(textInterval); // Stop the interval if loading is complete.
        }
    }, 2500);

    // 3. Execute the API request to the backend.
    Logic.createApiRequest('getWalletForensicsReport', 'GET', { address })
        .then(report => {
            // On success, update the state with the complete report.
            AppState.walletAnalysis.report = report;
        })
        .catch(err => {
            // On failure, create a structured error object in the state.
            AppState.walletAnalysis.report = { 
                success: false, 
                error: { message: err.message || 'An unknown analysis error occurred.' } 
            };
        })
        .finally(() => {
            // This block runs regardless of success or failure.
            AppState.walletAnalysis.isLoading = false;
            clearInterval(textInterval); // CRITICAL: Ensure the interval is always cleared.
            UI.renderActiveToolkit(); // Re-render the UI to display the report or error message.
            
            // If the report is successful, trigger the animations for the score gauges.
            if (AppState.walletAnalysis.report && AppState.walletAnalysis.report.success) {
                Logic.animateReportElements();
            }
        });
},

/**
 * Triggers the CSS animation for the SVG score gauges after they are rendered.
 */
animateReportElements: () => {
    // A short delay ensures elements are fully in the DOM before animation starts.
    setTimeout(() => {
        document.querySelectorAll('.score-gauge-fg').forEach(gauge => {
            if (gauge.dataset.score) {
                gauge.style.strokeDasharray = `${gauge.dataset.score}, 100`;
            }
        });
    }, 200);
},

/**
 * Generates the correct block explorer URL for a given wallet type and address/transaction.
 * @param {object} wallet - The wallet object from the report, containing address and type.
 * @param {string} [txHash=''] - An optional transaction hash.
 * @returns {string} The full URL to the block explorer.
 */
getExplorerUrl: (wallet, txHash = '') => {
    if (!wallet || !wallet.type) return '#';
    
    const explorers = {
        BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' },
        ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' },
        TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' }
    };

    const explorer = explorers[wallet.type.toUpperCase()];
    if (!explorer) return '#'; // Fallback for unknown types.

    return txHash ? explorer.tx + txHash : explorer.addr + wallet.address;
},

/**
 * Copies text to the user's clipboard and provides instant visual feedback.
 * @param {string} text - The text to copy.
 * @param {HTMLElement} element - The button element that was clicked, used to find the feedback span.
 */
copyToClipboard: (text, element) => {
    navigator.clipboard.writeText(text).then(() => {
        const feedback = element.querySelector('.copied-feedback');
        if (feedback) {
            feedback.style.opacity = '1';
            setTimeout(() => { feedback.style.opacity = '0'; }, 1500);
        }
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        Utils.showNotification('Could not copy to clipboard.', 'error');
    });
},

/**
 * Generates a dynamic, human-readable executive summary from the raw report data.
 * This is the definitive, pinnacle-grade implementation.
 * @param {object} report - The full report object from the backend.
 * @returns {string} An HTML string containing the formatted summary.
 */
generateExecutiveSummary: (report) => {
    if (!report || !report.analysis || !report.wallet) {
        return '<p class="text-error-color">Could not generate summary due to incomplete report data.</p>';
    }

    const { analysis, wallet, provenance } = report;
    let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="${Utils.getRiskClass(analysis.riskLevel)} text-risk-color">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `;
    
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN' && c.toUpperCase() !== 'CONFIDENTIAL'))];

    if (provenance.records && provenance.records.length > 0) {
        summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `;
        if (uniqueControllers.length > 1) {
            summary += `<strong class="text-critical-color">Critically, it has ${uniqueControllers.length} conflicting alleged controllers: ${uniqueControllers.slice(0, 2).join(', ')}${uniqueControllers.length > 2 ? '...' : ''}.</strong> `;
        } else if (uniqueControllers.length === 1) {
            summary += `A single controller, <strong>${uniqueControllers[0]}</strong>, is consistently reported. `;
        } else {
            summary += `However, no specific controller name is consistently recorded. `;
        }
    } else {
        summary += `There is <strong class="text-error-color">no provenance history</strong> in the GECAN Ledger, making ownership unverifiable. `;
    }

    if (analysis.redFlags && analysis.redFlags.length > 0) {
        const criticalFlagsCount = analysis.redFlags.filter(f => f.level === 'CRITICAL').length;
        if (criticalFlagsCount > 0) {
            summary += `The analysis identified <strong class="text-critical-color">${criticalFlagsCount} CRITICAL flag(s)</strong> requiring immediate attention. `;
        } else {
            summary += `The analysis identified <strong class="text-warning-color">${analysis.redFlags.length} minor flag(s)</strong>. `;
        }
    } else {
        summary += `<strong class="text-success-color">No major compliance flags</strong> were detected during on-chain analysis. `;
    }

    const isCompliant = analysis.redFlags.every(flag => flag.category !== 'INSTITUTIONAL');
    if (wallet.type !== 'BITCOIN') {
        summary += isCompliant
            ? `The wallet <strong class="text-success-color">meets</strong> the GECAN institutional requirements for balance and transaction history. `
            : `The wallet <strong class="text-error-color">does not meet</strong> GECAN institutional requirements. `;
    }
    
    summary += `Final recommendation is to proceed with ${analysis.riskLevel === 'LOW' ? 'standard due diligence' : '<strong>enhanced caution and verification</strong>'}.`;
    return summary;
},

            /**
     * [NEW & SEVERELY UPGRADED] Handles the premium PDF generation and download workflow.
     */
    generateAndDownloadForensicsPDF: () => {
        const btn = document.getElementById('pdf-export-btn');
        if (!btn || btn.disabled) return;

        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating...`;

        const reportData = AppState.walletAnalysis.report;
        if (!reportData || !reportData.success) {
            Utils.showNotification('Error: Could not find valid report data to generate PDF.', 'error');
            btn.disabled = false; btn.innerHTML = originalContent;
            return;
        }

        Logic.createApiRequest('generateWalletForensicsPdf', 'POST', { report: reportData })
            .then(Logic.downloadPdf)
            .catch(error => Utils.showNotification(error.message || 'PDF generation failed.', 'error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    },

    /**
     * [NEW & BENCHMARKED] Helper function to trigger a browser download from Base64 data.
     */
    downloadPdf: (response) => {
        if (!response || !response.pdfData) {
            throw new Error('Failed to receive valid PDF data from server.');
        }
        const link = document.createElement('a');
        link.href = `data:application/pdf;base64,${response.pdfData}`;
        link.download = response.fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        Utils.showNotification('Report downloaded successfully!', 'success');
    },

    /**
     * [NEW & BENCHMARKED] Initiates the first step of the official submission process: the referral ID modal.
     */
    initiateWalletSubmission: () => {
    // Target the correct modal ID. This ID must exist in your HTML body.
    const modal = document.getElementById('submission-modal');
    if (!modal) {
        console.error("CRITICAL FAILURE: The #submission-modal container is missing from the HTML body.");
        Utils.showNotification("UI Error: Cannot open submission suite.", "error");
        return;
    }
    
    // Render the first step (Referral Validation) into the modal.
    modal.innerHTML = UI.renderReferralValidationSuite(
        'Secure Submission Protocol', 
        'A valid Partner Referral ID is required to submit this wallet to the GECAN ledger for official review.'
    );
    
    // Show the modal.
    modal.showModal();
    
    // Attach the event listener to the "Validate" button inside the newly rendered modal.
    document.getElementById('validate-referral-btn').addEventListener('click', Logic.validateSubmissionReferralId);
},


    /**
     * [NEW & BENCHMARKED] Validates the entered referral ID. On success, transitions to the full engagement suite.
     */
    validateSubmissionReferralId: () => {
    const btn = document.getElementById('validate-referral-btn');
    const input = document.getElementById('referral-id-input');
    const errorDiv = document.getElementById('referral-error');
    if (!btn || !input || !errorDiv) return;

    const referralId = input.value.trim();
    if (!referralId) {
        errorDiv.textContent = 'Referral ID cannot be empty.';
        errorDiv.classList.remove('hidden');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';
    Utils.showNotification('Validating Referral ID with GECAN servers...', 'info');

    Logic.createApiRequest('validateReferralId', 'POST', { referralId })
        .then(validationResult => {
            if (validationResult.isValid) {
                Utils.showNotification('Referral ID Validated Successfully!', 'success');
                const modal = document.getElementById('submission-modal');
                // On success, render the full submission suite inside the same modal.
                modal.innerHTML = UI.renderWalletSubmissionSuite(validationResult);
                Logic.populateOfferIdDropdown();
                document.getElementById('wallet-submission-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    Logic.submitWalletForReview(validationResult);
                });
            } else {
                throw new Error('Invalid or inactive Referral ID. Please check the code and try again.');
            }
        })
        .catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key mr-2"></i>Validate & Proceed';
        });
},

            /**
     * [NEW] Fetches the list of active offers and populates the dropdown in the submission form.
     */
    populateOfferIdDropdown: async () => {
        const select = document.getElementById('submission-offer-id');
        if (!select) return;
        try {
            const offers = await Logic.createApiRequest('getOfferListForNcnda', 'GET');
            select.innerHTML = '<option value="GENERAL">General Submission (Not for a specific offer)</option>' +
                offers.map(offer => `<option value="${offer.offerId}">${offer.offerId} - ${offer.description}</option>`).join('');
        } catch (error) {
            console.error("Failed to fetch offer list for submission form:", error);
            select.innerHTML = '<option value="">Error loading offers</option>';
        }
    },
    

    /**
     * [NEW & BENCHMARKED] Gathers all submission form data and sends it to the backend.
     */
    submitWalletForReview: (referralInfo) => {
    const submitBtn = document.getElementById('confirm-submission-btn');
    if (!submitBtn) return;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting to GECAN Compliance...';

    // 1. Gather all data from the detailed form.
    const submissionData = {
        report: AppState.walletAnalysis.report, // Attach the full forensics report.
        referralInfo: referralInfo,
        targetOfferId: document.getElementById('submission-offer-id').value,
        submitter: {
            name: document.getElementById('submitter-name').value,
            role: document.getElementById('submitter-role').value,
            email: document.getElementById('submitter-email').value,
            phone: document.getElementById('submitter-phone').value,
        },
        controller: {
            name: document.getElementById('controller-name').value,
        },
        // In a future version, you could add file processing logic here.
    };

    // 2. DEFINITIVE FIX: Call the new backend API endpoint.
    Logic.createApiRequest('submitWalletForReview', 'POST', submissionData)
        .then(successMessage => {
            // On success, show the confirmation from the server and close the modal.
            Utils.showNotification(successMessage, 'success', 'Submission Sent');
            document.getElementById('submission-modal').close();
        })
        .catch(error => {
            // On failure, show a detailed error message.
            Utils.showNotification(error.message, 'error', 'Submission Failed');
        })
        .finally(() => {
            // Always re-enable the button, regardless of outcome.
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm & Submit to Ledger';
        });
},
            
            // --- Institutional Modeler Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Institutional Modeler toolkit.
 * This function is called once when the toolkit becomes active, using efficient
 * event delegation on the main input container to handle all dynamic changes.
 */
bindInstitutionalModelerEvents: () => {
    Logic.updateModelerUI(true);
    const inputContainer = document.getElementById('modeler-input-container');
    if (inputContainer) {
        inputContainer.addEventListener('input', Utils.debounce((e) => {
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        }, 250));
        inputContainer.addEventListener('change', (e) => { // For selects and radios
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        });
    }
},

/**
 * Handles the logic for switching between different deal types (e.g., Asset Swap, Commodity Trade).
 * It updates the application state and triggers a full re-render of the toolkit UI.
 * @param {string} newDealType - The ID of the toolkit to activate (e.g., 'AssetSwap').
 */
handleDealTypeChange: (newDealType) => {
    if (AppState.modeler.activeDealType === newDealType) return;
    AppState.modeler.activeDealType = newDealType;
    UI.renderActiveToolkit();
},

/**
 * Master handler for all user input within the modeler. It uses a `data-path`
 * attribute on form elements to dynamically and safely update the nested `AppState.modeler` object.
 * @param {Event} e - The input or change event object.
 */
handleModelerInputChange: (e) => {
    const { dataset, value, type, checked } = e.target;
    const path = dataset.path;
    if (!path) return;

    if (path === 'commodityTrade.assetKey') {
        Logic.handleCommodityChange(value);
        return;
    }

    try {
        const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean);
        let targetObject = AppState.modeler;
        for (let i = 0; i < pathKeys.length - 1; i++) {
            targetObject = targetObject[pathKeys[i]];
        }
        const finalKey = pathKeys[pathKeys.length - 1];
        let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
        targetObject[finalKey] = processedValue;
        Logic.updateModelerUI(false);
    } catch (error) {
        console.error(`Failed to update modeler state for path: ${path}`, error);
        Utils.showNotification("An internal error occurred while updating the model.", 'error');
    }
},

/**
 * A specialized handler that triggers when the main commodity asset is changed.
 * It intelligently updates related fields like 'Unit of Measure' to maintain data consistency.
 * @param {string} assetKey - The new commodity asset key (e.g., 'WTI-BBL-USD').
 */
            handleCommodityChange: (assetKey) => {
                const commodityState = AppState.modeler.commodityTrade;
                commodityState.assetKey = assetKey;
                
                // Use the new, reliable data source.
                const spec = commodityData.specifications[assetKey];
                if (spec) {
                    // This is the real-time update logic.
                    commodityState.unitOfMeasure = spec.uom;
                }
                
                // A full UI refresh guarantees all panels reflect the new data.
                Logic.updateModelerUI(true);
            },

/**
 * Placeholder for launching a future deep-dive analysis suite. For now, it provides
 * a premium, user-friendly notification about the feature's status.
 */
launchInstitutionalAnalysis: () => {
    Utils.showNotification(
        `The full Institutional Analysis Suite is in development. This panel will provide deep-dive analytics, counterparty risk assessment, and regulatory compliance checklists for the structured deal.`,
        'info',
        'Feature Coming Soon'
    );
},
            /**
 * Updates the Institutional Modeler's UI. Can perform a full refresh of the input panel
 * or a more performant partial refresh of only the output panel.
 * @param {boolean} [isFullRefresh=false] - If true, re-renders the entire input panel.
 */
updateModelerUI: (isFullRefresh = false) => {
    if (isFullRefresh) {
        const inputContainer = document.getElementById('modeler-input-container');
        if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
    }
    const calculation = Logic.calculateModel();
    const outputContainer = document.getElementById('modeler-output-container');
    if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
},

/**
 * Master calculation engine. It acts as a router, calling the specific calculation
 * function for the active deal type and then layering on the universal pricing
 * and commission calculations.
 * @returns {object|null} A comprehensive object with all calculated deal metrics, or null if calculation fails.
 */
            calculateModel: () => {
                const { activeDealType, pricingConfig } = AppState.modeler;
                const calculationFunc = Logic[`calculate${activeDealType}`];
                if (!calculationFunc) return null;
            
                const dealCalc = calculationFunc();
                if (!dealCalc) return null;

                // --- NATIVE ASSET CALCULATION PIPELINE ---
                const { primaryValue: baseValueInToAsset, toAsset } = dealCalc;
            
                const grossConfigValue = parseFloat(String(pricingConfig.grossValue).replace(/,/g, '')) || 0;
                const netConfigValue = parseFloat(String(pricingConfig.netValue).replace(/,/g, '')) || 0;
            
                // Calculate gross/net amounts DIRECTLY in the native 'To Asset' currency
                const grossOfferInToAsset = pricingConfig.isValueInPercent ? baseValueInToAsset * (grossConfigValue / 100) : grossConfigValue;
                const netToBuyerInToAsset = pricingConfig.isValueInPercent ? baseValueInToAsset * (netConfigValue / 100) : netConfigValue;
            
                // Apply discount/premium DIRECTLY to the native 'To Asset' currency
                let finalValueToBuyerInToAsset;
                if (pricingConfig.offerType === 'discount') {
                    finalValueToBuyerInToAsset = baseValueInToAsset - netToBuyerInToAsset;
                } else { // 'premium'
                    finalValueToBuyerInToAsset = baseValueInToAsset + netToBuyerInToAsset;
                }
            
                // Calculate commission DIRECTLY in the native 'To Asset' currency
                const totalCommissionInToAsset = Math.max(0, grossOfferInToAsset - netToBuyerInToAsset);

                // --- BACKGROUND USD CONVERSION (FOR IMFPA ONLY) ---
                // Convert the native commission value to USD for the IMFPA state.
                const totalCommissionPoolUSD = totalCommissionInToAsset * (toAsset.price || 0);
                AppState.modeler.legal.totalCommission = totalCommissionPoolUSD;
            
                return {
                    ...dealCalc,
                    baseValueInToAsset,
                    finalValueToBuyerInToAsset,
                    totalCommissionInToAsset,
                    netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}% Net ${pricingConfig.offerType}`,
                    grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}% Gross ${pricingConfig.offerType}`
                };
            },

/**
 * Calculates the specifics for an Asset Swap deal.
 * @returns {object} An object containing the calculated metrics for the swap.
 */
            calculateAssetSwap: () => {
                const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
                const fromAsset = Utils.getAssetByKey(fromAssetKey);
                const toAsset = Utils.getAssetByKey(toAssetKey);
                const amountToGive = parseFloat(String(amount).replace(/,/g, '')) || 0;
            
                const usdEquivalent = amountToGive * (fromAsset.price || 0);
                const directRate = (toAsset.price > 0) ? (fromAsset.price || 0) / toAsset.price : 0;
                const inverseRate = (fromAsset.price > 0) ? (toAsset.price || 0) / fromAsset.price : 0;
                const primaryValue = amountToGive * directRate;
            
                return { 
                    primaryValue: primaryValue,
                    primaryUnit: toAsset.baseAsset,
                    dealTitle: `${Utils.formatNumber(amountToGive, 4)} ${fromAsset.baseAsset} to ${toAsset.baseAsset}`,
                    usdEquivalent: usdEquivalent,
                    fromAsset: fromAsset,
                    toAsset: toAsset,
                    amountToGive: amountToGive,
                    // --- DEFINITIVE FIX IS HERE ---
                    directRate: directRate,     // This value is now correctly included
                    inverseRate: inverseRate,   // This value is now correctly included
                    // -----------------------------
                    finalValueToBuyerUSD: 0,
                    totalCommissionPool: 0
                };
            },

/**
 * Calculates the specifics for a physical Commodity Trade deal.
 * @returns {object} An object containing the calculated metrics for the trade.
 */
            calculateCommodityTrade: () => {
                const state = AppState.modeler.commodityTrade;
                if (!state.assetKey || !state.quantity || state.quantity <= 0) {
                    return { isValid: false, error: 'Invalid commodity or quantity' };
                }
                const commodityAsset = Utils.getAssetByKey(state.assetKey);
                const settlementAsset = Utils.getAssetByKey(state.settlementAssetKey) || { baseAsset: 'USD', price: 1 };
                if (!commodityAsset) {
                    return { isValid: false, error: 'Commodity asset not found' };
                }
                const marketPriceUSD = commodityAsset.price || 0;
                let netPricePerUnitUSD = 0;
                switch (state.pricingModel) {
                    case 'Fixed': netPricePerUnitUSD = Math.max(0, parseFloat(state.fixedPrice) || 0); break;
                    case 'PlattsMinus': netPricePerUnitUSD = Math.max(0, marketPriceUSD - (Math.max(0, parseFloat(state.priceAdjustmentValue) || 0))); break;
                    case 'PlattsPlus': netPricePerUnitUSD = marketPriceUSD + (Math.max(0, parseFloat(state.priceAdjustmentValue) || 0)); break;
                    default: netPricePerUnitUSD = marketPriceUSD;
                }
                let finalPricePerUnitUSD = 0;
                let commissionPerUnitUSD = 0;
                const quantity = parseFloat(state.quantity) || 0;
                if (state.isCommissionIncluded) {
                    finalPricePerUnitUSD = netPricePerUnitUSD;
                    commissionPerUnitUSD = Math.max(0, parseFloat(state.commissionValue) || 0);
                } else {
                    const markupValue = parseFloat(state.markupValue) || 0;
                    const markupAmount = state.isMarkupInPercent ? netPricePerUnitUSD * (Math.abs(markupValue) / 100) : Math.abs(markupValue);
                    finalPricePerUnitUSD = netPricePerUnitUSD + markupAmount;
                    commissionPerUnitUSD = markupAmount;
                }
                const totalFinalValueUSD = finalPricePerUnitUSD * quantity;
                const totalCommissionUSD = commissionPerUnitUSD * quantity;
                const conversionRate = settlementAsset.price || 1;
                const primaryValue = totalFinalValueUSD / conversionRate;
                const totalCommissionInSettlement = totalCommissionUSD / conversionRate;
                const currentUnitOfMeasure = commodityData.specifications[state.assetKey]?.uom || state.unitOfMeasure;
                return {
                    isValid: true,
                    primaryValue: primaryValue,
                    primaryUnit: settlementAsset.baseAsset,
                    dealTitle: `${Utils.formatNumber(quantity)} ${currentUnitOfMeasure} of ${commodityAsset.baseAsset}`,
                    usdEquivalent: totalFinalValueUSD,
                    toAsset: settlementAsset,
                    totalCommissionInSettlement: totalCommissionInSettlement,
                    commissionPerUnitUSD: commissionPerUnitUSD,
                    netPricePerUnitUSD: netPricePerUnitUSD,
                    finalPricePerUnitUSD: finalPricePerUnitUSD,
                    marketPriceUSD: marketPriceUSD,
                    unitOfMeasure: currentUnitOfMeasure
                };
            },

resetCommodityTrade: () => {
                AppState.modeler.commodityTrade = {
                    assetKey: 'EN590-1MT-USD',
                    quantity: 1,
                    unitOfMeasure: 'Metric Ton',
                    pricingModel: 'PlattsMinus',
                    priceAdjustmentValue: 0,
                    fixedPrice: 0,
                    isCommissionIncluded: false,
                    commissionValue: 0,
                    isMarkupInPercent: false,
                    markupValue: 0,
                    settlementAssetKey: 'USD'
                };
                Logic.updateModelerUI(true);
            },
            
/**
 * Calculates the specifics for a Crypto-Collateralized Loan.
 * @returns {object} An object containing the calculated metrics for the loan.
 */
            calculateCryptoLoan: () => {
                const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
                const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
                const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0);
                const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100);
                const totalRepayment = loanPrincipal + (loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12));
            
                return {
                    primaryValue: loanPrincipal,
                    primaryUnit: loanCurrency,
                    dealTitle: `Loan against ${collateralAsset.baseAsset}`,
                    usdEquivalent: loanPrincipal, // For a USD loan, the value and equivalent are the same.
                    toAsset: { baseAsset: loanCurrency, price: 1 }, // Mock `toAsset` for compatibility
                    // Additional properties for the custom analysis panel
                    totalRepayment: totalRepayment,
                    tenureMonths: tenureMonths,
                    interestRateValue: interestRateValue,
                    loanCurrency: loanCurrency,
                    finalValueToBuyerUSD: 0,
                    totalCommissionPool: 0
                };
            },
            /**
 * Calculates the specifics for SBLC Monetization.
 * @returns {object} An object containing the calculated metrics for the monetization deal.
 */
            calculateSBLCMonetization: () => {
                const { faceValue, ltv } = AppState.modeler.sblcMonetization;
                const monetizedValue = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
                
                return { 
                    primaryValue: monetizedValue,
                    primaryUnit: 'USD',
                    dealTitle: `LTV on ${Utils.formatPrice(faceValue)} SBLC`,
                    usdEquivalent: monetizedValue,
                    toAsset: { baseAsset: 'USD', price: 1 }, // Mock `toAsset` for compatibility
                    finalValueToBuyerUSD: 0,
                    totalCommissionPool: 0
                };
            },

/**
 * Resets the entire Institutional Modeler state to its default configuration.
 * This function performs a deep-clone reset to prevent any reference-related bugs
 * and ensures a clean slate for the user.
 */
            resetModelerState: () => {
                // 1. Preserve the current view context BEFORE resetting the state. This is the critical fix.
                const currentActiveDealType = AppState.modeler.activeDealType;

                // 2. Define the pristine, default state for all parameters.
                const defaultState = {
                    activeDealType: 'AssetSwap', // This will be overwritten by the preserved context
                    assetSwap: { 
                        amount: 30000, 
                        fromAssetKey: 'BTC-USD', 
                        toAssetKey: 'USDT-USD' 
                    },
                    commodityTrade: {
                        assetKey: 'EN590-1MT-USD',
                        quantity: 1,
                        unitOfMeasure: 'Metric Ton',
                        pricingModel: 'PlattsMinus',
                        priceAdjustmentValue: 0,
                        fixedPrice: 0,
                        isCommissionIncluded: false,
                        commissionValue: 0,
                        isMarkupInPercent: false,
                        markupValue: 0,
                        settlementAssetKey: 'USD'
                    },
                    cryptoLoan: { 
                        collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', 
                        ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 
                    },
                    sblcMonetization: { 
                        faceValue: 100000000, ltv: 80 
                    },
                    pricingConfig: { 
                        isVisible: false, offerType: 'discount', grossValue: 0, 
                        netValue: 0, isValueInPercent: true 
                    },
                    legal: { 
                        totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', 
                        spaReferenceCode: '', groups: [] 
                    }
                };

                // Perform the deep clone to reset all parameters to their defaults.
                AppState.modeler = JSON.parse(JSON.stringify(defaultState));
                
                // 3. Restore the preserved view context. This ensures the user stays on the correct panel.
                AppState.modeler.activeDealType = currentActiveDealType;
                
                // Trigger a full UI re-render, which will now correctly display the reset version of the current panel.
                Logic.updateModelerUI(true);
                
                // Provide user feedback.
                Utils.showNotification('Institutional Modeler has been reset to its default state.', 'info', 'Modeler Reset');
            },

/**
 * Swaps the 'from' and 'to' assets in the Asset Swap modeler.
 * It intelligently recalculates the 'from' amount to preserve the total USD value of the deal.
 */
swapAssets: () => {
    const swapState = AppState.modeler.assetSwap;
    
    // Retrieve full asset data to ensure prices are current.
    const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey);
    const toAsset = Utils.getAssetByKey(swapState.toAssetKey);

    // Recalculate the 'amount' field to maintain the same total USD value after the swap.
    if (fromAsset.price > 0 && toAsset.price > 0) {
        const totalUsdValue = (parseFloat(swapState.amount) || 0) * fromAsset.price;
        // The new 'amount' will be what the total USD value can buy of the *new* 'from' asset.
        swapState.amount = totalUsdValue / toAsset.price; 
    }

    // Perform the actual swap of the asset keys in the state.
    [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
    
    // Trigger the premium 3D icon animation for visual feedback.
    const icon = document.getElementById('swap-icon');
    if (icon) {
        // This technique forces a CSS animation restart.
        icon.style.animation = 'none';
        void icon.offsetWidth; // Trigger reflow
        icon.style.animation = 'swap-icon-spin 0.5s ease-in-out';
    }
    
    // Trigger a full UI update to reflect the swapped assets and recalculated amount.
    Logic.updateModelerUI(true);
},

/**
 * Toggles the visibility of the advanced pricing configuration panel in the UI.
 */
togglePricingConfig: () => {
    // Directly mutate the state.
    AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible;
    
    // Trigger a full UI update (`true`) to re-render the input panel with the
    // now-visible (or hidden) pricing configuration section. This ensures
    // the collapsible animation works correctly.
    Logic.updateModelerUI(true);
},
            
// ========================================================================================
// === PINNACLE NCNDA/IMFPA & DOCUMENT EXECUTION SUITE ENGINE (v10.0 - FINAL & UNABRIDGED) ===
// This is the definitive, military-grade logic and UI for the entire contract workflow.
// ========================================================================================

// --- A. SEVERELY OVERHAULED LOGIC ---
            openImfpaModal: () => {
                const modal = document.getElementById('imfpa-modal');
                if (!modal) return console.error("CRITICAL: IMFPA modal container not found.");
                if (AppState.modeler.legal.agreementType === undefined) AppState.modeler.legal.agreementType = 'IMFPA';
                if (AppState.modeler.legal.autoBalance === undefined) AppState.modeler.legal.autoBalance = true;
                modal.innerHTML = UI.renderImfpaModal();
                Logic.refreshImfpaModalUI();
                modal.showModal();
            },
            refreshImfpaModalUI: () => {
                const { legal } = AppState.modeler;
                const groupsContainer = document.getElementById('imfpa-groups-container');
                const legalPartiesContainer = document.getElementById('imfpa-legal-parties');
                if (groupsContainer) groupsContainer.innerHTML = UI.renderImfpaGroups();
                if (legalPartiesContainer) {
                    const allParties = legal.groups.flatMap(g => g.parties);
                    legalPartiesContainer.innerHTML = allParties.length > 0 ? allParties.map(p => `<div><i class="fas fa-user-check text-premium-gold mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('') : '<p class="text-xs text-premium-text-secondary">No signatory parties defined.</p>';
                }
                const modalContent = document.getElementById('imfpa-modal');
                if (modalContent) {
                    modalContent.removeEventListener('input', Logic.handleModelerInputChangeInModal);
                    modalContent.removeEventListener('change', Logic.handleModelerInputChangeInModal);
                    modalContent.addEventListener('input', Logic.handleModelerInputChangeInModal);
                    modalContent.addEventListener('change', Logic.handleModelerInputChangeInModal);
                }
                Logic.updateImfpaCalculations();
                Logic.updateContractPreview();
            },
            handleModelerInputChangeInModal: (e) => {
                Logic.handleModelerInputChange(e);
                Logic.updateImfpaCalculations();
                Logic.updateContractPreview();
                Logic.updateSynthesizeButtonState(); // <-- ADD THIS LINE
            },
            toggleAgreementType: (isImfpa) => {
                AppState.modeler.legal.agreementType = isImfpa ? 'IMFPA' : 'NCNDA';
                const commissionSection = document.getElementById('commission-allocation-section');
                if (commissionSection) commissionSection.classList.toggle('hidden', !isImfpa);
                const labels = document.querySelectorAll('.agreement-toggle .toggle-label');
                labels[0].classList.toggle('active', !isImfpa); labels[0].classList.toggle('text-gray-500', isImfpa);
                labels[1].classList.toggle('active', isImfpa); labels[1].classList.toggle('text-gray-500', !isImfpa);
                Logic.updateContractPreview();
                Logic.updateSynthesizeButtonState(); // <-- ADD THIS LINE
            },
            updateImfpaCalculations: () => {
                const { legal } = AppState.modeler;
                const { groups, totalCommission, autoBalance } = legal;
                const totalPoolEl = document.getElementById('imfpa-total-commission-pool');
                if (totalPoolEl) totalPoolEl.textContent = Utils.formatPrice(totalCommission);
                
                if (autoBalance && legal.agreementType === 'IMFPA') {
                    // Auto-Balance Groups
                    let totalSetGroupPct = 0;
                    const zeroGroups = [];
                    groups.forEach((g, index) => {
                        const pct = parseFloat(g.percentage) || 0;
                        if (pct > 0) totalSetGroupPct += pct; else zeroGroups.push(index);
                    });
                    if (zeroGroups.length > 0 && totalSetGroupPct < 100) {
                        const remainingPct = 100 - totalSetGroupPct;
                        const share = remainingPct / zeroGroups.length;
                        zeroGroups.forEach(index => {
                            groups[index].percentage = share;
                            const input = document.querySelector(`[data-path="legal.groups[${index}].percentage"]`);
                            if (input) input.value = share.toFixed(2);
                        });
                    }
                }

                const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
                const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
                if (totalAllocatedEl) {
                    totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
                    totalAllocatedEl.className = `text-right font-mono text-sm ${Math.abs(totalGroupPct - 100) < 0.01 ? 'text-success-color' : 'text-error-color'}`;
                }

                groups.forEach((g, groupIndex) => {
                    const groupValueEl = document.getElementById(`imfpa-group-value-${groupIndex}`);
                    if(groupValueEl) groupValueEl.textContent = Utils.formatPrice(totalCommission * ((parseFloat(g.percentage) || 0) / 100));
                    
                    if (autoBalance && legal.agreementType === 'IMFPA') {
                        // Auto-Balance Parties
                        let totalSetPartyPct = 0;
                        const zeroParties = [];
                        g.parties.forEach((p, partyIndex) => {
                            const pct = parseFloat(p.percentage) || 0;
                            if (pct > 0) totalSetPartyPct += pct; else zeroParties.push(partyIndex);
                        });
                        if (zeroParties.length > 0 && totalSetPartyPct < 100) {
                            const remainingPct = 100 - totalSetPartyPct;
                            const share = remainingPct / zeroParties.length;
                            zeroParties.forEach(index => {
                                g.parties[index].percentage = share;
                                const input = document.querySelector(`[data-path="legal.groups[${groupIndex}].parties[${index}].percentage"]`);
                                if (input) input.value = share.toFixed(2);
                            });
                        }
                    }

                    const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
                    const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
                    if (groupTotalEl) {
                        groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
                        groupTotalEl.className = `text-right font-mono text-xs ${Math.abs(totalPartyPct - 100) < 0.01 ? 'text-success-color' : 'text-error-color'}`;
                    }
                });
            },
            updateContractPreview: () => {
                const previewContainer = document.getElementById('contract-live-preview');
                if (!previewContainer) return;
                const calc = Logic.calculateModel();
                previewContainer.innerHTML = UI.renderContractPreview(AppState.modeler.legal, calc);
            },

            // Add this new function inside the `Logic` object
validateImfpaData: () => {
    const { legal } = AppState.modeler;
    const allParties = legal.groups.flatMap(g => g.parties);
    const isImfpa = legal.agreementType === 'IMFPA';

    // Rule 1: Must have a jurisdiction
    if (!legal.jurisdiction) return false;

    // Rule 2: Must have at least two parties for any agreement
    if (allParties.length < 2) return false;

    // --- SEVERELY UPGRADED RULE 3 ---
    // All parties must be at least in a "Sufficient" state (core details complete).
    const allPartiesSufficient = allParties.every(p => 
        p.legalName && p.email && p.contactNumber
    );
    if (!allPartiesSufficient) return false;

    // Rule 4: If IMFPA, run commission allocation checks
    if (isImfpa) {
        if (legal.groups.length === 0) return false;
        const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
        if (Math.abs(totalGroupPct - 100) > 0.01) return false;

        for (const group of legal.groups) {
            if (group.parties.length === 0) return false;
            const totalPartyPct = group.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
            if (Math.abs(totalPartyPct - 100) > 0.01) return false;
        }
    }

    // If all critical checks pass, the data is valid for synthesis.
    return true;
},

// Add this new function inside the `Logic` object
updateSynthesizeButtonState: () => {
    const isReady = Logic.validateImfpaData();
    const btn = document.getElementById('synthesize-btn');
    if (!btn) return;

    btn.disabled = !isReady;
    btn.innerHTML = `<i class="fas fa-file-signature mr-2"></i>${isReady ? 'Synthesize & Preview Full Document' : 'Complete All Required Fields (*)'}`;
    
    // Dynamically change the button's class for a premium color shift
    const readyClass = 'from-premium-gold to-yellow-600 border-premium-gold hover:shadow-lg hover:shadow-premium-gold-glow';
    const incompleteClass = 'from-gray-600 to-gray-800 border-gray-600 cursor-not-allowed';
    
    // Remove old classes before adding new ones
    btn.classList.remove(...readyClass.split(' '), ...incompleteClass.split(' '));
    btn.classList.add(...(isReady ? readyClass : incompleteClass).split(' '));
},
            
            addImfpaGroup: () => { AppState.modeler.legal.groups.push({ name: `Group ${AppState.modeler.legal.groups.length + 1}`, percentage: 0, parties: [] }); Logic.refreshImfpaModalUI(); },
            removeImfpaGroup: (groupIndex) => { AppState.modeler.legal.groups.splice(groupIndex, 1); Logic.refreshImfpaModalUI(); },
            /**
 * Adds a new party to the agreement.
 * Pinnacle-Grade Logic: Intelligently handles both IMFPA (adds to a specific group)
 * and NCNDA (adds to the master signatory list) modes.
 * It sets 'detailsVisible' to true by default to immediately guide the user.
 * @param {number} groupIndex - The index of the group to add the party to. In NCNDA mode, this is always 0.
 */
addImfpaParty: (groupIndex) => {
    // Military-Grade Safeguard: Ensure the target group exists before proceeding.
    if (!AppState.modeler.legal.groups[groupIndex]) {
        console.error(`Pinnacle Engine Error: Attempted to add party to non-existent group index ${groupIndex}.`);
        return;
    }

    // Define the pristine, default state for a new party.
    const newPartyTemplate = {
        legalName: `New Party`,
        role: 'Intermediary',
        percentage: 0,
        detailsVisible: true, // SEVERELY GUIDED UX: Auto-expand details for a new party.
        email: '',
        contactNumber: '',
        passport: {
            number: '',
            issueDate: '',
            expiryDate: '',
            authority: ''
        },
        payment: {
            method: 'Bank Wire',
            currency: 'USD',
            details: ''
        }
    };

    // Add the new party to the specified group's `parties` array.
    AppState.modeler.legal.groups[groupIndex].parties.push(newPartyTemplate);
    
    // Trigger a full UI refresh of the modal to render the new party card and update all counters and validation states.
    Logic.refreshImfpaModalUI();
},
            removeImfpaParty: (groupIndex, partyIndex) => { if (AppState.modeler.legal.groups[groupIndex]?.parties[partyIndex]) { AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1); Logic.refreshImfpaModalUI(); } },
            togglePartyDetails: (groupIndex, partyIndex) => { const party = AppState.modeler.legal.groups?.[groupIndex]?.parties?.[partyIndex]; if (party) { party.detailsVisible = !party.detailsVisible; Logic.refreshImfpaModalUI(); } },
            
            
            /**
             * [PINNACLE/MILITARY-GRADE v13.0 - CLIENT-SIDE SYNTHESIS ENGINE (DEFINITIVE)]
             * This function is the definitive, self-contained, client-side engine for synthesizing the complete, 
             * professional-grade IMFPA-NCNDA document. It meticulously constructs the entire HTML document string 
             * based on the current deal model, incorporating all advanced legal clauses, dynamic data, premium 
             * styling, and the required detailed table-based outputs. This function is perfectly integral to 
             * the toolkits.html file structure and executes entirely within the browser as instructed.
             */
            generateContract: () => {
                // --- 1. PRE-SYNTHESIS VALIDATION & RESOURCE CONFIRMATION ---
                const { legal } = AppState.modeler;
                const calc = Logic.calculateModel();
            
                if (!calc) { 
                    Utils.showNotification("Cannot generate contract. Please define and calculate the core deal parameters first.", 'error', 'Calculation Incomplete');
                    return; 
                }

                const previewContainer = document.getElementById('contract-preview-container');
                const printContainer = document.getElementById('print-area');

                if (!previewContainer || !printContainer) {
                    console.error('CRITICAL UI FAILURE: The required #contract-preview-container or #print-area DOM elements are missing.');
                    Utils.showNotification("A critical UI error prevented the document from being displayed.", 'error', 'UI Integration Fault');
                    return;
                }
            
                // --- 2. DYNAMIC LEGAL CLAUSE & METADATA SYNTHESIS ---
                const agreementReference = `GECAN-IMFPA-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                const effectiveDate = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const generatedDateTime = new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
                
                // Generates elevated, transaction-specific legal language for the preamble.
                let recitalsText = '';
                switch(AppState.modeler.activeDealType) {
                    case 'AssetSwap':
                        recitalsText = `WHEREAS, the Contracting Parties have entered into preliminary negotiations concerning a sophisticated digital and/or physical asset exchange transaction contemplating the bilateral swap of approximately ${Utils.formatNumber(AppState.modeler.assetSwap.amount)} units of ${calc.fromAsset.baseAsset} in consideration for equivalent value in ${calc.toAsset.baseAsset}, subject to market valuations and regulatory compliance;`;
                        break;
                    case 'CommodityTrade':
                        const ct = AppState.modeler.commodityTrade;
                        recitalsText = `WHEREAS, the Contracting Parties are engaged in commercial negotiations for the procurement, sale, and delivery of physical commodities, specifically ${Utils.formatNumber(ct.quantity)} ${ct.unitOfMeasure} of premium-grade ${Utils.getAssetByKey(ct.assetKey).baseAsset}, in accordance with international trade conventions and applicable commodity exchange regulations;`;
                        break;
                    case 'CryptoLoan':
                        const cl = AppState.modeler.cryptoLoan;
                        recitalsText = `WHEREAS, the Contracting Parties seek to establish a sophisticated credit facility secured by digital asset collateral, encompassing a principal loan amount of ${Utils.formatPrice(calc.loanPrincipal, cl.loanCurrency)} against pledged collateral consisting of ${Utils.formatNumber(cl.collateralAmount)} units of ${Utils.getAssetByKey(cl.collateralAssetKey).baseAsset}, subject to regulatory compliance and risk management protocols;`;
                        break;
                    case 'SBLCMonetization':
                        const sblc = AppState.modeler.sblcMonetization;
                        recitalsText = `WHEREAS, the Contracting Parties are collaborating on the monetization and financial optimization of a Standby Letter of Credit (SBLC) instrument bearing a face value of ${Utils.formatPrice(sblc.faceValue)}, issued by a prime banking institution and compliant with ICC UCP 600 standards;`;
                        break;
                    default:
                        recitalsText = `WHEREAS, the Contracting Parties have established a framework for cooperation in connection with a substantial international financial transaction of significant commercial value and strategic importance;`;
                }
            
                // --- 3. SEVERELY UPGRADED FEE DISTRIBUTION SCHEDULE SYNTHESIS (PREMIUM TABLE FORMAT) ---
                const feeClauses = legal.groups.map((g) => {
                    const groupPayout = legal.totalCommission * (g.percentage / 100);
            
                    const partiesRows = g.parties.map((p) => {
                        const partyValue = groupPayout * (p.percentage / 100);
                        const settlementDetailsText = p.payment.details || 'To be furnished through separate, encrypted KYC/KYB documentation exchange pursuant to regulatory requirements';
            
                        return `
                        <tr>
                            <td>
                                <div class="beneficiary-name">${p.legalName || '[LEGAL ENTITY NAME REQUIRED]'}</div>
                                <div class="beneficiary-role">${p.role || '[ROLE NOT DESIGNATED]'}</div>
                            </td>
                            <td>
                                <div class="allocation-value">${p.percentage}%</div>
                                <div class="text-muted">${Utils.formatPrice(partyValue, 'USD')}</div>
                            </td>
                            <td>
                                <div class="settlement-method">${p.payment.method?.toUpperCase() || '[METHOD]'} (${p.payment.currency || 'N/A'})</div>
                                <div class="settlement-details">${settlementDetailsText}</div>
                            </td>
                        </tr>`;
                    }).join('');
            
                    const tableBody = g.parties.length > 0
                        ? partiesRows
                        : `<tr class="no-parties-row"><td colspan="3">(No designated beneficiaries specified for this distribution group)</td></tr>`;
            
                    return `
                    <div class="fee-group-container">
                        <div class="fee-group-header">
                            <span class="fee-group-header-title">Distribution Group: "${g.name.toUpperCase()}"</span>
                            <span class="fee-group-header-value">${g.percentage}% (${Utils.formatPrice(groupPayout, 'USD')})</span>
                        </div>
                        <table class="fee-distribution-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Beneficiary & Role</th>
                                    <th style="width: 20%;">Allocation</th>
                                    <th style="width: 40%;">Remittance Instructions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableBody}
                            </tbody>
                        </table>
                    </div>`;
                }).join('');
            
                // --- 4. ENHANCED PARTY SIGNATURE BLOCK SYNTHESIS ---
                const signatureBlocks = legal.groups.flatMap(g => g.parties).map((p, i) => `
                <div class="p-signature-block" data-party-id="party-${i}" data-party-name="${p.legalName || 'Unnamed Party'}">
                    <p class="p-strong">FOR AND ON BEHALF OF: ${(p.legalName || '[LEGAL ENTITY NAME REQUIRED]').toUpperCase()}</p>
                    <div class="p-signature-line" data-sig-type="signature"><!-- Signature will be applied here --></div>
                    <p class="p-signature-label">By: (Authorized Signature)</p>
                    <div class="p-signature-line" data-sig-type="print-name"></div>
                    <p class="p-signature-label">Name/Title: ${p.legalName || ''} / ${p.role || ''}</p>
                    <div class="p-signature-line" data-sig-type="date"><!-- Date will be applied here --></div>
                    <p class="p-signature-label">Date of Execution:</p>
                    <div data-sig-type="seal" style="position: relative; height: 100px; margin-top: 10px;"><!-- Seal will be applied here --></div>
                </div>`).join('\n');
            
                // --- 5. COMPREHENSIVE PARTY DETAILS ANNEX SYNTHESIS (TABLE OUTPUT FORMAT) ---
                const partyDetailsTable = legal.groups.flatMap(g => g.parties).map((p, i) => `
                <div class="party-details-section">
                    <h4>CONTRACTING PARTY ${i+1} - COMPREHENSIVE DETAILS</h4>
                    <table class="party-details-table">
                        <tbody>
                            <tr>
                                <td class="detail-label">Legal Entity Name:</td>
                                <td class="detail-value">${p.legalName || '[REQUIRED - NOT SPECIFIED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Functional Role & Capacity:</td>
                                <td class="detail-value">${p.role || '[ROLE NOT DESIGNATED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Primary Contact Email:</td>
                                <td class="detail-value">${p.email || '[EMAIL ADDRESS REQUIRED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Direct Contact Number:</td>
                                <td class="detail-value">${p.contactNumber || '[CONTACT NUMBER REQUIRED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Passport/ID Number:</td>
                                <td class="detail-value">${p.passport.number || '[IDENTIFICATION REQUIRED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Document Issue Date:</td>
                                <td class="detail-value">${p.passport.issueDate || '[DATE REQUIRED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Document Expiry Date:</td>
                                <td class="detail-value">${p.passport.expiryDate || '[DATE REQUIRED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Issuing Authority:</td>
                                <td class="detail-value">${p.passport.authority || '[AUTHORITY REQUIRED]'}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h5>REMITTANCE & SETTLEMENT COORDINATES</h5>
                    <table class="payment-details-table">
                        <tbody>
                            <tr>
                                <td class="detail-label">Fee Allocation Percentage:</td>
                                <td class="detail-value">(As specified in Article 3 - Fee Distribution Schedule)</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Preferred Payment Method:</td>
                                <td class="detail-value">${p.payment.method || '[METHOD NOT SPECIFIED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Settlement Currency:</td>
                                <td class="detail-value">${p.payment.currency || '[CURRENCY NOT SPECIFIED]'}</td>
                            </tr>
                            <tr>
                                <td class="detail-label">Banking/Payment Details:</td>
                                <td class="detail-value">${p.payment.details || 'To be furnished through separate, secure KYC/KYB documentation exchange in compliance with AML/CTF regulations'}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>`).join('\n\n');
            
                // --- 6. MASTER DOCUMENT ASSEMBLY ---
                const contractHTML = `
                <div class="p-doc">
                    <style>
                        /* This embedded style block ensures the document is self-contained and renders perfectly for printing or PDF conversion. */
                        .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; }
                        .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
                        .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
                        .p-text { text-align: justify; margin-bottom: 11pt; }
                        .p-strong { font-weight: bold; color: #283593; }
                        .p-annex-start { page-break-before: always; }
                        .p-watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
                        
                        .fee-group-container { margin-top: 20pt; border: 1px solid #ccc; border-radius: 6pt; overflow: hidden; background: #fff; page-break-inside: avoid; }
                        .fee-group-header { background: #e8eaf6; padding: 8pt 12pt; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
                        .fee-group-header-title { font-size: 10pt; font-weight: bold; color: #1A237E; text-transform: uppercase; }
                        .fee-group-header-value { font-family: 'Courier New', monospace; font-size: 11pt; font-weight: bold; color: #1A237E; }
                        .fee-distribution-table { width: 100%; border-collapse: collapse; }
                        .fee-distribution-table th, .fee-distribution-table td { padding: 8pt 12pt; text-align: left; vertical-align: top; border-bottom: 1px solid #ddd; font-size: 9pt; }
                        .fee-distribution-table th { font-weight: bold; font-size: 8pt; color: #283593; text-transform: uppercase; background-color: #f9f9f9; }
                        .beneficiary-name { font-weight: bold; font-size: 10pt; color: #000; }
                        .beneficiary-role { font-style: italic; color: #555; }
                        .allocation-value { font-family: 'Courier New', monospace; font-weight: bold; color: #1A237E; }
                        .text-muted { color: #555; }
                        .settlement-method { font-weight: bold; text-transform: uppercase; }
                        .settlement-details { font-family: 'Courier New', monospace; font-size: 8pt; color: #555; word-break: break-all; }
                        .no-parties-row td { text-align: center; font-style: italic; color: #777; padding: 15pt; }

                        .party-details-section { margin-top: 20pt; page-break-inside: avoid; }
                        .party-details-section h4 { background: #1A237E; color: white; padding: 8pt 12pt; margin: 0; font-size: 10pt; text-transform: uppercase; }
                        .party-details-section h5 { background: #e8eaf6; color: #1A237E; padding: 6pt 12pt; margin: 0; font-size: 9pt; text-transform: uppercase; font-weight: bold; }
                        .party-details-table, .payment-details-table { width: 100%; border: 1px solid #ccc; border-collapse: collapse; margin-bottom: 12pt; }
                        .party-details-table td, .payment-details-table td { padding: 6pt 8pt; border: 1px solid #ccc; font-size: 9pt; vertical-align: top; }
                        .detail-label { background: #f9f9f9; font-weight: bold; width: 30%; }
                        .detail-value { font-family: 'Courier New', monospace; }

                        .p-signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; border-top: 1px solid #ccc; padding-top: 20pt; }
                        .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
                        .p-signature-label { font-size: 9pt; color: #555; }

                        .legal-footer { margin-top: 40pt; padding-top: 15pt; border-top: 2px solid #1A237E; font-size: 8pt; color: #555; text-align: center; page-break-inside: avoid; }
                    </style>
                    <div class="p-watermark">GECAN DRAFT</div>
                    <h1 class="p-h1">Irrevocable Master Fee Protection & Non-Circumvention Non-Disclosure Agreement (IMFPA-NCNDA)</h1>
                    <p class="p-text"><strong>Reference:</strong> ${agreementReference}</p>
                    <p class="p-text"><strong>Effective Date:</strong> ${effectiveDate}</p>
                    <p class="p-text"><strong>Governing Law:</strong> ${legal.jurisdiction || '[JURISDICTION TO BE SPECIFIED]'}</p>
                    <p class="p-text">This Agreement is structured in accordance with the highest standards of international commercial practice, including but not limited to, principles promulgated by the International Chamber of Commerce (ICC), Paris, France.</p>

                    <h2 class="p-h2">PRELIMINARY RECITALS</h2>
                    <p class="p-text" style="font-style: italic;">${recitalsText}</p>
                    <p class="p-text">NOW, THEREFORE, in consideration of the mutual covenants contained herein, the Parties agree to be legally bound by the terms and conditions set forth in this Agreement.</p>

                    <h2 class="p-h2">ARTICLE I: TRANSACTION & FEE POOL</h2>
                    <p class="p-text">The subject matter of this Agreement is a transaction with an aggregate base value of <strong>${Utils.formatPrice(calc.baseValueUSD)}</strong>, which generates a total commission pool of <strong>${Utils.formatPrice(legal.totalCommission)}</strong> (the "Fee Pool").</p>

                    <div class="p-annex-start">
                        <h2 class="p-h2">ANNEX A: IRREVOCABLE FEE DISTRIBUTION SCHEDULE</h2>
                        <p class="p-text">The Fee Pool shall be irrevocably distributed directly from the designated Payer's transactional settlement account(s) to the respective Beneficiaries' accounts according to the following schedule:</p>
                        ${feeClauses}
                    </div>

                    <div class="p-annex-start">
                        <h2 class="p-h2">ANNEX B: COMPREHENSIVE CONTRACTING PARTY DETAILS</h2>
                        <p class="p-text">This Annex B forms an integral, binding, and enforceable component of the foregoing Agreement and contains comprehensive identification and payment coordination details for all Contracting Parties.</p>
                        ${partyDetailsTable}
                    </div>
                    
                    <div class="p-annex-start">
                        <h2 class="p-h2">EXECUTION & SIGNATURE PAGE</h2>
                        <p class="p-text">IN WITNESS WHEREOF, the Contracting Parties have caused this Agreement to be executed by their respective duly authorized representatives as of the Effective Date first written above.</p>
                        ${signatureBlocks}
                    </div>

                    <div class="legal-footer">
                        <strong>CONFIDENTIAL & PROPRIETARY DOCUMENT</strong><br>
                        This document contains legally privileged and confidential commercial information. Unauthorized disclosure, reproduction, or distribution is strictly prohibited.<br>
                        Document Reference: ${agreementReference} | Generated: ${generatedDateTime}
                    </div>
                </div>`;
            
                // --- 7. RENDER DOCUMENT & EXECUTION SUITE TO THE DOM ---
                previewContainer.innerHTML = UI.renderExecutionSuite(contractHTML);
                printContainer.innerHTML = contractHTML; // Populate hidden div for clean printing
                
                previewContainer.classList.remove('hidden');
                setTimeout(() => {
                    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                Utils.showNotification(
                    'Premium legal contract generated successfully! Please review with legal counsel before execution.', 
                    'success',
                    'Document Synthesized'
                );
            },
            
            getPrintStyles: () => {
                let printCss = '';
                // Iterate through all stylesheets loaded on the page
                for (const sheet of document.styleSheets) {
                    try {
                        // Iterate through all rules in a stylesheet
                        for (const rule of sheet.cssRules) {
                            // Check if the rule is an @media rule and if it's for 'print'
                            if (rule.type === CSSRule.MEDIA_RULE && rule.media.mediaText === 'print') {
                                // If it matches, iterate through the rules *inside* the @media block
                                for (const printRule of rule.cssRules) {
                                    // Append the text content of each rule to our string
                                    printCss += printRule.cssText + '\n';
                                }
                            }
                        }
                    } catch (e) {
                        // Catch and log potential security errors when accessing cross-origin stylesheets
                        console.warn("Could not access stylesheet for print styles:", sheet.href, e);
                    }
                }
                return printCss;
            },
            // --- Document Execution & Signature Suite (v5.0 - Pinnacle Unabridged) ---

            initiateSigningProcess: () => {
    const sigBlocks = document.querySelectorAll('#contract-document-wrapper .p-signature-block');
    const selectEl = document.getElementById('signature-target-select');
    if (!selectEl) return;
    
    selectEl.innerHTML = '<option value="">-- Select a Signatory --</option>';
    sigBlocks.forEach((block, index) => {
        const partyName = block.dataset.partyName;
        const option = new Option(`${index + 1}: ${partyName}`, block.dataset.partyId);
        selectEl.add(option);
    });

    const modal = document.getElementById('signature-modal');
    modal.showModal();
    Logic.switchSignatureMode('draw');
    
    document.getElementById('signature-timestamp').textContent = new Date().toISOString();
    document.getElementById('signature-location').textContent = 'Fetching...';
    fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
        document.getElementById('signature-location').textContent = `${data.city}, ${data.country_name} (IP: ${data.ip})`;
    }).catch(() => { document.getElementById('signature-location').textContent = 'Location Not Available'; });
},

switchSignatureMode: (mode) => {
    const panels = { draw: 'draw-mode-panel', upload: 'upload-mode-panel', seal: 'seal-mode-panel' };
    const tabs = { draw: 'draw-tab-btn', upload: 'upload-tab-btn', seal: 'seal-tab-btn' };

    Object.values(panels).forEach(id => document.getElementById(id).classList.add('hidden'));
    Object.values(tabs).forEach(id => document.getElementById(id).classList.remove('active'));

    document.getElementById(panels[mode]).classList.remove('hidden');
    document.getElementById(tabs[mode]).classList.add('active');
    document.getElementById('signature-modal').dataset.activeMode = mode;
    
    if (mode === 'draw') Logic.setupSignaturePad();
    if (mode === 'upload' || mode === 'seal') Logic.setupFileUpload(mode);
},

setupSignaturePad: () => {
    const canvas = document.getElementById('signature-canvas');
    if (!canvas) return;
    const resizeCanvas = () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        if (window.signaturePad) window.signaturePad.clear();
    };
    if (!window.signaturePad) window.signaturePad = new SignaturePad(canvas, { penColor: "#1A237E" });
    setTimeout(resizeCanvas, 50);
},

clearSignaturePad: () => window.signaturePad?.clear(),

setupFileUpload: (type) => { // 'upload' for signature, 'seal' for seal
    const inputId = type === 'upload' ? 'signature-upload-input' : 'seal-upload-input';
    const previewId = type === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview';
    const promptId = type === 'upload' ? 'upload-prompt' : 'seal-prompt';
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const prompt = document.getElementById(promptId);
    if (!input || !preview || !prompt) return;
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                prompt.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    };
},

processImageForTransparency: (imageDataUrl) => {
    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "Anonymous";

        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                // --- SUPREME INTELLIGENCE: DYNAMIC BACKGROUND DETECTION ---
                // Sample the corner pixel color to intelligently determine the background.
                const cornerPixel = [data[0], data[1], data[2]];
                const isLightBg = (cornerPixel[0] + cornerPixel[1] + cornerPixel[2]) / 3 > 128;

                if (!isLightBg) {
                    // If the background is not light, we assume it's a pre-processed transparent PNG.
                    // No processing needed, just resolve.
                    resolve(canvas.toDataURL('image/png'));
                    return;
                }

                const bgR = cornerPixel[0];
                const bgG = cornerPixel[1];
                const bgB = cornerPixel[2];
                // Dynamic threshold adapts to the detected background color.
                const threshold = 30; 

                // --- PINNACLE-GRADE PROCESSING: PIXEL-BY-PIXEL ANALYSIS ---
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    // Calculate color distance from the detected background color.
                    const distance = Math.sqrt(
                        Math.pow(r - bgR, 2) +
                        Math.pow(g - bgG, 2) +
                        Math.pow(b - bgB, 2)
                    );

                    if (distance < threshold) {
                        // Pixel is part of the background, make it transparent.
                        data[i + 3] = 0;
                    } else {
                        // --- SEVERE UPGRADE: RE-TONE TO LEGAL NAVY BLUE & ENHANCE CONTRAST ---
                        // This pixel is part of the signature.
                        // Convert to grayscale to neutralize original color.
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        // Re-tone to a legally profound navy blue (#1A237E).
                        // The darker the original pixel, the closer to pure navy it becomes.
                        const intensity = 1 - (gray / 255);
                        data[i] = 26 * intensity;   // R channel for #1A237E
                        data[i + 1] = 35 * intensity; // G channel for #1A237E
                        data[i + 2] = 126 * intensity;// B channel for #1A237E

                        // Enhance alpha based on intensity for smoother edges.
                        data[i + 3] = 255 * Math.pow(intensity, 0.8);
                    }
                }

                // Put the modified, optimized, and re-toned image data back onto the canvas.
                ctx.putImageData(imageData, 0, 0);
                
                // Resolve the Promise with the new, pinnacle-grade PNG data URL.
                resolve(canvas.toDataURL('image/png'));
            } catch (e) {
                console.error("Could not process image data due to security restrictions:", e);
                reject(new Error("Image is from a different origin or is security-protected. Please use the 'Draw Signature' method or a different image file."));
            }
        };

        img.onerror = () => {
            reject(new Error("Failed to load the signature image for processing. The file may be corrupt or inaccessible."));
        };

        // Start loading the image
        img.src = imageDataUrl;
    });
},

applySignature: async () => {
    const modal = document.getElementById('signature-modal');
    const mode = modal.dataset.activeMode;
    const targetPartyId = document.getElementById('signature-target-select').value;
    if (!targetPartyId) return Utils.showNotification("Please select a signatory.", 'error');

    let dataUrl = '';
    try {
        if (mode === 'draw') {
            if (window.signaturePad.isEmpty()) throw new Error("Please draw a signature.");
            dataUrl = window.signaturePad.toDataURL('image/png');
        } else {
            const previewId = mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview';
            const previewImg = document.getElementById(previewId);
            if (!previewImg.src || previewImg.classList.contains('hidden')) throw new Error(`Please upload a ${mode === 'upload' ? 'signature' : 'seal'}.`);
            dataUrl = await Logic.processImageForTransparency(previewImg.src);
        }

        const dateOfExecution = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const containersToUpdate = ['#contract-document-wrapper', '#print-area'];

        containersToUpdate.forEach(containerSelector => {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            const targetBlock = container.querySelector(`.p-signature-block[data-party-id="${targetPartyId}"]`);
            if (!targetBlock) return;

            if (mode === 'draw' || mode === 'upload') {
                targetBlock.querySelector('[data-sig-type="signature"]').innerHTML = `<img src="${dataUrl}" class="p-signature-img" alt="Digital Signature">`;
                targetBlock.querySelector('[data-sig-type="date"]').textContent = dateOfExecution;
            } else if (mode === 'seal') {
                targetBlock.querySelector('[data-sig-type="seal"]').innerHTML = `<img src="${dataUrl}" class="p-seal-img" alt="Corporate Seal">`;
            }
        });

        modal.close();
        Logic.resetSignatureInputs();
        document.querySelector('#finalization-step-panel').classList.remove('opacity-50', 'pointer-events-none');
        Utils.showNotification("Signature/seal applied successfully.", 'success');
    } catch (error) {
        Utils.showNotification(error.message, 'error', 'Application Failed');
    }
},

resetSignatureInputs: () => {
    window.signaturePad?.clear();
    ['signature-upload', 'seal-upload'].forEach(id => {
        const input = document.getElementById(`${id}-input`);
        const preview = document.getElementById(`${id}-preview`);
        const promptEl = document.getElementById(id.replace('upload', 'prompt'));
        if(input) input.value = '';
        if(preview) { preview.src = ''; preview.classList.add('hidden'); }
        if(promptEl) promptEl.classList.remove('hidden');
    });
},

sendForSignature: () => {
                const modal = document.getElementById('finalization-modal');
                if(!modal) return;
                modal.innerHTML = UI.renderFinalizationModal();
                modal.showModal();
            },

simpleHash: async (str) => {
    const buffer = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
},

executeFinalizationWorkflow: async () => {
    document.getElementById('finalization-modal').close();
    Utils.showNotification("Finalizing document and dispatching...", 'info', 'Processing');

    try {
        const finalHtml = document.getElementById('print-area').innerHTML;
        const documentFingerprint = await Logic.simpleHash(finalHtml);
        const agreementReference = finalHtml.match(/Reference:<\/strong>\s*([^<]+)/)?.[1].trim() || 'GECAN-DOC-FINAL';
        const recipientEmails = AppState.modeler.legal.groups.flatMap(g => g.parties).map(p => p.email).filter(Boolean);

        const payload = {
            agreementReference,
            documentFingerprint,
            recipientEmails: recipientEmails.join(','),
            emailBody: Logic.generatePremiumEmailTemplate({ agreementReference, documentFingerprint, parties: AppState.modeler.legal.groups.flatMap(g => g.parties) }),
            fileName: `${agreementReference}_EXECUTED.pdf`,
            htmlContent: `<!DOCTYPE html><html><head><style>${Array.from(document.styleSheets).map(s => Array.from(s.rules || []).map(r => r.cssText).join('')).join('')}</style></head><body>${finalHtml}</body></html>`
        };

        const response = await Logic.createApiRequest('generatePdfAndDispatchEmail', 'POST', payload);
        Utils.showNotification(response, 'success', 'Document Dispatched');
    } catch (error) {
        Utils.showNotification(error.message, 'error', 'Dispatch Failed');
    }
},

generatePremiumEmailTemplate: (payload) => {
    const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');
    return `
    <body style="font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px;">
        <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px;">
            <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;"><h1>GECAN™ | Executed Agreement Attached</h1></div>
            <div style="padding: 30px;">
                <p>Dear Contracting Parties,</p>
                <p>Please find attached the fully executed legal document. This document has been finalized and its state cryptographically recorded.</p>
                <div style="background-color: #f9f9f9; padding: 20px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                    <h3 style="color: #0369a1;">Agreement Details</h3>
                    <p><strong>Reference:</strong> ${payload.agreementReference}</p>
                    <p><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px;">${payload.documentFingerprint}</code></p>
                </div>
                <h3>Parties to this Agreement:</h3><ul>${partyListHTML}</ul>
                <p>Thank you for your cooperation.<br><strong>The GECAN™ Transactional Systems</strong></p>
            </div>
            <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                <p><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication is strictly confidential and intended solely for the authorized recipients.</p>
            </div>
        </div>
    </body>`;
},


        };

// ====================================================================================
// === SECTION 4: UI RENDERERS (v4.0 - DEFINITIVE, UNABRIDGED & CORRECTED) ===
// This block contains the pinnacle-grade, word-for-word logic for rendering
// every component and state of the Toolkits page UI.
// ====================================================================================
const UI = {
    /**
     * Initializes the particle background with a default or fetched theme.
     * This function is the benchmark standard for dynamic background effects.
     */
    init: () => {
        const defaultConfig = {
            "particles": {
                "number": { "value": 50, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": ["#0ea5e9", "#6366f1", "#8b5cf6"] },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.6, "random": true, "anim": { "enable": true, "speed": 0.5, "opacity_min": 0.1 } },
                "size": { "value": 3, "random": true },
                "line_linked": { "enable": true, "distance": 150, "color": "#475569", "opacity": 0.4, "width": 1 },
                "move": { "enable": true, "speed": 1, "direction": "none", "random": true, "out_mode": "out" }
            },
            "interactivity": {
                "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } },
                "modes": { "grab": { "distance": 200, "line_linked": { "opacity": 0.6 } }, "push": { "particles_nb": 4 } }
            }
        };
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', defaultConfig);
        }
    },

    /**
     * Dynamically renders the particle.js background using a provided configuration.
     * @param {object} config - A valid particle.js configuration object.
     */
    renderParticles: (config) => {
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', config);
        } else {
            console.warn("particles.js library not found, skipping background rendering.");
        }
    },

    /**
     * Populates the main and mobile navigation menus from a central source of truth.
     * This function is benchmarked against index.html for perfect platform-wide consistency.
     */
    populateNavLinks: () => {
    const navPlaceholder = document.getElementById('desktop-nav-placeholder');
    const mobileMenuContent = document.getElementById('mobile-sidebar-content');
    if (!navPlaceholder || !mobileMenuContent) return;

    const path = window.location.pathname;
    const currentPageFile = path.split('/').pop().replace('.html', '') || 'index';

    const links = [
        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
        { page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },
        { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },
        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }
    ];

    const navHtml = (isMobile = false) => links.map(link => {
        const isActive = currentPageFile === link.page;
        const btnClass = isMobile ? 'nav-btn w-full justify-start' : 'nav-btn';
        // This HTML structure is the benchmark standard for all navigation buttons.
        return `
            <a href="./${link.page}.html" class="${btnClass} ${isActive ? 'active' : ''}">
                <div class="nav-icon-wrapper">
                    <div class="nav-icon-flipper">
                        <div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div>
                        <div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div>
                    </div>
                </div>
                <span class="nav-text">${link.text}</span>
            </a>`;
    }).join(isMobile ? '' : '');

    navPlaceholder.innerHTML = `<div id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">${navHtml(false)}</div>`;
    // For mobile, we create a fresh clone every time to ensure event listeners are clean.
    mobileMenuContent.innerHTML = `<div class="mobile-nav-clone">${navHtml(true)}</div>`;
},

    /**
     * Renders the menu of available toolkits in the left sidebar, highlighting the active one.
     */
    renderToolkitMenu: () => {
        const menuContainer = document.getElementById('toolkit-menu');
        if (!menuContainer) return;
        menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => {
            const isActive = AppState.activeToolkit === t.id;
            return `
                <button onclick="Logic.setActiveToolkit('${t.id}')" 
                        class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${isActive ? 'bg-gradient-to-r from-primary-azure to-primary-dark text-white shadow-lg shadow-primary-azure/20' : 'text-text-secondary hover:bg-background-secondary hover:text-white'}">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                        <i class="fas ${t.icon} text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold truncate">${t.name}</div>
                        <div class="text-xs opacity-75 mt-1 truncate">${t.description.split('.')[0]}</div>
                    </div>
                    <i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity ml-auto"></i>
                </button>`;
        }).join('');
    },

    /**
     * Master UI renderer. It acts as a router, calling the specific UI function 
     * for the currently active toolkit and binding its necessary event listeners.
     */
    renderActiveToolkit: () => {
        const container = document.getElementById('active-toolkit-container');
        if (!container) return console.error("CRITICAL: Active toolkit container not found.");
        
        const renderFunc = UI[`render${AppState.activeToolkit}UI`];
        if (typeof renderFunc === 'function') {
            container.innerHTML = renderFunc();
            container.classList.remove('hidden');
            Logic.bindActiveToolkitEvents();
        } else {
            Utils.showNotification(`UI for '${AppState.activeToolkit}' not implemented.`, 'error');
            container.innerHTML = `<p class="text-center text-error-color">UI Error: Component '${AppState.activeToolkit}' failed to load.</p>`;
        }
        UI.renderToolkitMenu();
    },

    /**
     * Renders the main dashboard/welcome view for the toolkits page.
     * DEFINITIVE FIX: The trailing comma that caused the syntax error has been removed.
     */
    renderDashboardUI: () => `
        <div class="glass rounded-2xl p-8 h-full flex flex-col animate-fade-in-up">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold gradient-text mb-4">GECAN™ Intelligent Toolkits</h2>
                <p class="text-text-secondary text-lg max-w-2xl mx-auto leading-relaxed">Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits)
                    .filter(t => t.id !== 'Dashboard')
                    .map((t, index) => `
                        <div class="report-section p-8 cursor-pointer group animate-scale-in stagger-${index + 1}" onclick="Logic.setActiveToolkit('${t.id}')">
                            <div class="flex items-start gap-6">
                                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform duration-300 ease-in-out">
                                    <i class="fas ${t.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-azure transition-colors">${t.name}</h3>
                                    <p class="text-text-secondary leading-relaxed">${t.description}</p>
                                    <div class="mt-4 flex items-center text-primary-azure opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <span class="text-sm font-medium">Launch Toolkit</span>
                                        <i class="fas fa-arrow-right ml-2"></i>
                                    </div>
                                </div>
                            </div>
                        </div>`).join('')
                }
            </div>
        </div>`,

    /**
     * Renders the main container and logic for the Wallet Forensics toolkit.
     * It intelligently displays the initial prompt, the premium loading state, or the full, detailed report.
     * @returns {string} The complete HTML for the Wallet Forensics toolkit interface.
     */
    renderWalletForensicsUI: () => {
        const { address, isLoading, report } = AppState.walletAnalysis;
        let contentHTML = '';

        if (isLoading) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center animate-fade-in-up"><div class="relative mb-8"><div class="w-24 h-24 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div><h3 class="text-2xl font-bold text-white mb-4">Analyzing Wallet On-Chain...</h3><p id="spinner-text" class="text-text-secondary mb-6 transition-opacity duration-300">Initializing GECAN Heuristic Engine v5.0...</p><div class="w-64 h-2 bg-background-secondary rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-primary-azure to-primary-royal" style="width: 100%; animation: shimmer 2s infinite linear; background-size: 400% 100%;"></div></div></div>`;
        } else if (report?.error || report?.success === false) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-scale-in"><div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8"><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i></div><h3 class="text-2xl font-bold text-white mb-4">Analysis Failed</h3><p class="text-text-secondary max-w-md leading-relaxed">${report.error?.message || 'An unknown server error occurred. Please try again.'}</p><button onclick="Logic.runWalletForensics()" class="btn-primary mt-6 px-6 py-3 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry Analysis</button></div>`;
        } else if (report) {
            contentHTML = UI.buildWalletReportHTML(report);
        } else {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center glass rounded-2xl border-2 border-dashed border-border-color animate-fade-in-up"><div class="w-24 h-24 rounded-full bg-primary-azure/10 flex items-center justify-center mb-8 animate-float"><i class="fas fa-search-dollar fa-3x text-primary-azure"></i></div><h3 class="text-2xl font-bold text-white mb-4">Ready for Analysis</h3><p class="text-text-secondary max-w-md leading-relaxed mb-2">Enter a wallet address to begin comprehensive due diligence and provenance analysis.</p><p class="text-xs text-text-muted">Powered by GECAN Proprietary Heuristic Engine v5.0</p></div>`;
        }

        return `<div class="glass rounded-2xl p-0 h-full flex flex-col animate-fade-in-up"><div class="p-8 border-b border-border-color"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-shield-alt text-white fa-lg"></i></div><div><h2 class="text-3xl font-bold text-white">Wallet Due Diligence & Provenance</h2><p class="text-text-secondary">Advanced blockchain forensics and risk assessment</p></div></div><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" class="btn-primary font-bold py-4 px-8 rounded-xl whitespace-nowrap w-full sm:w-auto"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto">${contentHTML}</div></div>`;
    },

    /**
     * Builds the complete HTML for a generated Wallet Forensics report.
     * @param {object} report - The full report data object from the backend.
     * @returns {string} The complete HTML string for the report.
     */
    buildWalletReportHTML: (report) => {
    const { wallet, analysis, provenance, transactions } = report;
    const { walletClassification, redFlags, riskLevel, integrityScore, scoreBreakdown } = analysis;
    const riskClass = `risk-${riskLevel}`;

    // --- DERIVED METRICS: Calculated once for efficiency and consistency ---
    const reliableTransactionCount = Array.isArray(transactions) ? transactions.length : (wallet.transactionCount || 0);
    const inboundCount = reliableTransactionCount > 0 ? transactions.filter(tx => tx.type === 'Receive').length : 0;
    const outboundCount = reliableTransactionCount > 0 ? transactions.filter(tx => tx.type === 'Send').length : 0;
    const lastActivityDate = reliableTransactionCount > 0 && transactions?.[0]?.time ? new Date(transactions[0].time) : new Date(wallet.firstTransaction);
    const daysSinceLastTx = lastActivityDate ? Math.floor((new Date() - lastActivityDate) / (1000 * 60 * 60 * 24)) : 'N/A';
    const transactionVelocity = wallet.ageInDays > 0 ? (reliableTransactionCount / wallet.ageInDays).toFixed(2) : '0.00';
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN'))];

    // --- Dynamic Header Tags ---
    const headerTags = [];
    if (provenance.records.length > 0) headerTags.push({ text: 'GECAN LEDGER MATCH', class: 'bg-success-color/20 text-success-color' });
    else headerTags.push({ text: 'UNVERIFIED IN LEDGER', class: 'bg-warning-color/20 text-warning-color' });
    headerTags.push({ text: `${riskLevel} RISK`, class: `bg-${riskClass.replace('risk-','')}-color/20 text-${riskClass.replace('risk-','')}-color` });
    if (uniqueControllers.length > 1) headerTags.push({ text: 'OWNERSHIP CONFLICT', class: 'bg-critical-color/20 text-critical-color' });
    if (walletClassification.type === 'BLACKLISTED') headerTags.push({ text: 'BLACKLISTED', class: 'bg-critical-color/20 text-critical-color font-bold' });

    // --- Severely Upgraded Score Gauge Helper v8.1 ---
    const createScoreGauge = (score, label, size = 'w-40 h-40', isMain = false) => {
        let scoreClass = 'gauge-low';
        if (score < 40) scoreClass = 'gauge-critical'; else if (score < 65) scoreClass = 'gauge-high'; else if (score < 80) scoreClass = 'gauge-medium';
        return `
        <div class="text-center animate-scale-in"><div class="relative ${size} mx-auto mb-3 transition-transform duration-300 hover:scale-105"><svg viewBox="0 0 36 36" class="w-full h-full"><defs><linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%" gradientTransform="rotate(90)"><stop offset="0%" stop-color="var(--critical-color)" /><stop offset="65%" stop-color="var(--warning-color)" /><stop offset="100%" stop-color="var(--success-color)" /></linearGradient></defs><circle cx="18" cy="18" r="15.9155" class="score-gauge-bg"></circle><circle cx="18" cy="18" r="15.9155" class="score-gauge-fg" stroke="url(#scoreGradient)" data-score="${score}"></circle></svg><div class="absolute inset-0 flex flex-col items-center justify-center"><span class="score-display ${isMain ? 'text-5xl' : 'text-3xl'} font-black transition-colors duration-500 ${scoreClass}">${Math.round(score)}</span>${isMain ? `<span class="text-xs font-bold -mt-1 ${scoreClass}">/ 100</span>` : ''}</div></div><p class="text-sm font-semibold text-white">${label}</p></div>`;
    };

    // --- Severely Upgraded Transaction Ledger Helper ---
    const createTransactionLedgerHTML = (transactions, walletType, walletAddress) => {
        if (reliableTransactionCount === 0) return `<div class="text-center text-text-muted py-12"><i class="fas fa-exchange-alt fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No On-Chain Transactions Found</p></div>`;
        const currency = walletType === 'BITCOIN' ? 'BTC' : 'USDT';
        return `
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Total Txs</p><p class="text-xl font-bold text-white">${reliableTransactionCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Inbound</p><p class="text-xl font-bold text-success-color">${inboundCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Outbound</p><p class="text-xl font-bold text-error-color">${outboundCount.toLocaleString()}</p></div>
            </div>
            <div id="transaction-ledger" class="space-y-3 max-h-[28rem] overflow-y-auto pr-2">
                ${transactions.map((tx, index) => {
                    const isInbound = tx.type === 'Receive';
                    return `
                    <div class="glass p-3 rounded-lg flex items-center justify-between gap-4 animate-fade-in-up" style="animation-delay: ${index * 30}ms">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isInbound ? 'bg-success-color/10 text-success-color' : 'bg-error-color/10 text-error-color'}">
                                <i class="fas ${isInbound ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div class="min-w-0">
                                <a href="${Logic.getExplorerUrl({type: walletType, address: walletAddress}, tx.hash)}" target="_blank" class="font-mono text-sm text-white truncate block hover:underline" title="View Transaction: ${tx.hash}">${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}</a>
                                <p class="text-xs text-text-muted">${Utils.calculateTimeAgo(tx.time)}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-mono font-semibold text-base ${isInbound ? 'text-success-color' : 'text-error-color'}">${isInbound ? '+' : '-'}${Utils.formatNumber(tx.amount, 6)} <span class="text-xs text-text-muted">${currency}</span></p>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
    };

    return `
        <div class="animate-fade-in-up">
            <div class="mb-8">
                <div class="glass p-5 rounded-2xl flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-wallet text-2xl text-primary-azure"></i>
                            <a href="${Logic.getExplorerUrl(wallet)}" target="_blank" class="font-mono text-lg text-white truncate hover:underline">${wallet.address}</a>
                            <button onclick="Utils.copyToClipboard('${wallet.address}', this)" class="text-text-muted hover:text-white relative group"><i class="fas fa-copy"></i><span class="copied-feedback absolute -top-8 left-1/2 -translate-x-1/2 text-xs bg-success-color text-white px-2 py-1 rounded-md opacity-0 pointer-events-none">Copied!</span></button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">${headerTags.map(tag => `<span class="text-xs font-bold px-3 py-1 rounded-full ${tag.class}">${tag.text}</span>`).join('')}</div>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-3">
                        <button id="pdf-export-btn" onclick="Logic.generateAndDownloadForensicsPDF()" class="btn-secondary px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                        <button id="submit-review-btn" onclick="Logic.initiateWalletSubmission()" class="btn-primary font-semibold px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-paper-plane mr-2"></i>Submit for Official Review
                        </button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-file-invoice text-primary-azure"></i>Executive Summary</h3><p class="text-text-secondary leading-relaxed">${Logic.generateExecutiveSummary(report)}</p></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-3"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-flag text-warning-color"></i>Compliance Risk Assessment</h3>${redFlags.length > 0 ? `<div class="space-y-4 max-h-[28rem] overflow-y-auto pr-2">${redFlags.map(flag => `<div class="glass p-4 rounded-xl border-l-4 ${'border-' + flag.level.toLowerCase()}-color"><div class="flex items-start gap-4"><i class="fas ${Utils.getRiskIcon(flag.level)} text-${flag.level.toLowerCase()}-color text-xl mt-1"></i><div><p class="font-bold text-${flag.level.toLowerCase()}-color">${flag.title}</p><p class="text-sm text-text-secondary mt-1">${flag.details}</p></div></div></div>`).join('')}</div>` : `<div class="text-center text-text-muted py-12"><i class="fas fa-check-circle text-success-color fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No Significant Compliance Flags Detected</p></div>`}</div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-exchange-alt text-primary-sapphire"></i>On-Chain Transaction Ledger</h3>${createTransactionLedgerHTML(transactions, wallet.type, wallet.address)}</div>
                </div>
                <div class="lg:col-span-1 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-6 text-center">Scoring Dashboard</h3>${createScoreGauge(integrityScore, 'Overall Integrity Score', 'w-40 h-40', true)}<div class="mt-8 border-t border-border-color pt-6 grid grid-cols-2 gap-6">${createScoreGauge(scoreBreakdown.provenance.score, 'Provenance', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.behavioral.score, 'Behavioral', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.temporal.score, 'Temporal', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.compliance.score, 'Compliance', 'w-28 h-28')}</div></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-2">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-microchip text-primary-royal"></i>Wallet Snapshot</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Balance (USD Eq.)</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${Utils.formatPrice(wallet.balance)}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Classification</dt><dd class="font-semibold text-white">${walletClassification.type}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Wallet Age</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${wallet.ageInDays} Days</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Last Activity</dt><dd class="font-semibold text-white">${daysSinceLastTx} days ago</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Tx Velocity</dt><dd class="font-semibold text-white">${transactionVelocity} tx/day</dd></div>
                        </div>
                    </div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-history text-primary-amethyst"></i>GECAN Provenance Timeline</h3><div class="relative">${provenance.records.length > 0 ? provenance.records.map((rec) => `<div class="timeline-item"><div class="timeline-dot"><div class="timeline-dot-inner ${uniqueControllers.length > 1 ? 'bg-critical-color' : 'bg-primary-azure'}"></div></div><p class="text-xs font-mono text-text-muted mb-1">${rec.date}</p><p class="font-semibold text-white">Controller: <span class="text-primary-azure">${rec.controller}</span></p><p class="text-xs text-text-secondary mt-1">Purpose: ${rec.purpose || 'Not specified'}</p></div>`).join('') : `<div class="text-center text-text-muted py-8"><i class="fas fa-question-circle text-warning-color fa-2x mb-3"></i><p class="font-semibold text-text-secondary text-sm">No GECAN Ledger Records</p></div>`}</div></div>
                </div>
            </div>
        </div>
    `;
},

        /**
     * [NEW & BENCHMARKED] Renders the referral ID validation modal, reused from index.html logic.
     */
    renderReferralValidationSuite: (title, subtitle) => {
    return `
        <div class="submission-dialog-content p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-bold">${title}</h2>
                <p class="mt-2">${subtitle}</p>
            </div>
            <div>
                <input type="text" id="referral-id-input" placeholder="Enter Partner Referral ID" class="submission-form-input text-center font-mono tracking-widest p-4">
            </div>
            <div id="referral-error" class="text-center bg-red-500/10 p-3 rounded-lg hidden"></div>
            <div class="flex flex-col sm:flex-row gap-4 pt-2">
                <button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel</button>
                <button id="validate-referral-btn" class="btn-primary w-full py-3 font-semibold">
                    <i class="fas fa-key mr-2"></i>Validate & Proceed
                </button>
            </div>
        </div>`;
},

    /**
     * [NEW & BENCHMARKED] Renders the official wallet submission form after successful validation.
     */
    renderWalletSubmissionSuite: (referralInfo) => {
    const { report } = AppState.walletAnalysis;
    return `
        <div class="submission-dialog-content max-w-3xl">
            <form id="wallet-submission-form">
                <!-- Header -->
                <div class="p-6 border-b border-border-color flex justify-between items-start flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold">Official Wallet Submission</h2>
                        <p class="mt-1">Confirm details for official GECAN ledger entry.</p>
                    </div>
                    <button type="button" onclick="document.getElementById('submission-modal').close()" class="text-2xl text-text-muted hover:text-white transition-colors">×</button>
                </div>

                <!-- Scrollable Content -->
                <div class="p-6 space-y-6 overflow-y-auto">
                    <fieldset>
                        <legend>Transaction Context</legend>
                        <div class="space-y-4">
                            <div><label>Wallet Address to be Submitted</label><input type="text" class="submission-form-input" value="${report.wallet.address}" readonly></div>
                            <div><label>Target Offer ID (If Applicable)</label><select id="submission-offer-id" class="submission-form-select"></select></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Your Details (Submitter)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label>Your Full Name*</label><input type="text" id="submitter-name" class="submission-form-input" placeholder="e.g., Jane Smith" required></div>
                            <div><label>Your Role*</label><input type="text" id="submitter-role" class="submission-form-input" placeholder="e.g., Mandate, Broker" required></div>
                            <div><label>Your Contact Email*</label><input type="email" id="submitter-email" class="submission-form-input" placeholder="you@example.com" required></div>
                            <div><label>Your Contact Phone*</label><input type="tel" id="submitter-phone" class="submission-form-input" placeholder="+1 555 123 4567" required></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Alleged Wallet Controller</legend>
                        <div class="space-y-4">
                            <div><label>Principal / Entity Name*</label><input type="text" id="controller-name" class="submission-form-input" placeholder="e.g., John Doe / XYZ Trading LLC" required></div>
                            <div class="recommendation-box">
                                <h4>Recommendation</h4>
                                <p>For expedited review, it is highly recommended to provide the alleged controller's Customer Information Sheet (CIS) and Proof of Funds (POF) via secure email to <strong>compliance@gecan.co</strong> after submission.</p>
                            </div>
                        </div>
                    </fieldset>
                    
                    <div><label>Referring Partner</label><input type="text" class="submission-form-input" value="${referralInfo.partnerName} (${referralInfo.referralId})" readonly></div>
                </div>

                <!-- Footer / Actions -->
                <div class="p-6 border-t border-border-color mt-auto flex flex-col sm:flex-row gap-4 flex-shrink-0">
                    <button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel Submission</button>
                    <button type="submit" id="confirm-submission-btn" class="btn-primary w-full py-3 font-semibold bg-gradient-to-r from-success-color to-emerald-600 border-success-color">
                        <i class="fas fa-check-circle mr-2"></i>Confirm & Submit to Ledger
                    </button>
                </div>
            </form>
        </div>`;
},
    /**
     * Renders the main container for the Institutional Modeler toolkit, including the deal type selection.
     * @returns {string} The HTML structure for the modeler interface.
     */
    renderInstitutionalModelerUI: () => {
    const dealTypes = [
        { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between assets in the GECAN matrix.', gradient: 'from-blue-500 to-cyan-500' },
        { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades with institutional-grade parameters.', gradient: 'from-yellow-500 to-orange-500' },
        { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized credit facilities with flexible terms.', gradient: 'from-green-500 to-emerald-500' },
        { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit to unlock institutional capital.', gradient: 'from-purple-500 to-violet-500' },
    ];
    return `<div class="flex flex-col gap-8 animate-fade-in-up"><div class="report-section p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-azure mr-3"></i>Institutional Deal Modeler</h2><button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-error-color/20 hover:border-error-color/50 hover:text-error-color whitespace-nowrap"><i class="fas fa-undo mr-2"></i>Reset All Parameters</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map((deal, index) => `<div class="deal-type-card glass p-6 text-center ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl deal-type-icon mx-auto"><i class="fas ${deal.icon}"></i></div><h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p></div>`).join('')}</div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-3 glass p-6 md:p-8 rounded-2xl flex flex-col"></div><div id="modeler-output-container" class="lg:col-span-2 glass p-6 md:p-8 rounded-2xl flex flex-col"></div></div></div>`;
},

    /**
     * Renders the main input panel for the Modeler, including the collapsible pricing configuration.
     * @returns {string} The HTML for the input panel.
     */
            renderModelerInputPanel: () => {
                const { activeDealType, pricingConfig } = AppState.modeler;
                
                let dealPanelHTML = '';
                // This logic block acts as the master router for the panel's content.
                if (activeDealType === 'AssetSwap') {
                    dealPanelHTML = UI.renderAssetSwapPanel();
                } else if (activeDealType === 'CommodityTrade') {
                    dealPanelHTML = UI.renderCommodityTradePanel();
                } else if (activeDealType === 'CryptoLoan') {
                    // Renders the standard, functional panel inside a styled container for consistency.
                    dealPanelHTML = `
                    <div class="p-6 rounded-2xl bg-background-dark border border-border-color">
                        <h3 class="step-title mb-4">Crypto Loan Parameters</h3>
                        ${UI.renderCryptoLoanPanel()}
                    </div>`;
                } else if (activeDealType === 'SBLCMonetization') {
                    // Renders the standard, functional panel inside a styled container for consistency.
                    dealPanelHTML = `
                    <div class="p-6 rounded-2xl bg-background-dark border border-border-color">
                        <h3 class="step-title mb-4">SBLC Monetization Parameters</h3>
                        ${UI.renderSBLCMonetizationPanel()}
                    </div>`;
                } else {
                    dealPanelHTML = `<p class="text-error-color text-center p-4">Guided workflow is optimized for Asset Swap & Commodity Trade. Please select a supported deal type.</p>`;
                }

                // This is the generic pricing configurator, used ONLY by Asset Swap.
                const pricingConfigHTML = `<div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}"><div class="grid grid-cols-2 gap-4 mb-4"><select data-path="pricingConfig.offerType" class="form-select">${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}</select><select data-path="pricingConfig.isValueInPercent" class="form-select">${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label><input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label><input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input"></div></div></div>`;
                
                // This logic is critical: It ensures the generic pricing panel is ONLY shown for Asset Swap,
                // as the Commodity Trade workflow has its own integrated commission steps.
                const showGenericPricingConfig = activeDealType === 'AssetSwap';

                return `
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-4">
                    <i class="fas fa-sliders-h text-primary-azure"></i>Deal Parameters
                </h2>
                <div class="space-y-6 flex-grow flex flex-col">
                    ${dealPanelHTML}
                    
                    <div class="guided-step-card mt-auto ${showGenericPricingConfig ? '' : 'hidden'}">
                        <div class="step-header cursor-pointer" onclick="Logic.togglePricingConfig()">
                            <div class="step-number">3</div>
                            <div class="flex-grow">
                                <h3 class="step-title">Configure Pricing</h3>
                                <p class="text-sm text-text-muted">Optional: Add institutional discounts or premiums.</p>
                            </div>
                            <i class="fas fa-chevron-down text-xl text-text-muted transition-transform ${pricingConfig.isVisible ? 'rotate-180' : ''}"></i>
                        </div>
                        <div class="step-content">${pricingConfigHTML}</div>
                    </div>
                </div>`;
            },

    /**
 * Renders the specific input fields for the Asset Swap deal type.
 * @returns {string} The HTML for the Asset Swap panel.
 */
            renderAssetSwapPanel: () => {
                const state = AppState.modeler.assetSwap;
                const assetOptions = (selectedKey) => AppState.marketData
                    .filter(a => a.type !== 'Cross-Rate' && a.price > 0)
                    .sort((a, b) => a.baseAsset.localeCompare(b.baseAsset))
                    .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
                
                // --- DEFINITIVE FIX: Corrected the typo from getByKey back to the proper getAssetByKey ---
                const fromAsset = Utils.getAssetByKey(state.fromAssetKey);

                // --- Intelligent State Determination ---
                const areAssetsDefined = state.fromAssetKey && state.toAssetKey && (state.fromAssetKey !== state.toAssetKey);
                const isAmountDefined = parseFloat(String(state.amount).replace(/,/g, '')) > 0;

                const fromAssetFocus = !areAssetsDefined ? 'highlight-focus' : '';
                const toAssetFocus = !areAssetsDefined ? 'highlight-focus' : '';
                const amountFocus = areAssetsDefined && !isAmountDefined ? 'highlight-focus' : '';
                
                // Use a timeout to apply focus after the element is rendered in the DOM
                setTimeout(() => {
                    const elToFocus = document.querySelector('.highlight-focus');
                    if (elToFocus) {
                        elToFocus.focus();
                        elToFocus.select();
                    }
                }, 100);

                return `
                <!-- Step 1: Define Assets -->
                <div class="guided-step-card">
                    <div class="step-header ${areAssetsDefined ? 'completed' : ''}">
                        <div class="step-number">
                            <i class="fas ${areAssetsDefined ? 'fa-check' : 'fa-exchange-alt'}"></i>
                        </div>
                        <div>
                            <h3 class="step-title">Define Assets</h3>
                            <p class="text-sm text-text-muted">Select the assets for the transaction.</p>
                        </div>
                    </div>
                    <div class="step-content flex items-start gap-2">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-text-muted mb-2">From Asset (To Purchase)</label>
                            <select data-path="assetSwap.fromAssetKey" class="form-select ${fromAssetFocus}">${assetOptions(state.fromAssetKey)}</select>
                        </div>
                        <div class="swap-icon-container">
                            <button onclick="Logic.swapAssets()" class="swap-icon-button" title="Swap Assets">
                                <i id="swap-icon" class="fas fa-exchange-alt text-lg"></i>
                            </button>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-text-muted mb-2">To Asset (Settlement Protocol)</label>
                            <select data-path="assetSwap.toAssetKey" class="form-select ${toAssetFocus}">${assetOptions(state.toAssetKey)}</select>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Specify Quantity -->
                <div class="guided-step-card">
                    <div class="step-header ${isAmountDefined ? 'completed' : ''}">
                         <div class="step-number">
                            <i class="fas ${isAmountDefined ? 'fa-check' : 'fa-coins'}"></i>
                        </div>
                        <div>
                            <h3 class="step-title">Specify Quantity</h3>
                            <p class="text-sm text-text-muted">Enter the amount of the asset to be purchased.</p>
                        </div>
                    </div>
                    <div class="step-content">
                        <label class="block text-sm font-medium text-text-muted mb-2">Amount to Purchase (<span class="font-bold text-white">${fromAsset.baseAsset || 'N/A'}</span>)</label>
                        <input type="text" data-path="assetSwap.amount" value="${(parseFloat(state.amount) || 0).toLocaleString()}" class="form-input text-lg font-bold ${amountFocus}">
                    </div>
                </div>
                `;
            },

/**
 * SEVERELY ENHANCED: Renders the multi-step, interactive UI for structuring a physical commodity trade.
 * @returns {string} The complete HTML for the Commodity Trade panel.
 */
            renderCommodityTradePanel: () => {
                const state = AppState.modeler.commodityTrade;
                const calculation = Logic.calculateCommodityTrade();
                
                const currentUnitOfMeasure = commodityData.specifications[state.assetKey]?.uom || state.unitOfMeasure;
                if (state.unitOfMeasure !== currentUnitOfMeasure) { state.unitOfMeasure = currentUnitOfMeasure; }
                
                const commodityOptions = (selectedKey) => AppState.marketData.filter(asset => ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Commodity', 'Energy'].some(term => asset.type?.includes(term))).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${commodityData.specifications[a.key]?.uom || 'Unit'})</option>`).join('');
                const settlementOptions = (selectedKey) => AppState.marketData.filter(a => a.price > 0).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset}</option>`).join('');
                
                const isCommodityDefined = state.assetKey && state.quantity > 0;
                const isPriceDefined = (state.pricingModel === 'Fixed' && state.fixedPrice > 0) || (state.pricingModel !== 'Fixed' && state.priceAdjustmentValue !== null && state.priceAdjustmentValue >= 0);
                const isCommissionDefined = state.isCommissionIncluded ? (state.commissionValue >= 0) : (state.markupValue !== null && state.markupValue >= 0);
                const isSettlementDefined = state.settlementAssetKey && state.settlementAssetKey.length > 0;
                
                setTimeout(() => {
                    let selector = '';
                    if (!isCommodityDefined) selector = state.assetKey ? '[data-path="commodityTrade.quantity"]' : '[data-path="commodityTrade.assetKey"]';
                    else if (!isPriceDefined) selector = (state.pricingModel === 'Fixed') ? '[data-path="commodityTrade.fixedPrice"]' : '[data-path="commodityTrade.priceAdjustmentValue"]';
                    else if (!isCommissionDefined) selector = state.isCommissionIncluded ? '[data-path="commodityTrade.commissionValue"]' : '[data-path="commodityTrade.markupValue"]';
                    else if (!isSettlementDefined) selector = '[data-path="commodityTrade.settlementAssetKey"]';
                    if (selector) {
                        const elToFocus = document.querySelector(selector);
                        if (elToFocus && typeof elToFocus.focus === 'function') {
                            elToFocus.focus();
                            if (typeof elToFocus.select === 'function') elToFocus.select();
                        }
                    }
                }, 150);
                
                const commissionInputsHTML = state.isCommissionIncluded ?
                    `<div class="space-y-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Commission Included Per ${currentUnitOfMeasure}</label><input type="number" data-path="commodityTrade.commissionValue" value="${state.commissionValue}" min="0" step="0.01" class="form-input text-lg font-bold ${!isCommissionDefined ? 'highlight-focus' : ''}" placeholder="0.00"><p class="text-xs text-text-muted mt-2 opacity-75">Commission is already included in the Net Price shown above.</p></div></div>` :
                    `<div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Mark-Up Value</label><input type="number" data-path="commodityTrade.markupValue" value="${state.markupValue}" min="0" step="0.01" class="form-input text-lg font-bold ${!isCommissionDefined ? 'highlight-focus' : ''}" placeholder="0.00"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Mark-Up Type</label><select data-path="commodityTrade.isMarkupInPercent" class="form-select"><option value="false" ${!state.isMarkupInPercent ? 'selected':''}>Fixed Amount</option><option value="true" ${state.isMarkupInPercent ? 'selected':''}>Percentage (%)</option></select></div></div><p class="text-xs text-text-muted opacity-75">Mark-up will be added to Net Price to create Final Price.</p></div>`;
                
                const calculationDisplay = (calculation && calculation.isValid) ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-sky-500/10 to-indigo-500/10 rounded-lg border border-sky-500/20">
                        <h4 class="text-sm font-semibold text-sky-400 mb-3 flex items-center"><i class="fas fa-calculator mr-2"></i>Live Calculation Results</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><span class="text-text-muted">Net Price / ${currentUnitOfMeasure}:</span><span class="float-right font-mono text-sky-400">${Utils.formatPrice(calculation.netPricePerUnitUSD)}</span></div>
                            <div><span class="text-text-muted">Final Price / ${currentUnitOfMeasure}:</span><span class="float-right font-mono text-sky-400">${Utils.formatPrice(calculation.finalPricePerUnitUSD)}</span></div>
                            <div class="col-span-2 pt-2 border-t border-sky-500/20"><span class="text-text-muted font-medium">Total Final Value:</span><span class="float-right font-mono text-lg font-bold text-sky-400">${Utils.formatNumber(calculation.primaryValue, 2)} ${calculation.primaryUnit}</span></div>
                        </div>
                    </div>` : '';
                
                return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-text-primary flex items-center"><i class="fas fa-oil-can mr-3 text-primary-azure"></i>Commodity Trade Configuration</h2>
                        <button onclick="Logic.resetCommodityTrade()" class="btn-secondary px-3 py-1 text-xs rounded-lg flex items-center gap-2"><i class="fas fa-undo-alt"></i>Reset All</button>
                    </div>
                    <div class="guided-step-card">
                        <div class="step-header ${isCommodityDefined ? 'completed' : ''}"><div class="step-number"><i class="fas ${isCommodityDefined ? 'fa-check' : 'fa-oil-can'}"></i></div><div><h3 class="step-title">Define Commodity</h3><p class="text-sm text-text-muted">Select product and specify quantity.</p></div></div>
                        <div class="step-content space-y-4">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="col-span-2"><label class="block text-sm font-medium text-text-muted mb-2">Commodity to Trade</label><select data-path="commodityTrade.assetKey" class="form-select">${commodityOptions(state.assetKey)}</select></div>
                                <div><label class="block text-sm font-medium text-text-muted mb-2">Unit of Measure</label><div class="form-input bg-background-light text-primary-azure font-mono text-center font-bold">${currentUnitOfMeasure}</div></div>
                            </div>
                            <div><label class="block text-sm font-medium text-text-muted mb-2">Quantity (${currentUnitOfMeasure})</label><input type="number" data-path="commodityTrade.quantity" value="${state.quantity}" min="1" class="form-input text-lg font-bold ${!isCommodityDefined ? 'highlight-focus' : ''}" placeholder="1.0"></div>
                        </div>
                    </div>
                    <div class="guided-step-card">
                        <div class="step-header ${isPriceDefined ? 'completed' : ''}"><div class="step-number"><i class="fas ${isPriceDefined ? 'fa-check' : 'fa-tags'}"></i></div><div><h3 class="step-title">Define Net Price</h3><p class="text-sm text-text-muted">Set pricing model and base price structure.</p></div></div>
                        <div class="step-content space-y-4">
                            <div class="flex items-center justify-around p-2 bg-background-dark rounded-lg">${Object.entries(commodityData.pricingModels).map(([key, model]) => `<label class="flex-1 text-center p-2 rounded-lg cursor-pointer transition-colors ${state.pricingModel === key ? 'bg-primary-azure/20 text-primary-azure font-semibold' : 'hover:bg-background-light'}"><input type="radio" name="pricingModel" value="${key}" ${state.pricingModel === key ? 'checked' : ''} data-path="commodityTrade.pricingModel" class="hidden"><i class="fas ${model.icon} text-lg mb-1"></i><div class="font-semibold text-sm">${model.label}</div></label>`).join('')}</div>
                            ${state.pricingModel === 'Fixed' ? `<div><label class="block text-sm font-medium text-text-muted mb-2">Fixed Price per ${currentUnitOfMeasure}</label><input type="number" data-path="commodityTrade.fixedPrice" value="${state.fixedPrice}" min="0" step="0.01" class="form-input text-lg font-bold ${!isPriceDefined ? 'highlight-focus' : ''}" placeholder="0.00"></div>` : `<div><label class="block text-sm font-medium text-text-muted mb-2">Price Adjustment (${state.pricingModel === 'PlattsMinus' ? 'Discount' : 'Premium'}) per ${currentUnitOfMeasure}</label><input type="number" data-path="commodityTrade.priceAdjustmentValue" value="${state.priceAdjustmentValue}" min="0" step="0.01" class="form-input text-lg font-bold ${!isPriceDefined ? 'highlight-focus' : ''}" placeholder="0.00"><p class="text-xs text-text-muted mt-2 opacity-75">${state.pricingModel === 'PlattsMinus' ? 'Amount to subtract from market price.' : 'Amount to add to market price.'}</p></div>`}
                        </div>
                    </div>
                    <div class="guided-step-card">
                        <div class="step-header ${isCommissionDefined ? 'completed' : ''}"><div class="step-number"><i class="fas ${isCommissionDefined ? 'fa-check' : 'fa-calculator'}"></i></div><div><h3 class="step-title">Configure Commission</h3><p class="text-sm text-text-muted">Define commission structure and fees.</p></div></div>
                        <div class="step-content space-y-4">
                            <div class="flex items-center justify-around p-2 bg-background-dark rounded-lg"><label class="flex-1 text-center p-2 rounded-lg cursor-pointer transition-colors ${!state.isCommissionIncluded ? 'bg-primary-azure/20 text-primary-azure font-semibold' : 'hover:bg-background-light'}"><input type="radio" name="isCommissionIncluded" value="false" ${!state.isCommissionIncluded ? 'checked' : ''} data-path="commodityTrade.isCommissionIncluded" class="hidden"><i class="fas fa-plus-circle text-lg mb-1"></i><div class="font-semibold text-sm">Add Mark-Up</div></label><label class="flex-1 text-center p-2 rounded-lg cursor-pointer transition-colors ${state.isCommissionIncluded ? 'bg-primary-azure/20 text-primary-azure font-semibold' : 'hover:bg-background-light'}"><input type="radio" name="isCommissionIncluded" value="true" ${state.isCommissionIncluded ? 'checked' : ''} data-path="commodityTrade.isCommissionIncluded" class="hidden"><i class="fas fa-check-circle text-lg mb-1"></i><div class="font-semibold text-sm">Commission Included</div></label></div>
                            ${commissionInputsHTML}
                        </div>
                    </div>
                    <div class="guided-step-card">
                        <div class="step-header ${isSettlementDefined ? 'completed' : ''}"><div class="step-number"><i class="fas ${isSettlementDefined ? 'fa-check' : 'fa-coins'}"></i></div><div><h3 class="step-title">Define Settlement</h3><p class="text-sm text-text-muted">Select final settlement currency.</p></div></div>
                        <div class="step-content"><label class="block text-sm font-medium text-text-muted mb-2">Settlement Currency</label><select data-path="commodityTrade.settlementAssetKey" class="form-select">${settlementOptions(state.settlementAssetKey)}</select></div>
                    </div>
                    ${calculationDisplay}
                </div>`;
            },

/**
 * Renders the specific input fields for the Crypto Loan deal type.
 * @returns {string} The HTML for the Crypto Loan panel.
 */
renderCryptoLoanPanel: () => {
    const state = AppState.modeler.cryptoLoan;
    const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type === 'Cryptocurrency').map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
    return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div></div>`;
},

/**
 * Renders the specific input fields for the SBLC Monetization deal type.
 * @returns {string} The HTML for the SBLC Monetization panel.
 */
renderSBLCMonetizationPanel: () => {
    const state = AppState.modeler.sblcMonetization;
    return `<div><label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label><input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div>`;
},

/**
 * Renders the main output panel, dynamically displaying results for the active model.
 * @param {object|null} calc - The full calculation object from Logic.calculateModel().
 * @returns {string} The HTML for the output/analysis panel.
 */
            renderModelerOutputPanel: (calc) => {
                if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
            
                let customAnalysisPanel = '';
                let primaryAnalysisCards = '';
            
                // ========================================================================
                // === ASSET SWAP WORKFLOW (PRESERVED WORD-FOR-WORD - NO REGRESSIONS) ===
                // ========================================================================
                if (AppState.modeler.activeDealType === 'AssetSwap') {
                    const { 
                        fromAsset, toAsset, amountToGive, baseValueInToAsset, 
                        finalValueToBuyerInToAsset, totalCommissionInToAsset, 
                        netValueDescription, grossValueDescription, directRate, inverseRate
                    } = calc;
                    
                    primaryAnalysisCards = `
                        <div class="output-metric-card base-value">
                            <p class="label"><i class="fas fa-exchange-alt"></i>Base Settlement Value</p>
                            <p class="value">${Utils.formatNumber(baseValueInToAsset, 4)} <span class="text-2xl">${toAsset.baseAsset}</span></p>
                            <p class="sub-value">Market Rate Settlement</p>
                        </div>
                        <div class="output-metric-card net">
                            <p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Settlement to Buyer</p>
                            <p class="value">${Utils.formatNumber(finalValueToBuyerInToAsset, 4)} <span class="text-2xl">${toAsset.baseAsset}</span></p>
                            <p class="sub-value">${netValueDescription}</p>
                        </div>
                        <div class="output-metric-card commission">
                            <p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p>
                            <p class="value">${Utils.formatNumber(totalCommissionInToAsset, 4)} <span class="text-2xl">${toAsset.baseAsset}</span></p>
                            <p class="sub-value">${grossValueDescription}</p>
                        </div>`;

                    const { offerType, grossValue, netValue, isValueInPercent } = AppState.modeler.pricingConfig;
                    const isPricingActive = totalCommissionInToAsset > 0 || netValue != 0;
                    
                    let pricingBreakdownHTML = '';
                    if (isPricingActive) {
                        const netOfferSign = offerType === 'discount' ? '-' : '+';
                        const netOfferColor = offerType === 'discount' ? 'text-red-400' : 'text-green-400';
                        const netOfferIcon = offerType === 'discount' ? 'fa-minus-circle' : 'fa-plus-circle';
                        const netOfferText = `${Utils.formatNumber(netValue)}${isValueInPercent ? '%' : ''} Net ${offerType}`;

                        pricingBreakdownHTML = `
                        <div class="mt-4 pt-4 border-t border-border-color space-y-4">
                            <p class="label !mb-2 text-primary-royal"><i class="fas fa-calculator"></i>Pricing & Commission Analysis</p>
                            <div class="p-3 rounded-lg bg-background-light space-y-2">
                                <div class="flex justify-between items-center"><span class="text-sm text-text-muted">Base Settlement Value</span><span class="font-mono font-semibold">${Utils.formatNumber(baseValueInToAsset, 4)} ${toAsset.baseAsset}</span></div>
                                <div class="flex justify-between items-center ${netOfferColor}"><span class="text-sm font-semibold flex items-center gap-2"><i class="fas ${netOfferIcon}"></i> ${netOfferText}</span><span class="font-mono font-semibold">${netOfferSign} ${Utils.formatNumber(baseValueInToAsset - finalValueToBuyerInToAsset, 4)} ${toAsset.baseAsset}</span></div>
                                <div class="border-t border-border-color my-1"></div>
                                <div class="flex justify-between items-center text-white"><span class="text-sm font-bold">Final Settlement</span><span class="font-mono font-bold text-lg">${Utils.formatNumber(finalValueToBuyerInToAsset, 4)} ${toAsset.baseAsset}</span></div>
                            </div>
                            <div class="p-3 rounded-lg bg-background-light space-y-2">
                                <div class="flex justify-between items-center"><span class="text-sm text-text-muted">Gross Offer (${grossValue}%)</span><span class="font-mono font-semibold">${Utils.formatNumber(baseValueInToAsset * (grossValue/100), 4)} ${toAsset.baseAsset}</span></div>
                                <div class="flex justify-between items-center"><span class="text-sm text-text-muted">Net Offer (${netValue}%)</span><span class="font-mono font-semibold">- ${Utils.formatNumber(baseValueInToAsset * (netValue/100), 4)} ${toAsset.baseAsset}</span></div>
                                <div class="border-t border-border-color my-1"></div>
                                <div class="flex justify-between items-center text-warning-color"><span class="text-sm font-bold">Commission Pool</span><span class="font-mono font-bold text-lg">${Utils.formatNumber(totalCommissionInToAsset, 4)} ${toAsset.baseAsset}</span></div>
                            </div>
                        </div>`;
                    }

                    customAnalysisPanel = `
                    <div class="output-metric-card p-4 mt-4 border-l-4 border-primary-royal">
                        <div class="space-y-3">
                            <div class="p-3 rounded-lg bg-background-light border border-red-500/30">
                                <div class="flex justify-between items-center text-xs text-red-400 font-semibold"><span>PURCHASING</span><i class="fas fa-arrow-up"></i></div>
                                <div class="flex justify-between items-baseline mt-1">
                                    <span class="text-xl font-bold font-mono text-white">${Utils.formatNumber(amountToGive, 4)} ${fromAsset.baseAsset}</span>
                                </div>
                            </div>
                            <div class="p-3 rounded-lg bg-background-light border border-green-500/30">
                                <div class="flex justify-between items-center text-xs text-green-400 font-semibold"><span>BASE SETTLEMENT</span><i class="fas fa-arrow-down"></i></div>
                                <div class="flex justify-between items-baseline mt-1">
                                    <span class="text-xl font-bold font-mono text-white">${Utils.formatNumber(baseValueInToAsset, 4)} ${toAsset.baseAsset}</span>
                                </div>
                            </div>
                        </div>
                        ${pricingBreakdownHTML}
                        <div class="mt-4 pt-4 border-t border-border-color text-center">
                             <p class="text-xs text-text-muted mb-1">Live Institutional Cross Rate</p>
                             <p class="text-lg font-bold font-mono text-primary-azure">
                                1 ${fromAsset.baseAsset} <i class="fas fa-equals text-xs mx-2"></i> ${Utils.formatNumber(directRate, 8)} ${toAsset.baseAsset}
                             </p>
                             <p class="text-xs font-mono text-text-muted mt-1">(1 ${toAsset.baseAsset} ≈ ${Utils.formatNumber(inverseRate, 8)} ${fromAsset.baseAsset})</p>
                        </div>
                    </div>`;

                // ========================================================================
                // === COMMODITY TRADE WORKFLOW (ELEVATED TO PINNACLE STANDARD) ===
                // ========================================================================
                } else if (AppState.modeler.activeDealType === 'CommodityTrade') {
                    const { primaryValue, primaryUnit, dealTitle, totalCommissionInSettlement, baseCostPerUnitUSD, commissionPerUnitUSD, netPricePerUnitUSD, finalPricePerUnitUSD, plattsPriceUSD } = calc;
                    const state = AppState.modeler.commodityTrade;

                    primaryAnalysisCards = `
                        <div class="output-metric-card base-value">
                            <p class="label"><i class="fas fa-file-invoice-dollar"></i>Total Final Settlement</p>
                            <p class="value">${Utils.formatNumber(primaryValue, 2)} <span class="text-2xl">${primaryUnit}</span></p>
                            <p class="sub-value">${dealTitle}</p>
                        </div>
                        <div class="output-metric-card net">
                            <p class="label"><i class="fas fa-tag"></i>Final Price Per ${state.unitOfMeasure}</p>
                            <p class="value">${Utils.formatPrice(finalPricePerUnitUSD)}</p>
                            <p class="sub-value">Net: ${Utils.formatPrice(netPricePerUnitUSD)} + Comm: ${Utils.formatPrice(commissionPerUnitUSD)}</p>
                        </div>
                        <div class="output-metric-card commission">
                            <p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p>
                            <p class="value">${Utils.formatNumber(totalCommissionInSettlement, 2)} <span class="text-2xl">${primaryUnit}</span></p>
                            <p class="sub-value">@ ${Utils.formatPrice(commissionPerUnitUSD)} per ${state.unitOfMeasure}</p>
                        </div>`;
                    
                    customAnalysisPanel = `
                    <div class="output-metric-card p-4 mt-4 border-l-4 border-primary-royal">
                        <p class="label !mb-2 text-primary-royal"><i class="fas fa-stream"></i>Pinnacle Pricing Analysis (Per ${state.unitOfMeasure})</p>
                        <div class="p-3 rounded-lg bg-background-light space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-text-muted">Live Market Price</span>
                                <span class="font-mono font-semibold">${Utils.formatPrice(plattsPriceUSD)}</span>
                            </div>
                            <div class="flex justify-between items-center text-blue-400">
                                <span class="text-sm">Net Price to Buyer</span>
                                <span class="font-mono font-semibold">${Utils.formatPrice(netPricePerUnitUSD)}</span>
                            </div>
                            <div class="flex justify-between items-center text-yellow-400">
                                <span class="text-sm">Commission / Mark-Up</span>
                                <span class="font-mono font-semibold">+ ${Utils.formatPrice(commissionPerUnitUSD)}</span>
                            </div>
                            <div class="border-t border-border-color my-1"></div>
                            <div class="flex justify-between items-center text-white">
                                <span class="text-sm font-bold">Final Price</span>
                                <span class="font-mono font-bold text-lg">${Utils.formatPrice(finalPricePerUnitUSD)}</span>
                            </div>
                        </div>
                    </div>`;

                } else {
                    primaryAnalysisCards = `<p class="text-center text-text-muted py-12">Analysis dashboard is optimized for Asset Swap & Commodity Trade. Please select a supported deal type.</p>`;
                }
            
                return `
                <div class="flex flex-col h-full animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-success-color"></i>Deal Analysis & Projections</h2>
                    <div class="space-y-4 flex-grow">
                        ${primaryAnalysisCards}
                        ${customAnalysisPanel}
                    </div>
                    <div class="mt-auto pt-6 border-t border-border-color">
                        <button onclick="Logic.openImfpaModal()" class="btn-primary w-full py-3 font-bold">
                            <i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Commission Manager
                        </button>
                    </div>
                </div>`;
            },
/**
 * Renders a simple SVG yield graph for the Crypto Loan model.
 * @param {object} calc - The calculation object for the Crypto Loan.
 * @returns {string} An SVG string representing the graph.
 */
renderYieldGraph: (calc) => {
    const { loanPrincipal, totalRepayment, tenureMonths } = calc;
    if (tenureMonths <= 0) return '<p class="text-center text-text-muted text-sm">Invalid tenure for graph.</p>';
    const points = Array.from({length: tenureMonths + 1}, (_, i) => ({ month: i, value: loanPrincipal + ((totalRepayment - loanPrincipal) / tenureMonths * i) }));
    const width=300, height=120, marginY=20, marginX=30; const yMax = totalRepayment, yMin = loanPrincipal;
    const xScale = (width - marginX*2) / tenureMonths; const yScale = (yMax > yMin) ? (height - marginY*2) / (yMax - yMin) : 0;
    const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${(marginX + p.month * xScale).toFixed(2)} ${(height - marginY - ((p.value - yMin) * yScale)).toFixed(2)}`).join(' ');
    return `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full"><line x1="${marginX}" y1="${height-marginY}" x2="${width-marginX}" y2="${height-marginY}" stroke="var(--border-color)"/><text x="${marginX-5}" y="${marginY+5}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMax, 0)}</text><text x="${marginX-5}" y="${height-marginY}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMin, 0)}</text><path d="${pathData}" fill="none" stroke="var(--success-color)" stroke-width="2"/></svg>`;
},

    // --- IMFPA & DOCUMENT EXECUTION SUITE RENDERERS (v6.0 Pinnacle Overhaul) ---
    renderImfpaModal: () => {
    const { legal } = AppState.modeler;
    const isImfpa = legal.agreementType === 'IMFPA';
    const mainSectionTitle = isImfpa ? 'Commission Allocation & Parties' : 'Signatory Parties';
    const mainSectionIcon = isImfpa ? 'fa-sitemap' : 'fa-users';

    // --- MILITARY-GRADE FINAL VALIDATION CHECK (NEW) ---
    const isReadyToSynthesize = Logic.validateImfpaData();
    const synthesizeButtonClass = isReadyToSynthesize 
        ? 'from-premium-gold to-yellow-600 border-premium-gold hover:shadow-lg hover:shadow-premium-gold-glow' // Ready State (Premium Gold)
        : 'from-gray-600 to-gray-800 border-gray-600 cursor-not-allowed'; // Incomplete State (Muted Gray)
    const synthesizeButtonText = isReadyToSynthesize 
        ? 'Synthesize & Preview Full Document' 
        : 'Complete All Required Fields';

    return `
        <div class="dialog-content-wrapper">
            <div class="p-6 md:p-8 flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-start mb-4 imfpa-header print-hide">
                    <div>
                        <h2 class="text-3xl font-bold">Commission & Contract Suite</h2>
                        <p class="text-premium-text-secondary">Synthesize Legally Binding Agreements with Supreme Intelligence.</p>
                    </div>
                    <button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-premium-text-secondary hover:text-white transition-colors">&times;</button>
                </div>
                <div class="mb-6 p-4 rounded-lg bg-black/20 flex items-center justify-center gap-6">
                    <span class="toggle-label ${!isImfpa ? 'active' : 'text-gray-500'}">NCNDA Only</span>
                    <label class="agreement-toggle"><div class="toggle-switch"><input type="checkbox" onchange="Logic.toggleAgreementType(this.checked)" ${isImfpa ? 'checked' : ''}><span class="toggle-slider"></span></div></label>
                    <span class="toggle-label ${isImfpa ? 'active' : 'text-gray-500'}">Full IMFPA</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 flex-1 overflow-y-auto pr-2">
                    <div class="lg:col-span-3 space-y-6 overflow-y-auto pr-4">
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <h3 class="imfpa-section-title"><i class="fas ${mainSectionIcon} mr-3"></i>${mainSectionTitle}</h3>
                                <div class="text-right ${isImfpa ? 'block' : 'hidden'}">
                                    <p class="text-xs text-premium-text-secondary">Total Pool</p>
                                    <p id="imfpa-total-commission-pool" class="text-2xl font-bold text-primary-azure">${Utils.formatPrice(legal.totalCommission)}</p>
                                </div>
                            </div>
                            <div id="imfpa-controls" class="flex justify-between items-center">
                                <button onclick="Logic.addImfpaGroup()" class="btn-secondary px-3 py-1 text-sm rounded-lg"><i class="fas fa-plus mr-1"></i>${isImfpa ? 'Add Group' : 'Add Signatory Party'}</button>
                                <div class="flex items-center gap-4 ${isImfpa ? 'flex' : 'hidden'}">
                                    <div class="flex items-center gap-2 text-xs">
                                        <input type="checkbox" id="auto-balance-toggle" onchange="AppState.modeler.legal.autoBalance = this.checked; Logic.updateImfpaCalculations();" ${legal.autoBalance ? 'checked' : ''} class="w-4 h-4 rounded text-premium-gold bg-premium-bg-dark border-premium-border focus:ring-premium-gold">
                                        <label for="auto-balance-toggle">Auto-Balance</label>
                                    </div>
                                    <div id="imfpa-total-allocated" class="text-right font-mono text-sm"></div>
                                </div>
                            </div>
                            <div class="space-y-4" id="imfpa-groups-container"></div>
                        </div>
                        <div class="space-y-6">
                            <h3 class="imfpa-section-title"><i class="fas fa-gavel mr-3"></i>Legal Framework</h3>
                            <div class="bg-black/20 p-4 rounded-lg">
                                <label class="block text-sm font-medium mb-2 text-premium-text-secondary">Governing Law & Jurisdiction*</label>
                                <input value="${legal.jurisdiction}" data-path="legal.jurisdiction" class="form-input" placeholder="e.g., Singapore, Dubai, England, Wales">
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg">
                                <label class="block text-sm font-medium mb-2 text-premium-text-secondary">Cross-Referenced Contract / SPA (Optional)</label>
                                <input value="${legal.spaReferenceCode || ''}" data-path="legal.spaReferenceCode" class="form-input font-mono" placeholder="e.g., GECAN-SPA-XYZ-12345">
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="imfpa-section-title"><i class="fas fa-eye mr-3"></i>Live Preview</h3>
                        <div id="contract-live-preview" class="h-full"></div>
                    </div>
                </div>
                
                <div class="pt-6 border-t border-premium-border mt-auto print-hide">
                    <button id="synthesize-btn" onclick="Logic.generateContract()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r ${synthesizeButtonClass}" ${!isReadyToSynthesize ? 'disabled' : ''}>
                        <i class="fas fa-file-signature mr-2"></i>${synthesizeButtonText}
                    </button>
                    <div id="contract-preview-container" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    `;
},
renderImfpaGroups: () => {
    const { legal } = AppState.modeler;
    const { groups, agreementType } = legal;
    const isImfpa = agreementType === 'IMFPA';

    // --- A. PINNACLE-GRADE HANDLING FOR IMFPA MODE ---
    if (isImfpa) {
        if (!groups || groups.length === 0) {
            return `<p class="text-center text-premium-text-secondary py-4">No allocation groups defined. Click 'Add Group' to begin.</p>`;
        }
        return groups.map((g, groupIndex) => `
            <div class="allocation-group-card p-4">
                <!-- ========================================================= -->
                <!-- === PINNACLE GROUP HEADER w/ REAL-TIME PARTY COUNTER === -->
                <!-- ========================================================= -->
                <div class="flex items-center gap-2 mb-3">
                    <input type="text" value="${g.name}" data-path="legal.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow !p-1 focus:ring-0 font-semibold text-lg !text-premium-text-primary" placeholder="Group Name">
                    <!-- REAL-TIME PARTY COUNTER -->
                    <span class="text-xs font-mono text-premium-text-secondary bg-black/20 px-2 py-1 rounded-md flex-shrink-0">
                        ${g.parties.length} ${g.parties.length === 1 ? 'Party' : 'Parties'}
                    </span>
                    <div class="relative w-32 flex-shrink-0"><input type="number" value="${g.percentage}" data-path="legal.groups[${groupIndex}].percentage" class="form-input text-right font-bold"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-premium-text-secondary pointer-events-none">%</span></div>
                    <button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-red-500 hover:text-red-400 text-xl font-bold w-8 h-8 flex-shrink-0 flex items-center justify-center transition-colors duration-300 rounded-full hover:bg-red-500/10">×</button>
                </div>
                <p id="imfpa-group-value-${groupIndex}" class="text-right text-premium-gold font-mono text-lg mb-4"></p>
                <div class="space-y-2 pl-4 border-l-2 border-premium-border">
                    ${g.parties.map((p, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('')}
                    <div class="flex justify-between items-center pt-2">
                        <button onclick="Logic.addImfpaParty(${groupIndex})" class="text-premium-gold hover:text-yellow-300 text-xs font-semibold"><i class="fas fa-user-plus mr-1"></i>Add Party</button>
                        <div id="imfpa-group-total-${groupIndex}" class="text-right font-mono text-xs"></div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    // --- B. SEVERELY GUIDED WORKFLOW FOR NCNDA-ONLY MODE ---
    else {
        if (!groups || groups.length === 0) {
            AppState.modeler.legal.groups.push({ name: 'NCNDA Signatories', percentage: 100, parties: [] });
        }
        const signatoryList = AppState.modeler.legal.groups[0].parties;
        if (signatoryList.length === 0) {
            return `<p class="text-center text-premium-text-secondary py-4">No signatory parties defined. Click 'Add Signatory Party' to begin.</p>`;
        }
        return signatoryList.map((p, partyIndex) => UI.renderImfpaParty(0, partyIndex)).join('');
    }
},

renderImfpaParty: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;

    // --- MILITARY-GRADE MULTI-STAGE VALIDATION ENGINE (v3.0) ---
    const isSufficient = party.legalName && party.email && party.contactNumber;
    const isComplete = isSufficient && party.role && party.passport?.number && party.passport?.authority && party.passport?.issueDate && party.passport?.expiryDate && party.payment?.method && party.payment?.currency && party.payment?.details;
    
    let validationStatus;
    if (isComplete) {
        validationStatus = {
            badgeClass: 'bg-green-500/20 text-green-400',
            badgeText: 'COMPLETE',
            indicatorClass: 'text-success-color',
            indicatorIcon: 'fa-check-double',
            indicatorText: 'All Details Provided'
        };
    } else if (isSufficient) {
        validationStatus = {
            badgeClass: 'bg-blue-500/20 text-blue-400',
            badgeText: 'SUFFICIENT',
            indicatorClass: 'text-primary-azure',
            indicatorIcon: 'fa-check-circle',
            indicatorText: 'Core Details Sufficient'
        };
    } else {
        validationStatus = {
            badgeClass: 'bg-red-500/20 text-red-400 animate-pulse',
            badgeText: 'INCOMPLETE',
            indicatorClass: 'text-error-color',
            indicatorIcon: 'fa-exclamation-triangle',
            indicatorText: 'Core Details Required'
        };
    }

    return `
        <div class="allocation-party-card p-3">
            <div class="flex items-center gap-2">
                <!-- ========================================================= -->
                <!-- === PINNACLE PARTY HEADER w/ DYNAMIC STATUS BADGE === -->
                <!-- ========================================================= -->
                <input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow !p-1 !text-sm focus:ring-0 !text-premium-text-primary" placeholder="Full Legal Name*">
                
                <!-- DYNAMIC STATUS BADGE (NEW) -->
                <span class="text-xs font-bold px-2 py-1 rounded-md flex-shrink-0 ${validationStatus.badgeClass}">
                    ${validationStatus.badgeText}
                </span>

                <div class="relative w-24 flex-shrink-0 ${AppState.modeler.legal.agreementType === 'IMFPA' ? 'block' : 'hidden'}">
                    <input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input !text-sm text-right">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-premium-text-secondary pointer-events-none">%</span>
                </div>
                
                <button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-red-500 text-lg w-6 h-6 flex-shrink-0 flex items-center justify-center transition-colors duration-300 rounded-full hover:bg-red-500/10">×</button>
            </div>

            <div class="mt-2 flex justify-between items-center">
                <!-- Dynamic Indicator Text -->
                <div class="flex items-center gap-2 text-xs ${validationStatus.indicatorClass}">
                    <i class="fas ${validationStatus.indicatorIcon}"></i>
                    <span>${validationStatus.indicatorText}</span>
                </div>
                <a onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-xs text-primary-amethyst cursor-pointer hover:underline flex items-center gap-1">
                    <i class="fas fa-user-cog"></i> 
                    Manage Details 
                    <i class="fas fa-chevron-down text-xs transition-transform ${party.detailsVisible ? 'rotate-180' : ''} ml-auto"></i>
                </a>
            </div>
            
            <div class="collapsible-content ${party.detailsVisible ? 'expanded' : ''}">
                <div>${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div>
            </div>
        </div>
    `;
},

renderImfpaPartyDetails: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
    
    // --- INTELLIGENT FIELD HIGHLIGHTING ENGINE ---
    // This helper function adds a green border class if the field has a value.
    const highlightIfComplete = (value) => value ? 'border-green-500/50' : '';

    const paymentDetailsPlaceholder = {
        'Bank Wire': 'Beneficiary, Bank, Address, Acct No, SWIFT/BIC, IBAN...',
        'USDT TRC-20': 'TRC-20 Wallet Address (e.g., T...)',
        'USDT ERC-20': 'ERC-20 Wallet Address (e.g., 0x...)'
    }[party.payment.method] || 'Enter relevant payment coordinates...';

    return `
        <div class="party-details-grid pt-4 mt-2 border-t border-premium-border">
            <!-- ========================================================= -->
            <!-- === GUIDED FIELDSET: CORE IDENTIFICATION === -->
            <!-- ========================================================= -->
            <fieldset class="col-span-2 border border-premium-border p-4 rounded-lg">
                <legend class="text-premium-text-secondary text-sm px-2">Core Identification</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="party-detail-label">Email Address*</label>
                        <input type="email" class="form-input !text-xs ${highlightIfComplete(party.email)}" value="${party.email || ''}" data-path="${base}.email" placeholder="Used for official correspondence">
                    </div>
                    <div>
                        <label class="party-detail-label">Contact Number*</label>
                        <input class="form-input !text-xs ${highlightIfComplete(party.contactNumber)}" value="${party.contactNumber || ''}" data-path="${base}.contactNumber" placeholder="+1-555-123-4567">
                    </div>
                </div>
            </fieldset>

            <!-- ========================================================= -->
            <!-- === GUIDED FIELDSET: OPTIONAL DETAILS === -->
            <!-- ========================================================= -->
            <fieldset class="col-span-2 border border-premium-border p-4 rounded-lg">
                <legend class="text-premium-text-secondary text-sm px-2">Optional Details (Recommended for Expedited Review)</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="party-detail-label">Role</label>
                        <input class="form-input !text-xs ${highlightIfComplete(party.role)}" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate, Intermediary">
                    </div>
                    <div>
                        <label class="party-detail-label">Passport / ID Number</label>
                        <input class="form-input !text-xs ${highlightIfComplete(party.passport.number)}" value="${party.passport.number || ''}" data-path="${base}.passport.number" placeholder="As shown on document">
                    </div>
                    <div>
                        <label class="party-detail-label">Issuing Authority / Country</label>
                        <input class="form-input !text-xs ${highlightIfComplete(party.passport.authority)}" value="${party.passport.authority || ''}" data-path="${base}.passport.authority" placeholder="e.g., USA">
                    </div>
                     <div>
                        <label class="party-detail-label">Date of Expiry</label>
                        <input type="date" class="form-input !text-xs ${highlightIfComplete(party.passport.expiryDate)}" value="${party.passport.expiryDate || ''}" data-path="${base}.passport.expiryDate">
                    </div>
                    <div>
                        <label class="party-detail-label">Date of Issue</label>
                        <input type="date" class="form-input !text-xs ${highlightIfComplete(party.passport.issueDate)}" value="${party.passport.issueDate || ''}" data-path="${base}.passport.issueDate">
                    </div>
                </div>
            </fieldset>

            <!-- ========================================================= -->
            <!-- === GUIDED FIELDSET: REMITTANCE COORDINATES === -->
            <!-- ========================================================= -->
            <fieldset class="col-span-2 border border-premium-border p-4 rounded-lg">
                <legend class="text-premium-text-secondary text-sm px-2">Remittance Coordinates</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="party-detail-label">Payment Method</label>
                        <select class="form-select !text-xs" data-path="${base}.payment.method">
                            <option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected':''}>Bank Wire</option>
                            <option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected':''}>USDT (TRC-20)</option>
                            <option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected':''}>USDT (ERC-20)</option>
                        </select>
                    </div>
                    <div>
                        <label class="party-detail-label">Settlement Currency</label>
                        <select class="form-select !text-xs" data-path="${base}.payment.currency">
                            <option value="USD" ${party.payment.currency === 'USD' ? 'selected':''}>USD</option>
                            <option value="USDT" ${party.payment.currency === 'USDT' ? 'selected':''}>USDT</option>
                            <option value="EUR" ${party.payment.currency === 'EUR' ? 'selected':''}>EUR</option>
                        </select>
                    </div>
                    <div class="col-span-1 sm:col-span-2">
                        <label class="party-detail-label">Payment Coordinates</label>
                        <textarea class="form-input !text-xs font-mono ${highlightIfComplete(party.payment.details)}" data-path="${base}.payment.details" rows="3" placeholder="${paymentDetailsPlaceholder}">${party.payment.details || ''}</textarea>
                    </div>
                </div>
            </fieldset>
        </div>
    `;
},
renderExecutionSuite: (contractHTML) => `
    <div id="execution-suite"><div class="step-panel step-1"><h4>Step 1: Sign & Prepare Document</h4><p class="text-sm mt-2 mb-4">Apply all known signatures and corporate seals. This prepares the document for the final, binding workflow.</p><button id="launch-signing-btn" class="execution-btn" onclick="Logic.initiateSigningProcess()"><i class="fas fa-pen-fancy mr-2"></i>Launch Signature Suite</button></div><div id="finalization-step-panel" class="step-panel step-2 opacity-50 pointer-events-none"><h4>Step 2: Finalize & Dispatch</h4><p class="text-sm mt-2 mb-4">This will lock the document and dispatch the finalized PDF to all parties.</p><button id="send-for-signature-btn" class="execution-btn" onclick="Logic.sendForSignature()"><i class="fas fa-paper-plane mr-2"></i>Lock & Send to Parties</button></div></div><div id="contract-document-wrapper">${contractHTML}</div>`,

renderContractDocument: (agreementReference) => {
    const { legal } = AppState.modeler;
    const allParties = legal.groups.flatMap(g => g.parties);
    const isImfpa = legal.agreementType === 'IMFPA';

    const feeClauses = isImfpa ? legal.groups.map(g => {
        const groupPayout = legal.totalCommission * (g.percentage / 100);
        return `<h2 class="p-h2">Distribution Group: ${g.name} (${g.percentage}%)</h2><p class="p-text">Total value for this group: ${Utils.formatPrice(groupPayout)}</p><table class="p-table"><thead><tr><th>Beneficiary</th><th>Role</th><th>Allocation</th><th>Value</th><th>Payment Details</th></tr></thead><tbody>${g.parties.map(p => { const partyValue = groupPayout * (p.percentage / 100); return `<tr><td>${p.legalName}</td><td>${p.role}</td><td>${p.percentage}%</td><td>${Utils.formatPrice(partyValue)}</td><td>${p.payment.method}: ${p.payment.details || 'To be furnished via secure KYC.'}</td></tr>` }).join('')}</tbody></table>`;
    }).join('') : '';

    const signatureBlocks = allParties.map((p, i) => `<div class="p-signature-block" data-party-id="party-${i}" data-party-name="${p.legalName}"><p class="p-strong">FOR AND ON BEHALF OF: ${p.legalName.toUpperCase()}</p><div class="p-signature-line" data-sig-type="signature"></div><p class="p-signature-label">By: (Authorized Signature)</p><div class="p-signature-line" data-sig-type="print-name"></div><p class="p-signature-label">Name/Title: ${p.legalName} / ${p.role}</p><div class="p-signature-line" data-sig-type="date"></div><p class="p-signature-label">Date of Execution:</p><div data-sig-type="seal" style="position: relative; height: 100px;"></div></div>`).join('');
    
    const title = isImfpa ? "Irrevocable Master Fee Protection & NCND Agreement" : "Non-Circumvention, Non-Disclosure Agreement (NCNDA)";
    const imfpaArticle = isImfpa ? `<p class="p-text">This agreement concerns a transaction with a total commission pool of <strong>${Utils.formatPrice(legal.totalCommission)}</strong>.</p><div class="p-annex-start"><h2 class="p-h2">ANNEX A: FEE DISTRIBUTION SCHEDULE</h2>${feeClauses}</div>` : '';

    return `<div class="p-doc"><div class="p-watermark">DRAFT</div><h1 class="p-h1">${title}</h1><p class="p-text"><strong>Reference:</strong> ${agreementReference}</p><p class="p-text"><strong>Effective Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>${imfpaArticle}<div class="p-annex-start"><h2 class="p-h2">SIGNATURE PAGE</h2><p class="p-text">IN WITNESS WHEREOF, the Parties have executed this Agreement by their duly authorized representatives as of the Effective Date.</p>${signatureBlocks}</div></div>`;
},
renderContractPreview: (legal, calc) => {
        const isImfpa = legal.agreementType === 'IMFPA';
        const allParties = legal.groups.flatMap(g => g.parties);
        const title = isImfpa ? "IMFPA & NCNDA Summary" : "NCNDA Summary";
        const commissionSummary = isImfpa ? `<p class="preview-p">The Parties acknowledge a total commission pool of <span class="preview-strong">${Utils.formatPrice(legal.totalCommission)}</span> to be distributed as per the configured allocation schedule.</p>` : '';
        return `<h1 class="preview-h1">${title}</h1><p class="preview-p"><span class="preview-strong">Reference:</span> GECAN-${legal.agreementType}-... (provisional)</p><p class="preview-p"><span class="preview-strong">Date:</span> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p><p class="preview-p"><span class="preview-strong">Signatory Parties (${allParties.length}):</span> ${allParties.length > 0 ? `This agreement is entered into by and between ${allParties.map(p => p.legalName || '[Unnamed Party]').join(', ')}.` : 'Awaiting party details.'}</p>${commissionSummary}<p class="preview-p"><span class="preview-strong">Governing Law:</span> This Agreement shall be governed by the laws of ${legal.jurisdiction || '[Not Specified]'}.</p>`;
    },
    

    // --- DYNAMIC MODAL RENDERERS ---
    renderNotificationModal: (message, type, title) => {
        const types = { success: { i: 'fa-check-circle', c: 'green', t: 'Success' }, error: { i: 'fa-exclamation-triangle', c: 'red', t: 'Error' }, warning: { i: 'fa-exclamation-circle', c: 'yellow', t: 'Warning' }, info: { i: 'fa-info-circle', c: 'blue', t: 'Information' } };
        const config = types[type] || types.info;
        return `<div class="dialog-content-wrapper"><div class="text-white flex flex-col"><div class="p-6 flex items-center gap-4 border-b bg-${config.c}-500/10 border-${config.c}-500/20"><div class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg bg-gradient-to-br from-${config.c}-400 to-${config.c}-600"><i class="fas ${config.i} fa-2x"></i></div><div><h2 class="text-2xl font-bold">${title || config.t}</h2><p class="text-sm text-text-secondary">Please review this message.</p></div></div><div class="p-8 flex-grow"><p class="text-text-secondary leading-relaxed">${message}</p></div><div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end"><button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg bg-gradient-to-r from-${config.c}-500 to-${config.c}-700 border-${config.c}-500">OK</button></div></div></div>`;
    },
    renderSignatureModal: () => {
        return `<div id="signature-modal-content" class="text-white flex-grow flex flex-col"><div class="p-6 border-b border-[var(--border-premium)] flex-shrink-0"><div class="flex justify-between items-start mb-4"><div><h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2><p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p></div><button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white">&times;</button></div><div><label for="signature-target-select" class="block text-sm font-semibold mb-2">Apply to:</label><select id="signature-target-select" class="form-select w-full"></select></div></div><div class="p-6 flex-grow overflow-y-auto"><div class="flex border-b border-[var(--border-premium)] mb-4"><button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('draw')">Draw</button><button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button><button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('seal')">Upload Seal</button></div><div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div><div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div><div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div></div><div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex-shrink-0"><div class="text-xs text-text-muted mb-4"><p>A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div><button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button></div></div>`;
    },
    renderFinalizationModal: () => {
        return `<div class="flex flex-col text-white"><div class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)] bg-[var(--background-dark)]/50"><div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg"><i class="fas fa-shield-alt fa-2x"></i></div><div><h2 class="text-2xl font-bold">Finalize & Lock Document</h2><p class="text-sm text-text-secondary">Confirm this critical, irreversible action.</p></div><button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white ml-auto">&times;</button></div><div class="p-8 flex-grow"><p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action will:</p><ul class="space-y-4 text-text-primary"><li class="flex items-start gap-3"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Lock Document State:</strong> The current version will be cryptographically fingerprinted.</div></li><li class="flex items-start gap-3"><i class="fas fa-project-diagram text-purple-400 mt-1"></i><div><strong>Generate Secure Audit Trail:</strong> An immutable record will be created.</div></li><li class="flex items-start gap-3"><i class="fas fa-paper-plane text-purple-400 mt-1"></i><div><strong>Dispatch to All Parties:</strong> A finalized PDF will be emailed to all signatories.</div></li></ul></div><div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end gap-4"><button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button><button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 px-8 py-2 font-bold shadow-lg"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button></div></div>`;
    }
};
        // --- SECTION 5: INITIALIZATION ---
        const initInteractiveBackground = () => {
            const vortex = document.getElementById('background-vortex');
            if (!vortex) return;
            let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
            let currentX = targetX, currentY = targetY;
            document.addEventListener('mousemove', (e) => { targetX = e.clientX; targetY = e.clientY; });
            const animate = () => { currentX += (targetX - currentX) * 0.05; currentY += (targetY - currentY) * 0.05; vortex.style.transform = `translate(-50%, -50%) translate3d(${currentX}px, ${currentY}px, 0)`; requestAnimationFrame(animate); };
            animate();
        };
        
        document.addEventListener('DOMContentLoaded', Logic.init);

    </script>
</body>
</html>
