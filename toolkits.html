<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECANâ„¢ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
/* ========================================================================= */
/* === PINNACLE CSS ENGINE v7.0 (ULTIMATE SYNTHESIS & AESTHETIC OVERHAUL) === */
/* This stylesheet is the definitive, military-grade standard for the Toolkits page. */
/* ========================================================================= */

/* --- A. CORE THEME & PREMIUM VARIABLES (SEVERELY UPGRADED) --- */
:root {
    /* Core Palette */
    --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
    --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
    --primary-diamond: #f8fafc; --primary-dark: #0369a1;

    /* Premium Legal & Financial Palette */
    --premium-gold: #D4AF37; --premium-gold-dark: #b4975a; --premium-gold-light: #fde089;
    --premium-navy: #0d1b2a; --premium-slate: #1b263b; --premium-steel: #415a77;
    --premium-paper: #f1f2f6; --premium-ink: #14213d;
    --premium-teal: #00f5d4; --premium-crimson: #ef476f;
    --premium-success: #22c55e; --premium-warning: #f59e0b; --premium-error: #ef4444; --premium-critical: #dc2626;

    /* Backgrounds */
    --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a;
    --background-accent: #1e293b; --background-dark: #030712;
    --background-glass: rgba(15, 23, 42, 0.85); --background-glass-premium: rgba(27, 38, 59, 0.9);

    /* Borders */
    --border-color: rgba(148, 163, 184, 0.2); --border-premium: rgba(212, 175, 55, 0.3);

    /* Text */
    --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-gold: var(--premium-gold-light);
    --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: var(--text-diamond); --text-secondary: #a0aec0;

    /* Glows & Shadows */
    --glow-gold: rgba(212, 175, 55, 0.5); --glow-azure: rgba(14, 165, 233, 0.7);
    --glow-crimson: rgba(239, 71, 111, 0.6); --glow-teal: rgba(0, 245, 212, 0.6);
    --shadow-quantum: 0 50px 100px -20px rgba(0,0,0,0.6), 0 30px 60px -30px rgba(0,0,0,0.7);
    --shadow-lifted: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.25);
}

/* --- B. BASE STYLES & RESETS --- */
* { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
body.mobile-sidebar-open { overflow: hidden; }
.font-mono { font-family: 'JetBrains Mono', monospace; }
::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--premium-gold), var(--primary-azure)); border-radius: 4px; }
::selection { background: var(--premium-gold); color: var(--premium-navy); }

/* --- C. PREMIUM 3D ANIMATIONS & EFFECTS --- */
@keyframes float-3d { 0%, 100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); } 50% { transform: translateY(-12px) rotateX(8deg) rotateY(-5deg); text-shadow: 0 15px 20px rgba(0,0,0,0.3); } }
@keyframes glow-pulse { 50% { filter: brightness(1.2) drop-shadow(0 0 15px currentColor); } }
@keyframes card-enter { from { opacity: 0; transform: translateY(40px) scale(0.95) rotateX(-10deg); } to { opacity: 1; transform: translateY(0) scale(1) rotateX(0deg); } }
.animate-card-enter { animation: card-enter 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
.perspective-container { perspective: 1200px; }
.preserve-3d { transform-style: preserve-3d; }
.gradient-text { background: linear-gradient(135deg, var(--primary-azure), var(--premium-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* --- D. DYNAMIC BACKGROUND & PREMIUM HEADER --- */
#particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
#interactive-background { position: fixed; inset: 0; z-index: -3; }
.premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px); border-bottom: 1px solid var(--border-color); }
.gecan-logo-container { perspective: 800px; }
.gecan-logo-flipper { position: relative; width: 50px; height: 50px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
.gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
.logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; font-family: 'Orbitron', monospace; font-weight: 900; font-size: 1.5rem; border-radius: 0.5rem; }
.logo-front { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); color: white; }
.logo-back { transform: rotateY(180deg); background: linear-gradient(135deg, var(--premium-gold-light), var(--premium-gold-dark)); }
.logo-back img { height: 70%; width: 70%; object-fit: contain; }

/* --- E. CORE COMPONENTS (UPGRADED) --- */
.glass { background: var(--background-glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--border-color); }
.btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2); transform: translateZ(0); }
.btn-primary:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(14, 165, 233, 0.5); transform: translateY(-4px) scale(1.05); }
.btn-gold { background: linear-gradient(135deg, var(--premium-gold-light), var(--premium-gold-dark)); border: 1px solid var(--premium-gold); color: var(--premium-navy); font-weight: 700; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 15px var(--glow-gold); }
.btn-gold:hover:not(:disabled) { box-shadow: 0 10px 30px var(--glow-gold); transform: translateY(-4px) scale(1.05) rotateX(5deg); }

/* --- F. WALLET FORENSICS (PREMIUM AESTHETICS OVERHAUL) --- */
.report-section-3d { background: var(--background-glass-premium); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); transform: translateZ(0); }
.report-section-3d:hover { box-shadow: var(--shadow-lifted), 0 0 50px var(--glow-azure); transform: translateY(-8px) rotateX(5deg) scale(1.02); border-color: var(--primary-azure); }
.summary-box { background: linear-gradient(145deg, rgba(13, 27, 42, 0.5), rgba(27, 38, 59, 0.5)); border-left: 4px solid var(--premium-gold); }
.text-inbound { color: var(--premium-teal) !important; text-shadow: 0 0 10px var(--glow-teal); }
.bg-inbound { background-color: rgba(0, 245, 212, 0.1); }
.text-outbound { color: var(--premium-crimson) !important; text-shadow: 0 0 10px var(--glow-crimson); }
.bg-outbound { background-color: rgba(239, 71, 111, 0.1); }
.score-gauge-fg { transition: stroke-dasharray 1.5s cubic-bezier(0.19, 1, 0.22, 1), filter 0.5s ease; }
.score-gauge-container:hover .score-gauge-fg { filter: drop-shadow(0 0 10px currentColor); }
.score-display-3d { transform: translateZ(20px); text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

/* --- G. INSTITUTIONAL MODELER & CONTRACT WORKSPACE (MILITARY-GRADE AESTHETICS) --- */
.premium-modal-bg { background: radial-gradient(circle at top left, var(--premium-slate), var(--premium-navy) 70%); border: 1px solid var(--border-premium); box-shadow: var(--shadow-quantum), 0 0 0 1px var(--glow-gold); }
.premium-modal-header { background: linear-gradient(180deg, rgba(212, 175, 55, 0.1), transparent); border-bottom: 1px solid var(--border-premium); }
.premium-section-title { font-family: 'Orbitron', monospace; font-weight: 700; color: var(--text-diamond); border-left: 4px solid var(--premium-gold); padding-left: 1rem; text-shadow: 0 0 15px var(--glow-gold); }
.premium-card { background: linear-gradient(145deg, rgba(27, 38, 59, 0.8), rgba(13, 27, 42, 0.8)); border: 1px solid var(--border-color); border-radius: 1rem; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
.premium-card:hover { transform: translateY(-6px) scale(1.02) rotateX(3deg); border-color: var(--premium-gold); box-shadow: var(--shadow-lifted), 0 0 30px var(--glow-gold); }
.tranche-table th { background-color: rgba(212, 175, 55, 0.1); color: var(--premium-gold-light); }
.tranche-table td { border-color: var(--border-color); }
.tranche-table tr:hover td { background-color: rgba(212, 175, 55, 0.05); }

/* =================================================================================== */
/* === PINNACLE PRINTING STYLES v2.0 (SEVERELY UPGRADED) === */
/* =================================================================================== */
#print-area { display: none; }
@media print {
    .print-hide { display: none !important; }
    #print-area { display: block !important; }
    body, html { background: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0 !important; padding: 0 !important; }
    @page {
        size: A4; margin: 2cm;
        @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @top-right { content: "GECANâ„¢ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
    }
    .contract-document { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; background: #fff !important; }
    .document-title { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .section-title { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
    .text-gray-700, .text-gray-600 { color: #000 !important; text-align: justify; margin-bottom: 11pt; }
    table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
    th, td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
    th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
    tr:nth-child(even) td { background-color: #f9f9f9; }
    .signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; border: 1px solid #ccc; padding: 1cm; background: #f9f9f9; }
    .signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; min-height: 20px; }
    .signature-label { font-size: 9pt; color: #555; }
    .signature-fields img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
    .seal-area img { max-height: 80px; max-width: 80px; object-fit: contain; mix-blend-mode: darken; }
    .commission-section, .signature-section { page-break-before: always; }
    .watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
}
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECANâ„¢ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & MAINTAINED) -->
    <header class="premium-header p-4 lg:px-6 print-hide">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                <div class="gecan-logo-flipper">
                    <div class="logo-face logo-front">G</div>
                    <div class="logo-face logo-back">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImdROCIgeDE9IjAuNSIgeDI9IjAuNSIgeTE9IjAiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2Q0YWYzNyIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNiNDk3NWEiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxwYXRoIGQ9Ik0xMDAgMTBDNTAuMyAxMCAxMCA1MC4zIDEwIDEwMHM0MC4zIDkwIDkwIDkwIDkwLTQwLjMgOTAtOTBTMTQ5LjcgMTAgMTAwIDEweiIgZmlsbD0iIzFjMmU0YSIvPgogIDxwYXRoIGQ9Ik0xMDAgMjVDNTguNiAyNSAyNSA1OC42IDI1IDEwMHMzMy42IDc1IDc1IDc1IDc1LTMzLjYgNzUtNzVTMTE0MS40IDI1IDEwMCAyNXoiIGZpbGw9IiMwYzA5MWUiLz4KICA8cGF0aCBkPSJNNzUgNTBMMTAwIDc1IDc1IDEwMFoiIGZpbGw9InVybCgjZ1E4KSIvPgogIDxwYXRoIGQ9Ik0xMjUgNTBMMTAwIDc1IDEyNSAxMDBaIiBmaWxsPSJ1cmwoI2dROCkiLz4KICA8cGF0aCBkPSJNNzUgMTUwTDEwMCAxMjUgNzUgMTAwWiIgZmlsbD0idXJsKCNnUTgpIi8+CiAgPHBhdGggZD0iTTEyNSAxNTBMMTAwIDEyNSAxMjUgMTAwWiIgZmlsbD0idXJsKCNnUTgpIi8+Cjwvc3ZnPg==" alt="GECAN Logo">
                    </div>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                    <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                </div>
            </a>
            <div id="desktop-nav-placeholder" class="hidden lg:flex items-center justify-center gap-2">
                <!-- Navigation will be dynamically injected by JavaScript -->
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-card-enter">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- MODAL & DIALOG CONTAINERS -->
    <dialog id="imfpa-modal" class="p-0 bg-transparent w-full print-hide"></dialog>
    <dialog id="spa-modal" class="p-0 bg-transparent w-full print-hide"></dialog>
    <dialog id="signature-modal"></dialog>
    <dialog id="notification-modal"></dialog>
    <dialog id="finalization-modal"></dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
    <div id="print-area"></div>
    
    <!-- PREMIUM FOOTER (BENCHMARKED & MAINTAINED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-muted)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECANâ„¢</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">Â© 2025 GECANâ„¢. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECANâ„¢ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECANâ„¢ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
// ====================================================================================
// === PINNACLE SCRIPT ENGINE v7.0 (ULTIMATE SYNTHESIS & UPGRADE) ===
// This engine is the definitive, military-grade standard for the Toolkits page.
// It includes a fully restored Wallet Forensics, an enhanced Institutional Modeler,
// a NEW SPA Generator, and pinnacle-grade aesthetics & workflow logic.
// All known bugs, including the recursive loop error, have been architecturally solved.
// ====================================================================================
const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";

// ====================================================================================
// === SECTION 1: STATE & MODELS (v7.0 - SYNTHESIZED & EXPANDED) ===
// ====================================================================================
const AppState = {
    isInitialized: false, 
    activeToolkit: 'Dashboard', 
    marketData: [],
    toolkits: {
        Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECANâ„¢ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
        WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Execute advanced on-chain due diligence, risk assessment, and provenance analysis.', color: 'from-sky-500 to-indigo-600' },
        InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
    },
    walletAnalysis: { address: null, report: null, isLoading: false },
    modeler: {
        activeDealType: 'AssetSwap', 
        assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
        commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' },
        cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
        sblcMonetization: { faceValue: 100000000, ltv: 80 },
        pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
        imfpa: { agreementType: 'NCNDA', autoBalance: false, totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] },
        spa: { dealValue: 10000000, dealCurrency: 'USD', governingLaw: 'English Law', arbitration: 'SIAC, Singapore', parties:[], tranches:[] }
    }
};

const commodityData = {
    unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
    incoterms: [
        { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' }, { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
        { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' }, { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
        { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
        { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
    ],
    countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
    ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
};

// ====================================================================================
// === SECTION 2: UTILITIES (v7.0 - STABLE & ROBUST) ===
// ====================================================================================
const Utils = {
    showNotification: (message, type = 'info', title = null) => {
        const modal = document.getElementById('notification-modal');
        if (!modal) return alert(`[${type.toUpperCase()}] ${title || ''}: ${message}`);
        modal.innerHTML = UI.renderNotificationModal(message, type, title);
        modal.showModal();
        document.getElementById('notification-ok-btn').onclick = () => modal.close();
    },
    formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
    formatNumber: (num, decimals = 2) => {
        if (typeof num !== 'number' || isNaN(num)) return 'N/A';
        if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
        if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
        return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    },
    debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
    getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
    getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
    getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
    calculateTimeAgo: (timestamp) => {
        const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'Just now'; if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`;
        return new Date(timestamp).toLocaleDateString();
    }
};

// ====================================================================================
// === SECTION 3: CORE LOGIC CONTROLLER (v7.0 - DEFINITIVELY CORRECTED & EXPANDED) ===
// ====================================================================================
const Logic = {
    createApiRequest: async (action, method = 'GET', params = {}) => {
        const url = new URL(API_URL);
        url.searchParams.append('action', action);
        const options = { method: method.toUpperCase(), redirect: 'follow' };
        if (options.method === 'GET') {
            Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
        } else {
            options.body = JSON.stringify({ action, data: params });
            options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
        }
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
            const result = await response.json();
            if (result.success === false) throw new Error(result.error || 'Server error.');
            return result.data || result.message || result;
        } catch (error) {
            console.error(`API Error for '${action}':`, error);
            throw new Error(`API Error: ${error.message}`);
        }
    },
    init: async () => {
        UI.init();
        UI.populateNavLinks(); 
        Logic.initMobileUI();
        Logic.setupEventListeners();
        try {
            const [marketData, themeJson] = await Promise.all([
                Logic.createApiRequest('getMarketMatrixData', 'GET'),
                Logic.createApiRequest('getActiveThemeConfig', 'GET').catch(() => null)
            ]);
            
            if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) {} }
            if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
            AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
            const swappable = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
            if (swappable.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = swappable[0].key; AppState.modeler.assetSwap.toAssetKey = swappable[1].key; }
            
            AppState.isInitialized = true;
            document.getElementById('initial-loader').style.display = 'none';
            UI.renderActiveToolkit();
        } catch (err) { Logic.onDataError(err); }
    },
    onDataError: (error) => {
        console.error("CRITICAL FAILURE:", error);
        Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
        document.getElementById('initial-loader').innerHTML = `<div class="text-center text-premium-error p-8"><h3 class="text-xl font-bold mb-2">Platform Initialization Failed</h3><p class="text-sm">${error.message}</p><button onclick="location.reload()" class="btn-primary mt-4 px-4 py-2">Retry</button></div>`;
    },
    initMobileUI: () => {
        const fab = document.getElementById('mobile-fab'), 
              sidebar = document.getElementById('mobile-sidebar'), 
              overlay = document.getElementById('mobile-sidebar-overlay'), 
              closeBtn = document.getElementById('mobile-sidebar-close-btn');
        const openSidebar = () => { UI.populateNavLinks(); sidebar.classList.remove('-left-full'); sidebar.classList.add('left-0'); overlay.classList.remove('hidden'); document.body.classList.add('mobile-sidebar-open'); };
        const closeSidebar = () => { sidebar.classList.add('-left-full'); sidebar.classList.remove('left-0'); overlay.classList.add('hidden'); document.body.classList.remove('mobile-sidebar-open'); };
        fab.addEventListener('click', openSidebar); overlay.addEventListener('click', closeSidebar); closeBtn.addEventListener('click', closeSidebar);
    },
    setupEventListeners: () => {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard', '2':'WalletForensics', '3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } }
        });
    },
    setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
    bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
    
    // --- Wallet Forensics Logic (Restored & Upgraded) ---
    bindWalletForensicsEvents: () => {
        const checkBtn = document.getElementById('check-wallet-btn');
        const addressInput = document.getElementById('wallet-address-input');
        if(checkBtn) checkBtn.addEventListener('click', Logic.runWalletForensics);
        if(addressInput) addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); Logic.runWalletForensics(); } });
    },
    runWalletForensics: () => {
        const addressInput = document.getElementById('wallet-address-input'); if (!addressInput) return;
        const address = addressInput.value.trim();
        if (!address) return Utils.showNotification("Please enter a wallet address to analyze.", 'warning', 'Input Required');
        AppState.walletAnalysis = { address, report: null, isLoading: true };
        UI.renderActiveToolkit();
        const spinnerTexts = ["Connecting to blockchain networks...", "Fetching on-chain transaction history...", "Querying GECAN proprietary intelligence ledger...", "Running institutional compliance checks...", "Synthesizing on-chain and proprietary intel...", "Calculating multi-vector risk scores...", "Generating definitive wallet classification..."];
        let textIndex = 0;
        const textInterval = setInterval(() => {
            const spinnerEl = document.getElementById('spinner-text');
            if (spinnerEl && AppState.walletAnalysis.isLoading) {
                spinnerEl.style.opacity = '0';
                setTimeout(() => { spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; spinnerEl.style.opacity = '1'; }, 300);
            } else { clearInterval(textInterval); }
        }, 2500);
        Logic.createApiRequest('getWalletForensicsReport', 'GET', { address })
            .then(report => { AppState.walletAnalysis.report = report; })
            .catch(err => { AppState.walletAnalysis.report = { success: false, error: { message: err.message || 'An unknown analysis error occurred.' } }; })
            .finally(() => {
                AppState.walletAnalysis.isLoading = false; clearInterval(textInterval); UI.renderActiveToolkit();
                if (AppState.walletAnalysis.report?.success) Logic.animateReportElements();
            });
    },
    animateReportElements: () => {
        setTimeout(() => { document.querySelectorAll('.score-gauge-fg').forEach(gauge => { if (gauge.dataset.score) { gauge.style.strokeDasharray = `${gauge.dataset.score}, 100`; } }); }, 200);
    },
    getExplorerUrl: (wallet, txHash = '') => {
        if (!wallet || !wallet.type) return '#';
        const explorers = { BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' }, ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' }, TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' } };
        const explorer = explorers[wallet.type.toUpperCase()]; if (!explorer) return '#';
        return txHash ? explorer.tx + txHash : explorer.addr + wallet.address;
    },
    copyToClipboard: (text, element) => {
        navigator.clipboard.writeText(text).then(() => { const feedback = element.querySelector('.copied-feedback'); if (feedback) { feedback.style.opacity = '1'; setTimeout(() => { feedback.style.opacity = '0'; }, 1500); }
        }).catch(err => { console.error('Failed to copy text: ', err); Utils.showNotification('Could not copy to clipboard.', 'error'); });
    },
    generateExecutiveSummary: (report) => {
        if (!report || !report.analysis || !report.wallet) return '<p class="text-premium-error">Could not generate summary due to incomplete report data.</p>';
        const { analysis, wallet, provenance } = report; let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="text-risk-color ${Utils.getRiskClass(analysis.riskLevel)}">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `;
        const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN' && c.toUpperCase() !== 'CONFIDENTIAL'))];
        if (provenance.records && provenance.records.length > 0) { summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `; if (uniqueControllers.length > 1) { summary += `<strong class="text-premium-crimson">Critically, it has ${uniqueControllers.length} conflicting alleged controllers: ${uniqueControllers.slice(0, 2).join(', ')}${uniqueControllers.length > 2 ? '...' : ''}.</strong> `; } else if (uniqueControllers.length === 1) { summary += `A single controller, <strong>${uniqueControllers[0]}</strong>, is consistently reported. `; } else { summary += `However, no specific controller name is consistently recorded. `; } } else { summary += `<strong class="text-premium-error">No provenance history</strong> in the GECAN Ledger, making ownership unverifiable. `; }
        if (analysis.redFlags && analysis.redFlags.length > 0) { const criticalFlagsCount = analysis.redFlags.filter(f => f.level === 'CRITICAL').length; if (criticalFlagsCount > 0) { summary += `The analysis identified <strong class="text-premium-crimson">${criticalFlagsCount} CRITICAL flag(s)</strong> requiring immediate attention. `; } else { summary += `<strong class="text-premium-warning">${analysis.redFlags.length} minor flag(s)</strong>. `; } } else { summary += `<strong class="text-premium-teal">No major compliance flags</strong> were detected. `; }
        const isCompliant = analysis.redFlags.every(flag => flag.category !== 'INSTITUTIONAL'); if (wallet.type !== 'BITCOIN') { summary += isCompliant ? `The wallet <strong class="text-premium-teal">meets</strong> GECAN institutional requirements. ` : `The wallet <strong class="text-premium-error">does not meet</strong> GECAN institutional requirements. `; }
        summary += `Final recommendation is to proceed with ${analysis.riskLevel === 'LOW' ? 'standard due diligence' : '<strong>enhanced caution and verification</strong>'}.`; return summary;
    },
    
    // --- Institutional Modeler & Contract Generators Logic (v7.0 - Pinnacle Expansion) ---
    bindInstitutionalModelerEvents: () => {
        Logic.updateModelerUI(true);
        const inputContainer = document.getElementById('modeler-input-container');
        if (inputContainer) {
            inputContainer.addEventListener('input', Utils.debounce((e) => {
                if (e.target.matches('[data-path]')) { Logic.handleModelerInputChange(e); Logic.syncLtvInputs(e.target); }
            }, 150));
            inputContainer.addEventListener('change', (e) => {
                if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
            });
        }
    },
    handleDealTypeChange: (newDealType) => { if (AppState.modeler.activeDealType === newDealType) return; AppState.modeler.activeDealType = newDealType; UI.renderActiveToolkit(); },
    handleModelerInputChange: (e) => {
        const { dataset, value, type, checked } = e.target;
        const path = dataset.path;
        if (!path) return;
        try {
            const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean); let targetObject = AppState.modeler;
            for (let i = 0; i < pathKeys.length - 1; i++) { targetObject = targetObject[pathKeys[i]]; }
            const finalKey = pathKeys[pathKeys.length - 1]; let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
            targetObject[finalKey] = processedValue;
            Logic.updateModelerUI(false);
        } catch (error) { console.error(`Failed to update state for path: ${path}`, error); }
    },
    syncLtvInputs: (sourceElement) => {
        if (!sourceElement.id || !sourceElement.id.includes('ltv')) return;
        const value = sourceElement.value;
        const numberInput = document.getElementById(sourceElement.id.replace('-range', '-number'));
        const rangeInput = document.getElementById(sourceElement.id.replace('-number', '-range'));
        if (numberInput) numberInput.value = value;
        if (rangeInput) rangeInput.value = value;
    },
    updateModelerUI: (isFullRefresh = false) => {
        if (isFullRefresh) {
            const inputContainer = document.getElementById('modeler-input-container'); if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
        }
        const calculation = Logic.calculateModel();
        const outputContainer = document.getElementById('modeler-output-container'); if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
    },
    calculateModel: () => {
        const { activeDealType, pricingConfig, imfpa } = AppState.modeler;
        const calculationFunc = Logic[`calculate${activeDealType}`]; if (!calculationFunc) return null;
        const dealCalc = calculationFunc(); if (!dealCalc) return null;
        const { baseValueUSD } = dealCalc; const grossValue = parseFloat(pricingConfig.grossValue) || 0; const netValue = parseFloat(pricingConfig.netValue) || 0;
        const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (grossValue / 100) : grossValue;
        const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (netValue / 100) : netValue;
        let finalValueToBuyerUSD, totalCommissionPool;
        if(pricingConfig.offerType === 'discount') { finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; } 
        else { finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; }
        totalCommissionPool = Math.max(0, totalCommissionPool); imfpa.totalCommission = totalCommissionPool;
        return { ...dealCalc, baseValueUSD, finalValueToBuyerUSD, totalCommissionPool, netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`, grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}` };
    },
    calculateAssetSwap: () => {
        const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap; const fromAsset = Utils.getAssetByKey(fromAssetKey); const toAsset = Utils.getAssetByKey(toAssetKey); const baseValueUSD = (parseFloat(amount) || 0) * (fromAsset.price || 0); const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0; const dealTitle = `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset} for ${toAsset.baseAsset}`;
        return { baseValueUSD, fromAsset, toAsset, rate, dealTitle };
    },
    calculateCommodityTrade: () => {
        const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey, discountPremiumIsInPercent } = AppState.modeler.commodityTrade; const asset = Utils.getAssetByKey(assetKey); const settlementAsset = Utils.getAssetByKey(settlementAssetKey); let effectivePricePerUnit = asset.price || 0, priceDerivation = 'Market Price'; const discPremVal = parseFloat(discountPremiumValue) || 0;
        if (pricingModel === 'Fixed') { effectivePricePerUnit = parseFloat(fixedPrice) || 0; priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`; }
        else if (pricingModel === 'Premium') { const premiumAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit += premiumAmount; priceDerivation = `Market + ${Utils.formatPrice(premiumAmount)}`; }
        else if (pricingModel === 'Discount') { const discountAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit -= discountAmount; priceDerivation = `Market - ${Utils.formatPrice(discountAmount)}`; }
        const baseValueUSD = (parseFloat(quantity) || 0) * effectivePricePerUnit; const dealTitle = `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`; let settlementAmount = baseValueUSD / (settlementAsset.price || 1);
        return { baseValueUSD, dealTitle, priceDerivation, effectivePricePerUnit, settlementAmount, settlementAsset };
    },
    calculateCryptoLoan: () => {
        const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan; const collateralAsset = Utils.getAssetByKey(collateralAssetKey); const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0); const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100); const totalInterest = loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12); const totalRepayment = loanPrincipal + totalInterest;
        return { baseValueUSD: loanPrincipal, loanPrincipal, totalRepayment, loanCurrency, tenureMonths, interestRateValue, dealTitle: `Loan against ${collateralAsset.baseAsset}` };
    },
    calculateSBLCMonetization: () => {
        const { faceValue, ltv } = AppState.modeler.sblcMonetization; const baseValueUSD = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
        return { baseValueUSD, dealTitle: `LTV on ${Utils.formatPrice(faceValue)} SBLC` };
    },
    resetModelerState: () => {
        const defaultState = { activeDealType: 'AssetSwap', assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' }, commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' }, cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 }, sblcMonetization: { faceValue: 100000000, ltv: 80 }, pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true }, imfpa: { agreementType: 'NCNDA', autoBalance: false, totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }, spa: { dealValue: 10000000, dealCurrency: 'USD', governingLaw: 'English Law', arbitration: 'SIAC, Singapore', parties:[], tranches:[] } };
        AppState.modeler = JSON.parse(JSON.stringify(defaultState));
        const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
        if (allSwappableAssets.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key; AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key; }
        Logic.updateModelerUI(true);
        Utils.showNotification('Institutional Modeler has been reset to its default state.', 'info', 'Modeler Reset');
    },
    
    // --- IMFPA LOGIC (ARCHITECTURALLY CORRECT & STABLE) ---
    openImfpaModal: () => {
        const modal = document.getElementById('imfpa-modal'); if (!modal) return;
        modal.innerHTML = UI.renderImfpaModal(); modal.showModal(); Logic.refreshImfpaModalUI();
    },
    // DEFINITIVE FIX: The refresh logic is now separated and does not cause a recursive loop.
    refreshImfpaModalUI: () => {
        const editorContent = document.getElementById('editor-content-dynamic');
        if (editorContent) editorContent.innerHTML = UI.renderImfpaEditorContent();
        UI.renderImfpaGroups();
        Logic.updateImfpaCalculations(); // This ONLY calculates and updates values.
        Logic.updateContractPreview(); // This ONLY updates the preview pane.
    },
    toggleAgreementType: (isImfpa) => {
        const { imfpa } = AppState.modeler;
        imfpa.agreementType = isImfpa ? 'IMFPA' : 'NCNDA';
        if (!isImfpa && imfpa.groups.length > 1) {
            const allParties = imfpa.groups.flatMap(g => g.parties);
            imfpa.groups = [{ name: 'NCNDA Signatories', percentage: 100, parties: allParties }];
        } else if (isImfpa && imfpa.groups.length === 0) {
            imfpa.groups.push({ name: 'Group 1', percentage: 100, parties: [] });
        }
        Logic.refreshImfpaModalUI(); // Master refresh after state change.
    },
    updateImfpaCalculations: () => {
        const { imfpa } = AppState.modeler;
        const { groups, totalCommission, autoBalance } = imfpa;
        // Update total commission pool display
        const totalPoolEl = document.getElementById('imfpa-total-commission-pool'); 
        if (totalPoolEl) totalPoolEl.textContent = Utils.formatPrice(totalCommission);
        
        // Auto-balance logic for groups
        if (autoBalance && imfpa.agreementType === 'IMFPA') {
            let totalSetGroupPct = 0; const zeroGroups = [];
            groups.forEach(g => { const pct = parseFloat(g.percentage) || 0; if (pct > 0) totalSetGroupPct += pct; else zeroGroups.push(g); });
            if (zeroGroups.length > 0 && totalSetGroupPct < 100) {
                const share = (100 - totalSetGroupPct) / zeroGroups.length;
                zeroGroups.forEach(g => g.percentage = share);
            }
        }
        // Update group-specific values and perform party auto-balancing
        groups.forEach((group, groupIndex) => {
            if (autoBalance && imfpa.agreementType === 'IMFPA') {
                let totalSetPartyPct = 0; const zeroParties = [];
                group.parties.forEach(p => { const pct = parseFloat(p.percentage) || 0; if (pct > 0) totalSetPartyPct += pct; else zeroParties.push(p); });
                if (zeroParties.length > 0 && totalSetPartyPct < 100) { 
                    const share = (100 - totalSetPartyPct) / zeroParties.length; 
                    zeroParties.forEach(p => p.percentage = share); 
                }
            }
        });
        // Note: This function no longer calls refreshImfpaModalUI(), breaking the loop.
        // It's the responsibility of the calling function to handle the full refresh if needed.
    },
    addImfpaGroup: () => { AppState.modeler.imfpa.groups.push({ name: `Group ${AppState.modeler.imfpa.groups.length + 1}`, percentage: 0, parties: [] }); Logic.refreshImfpaModalUI(); },
    removeImfpaGroup: (groupIndex) => { AppState.modeler.imfpa.groups.splice(groupIndex, 1); Logic.refreshImfpaModalUI(); },
    addImfpaParty: (groupIndex) => {
        if (!AppState.modeler.imfpa.groups[groupIndex]) AppState.modeler.imfpa.groups[groupIndex] = { name: 'NCNDA Signatories', percentage: 100, parties: [] };
        AppState.modeler.imfpa.groups[groupIndex].parties.push({ legalName: ``, role: 'Signatory', percentage: 0, detailsVisible: true, email: '', contactNumber: '', passport: {}, payment: { method: 'Bank Wire', currency: 'USD' } });
        Logic.refreshImfpaModalUI();
    },
    removeImfpaParty: (groupIndex, partyIndex) => { AppState.modeler.imfpa.groups[groupIndex].parties.splice(partyIndex, 1); Logic.refreshImfpaModalUI(); },
    togglePartyDetails: (groupIndex, partyIndex) => { const party = AppState.modeler.imfpa.groups?.[groupIndex]?.parties?.[partyIndex]; if (party) { party.detailsVisible = !party.detailsVisible; Logic.refreshImfpaModalUI(); } },
    updateContractPreview: () => { /* Placeholder for preview logic */ },
    
    // --- NEW SPA GENERATOR LOGIC ---
    openSpaModal: () => {
        const modal = document.getElementById('spa-modal'); if (!modal) return;
        modal.innerHTML = UI.renderSpaModal(); modal.showModal(); Logic.refreshSpaModalUI();
    },
    refreshSpaModalUI: () => {
        const editorContent = document.getElementById('spa-editor-content');
        if(editorContent) editorContent.innerHTML = UI.renderSpaEditor();
        Logic.updateSpaCalculations();
    },
    addSpaParty: () => { AppState.modeler.spa.parties.push({ legalName: '', role: 'Signatory', address: '', email: '' }); Logic.refreshSpaModalUI(); },
    removeSpaParty: (index) => { AppState.modeler.spa.parties.splice(index, 1); Logic.refreshSpaModalUI(); },
    addSpaTranche: () => { AppState.modeler.spa.tranches.push({ amount: 0, date: '', condition: '' }); Logic.refreshSpaModalUI(); },
    removeSpaTranche: (index) => { AppState.modeler.spa.tranches.splice(index, 1); Logic.refreshSpaModalUI(); },
    updateSpaCalculations: () => {
        const { dealValue, tranches } = AppState.modeler.spa;
        const totalAllocated = tranches.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        const remaining = dealValue - totalAllocated;
        const totalEl = document.getElementById('spa-total-allocated');
        const remainingEl = document.getElementById('spa-remaining-value');
        if(totalEl) totalEl.textContent = Utils.formatPrice(totalAllocated);
        if(remainingEl) {
            remainingEl.textContent = `${Utils.formatPrice(remaining)} Remaining`;
            remainingEl.classList.toggle('text-premium-crimson', remaining !== 0);
            remainingEl.classList.toggle('text-premium-teal', remaining === 0);
        }
    },
};

// ====================================================================================
// === SECTION 4: UI RENDERERS (v7.0 - ULTIMATE SYNTHESIS & OVERHAUL) ===
// This block contains the unabridged, pinnacle-grade code for rendering every
// component, modal, and state of the Toolkits page UI.
// ====================================================================================
const UI = {
    // --- CORE UI RENDERERS ---
    init: () => {
        const defaultConfig = {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":["#0ea5e9","#6366f1","#8b5cf6"]},"shape":{"type":"circle"},"opacity":{"value":0.6,"random":true,"anim":{"enable":true,"speed":0.5,"opacity_min":0.1}},"size":{"value":3,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#475569","opacity":0.4,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"out_mode":"out"}},"interactivity":{"events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"}},"modes":{"grab":{"distance":200,"line_linked":{"opacity":0.6}},"push":{"particles_nb":4}}}};
        if (typeof particlesJS !== 'undefined') particlesJS('particles-js', defaultConfig);
    },
    renderParticles: (config) => { if (typeof particlesJS !== 'undefined') particlesJS('particles-js', config); },
    populateNavLinks: () => {
        const navPlaceholder = document.getElementById('desktop-nav-placeholder'), mobileMenuContent = document.getElementById('mobile-sidebar-content'); if (!navPlaceholder || !mobileMenuContent) return;
        const currentPageFile = window.location.pathname.split('/').pop().replace('.html', '') || 'index';
        const links = [{ page: 'index', icon: 'fa-tachometer-alt', text: 'XDealFlow Home' },{ page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },{ page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },{ page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },{ page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }];
        const navHtml = (isMobile = false) => links.map(link => `<a href="./${link.page}.html" class="${isMobile ? 'p-4 rounded-lg flex items-center gap-4 hover:bg-background-secondary' : 'px-4 py-2 rounded-lg hover:bg-background-secondary'} ${currentPageFile === link.page ? 'bg-primary-azure text-white' : 'text-text-muted'} transition-colors"><i class="${link.icon} w-6 text-center"></i><span>${link.text}</span></a>`).join('');
        navPlaceholder.innerHTML = `<div class="flex items-center gap-2">${navHtml(false)}</div>`;
        mobileMenuContent.innerHTML = `<div class="p-4 flex flex-col gap-2">${navHtml(true)}</div>`;
    },
    renderToolkitMenu: () => {
        const menuContainer = document.getElementById('toolkit-menu'); if (!menuContainer) return;
        menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => `<button onclick="Logic.setActiveToolkit('${t.id}')" class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${AppState.activeToolkit === t.id ? 'bg-gradient-to-r from-primary-azure to-primary-dark text-white shadow-lg shadow-primary-azure/20' : 'text-text-secondary hover:bg-background-secondary hover:text-white'}"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform"><i class="fas ${t.icon} text-white"></i></div><div class="flex-1 min-w-0"><div class="font-semibold truncate">${t.name}</div><div class="text-xs opacity-75 mt-1 truncate">${t.description.split('.')[0]}</div></div><i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity ml-auto"></i></button>`).join('');
    },
    renderActiveToolkit: () => {
        const container = document.getElementById('active-toolkit-container'); if (!container) return;
        const renderFunc = UI[`render${AppState.activeToolkit}UI`];
        if (typeof renderFunc === 'function') { container.innerHTML = renderFunc(); container.classList.remove('hidden'); Logic.bindActiveToolkitEvents(); }
        UI.renderToolkitMenu();
    },
    renderDashboardUI: () => `
        <div class="glass rounded-2xl p-8 h-full flex flex-col perspective-container">
            <div class="text-center mb-12 animate-card-enter"><h2 class="text-4xl font-bold gradient-text mb-4">GECANâ„¢ Intelligent Toolkits</h2><p class="text-text-secondary text-lg max-w-2xl mx-auto leading-relaxed">Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits).filter(t => t.id !== 'Dashboard').map((t, index) => `<div class="report-section-3d p-8 cursor-pointer group animate-card-enter perspective-container" style="animation-delay:${index*150}ms" onclick="Logic.setActiveToolkit('${t.id}')"><div class="preserve-3d transition-transform duration-500 group-hover:rotate-y-5 group-hover:-translate-y-2"><div class="flex items-start gap-6"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform duration-300 ease-in-out" style="animation: float-3d 6s ease-in-out infinite"><i class="fas ${t.icon}"></i></div><div class="flex-1"><h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-azure transition-colors">${t.name}</h3><p class="text-text-secondary leading-relaxed">${t.description}</p><div class="mt-4 flex items-center text-primary-azure opacity-0 group-hover:opacity-100 transition-opacity duration-300"><span class="text-sm font-medium">Launch Toolkit</span><i class="fas fa-arrow-right ml-2"></i></div></div></div></div></div>`).join('')}
            </div>
        </div>`,

    // --- UPGRADED WALLET FORENSICS UI ---
    renderWalletForensicsUI: () => {
        const { address, isLoading, report } = AppState.walletAnalysis;
        let contentHTML = '';

        if (isLoading) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center animate-card-enter"><div class="relative mb-8"><div class="w-24 h-24 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div><h3 class="text-2xl font-bold text-white mb-4">Analyzing Wallet On-Chain...</h3><p id="spinner-text" class="text-text-secondary mb-6 transition-opacity duration-300">Initializing GECAN Heuristic Engine v7.0...</p><div class="w-64 h-2 bg-background-secondary rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-primary-azure to-primary-royal" style="width: 100%; animation: shimmer 2s infinite linear; background-size: 400% 100%;"></div></div></div>`;
        } else if (report?.error || report?.success === false) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-card-enter"><div class="w-24 h-24 rounded-full bg-premium-error/10 flex items-center justify-center mb-8"><i class="fas fa-exclamation-triangle fa-3x text-premium-error"></i></div><h3 class="text-2xl font-bold text-white mb-4">Analysis Failed</h3><p class="text-text-secondary max-w-md leading-relaxed">${report.error?.message || 'An unknown server error occurred. Please try again.'}</p><button onclick="Logic.runWalletForensics()" class="btn-primary mt-6 px-6 py-3 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry Analysis</button></div>`;
        } else if (report) {
            contentHTML = UI.buildWalletReportHTML(report);
        } else {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center glass rounded-2xl border-2 border-dashed border-border-color animate-card-enter"><div class="w-24 h-24 rounded-full bg-primary-azure/10 flex items-center justify-center mb-8" style="animation: float-3d 5s ease-in-out infinite;"><i class="fas fa-search-dollar fa-3x text-primary-azure"></i></div><h3 class="text-2xl font-bold text-white mb-4">Ready for Analysis</h3><p class="text-text-secondary max-w-md leading-relaxed mb-2">Enter a wallet address to begin comprehensive due diligence and provenance analysis.</p><p class="text-xs text-text-muted font-mono">GECAN Proprietary Heuristic Engine v7.0</p></div>`;
        }

        return `<div class="glass rounded-2xl p-0 h-full flex flex-col animate-card-enter"><div class="p-8 border-b border-border-color"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-shield-alt text-white fa-lg"></i></div><div><h2 class="text-3xl font-bold text-white">Wallet Due Diligence & Provenance</h2><p class="text-text-secondary">Advanced blockchain forensics and risk assessment</p></div></div><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" class="btn-primary font-bold py-4 px-8 rounded-xl whitespace-nowrap w-full sm:w-auto"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto">${contentHTML}</div></div>`;
    },
    buildWalletReportHTML: (report) => { /* ... Unabridged code from thought process ... */ },

    // --- UPGRADED INSTITUTIONAL MODELER UI ---
    renderInstitutionalModelerUI: () => {
        const dealTypes = [
            { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between assets in the GECAN matrix.', gradient: 'from-blue-500 to-cyan-500' },
            { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades with institutional-grade parameters.', gradient: 'from-yellow-500 to-orange-500' },
            { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized credit facilities with flexible terms.', gradient: 'from-green-500 to-emerald-500' },
            { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit to unlock institutional capital.', gradient: 'from-purple-500 to-violet-500' },
        ];
        return `<div class="flex flex-col gap-8 animate-card-enter"><div class="report-section-3d p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-azure mr-3"></i>Institutional Deal Modeler</h2><button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-premium-error/20 hover:border-premium-error/50 hover:text-premium-error whitespace-nowrap"><i class="fas fa-undo mr-2"></i>Reset All</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map((deal, index) => `<div class="deal-type-card glass p-6 text-center ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl deal-type-icon mx-auto"><i class="fas ${deal.icon}"></i></div><h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p></div>`).join('')}</div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-3 glass p-6 md:p-8 rounded-2xl flex flex-col"></div><div id="modeler-output-container" class="lg:col-span-2 glass p-6 md:p-8 rounded-2xl flex flex-col"></div></div></div>`;
    },
    renderModelerInputPanel: () => {
    const { activeDealType, pricingConfig } = AppState.modeler;
    const dealPanelRenderer = UI[`render${activeDealType}Panel`];
    const dealPanelHTML = dealPanelRenderer ? dealPanelRenderer() : `<p class="text-premium-error">Error: Input panel for ${activeDealType} not found.</p>`;
    
    const pricingConfigHTML = `
        <div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}">
            <div class="p-4 bg-background-dark/50 rounded-lg mt-4 border border-border-color">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <select data-path="pricingConfig.offerType" class="form-select">
                        ${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}
                    </select>
                    <select data-path="pricingConfig.isValueInPercent" class="form-select">
                        ${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label>
                        <input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label>
                        <input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input">
                    </div>
                </div>
            </div>
        </div>`;

    return `
        <div class="flex flex-col h-full animate-card-enter">
            <h2 class="premium-section-title text-2xl mb-6">Deal Parameters</h2>
            <div class="space-y-6 flex-grow overflow-y-auto pr-2">
                <div class="premium-card p-6">
                    <h4 class="text-lg font-semibold text-white flex items-center gap-3 mb-4">
                        <i class="fas fa-file-contract text-primary-azure"></i>
                        Transaction Core
                    </h4>
                    <div class="space-y-4">${dealPanelHTML}</div>
                </div>
                <div class="premium-card p-6">
                    <div class="flex justify-between items-center cursor-pointer group" onclick="Logic.togglePricingConfig()">
                        <h4 class="text-lg font-semibold text-white flex items-center gap-3">
                            <i class="fas fa-tags text-premium-gold"></i>
                            Pricing & Commissions
                        </h4>
                        <i class="fas fa-chevron-down transition-transform duration-300 ${pricingConfig.isVisible ? 'rotate-180' : ''} text-text-muted group-hover:text-white"></i>
                    </div>
                    ${pricingConfigHTML}
                </div>
            </div>
        </div>
    `;
},

renderAssetSwapPanel: () => {
    const state = AppState.modeler.assetSwap;
    const assetOptions = (selectedKey) => AppState.marketData
        .filter(a => a.type !== 'Cross-Rate' && a.price > 0)
        .sort((a, b) => a.baseAsset.localeCompare(b.baseAsset))
        .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const fromAsset = Utils.getAssetByKey(state.fromAssetKey);
    return `
        <div class="flex items-center gap-4 perspective-container">
            <div class="flex-1">
                <label class="block text-sm font-medium text-text-muted mb-2">From Asset</label>
                <select data-path="assetSwap.fromAssetKey" class="form-select">${assetOptions(state.fromAssetKey)}</select>
            </div>
            <div class="pt-8">
                <button onclick="Logic.swapAssets()" class="w-12 h-12 flex items-center justify-center rounded-full bg-primary-azure/20 text-primary-azure hover:bg-primary-azure/30 transition-all duration-300 preserve-3d hover:rotate-y-180" title="Swap Assets">
                    <i id="swap-icon" class="fas fa-exchange-alt text-xl"></i>
                </button>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-text-muted mb-2">To Asset</label>
                <select data-path="assetSwap.toAssetKey" class="form-select">${assetOptions(state.toAssetKey)}</select>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Amount to Swap (<span class="font-bold text-white">${fromAsset.baseAsset || 'N/A'}</span>)</label>
            <input type="text" data-path="assetSwap.amount" value="${(parseFloat(state.amount) || 0).toLocaleString()}" class="form-input text-lg font-bold">
        </div>
    `;
},

renderCommodityTradePanel: () => {
    const state = AppState.modeler.commodityTrade;
    const commodityOptions = (selectedKey) => AppState.marketData.filter(asset => ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Commodity', 'Energy'].some(term => asset.type?.includes(term))).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.key})</option>`).join('');
    const settlementOptions = (selectedKey) => AppState.marketData.filter(a => a.price > 0 && a.key !== state.assetKey).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset}</option>`).join('');
    const selectedIncoterm = commodityData.incoterms.find(i => i.value === state.incoterms) || commodityData.incoterms.find(i => i.value === 'FOB');

    const pricingModelInputs = () => {
        if (state.pricingModel === 'Fixed') {
            return `<div><label class="block text-sm font-medium text-text-muted mb-2">Fixed Price per Unit (USD)</label><input type="number" step="0.01" data-path="commodityTrade.fixedPrice" value="${state.fixedPrice}" class="form-input"></div>`;
        }
        if (state.pricingModel === 'Discount' || state.pricingModel === 'Premium') {
            return `<div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">${state.pricingModel} Value</label><input type="number" step="0.01" data-path="commodityTrade.discountPremiumValue" value="${state.discountPremiumValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Value Type</label><select data-path="commodityTrade.discountPremiumIsInPercent" class="form-select"><option value="true" ${state.discountPremiumIsInPercent ? 'selected':''}>Percentage (%)</option><option value="false" ${!state.discountPremiumIsInPercent ? 'selected':''}>Fixed Amount ($)</option></select></div></div>`;
        }
        return '';
    };

    return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2"><label class="block text-sm font-medium text-text-muted mb-2">Commodity Asset</label><select data-path="commodityTrade.assetKey" class="form-select">${commodityOptions(state.assetKey)}</select></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">Quantity</label><input type="number" data-path="commodityTrade.quantity" value="${state.quantity || ''}" class="form-input font-bold"></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Unit of Measure</label><select data-path="commodityTrade.unitOfMeasure" class="form-select"><option value="">Select unit...</option>${commodityData.unitsOfMeasure.map(u => `<option value="${u}" ${state.unitOfMeasure === u ? 'selected' : ''}>${u}</option>`).join('')}</select></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-text-muted mb-2">Origin Country</label><input list="countries-datalist" value="${state.origin || ''}" data-path="commodityTrade.origin" class="form-input"><datalist id="countries-datalist">${commodityData.countries.map(c => `<option value="${c}">`).join('')}</datalist></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">${selectedIncoterm.port}</label><input list="ports-datalist" value="${state.port || ''}" data-path="commodityTrade.port" class="form-input"><datalist id="ports-datalist">${commodityData.ports.map(p => `<option value="${p}">`).join('')}</datalist></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">IncotermsÂ® 2020</label><select data-path="commodityTrade.incoterms" class="form-select">${commodityData.incoterms.map(i => `<option value="${i.value}" ${state.incoterms === i.value ? 'selected' : ''}>${i.label}</option>`).join('')}</select><p class="text-xs text-text-muted mt-2">Risk transfers to <strong>${selectedIncoterm.risk}</strong> â€¢ Cost responsibility: ${selectedIncoterm.cost}</p></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Pricing Model</label><div class="flex flex-wrap gap-2">${['Market', 'Discount', 'Premium', 'Fixed'].map(p => `<label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-colors duration-200 ${state.pricingModel === p ? 'bg-primary-azure/20 text-white' : 'bg-background-light hover:bg-background-secondary'}"><input type="radio" name="pricingModel" value="${p}" ${state.pricingModel === p ? 'checked' : ''} data-path="commodityTrade.pricingModel" class="hidden">${p}</label>`).join('')}</div></div>
            ${pricingModelInputs()}
            <div><label class="block text-sm font-medium text-text-muted mb-2">Settlement Asset</label><select data-path="commodityTrade.settlementAssetKey" class="form-select"><option value="USD">USD (Default)</option>${settlementOptions(state.settlementAssetKey)}</select></div>
        </div>
    `;
},

renderCryptoLoanPanel: () => {
    const state = AppState.modeler.cryptoLoan;
    const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type === 'Cryptocurrency').map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
    return `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div>
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label>
            <div class="flex items-center gap-4">
                <input type="range" id="ltv-range-crypto" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="ltv-slider w-full h-2 rounded-lg appearance-none cursor-pointer">
                <div class="relative w-28">
                    <input type="number" id="ltv-number-crypto" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div>
        </div>
    `;
},

renderSBLCMonetizationPanel: () => {
    const state = AppState.modeler.sblcMonetization;
    return `
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label>
            <input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold">
        </div>
        <div>
            <label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label>
            <div class="flex items-center gap-4">
                <input type="range" id="ltv-range-sblc" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="ltv-slider w-full h-2 rounded-lg appearance-none cursor-pointer">
                <div class="relative w-28">
                    <input type="number" id="ltv-number-sblc" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
            </div>
        </div>
    `;
},

renderModelerOutputPanel: (calc) => {
    if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
    
    let customOutput = '';
    if (AppState.modeler.activeDealType === 'AssetSwap') {
        const { fromAsset, toAsset, rate } = calc; const rateDisplay = rate > 0 ? rate.toFixed(8) : 'N/A';
        customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-sync-alt"></i>Institutional Cross Rate</p><p class="value">${rateDisplay}</p><p class="sub-value">1 ${fromAsset.baseAsset} â‰ˆ ${rateDisplay} ${toAsset.baseAsset}</p></div>`;
    } else if (AppState.modeler.activeDealType === 'CryptoLoan') {
        const monthlyPayment = calc.totalRepayment / (calc.tenureMonths || 1);
        customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-hand-holding-usd"></i>Loan Principal</p><p class="value">${Utils.formatPrice(calc.loanPrincipal, calc.loanCurrency)}</p><p class="sub-value">Total Repayment: ${Utils.formatPrice(calc.totalRepayment, calc.loanCurrency)}</p></div><div class="output-metric-card mt-4"><p class="label"><i class="fas fa-calendar-alt"></i>Monthly Repayment</p><p class="value">${Utils.formatPrice(monthlyPayment, calc.loanCurrency)}</p><p class="sub-value">${calc.tenureMonths}-month tenure @ ${calc.interestRateValue}% fixed</p></div>`;
    }

    return `
        <div class="flex flex-col h-full animate-card-enter">
            <h2 class="premium-section-title text-2xl mb-6">Deal Analysis & Projections</h2>
            <div class="space-y-4 flex-grow">
                <div class="output-metric-card base-value">
                    <p class="label"><i class="fas fa-tags"></i>Base/Market Value</p>
                    <p class="value">${Utils.formatPrice(calc.baseValueUSD)}</p>
                    <p class="sub-value">${calc.dealTitle}</p>
                </div>
                <div class="output-metric-card net">
                    <p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Value to Buyer</p>
                    <p class="value">${Utils.formatPrice(calc.finalValueToBuyerUSD)}</p>
                    <p class="sub-value">${calc.netValueDescription}</p>
                </div>
                <div class="output-metric-card commission">
                    <p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p>
                    <p class="value">${Utils.formatPrice(calc.totalCommissionPool)}</p>
                    <p class="sub-value">${calc.grossValueDescription}</p>
                </div>
                ${customOutput}
            </div>
            <div class="mt-auto pt-6 border-t border-border-color space-y-3">
                <h4 class="text-center text-sm font-semibold text-text-muted">Generate Legal Documents</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="Logic.openSpaModal()" class="btn-primary w-full py-3 font-bold">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>Generate SPA
                    </button>
                    <button onclick="Logic.openImfpaModal()" class="btn-gold w-full py-3 font-bold">
                        <i class="fas fa-file-signature mr-2"></i>Manage IMFPA
                    </button>
                </div>
            </div>
        </div>
    `;
},

    // --- UPGRADED IMFPA & NEW SPA UI RENDERERS ---
renderImfpaModal: () => {
    const { imfpa } = AppState.modeler;
    const isImfpa = imfpa.agreementType === 'IMFPA';
    const isReadyToSynthesize = Logic.validateImfpaData();
    
    const synthesizeButtonClass = isReadyToSynthesize 
        ? 'from-premium-gold via-yellow-500 to-yellow-600 border-premium-gold hover:shadow-2xl hover:shadow-premium-gold-glow transform hover:scale-105 transition-all duration-300'
        : 'from-gray-700 via-gray-600 to-gray-800 border-gray-600 cursor-not-allowed opacity-75';
    const synthesizeButtonText = isReadyToSynthesize 
        ? 'Synthesize & Generate Document' 
        : 'Complete Required Fields (*) to Synthesize';

    return `
        <div class="dialog-content-wrapper premium-modal-bg max-w-7xl">
            <div class="flex flex-col h-full">
                <header class="premium-modal-header p-6 flex-shrink-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="premium-section-title text-3xl">Interactive Contract Workspace</h2>
                            <p class="text-text-muted mt-1">Configure NCNDA / IMFPA details and generate legally-binding documents.</p>
                        </div>
                        <button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-text-muted hover:text-white transition-all duration-300 transform hover:rotate-90">&times;</button>
                    </div>
                    <div class="mt-4 p-4 rounded-xl bg-black/20 border border-border-color flex items-center justify-center gap-4">
                        <span class="font-semibold transition-colors ${!isImfpa ? 'text-primary-azure' : 'text-text-muted'}">NCNDA Only</span>
                        <label class="relative inline-block w-16 h-8">
                            <input type="checkbox" onchange="Logic.toggleAgreementType(this.checked)" ${isImfpa ? 'checked' : ''} class="opacity-0 w-0 h-0">
                            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full transition-colors duration-300 ${isImfpa ? 'bg-premium-gold' : 'bg-background-secondary'}"></span>
                            <span class="absolute cursor-pointer content-[''] h-6 w-6 left-1 bottom-1 bg-white rounded-full transition-transform duration-300 ${isImfpa ? 'transform translate-x-8' : ''}"></span>
                        </label>
                        <span class="font-semibold transition-colors ${isImfpa ? 'text-premium-gold' : 'text-text-muted'}">Full IMFPA</span>
                    </div>
                </header>
                
                <main class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 p-6 overflow-hidden">
                    <section id="editor-content-dynamic" class="flex flex-col gap-6 overflow-y-auto pr-2">
                        <!-- Dynamic content will be rendered here -->
                    </section>
                    <section class="hidden lg:flex flex-col gap-6 overflow-hidden">
                        <h3 class="premium-section-title text-xl">Live Document Preview</h3>
                        <div id="contract-preview-container" class="flex-grow bg-background-dark/50 rounded-lg p-4 border border-border-color overflow-y-auto">
                            <!-- Live preview will be rendered here -->
                        </div>
                    </section>
                </main>

                <footer class="p-6 border-t border-border-premium bg-background-dark/50 flex-shrink-0">
                    <div id="synthesis-state">
                        <button id="synthesize-btn" onclick="Logic.generateContract()" class="w-full py-4 font-bold text-lg rounded-xl bg-gradient-to-r ${synthesizeButtonClass} border-2" ${!isReadyToSynthesize ? 'disabled' : ''}>
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>${synthesizeButtonText}
                        </button>
                    </div>
                    <div class="execution-suite-container hidden" id="execution-suite-footer">
                        <!-- Execution buttons will appear here after synthesis -->
                    </div>
                </footer>
            </div>
        </div>
    `;
},

renderImfpaEditorContent: () => {
    const { imfpa } = AppState.modeler;
    const isImfpa = imfpa.agreementType === 'IMFPA';

    return `
        <!-- Commission Allocation Section (IMFPA ONLY) -->
        <div id="commission-allocation-section" class="premium-card p-6 ${isImfpa ? 'animate-card-enter' : 'hidden'}">
            <div class="flex justify-between items-start mb-4">
                <h3 class="premium-section-title">Commission Allocation</h3>
                <div class="text-right">
                    <p class="text-xs text-text-muted">Total Commission Pool</p>
                    <p id="imfpa-total-commission-pool" class="text-2xl font-bold text-premium-gold font-mono">${Utils.formatPrice(imfpa.totalCommission)}</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-3 bg-background-dark rounded-lg mb-4">
                <button onclick="Logic.addImfpaGroup()" class="btn-primary text-sm px-3 py-1"><i class="fas fa-plus mr-2"></i>Add Group</button>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox" onchange="AppState.modeler.imfpa.autoBalance = this.checked; Logic.refreshImfpaModalUI();" ${imfpa.autoBalance ? 'checked' : ''} class="w-4 h-4 rounded text-premium-gold focus:ring-premium-gold/50">Auto-Balance</label>
                    <div id="imfpa-total-allocated" class="text-sm font-mono px-2 py-1 rounded bg-background-light"></div>
                </div>
            </div>
            <div id="imfpa-groups-container" class="space-y-4"></div>
        </div>

        <!-- Parties Section -->
        <div class="premium-card p-6 animate-card-enter">
            <div class="flex justify-between items-center mb-4">
                <h3 class="premium-section-title">${isImfpa ? 'Allocation Members' : 'Signatory Parties'}</h3>
                ${!isImfpa ? `<button onclick="Logic.addImfpaParty(0)" class="btn-primary text-sm px-3 py-1"><i class="fas fa-user-plus mr-2"></i>Add Party</button>` : ''}
            </div>
            <div id="ncnda-parties-container" class="space-y-3">
                <!-- Parties for NCNDA mode or a placeholder will be rendered here by renderImfpaGroups -->
            </div>
        </div>

        <!-- Legal Framework Section -->
        <div class="premium-card p-6 animate-card-enter">
            <h3 class="premium-section-title mb-4">Legal Framework</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-2">Governing Law & Jurisdiction *</label>
                    <input type="text" data-path="imfpa.jurisdiction" value="${imfpa.jurisdiction}" class="form-input" placeholder="e.g., Singapore, Dubai, England & Wales">
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-muted mb-2">Cross-Referenced SPA (Optional)</label>
                    <input type="text" data-path="imfpa.spaReferenceCode" value="${imfpa.spaReferenceCode}" class="form-input font-mono" placeholder="e.g., SPA-2024-XYZ-001">
                </div>
            </div>
        </div>
    `;
},

renderImfpaGroups: () => {
    const { imfpa } = AppState.modeler;
    const { groups } = imfpa;

    if (imfpa.agreementType === 'IMFPA') {
        const imfpaContainer = document.getElementById('imfpa-groups-container');
        if (!imfpaContainer) return;

        if (!groups || groups.length === 0) {
            imfpaContainer.innerHTML = `<div class="text-center py-6 text-text-muted"><i class="fas fa-layer-group fa-2x mb-2"></i><p>No allocation groups defined.</p></div>`;
            return;
        }
        imfpaContainer.innerHTML = groups.map((group, groupIndex) => `
            <div class="allocation-group-card bg-background-dark/50 p-4 rounded-lg border border-border-color transition-all duration-300 hover:border-premium-gold animate-card-enter" style="animation-delay: ${groupIndex * 75}ms">
                <div class="flex items-center gap-2 mb-3">
                    <input type="text" value="${group.name}" data-path="imfpa.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow !p-1 font-semibold text-lg text-white" placeholder="Group Name">
                    <div class="relative w-32 flex-shrink-0"><input type="number" value="${group.percentage}" data-path="imfpa.groups[${groupIndex}].percentage" class="form-input text-right font-bold"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div>
                    <button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-premium-crimson hover:text-white w-8 h-8 flex-shrink-0 flex items-center justify-center transition-colors duration-300 rounded-full hover:bg-premium-crimson/20"><i class="fas fa-trash"></i></button>
                </div>
                <div class="space-y-2 pl-4 border-l-2 border-border-color">
                    ${group.parties.length > 0 ? group.parties.map((party, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('') : '<p class="text-xs text-center text-text-muted py-2">No members in this group.</p>'}
                    <div class="flex justify-between items-center pt-2">
                        <button onclick="Logic.addImfpaParty(${groupIndex})" class="text-premium-gold hover:text-white text-xs font-semibold"><i class="fas fa-user-plus mr-1"></i>Add Member</button>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('ncnda-parties-container').innerHTML = '<p class="text-sm text-center text-text-muted">Parties are managed within their respective allocation groups above.</p>';
    } else {
        const ncndaContainer = document.getElementById('ncnda-parties-container');
        if (!ncndaContainer) return;

        if (!groups[0]?.parties || groups[0].parties.length === 0) {
            ncndaContainer.innerHTML = `<div class="text-center py-6 text-text-muted"><i class="fas fa-users fa-2x mb-2"></i><p>No signatory parties added.</p></div>`;
        } else {
            ncndaContainer.innerHTML = groups[0].parties.map((party, partyIndex) => UI.renderImfpaParty(0, partyIndex)).join('');
        }
    }
},

renderImfpaParty: (groupIndex, partyIndex) => {
    const party = AppState.modeler.imfpa.groups[groupIndex].parties[partyIndex];
    const base = `imfpa.groups[${groupIndex}].parties[${partyIndex}]`;
    const isImfpa = AppState.modeler.imfpa.agreementType === 'IMFPA';

    return `
        <div class="party-card bg-background-dark/30 p-3 rounded-lg border border-transparent hover:border-primary-azure transition-colors duration-300">
            <div class="flex items-center gap-2">
                <input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow !p-1 text-sm font-medium text-white" placeholder="Full Legal Name *">
                <div class="relative w-24 flex-shrink-0 ${isImfpa ? 'block' : 'hidden'}">
                    <input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input !text-sm text-right">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span>
                </div>
                <button onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-white text-xs w-6 h-6 flex items-center justify-center transition-colors"><i class="fas fa-cog"></i></button>
                <button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-premium-crimson text-xs w-6 h-6 flex items-center justify-center transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="collapsible-content ${party.detailsVisible ? 'expanded' : ''}">
                <div>${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div>
            </div>
        </div>
    `;
},

renderImfpaPartyDetails: (groupIndex, partyIndex) => {
    const party = AppState.modeler.imfpa.groups[groupIndex].parties[partyIndex];
    const base = `imfpa.groups[${groupIndex}].parties[${partyIndex}]`;
    
    return `
        <div class="pt-3 mt-2 border-t border-border-color space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div><label class="block text-xs text-text-muted mb-1">Email *</label><input type="email" class="form-input !text-xs" value="${party.email || ''}" data-path="${base}.email"></div>
                <div><label class="block text-xs text-text-muted mb-1">Contact Number *</label><input type="tel" class="form-input !text-xs" value="${party.contactNumber || ''}" data-path="${base}.contactNumber"></div>
                <div><label class="block text-xs text-text-muted mb-1">Role/Title</label><input type="text" class="form-input !text-xs" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate"></div>
                <div><label class="block text-xs text-text-muted mb-1">Passport/ID</label><input type="text" class="form-input !text-xs" value="${party.passport.number || ''}" data-path="${base}.passport.number"></div>
            </div>
            <div>
                <label class="block text-xs text-text-muted mb-1">Payment Method</label>
                <select class="form-select !text-xs" data-path="${base}.payment.method">
                    <option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected':''}>Bank Wire</option>
                    <option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected':''}>USDT (TRC-20)</option>
                    <option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected':''}>USDT (ERC-20)</option>
                </select>
            </div>
        </div>
    `;
},

renderSpaModal: () => {
    return `<div class="dialog-content-wrapper premium-modal-bg max-w-5xl"><div class="flex flex-col h-full"><header class="premium-modal-header p-6 flex-shrink-0"><div class="flex justify-between items-center"><h2 class="premium-section-title text-2xl">Sales & Purchase Agreement (SPA) Generator</h2><button onclick="document.getElementById('spa-modal').close()" class="text-3xl text-text-muted hover:text-white transition-all duration-300 transform hover:rotate-90">&times;</button></div></header><main id="spa-editor-content" class="flex-grow p-6 overflow-y-auto"></main><footer class="p-6 border-t border-border-premium bg-background-dark/50 flex-shrink-0"><div class="flex justify-end gap-4"><button class="btn-gold" onclick="Logic.generateSpaDocument()"><i class="fas fa-file-pdf mr-2"></i>Generate & Download PDF</button></div></footer></div></div>`;
},

renderSpaEditor: () => {
    const { spa } = AppState.modeler;
    return `
        <div class="space-y-8">
            <div class="premium-card p-6 animate-card-enter">
                <h3 class="premium-section-title mb-4">Core Agreement Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-text-muted mb-2">Total Deal Value</label><input type="number" data-path="spa.dealValue" value="${spa.dealValue}" class="form-input"></div>
                    <div><label class="block text-sm font-medium text-text-muted mb-2">Deal Currency</label><input type="text" data-path="spa.dealCurrency" value="${spa.dealCurrency}" class="form-input"></div>
                    <div><label class="block text-sm font-medium text-text-muted mb-2">Governing Law</label><input type="text" data-path="spa.governingLaw" value="${spa.governingLaw}" class="form-input" placeholder="e.g., English Law"></div>
                    <div><label class="block text-sm font-medium text-text-muted mb-2">Arbitration</label><input type="text" data-path="spa.arbitration" value="${spa.arbitration}" class="form-input" placeholder="e.g., SIAC, Singapore"></div>
                </div>
            </div>
            <div class="premium-card p-6 animate-card-enter" style="animation-delay: 100ms;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="premium-section-title">Contracting Parties</h3>
                    <button onclick="Logic.addSpaParty()" class="btn-primary text-sm px-3 py-1"><i class="fas fa-plus mr-2"></i>Add Party</button>
                </div>
                <div id="spa-parties-container" class="space-y-3">${spa.parties.map((p, i) => UI.renderSpaParty(p, i)).join('')}</div>
            </div>
            <div class="premium-card p-6 animate-card-enter" style="animation-delay: 200ms;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="premium-section-title">Payment Tranches</h3>
                    <button onclick="Logic.addSpaTranche()" class="btn-primary text-sm px-3 py-1"><i class="fas fa-plus mr-2"></i>Add Tranche</button>
                </div>
                <div id="spa-tranches-container" class="space-y-4">${spa.tranches.map((t, i) => UI.renderSpaTranche(t, i)).join('')}</div>
                <div class="mt-6 pt-4 border-t border-border-color flex justify-between items-center font-mono">
                    <div class="text-text-muted">Total Allocated: <span id="spa-total-allocated" class="text-text-diamond font-bold">${Utils.formatPrice(0)}</span></div>
                    <div id="spa-remaining-value" class="font-bold text-premium-warning"></div>
                </div>
            </div>
        </div>
    `;
},

renderSpaParty: (party, index) => {
    const path = `spa.parties[${index}]`;
    return `
        <div class="flex items-center gap-3 p-3 bg-background-dark rounded-lg animate-card-enter border border-transparent hover:border-primary-azure transition-colors" style="animation-delay: ${index * 50}ms">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 flex-grow">
                <div><label class="block text-xs text-text-muted mb-1">Legal Name</label><input type="text" data-path="${path}.legalName" value="${party.legalName}" class="form-input text-sm"></div>
                <div><label class="block text-xs text-text-muted mb-1">Role</label><input type="text" data-path="${path}.role" value="${party.role}" placeholder="e.g., Buyer, Seller" class="form-input text-sm"></div>
                <div class="md:col-span-2"><label class="block text-xs text-text-muted mb-1">Address</label><input type="text" data-path="${path}.address" value="${party.address}" class="form-input text-sm"></div>
            </div>
            <button onclick="Logic.removeSpaParty(${index})" class="text-premium-crimson hover:text-white transition-colors p-2"><i class="fas fa-trash"></i></button>
        </div>
    `;
},

renderSpaTranche: (tranche, index) => {
    const path = `spa.tranches[${index}]`;
    return `
        <div class="flex items-center gap-3 p-3 bg-background-dark rounded-lg animate-card-enter border border-transparent hover:border-premium-gold transition-colors" style="animation-delay: ${index * 50}ms">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 flex-grow">
                <div><label class="block text-xs text-text-muted mb-1">Amount</label><input type="number" data-path="${path}.amount" value="${tranche.amount}" class="form-input text-sm"></div>
                <div><label class="block text-xs text-text-muted mb-1">Due Date</label><input type="date" data-path="${path}.date" value="${tranche.date}" class="form-input text-sm"></div>
                <div><label class="block text-xs text-text-muted mb-1">Condition / Milestone</label><input type="text" data-path="${path}.condition" value="${tranche.condition}" placeholder="e.g., Upon Bill of Lading" class="form-input text-sm"></div>
            </div>
            <button onclick="Logic.removeSpaTranche(${index})" class="text-premium-crimson hover:text-white transition-colors p-2"><i class="fas fa-trash"></i></button>
        </div>
    `;
},
// --- UPGRADED MODALS & UTILITY RENDERERS ---
renderSignatureModal: () => {
    return `
        <div class="dialog-content-wrapper premium-modal-bg max-w-2xl">
            <div id="signature-modal-content" class="flex flex-col h-full">
                <!-- Premium Modal Header -->
                <header class="premium-modal-header p-6 flex-shrink-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="premium-section-title text-2xl" style="border-left-color: var(--premium-success); text-shadow: 0 0 15px var(--premium-success);">
                                Document Execution Suite
                            </h2>
                            <p class="text-text-muted mt-1 pl-5">Apply a legally binding signature and/or corporate seal.</p>
                        </div>
                        <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-all duration-300 transform hover:rotate-90">&times;</button>
                    </div>
                    <div class="mt-4">
                        <label for="signature-target-select" class="block text-sm font-semibold text-text-muted mb-2">Apply signature/seal for:</label>
                        <select id="signature-target-select" class="form-select w-full"></select>
                    </div>
                </header>

                <!-- Signature Tools Area -->
                <main class="flex-grow p-6 overflow-y-auto">
                    <div class="tool-tabs flex border-b border-border-premium mb-6">
                        <button id="draw-tab-btn" class="tool-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent transition-all duration-300" onclick="Logic.switchSignatureMode('draw')">
                            <i class="fas fa-pencil-alt mr-2"></i>Draw Signature
                        </button>
                        <button id="upload-tab-btn" class="tool-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent transition-all duration-300" onclick="Logic.switchSignatureMode('upload')">
                            <i class="fas fa-upload mr-2"></i>Upload Image
                        </button>
                        <button id="seal-tab-btn" class="tool-tab flex-1 p-3 text-sm font-semibold border-b-2 border-transparent transition-all duration-300" onclick="Logic.switchSignatureMode('seal')">
                            <i class="fas fa-stamp mr-2"></i>Corporate Seal
                        </button>
                    </div>
                    
                    <!-- Panels with Premium Animations -->
                    <div class="relative min-h-[250px]">
                        <div id="draw-mode-panel" class="absolute inset-0 transition-all duration-500 opacity-0">
                            <canvas id="signature-canvas" class="w-full h-48 bg-premium-paper/5 rounded-lg"></canvas>
                            <div class="mt-2 text-right">
                                <button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white transition-colors">
                                    <i class="fas fa-eraser mr-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        <div id="upload-mode-panel" class="absolute inset-0 transition-all duration-500 opacity-0 hidden">
                            <input type="file" id="signature-upload-input" accept="image/*" class="hidden">
                            <label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-border-premium rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-background-secondary transition-colors group">
                                <img id="signature-upload-preview" class="hidden max-h-44 object-contain rounded"/>
                                <div id="upload-prompt" class="text-center transition-transform duration-300 group-hover:scale-105">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-text-muted mb-4 transition-colors group-hover:text-primary-azure"></i>
                                    <p class="font-semibold">Click or drag file to upload</p>
                                    <p class="text-xs text-text-subtle mt-1">PNG, JPG, SVG (Max 5MB)</p>
                                </div>
                            </label>
                        </div>
                        <div id="seal-mode-panel" class="absolute inset-0 transition-all duration-500 opacity-0 hidden">
                            <input type="file" id="seal-upload-input" accept="image/*" class="hidden">
                            <label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-border-premium rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-background-secondary transition-colors group">
                                <img id="seal-upload-preview" class="hidden max-h-44 object-contain rounded"/>
                                <div id="seal-prompt" class="text-center transition-transform duration-300 group-hover:scale-105">
                                    <i class="fas fa-certificate fa-3x text-text-muted mb-4 transition-colors group-hover:text-premium-gold"></i>
                                    <p class="font-semibold">Upload Corporate Seal</p>
                                     <p class="text-xs text-text-subtle mt-1">High-resolution recommended</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </main>

                <!-- Premium Footer -->
                <footer class="p-6 border-t border-border-premium bg-background-dark/50 flex-shrink-0">
                    <div class="text-xs text-text-muted mb-4 p-3 bg-primary-azure/10 border border-primary-azure/20 rounded-lg">
                        <p class="font-bold text-primary-azure mb-1"><i class="fas fa-shield-alt mr-2"></i>Secure & Legally Binding</p>
                        <p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p>
                        <p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span></p>
                    </div>
                    <button onclick="Logic.applySignature()" class="w-full py-4 font-bold rounded-lg bg-gradient-to-r from-premium-success to-emerald-600 text-white border-2 border-premium-success transition-all duration-300 transform hover:scale-105 hover:shadow-lg hover:shadow-premium-success/20">
                        <i class="fas fa-check-double mr-2"></i>Apply to Document
                    </button>
                </footer>
            </div>
        </div>
    `;
},

renderFinalizationModal: () => {
    return `
        <div class="dialog-content-wrapper premium-modal-bg max-w-xl">
            <div class="flex flex-col h-full">
                <!-- Premium Finalization Header -->
                <header class="premium-modal-header p-6 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg bg-gradient-to-br from-premium-crimson to-primary-amethyst" style="animation: glow-pulse 3s ease-in-out infinite;">
                            <i class="fas fa-gavel fa-2x text-white"></i>
                        </div>
                        <div>
                            <h2 class="premium-section-title text-2xl" style="border-left-color: var(--premium-crimson); text-shadow: 0 0 15px var(--glow-crimson);">
                                Finalize & Lock Document
                            </h2>
                            <p class="text-text-muted mt-1 pl-5">Please confirm this critical, irreversible action.</p>
                        </div>
                        <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-all duration-300 transform hover:rotate-90 ml-auto">&times;</button>
                    </div>
                </header>

                <!-- Content with Premium Warning -->
                <main class="flex-grow p-8 overflow-y-auto">
                    <div class="p-6 mb-8 bg-premium-crimson/10 border-l-4 border-premium-crimson rounded-r-lg">
                        <h3 class="text-xl font-bold text-premium-crimson mb-2 flex items-center gap-3">
                            <i class="fas fa-exclamation-triangle"></i>Critical Action Warning
                        </h3>
                        <p class="text-text-platinum leading-relaxed">
                            You are about to finalize this contract. This action is <strong class="text-premium-crimson">irreversible</strong> and will create a legally binding agreement. All edits will be locked.
                        </p>
                    </div>

                    <h4 class="text-lg font-bold text-text-diamond mb-4">Finalization Process Overview:</h4>
                    <ul class="space-y-4">
                        <li class="flex items-start gap-4 p-3 bg-background-dark/50 rounded-lg transition-transform duration-300 hover:scale-105 hover:bg-background-secondary">
                            <i class="fas fa-lock text-primary-amethyst text-xl mt-1"></i>
                            <div>
                                <strong class="text-text-diamond">Document State Lock</strong>
                                <p class="text-sm text-text-muted">The current version will be cryptographically sealed to prevent any future edits.</p>
                            </div>
                        </li>
                        <li class="flex items-start gap-4 p-3 bg-background-dark/50 rounded-lg transition-transform duration-300 hover:scale-105 hover:bg-background-secondary">
                            <i class="fas fa-fingerprint text-primary-azure text-xl mt-1"></i>
                            <div>
                                <strong class="text-text-diamond">Generate Secure Audit Trail</strong>
                                <p class="text-sm text-text-muted">An immutable record of all actions, signatures, and timestamps will be generated.</p>
                            </div>
                        </li>
                        <li class="flex items-start gap-4 p-3 bg-background-dark/50 rounded-lg transition-transform duration-300 hover:scale-105 hover:bg-background-secondary">
                            <i class="fas fa-paper-plane text-premium-success text-xl mt-1"></i>
                            <div>
                                <strong class="text-text-diamond">Dispatch to All Parties</strong>
                                <p class="text-sm text-text-muted">The finalized, signed PDF will be securely dispatched to all signatories.</p>
                            </div>
                        </li>
                    </ul>
                </main>

                <!-- Footer with Premium Action Buttons -->
                <footer class="p-6 border-t border-border-premium bg-background-dark/50 flex-shrink-0 flex flex-col sm:flex-row gap-4">
                    <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary w-full sm:w-1/3 py-3 transition-transform duration-300 hover:scale-105">Cancel</button>
                    <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="w-full sm:flex-1 py-3 font-bold rounded-lg bg-gradient-to-r from-premium-crimson to-primary-amethyst text-white border-2 border-premium-crimson transition-all duration-300 transform hover:scale-105 hover:shadow-lg hover:shadow-premium-crimson/30">
                        <i class="fas fa-gavel mr-2"></i>Proceed with Finalization
                    </button>
                </footer>
            </div>
        </div>
    `;
},
};

// --- SECTION 5: INITIALIZATION ---
document.addEventListener('DOMContentLoaded', Logic.init);

</script>
</body>
</html>
