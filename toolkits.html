<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECANâ„¢ XDealFlow | Intelligent Toolkits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v4.0 (BENCHMARKED & UNIFIED) === */
        /* This stylesheet is the definitive standard for the Toolkits page, */
        /* ensuring visual consistency with the entire GECAN platform. */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
            --glow-royal: rgba(139, 92, 246, 0.8); --glow-amethyst: rgba(168, 85, 247, 0.7);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        body.mobile-sidebar-open { overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        #interactive-background { position: fixed; inset: 0; z-index: -3; overflow: hidden; perspective: 1500px; background: radial-gradient(ellipse at center, rgba(6, 18, 42, 0.95) 0%, rgba(2, 8, 23, 0.98) 70%, rgba(0, 0, 0, 1) 100%); }
        #background-vortex { position: absolute; width: 300px; height: 300px; background: conic-gradient(from 0deg, transparent, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.2), transparent); border-radius: 50%; z-index: 0; transition: transform 0.1s linear; animation: vortex-spin 10s linear infinite; }
        #background-vortex::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(14, 165, 233, 0.25) 0%, rgba(99, 102, 241, 0.15) 30%, transparent 75%); animation: vortex-pulse 9s ease-in-out infinite alternate; }
        @keyframes vortex-spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes vortex-pulse { to { transform: scale(1.1) rotate(15deg); opacity: 1; } }

        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); overflow: hidden; }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); animation: premium-text-glow 4s ease-in-out infinite; }
        .logo-back { transform: rotateY(180deg); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); animation: premium-pulse 3s ease-in-out infinite alternate; }
        @keyframes premium-text-glow { 50% { text-shadow: 0 0 70px var(--glow-royal); } }
        @keyframes premium-pulse { 100% { transform: scale(1.05); box-shadow: 0 0 50px var(--glow-sapphire), 0 0 70px var(--glow-royal); } }

        /* BENCHMARKED NAVIGATION & MOBILE MENU */
        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }
        @keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }
        
        #mobile-sidebar.left-0 { transform: translateX(0); }
        .mobile-nav-clone { display: flex !important; flex-direction: column; padding: 1rem; gap: 0.5rem; }
        .mobile-nav-clone .nav-btn { width: 100%; justify-content: flex-start; }
        @media (max-width: 1280px) { #desktop-nav-placeholder { display: none; } #mobile-fab { display: flex; } }

        /* --- D. TOOLKIT-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        /* Universal Glass Container */
        .glass { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        /* Universal Buttons */
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
        /* Universal Forms */
        /* ========================================================================= */
/* === DEFINITIVE FORM STYLES (PINNACLE STANDARD v5.2 - TEXT COLOR FIX) === */
/* This is the SINGLE SOURCE OF TRUTH for all form elements. */
/* ========================================================================= */

.form-input, .form-select {
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
    /* DEFINITIVE TEXT COLOR FIX: Ensures text is always bright white */
    color: var(--text-primary); 
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    width: 100%;
    font-size: 1rem;
    transition: all 0.3s ease;
    appearance: none;
    /* CRITICAL FOR CHROME AUTOFILL: Overrides the browser's default text color */
    -webkit-text-fill-color: var(--text-primary);
    box-shadow: inset 0 0 0 30px var(--background-light); /* Prevents autofill background color change */
}

.form-input::placeholder {
    color: var(--text-muted);
    opacity: 1; /* Ensure placeholder is visible */
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-azure);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25), inset 0 0 0 30px var(--background-secondary);
    background-color: var(--background-secondary); /* Darken on focus for contrast */
}

/* Readonly styles for a premium, disabled look */
.form-input:read-only {
    background-color: var(--background-dark);
    color: var(--text-muted);
    cursor: not-allowed;
    box-shadow: none;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}
        /* Toolkit Content Cards */
        .report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
        .report-section:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(-2px); }
        .gradient-text { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes float { 50% { transform: translateY(-8px); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .animate-scale-in { animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; }

        /* Wallet Forensics Report Specific Styles */
        .risk-LOW { --risk-color: var(--success-color); } .risk-MEDIUM { --risk-color: var(--warning-color); }
        .risk-HIGH { --risk-color: var(--error-color); } .risk-CRITICAL { --risk-color: var(--critical-color); }
        .text-risk-color { color: var(--risk-color); } .border-risk-color { border-color: var(--risk-color); } .bg-risk-color { background-color: var(--risk-color); }
        .score-gauge-bg { stroke: var(--background-secondary); stroke-width: 2.5; }
        .score-gauge-fg { stroke-width: 3.5; stroke-linecap: round; transform-origin: 50% 50%; transform: rotate(-90deg); transition: stroke-dasharray 1.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .gauge-low { color: var(--success-color); } .gauge-medium { color: var(--warning-color); }
        .gauge-high { color: var(--error-color); } .gauge-critical { color: var(--critical-color); }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 20px; border-left: 2px solid var(--border-color); }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--background-secondary); display: grid; place-items: center; }
        .timeline-dot-inner { width: 8px; height: 8px; border-radius: 50%; }

        /* Institutional Modeler Specific Styles */
        .deal-type-card { background: var(--background-glass); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; cursor: pointer; transition: all 0.4s ease; text-align: left; }
        .deal-type-card:hover { transform: translateY(-8px) scale(1.03); border-color: var(--primary-azure); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 40px rgba(14, 165, 233, 0.2); }
        .deal-type-card.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--primary-azure); transform: translateY(-4px) scale(1.05); }
        .deal-type-icon { transition: all 0.3s ease; } .deal-type-card:hover .deal-type-icon { animation: icon-glow-rotate 1.5s ease-in-out infinite; color: var(--text-primary); }
        @keyframes icon-glow-rotate { 50% { transform: rotate(15deg) scale(1.1); filter: drop-shadow(0 0 20px currentColor); } }
        
        .output-metric-card { background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
        .output-metric-card .label { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .output-metric-card .value { font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .output-metric-card .sub-value { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
        .output-metric-card.base-value .value { color: var(--primary-azure); } .output-metric-card.net .value { color: var(--success-color); } .output-metric-card.commission .value { color: var(--warning-color); }
        
        /* IMFPA/NCNDA Modal Styles */
        #imfpa-modal-content { border: 1px solid var(--border-premium); box-shadow: 0 25px 60px -12px rgba(0,0,0,0.75), 0 0 0 1px rgba(139, 92, 246, 0.2); background: linear-gradient(180deg, var(--background-light) 0%, var(--background-primary) 100%); }
        .imfpa-section-title { font-family: 'Orbitron', monospace; font-size: 1.25rem; font-weight: bold; color: var(--text-diamond); }
        .allocation-group-card { background: var(--background-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1rem; }
        .allocation-party-card { background: var(--background-light); border: 1px solid var(--border-secondary); border-radius: 0.75rem; padding: 0.75rem; }
        .party-details-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.75rem; padding-top: 1rem; margin-top: 0.75rem; border-top: 1px solid var(--border-secondary); }
        .party-detail-label { font-size: 0.65rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.5s ease; }
        .collapsible-content.expanded { grid-template-rows: 1fr; }
        .collapsible-content > div { overflow: hidden; }

        /* Dialog & Modal Base Styles */
       /* ========================================================================= */
/* === DEFINITIVE MODAL & FORM STYLES (PINNACLE STANDARD v5.1) === */
/* This is the SINGLE SOURCE OF TRUTH for all dialogs and modals. */
/* REMOVE ALL OTHER 'dialog' STYLES TO PREVENT CONFLICTS. */
/* ========================================================================= */

/* --- A. UNIVERSAL DIALOG & BACKDROP STYLES (POSITIONING FIX) --- */
dialog {
    /* Base resets */
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    overflow: visible !important;
    max-width: 90vw; /* Responsive max-width */
    width: auto;
}

/* The [open] state is the key to perfect centering */
dialog[open] {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: fixed !important; 
    inset: 0 !important; 
    animation: modal-backdrop-fade-in 0.5s ease forwards;
    z-index: 200 !important; /* Highest z-index */
}

dialog::backdrop {
    background: rgba(5, 5, 9, 0.85) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    animation: modal-backdrop-fade-in 0.5s ease forwards;
}

/* --- B. DIALOG CONTENT WRAPPER --- */
/* This is the visible modal box that gets centered by the parent dialog */
.dialog-content-wrapper {
    background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
    border: 1px solid var(--border-premium) !important;
    box-shadow: var(--shadow-quantum) !important;
    border-radius: 1.5rem !important;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: modal-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* --- C. SPECIFIC MODAL WIDTHS --- */
/* Control the width of specific modals by targeting their ID */
#imfpa-modal { max-width: 80vw !important; }
#submission-modal { max-width: 640px !important; }
#signature-modal { max-width: 560px !important; }


/* --- D. KEYFRAME ANIMATIONS --- */
@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}
@keyframes scaleIn { 
    from { opacity: 0; transform: scale(0.95); } 
    to { opacity: 1; transform: scale(1); } 
}

        @keyframes modal-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes modal-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* ========================================================================= */
/* === DEFINITIVE FORM TEXT & LEGEND STYLES (PINNACLE STANDARD v5.4) === */
/* This block specifically targets form labels and legends for perfect text color. */
/* ========================================================================= */

/* --- A. Fieldset & Legend Enhancement --- */
fieldset {
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1rem;
    position: relative; /* Required for legend positioning */
    margin-top: 1rem; /* Add space for the legend */
}

legend {
    /* Styling for "Transaction Context", "Your Details", etc. */
    padding: 0 0.5rem; /* Horizontal padding */
    margin-left: 0.5rem; /* Indent from the left edge */
    font-size: 1.125rem; /* 18px for better hierarchy */
    font-weight: 600; /* Semibold */
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--primary-azure);
    
    /* Ensures it sits correctly on top of the fieldset border */
    position: relative;
    top: -0.5rem;
    display: inline-block;
    width: auto;
}

/* --- B. Label Enhancement --- */
label.form-label,
/* Target labels within the submission form specifically for robustness */
#wallet-submission-form label {
    display: block;
    margin-bottom: 0.25rem; /* 4px space below the label */
    font-size: 0.875rem; /* 14px */
    font-weight: 500; /* Medium weight */
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-platinum); /* Use a slightly softer white for labels for better contrast against pure white input text */
}

/* --- C. Recommendation Box Text Enhancement --- */
.recommendation-box {
    margin-top: 1rem;
    padding: 1rem;
    background-color: rgba(245, 158, 11, 0.05); /* --warning-color with low opacity */
    border-left: 4px solid var(--warning-color);
    border-radius: 0 0.5rem 0.5rem 0;
}

.recommendation-box h4 {
    font-weight: 600;
    color: var(--warning-color);
}

.recommendation-box p {
    font-size: 0.875rem;
    
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-secondary); /* A clear, readable grey */
    margin-top: 0.25rem;
}

.recommendation-box strong {
    /* DEFINITIVE TEXT COLOR FIX */
    color: var(--text-diamond); /* Pure white for emphasis */
    font-weight: 600;
}

/* ========================================================================= */
/* === PINNACLE SUBMISSION SUITE ENGINE v2.0 (ISOLATED & HARDENED) === */
/* This is the definitive, self-contained style block that governs ONLY */
/* the #submission-modal for conflict-free, pinnacle-grade performance. */
/* ========================================================================= */

/* --- A. MODAL CONTAINER & CENTERING --- */
#submission-modal {
    max-width: 640px;
    width: calc(100% - 2rem);
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
    overflow: visible !important;
}

#submission-modal[open] {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: fixed !important; 
    inset: 0 !important; 
    animation: submission-backdrop-fade-in 0.5s ease forwards;
    z-index: 200 !important;
}

#submission-modal::backdrop {
    background: rgba(10, 10, 15, 0.85) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    animation: submission-backdrop-fade-in 0.5s ease forwards;
}

/* --- B. MODAL CONTENT WRAPPER --- */
#submission-modal .submission-dialog-content {
    background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
    border: 1px solid var(--border-premium) !important;
    box-shadow: var(--shadow-quantum) !important;
    border-radius: 1.5rem !important;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: submission-content-scale-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* --- C. HARDENED FORM STYLES (ISOLATED) --- */
#submission-modal .submission-form-input, 
#submission-modal .submission-form-select {
    background-color: var(--background-dark) !important;
    border: 1px solid var(--border-secondary) !important;
    color: var(--text-primary) !important; 
    border-radius: 0.75rem !important;
    padding: 0.75rem 1rem !important;
    width: 100% !important;
    font-size: 1rem !important;
    transition: all 0.3s ease !important;
    appearance: none !important;
    -webkit-text-fill-color: var(--text-primary) !important;
    box-shadow: inset 0 0 0 50px var(--background-dark) !important;
}

#submission-modal input:-webkit-autofill, 
#submission-modal input:-webkit-autofill:hover, 
#submission-modal input:-webkit-autofill:focus, 
#submission-modal input:-webkit-autofill:active {
    -webkit-text-fill-color: var(--text-primary) !important;
    box-shadow: inset 0 0 0 50px var(--background-dark) !important;
    caret-color: var(--text-primary) !important;
}

#submission-modal .submission-form-input::placeholder { color: var(--text-muted) !important; opacity: 1 !important; }
#submission-modal .submission-form-input:focus, 
#submission-modal .submission-form-select:focus { 
    outline: none !important; 
    border-color: var(--primary-azure) !important; 
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 0 0 50px var(--background-secondary) !important; 
    background-color: var(--background-secondary) !important; 
}

#submission-modal .submission-form-input:read-only { 
    background-color: var(--background-dark) !important; 
    color: var(--text-muted) !important; 
    cursor: not-allowed !important; 
    border-style: dashed; 
}

#submission-modal .submission-form-select { 
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; 
    background-position: right 0.75rem center !important; 
    background-repeat: no-repeat !important; 
    background-size: 1.5em 1.5em !important; 
    padding-right: 2.5rem !important; 
}

/* --- D. HARDENED TEXT & LAYOUT STYLES (ISOLATED) --- */
#submission-modal h2 { color: var(--text-diamond) !important; }
#submission-modal p { color: var(--text-secondary) !important; }
#submission-modal fieldset { border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; position: relative; margin-top: 1rem; }
#submission-modal legend { padding: 0 0.5rem; margin-left: 0.5rem; font-size: 1.125rem; font-weight: 600; color: var(--primary-azure) !important; background: var(--background-light); position: relative; top: -0.5rem; display: inline-block; width: auto; }
#submission-modal label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-platinum) !important; }
#submission-modal .recommendation-box { margin-top: 1rem; padding: 1rem; background-color: rgba(245, 158, 11, 0.05); border-left: 4px solid var(--warning-color); border-radius: 0 0.5rem 0.5rem 0; }
#submission-modal .recommendation-box h4 { font-weight: 600; color: var(--warning-color) !important; }
#submission-modal .recommendation-box p { font-size: 0.875rem; color: var(--text-secondary) !important; margin-top: 0.25rem; }
#submission-modal .recommendation-box strong { color: var(--text-diamond) !important; font-weight: 600; }
#submission-modal #referral-error { color: var(--error-color) !important; }

/* --- E. KEYFRAME ANIMATIONS --- */
@keyframes submission-backdrop-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes submission-content-scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        <!-- ================================================================================================================== -->
<!-- === PINNACLE REPLACEMENT BLOCK: BEGINS HERE === -->
<!-- This block contains the new CSS, Modal HTML, and JavaScript Logic for the entire Document Execution Suite. -->
<!-- ================================================================================================================== -->

<!-- I. RE-ENGINEERED CSS FOR PREMIUM CONTRACT & PRINTING (ADD THIS WITHIN YOUR MAIN <style> TAG) -->
<style>
    /* ========================================================================= */
    /* === PINNACLE DOCUMENT EXECUTION SUITE CSS (v5.0 - UNABRIDGED) === */
    /* This is the definitive, self-contained style block that governs the */
    /* entire document generation, preview, and signing workflow. */
    /* ========================================================================= */

    /* --- A. PREMIUM MODAL DIALOGS (RE-ENGINEERED) --- */
    #imfpa-modal-content, #signature-modal-content, #finalization-modal-content {
        background: linear-gradient(170deg, var(--background-light) 0%, var(--background-primary) 100%) !important;
        border: 1px solid var(--border-premium) !important;
        box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6), 0 0 0 1px rgba(139, 92, 246, 0.2) !important;
        border-radius: 1.5rem !important;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #imfpa-modal .dialog-content-wrapper { max-width: 80vw; }
    #signature-modal .dialog-content-wrapper { max-width: 560px; }
    #finalization-modal .dialog-content-wrapper { max-width: 640px; }
    
    .imfpa-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-premium);
    }
    .imfpa-header h2 {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-family: 'Orbitron', monospace;
    }
    
    /* --- B. CONTRACT PREVIEW & EXECUTION SUITE (UNABRIDGED) --- */
    #contract-preview-container {
        animation: fadeInUp 0.5s ease-out;
    }

    #execution-suite {
        background: var(--background-glass);
        border: 1px solid var(--border-premium);
        border-radius: 1.5rem;
        padding: 1.5rem;
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    #execution-suite .step-panel {
        background: rgba(var(--rgb-color, 59, 130, 246), 0.1);
        border: 1px solid rgba(var(--rgb-color, 59, 130, 246), 0.2);
        border-left: 4px solid rgb(var(--rgb-color, 59, 130, 246));
        border-radius: 1rem;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    #execution-suite .step-panel.step-1 { --rgb-color: 59, 130, 246; /* Sapphire */ }
    #execution-suite .step-panel.step-2 { --rgb-color: 139, 92, 246; /* Amethyst */ }

    .step-panel h4 {
        color: rgb(var(--rgb-color));
        font-weight: 700;
        font-size: 1.125rem;
    }

    .step-panel p { color: var(--text-secondary); }

    .execution-btn {
        background: linear-gradient(135deg, rgb(var(--rgb-color)), rgba(var(--rgb-color), 0.7));
        border: 1px solid rgb(var(--rgb-color));
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(var(--rgb-color), 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        padding: 0.75rem 1.5rem;
        font-weight: 700;
        border-radius: 0.75rem;
    }
    .execution-btn:hover:not(:disabled) {
        box-shadow: 0 8px 30px rgba(var(--rgb-color), 0.4);
        transform: translateY(-3px);
    }

    /* --- C. GENERATED CONTRACT DOCUMENT (PINNACLE STANDARD) --- */
    #contract-document-wrapper {
        background: #f8fafc; /* Light background for contrast */
        border-radius: 1rem;
        padding: 1rem;
        margin-top: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }
    .contract-document {
        font-family: 'Garamond', 'Times New Roman', serif;
        font-size: 11pt;
        line-height: 1.5;
        color: #1a202c; /* Near-black for readability */
        background: white;
        padding: 2cm;
        margin: 0 auto;
        max-width: 21cm; /* A4 width */
        min-height: 29.7cm; /* A4 height */
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* --- D. SIGNATURE SUITE MODAL (SEVERELY UPGRADED) --- */
    #signature-modal-content { --glow-color: var(--success-color); }
    .signature-tab.active { border-color: var(--success-color); color: var(--text-diamond); }
    #signature-canvas {
        background: var(--background-dark);
        border: 1px dashed var(--border-premium);
        border-radius: 0.75rem;
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg>') 4 20, crosshair;
    }
    
    /* --- E. FINALIZATION MODAL (SECURE AESTHETIC) --- */
    #finalization-modal-content { --glow-color: var(--amethyst); }
    #finalization-icon-container {
        background: linear-gradient(135deg, var(--primary-amethyst), var(--primary-royal));
        animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
        50% { transform: scale(1.05); box-shadow: 0 0 35px var(--glow-amethyst); }
    }

    /* --- F. PINNACLE PRINTING STYLES (THE FIX) --- */
    #print-area { display: none; }
    @media print {
        .print-hide { display: none !important; }
        #print-area { display: block !important; }

        body, html {
            background: #fff !important;
            color: #000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        @page {
            size: A4;
            margin: 2cm;
            @top-left { content: var(--agreement-reference); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
            @top-right { content: "GECANâ„¢ | STRICTLY PRIVATE & CONFIDENTIAL"; font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
            @bottom-center { content: "Page " counter(page) " of " counter(pages); font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 8pt; color: #888; }
        }

        .p-doc { font-family: 'Garamond', 'Times New Roman', serif; font-size: 11pt; line-height: 1.4; color: #000; margin: 0; padding: 0; border: none; box-shadow: none; }
        .p-h1 { font-size: 18pt; font-weight: bold; color: #1A237E; border-bottom: 2px solid #b4975a; padding-bottom: 8pt; margin-bottom: 24pt; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .p-h2 { font-size: 14pt; font-weight: bold; color: #283593; border-bottom: 1px solid #ccc; padding-bottom: 4pt; margin-top: 20pt; margin-bottom: 12pt; font-family: 'Helvetica Neue', Arial, sans-serif; page-break-after: avoid; }
        .p-text { text-align: justify; margin-bottom: 11pt; }
        
        .p-table { width: 100%; border-collapse: collapse; margin-top: 12pt; margin-bottom: 16pt; page-break-inside: avoid; }
        .p-table th, .p-table td { border: 1px solid #ccc; padding: 6pt 8pt; text-align: left; vertical-align: top; font-size: 9pt; }
        .p-table th { background-color: #e8eaf6; color: #1A237E; font-weight: bold; font-family: 'Helvetica Neue', sans-serif; }
        .p-table tr:nth-child(even) td { background-color: #f9f9f9; }
        
        .p-signature-block { margin-top: 40pt; page-break-inside: avoid; display: block; }
        .p-signature-line { border-bottom: 1px solid #000; margin-top: 40pt; margin-bottom: 6pt; }
        .p-signature-label { font-size: 9pt; color: #555; }
        .p-signature-img { max-height: 60px; object-fit: contain; mix-blend-mode: darken; }
        .p-seal-img { max-height: 80px; max-width: 80px; object-fit: contain; position: absolute; right: 2cm; bottom: 2cm; opacity: 0.9; }

        .p-annex-start { page-break-before: always; }
        
        .p-watermark { display: block !important; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120pt; color: rgba(180, 151, 90, 0.08); font-weight: bold; z-index: -1000; pointer-events: none; font-family: 'Arial Black', sans-serif; }
    }
        
    </style>
</head>
<body class="min-h-screen">

    <div id="interactive-background"><div id="background-vortex"></div></div>
    <div id="particles-js" class="print-hide"></div>
    
    <!-- MOBILE SIDEBAR & FAB (BENCHMARKED) -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-[99] hidden backdrop-blur-sm transition-opacity duration-300 lg:hidden"></div>
    <div id="mobile-sidebar" class="fixed top-0 -left-full w-4/5 max-w-[320px] h-full bg-[var(--background-primary)] border-r border-[var(--border-premium)] shadow-2xl z-[100] transition-transform duration-300 ease-in-out flex flex-col lg:hidden">
        <div class="flex-shrink-0 p-4 border-b border-[var(--border-premium)] flex justify-between items-center">
            <div><h2 class="text-xl font-bold text-white">GECANâ„¢ Menu</h2><p class="text-xs text-gray-400 font-mono">Platform Navigation</p></div>
            <button id="mobile-sidebar-close-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="mobile-sidebar-content" class="flex-grow overflow-y-auto"></div>
    </div>
    <button id="mobile-fab" aria-label="Open Navigation Menu" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-[var(--primary-azure)] to-[var(--primary-amethyst)] rounded-full shadow-2xl z-40 hidden justify-center items-center text-white text-2xl transition-all duration-300 active:scale-90 lg:hidden">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- PREMIUM HEADER (BENCHMARKED & CORRECTED) -->
<header class="premium-header p-4 lg:px-6 print-hide">
    <div class="container mx-auto flex items-center justify-between gap-6">
        <div class="flex items-center gap-6 flex-shrink-0">
            <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                <div class="gecan-logo-flipper">
                    <div class="logo-face logo-front">GECANâ„¢</div>
                    <div class="logo-face logo-back">
                        <!-- Placeholder for Base64 image -->
                        <img src="" alt="GECAN Logo">
                    </div>
                </div>
                <div class="logo-separator"></div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">Intelligent Toolkits</h1>
                    <p class="text-sm text-gray-400 font-mono">Proprietary Analytics Suite</p>
                </div>
            </a>
        </div>
        <!-- DEFINITIVE FIX: The navigation placeholder is restored here -->
        <div id="desktop-nav-placeholder" class="flex-grow">
            <!-- Navigation will be dynamically injected by JavaScript -->
        </div>
    </div>
</header>

    <main class="container mx-auto p-4 md:p-8 flex-grow print-hide">
        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-80 flex-shrink-0 print-hide">
                <div class="glass rounded-2xl p-6 sticky top-28">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-primary-azure"></i>Available Toolkits</h3>
                    <div id="toolkit-menu" class="space-y-3"></div>
                </div>
            </aside>
            <div id="toolkit-content" class="flex-grow min-w-0">
                <div id="initial-loader" class="text-center py-20 animate-fade-in-up">
                    <div class="relative inline-block mb-6">
                        <div class="w-16 h-16 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Initializing GECAN Suite</h2>
                    <p class="text-text-secondary">Loading institutional-grade analytics...</p>
                </div>
                <div id="active-toolkit-container" class="hidden"></div>
            </div>
        </div>
    </main>
    
    <!-- MODAL & DIALOG CONTAINERS -->
    <dialog id="imfpa-modal" class="p-0 bg-transparent max-w-7xl w-full print-hide"></dialog>
    <!-- II. RE-ENGINEERED MODAL HTML CONTAINERS (ADD THESE TO YOUR MAIN HTML BODY) -->
<dialog id="signature-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="signature-modal-content" class="text-white flex-grow flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-[var(--border-premium)] flex-shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-300 to-green-500">Document Execution Suite</h2>
                        <p class="text-sm text-text-secondary">Apply a legally binding signature and/or corporate seal.</p>
                    </div>
                    <button onclick="document.getElementById('signature-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">Ã—</button>
                </div>
                <div>
                    <label for="signature-target-select" class="block text-sm font-semibold text-text-secondary mb-2">Apply signature/seal for:</label>
                    <select id="signature-target-select" class="form-select w-full"></select>
                </div>
            </div>

            <!-- Signing Area -->
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex border-b border-[var(--border-premium)] mb-4">
                    <button id="draw-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('draw')">Draw Signature</button>
                    <button id="upload-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('upload')">Upload Signature</button>
                    <button id="seal-tab-btn" class="flex-1 p-3 text-sm font-semibold border-b-2 border-transparent signature-tab" onclick="Logic.switchSignatureMode('seal')">Upload Corporate Seal</button>
                </div>
                <!-- Panels -->
                <div id="draw-mode-panel"><canvas id="signature-canvas" class="w-full h-48"></canvas><button onclick="Logic.clearSignaturePad()" class="text-xs text-text-muted hover:text-white mt-2">Clear</button></div>
                <div id="upload-mode-panel" class="hidden"><input type="file" id="signature-upload-input" accept="image/*" class="hidden"><label for="signature-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="signature-upload-preview" class="hidden max-h-44 object-contain"/><div id="upload-prompt"><i class="fas fa-upload fa-2x text-text-muted mb-2"></i><p>Click to upload signature</p></div></label></div>
                <div id="seal-mode-panel" class="hidden"><input type="file" id="seal-upload-input" accept="image/*" class="hidden"><label for="seal-upload-input" class="w-full h-48 border-2 border-dashed border-[var(--border-premium)] rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[var(--background-secondary)] transition-colors"><img id="seal-upload-preview" class="hidden max-h-44 object-contain"/><div id="seal-prompt"><i class="fas fa-stamp fa-2x text-text-muted mb-2"></i><p>Click to import corporate seal</p></div></label></div>
            </div>
            
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex-shrink-0">
                <div class="text-xs text-text-muted mb-4"><p>By signing, you affirm all details are correct. A secure, tamper-proof record will be generated.</p><p class="font-mono mt-1"><strong>Timestamp:</strong> <span id="signature-timestamp"></span> | <strong>Location:</strong> <span id="signature-location"></span></p></div>
                <button onclick="Logic.applySignature()" class="btn-primary w-full py-3 font-bold bg-gradient-to-r from-green-500 to-green-700 border-green-500"><i class="fas fa-check-circle mr-2"></i>Apply to Document</button>
            </div>
        </div>
    </div>
</dialog>

    
    <!-- ==================================================================================== -->
<!-- === DEFINITIVE NOTIFICATION MODAL (v5.1 - UNIVERSAL REPLACEMENT) === -->
<!-- This is the complete, benchmark-standard modal required for all platform notifications. -->
<!-- ==================================================================================== -->
<dialog id="notification-modal" class="p-0 bg-transparent max-w-lg w-full print-hide">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="notification-modal-content" class="text-white flex flex-col">
            <!-- Dynamic Header: Color changes based on message type -->
            <div id="notification-header" class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)]">
                <div id="notification-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400">
                    <i id="notification-icon" class="fas fa-2x"></i>
                </div>
                <div>
                    <h2 id="notification-title" class="text-2xl font-bold">Notification</h2>
                    <p id="notification-subtitle" class="text-sm text-text-secondary">Please review this message.</p>
                </div>
            </div>

            <!-- Dynamic Content -->
            <div class="p-8 flex-grow">
                <p id="notification-message" class="text-text-secondary leading-relaxed">Message content goes here.</p>
            </div>
            
            <!-- Footer & Action -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end">
                <button id="notification-ok-btn" class="btn-primary px-8 py-2 font-bold shadow-lg">OK</button>
            </div>
        </div>
    </div>
</dialog>
   
    
    <dialog id="finalization-modal">
    <div class="dialog-content-wrapper" style="width:100%;">
        <div id="finalization-modal-content" class="flex flex-col text-white">
             <!-- Header -->
            <div class="p-6 flex items-center gap-4 border-b border-[var(--border-premium)] bg-[var(--background-dark)]/50">
                <div id="finalization-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt fa-2x"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Finalize & Lock Document</h2>
                    <p class="text-sm text-text-secondary">Please confirm this critical, irreversible action.</p>
                </div>
                 <button onclick="document.getElementById('finalization-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors ml-auto">Ã—</button>
            </div>
            <!-- Content -->
            <div class="p-8 flex-grow">
                <p class="text-text-secondary mb-5">You are about to initiate the final, legally binding workflow. This action will:</p>
                <ul class="space-y-4 text-text-primary">
                    <li class="flex items-start gap-3"><i class="fas fa-lock text-purple-400 mt-1"></i><div><strong>Lock Document State:</strong> The current version will be cryptographically fingerprinted to prevent edits.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-project-diagram text-purple-400 mt-1"></i><div><strong>Generate Secure Audit Trail:</strong> An immutable record will be created for all actions.</div></li>
                    <li class="flex items-start gap-3"><i class="fas fa-paper-plane text-purple-400 mt-1"></i><div><strong>Dispatch to All Parties:</strong> A finalized PDF will be emailed to all signatories.</div></li>
                </ul>
            </div>
            <!-- Footer -->
            <div class="p-6 border-t border-[var(--border-premium)] bg-[var(--background-dark)]/50 flex justify-end items-center gap-4">
                <button onclick="document.getElementById('finalization-modal').close()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button id="proceed-finalize-btn" onclick="Logic.executeFinalizationWorkflow()" class="btn-primary bg-gradient-to-r from-purple-600 to-red-600 border-purple-500 hover:shadow-red-500/30 px-8 py-2 font-bold shadow-lg shadow-purple-500/20"><i class="fas fa-gavel mr-2"></i>Proceed with Finalization</button>
            </div>
        </div>
    </div>
</dialog>

    <!-- This is a hidden div used to stage the final, clean HTML for printing -->
<div id="print-area"></div>

    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FIX: RESTORE THE SUBMISSION MODAL CONTAINER === -->
    <!-- This is the container the JavaScript is trying to open. -->
    <!-- ========================================================================= -->
    <dialog id="submission-modal"></dialog>
    
    <!-- PREMIUM FOOTER (BENCHMARKED) -->
    <footer class="mt-auto pt-16 print-hide">
        <div class="container mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-[var(--text-silver)]">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECANâ„¢</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-gray-500">Â© 2025 GECANâ„¢. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECANâ„¢ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECANâ„¢ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ====================================================================================
        // === PINNACLE SCRIPT ENGINE v4.0 (BENCHMARKED, RE-ARCHITECTED, & UNABRIDGED) ===
        // This engine is the definitive, production-grade standard for the Toolkits page.
        // ====================================================================================
        
        const API_URL = "https://script.google.com/macros/s/AKfycby_U6tBwtdj4Sud-t94FFgTmb8YwNRyS3VJeHJIoZ3KEkhR9EfM8I3NuS0CYLsCWjzX/exec";
        
        // ====================================================================================
        // === SECTION 1: STATE & MODELS (v4.0 - DEFINITIVE & SEVERELY ENHANCED) ===
        // ====================================================================================
        const AppState = {
            isInitialized: false, 
            activeToolkit: 'Dashboard', 
            marketData: [],

            toolkits: {
                Dashboard: { id: 'Dashboard', name: 'Dashboard', icon: 'fa-th-large', description: 'Centralized hub for accessing all GECANâ„¢ proprietary institutional tools.', color: 'from-blue-500 to-purple-600' },
                WalletForensics: { id: 'WalletForensics', name: 'Wallet Forensics', icon: 'fa-shield-alt', description: 'Execute advanced on-chain due diligence, risk assessment, and provenance analysis.', color: 'from-sky-500 to-indigo-600' },
                InstitutionalModeler: { id: 'InstitutionalModeler', name: 'Institutional Modeler Suite', icon: 'fa-sitemap', description: 'Model, simulate, and generate legal frameworks for complex institutional transactions.', color: 'from-green-500 to-emerald-600' },
            },
            walletAnalysis: { address: null, report: null, isLoading: false },
            modeler: {
                activeDealType: 'AssetSwap', 
                assetSwap: { amount: 1000000, fromAssetKey: '', toAssetKey: '' },
                commodityTrade: { assetKey: 'WTI-BBL-USD', quantity: 100000, unitOfMeasure: 'Barrel', qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%', origin: 'USA', port: 'Houston', incoterms: 'FOB', procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC', pricingModel: 'Discount', fixedPrice: 0, discountPremiumValue: 4, discountPremiumIsInPercent: true, settlementAssetKey: 'USD' },
                cryptoLoan: { collateralAssetKey: 'BTC-USD', collateralAmount: 10, loanCurrency: 'USD', ltv: 60, interestRateType: 'fixed', interestRateValue: 5.5, tenureMonths: 12 },
                sblcMonetization: { faceValue: 100000000, ltv: 80 },
                pricingConfig: { isVisible: false, offerType: 'discount', grossValue: 0, netValue: 0, isValueInPercent: true },
                legal: { totalCommission: 0, jurisdiction: 'Singapore, Dubai, England, Wales', spaReferenceCode: '', groups: [] }
            }
        };

        const commodityData = {
            unitsOfMeasure: ['Barrel', 'Metric Ton', 'Troy Ounce', 'Kilogram', 'Pound', 'Gallon', 'Liter', 'Cubic Meter', 'Short Ton', 'Long Ton', 'Tonne', 'MMBtu', 'Bushel'].sort(),
            incoterms: [
                { value: 'EXW', label: 'EXW - Ex Works', port: 'Seller\'s Premises', risk: 'Buyer', cost: 'Minimal' }, { value: 'FCA', label: 'FCA - Free Carrier', port: 'Named Place', risk: 'Buyer', cost: 'Low' },
                { value: 'FOB', label: 'FOB - Free on Board', port: 'Port of Loading', risk: 'Buyer', cost: 'Low' }, { value: 'CFR', label: 'CFR - Cost & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'Medium' },
                { value: 'CIF', label: 'CIF - Cost, Insurance & Freight', port: 'Port of Destination', risk: 'Seller', cost: 'High' }, { value: 'DPU', label: 'DPU - Delivered at Place Unloaded', port: 'Named Place', risk: 'Seller', cost: 'Very High' },
                { value: 'DDP', label: 'DDP - Delivered Duty Paid', port: 'Buyer\'s Premises', risk: 'Seller', cost: 'Maximum' }
            ],
            countries: ['USA', 'Saudi Arabia', 'Russia', 'Canada', 'China', 'Brazil', 'UAE', 'Nigeria', 'Netherlands', 'Singapore', 'UK', 'Qatar', 'Australia'].sort(),
            ports: ['Shanghai', 'Singapore', 'Hong Kong', 'Rotterdam', 'Los Angeles', 'Houston', 'Jebel Ali', 'Fujairah', 'Ras Tanura'].sort()
        };

        // ====================================================================================
        // === SECTION 2: UTILITIES (v4.0 - DEFINITIVE & BENCHMARKED) ===
        // ====================================================================================
        const Utils = {
            showNotification: (message, type = 'info', title = null) => {
    const modal = document.getElementById('notification-modal');
    if (!modal) {
        console.error("Notification modal not found in DOM!");
        // Fallback for critical errors when the modal itself is missing.
        alert(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
        return;
    }

    const content = document.getElementById('notification-modal-content');
    const header = document.getElementById('notification-header');
    const iconContainer = document.getElementById('notification-icon-container');
    const icon = document.getElementById('notification-icon');
    const titleEl = document.getElementById('notification-title');
    const subtitleEl = document.getElementById('notification-subtitle');
    const messageEl = document.getElementById('notification-message');
    const okBtn = document.getElementById('notification-ok-btn');

    // A single source of truth for notification types.
    const types = {
        success: { iconClass: 'fa-check-circle', defaultTitle: 'Success', subtitle: 'The operation completed successfully.', baseClass: 'green' },
        error: { iconClass: 'fa-exclamation-triangle', defaultTitle: 'Error', subtitle: 'An error has occurred.', baseClass: 'red' },
        warning: { iconClass: 'fa-exclamation-circle', defaultTitle: 'Warning', subtitle: 'Please review this message.', baseClass: 'yellow' },
        info: { iconClass: 'fa-info-circle', defaultTitle: 'Information', subtitle: 'System Notification.', baseClass: 'blue' }
    };

    const config = types[type] || types.info;

    // Apply dynamic content
    titleEl.textContent = title || config.defaultTitle;
    subtitleEl.textContent = config.subtitle;
    messageEl.textContent = message;
    icon.className = `fas ${config.iconClass} fa-2x`;

    // Apply dynamic styling using Tailwind classes for consistency and maintainability.
    const colorClasses = {
        header: `bg-${config.baseClass}-500/10 border-${config.baseClass}-500/20`,
        icon: `bg-gradient-to-br from-${config.baseClass}-400 to-${config.baseClass}-600`,
        button: `bg-gradient-to-r from-${config.baseClass}-500 to-${config.baseClass}-700 border-${config.baseClass}-500`
    };

    // Remove old color classes before adding new ones
    header.className = `p-6 flex items-center gap-4 border-b ${colorClasses.header}`;
    iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-400 ${colorClasses.icon}`;
    okBtn.className = `btn-primary px-8 py-2 font-bold shadow-lg ${colorClasses.button}`;
    
    // Attach a one-time event listener to the OK button to close the modal.
    okBtn.onclick = () => modal.close();
    
    // Show the modal.
    if (!modal.hasAttribute('open')) {
        modal.showModal();
    }
},
            formatPrice: (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0),
            formatNumber: (num, decimals = 2) => {
                if (typeof num !== 'number' || isNaN(num)) return 'N/A';
                if (Math.abs(num) >= 1e12) return (num / 1e12).toFixed(decimals) + 'T'; if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(decimals) + 'B';
                if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
                return (num || 0).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            },
            debounce: (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; },
            getAssetByKey: (key) => AppState.marketData.find(a => a.key === key) || { price: 0, baseAsset: 'N/A', quoteAsset: 'N/A', key, type: 'Unknown' },
            getRiskClass: (level) => `risk-${level || 'MEDIUM'}`,
            getRiskIcon: (level) => ({ LOW: 'fa-check-circle', MEDIUM: 'fa-exclamation-circle', HIGH: 'fa-exclamation-triangle', CRITICAL: 'fa-skull-crossbones' }[level] || 'fa-question-circle'),
            calculateTimeAgo: (timestamp) => {
                const diffMs = new Date() - new Date(timestamp); const diffMins = Math.floor(diffMs / 60000);
                if (diffMins < 1) return 'Just now'; if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMs / 3600000); if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffMs / 86400000); if (diffDays < 30) return `${diffDays}d ago`;
                return new Date(timestamp).toLocaleDateString();
            }
        };

        // ====================================================================================
        // === SECTION 3: CORE LOGIC CONTROLLER (v4.0 - DEFINITIVE & UNABRIDGED) ===
        // ====================================================================================
        const Logic = {
            createApiRequest: async (action, method = 'GET', params = {}) => {
                const url = new URL(API_URL); url.searchParams.append('action', action);
                const options = { method: method.toUpperCase(), redirect: 'follow' };
                if (options.method === 'GET') { Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v)); } 
                else { options.body = JSON.stringify({ action, data: params }); options.headers = { 'Content-Type': 'text/plain;charset=utf-8' }; }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                    const result = await response.json();
                    if (result.success === false) throw new Error(result.error || 'Server error.');
                    return result.data || result.message || result;
                } catch (error) { console.error(`API Error for '${action}':`, error); throw error; }
            },

            init: async () => {
    UI.init();
    // DEFINITIVE FIX: Restore the call to populate navigation links on page load.
    UI.populateNavLinks(); 
    Logic.initMobileUI();
    Logic.setupEventListeners();
    try {
        const [marketData, themeJson] = await Promise.all([
            Logic.createApiRequest('getMarketMatrixData'),
            Logic.createApiRequest('getActiveThemeConfig').catch(() => null)
        ]);
        if (themeJson) { try { UI.renderParticles(JSON.parse(themeJson)); } catch (e) {} }
        if (!marketData || !Array.isArray(marketData)) throw new Error("Market data invalid.");
        AppState.marketData = marketData.filter(a => a.status === 'OK' || a.status === 'MANUAL').map(a => ({ ...a, price: parseFloat(a.price) || 0 }));
        const swappable = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
        if (swappable.length >= 2) { AppState.modeler.assetSwap.fromAssetKey = swappable[0].key; AppState.modeler.assetSwap.toAssetKey = swappable[1].key; }
        
        AppState.isInitialized = true;
        document.getElementById('initial-loader').style.display = 'none';
        UI.renderActiveToolkit();
    } catch (err) { Logic.onDataError(err); }
},
            onDataError: (error) => {
                console.error("CRITICAL FAILURE:", error);
                Utils.showNotification(`Failed to load critical platform data: ${error.message}.`, 'error', 'Platform Initialization Error');
                document.getElementById('initial-loader').innerHTML = `<div class="text-center text-red-400">Platform Initialization Failed.</div>`;
            },
            initMobileUI: () => {
    const fab = document.getElementById('mobile-fab'), 
          sidebar = document.getElementById('mobile-sidebar'), 
          overlay = document.getElementById('mobile-sidebar-overlay'), 
          closeBtn = document.getElementById('mobile-sidebar-close-btn');
          
    const openSidebar = () => { 
        // DEFINITIVE FIX: Ensure nav links are populated every time the mobile menu is opened.
        UI.populateNavLinks(); 
        sidebar.classList.remove('-left-full'); 
        sidebar.classList.add('left-0'); 
        overlay.classList.remove('hidden'); 
        document.body.classList.add('mobile-sidebar-open'); 
    };
    const closeSidebar = () => { 
        sidebar.classList.add('-left-full'); 
        sidebar.classList.remove('left-0'); 
        overlay.classList.add('hidden'); 
        document.body.classList.remove('mobile-sidebar-open'); 
    };
    
    fab.addEventListener('click', openSidebar); 
    overlay.addEventListener('click', closeSidebar); 
    closeBtn.addEventListener('click', closeSidebar);
},
            setupEventListeners: () => {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) { const keyMap = {'1':'Dashboard','2':'WalletForensics','3':'InstitutionalModeler'}; if(keyMap[e.key]) { e.preventDefault(); Logic.setActiveToolkit(keyMap[e.key]); } }
                });
            },
            setActiveToolkit: (id) => { if (AppState.activeToolkit === id && AppState.isInitialized) return; AppState.activeToolkit = id; UI.renderActiveToolkit(); },
            bindActiveToolkitEvents: () => { const binder = Logic[`bind${AppState.activeToolkit}Events`]; if (binder) binder(); },
            
            // --- Wallet Forensics Logic (Unabridged) ---
            // --- Wallet Forensics Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Wallet Forensics toolkit.
 * This function is called once when the toolkit becomes active.
 */
bindWalletForensicsEvents: () => {
    const checkBtn = document.getElementById('check-wallet-btn');
    const addressInput = document.getElementById('wallet-address-input');
    
    // Robustness: Ensure elements exist before binding to prevent runtime errors.
    if(checkBtn) {
        checkBtn.addEventListener('click', Logic.runWalletForensics);
    }
    if(addressInput) {
        addressInput.addEventListener('keypress', e => { 
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission if it's inside a form
                Logic.runWalletForensics(); 
            }
        });
    }
},

/**
 * Orchestrates the entire wallet analysis process, from user input to displaying the final report.
 * It manages application state, provides premium loading feedback, and handles all API communication.
 */
runWalletForensics: () => {
    const addressInput = document.getElementById('wallet-address-input');
    if (!addressInput) return; // Safeguard
    
    const address = addressInput.value.trim();
    if (!address) {
        return Utils.showNotification("Please enter a wallet address to analyze.", 'warning', 'Input Required');
    }
    
    // 1. Set application state to loading and trigger a UI re-render.
    AppState.walletAnalysis = { address, report: null, isLoading: true };
    UI.renderActiveToolkit();

    // 2. Initialize the premium, multi-stage loading text spinner.
    const spinnerTexts = [
        "Connecting to blockchain networks...", 
        "Fetching on-chain transaction history...", 
        "Querying GECAN proprietary intelligence ledger...", 
        "Running institutional compliance checks...", 
        "Synthesizing on-chain and proprietary intel...", 
        "Calculating multi-vector risk scores...", 
        "Generating definitive wallet classification..."
    ];
    let textIndex = 0;
    
    // This interval provides dynamic feedback to the user during the analysis process.
    const textInterval = setInterval(() => {
        const spinnerEl = document.getElementById('spinner-text');
        // The interval only updates the text if the spinner is still visible and the app is loading.
        if (spinnerEl && AppState.walletAnalysis.isLoading) {
            spinnerEl.style.opacity = '0';
            setTimeout(() => { 
                spinnerEl.textContent = spinnerTexts[textIndex++ % spinnerTexts.length]; 
                spinnerEl.style.opacity = '1';
            }, 300); // Wait for fade-out before changing text and fading in.
        } else {
            clearInterval(textInterval); // Stop the interval if loading is complete.
        }
    }, 2500);

    // 3. Execute the API request to the backend.
    Logic.createApiRequest('getWalletForensicsReport', 'GET', { address })
        .then(report => {
            // On success, update the state with the complete report.
            AppState.walletAnalysis.report = report;
        })
        .catch(err => {
            // On failure, create a structured error object in the state.
            AppState.walletAnalysis.report = { 
                success: false, 
                error: { message: err.message || 'An unknown analysis error occurred.' } 
            };
        })
        .finally(() => {
            // This block runs regardless of success or failure.
            AppState.walletAnalysis.isLoading = false;
            clearInterval(textInterval); // CRITICAL: Ensure the interval is always cleared.
            UI.renderActiveToolkit(); // Re-render the UI to display the report or error message.
            
            // If the report is successful, trigger the animations for the score gauges.
            if (AppState.walletAnalysis.report && AppState.walletAnalysis.report.success) {
                Logic.animateReportElements();
            }
        });
},

/**
 * Triggers the CSS animation for the SVG score gauges after they are rendered.
 */
animateReportElements: () => {
    // A short delay ensures elements are fully in the DOM before animation starts.
    setTimeout(() => {
        document.querySelectorAll('.score-gauge-fg').forEach(gauge => {
            if (gauge.dataset.score) {
                gauge.style.strokeDasharray = `${gauge.dataset.score}, 100`;
            }
        });
    }, 200);
},

/**
 * Generates the correct block explorer URL for a given wallet type and address/transaction.
 * @param {object} wallet - The wallet object from the report, containing address and type.
 * @param {string} [txHash=''] - An optional transaction hash.
 * @returns {string} The full URL to the block explorer.
 */
getExplorerUrl: (wallet, txHash = '') => {
    if (!wallet || !wallet.type) return '#';
    
    const explorers = {
        BITCOIN: { addr: 'https://www.blockchain.com/btc/address/', tx: 'https://www.blockchain.com/btc/tx/' },
        ETHEREUM: { addr: 'https://etherscan.io/address/', tx: 'https://etherscan.io/tx/' },
        TRON: { addr: 'https://tronscan.org/#/address/', tx: 'https://tronscan.org/#/transaction/' }
    };

    const explorer = explorers[wallet.type.toUpperCase()];
    if (!explorer) return '#'; // Fallback for unknown types.

    return txHash ? explorer.tx + txHash : explorer.addr + wallet.address;
},

/**
 * Copies text to the user's clipboard and provides instant visual feedback.
 * @param {string} text - The text to copy.
 * @param {HTMLElement} element - The button element that was clicked, used to find the feedback span.
 */
copyToClipboard: (text, element) => {
    navigator.clipboard.writeText(text).then(() => {
        const feedback = element.querySelector('.copied-feedback');
        if (feedback) {
            feedback.style.opacity = '1';
            setTimeout(() => { feedback.style.opacity = '0'; }, 1500);
        }
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        Utils.showNotification('Could not copy to clipboard.', 'error');
    });
},

/**
 * Generates a dynamic, human-readable executive summary from the raw report data.
 * This is the definitive, pinnacle-grade implementation.
 * @param {object} report - The full report object from the backend.
 * @returns {string} An HTML string containing the formatted summary.
 */
generateExecutiveSummary: (report) => {
    if (!report || !report.analysis || !report.wallet) {
        return '<p class="text-error-color">Could not generate summary due to incomplete report data.</p>';
    }

    const { analysis, wallet, provenance } = report;
    let summary = `This ${wallet.type} wallet, active for <strong>${wallet.ageInDays} days</strong>, presents a <strong class="${Utils.getRiskClass(analysis.riskLevel)} text-risk-color">${analysis.riskLevel}</strong> risk profile with an integrity score of <strong>${analysis.integrityScore}/100</strong>. `;
    
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN' && c.toUpperCase() !== 'CONFIDENTIAL'))];

    if (provenance.records && provenance.records.length > 0) {
        summary += `It is documented in the GECAN Ledger <strong>${provenance.records.length} time(s)</strong>. `;
        if (uniqueControllers.length > 1) {
            summary += `<strong class="text-critical-color">Critically, it has ${uniqueControllers.length} conflicting alleged controllers: ${uniqueControllers.slice(0, 2).join(', ')}${uniqueControllers.length > 2 ? '...' : ''}.</strong> `;
        } else if (uniqueControllers.length === 1) {
            summary += `A single controller, <strong>${uniqueControllers[0]}</strong>, is consistently reported. `;
        } else {
            summary += `However, no specific controller name is consistently recorded. `;
        }
    } else {
        summary += `There is <strong class="text-error-color">no provenance history</strong> in the GECAN Ledger, making ownership unverifiable. `;
    }

    if (analysis.redFlags && analysis.redFlags.length > 0) {
        const criticalFlagsCount = analysis.redFlags.filter(f => f.level === 'CRITICAL').length;
        if (criticalFlagsCount > 0) {
            summary += `The analysis identified <strong class="text-critical-color">${criticalFlagsCount} CRITICAL flag(s)</strong> requiring immediate attention. `;
        } else {
            summary += `The analysis identified <strong class="text-warning-color">${analysis.redFlags.length} minor flag(s)</strong>. `;
        }
    } else {
        summary += `<strong class="text-success-color">No major compliance flags</strong> were detected during on-chain analysis. `;
    }

    const isCompliant = analysis.redFlags.every(flag => flag.category !== 'INSTITUTIONAL');
    if (wallet.type !== 'BITCOIN') {
        summary += isCompliant
            ? `The wallet <strong class="text-success-color">meets</strong> the GECAN institutional requirements for balance and transaction history. `
            : `The wallet <strong class="text-error-color">does not meet</strong> GECAN institutional requirements. `;
    }
    
    summary += `Final recommendation is to proceed with ${analysis.riskLevel === 'LOW' ? 'standard due diligence' : '<strong>enhanced caution and verification</strong>'}.`;
    return summary;
},

            /**
     * [NEW & SEVERELY UPGRADED] Handles the premium PDF generation and download workflow.
     */
    generateAndDownloadForensicsPDF: () => {
        const btn = document.getElementById('pdf-export-btn');
        if (!btn || btn.disabled) return;

        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generating...`;

        const reportData = AppState.walletAnalysis.report;
        if (!reportData || !reportData.success) {
            Utils.showNotification('Error: Could not find valid report data to generate PDF.', 'error');
            btn.disabled = false; btn.innerHTML = originalContent;
            return;
        }

        Logic.createApiRequest('generateWalletForensicsPdf', 'POST', { report: reportData })
            .then(Logic.downloadPdf)
            .catch(error => Utils.showNotification(error.message || 'PDF generation failed.', 'error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    },

    /**
     * [NEW & BENCHMARKED] Helper function to trigger a browser download from Base64 data.
     */
    downloadPdf: (response) => {
        if (!response || !response.pdfData) {
            throw new Error('Failed to receive valid PDF data from server.');
        }
        const link = document.createElement('a');
        link.href = `data:application/pdf;base64,${response.pdfData}`;
        link.download = response.fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        Utils.showNotification('Report downloaded successfully!', 'success');
    },

    /**
     * [NEW & BENCHMARKED] Initiates the first step of the official submission process: the referral ID modal.
     */
    initiateWalletSubmission: () => {
    // Target the correct modal ID. This ID must exist in your HTML body.
    const modal = document.getElementById('submission-modal');
    if (!modal) {
        console.error("CRITICAL FAILURE: The #submission-modal container is missing from the HTML body.");
        Utils.showNotification("UI Error: Cannot open submission suite.", "error");
        return;
    }
    
    // Render the first step (Referral Validation) into the modal.
    modal.innerHTML = UI.renderReferralValidationSuite(
        'Secure Submission Protocol', 
        'A valid Partner Referral ID is required to submit this wallet to the GECAN ledger for official review.'
    );
    
    // Show the modal.
    modal.showModal();
    
    // Attach the event listener to the "Validate" button inside the newly rendered modal.
    document.getElementById('validate-referral-btn').addEventListener('click', Logic.validateSubmissionReferralId);
},


    /**
     * [NEW & BENCHMARKED] Validates the entered referral ID. On success, transitions to the full engagement suite.
     */
    validateSubmissionReferralId: () => {
    const btn = document.getElementById('validate-referral-btn');
    const input = document.getElementById('referral-id-input');
    const errorDiv = document.getElementById('referral-error');
    if (!btn || !input || !errorDiv) return;

    const referralId = input.value.trim();
    if (!referralId) {
        errorDiv.textContent = 'Referral ID cannot be empty.';
        errorDiv.classList.remove('hidden');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';
    Utils.showNotification('Validating Referral ID with GECAN servers...', 'info');

    Logic.createApiRequest('validateReferralId', 'POST', { referralId })
        .then(validationResult => {
            if (validationResult.isValid) {
                Utils.showNotification('Referral ID Validated Successfully!', 'success');
                const modal = document.getElementById('submission-modal');
                // On success, render the full submission suite inside the same modal.
                modal.innerHTML = UI.renderWalletSubmissionSuite(validationResult);
                Logic.populateOfferIdDropdown();
                document.getElementById('wallet-submission-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    Logic.submitWalletForReview(validationResult);
                });
            } else {
                throw new Error('Invalid or inactive Referral ID. Please check the code and try again.');
            }
        })
        .catch(error => {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key mr-2"></i>Validate & Proceed';
        });
},

            /**
     * [NEW] Fetches the list of active offers and populates the dropdown in the submission form.
     */
    populateOfferIdDropdown: async () => {
        const select = document.getElementById('submission-offer-id');
        if (!select) return;
        try {
            const offers = await Logic.createApiRequest('getOfferListForNcnda', 'GET');
            select.innerHTML = '<option value="GENERAL">General Submission (Not for a specific offer)</option>' +
                offers.map(offer => `<option value="${offer.offerId}">${offer.offerId} - ${offer.description}</option>`).join('');
        } catch (error) {
            console.error("Failed to fetch offer list for submission form:", error);
            select.innerHTML = '<option value="">Error loading offers</option>';
        }
    },
    

    /**
     * [NEW & BENCHMARKED] Gathers all submission form data and sends it to the backend.
     */
    submitWalletForReview: (referralInfo) => {
    const submitBtn = document.getElementById('confirm-submission-btn');
    if (!submitBtn) return;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting to GECAN Compliance...';

    // 1. Gather all data from the detailed form.
    const submissionData = {
        report: AppState.walletAnalysis.report, // Attach the full forensics report.
        referralInfo: referralInfo,
        targetOfferId: document.getElementById('submission-offer-id').value,
        submitter: {
            name: document.getElementById('submitter-name').value,
            role: document.getElementById('submitter-role').value,
            email: document.getElementById('submitter-email').value,
            phone: document.getElementById('submitter-phone').value,
        },
        controller: {
            name: document.getElementById('controller-name').value,
        },
        // In a future version, you could add file processing logic here.
    };

    // 2. DEFINITIVE FIX: Call the new backend API endpoint.
    Logic.createApiRequest('submitWalletForReview', 'POST', submissionData)
        .then(successMessage => {
            // On success, show the confirmation from the server and close the modal.
            Utils.showNotification(successMessage, 'success', 'Submission Sent');
            document.getElementById('submission-modal').close();
        })
        .catch(error => {
            // On failure, show a detailed error message.
            Utils.showNotification(error.message, 'error', 'Submission Failed');
        })
        .finally(() => {
            // Always re-enable the button, regardless of outcome.
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm & Submit to Ledger';
        });
},
            
            // --- Institutional Modeler Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Binds all necessary event listeners for the Institutional Modeler toolkit.
 * This function is called once when the toolkit becomes active, using efficient
 * event delegation on the main input container to handle all dynamic changes.
 */
bindInstitutionalModelerEvents: () => {
    Logic.updateModelerUI(true);
    const inputContainer = document.getElementById('modeler-input-container');
    if (inputContainer) {
        inputContainer.addEventListener('input', Utils.debounce((e) => {
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        }, 250));
        inputContainer.addEventListener('change', (e) => { // For selects and radios
            if (e.target.matches('[data-path]')) Logic.handleModelerInputChange(e);
        });
    }
},

/**
 * Handles the logic for switching between different deal types (e.g., Asset Swap, Commodity Trade).
 * It updates the application state and triggers a full re-render of the toolkit UI.
 * @param {string} newDealType - The ID of the toolkit to activate (e.g., 'AssetSwap').
 */
handleDealTypeChange: (newDealType) => {
    if (AppState.modeler.activeDealType === newDealType) return;
    AppState.modeler.activeDealType = newDealType;
    UI.renderActiveToolkit();
},

/**
 * Master handler for all user input within the modeler. It uses a `data-path`
 * attribute on form elements to dynamically and safely update the nested `AppState.modeler` object.
 * @param {Event} e - The input or change event object.
 */
handleModelerInputChange: (e) => {
    const { dataset, value, type, checked } = e.target;
    const path = dataset.path;
    if (!path) return;

    if (path === 'commodityTrade.assetKey') {
        Logic.handleCommodityChange(value);
        return;
    }

    try {
        const pathKeys = path.split(/[\.\[\]]+/).filter(Boolean);
        let targetObject = AppState.modeler;
        for (let i = 0; i < pathKeys.length - 1; i++) {
            targetObject = targetObject[pathKeys[i]];
        }
        const finalKey = pathKeys[pathKeys.length - 1];
        let processedValue = (type === 'checkbox') ? checked : (typeof targetObject[finalKey] === 'boolean') ? (value === 'true') : (type === 'number' || type === 'range' || typeof targetObject[finalKey] === 'number') ? parseFloat(value.replace(/,/g, '')) || 0 : value;
        targetObject[finalKey] = processedValue;
        Logic.updateModelerUI(false);
    } catch (error) {
        console.error(`Failed to update modeler state for path: ${path}`, error);
        Utils.showNotification("An internal error occurred while updating the model.", 'error');
    }
},

/**
 * A specialized handler that triggers when the main commodity asset is changed.
 * It intelligently updates related fields like 'Unit of Measure' to maintain data consistency.
 * @param {string} assetKey - The new commodity asset key (e.g., 'WTI-BBL-USD').
 */
handleCommodityChange: (assetKey) => {
    const commodityState = AppState.modeler.commodityTrade;
    commodityState.assetKey = assetKey;
    const spec = commodityData.specifications[assetKey];
    if (spec) {
        commodityState.unitOfMeasure = spec.uom;
        commodityState.qualitySpec = spec.spec;
        commodityState.incoterms = spec.incoterm;
        commodityState.origin = spec.origin;
    }
    Logic.updateModelerUI(true);
},

/**
 * Placeholder for launching a future deep-dive analysis suite. For now, it provides
 * a premium, user-friendly notification about the feature's status.
 */
launchInstitutionalAnalysis: () => {
    Utils.showNotification(
        `The full Institutional Analysis Suite is in development. This panel will provide deep-dive analytics, counterparty risk assessment, and regulatory compliance checklists for the structured deal.`,
        'info',
        'Feature Coming Soon'
    );
},
            /**
 * Updates the Institutional Modeler's UI. Can perform a full refresh of the input panel
 * or a more performant partial refresh of only the output panel.
 * @param {boolean} [isFullRefresh=false] - If true, re-renders the entire input panel.
 */
updateModelerUI: (isFullRefresh = false) => {
    if (isFullRefresh) {
        const inputContainer = document.getElementById('modeler-input-container');
        if (inputContainer) inputContainer.innerHTML = UI.renderModelerInputPanel();
    }
    const calculation = Logic.calculateModel();
    const outputContainer = document.getElementById('modeler-output-container');
    if (outputContainer) outputContainer.innerHTML = UI.renderModelerOutputPanel(calculation);
},

/**
 * Master calculation engine. It acts as a router, calling the specific calculation
 * function for the active deal type and then layering on the universal pricing
 * and commission calculations.
 * @returns {object|null} A comprehensive object with all calculated deal metrics, or null if calculation fails.
 */
calculateModel: () => {
    const { activeDealType, pricingConfig } = AppState.modeler;
    const calculationFunc = Logic[`calculate${activeDealType}`];
    if (!calculationFunc) return null;
    const dealCalc = calculationFunc();
    if (!dealCalc) return null;
    const { baseValueUSD } = dealCalc;
    const grossValue = parseFloat(pricingConfig.grossValue) || 0;
    const netValue = parseFloat(pricingConfig.netValue) || 0;
    const grossOffer = pricingConfig.isValueInPercent ? baseValueUSD * (grossValue / 100) : grossValue;
    const netToBuyerOffer = pricingConfig.isValueInPercent ? baseValueUSD * (netValue / 100) : netValue;
    let finalValueToBuyerUSD, totalCommissionPool;
    if(pricingConfig.offerType === 'discount') { finalValueToBuyerUSD = baseValueUSD - netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; } 
    else { finalValueToBuyerUSD = baseValueUSD + netToBuyerOffer; totalCommissionPool = grossOffer - netToBuyerOffer; }
    totalCommissionPool = Math.max(0, totalCommissionPool);
    AppState.modeler.legal.totalCommission = totalCommissionPool;
    return { ...dealCalc, baseValueUSD, finalValueToBuyerUSD, totalCommissionPool, netValueDescription: `${Utils.formatNumber(pricingConfig.netValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Net ${pricingConfig.offerType}`, grossValueDescription: `${Utils.formatNumber(pricingConfig.grossValue)}${pricingConfig.isValueInPercent ? '%' : '$'} Gross ${pricingConfig.offerType}` };
},

/**
 * Calculates the specifics for an Asset Swap deal.
 * @returns {object} An object containing the calculated metrics for the swap.
 */
calculateAssetSwap: () => {
    const { amount, fromAssetKey, toAssetKey } = AppState.modeler.assetSwap;
    const fromAsset = Utils.getAssetByKey(fromAssetKey);
    const toAsset = Utils.getAssetByKey(toAssetKey);
    const baseValueUSD = (parseFloat(amount) || 0) * (fromAsset.price || 0);
    const rate = (fromAsset.price > 0 && toAsset.price > 0) ? fromAsset.price / toAsset.price : 0;
    const dealTitle = `Swap ${Utils.formatNumber(amount, 2)} ${fromAsset.baseAsset} for ${toAsset.baseAsset}`;
    return { baseValueUSD, fromAsset, toAsset, rate, dealTitle };
},

/**
 * Calculates the specifics for a physical Commodity Trade deal.
 * @returns {object} An object containing the calculated metrics for the trade.
 */
calculateCommodityTrade: () => {
    const { quantity, assetKey, pricingModel, fixedPrice, discountPremiumValue, settlementAssetKey, discountPremiumIsInPercent } = AppState.modeler.commodityTrade;
    const asset = Utils.getAssetByKey(assetKey);
    const settlementAsset = Utils.getAssetByKey(settlementAssetKey);
    let effectivePricePerUnit = asset.price || 0, priceDerivation = 'Market Price';
    const discPremVal = parseFloat(discountPremiumValue) || 0;
    if (pricingModel === 'Fixed') { effectivePricePerUnit = parseFloat(fixedPrice) || 0; priceDerivation = `Fixed at ${Utils.formatPrice(fixedPrice)}`; }
    else if (pricingModel === 'Premium') { const premiumAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit += premiumAmount; priceDerivation = `Market + ${Utils.formatPrice(premiumAmount)}`; }
    else if (pricingModel === 'Discount') { const discountAmount = discountPremiumIsInPercent ? effectivePricePerUnit * (discPremVal / 100) : discPremVal; effectivePricePerUnit -= discountAmount; priceDerivation = `Market - ${Utils.formatPrice(discountAmount)}`; }
    const baseValueUSD = (parseFloat(quantity) || 0) * effectivePricePerUnit;
    const dealTitle = `${Utils.formatNumber(quantity)} units of ${asset.baseAsset}`;
    let settlementAmount = baseValueUSD / (settlementAsset.price || 1);
    return { baseValueUSD, dealTitle, priceDerivation, effectivePricePerUnit, settlementAmount, settlementAsset };
},

/**
 * Calculates the specifics for a Crypto-Collateralized Loan.
 * @returns {object} An object containing the calculated metrics for the loan.
 */
calculateCryptoLoan: () => {
    const { collateralAmount, collateralAssetKey, ltv, loanCurrency, tenureMonths, interestRateValue } = AppState.modeler.cryptoLoan;
    
    const collateralAsset = Utils.getAssetByKey(collateralAssetKey);
    
    // Calculate the total value of the collateral in USD.
    const collateralValueUSD = (parseFloat(collateralAmount) || 0) * (parseFloat(collateralAsset.price) || 0);
    
    // Calculate the loan principal based on the Loan-to-Value (LTV) percentage.
    const loanPrincipal = collateralValueUSD * ((parseFloat(ltv) || 0) / 100);
    
    // Calculate the total simple interest over the loan term.
    const totalInterest = loanPrincipal * ((parseFloat(interestRateValue) || 0) / 100) * ((parseInt(tenureMonths, 10) || 1) / 12);
    
    const totalRepayment = loanPrincipal + totalInterest;

    return {
        baseValueUSD: loanPrincipal, // For consistency, the base value of a loan is its principal.
        loanPrincipal,
        totalRepayment,
        loanCurrency,
        tenureMonths,
        interestRateValue,
        dealTitle: `Loan against ${collateralAsset.baseAsset}`
    };
},
            /**
 * Calculates the specifics for SBLC Monetization.
 * @returns {object} An object containing the calculated metrics for the monetization deal.
 */
calculateSBLCMonetization: () => {
    const { faceValue, ltv } = AppState.modeler.sblcMonetization;
    
    // Calculate the monetized value based on the instrument's face value and the Loan-to-Value (LTV) percentage.
    const baseValueUSD = (parseFloat(faceValue) || 0) * ((parseFloat(ltv) || 0) / 100);
    
    const dealTitle = `LTV on ${Utils.formatPrice(faceValue)} SBLC`;

    return { 
        baseValueUSD, // For consistency, the base value is the total capital unlocked.
        dealTitle 
    };
},

/**
 * Resets the entire Institutional Modeler state to its default configuration.
 * This function performs a deep-clone reset to prevent any reference-related bugs
 * and ensures a clean slate for the user.
 */
resetModelerState: () => {
    // Define the pristine, default state of the entire modeler.
    const defaultState = {
        activeDealType: 'AssetSwap',
        assetSwap: { 
            amount: 1000000, 
            fromAssetKey: '', 
            toAssetKey: '' 
        },
        commodityTrade: { 
        assetKey: 'WTI-BBL-USD',
        quantity: 100000,
        unitOfMeasure: 'Barrel',
        qualitySpec: 'API Gravity: 40-42, Sulfur Content: <0.42%',
        origin: 'United States',
        port: 'Houston',
        incoterms: 'FOB',
        procedures: 'â€¢ Standard TTV Procedures\nâ€¢ SGS/Intertek Inspection\nâ€¢ Payment via SBLC/DLC',
        pricingModel: 'Discount',
        fixedPrice: 0,
        discountPremiumValue: 4,
        discountPremiumIsInPercent: true,
        settlementAssetKey: 'USD' 
    },
        cryptoLoan: { 
            collateralAssetKey: 'BTC-USD', 
            collateralAmount: 10, 
            loanCurrency: 'USD', 
            ltv: 60, 
            interestRateType: 'fixed', 
            interestRateValue: 5.5, 
            tenureMonths: 12 
        },
        sblcMonetization: { 
            faceValue: 100000000, 
            ltv: 80 
        },
        pricingConfig: { 
            isVisible: false, 
            offerType: 'discount', 
            grossValue: 0, 
            netValue: 0, 
            isValueInPercent: true 
        },
        legal: { 
            totalCommission: 0, 
            jurisdiction: 'Singapore, Dubai, England, Wales', 
            spaReferenceCode: '', 
            groups: [] 
        }
    };

    // Perform a deep clone to ensure no lingering references. This is the most robust way to reset.
    AppState.modeler = JSON.parse(JSON.stringify(defaultState));
    
    // Intelligence: After resetting, re-populate the Asset Swap fields with the first two
    // available assets from the market data, providing a sensible default.
    const allSwappableAssets = AppState.marketData.filter(a => a.type !== 'Cross-Rate' && a.price > 0);
    if (allSwappableAssets.length >= 2) {
        AppState.modeler.assetSwap.fromAssetKey = allSwappableAssets[0].key;
        AppState.modeler.assetSwap.toAssetKey = allSwappableAssets[1].key;
    }
    
    // Trigger a full UI re-render to reflect the reset state.
    Logic.updateModelerUI(true);
    
    // Provide user feedback.
    Utils.showNotification('Institutional Modeler has been reset to its default state.', 'info', 'Modeler Reset');
},

/**
 * Swaps the 'from' and 'to' assets in the Asset Swap modeler.
 * It intelligently recalculates the 'from' amount to preserve the total USD value of the deal.
 */
swapAssets: () => {
    const swapState = AppState.modeler.assetSwap;
    
    // Retrieve full asset data to ensure prices are current.
    const fromAsset = Utils.getAssetByKey(swapState.fromAssetKey);
    const toAsset = Utils.getAssetByKey(swapState.toAssetKey);

    // Recalculate the 'amount' field to maintain the same total USD value after the swap.
    if (fromAsset.price > 0 && toAsset.price > 0) {
        const totalUsdValue = (parseFloat(swapState.amount) || 0) * fromAsset.price;
        // The new 'amount' will be what the total USD value can buy of the *new* 'from' asset.
        swapState.amount = totalUsdValue / toAsset.price; 
    }

    // Perform the actual swap of the asset keys in the state.
    [swapState.fromAssetKey, swapState.toAssetKey] = [swapState.toAssetKey, swapState.fromAssetKey];
    
    // Trigger the premium 3D icon animation for visual feedback.
    const icon = document.getElementById('swap-icon');
    if (icon) {
        // This technique forces a CSS animation restart.
        icon.style.animation = 'none';
        void icon.offsetWidth; // Trigger reflow
        icon.style.animation = 'swap-icon-spin 0.5s ease-in-out';
    }
    
    // Trigger a full UI update to reflect the swapped assets and recalculated amount.
    Logic.updateModelerUI(true);
},

/**
 * Toggles the visibility of the advanced pricing configuration panel in the UI.
 */
togglePricingConfig: () => {
    // Directly mutate the state.
    AppState.modeler.pricingConfig.isVisible = !AppState.modeler.pricingConfig.isVisible;
    
    // Trigger a full UI update (`true`) to re-render the input panel with the
    // now-visible (or hidden) pricing configuration section. This ensures
    // the collapsible animation works correctly.
    Logic.updateModelerUI(true);
},
            
            // --- IMFPA & NCNDA Logic (v4.0 - Definitive & Unabridged) ---

/**
 * Opens and initializes the main IMFPA & Commission Manager modal.
 * It renders the initial UI and attaches all necessary event listeners.
 */
openImfpaModal: () => {
    const modal = document.getElementById('imfpa-modal');
    if (!modal) return console.error("CRITICAL: IMFPA modal container not found in DOM.");
    
    modal.innerHTML = UI.renderImfpaModal();
    Logic.refreshImfpaModalUI();
    modal.showModal();
},

/**
 * Refreshes the entire IMFPA modal UI based on the current `AppState.modeler.legal`.
 * This function is the single source of truth for updating the modal's dynamic content,
 * such as allocation groups and party lists, and re-binding necessary event listeners.
 */
refreshImfpaModalUI: () => {
    const { legal } = AppState.modeler;
    const groupsContainer = document.getElementById('imfpa-groups-container');
    const legalPartiesContainer = document.getElementById('imfpa-legal-parties');

    if (groupsContainer) groupsContainer.innerHTML = UI.renderImfpaGroups();
    if (legalPartiesContainer) {
        const allParties = legal.groups.flatMap(g => g.parties);
        legalPartiesContainer.innerHTML = allParties.length > 0
            ? allParties.map(p => `<div><i class="fas fa-user-check text-success-color mr-2"></i>${p.legalName || 'Unnamed Party'}</div>`).join('')
            : '<p class="text-xs text-text-muted">No signatory parties defined.</p>';
    }

    const modalContent = document.getElementById('imfpa-modal-content');
    if (modalContent) {
        modalContent.removeEventListener('input', Logic.handleModelerInputChangeInModal);
        modalContent.removeEventListener('change', Logic.handleModelerInputChangeInModal);
        modalContent.addEventListener('input', Logic.handleModelerInputChangeInModal);
        modalContent.addEventListener('change', Logic.handleModelerInputChangeInModal);
    }
    Logic.updateImfpaCalculations();
},

/**
 * A dedicated event handler for inputs within the IMFPA modal. It calls the main
 * input handler and then triggers the specific calculation updates for the IMFPA UI.
 * @param {Event} e - The input or change event from within the modal.
 */
handleModelerInputChangeInModal: (e) => {
    // Leverage the main, robust input handler to update the application state.
    Logic.handleModelerInputChange(e);
    
    // After the state is updated, call the specific function to update IMFPA calculations.
    Logic.updateImfpaCalculations();
},

/**
 * Updates all calculated values within the IMFPA modal, such as group totals and
 * total allocation percentages, providing real-time feedback to the user.
 */
updateImfpaCalculations: () => {
    const { groups, totalCommission } = AppState.modeler.legal;
    
    document.getElementById('imfpa-total-commission-pool').textContent = Utils.formatPrice(totalCommission);
    
    const totalGroupPct = groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
    const totalAllocatedEl = document.getElementById('imfpa-total-allocated');
    if (totalAllocatedEl) {
        totalAllocatedEl.textContent = `Total Allocated: ${totalGroupPct.toFixed(2)}%`;
        const isBalanced = Math.abs(totalGroupPct - 100) < 0.01;
        totalAllocatedEl.className = `text-right font-mono text-sm ${isBalanced ? 'text-success-color' : 'text-error-color'}`;
    }

    groups.forEach((g, groupIndex) => {
        const groupValue = totalCommission * ((parseFloat(g.percentage) || 0) / 100);
        document.getElementById(`imfpa-group-value-${groupIndex}`).textContent = Utils.formatPrice(groupValue);

        const totalPartyPct = g.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
        const groupTotalEl = document.getElementById(`imfpa-group-total-${groupIndex}`);
        if (groupTotalEl) {
            groupTotalEl.textContent = `Group Total: ${totalPartyPct.toFixed(2)}%`;
            const isGroupBalanced = Math.abs(totalPartyPct - 100) < 0.01;
            groupTotalEl.className = `text-right font-mono text-xs ${isGroupBalanced ? 'text-success-color' : 'text-error-color'}`;
        }
    });
},

/**
 * Adds a new, empty allocation group to the state and refreshes the UI.
 */
addImfpaGroup: () => {
    // Add a new group object with default values to the state.
    AppState.modeler.legal.groups.push({
        name: `Group ${AppState.modeler.legal.groups.length + 1}`,
        percentage: 0,
        parties: []
    });
    
    // Trigger a full UI refresh of the modal to display the new group.
    Logic.refreshImfpaModalUI();
},
            /**
 * Removes a specific allocation group from the state by its index.
 * @param {number} groupIndex - The index of the group to remove.
 */
removeImfpaGroup: (groupIndex) => {
    // Modify the state by removing the specified group from the array.
    AppState.modeler.legal.groups.splice(groupIndex, 1);
    
    // Trigger a full UI refresh of the modal to reflect the removal.
    Logic.refreshImfpaModalUI();
},

/**
 * Adds a new, empty party to a specific allocation group in the state.
 * @param {number} groupIndex - The index of the group to which the party will be added.
 */
addImfpaParty: (groupIndex) => {
    // Safeguard: Ensure the target group exists before attempting to add a party.
    if (!AppState.modeler.legal.groups[groupIndex]) {
        console.error(`Attempted to add party to a non-existent group at index ${groupIndex}.`);
        return;
    }

    // Add a new party object with a comprehensive, default structure to the specified group.
    AppState.modeler.legal.groups[groupIndex].parties.push({
        legalName: `New Party`,
        role: 'Intermediary',
        percentage: 0,
        detailsVisible: true, // Default to showing details for a new party for immediate input.
        email: '',
        contactNumber: '',
        passport: {
            number: '',
            issueDate: '',
            expiryDate: '',
            authority: ''
        },
        payment: {
            method: 'Bank Wire', // Default to the most common method.
            currency: 'USD',
            details: ''
        }
    });
    
    // Trigger a full UI refresh of the modal to display the new party.
    Logic.refreshImfpaModalUI();
},

/**
 * Removes a specific party from a specific group by their respective indices.
 * @param {number} groupIndex - The index of the parent group.
 * @param {number} partyIndex - The index of the party to remove within the group.
 */
removeImfpaParty: (groupIndex, partyIndex) => {
    // Safeguard: Ensure the target party exists before attempting removal.
    if (AppState.modeler.legal.groups[groupIndex] && AppState.modeler.legal.groups[groupIndex].parties[partyIndex]) {
        // Modify the state by removing the specified party from the group's parties array.
        AppState.modeler.legal.groups[groupIndex].parties.splice(partyIndex, 1);
        
        // Trigger a full UI refresh of the modal to reflect the removal.
        Logic.refreshImfpaModalUI();
    } else {
        console.error(`Attempted to remove a non-existent party at group ${groupIndex}, party ${partyIndex}.`);
    }
},

/**
 * Toggles the visibility of the detailed input fields for a specific party.
 * @param {number} groupIndex - The index of the parent group.
 * @param {number} partyIndex - The index of the party whose details will be toggled.
 */
togglePartyDetails: (groupIndex, partyIndex) => {
    // Safeguard: Ensure the target party exists before toggling.
    const party = AppState.modeler.legal.groups?.[groupIndex]?.parties?.[partyIndex];
    if (party) {
        // Directly mutate the boolean state property.
        party.detailsVisible = !party.detailsVisible;
        
        // Trigger a full UI refresh of the modal to apply the CSS class change for the collapse/expand animation.
        Logic.refreshImfpaModalUI();
    } else {
        console.error(`Attempted to toggle details for a non-existent party at group ${groupIndex}, party ${partyIndex}.`);
    }
},

/**
 * Generates the final NCNDA/IMFPA contract preview based on the current modeler state.
 * This is the pinnacle, unabridged implementation.
 */
generateContract: () => {
    const { legal, activeDealType } = AppState.modeler;
    const calc = Logic.calculateModel();

    // --- SEVERE VALIDATION ENGINE ---
    const totalGroupPct = legal.groups.reduce((sum, g) => sum + (parseFloat(g.percentage) || 0), 0);
    if (Math.abs(totalGroupPct - 100) > 0.01) {
        return Utils.showNotification("Total group allocation must equal exactly 100%.", 'error', 'Allocation Error');
    }

    for (const group of legal.groups) {
        const totalPartyPct = group.parties.reduce((sum, p) => sum + (parseFloat(p.percentage) || 0), 0);
        if (Math.abs(totalPartyPct - 100) > 0.01) {
            return Utils.showNotification(`Party allocation within "${group.name}" must equal exactly 100%.`, 'error', 'Allocation Error');
        }
    }
    
    const allParties = legal.groups.flatMap(g => g.parties);
    if (allParties.length < 2) {
        return Utils.showNotification("At least two signatory parties are required to generate a contract.", 'error', 'Party Error');
    }

    if (allParties.some(p => !p.legalName || !p.role)) {
        return Utils.showNotification("All parties must have a 'Full Legal Name' and a 'Role' defined.", 'error', 'Party Data Incomplete');
    }
    // --- END VALIDATION ---

    const now = new Date();
    const formattedDate = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    
    // --- DYNAMIC PREAMBLE GENERATION ---
    const dealDescription = {
        'AssetSwap': `the exchange of approximately ${Utils.formatPrice(calc.baseValueUSD)} worth of digital and/or physical assets`,
        'CommodityTrade': `the trade of ${calc.dealTitle} with an estimated value of ${Utils.formatPrice(calc.baseValueUSD)}`,
        'CryptoLoan': `a crypto-collateralized loan facility with a principal of ${Utils.formatPrice(calc.baseValueUSD)}`,
        'SBLCMonetization': `the monetization of a Standby Letter of Credit with a face value of ${Utils.formatPrice(AppState.modeler.sblcMonetization.faceValue)}`
    }[activeDealType] || 'various prospective financial opportunities';
    
    // --- PINNACLE HTML TEMPLATE FOR CONTRACT ---
    const contractHTML = `
        <div class="contract-preview">
            <h1 style="text-align: center; font-size: 1.2em; font-weight: bold; text-transform: uppercase;">Non-Circumvention, Non-Disclosure & Working Agreement (NCNDA)</h1>
            <h2 style="text-align: center; font-size: 1.1em; font-weight: bold; text-transform: uppercase;">Irrevocable Master Fee Protection Agreement (IMFPA)</h2>
            <p><strong>Effective Date:</strong> ${formattedDate}</p>
            <p><strong>Reference Code:</strong> GECAN-IMFPA-${now.getTime()}</p>
            ${legal.spaReferenceCode ? `<p><strong>Cross-Reference:</strong> ${legal.spaReferenceCode}</p>` : ''}
            <hr style="margin: 1em 0;">

            <p>This Agreement is made and entered into as of the Effective Date, by and between the undersigned Parties, each acting with full corporate authority and responsibility.</p>
            
            <h3>ARTICLE 1: PURPOSE</h3>
            <p>1.1. The Parties, intending to be legally bound, mutually agree to collaborate on ${dealDescription} (the "Project"). This agreement serves to protect the proprietary interests, confidential information, and commission structures of all involved intermediaries.</p>

            <h3>ARTICLE 2: THE PARTIES</h3>
            ${allParties.map((p, i) => `<p><strong>Party ${String.fromCharCode(65 + i)}:</strong> ${p.legalName}, acting as ${p.role}.</p>`).join('')}

            <h3>ARTICLE 3: NON-CIRCUMVENTION & NON-DISCLOSURE (NCND)</h3>
            <p>3.1. The Parties irrevocably agree not to circumvent, avoid, or bypass each other, directly or indirectly, to transact with any entity or individual introduced by another Party in relation to the Project. This covenant shall extend for a period of five (5) years from the Effective Date.</p>
            <p>3.2. All information exchanged, including but not limited to contacts, financial data, and procedures, shall be deemed confidential and proprietary.</p>

            <h3>ARTICLE 4: IRREVOCABLE MASTER FEE PROTECTION AGREEMENT (IMFPA)</h3>
            <p>4.1. The Parties agree that a total commission pool of <strong>${Utils.formatPrice(legal.totalCommission)}</strong> (the "Commission Pool") is established for the successful execution of the Project.</p>
            <p>4.2. This Commission Pool shall be irrevocably distributed amongst the Parties as per the schedule detailed in Addendum A.</p>
            <p>4.3. Payments shall be made via ${allParties[0].payment.method} in ${allParties[0].payment.currency} within seventy-two (72) banking hours of the clearing of funds for each tranche of the transaction.</p>

            <h3>ARTICLE 5: GOVERNING LAW</h3>
            <p>5.1. This Agreement shall be governed by and construed in accordance with the laws of: <strong>${legal.jurisdiction}</strong>. The principles of the International Chamber of Commerce (ICC) shall be considered persuasive authority.</p>

            <h3>ADDENDUM A: COMMISSION ALLOCATION SCHEDULE</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 1em; font-size: 0.9em;">
                <thead style="background-color: #1e293b;">
                    <tr>
                        <th style="padding: 0.5em; border: 1px solid var(--border-color); text-align: left;">Group / Party</th>
                        <th style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;">Allocation (%)</th>
                        <th style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;">Estimated Payout</th>
                    </tr>
                </thead>
                <tbody>
                ${legal.groups.map(g => `
                    <tr style="background-color: #111827;">
                        <td style="padding: 0.5em; border: 1px solid var(--border-color);"><strong>${g.name}</strong></td>
                        <td style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;"><strong>${g.percentage}%</strong></td>
                        <td style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;"><strong>${Utils.formatPrice(legal.totalCommission * (g.percentage / 100))}</strong></td>
                    </tr>
                    ${g.parties.map(p => `
                        <tr>
                            <td style="padding: 0.5em 0.5em 0.5em 2em; border: 1px solid var(--border-color);">${p.legalName} (${p.role})</td>
                            <td style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;">${p.percentage}%</td>
                            <td style="padding: 0.5em; border: 1px solid var(--border-color); text-align: right;">${Utils.formatPrice(legal.totalCommission * (g.percentage / 100) * (p.percentage / 100))}</td>
                        </tr>
                    `).join('')}
                `).join('')}
                </tbody>
            </table>
        </div>
    `;

    // Display the preview and show the finalization button.
    const previewContainer = document.getElementById('contract-preview-container');
    if (previewContainer) {
        previewContainer.innerHTML = contractHTML;
        previewContainer.classList.remove('hidden');
        previewContainer.scrollIntoView({ behavior: 'smooth' });
    }

    Utils.showNotification("NCNDA/IMFPA contract has been successfully synthesized.", 'success', 'Contract Generated');
},
            // --- Document Execution & Signature Suite (v5.0 - Pinnacle Unabridged) ---
initiateSigningProcess: () => {
    const sigBlocks = document.querySelectorAll('#contract-document-wrapper .p-signature-block');
    const selectEl = document.getElementById('signature-target-select');
    if (!selectEl) return;
    
    selectEl.innerHTML = '<option value="">-- Select a Signatory --</option>';
    sigBlocks.forEach((block, index) => {
        const partyName = block.dataset.partyName;
        const option = new Option(`${index + 1}: ${partyName}`, block.dataset.partyId);
        selectEl.add(option);
    });

    const modal = document.getElementById('signature-modal');
    modal.showModal();
    Logic.switchSignatureMode('draw');
    
    document.getElementById('signature-timestamp').textContent = new Date().toISOString();
    document.getElementById('signature-location').textContent = 'Fetching...';
    fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
        document.getElementById('signature-location').textContent = `${data.city}, ${data.country_name} (IP: ${data.ip})`;
    }).catch(() => { document.getElementById('signature-location').textContent = 'Location Not Available'; });
},

switchSignatureMode: (mode) => {
    const panels = { draw: 'draw-mode-panel', upload: 'upload-mode-panel', seal: 'seal-mode-panel' };
    const tabs = { draw: 'draw-tab-btn', upload: 'upload-tab-btn', seal: 'seal-tab-btn' };

    Object.values(panels).forEach(id => document.getElementById(id).classList.add('hidden'));
    Object.values(tabs).forEach(id => document.getElementById(id).classList.remove('active'));

    document.getElementById(panels[mode]).classList.remove('hidden');
    document.getElementById(tabs[mode]).classList.add('active');
    document.getElementById('signature-modal').dataset.activeMode = mode;
    
    if (mode === 'draw') Logic.setupSignaturePad();
    if (mode === 'upload' || mode === 'seal') Logic.setupFileUpload(mode);
},

setupSignaturePad: () => {
    const canvas = document.getElementById('signature-canvas');
    if (!canvas) return;
    const resizeCanvas = () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        if (window.signaturePad) window.signaturePad.clear();
    };
    if (!window.signaturePad) window.signaturePad = new SignaturePad(canvas, { penColor: "#1A237E" });
    setTimeout(resizeCanvas, 50);
},

clearSignaturePad: () => window.signaturePad?.clear(),

setupFileUpload: (type) => { // 'upload' for signature, 'seal' for seal
    const inputId = type === 'upload' ? 'signature-upload-input' : 'seal-upload-input';
    const previewId = type === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview';
    const promptId = type === 'upload' ? 'upload-prompt' : 'seal-prompt';
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const prompt = document.getElementById(promptId);
    if (!input || !preview || !prompt) return;
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                prompt.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    };
},

processImageForTransparency: (imageDataUrl, threshold = 240) => {
    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] > threshold && data[i + 1] > threshold && data[i + 2] > threshold) {
                        data[i + 3] = 0;
                    }
                }
                ctx.putImageData(imageData, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            } catch (e) { reject(new Error("Cannot process image due to security restrictions.")); }
        };
        img.onerror = () => reject(new Error("Failed to load image."));
        img.src = imageDataUrl;
    });
},

applySignature: async () => {
    const modal = document.getElementById('signature-modal');
    const mode = modal.dataset.activeMode;
    const targetPartyId = document.getElementById('signature-target-select').value;
    if (!targetPartyId) return Utils.showNotification("Please select a signatory.", 'error');

    let dataUrl = '';
    try {
        if (mode === 'draw') {
            if (window.signaturePad.isEmpty()) throw new Error("Please draw a signature.");
            dataUrl = window.signaturePad.toDataURL('image/png');
        } else {
            const previewId = mode === 'upload' ? 'signature-upload-preview' : 'seal-upload-preview';
            const previewImg = document.getElementById(previewId);
            if (!previewImg.src || previewImg.classList.contains('hidden')) throw new Error(`Please upload a ${mode === 'upload' ? 'signature' : 'seal'}.`);
            dataUrl = await Logic.processImageForTransparency(previewImg.src);
        }

        const dateOfExecution = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const containersToUpdate = ['#contract-document-wrapper', '#print-area'];

        containersToUpdate.forEach(containerSelector => {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            const targetBlock = container.querySelector(`.p-signature-block[data-party-id="${targetPartyId}"]`);
            if (!targetBlock) return;

            if (mode === 'draw' || mode === 'upload') {
                targetBlock.querySelector('[data-sig-type="signature"]').innerHTML = `<img src="${dataUrl}" class="p-signature-img" alt="Digital Signature">`;
                targetBlock.querySelector('[data-sig-type="date"]').textContent = dateOfExecution;
            } else if (mode === 'seal') {
                targetBlock.querySelector('[data-sig-type="seal"]').innerHTML = `<img src="${dataUrl}" class="p-seal-img" alt="Corporate Seal">`;
            }
        });

        modal.close();
        Logic.resetSignatureInputs();
        document.querySelector('#finalization-step-panel').classList.remove('opacity-50', 'pointer-events-none');
        Utils.showNotification("Signature/seal applied successfully.", 'success');
    } catch (error) {
        Utils.showNotification(error.message, 'error', 'Application Failed');
    }
},

resetSignatureInputs: () => {
    window.signaturePad?.clear();
    ['signature-upload', 'seal-upload'].forEach(id => {
        const input = document.getElementById(`${id}-input`);
        const preview = document.getElementById(`${id}-preview`);
        const promptEl = document.getElementById(id.replace('upload', 'prompt'));
        if(input) input.value = '';
        if(preview) { preview.src = ''; preview.classList.add('hidden'); }
        if(promptEl) promptEl.classList.remove('hidden');
    });
},

sendForSignature: () => {
    document.getElementById('finalization-modal').showModal();
},

simpleHash: async (str) => {
    const buffer = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
},

executeFinalizationWorkflow: async () => {
    document.getElementById('finalization-modal').close();
    Utils.showNotification("Finalizing document and dispatching...", 'info', 'Processing');

    try {
        const finalHtml = document.getElementById('print-area').innerHTML;
        const documentFingerprint = await Logic.simpleHash(finalHtml);
        const agreementReference = finalHtml.match(/Reference:<\/strong>\s*([^<]+)/)?.[1].trim() || 'GECAN-DOC-FINAL';
        const recipientEmails = AppState.modeler.legal.groups.flatMap(g => g.parties).map(p => p.email).filter(Boolean);

        const payload = {
            agreementReference,
            documentFingerprint,
            recipientEmails: recipientEmails.join(','),
            emailBody: Logic.generatePremiumEmailTemplate({ agreementReference, documentFingerprint, parties: AppState.modeler.legal.groups.flatMap(g => g.parties) }),
            fileName: `${agreementReference}_EXECUTED.pdf`,
            htmlContent: `<!DOCTYPE html><html><head><style>${Array.from(document.styleSheets).map(s => Array.from(s.rules || []).map(r => r.cssText).join('')).join('')}</style></head><body>${finalHtml}</body></html>`
        };

        const response = await Logic.createApiRequest('generatePdfAndDispatchEmail', 'POST', payload);
        Utils.showNotification(response, 'success', 'Document Dispatched');
    } catch (error) {
        Utils.showNotification(error.message, 'error', 'Dispatch Failed');
    }
},

generatePremiumEmailTemplate: (payload) => {
    const partyListHTML = payload.parties.map(p => `<li><strong>${p.legalName || 'N/A'}</strong> (${p.role || 'N/A'})</li>`).join('');
    return `
    <body style="font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px;">
        <div style="max-width: 750px; margin: auto; background-color: #ffffff; border: 1px solid #ddd; border-radius: 10px;">
            <div style="background-color: #0369a1; color: white; padding: 25px; text-align: center;"><h1>GECANâ„¢ | Executed Agreement Attached</h1></div>
            <div style="padding: 30px;">
                <p>Dear Contracting Parties,</p>
                <p>Please find attached the fully executed legal document. This document has been finalized and its state cryptographically recorded.</p>
                <div style="background-color: #f9f9f9; padding: 20px; border-left: 5px solid #0ea5e9; margin: 25px 0;">
                    <h3 style="color: #0369a1;">Agreement Details</h3>
                    <p><strong>Reference:</strong> ${payload.agreementReference}</p>
                    <p><strong>Document Fingerprint (SHA-256):</strong> <code style="font-size: 12px;">${payload.documentFingerprint}</code></p>
                </div>
                <h3>Parties to this Agreement:</h3><ul>${partyListHTML}</ul>
                <p>Thank you for your cooperation.<br><strong>The GECANâ„¢ Transactional Systems</strong></p>
            </div>
            <div style="background-color: #e2e8f0; color: #4a5568; padding: 20px; font-size: 12px; text-align: center;">
                <p><strong>CONFIDENTIALITY NOTICE (ICC Pub. No. 769 E):</strong> This electronic communication is strictly confidential and intended solely for the authorized recipients.</p>
            </div>
        </div>
    </body>`;
},


        };

// ====================================================================================
// === SECTION 4: UI RENDERERS (v4.0 - DEFINITIVE, UNABRIDGED & CORRECTED) ===
// This block contains the pinnacle-grade, word-for-word logic for rendering
// every component and state of the Toolkits page UI.
// ====================================================================================
const UI = {
    /**
     * Initializes the particle background with a default or fetched theme.
     * This function is the benchmark standard for dynamic background effects.
     */
    init: () => {
        const defaultConfig = {
            "particles": {
                "number": { "value": 50, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": ["#0ea5e9", "#6366f1", "#8b5cf6"] },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.6, "random": true, "anim": { "enable": true, "speed": 0.5, "opacity_min": 0.1 } },
                "size": { "value": 3, "random": true },
                "line_linked": { "enable": true, "distance": 150, "color": "#475569", "opacity": 0.4, "width": 1 },
                "move": { "enable": true, "speed": 1, "direction": "none", "random": true, "out_mode": "out" }
            },
            "interactivity": {
                "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } },
                "modes": { "grab": { "distance": 200, "line_linked": { "opacity": 0.6 } }, "push": { "particles_nb": 4 } }
            }
        };
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', defaultConfig);
        }
    },

    /**
     * Dynamically renders the particle.js background using a provided configuration.
     * @param {object} config - A valid particle.js configuration object.
     */
    renderParticles: (config) => {
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', config);
        } else {
            console.warn("particles.js library not found, skipping background rendering.");
        }
    },

    /**
     * Populates the main and mobile navigation menus from a central source of truth.
     * This function is benchmarked against index.html for perfect platform-wide consistency.
     */
    populateNavLinks: () => {
    const navPlaceholder = document.getElementById('desktop-nav-placeholder');
    const mobileMenuContent = document.getElementById('mobile-sidebar-content');
    if (!navPlaceholder || !mobileMenuContent) return;

    const path = window.location.pathname;
    const currentPageFile = path.split('/').pop().replace('.html', '') || 'index';

    const links = [
        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
        { page: 'about', icon: 'fas fa-landmark', text: 'About The Alliance' },
        { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },
        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }
    ];

    const navHtml = (isMobile = false) => links.map(link => {
        const isActive = currentPageFile === link.page;
        const btnClass = isMobile ? 'nav-btn w-full justify-start' : 'nav-btn';
        // This HTML structure is the benchmark standard for all navigation buttons.
        return `
            <a href="./${link.page}.html" class="${btnClass} ${isActive ? 'active' : ''}">
                <div class="nav-icon-wrapper">
                    <div class="nav-icon-flipper">
                        <div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div>
                        <div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div>
                    </div>
                </div>
                <span class="nav-text">${link.text}</span>
            </a>`;
    }).join(isMobile ? '' : '');

    navPlaceholder.innerHTML = `<div id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">${navHtml(false)}</div>`;
    // For mobile, we create a fresh clone every time to ensure event listeners are clean.
    mobileMenuContent.innerHTML = `<div class="mobile-nav-clone">${navHtml(true)}</div>`;
},

    /**
     * Renders the menu of available toolkits in the left sidebar, highlighting the active one.
     */
    renderToolkitMenu: () => {
        const menuContainer = document.getElementById('toolkit-menu');
        if (!menuContainer) return;
        menuContainer.innerHTML = Object.values(AppState.toolkits).map(t => {
            const isActive = AppState.activeToolkit === t.id;
            return `
                <button onclick="Logic.setActiveToolkit('${t.id}')" 
                        class="w-full text-left p-4 rounded-xl flex items-center gap-4 transition-all duration-300 group ${isActive ? 'bg-gradient-to-r from-primary-azure to-primary-dark text-white shadow-lg shadow-primary-azure/20' : 'text-text-secondary hover:bg-background-secondary hover:text-white'}">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${t.color} flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                        <i class="fas ${t.icon} text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold truncate">${t.name}</div>
                        <div class="text-xs opacity-75 mt-1 truncate">${t.description.split('.')[0]}</div>
                    </div>
                    <i class="fas fa-chevron-right opacity-50 group-hover:opacity-100 transition-opacity ml-auto"></i>
                </button>`;
        }).join('');
    },

    /**
     * Master UI renderer. It acts as a router, calling the specific UI function 
     * for the currently active toolkit and binding its necessary event listeners.
     */
    renderActiveToolkit: () => {
        const container = document.getElementById('active-toolkit-container');
        if (!container) return console.error("CRITICAL: Active toolkit container not found.");
        
        const renderFunc = UI[`render${AppState.activeToolkit}UI`];
        if (typeof renderFunc === 'function') {
            container.innerHTML = renderFunc();
            container.classList.remove('hidden');
            Logic.bindActiveToolkitEvents();
        } else {
            Utils.showNotification(`UI for '${AppState.activeToolkit}' not implemented.`, 'error');
            container.innerHTML = `<p class="text-center text-error-color">UI Error: Component '${AppState.activeToolkit}' failed to load.</p>`;
        }
        UI.renderToolkitMenu();
    },

    /**
     * Renders the main dashboard/welcome view for the toolkits page.
     * DEFINITIVE FIX: The trailing comma that caused the syntax error has been removed.
     */
    renderDashboardUI: () => `
        <div class="glass rounded-2xl p-8 h-full flex flex-col animate-fade-in-up">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold gradient-text mb-4">GECANâ„¢ Intelligent Toolkits</h2>
                <p class="text-text-secondary text-lg max-w-2xl mx-auto leading-relaxed">Select a proprietary tool from the sidebar to begin your institutional-grade analysis. Each toolkit is powered by advanced algorithms and real-time data intelligence.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                ${Object.values(AppState.toolkits)
                    .filter(t => t.id !== 'Dashboard')
                    .map((t, index) => `
                        <div class="report-section p-8 cursor-pointer group animate-scale-in stagger-${index + 1}" onclick="Logic.setActiveToolkit('${t.id}')">
                            <div class="flex items-start gap-6">
                                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${t.color} flex items-center justify-center text-white text-2xl group-hover:scale-110 transition-transform duration-300 ease-in-out">
                                    <i class="fas ${t.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary-azure transition-colors">${t.name}</h3>
                                    <p class="text-text-secondary leading-relaxed">${t.description}</p>
                                    <div class="mt-4 flex items-center text-primary-azure opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                        <span class="text-sm font-medium">Launch Toolkit</span>
                                        <i class="fas fa-arrow-right ml-2"></i>
                                    </div>
                                </div>
                            </div>
                        </div>`).join('')
                }
            </div>
        </div>`,

    /**
     * Renders the main container and logic for the Wallet Forensics toolkit.
     * It intelligently displays the initial prompt, the premium loading state, or the full, detailed report.
     * @returns {string} The complete HTML for the Wallet Forensics toolkit interface.
     */
    renderWalletForensicsUI: () => {
        const { address, isLoading, report } = AppState.walletAnalysis;
        let contentHTML = '';

        if (isLoading) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center animate-fade-in-up"><div class="relative mb-8"><div class="w-24 h-24 border-4 border-primary-azure border-t-transparent rounded-full animate-spin"></div><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div><h3 class="text-2xl font-bold text-white mb-4">Analyzing Wallet On-Chain...</h3><p id="spinner-text" class="text-text-secondary mb-6 transition-opacity duration-300">Initializing GECAN Heuristic Engine v5.0...</p><div class="w-64 h-2 bg-background-secondary rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-primary-azure to-primary-royal" style="width: 100%; animation: shimmer 2s infinite linear; background-size: 400% 100%;"></div></div></div>`;
        } else if (report?.error || report?.success === false) {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-8 animate-scale-in"><div class="w-24 h-24 rounded-full bg-red-500/10 flex items-center justify-center mb-8"><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i></div><h3 class="text-2xl font-bold text-white mb-4">Analysis Failed</h3><p class="text-text-secondary max-w-md leading-relaxed">${report.error?.message || 'An unknown server error occurred. Please try again.'}</p><button onclick="Logic.runWalletForensics()" class="btn-primary mt-6 px-6 py-3 rounded-lg"><i class="fas fa-redo mr-2"></i>Retry Analysis</button></div>`;
        } else if (report) {
            contentHTML = UI.buildWalletReportHTML(report);
        } else {
            contentHTML = `<div class="h-full flex flex-col items-center justify-center text-center glass rounded-2xl border-2 border-dashed border-border-color animate-fade-in-up"><div class="w-24 h-24 rounded-full bg-primary-azure/10 flex items-center justify-center mb-8 animate-float"><i class="fas fa-search-dollar fa-3x text-primary-azure"></i></div><h3 class="text-2xl font-bold text-white mb-4">Ready for Analysis</h3><p class="text-text-secondary max-w-md leading-relaxed mb-2">Enter a wallet address to begin comprehensive due diligence and provenance analysis.</p><p class="text-xs text-text-muted">Powered by GECAN Proprietary Heuristic Engine v5.0</p></div>`;
        }

        return `<div class="glass rounded-2xl p-0 h-full flex flex-col animate-fade-in-up"><div class="p-8 border-b border-border-color"><div class="flex items-center gap-4 mb-6"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-shield-alt text-white fa-lg"></i></div><div><h2 class="text-3xl font-bold text-white">Wallet Due Diligence & Provenance</h2><p class="text-text-secondary">Advanced blockchain forensics and risk assessment</p></div></div><div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="wallet-address-input" value="${address || ''}" placeholder="Enter BTC, ETH, or TRON address..." class="flex-grow form-input p-4 text-white rounded-xl font-mono text-sm"><button id="check-wallet-btn" class="btn-primary font-bold py-4 px-8 rounded-xl whitespace-nowrap w-full sm:w-auto"><i class="fas fa-microscope mr-2"></i>Analyze</button></div></div><div class="flex-grow p-8 overflow-y-auto">${contentHTML}</div></div>`;
    },

    /**
     * Builds the complete HTML for a generated Wallet Forensics report.
     * @param {object} report - The full report data object from the backend.
     * @returns {string} The complete HTML string for the report.
     */
    buildWalletReportHTML: (report) => {
    const { wallet, analysis, provenance, transactions } = report;
    const { walletClassification, redFlags, riskLevel, integrityScore, scoreBreakdown } = analysis;
    const riskClass = `risk-${riskLevel}`;

    // --- DERIVED METRICS: Calculated once for efficiency and consistency ---
    const reliableTransactionCount = Array.isArray(transactions) ? transactions.length : (wallet.transactionCount || 0);
    const inboundCount = reliableTransactionCount > 0 ? transactions.filter(tx => tx.type === 'Receive').length : 0;
    const outboundCount = reliableTransactionCount > 0 ? transactions.filter(tx => tx.type === 'Send').length : 0;
    const lastActivityDate = reliableTransactionCount > 0 && transactions?.[0]?.time ? new Date(transactions[0].time) : new Date(wallet.firstTransaction);
    const daysSinceLastTx = lastActivityDate ? Math.floor((new Date() - lastActivityDate) / (1000 * 60 * 60 * 24)) : 'N/A';
    const transactionVelocity = wallet.ageInDays > 0 ? (reliableTransactionCount / wallet.ageInDays).toFixed(2) : '0.00';
    const uniqueControllers = [...new Set((provenance.records || []).map(r => r.controller).filter(c => c && c.toUpperCase() !== 'UNKNOWN'))];

    // --- Dynamic Header Tags ---
    const headerTags = [];
    if (provenance.records.length > 0) headerTags.push({ text: 'GECAN LEDGER MATCH', class: 'bg-success-color/20 text-success-color' });
    else headerTags.push({ text: 'UNVERIFIED IN LEDGER', class: 'bg-warning-color/20 text-warning-color' });
    headerTags.push({ text: `${riskLevel} RISK`, class: `bg-${riskClass.replace('risk-','')}-color/20 text-${riskClass.replace('risk-','')}-color` });
    if (uniqueControllers.length > 1) headerTags.push({ text: 'OWNERSHIP CONFLICT', class: 'bg-critical-color/20 text-critical-color' });
    if (walletClassification.type === 'BLACKLISTED') headerTags.push({ text: 'BLACKLISTED', class: 'bg-critical-color/20 text-critical-color font-bold' });

    // --- Severely Upgraded Score Gauge Helper v8.1 ---
    const createScoreGauge = (score, label, size = 'w-40 h-40', isMain = false) => {
        let scoreClass = 'gauge-low';
        if (score < 40) scoreClass = 'gauge-critical'; else if (score < 65) scoreClass = 'gauge-high'; else if (score < 80) scoreClass = 'gauge-medium';
        return `
        <div class="text-center animate-scale-in"><div class="relative ${size} mx-auto mb-3 transition-transform duration-300 hover:scale-105"><svg viewBox="0 0 36 36" class="w-full h-full"><defs><linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%" gradientTransform="rotate(90)"><stop offset="0%" stop-color="var(--critical-color)" /><stop offset="65%" stop-color="var(--warning-color)" /><stop offset="100%" stop-color="var(--success-color)" /></linearGradient></defs><circle cx="18" cy="18" r="15.9155" class="score-gauge-bg"></circle><circle cx="18" cy="18" r="15.9155" class="score-gauge-fg" stroke="url(#scoreGradient)" data-score="${score}"></circle></svg><div class="absolute inset-0 flex flex-col items-center justify-center"><span class="score-display ${isMain ? 'text-5xl' : 'text-3xl'} font-black transition-colors duration-500 ${scoreClass}">${Math.round(score)}</span>${isMain ? `<span class="text-xs font-bold -mt-1 ${scoreClass}">/ 100</span>` : ''}</div></div><p class="text-sm font-semibold text-white">${label}</p></div>`;
    };

    // --- Severely Upgraded Transaction Ledger Helper ---
    const createTransactionLedgerHTML = (transactions, walletType, walletAddress) => {
        if (reliableTransactionCount === 0) return `<div class="text-center text-text-muted py-12"><i class="fas fa-exchange-alt fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No On-Chain Transactions Found</p></div>`;
        const currency = walletType === 'BITCOIN' ? 'BTC' : 'USDT';
        return `
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Total Txs</p><p class="text-xl font-bold text-white">${reliableTransactionCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Inbound</p><p class="text-xl font-bold text-success-color">${inboundCount.toLocaleString()}</p></div>
                <div class="glass p-3 rounded-lg"><p class="text-xs text-text-muted">Outbound</p><p class="text-xl font-bold text-error-color">${outboundCount.toLocaleString()}</p></div>
            </div>
            <div id="transaction-ledger" class="space-y-3 max-h-[28rem] overflow-y-auto pr-2">
                ${transactions.map((tx, index) => {
                    const isInbound = tx.type === 'Receive';
                    return `
                    <div class="glass p-3 rounded-lg flex items-center justify-between gap-4 animate-fade-in-up" style="animation-delay: ${index * 30}ms">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isInbound ? 'bg-success-color/10 text-success-color' : 'bg-error-color/10 text-error-color'}">
                                <i class="fas ${isInbound ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div class="min-w-0">
                                <a href="${Logic.getExplorerUrl({type: walletType, address: walletAddress}, tx.hash)}" target="_blank" class="font-mono text-sm text-white truncate block hover:underline" title="View Transaction: ${tx.hash}">${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}</a>
                                <p class="text-xs text-text-muted">${Utils.calculateTimeAgo(tx.time)}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-mono font-semibold text-base ${isInbound ? 'text-success-color' : 'text-error-color'}">${isInbound ? '+' : '-'}${Utils.formatNumber(tx.amount, 6)} <span class="text-xs text-text-muted">${currency}</span></p>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
    };

    return `
        <div class="animate-fade-in-up">
            <div class="mb-8">
                <div class="glass p-5 rounded-2xl flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-wallet text-2xl text-primary-azure"></i>
                            <a href="${Logic.getExplorerUrl(wallet)}" target="_blank" class="font-mono text-lg text-white truncate hover:underline">${wallet.address}</a>
                            <button onclick="Utils.copyToClipboard('${wallet.address}', this)" class="text-text-muted hover:text-white relative group"><i class="fas fa-copy"></i><span class="copied-feedback absolute -top-8 left-1/2 -translate-x-1/2 text-xs bg-success-color text-white px-2 py-1 rounded-md opacity-0 pointer-events-none">Copied!</span></button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">${headerTags.map(tag => `<span class="text-xs font-bold px-3 py-1 rounded-full ${tag.class}">${tag.text}</span>`).join('')}</div>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-3">
                        <button id="pdf-export-btn" onclick="Logic.generateAndDownloadForensicsPDF()" class="btn-secondary px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                        <button id="submit-review-btn" onclick="Logic.initiateWalletSubmission()" class="btn-primary font-semibold px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-paper-plane mr-2"></i>Submit for Official Review
                        </button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-file-invoice text-primary-azure"></i>Executive Summary</h3><p class="text-text-secondary leading-relaxed">${Logic.generateExecutiveSummary(report)}</p></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-3"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-flag text-warning-color"></i>Compliance Risk Assessment</h3>${redFlags.length > 0 ? `<div class="space-y-4 max-h-[28rem] overflow-y-auto pr-2">${redFlags.map(flag => `<div class="glass p-4 rounded-xl border-l-4 ${'border-' + flag.level.toLowerCase()}-color"><div class="flex items-start gap-4"><i class="fas ${Utils.getRiskIcon(flag.level)} text-${flag.level.toLowerCase()}-color text-xl mt-1"></i><div><p class="font-bold text-${flag.level.toLowerCase()}-color">${flag.title}</p><p class="text-sm text-text-secondary mt-1">${flag.details}</p></div></div></div>`).join('')}</div>` : `<div class="text-center text-text-muted py-12"><i class="fas fa-check-circle text-success-color fa-3x mb-4"></i><p class="font-semibold text-text-secondary">No Significant Compliance Flags Detected</p></div>`}</div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-exchange-alt text-primary-sapphire"></i>On-Chain Transaction Ledger</h3>${createTransactionLedgerHTML(transactions, wallet.type, wallet.address)}</div>
                </div>
                <div class="lg:col-span-1 space-y-8">
                    <div class="report-section p-6 animate-fade-in-up stagger-1"><h3 class="text-xl font-bold text-white mb-6 text-center">Scoring Dashboard</h3>${createScoreGauge(integrityScore, 'Overall Integrity Score', 'w-40 h-40', true)}<div class="mt-8 border-t border-border-color pt-6 grid grid-cols-2 gap-6">${createScoreGauge(scoreBreakdown.provenance.score, 'Provenance', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.behavioral.score, 'Behavioral', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.temporal.score, 'Temporal', 'w-28 h-28')}${createScoreGauge(scoreBreakdown.compliance.score, 'Compliance', 'w-28 h-28')}</div></div>
                    <div class="report-section p-6 animate-fade-in-up stagger-2">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><i class="fas fa-microchip text-primary-royal"></i>Wallet Snapshot</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Balance (USD Eq.)</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${Utils.formatPrice(wallet.balance)}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Classification</dt><dd class="font-semibold text-white">${walletClassification.type}</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Wallet Age</dt><dd class="font-semibold text-white bg-background-dark/50 px-2 py-1 rounded font-mono">${wallet.ageInDays} Days</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Last Activity</dt><dd class="font-semibold text-white">${daysSinceLastTx} days ago</dd></div>
                            <div class="flex justify-between items-center"><dt class="text-text-muted">Tx Velocity</dt><dd class="font-semibold text-white">${transactionVelocity} tx/day</dd></div>
                        </div>
                    </div>
                    <div class="report-section p-6 animate-fade-in-up stagger-4"><h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-history text-primary-amethyst"></i>GECAN Provenance Timeline</h3><div class="relative">${provenance.records.length > 0 ? provenance.records.map((rec) => `<div class="timeline-item"><div class="timeline-dot"><div class="timeline-dot-inner ${uniqueControllers.length > 1 ? 'bg-critical-color' : 'bg-primary-azure'}"></div></div><p class="text-xs font-mono text-text-muted mb-1">${rec.date}</p><p class="font-semibold text-white">Controller: <span class="text-primary-azure">${rec.controller}</span></p><p class="text-xs text-text-secondary mt-1">Purpose: ${rec.purpose || 'Not specified'}</p></div>`).join('') : `<div class="text-center text-text-muted py-8"><i class="fas fa-question-circle text-warning-color fa-2x mb-3"></i><p class="font-semibold text-text-secondary text-sm">No GECAN Ledger Records</p></div>`}</div></div>
                </div>
            </div>
        </div>
    `;
},

        /**
     * [NEW & BENCHMARKED] Renders the referral ID validation modal, reused from index.html logic.
     */
    renderReferralValidationSuite: (title, subtitle) => {
    return `
        <div class="submission-dialog-content p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-bold">${title}</h2>
                <p class="mt-2">${subtitle}</p>
            </div>
            <div>
                <input type="text" id="referral-id-input" placeholder="Enter Partner Referral ID" class="submission-form-input text-center font-mono tracking-widest p-4">
            </div>
            <div id="referral-error" class="text-center bg-red-500/10 p-3 rounded-lg hidden"></div>
            <div class="flex flex-col sm:flex-row gap-4 pt-2">
                <button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel</button>
                <button id="validate-referral-btn" class="btn-primary w-full py-3 font-semibold">
                    <i class="fas fa-key mr-2"></i>Validate & Proceed
                </button>
            </div>
        </div>`;
},

    /**
     * [NEW & BENCHMARKED] Renders the official wallet submission form after successful validation.
     */
    renderWalletSubmissionSuite: (referralInfo) => {
    const { report } = AppState.walletAnalysis;
    return `
        <div class="submission-dialog-content max-w-3xl">
            <form id="wallet-submission-form">
                <!-- Header -->
                <div class="p-6 border-b border-border-color flex justify-between items-start flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold">Official Wallet Submission</h2>
                        <p class="mt-1">Confirm details for official GECAN ledger entry.</p>
                    </div>
                    <button type="button" onclick="document.getElementById('submission-modal').close()" class="text-2xl text-text-muted hover:text-white transition-colors">Ã—</button>
                </div>

                <!-- Scrollable Content -->
                <div class="p-6 space-y-6 overflow-y-auto">
                    <fieldset>
                        <legend>Transaction Context</legend>
                        <div class="space-y-4">
                            <div><label>Wallet Address to be Submitted</label><input type="text" class="submission-form-input" value="${report.wallet.address}" readonly></div>
                            <div><label>Target Offer ID (If Applicable)</label><select id="submission-offer-id" class="submission-form-select"></select></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Your Details (Submitter)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label>Your Full Name*</label><input type="text" id="submitter-name" class="submission-form-input" placeholder="e.g., Jane Smith" required></div>
                            <div><label>Your Role*</label><input type="text" id="submitter-role" class="submission-form-input" placeholder="e.g., Mandate, Broker" required></div>
                            <div><label>Your Contact Email*</label><input type="email" id="submitter-email" class="submission-form-input" placeholder="you@example.com" required></div>
                            <div><label>Your Contact Phone*</label><input type="tel" id="submitter-phone" class="submission-form-input" placeholder="+1 555 123 4567" required></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Alleged Wallet Controller</legend>
                        <div class="space-y-4">
                            <div><label>Principal / Entity Name*</label><input type="text" id="controller-name" class="submission-form-input" placeholder="e.g., John Doe / XYZ Trading LLC" required></div>
                            <div class="recommendation-box">
                                <h4>Recommendation</h4>
                                <p>For expedited review, it is highly recommended to provide the alleged controller's Customer Information Sheet (CIS) and Proof of Funds (POF) via secure email to <strong>compliance@gecan.co</strong> after submission.</p>
                            </div>
                        </div>
                    </fieldset>
                    
                    <div><label>Referring Partner</label><input type="text" class="submission-form-input" value="${referralInfo.partnerName} (${referralInfo.referralId})" readonly></div>
                </div>

                <!-- Footer / Actions -->
                <div class="p-6 border-t border-border-color mt-auto flex flex-col sm:flex-row gap-4 flex-shrink-0">
                    <button type="button" onclick="document.getElementById('submission-modal').close()" class="btn-secondary w-full py-3">Cancel Submission</button>
                    <button type="submit" id="confirm-submission-btn" class="btn-primary w-full py-3 font-semibold bg-gradient-to-r from-success-color to-emerald-600 border-success-color">
                        <i class="fas fa-check-circle mr-2"></i>Confirm & Submit to Ledger
                    </button>
                </div>
            </form>
        </div>`;
},
    /**
     * Renders the main container for the Institutional Modeler toolkit, including the deal type selection.
     * @returns {string} The HTML structure for the modeler interface.
     */
    renderInstitutionalModelerUI: () => {
    const dealTypes = [
        { id: 'AssetSwap', name: 'Asset Swap', icon: 'fa-exchange-alt', desc: 'Model direct conversions between assets in the GECAN matrix.', gradient: 'from-blue-500 to-cyan-500' },
        { id: 'CommodityTrade', name: 'Commodity Trade', icon: 'fa-oil-can', desc: 'Structure physical commodity trades with institutional-grade parameters.', gradient: 'from-yellow-500 to-orange-500' },
        { id: 'CryptoLoan', name: 'Crypto Loan', icon: 'fa-hand-holding-usd', desc: 'Originate crypto-collateralized credit facilities with flexible terms.', gradient: 'from-green-500 to-emerald-500' },
        { id: 'SBLCMonetization', name: 'SBLC Monetization', icon: 'fa-file-invoice-dollar', desc: 'Monetize standby letters of credit to unlock institutional capital.', gradient: 'from-purple-500 to-violet-500' },
    ];
    return `<div class="flex flex-col gap-8 animate-fade-in-up"><div class="report-section p-6"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white"><i class="fas fa-sitemap text-primary-azure mr-3"></i>Institutional Deal Modeler</h2><button onclick="Logic.resetModelerState()" class="btn-secondary px-4 py-2 text-sm rounded-lg hover:bg-error-color/20 hover:border-error-color/50 hover:text-error-color whitespace-nowrap"><i class="fas fa-undo mr-2"></i>Reset All Parameters</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${dealTypes.map((deal, index) => `<div class="deal-type-card glass p-6 text-center ${AppState.modeler.activeDealType === deal.id ? 'active' : ''}" onclick="Logic.handleDealTypeChange('${deal.id}')"><div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${deal.gradient} flex items-center justify-center mb-4 text-2xl deal-type-icon mx-auto"><i class="fas ${deal.icon}"></i></div><h3 class="text-lg font-bold text-white mb-1">${deal.name}</h3><p class="text-sm text-text-muted leading-relaxed">${deal.desc}</p></div>`).join('')}</div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-8 relative"><div id="modeler-input-container" class="lg:col-span-3 glass p-6 md:p-8 rounded-2xl flex flex-col"></div><div id="modeler-output-container" class="lg:col-span-2 glass p-6 md:p-8 rounded-2xl flex flex-col"></div></div></div>`;
},

    /**
     * Renders the main input panel for the Modeler, including the collapsible pricing configuration.
     * @returns {string} The HTML for the input panel.
     */
    renderModelerInputPanel: () => {
    const { activeDealType, pricingConfig } = AppState.modeler;
    const dealPanelRenderer = UI[`render${activeDealType}Panel`];
    const dealPanelHTML = dealPanelRenderer ? dealPanelRenderer() : `<p class="text-error-color">Error: Input panel for ${activeDealType} not found.</p>`;
    const pricingConfigHTML = `<div class="collapsible-content ${pricingConfig.isVisible ? 'expanded' : ''}"><div class="grid grid-cols-2 gap-4 mb-4"><select data-path="pricingConfig.offerType" class="form-select">${['discount','premium'].map(o => `<option value="${o}" ${pricingConfig.offerType === o ? 'selected' : ''}>${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('')}</select><select data-path="pricingConfig.isValueInPercent" class="form-select">${[[true, '%'], [false, '$']].map(([v,l]) => `<option value="${String(v)}" ${String(pricingConfig.isValueInPercent) === String(v) ? 'selected' : ''}>Value in ${l}</option>`).join('')}</select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Gross Offer</label><input type="number" data-path="pricingConfig.grossValue" value="${pricingConfig.grossValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Net to Buyer</label><input type="number" data-path="pricingConfig.netValue" value="${pricingConfig.netValue}" class="form-input"></div></div></div>`;
    return `<h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-sliders-h text-primary-azure"></i>Deal Parameters</h2><div class="space-y-6"><div class="p-4 rounded-lg bg-background-dark border border-border-color"><h4 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fas fa-file-contract text-primary-azure"></i>Transaction Core</h4><div class="space-y-4 mt-4">${dealPanelHTML}</div></div><div class="p-4 rounded-lg bg-background-dark border border-border-color"><div class="flex justify-between items-center cursor-pointer" onclick="Logic.togglePricingConfig()"><h4 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fas fa-percent text-primary-azure"></i>Pricing & Configuration</h4><i class="fas fa-chevron-down transition-transform ${pricingConfig.isVisible ? 'rotate-180' : ''}"></i></div>${pricingConfigHTML}</div></div>`;
},

    /**
 * Renders the specific input fields for the Asset Swap deal type.
 * @returns {string} The HTML for the Asset Swap panel.
 */
renderAssetSwapPanel: () => {
    const state = AppState.modeler.assetSwap;
    const assetOptions = (selectedKey) => AppState.marketData
        .filter(a => a.type !== 'Cross-Rate' && a.price > 0)
        .sort((a, b) => a.baseAsset.localeCompare(b.baseAsset))
        .map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const fromAsset = Utils.getAssetByKey(state.fromAssetKey);
    return `<div class="flex items-center gap-4"><div class="flex-1"><label class="block text-sm font-medium text-text-muted mb-2">From Asset</label><select data-path="assetSwap.fromAssetKey" class="form-select">${assetOptions(state.fromAssetKey)}</select></div><div class="pt-8"><button onclick="Logic.swapAssets()" class="w-10 h-10 flex items-center justify-center rounded-full bg-primary-azure/20 text-primary-azure hover:bg-primary-azure/30 transition-all duration-300" title="Swap Assets"><i id="swap-icon" class="fas fa-exchange-alt"></i></button></div><div class="flex-1"><label class="block text-sm font-medium text-text-muted mb-2">To Asset</label><select data-path="assetSwap.toAssetKey" class="form-select">${assetOptions(state.toAssetKey)}</select></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Amount to Swap (<span class="font-bold text-white">${fromAsset.baseAsset || 'N/A'}</span>)</label><input type="text" data-path="assetSwap.amount" value="${(parseFloat(state.amount) || 0).toLocaleString()}" class="form-input text-lg font-bold"></div>`;
},

/**
 * SEVERELY ENHANCED: Renders the multi-step, interactive UI for structuring a physical commodity trade.
 * @returns {string} The complete HTML for the Commodity Trade panel.
 */
renderCommodityTradePanel: () => {
    const state = AppState.modeler.commodityTrade;
    const commodityAsset = Utils.getAssetByKey(state.assetKey);

    const commodityOptions = (selectedKey) => AppState.marketData.filter(asset => ['Crude Oil', 'Refined Fuel', 'Precious Metal', 'Commodity', 'Energy'].some(term => asset.type?.includes(term))).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.key})</option>`).join('');
    const settlementOptions = (selectedKey) => AppState.marketData.filter(a => a.price > 0 && a.key !== state.assetKey).sort((a,b) => a.baseAsset.localeCompare(b.baseAsset)).map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset}</option>`).join('');
    const selectedIncoterm = commodityData.incoterms.find(i => i.value === state.incoterms) || commodityData.incoterms.find(i => i.value === 'FOB');

    const pricingModelInputs = () => {
        if (state.pricingModel === 'Fixed') {
            return `<div><label class="block text-sm font-medium text-text-muted mb-2">Fixed Price per Unit (USD)</label><input type="number" step="0.01" data-path="commodityTrade.fixedPrice" value="${state.fixedPrice}" class="form-input"></div>`;
        }
        if (state.pricingModel === 'Discount' || state.pricingModel === 'Premium') {
            return `<div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">${state.pricingModel} Value</label><input type="number" step="0.01" data-path="commodityTrade.discountPremiumValue" value="${state.discountPremiumValue}" class="form-input"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Value Type</label><select data-path="commodityTrade.discountPremiumIsInPercent" class="form-select"><option value="true" ${state.discountPremiumIsInPercent ? 'selected':''}>Percentage (%)</option><option value="false" ${!state.discountPremiumIsInPercent ? 'selected':''}>Fixed Amount ($)</option></select></div></div>`;
        }
        return '';
    };

    return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2"><label class="block text-sm font-medium text-text-muted mb-2">Commodity Asset</label><select data-path="commodityTrade.assetKey" class="form-select">${commodityOptions(state.assetKey)}</select></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">Quantity</label><input type="number" data-path="commodityTrade.quantity" value="${state.quantity || ''}" class="form-input font-bold"></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Unit of Measure</label><select data-path="commodityTrade.unitOfMeasure" class="form-select"><option value="">Select unit...</option>${commodityData.unitsOfMeasure.map(u => `<option value="${u}" ${state.unitOfMeasure === u ? 'selected' : ''}>${u}</option>`).join('')}</select></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-text-muted mb-2">Origin Country</label><input list="countries-datalist" value="${state.origin || ''}" data-path="commodityTrade.origin" class="form-input"><datalist id="countries-datalist">${commodityData.countries.map(c => `<option value="${c}">`).join('')}</datalist></div>
                <div><label class="block text-sm font-medium text-text-muted mb-2">${selectedIncoterm.port}</label><input list="ports-datalist" value="${state.port || ''}" data-path="commodityTrade.port" class="form-input"><datalist id="ports-datalist">${commodityData.ports.map(p => `<option value="${p}">`).join('')}</datalist></div>
            </div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">IncotermsÂ® 2020</label><select data-path="commodityTrade.incoterms" class="form-select">${commodityData.incoterms.map(i => `<option value="${i.value}" ${state.incoterms === i.value ? 'selected' : ''}>${i.label}</option>`).join('')}</select><p class="text-xs text-text-muted mt-2">Risk transfers to <strong>${selectedIncoterm.risk}</strong> â€¢ Cost responsibility: ${selectedIncoterm.cost}</p></div>
            <div><label class="block text-sm font-medium text-text-muted mb-2">Pricing Model</label><div class="flex flex-wrap gap-2">${['Market', 'Discount', 'Premium', 'Fixed'].map(p => `<label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer ${state.pricingModel === p ? 'bg-primary-azure/20' : 'bg-background-light'}"><input type="radio" name="pricingModel" value="${p}" ${state.pricingModel === p ? 'checked' : ''} data-path="commodityTrade.pricingModel" class="hidden">${p}</label>`).join('')}</div></div>
            ${pricingModelInputs()}
            <div><label class="block text-sm font-medium text-text-muted mb-2">Settlement Asset</label><select data-path="commodityTrade.settlementAssetKey" class="form-select"><option value="USD">USD (Default)</option>${settlementOptions(state.settlementAssetKey)}</select></div>
        </div>`;
},

/**
 * Renders the specific input fields for the Crypto Loan deal type.
 * @returns {string} The HTML for the Crypto Loan panel.
 */
renderCryptoLoanPanel: () => {
    const state = AppState.modeler.cryptoLoan;
    const assetOptions = (selectedKey) => AppState.marketData.filter(a => a.type === 'Cryptocurrency').map(a => `<option value="${a.key}" ${selectedKey === a.key ? 'selected' : ''}>${a.baseAsset} (${a.quoteAsset})</option>`).join('');
    const currencyOptions = () => ['USD', 'EUR', 'HKD', 'USDT'].sort().map(c => `<option value="${c}" ${state.loanCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
    return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Asset</label><select data-path="cryptoLoan.collateralAssetKey" class="form-select">${assetOptions(state.collateralAssetKey)}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Collateral Amount</label><input type="text" data-path="cryptoLoan.collateralAmount" value="${state.collateralAmount.toLocaleString()}" class="form-input text-lg font-bold"></div></div><div><label class="block text-sm font-medium text-text-muted mb-2">Loan-to-Value (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="cryptoLoan.ltv" min="10" max="90" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="cryptoLoan.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Loan Currency</label><select data-path="cryptoLoan.loanCurrency" class="form-select">${currencyOptions()}</select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Tenure (Months)</label><input type="number" data-path="cryptoLoan.tenureMonths" value="${state.tenureMonths}" class="form-input"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-text-muted mb-2">Interest Rate Type</label><select data-path="cryptoLoan.interestRateType" class="form-select"><option value="fixed" ${state.interestRateType === 'fixed' ? 'selected' : ''}>Fixed</option><option value="floating" ${state.interestRateType === 'floating' ? 'selected' : ''}>Floating</option></select></div><div><label class="block text-sm font-medium text-text-muted mb-2">Annual Interest Rate (%)</label><input type="number" step="0.1" data-path="cryptoLoan.interestRateValue" value="${state.interestRateValue}" class="form-input"></div></div>`;
},

/**
 * Renders the specific input fields for the SBLC Monetization deal type.
 * @returns {string} The HTML for the SBLC Monetization panel.
 */
renderSBLCMonetizationPanel: () => {
    const state = AppState.modeler.sblcMonetization;
    return `<div><label class="block text-sm font-medium text-text-muted mb-2">Instrument Face Value (USD)</label><input type="text" data-path="sblcMonetization.faceValue" value="${state.faceValue.toLocaleString()}" class="form-input text-lg font-bold"></div><div><label class="block text-sm font-medium text-text-muted mb-2">Monetization (LTV)</label><div class="flex items-center gap-4"><input type="range" data-path="sblcMonetization.ltv" min="50" max="95" value="${state.ltv}" class="w-full h-2 bg-background-secondary rounded-lg appearance-none cursor-pointer"><div class="relative w-28"><input type="number" data-path="sblcMonetization.ltv" value="${state.ltv}" class="form-input text-lg text-center font-bold pr-6"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div></div></div>`;
},

/**
 * Renders the main output panel, dynamically displaying results for the active model.
 * @param {object|null} calc - The full calculation object from Logic.calculateModel().
 * @returns {string} The HTML for the output/analysis panel.
 */
renderModelerOutputPanel: (calc) => {
    if (!calc) return `<div class="flex items-center justify-center h-full text-center text-text-muted"><i class="fas fa-calculator fa-2x mr-4"></i>Awaiting parameters...</div>`;
    let customOutput = '';
    if (AppState.modeler.activeDealType === 'AssetSwap') {
        const { fromAsset, toAsset, rate } = calc; const rateDisplay = rate > 0 ? rate.toFixed(8) : 'N/A';
        customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-sync-alt"></i>Institutional Cross Rate</p><p class="value">${rateDisplay}</p><p class="sub-value">1 ${fromAsset.baseAsset} â‰ˆ ${rateDisplay} ${toAsset.baseAsset}</p></div>`;
    } else if (AppState.modeler.activeDealType === 'CryptoLoan') {
        const monthlyPayment = calc.totalRepayment / (calc.tenureMonths || 1);
        customOutput = `<div class="output-metric-card"><p class="label"><i class="fas fa-hand-holding-usd"></i>Loan Principal</p><p class="value">${Utils.formatPrice(calc.loanPrincipal, calc.loanCurrency)}</p><p class="sub-value">Total Repayment: ${Utils.formatPrice(calc.totalRepayment, calc.loanCurrency)}</p></div><div class="output-metric-card mt-4"><p class="label"><i class="fas fa-calendar-alt"></i>Monthly Repayment</p><p class="value">${Utils.formatPrice(monthlyPayment, calc.loanCurrency)}</p><p class="sub-value">${calc.tenureMonths}-month tenure @ ${calc.interestRateValue}% fixed</p></div><div class="mt-4"><h4 class="text-sm font-semibold text-text-secondary mb-2">Projected Loan Balance Over Time</h4><div class="yield-graph-container h-40">${UI.renderYieldGraph(calc)}</div></div>`;
    }
    return `<div class="flex flex-col h-full animate-fade-in-up"><h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-success-color"></i>Deal Analysis & Projections</h2><div class="space-y-4 flex-grow"><div class="output-metric-card base-value"><p class="label"><i class="fas fa-tags"></i>Base/Market Value</p><p class="value">${Utils.formatPrice(calc.baseValueUSD)}</p><p class="sub-value">${calc.dealTitle}</p></div><div class="output-metric-card net"><p class="label"><i class="fas fa-hand-holding-dollar"></i>Net Value to Buyer</p><p class="value">${Utils.formatPrice(calc.finalValueToBuyerUSD)}</p><p class="sub-value">${calc.netValueDescription}</p></div><div class="output-metric-card commission"><p class="label"><i class="fas fa-coins"></i>Total Commission Pool</p><p class="value">${Utils.formatPrice(calc.totalCommissionPool)}</p><p class="sub-value">${calc.grossValueDescription}</p></div>${customOutput}</div><div class="mt-auto pt-6 border-t border-border-color"><button onclick="Logic.openImfpaModal()" class="btn-primary w-full py-3 font-bold"><i class="fas fa-file-signature mr-2"></i>Launch IMFPA & Commission Manager</button></div></div>`;
},

/**
 * Renders a simple SVG yield graph for the Crypto Loan model.
 * @param {object} calc - The calculation object for the Crypto Loan.
 * @returns {string} An SVG string representing the graph.
 */
renderYieldGraph: (calc) => {
    const { loanPrincipal, totalRepayment, tenureMonths } = calc;
    if (tenureMonths <= 0) return '<p class="text-center text-text-muted text-sm">Invalid tenure for graph.</p>';
    const points = Array.from({length: tenureMonths + 1}, (_, i) => ({ month: i, value: loanPrincipal + ((totalRepayment - loanPrincipal) / tenureMonths * i) }));
    const width=300, height=120, marginY=20, marginX=30; const yMax = totalRepayment, yMin = loanPrincipal;
    const xScale = (width - marginX*2) / tenureMonths; const yScale = (yMax > yMin) ? (height - marginY*2) / (yMax - yMin) : 0;
    const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${(marginX + p.month * xScale).toFixed(2)} ${(height - marginY - ((p.value - yMin) * yScale)).toFixed(2)}`).join(' ');
    return `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full"><line x1="${marginX}" y1="${height-marginY}" x2="${width-marginX}" y2="${height-marginY}" stroke="var(--border-color)"/><text x="${marginX-5}" y="${marginY+5}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMax, 0)}</text><text x="${marginX-5}" y="${height-marginY}" text-anchor="end" font-size="10" fill="var(--text-muted)">${Utils.formatNumber(yMin, 0)}</text><path d="${pathData}" fill="none" stroke="var(--success-color)" stroke-width="2"/></svg>`;
},

/**
 * Renders the main shell and layout for the IMFPA & Commission Manager modal.
 * @returns {string} The complete HTML structure for the modal.
 */
renderImfpaModal: () => {
    const { legal } = AppState.modeler;
    return `
        <div class="dialog-content-wrapper">
            <div class="p-6 md:p-8 flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-start mb-6 imfpa-header print-hide">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Commission & Contract Suite</h2>
                        <p class="text-text-secondary">Synthesize the Irrevocable Master Fee Protection Agreement.</p>
                    </div>
                    <button onclick="document.getElementById('imfpa-modal').close()" class="text-3xl text-text-muted hover:text-white transition-colors">Ã—</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 overflow-y-auto pr-4 -mr-4">
                    <!-- Left: Allocation -->
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="imfpa-section-title"><i class="fas fa-sitemap mr-3 text-primary-color"></i>Commission Allocation</h3>
                            <div class="text-right">
                                <p class="text-xs text-text-muted">Total Pool</p>
                                <p id="imfpa-total-commission-pool" class="text-2xl font-bold text-primary-color">${Utils.formatPrice(legal.totalCommission)}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <button onclick="Logic.addImfpaGroup()" class="btn-secondary px-3 py-1 text-sm rounded-lg"><i class="fas fa-plus mr-1"></i>Add Group</button>
                            <div id="imfpa-total-allocated" class="text-right font-mono text-sm"></div>
                        </div>
                        <div class="space-y-4" id="imfpa-groups-container"></div>
                    </div>
                    <!-- Right: Legal Details -->
                    <div class="space-y-6">
                        <h3 class="imfpa-section-title"><i class="fas fa-gavel mr-3 text-accent-color"></i>Legal Framework</h3>
                        <div class="input-group">
                            <h4 class="input-group-title"><i class="fas fa-landmark text-primary-color"></i>Governing Law & Jurisdiction</h4>
                            <input value="${legal.jurisdiction}" data-path="legal.jurisdiction" class="form-input" placeholder="e.g., Singapore, Dubai, England, Wales">
                        </div>
                        <div class="input-group">
                            <h4 class="input-group-title"><i class="fas fa-users text-primary-color"></i>Signatory Parties</h4>
                            <div class="text-xs text-text-muted mb-2">A comprehensive list of all signatories.</div>
                            <div id="imfpa-legal-parties" class="space-y-2 text-sm text-text-secondary"></div>
                        </div>
                        <div class="input-group">
                            <h4 class="input-group-title"><i class="fas fa-link text-primary-color"></i>Cross-Referenced Contract / SPA (Optional)</h4>
                            <input value="${legal.spaReferenceCode || ''}" data-path="legal.spaReferenceCode" class="form-input font-mono" placeholder="e.g., GECAN-SPA-XYZ-12345">
                        </div>
                    </div>
                </div>
                <div class="pt-6 border-t border-border-color mt-auto print-hide">
                    <button onclick="Logic.generateContract()" class="btn-primary w-full py-3 font-bold">
                        <i class="fas fa-file-signature mr-2"></i>Synthesize & Preview IMFPA/NCNDA
                    </button>
                    <div id="contract-preview-container" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    `;
},

/**
 * Renders the HTML for all allocation groups and their nested parties.
 * @returns {string} The complete HTML string for all groups.
 */
renderImfpaGroups: () => {
    const { groups } = AppState.modeler.legal;
    return groups.map((g, groupIndex) => `<div class="allocation-group-card animate-fade-in-up"><div class="flex items-center gap-2 mb-3"><input type="text" value="${g.name}" data-path="legal.groups[${groupIndex}].name" class="form-input bg-transparent border-0 flex-grow !p-1 focus:ring-0 font-semibold text-lg !text-text-primary"><div class="relative w-32"><input type="number" value="${g.percentage}" data-path="legal.groups[${groupIndex}].percentage" class="form-input text-right font-bold"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div><button onclick="Logic.removeImfpaGroup(${groupIndex})" class="text-red-500 hover:text-red-400 text-xl font-bold w-8 h-8 flex items-center justify-center transition">Ã—</button></div><p id="imfpa-group-value-${groupIndex}" class="text-right text-primary-azure font-mono text-lg mb-4"></p><div class="space-y-2 pl-4 border-l-2 border-border-accent">${g.parties.map((p, partyIndex) => UI.renderImfpaParty(groupIndex, partyIndex)).join('')}<div class="flex justify-between items-center pt-2"><button onclick="Logic.addImfpaParty(${groupIndex})" class="text-primary-azure hover:text-white text-xs font-semibold"><i class="fas fa-user-plus mr-1"></i>Add Party</button><div id="imfpa-group-total-${groupIndex}" class="text-right font-mono text-xs"></div></div></div></div>`).join('') || `<p class="text-center text-text-muted py-4">No allocation groups defined.</p>`;
},

/**
 * Renders the HTML for a single party within an allocation group.
 * @param {number} groupIndex - The index of the parent group.
 * @param {number} partyIndex - The index of the party within the group.
 * @returns {string} The HTML for the party card.
 */
renderImfpaParty: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
    return `<div class="allocation-party-card"><div class="flex items-center gap-2"><input type="text" value="${party.legalName || ''}" data-path="${base}.legalName" class="form-input bg-transparent border-0 flex-grow !p-1 !text-sm focus:ring-0 !text-text-primary" placeholder="Full Legal Name"><div class="relative w-24"><input type="number" value="${party.percentage}" data-path="${base}.percentage" class="form-input !text-sm text-right"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">%</span></div><button onclick="Logic.removeImfpaParty(${groupIndex}, ${partyIndex})" class="text-text-muted hover:text-red-500 text-lg w-6 h-6 flex items-center justify-center transition">Ã—</button></div><div class="mt-2"><a onclick="Logic.togglePartyDetails(${groupIndex}, ${partyIndex})" class="text-xs text-primary-amethyst cursor-pointer hover:underline flex items-center gap-1 w-full"><i class="fas fa-user-cog"></i> Manage Details <i class="fas fa-chevron-down text-xs transition-transform ${party.detailsVisible ? 'rotate-180' : ''} ml-auto"></i></a></div><div class="collapsible-content ${party.detailsVisible ? 'expanded' : ''}"><div>${UI.renderImfpaPartyDetails(groupIndex, partyIndex)}</div></div></div>`;
},

/**
 * Renders the detailed input fields for a single party (passport, payment info, etc.).
 * @param {number} groupIndex - The index of the parent group.
 * @param {number} partyIndex - The index of the party within the group.
 * @returns {string} The HTML for the party's detail form.
 */
renderImfpaPartyDetails: (groupIndex, partyIndex) => {
    const party = AppState.modeler.legal.groups[groupIndex].parties[partyIndex];
    const base = `legal.groups[${groupIndex}].parties[${partyIndex}]`;
    const paymentDetailsPlaceholder = { 'Bank Wire': 'IBAN, SWIFT, Bank Info...', 'USDT TRC-20': 'TRC-20 Wallet Address', 'USDT ERC-20': 'ERC-20 Wallet Address' }[party.payment.method] || 'Details...';
    return `<div class="party-details-grid"><div><span class="party-detail-label">Role</span><input class="form-input !text-xs" value="${party.role || ''}" data-path="${base}.role" placeholder="e.g., Mandate"></div><div><span class="party-detail-label">Email</span><input type="email" class="form-input !text-xs" value="${party.email || ''}" data-path="${base}.email" placeholder="contact@email.com"></div><div><span class="party-detail-label">Contact Number</span><input class="form-input !text-xs" value="${party.contactNumber || ''}" data-path="${base}.contactNumber" placeholder="+1-555-123-4567"></div><div><span class="party-detail-label">Passport No.</span><input class="form-input !text-xs" value="${party.passport.number || ''}" data-path="${base}.passport.number" placeholder="P12345678"></div><div><span class="party-detail-label">Passport Issue Date</span><input type="date" class="form-input !text-xs" value="${party.passport.issueDate || ''}" data-path="${base}.passport.issueDate"></div><div><span class="party-detail-label">Passport Expiry Date</span><input type="date" class="form-input !text-xs" value="${party.passport.expiryDate || ''}" data-path="${base}.passport.expiryDate"></div><div class="col-span-2"><span class="party-detail-label">Passport Issuing Authority</span><input class="form-input !text-xs" value="${party.passport.authority || ''}" data-path="${base}.passport.authority" placeholder="USA"></div><div class="col-span-2 pt-2 mt-2 border-t border-border-secondary"><span class="party-detail-label font-bold">Payment Method</span></div><div><select class="form-select !text-xs" data-path="${base}.payment.method"><option value="Bank Wire" ${party.payment.method === 'Bank Wire' ? 'selected':''}>Bank Wire</option><option value="USDT TRC-20" ${party.payment.method === 'USDT TRC-20' ? 'selected':''}>USDT (TRC-20)</option><option value="USDT ERC-20" ${party.payment.method === 'USDT ERC-20' ? 'selected':''}>USDT (ERC-20)</option></select></div><div><select class="form-select !text-xs" data-path="${base}.payment.currency"><option value="USD" ${party.payment.currency === 'USD' ? 'selected':''}>USD</option><option value="USDT" ${party.payment.currency === 'USDT' ? 'selected':''}>USDT</option><option value="EUR" ${party.payment.currency === 'EUR' ? 'selected':''}>EUR</option></select></div><div class="col-span-2"><span class="party-detail-label">Payment Coordinates</span><textarea class="form-input !text-xs font-mono" data-path="${base}.payment.details" rows="3" placeholder="${paymentDetailsPlaceholder}">${party.payment.details || ''}</textarea></div></div>`;
}
};

        // --- SECTION 5: INITIALIZATION ---
        const initInteractiveBackground = () => {
            const vortex = document.getElementById('background-vortex');
            if (!vortex) return;
            let targetX = window.innerWidth / 2, targetY = window.innerHeight / 2;
            let currentX = targetX, currentY = targetY;
            document.addEventListener('mousemove', (e) => { targetX = e.clientX; targetY = e.clientY; });
            const animate = () => { currentX += (targetX - currentX) * 0.05; currentY += (targetY - currentY) * 0.05; vortex.style.transform = `translate(-50%, -50%) translate3d(${currentX}px, ${currentY}px, 0)`; requestAnimationFrame(animate); };
            animate();
        };
        
        document.addEventListener('DOMContentLoaded', Logic.init);

    </script>
</body>
</html>
