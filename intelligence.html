<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <base target="_top">
    <title>GECANâ„¢ Network Intelligence Suite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v5.0 (INTELLIGENCE SUITE EDITION) === */
        /* This stylesheet is the definitive standard, ensuring visual consistency */
        /* with the entire GECAN platform, plus Intelligence-specific enhancements. */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --text-premium-gold: #EAE0C8;
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9); --glow-royal: rgba(139, 92, 246, 0.8);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444; --critical-color: #dc2626;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); transform: rotateY(180deg); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); }

        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
        @keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }

        /* --- D. INTELLIGENCE SUITE STYLES (SEVERELY ENHANCED) --- */
        .glass-card { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-primary:disabled { background: var(--background-secondary); border-color: var(--border-color); color: var(--text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
        .form-input, .form-select { background-color: var(--background-dark); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-azure); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 2px 4px rgba(0,0,0,0.3); }
        
        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .report-section { background: var(--background-glass); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1.5rem; transition: all 0.5s ease; }
        
        .contact-card {
            border: 1px solid var(--border-secondary);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(145deg, #161d31, #0a0f1c);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }
        .contact-card:hover {
            transform: translateY(-8px) scale(1.02) perspective(1000px) rotateX(3deg);
            border-color: var(--primary-azure);
            box-shadow: 0 0 40px var(--glow-azure), 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        .status-indicator-ring { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: var(--background-dark); padding: 4px; transition: transform 0.3s ease; }
        .contact-card:hover .status-indicator-ring { transform: scale(1.1) translateZ(10px); }
        .status-ring-ACTIVE { border: 2px solid var(--success-color); box-shadow: 0 0 10px var(--success-color); }
        .status-ring-INACTIVE { border: 2px solid var(--text-muted); }
        .status-ring-BLACKLISTED { border: 2px solid var(--error-color); box-shadow: 0 0 10px var(--error-color); }
        .status-ring-UNKNOWN { border: 2px solid var(--warning-color); }
        .status-indicator-ring > div { width: 100%; height: 100%; border-radius: 50%; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
        .status-dot-ACTIVE { background: radial-gradient(circle, var(--success-color), #16a34a); }
        .status-dot-INACTIVE { background: radial-gradient(circle, var(--text-muted), #4b5563); }
        .status-dot-BLACKLISTED { background: radial-gradient(circle, var(--error-color), #dc2626); }
        .status-dot-UNKNOWN { background: radial-gradient(circle, var(--warning-color), #ca8a04); }
        
        .card-details { max-height: 0; overflow: hidden; transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), padding 0.6s ease, margin 0.6s ease; padding-top: 0; padding-bottom: 0; margin-top: 0; border-top: 1px solid transparent; }
        .card-details.expanded { max-height: 1000px; padding-top: 1rem; margin-top: 1rem; border-top-color: var(--border-color); }

        .legitimacy-bar-container { background-color: var(--background-dark); border: 1px solid var(--border-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }
        .legitimacy-bar-fill { height: 10px; border-radius: 9999px; transition: width 1.2s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 10px var(--bar-color, var(--primary-color)); }
        .legitimacy-high { --bar-color: var(--success-color); background: linear-gradient(90deg, #16a34a, #22c55e, #4ade80); }
        .legitimacy-medium { --bar-color: var(--warning-color); background: linear-gradient(90deg, #ca8a04, #eab308, #facc15); }
        .legitimacy-low { --bar-color: var(--error-color); background: linear-gradient(90deg, #dc2626, #ef4444, #f87171); }

        .autocomplete-suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background-color: var(--background-light); border: 1px solid var(--border-accent);
            border-radius: 0.75rem; margin-top: 0.5rem; max-height: 250px; overflow-y: auto;
            z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; }
        .suggestion-item:hover, .suggestion-item.active { background: var(--gradient-primary); }
        .suggestion-item .name { font-weight: 600; color: var(--text-primary); }
        .suggestion-item .entity { font-size: 0.75rem; color: var(--text-secondary); }
        
        .selected-contact-display {
            position: absolute; inset: 1px; background-color: var(--background-accent);
            border-radius: 0.6rem; display: flex; align-items: center;
            justify-content: space-between; padding: 0 0.75rem; cursor: pointer;
        }
        .selected-contact-display .icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .selected-contact-display .name { color: var(--primary-azure); font-weight: 500; padding-left: 1.75rem; }
        .selected-contact-display .clear-btn { color: var(--text-muted); font-size: 1.25rem; line-height: 1; transition: color 0.2s ease; }
        .selected-contact-display:hover .clear-btn { color: var(--error-color); }

        .goal-btn {
            background-color: var(--background-secondary); border: 1px solid var(--border-color);
            color: var(--text-secondary); transition: all 0.3s ease;
        }
        .goal-btn:hover:not(.active) { border-color: var(--primary-azure); color: var(--text-diamond); }
        .goal-btn.active { background: var(--gradient-primary); border-color: var(--primary-azure); color: white; box-shadow: 0 0 20px var(--glow-azure); }

        #path-results-tbody tr { transition: background-color 0.3s ease, border-left-color 0.3s ease; }
        #path-results-tbody tr.selected-path { background-color: rgba(14, 165, 233, 0.1); border-left: 3px solid var(--primary-azure); }
        .path-details-row.hidden { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <div id="particles-js"></div>
    
    <!-- PREMIUM HEADER (BENCHMARKED & UNIFIED) -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECANâ„¢</div>
                        <div class="logo-face logo-back">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMiwyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" alt="GECAN Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Network Intelligence</h1>
                        <p class="text-sm text-gray-400 font-mono">Proprietary Contact Ledger</p>
                    </div>
                </a>
            </div>
            <nav id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">
                <!-- Navigation is dynamically injected by JavaScript -->
            </nav>
            <div id="welcome-banner" class="hidden lg:block text-right"></div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-4 md:p-8">
        <!-- The entire UI will be dynamically rendered here by JavaScript -->
    </main>
    
    <footer class="mt-auto pt-16">
        <div class="container mx-auto p-6 md:p-10 border-t border-border-color">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-text-silver">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECANâ„¢</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-text-muted">Â© 2025 GECANâ„¢. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECANâ„¢ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECANâ„¢ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

<script>
        // ====================================================================================
        // === GECANâ„¢ INTELLIGENCE ENGINE v8.0 (SUPREME UNIFIED STANDARD) ===
        // This is the definitive, production-grade, and fully synthesized script for the
        // Intelligence Suite. It unifies all logic into one cohesive block, resolves all
        // previous TypeErrors and regressions, uses the modern createApiRequest protocol,
        // and renders a severely upgraded, state-driven, and interactive UI without brevity
        // or compromise. Every original function has been re-architected and elevated.
        // ====================================================================================
        
        (function() {
            'use strict';
            
            const API_URL = "https://script.google.com/macros/s/AKfycbwrrMjSFDAwywkZ5stFEOiX8_58qm8CZVw5-m0OOQenJPK4ez41mfqfX5bLcQupY-nu/exec";

            const AppState = { 
                allContacts: [], 
                filteredContacts: [],
                allOffers: [],
                userAccessCode: null,
                userAccessTier: null,
                partnerName: null,
                currentPage: 1, 
                contactsPerPage: 12,
                contactSort: 'legitimacy_desc',
                pathAnalysis: {
                    start: null, via: null, end: null,
                    goal: 'confidence',
                    excludeBlacklisted: true,
                    includeRisk: false,
                    results: [],
                    selectedPathId: null,
                    isLoading: false,
                },
                ncnda: {
                    parties: [],
                    includeImfpa: false,
                    dealContextType: 'Agnostic',
                    offerId: null,
                    jurisdiction: 'International Chamber of Commerce (ICC Pub. No. 769 E)',
                    imfpaGroups: [],
                    dealMetrics: { volume: 0, price: 0, commissionPct: 0 }
                },
                ui: {
                    isRefreshing: false,
                    lastDataHash: null,
                    refreshInterval: null,
                    activeAutocomplete: null,
                    expandedCards: new Set()
                }
            };
            
            const Utils = {
                createApiRequest: async (action, method = 'POST', params = {}) => {
                    const url = new URL(API_URL);
                    const options = {
                        method: method.toUpperCase(),
                        redirect: 'follow',
                        body: JSON.stringify({ action, data: params }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    };
                    try {
                        const response = await fetch(url, options);
                        const resultText = await response.text();
                        if (!response.ok) throw new Error(`API Network Error: Status ${response.status} - ${resultText}`);
                        const result = JSON.parse(resultText);
                        if (result.success === false) throw new Error(result.error || 'An unknown server error occurred.');
                        return result.data || result;
                    } catch (error) {
                        console.error(`API Error for action '${action}':`, error);
                        throw error;
                    }
                },
                debounce: (func, wait) => { 
                    let timeout; 
                    return (...args) => { 
                        clearTimeout(timeout); 
                        timeout = setTimeout(() => func.apply(this, args), wait); 
                    }; 
                },
                showNotification: (message, type = 'info', duration = 4000) => {
                    const toast = document.createElement('div');
                    const colors = { success: 'from-green-500 to-emerald-600', error: 'from-red-500 to-rose-600', info: 'from-sky-500 to-blue-600' };
                    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
                    toast.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[200] text-white font-medium bg-gradient-to-br ${colors[type]} transform translate-x-full transition-all duration-500 ease-out`;
                    toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icons[type]} text-lg"></i><span>${message}</span></div>`;
                    document.body.appendChild(toast);
                    requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
                    setTimeout(() => { toast.style.transform = 'translateX(120%)'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, duration);
                },
                hashString: (str) => { 
                    let hash = 0; if (str.length === 0) return hash; 
                    for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } 
                    return hash; 
                },
                animateProgressBar: (el, target, onComplete) => {
                    if(!el) return;
                    let start = parseFloat(el.style.width) || 0;
                    let startTime = null;
                    const duration = 800;
                    function animation(currentTime) {
                        if (startTime === null) startTime = currentTime;
                        const timeElapsed = currentTime - startTime;
                        const progress = Math.min(timeElapsed / duration, 1);
                        const currentWidth = start + (target - start) * progress;
                        el.style.width = currentWidth + '%';
                        if (progress < 1) {
                            requestAnimationFrame(animation);
                        } else {
                            if (onComplete) onComplete();
                        }
                    }
                    requestAnimationFrame(animation);
                }
            };
            
            const UI = {
                init: () => {
                    UI.initParticles();
                    UI.populateNavLinks();
                    UI.renderView('auth');
                },
                initParticles: () => { 
                     if(typeof particlesJS !== 'undefined') { 
                        particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":1200}},"color":{"value":"#334155"},"shape":{"type":"circle"},"opacity":{"value":0.4,"random":true},"size":{"value":2,"random":true},"line_linked":{"enable":true,"distance":180,"color":"#475569","opacity":0.2,"width":1},"move":{"enable":true,"speed":0.8,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":false}},"modes":{"grab":{"distance":200,"line_linked":{"opacity":0.5}}}},"retina_detect":true}); 
                    } 
                },
                populateNavLinks: () => {
                    const navContainer = document.getElementById('nav-container');
                    if (!navContainer) return;
                    const links = [
                        { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow' },
                        { page: 'toolkits', icon: 'fas fa-tools', text: 'Toolkits' },
                        { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect' },
                        { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Intelligence' },
                        { page: 'nexus', icon: 'fas fa-layer-group', text: 'Capital Nexus' }
                    ];
                    navContainer.innerHTML = links.map(link => {
                        const isActive = link.page === 'intelligence';
                        return `<a href="./${link.page}.html" class="nav-btn ${isActive ? 'active' : ''}"><div class="nav-icon-wrapper"><div class="nav-icon-flipper"><div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div><div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div></div></div><span class="nav-text">${link.text}</span></a>`;
                    }).join('');
                },
                renderView: (viewName) => {
                    const mainContent = document.getElementById('main-content');
                    if (!mainContent) return;
                    let html = '';
                    switch(viewName) {
                        case 'auth':
                            html = ComponentBuilders.renderAuthGate();
                            break;
                        case 'suite':
                            html = ComponentBuilders.renderMainSuite();
                            break;
                    }
                    mainContent.innerHTML = html;
                    Logic.bindEventListenersForView(viewName);
                },
                updateContactDisplay: () => {
                    const container = document.getElementById('contacts-container');
                    const loadingSpinner = document.getElementById('contacts-loading-spinner');
                    const paginationEl = document.getElementById('contacts-pagination');
                    if (!container || !loadingSpinner || !paginationEl) return;

                    loadingSpinner.classList.add('hidden');
                    container.classList.remove('hidden');
                    
                    const startIndex = (AppState.currentPage - 1) * AppState.contactsPerPage;
                    const endIndex = startIndex + AppState.contactsPerPage;
                    const contactsToRender = AppState.filteredContacts.slice(startIndex, endIndex);
                    
                    document.getElementById('contacts-shown').textContent = AppState.filteredContacts.length;

                    if (contactsToRender.length === 0) {
                        container.innerHTML = `<div class="col-span-full text-center py-20 text-text-muted"><i class="fas fa-search-minus fa-4x opacity-50"></i><p class="text-xl mt-4">No contacts match your current filters.</p></div>`;
                        paginationEl.classList.add('hidden');
                    } else {
                        container.innerHTML = contactsToRender.map(ComponentBuilders.createContactCardHTML).join('');
                        paginationEl.classList.remove('hidden');
                        setTimeout(() => document.querySelectorAll('.legitimacy-bar-fill').forEach(bar => { bar.style.width = bar.dataset.score + '%'; }), 50);
                        UI.updatePaginationControls();
                    }
                },
                updatePaginationControls: () => {
                    const container = document.getElementById('contacts-pagination');
                    const totalPages = Math.ceil(AppState.filteredContacts.length / AppState.contactsPerPage);
                    if (totalPages <= 1) { container.classList.add('hidden'); return; }
                    container.innerHTML = `
                        <button id="prev-page-btn" class="btn-secondary px-4 py-2 rounded-lg" ${AppState.currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                        <span id="page-info" class="text-sm text-text-muted font-medium">Page ${AppState.currentPage} of ${totalPages}</span>
                        <button id="next-page-btn" class="btn-secondary px-4 py-2 rounded-lg" ${AppState.currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                    `;
                    document.getElementById('prev-page-btn').addEventListener('click', Logic.prevPage);
                    document.getElementById('next-page-btn').addEventListener('click', Logic.nextPage);
                },
                updateSelectedContactDisplay: (target, name) => {
                    const displayEl = document.getElementById(`${target}-contact-display`);
                    const inputEl = document.getElementById(`${target}-contact-input`);
                    const suggestionsEl = document.getElementById(`${target}-contact-suggestions`);
                    if (!displayEl || !inputEl || !suggestionsEl) return;

                    if (name) {
                        const icons = { start: 'fa-flag-checkered', via: 'fa-map-signs', end: 'fa-bullseye' };
                        displayEl.innerHTML = `<i class="fas ${icons[target]} icon"></i><span class="name truncate">${name}</span><button class="clear-btn" onmousedown="event.preventDefault(); Logic.clearSelectedContact('${target}')">Ã—</button>`;
                        displayEl.classList.remove('hidden');
                        inputEl.classList.add('hidden');
                    } else {
                        displayEl.classList.add('hidden');
                        inputEl.value = '';
                        inputEl.classList.remove('hidden');
                    }
                    suggestionsEl.classList.add('hidden');
                },
                renderAutocompleteSuggestions: (suggestions, target) => {
                    const suggestionsEl = document.getElementById(`${target}-contact-suggestions`);
                    if (!suggestionsEl) return;
                    if (suggestions.length === 0) {
                        suggestionsEl.innerHTML = `<div class="suggestion-item text-text-muted italic">No active contacts found.</div>`;
                    } else {
                        suggestionsEl.innerHTML = suggestions.map(s => `
                            <div class="suggestion-item" onmousedown="Logic.selectAutocompleteSuggestion('${target}', '${s.fullName}')">
                                <div class="name">${s.fullName}</div><div class="entity">${s.entity}</div>
                            </div>`).join('');
                    }
                    suggestionsEl.classList.remove('hidden');
                },
                updateSingleCardExpansion: (contactId) => {
                    const card = document.getElementById(`contact-card-${contactId}`);
                    if (!card) return;
                    const details = card.querySelector('.card-details');
                    const toggleBtnIcon = card.querySelector('.expand-toggle-btn i');
                    details.classList.toggle('expanded', AppState.ui.expandedCards.has(contactId));
                    toggleBtnIcon.classList.toggle('rotate-180', AppState.ui.expandedCards.has(contactId));
                },
                renderPathResults: (paths) => {
                    const resultsArea = document.getElementById('path-results-area');
                    const reportContainer = document.getElementById('path-report-container');
                    const errorDisplay = document.getElementById('path-error-display');
                    
                    resultsArea.classList.remove('hidden');
                    document.getElementById('path-loading-spinner').classList.add('hidden');
                    
                    if (!paths || paths.length === 0) {
                        reportContainer.classList.add('hidden');
                        document.getElementById('path-error-message').textContent = "No viable pathways could be found matching your criteria.";
                        errorDisplay.classList.remove('hidden');
                        return;
                    }
                    
                    AppState.pathAnalysis.results = paths;
                    Logic.sortPaths();
                    document.getElementById('path-results-tbody').innerHTML = paths.map(ComponentBuilders.createPathRowHTML).join('');
                    reportContainer.classList.remove('hidden');
                    errorDisplay.classList.add('hidden');
                    Logic.selectPath(paths[0].pathId);
                },
                closeNcndaModal: () => {
                    const overlay = document.getElementById('ncnda-modal-overlay');
                    if (overlay) {
                        overlay.classList.remove('active');
                        setTimeout(() => overlay.classList.add('hidden'), 400);
                    }
                }
            };
            
            const ComponentBuilders = {
                renderAuthGate: () => `
                    <div class="glass-card rounded-2xl p-6 md:p-10 max-w-lg mx-auto shadow-2xl fade-in-up text-center">
                        <i class="fas fa-shield-alt text-5xl text-primary-azure mb-4" style="text-shadow: 0 0 20px var(--glow-azure);"></i>
                        <h2 class="text-3xl font-bold text-white mb-2">Intelligence Suite Access</h2>
                        <p class="text-text-secondary mb-8">This module requires premium partner authentication. Please enter your GECANâ„¢ Access Code to proceed.</p>
                        <div class="flex items-center gap-3">
                            <input type="password" id="access-code-input" placeholder="Enter Access Code" class="flex-grow form-input p-3 text-white rounded-xl focus:outline-none text-sm font-mono tracking-widest text-center">
                            <button id="validate-code-btn" class="btn-primary bg-gradient-to-r from-primary-royal to-primary-amethyst border-primary-royal font-bold py-3 px-6 rounded-xl disabled:opacity-50">Authenticate</button>
                        </div>
                        <p id="access-error" class="text-sm text-error-color mt-3 h-5"></p>
                        <div id="auth-progress" class="mt-4 hidden">
                            <div class="w-full progress-bar-container rounded-full h-2.5"><div class="bg-gradient-to-r from-primary-royal to-primary-amethyst h-2.5 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>`,
                renderMainSuite: () => `
                    <div class="space-y-16">
                        <section id="path-analyzer-section" class="fade-in-up">
                            ${ComponentBuilders.renderPathAnalyzerForm()}
                            ${ComponentBuilders.renderPathResultsArea()}
                        </section>
                        <section id="contacts-section" class="mt-16 fade-in-up" style="animation-delay: 0.2s;">
                            ${ComponentBuilders.renderContactDirectory()}
                        </section>
                    </div>`,
                renderPathAnalyzerForm: () => `
                    <div class="text-center mb-10">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Strategic Path Analyzer</h2>
                        <p class="text-text-secondary max-w-3xl mx-auto">Visually construct and analyze communication pathways between network contacts to identify the most efficient, secure, and legitimate routes for engagement.</p>
                    </div>
                    <div class="report-section p-6 md:p-8">
                        <div class="mb-8">
                            <label class="text-sm font-medium text-text-muted mb-3 block text-center">Step 1: Define Optimization Goal</label>
                            <div id="optimization-goal-selector" class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-3xl mx-auto">
                                <button data-goal="confidence" class="goal-btn active flex-col h-24 rounded-xl"><i class="fas fa-shield-alt text-2xl mb-2"></i><span>Highest Confidence</span></button>
                                <button data-goal="userCentric" class="goal-btn flex-col h-24 rounded-xl"><i class="fas fa-user-check text-2xl mb-2 text-primary-royal"></i><span>User-Centric (Via Me)</span></button>
                                <button data-goal="shortest" class="goal-btn flex-col h-24 rounded-xl"><i class="fas fa-route text-2xl mb-2"></i><span>Shortest Path</span></button>
                                <button data-goal="legitimacy" class="goal-btn flex-col h-24 rounded-xl"><i class="fas fa-balance-scale text-2xl mb-2"></i><span>Highest Legitimacy</span></button>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="text-sm font-medium text-text-muted mb-3 block text-center">Step 2: Configure Pathway</label>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                                ${['start', 'via', 'end'].map(target => `
                                    <div class="relative">
                                        <input type="text" id="${target}-contact-input" class="form-input p-3 pl-4 text-white rounded-xl w-full autocomplete-input" placeholder="${target.charAt(0).toUpperCase() + target.slice(1)} Contact..." autocomplete="off">
                                        <div id="${target}-contact-suggestions" class="autocomplete-suggestions hidden"></div>
                                        <div id="${target}-contact-display" class="selected-contact-display hidden"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-border-secondary flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4 text-sm text-text-secondary">
                                <label class="flex items-center gap-2 cursor-pointer hover:text-white"><input type="checkbox" id="exclude-blacklisted" checked class="form-input !w-4 !h-4 !p-0 !rounded text-primary-azure focus:ring-primary-azure">Exclude Blacklisted</label>
                            </div>
                            <div class="flex gap-3">
                                <button id="clear-paths-btn" class="btn-secondary px-6 py-2.5 rounded-lg text-sm font-semibold"><i class="fas fa-times mr-2"></i>Clear Path</button>
                                <button id="find-paths-btn" class="btn-primary font-bold py-2.5 px-8 rounded-lg"><i class="fas fa-project-diagram mr-2"></i>Generate Report</button>
                            </div>
                        </div>
                    </div>`,
                renderPathResultsArea: () => `
                    <div id="path-results-area" class="mt-8 hidden">
                        <div id="path-loading-spinner" class="hidden text-center py-10"><div class="relative inline-block"><i class="fas fa-spinner fa-spin fa-3x text-primary-azure"></i><div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div></div><p class="mt-6 text-lg text-text-secondary">Analyzing GECANâ„¢ Network...</p></div>
                        <div id="path-error-display" class="hidden report-section p-8 text-center"><i class="fas fa-exclamation-triangle text-4xl mb-4 text-error-color"></i><p class="text-xl font-semibold text-white">Analysis Error</p><p id="path-error-message" class="text-text-secondary mt-1"></p></div>
                        <div id="path-report-container" class="hidden space-y-8">
                            <div id="path-summary-section" class="report-section"></div>
                            <div class="overflow-x-auto report-section"><table class="min-w-full text-sm text-left text-text-secondary"><thead class="text-xs text-text-muted uppercase bg-background-dark/50"><tr><th scope="col" class="p-4 cursor-pointer hover:text-white" onclick="Logic.handlePathSortClick('integrityScore')">Integrity <i class="fas fa-sort ml-1"></i></th><th scope="col" class="p-4">Path</th><th scope="col" class="p-4 text-center cursor-pointer hover:text-white" onclick="Logic.handlePathSortClick('hops')">Hops <i class="fas fa-sort ml-1"></i></th><th scope="col" class="p-4 text-center cursor-pointer hover:text-white" onclick="Logic.handlePathSortClick('avgLegitimacy')">Avg. Legitimacy <i class="fas fa-sort ml-1"></i></th><th scope="col" class="p-4">Weakest Link</th><th scope="col" class="p-4 text-center">Details</th></tr></thead><tbody id="path-results-tbody" class="divide-y divide-border-color"></tbody></table></div>
                        </div>
                    </div>`,
                renderContactDirectory: () => `
                    <div class="text-center mb-10">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Contact Ledger</h2>
                        <p class="text-text-secondary max-w-3xl mx-auto">Browse, filter, and review contacts within the GECAN network. Access levels may apply based on your partner tier.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="relative lg:col-span-2"><i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-text-muted"></i><input type="text" id="contact-search-input" placeholder="Search by name, entity, role, jurisdiction..." class="w-full form-input py-3 pl-12 pr-10 text-white rounded-xl"><button id="clear-search-btn" class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted hover:text-white hidden">&times;</button></div>
                        <div><select id="role-filter-select" class="w-full form-input p-3 text-white rounded-xl"></select></div>
                        <div><select id="asset-filter-select" class="w-full form-input p-3 text-white rounded-xl"></select></div>
                    </div>
                    <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                      <div class="flex items-center gap-2" id="contact-status-filters"><span class="text-sm text-text-muted">Status:</span><button class="btn-primary px-3 py-1 text-xs rounded-lg" data-status="ALL">All</button><button class="btn-secondary px-3 py-1 text-xs rounded-lg" data-status="ACTIVE">Active</button><button class="btn-secondary px-3 py-1 text-xs rounded-lg" data-status="BLACKLISTED">Blacklisted</button></div>
                      <div class="flex items-center gap-4 text-sm text-text-secondary"><span>Showing <span id="contacts-shown" class="font-bold text-white">0</span> of <span id="total-contacts" class="font-bold text-white">0</span> contacts</span><select id="contacts-sort-select" class="form-input p-2 text-sm text-white rounded-lg"><option value="legitimacy_desc">Sort: Legitimacy (High-Low)</option><option value="name_asc">Sort: Name (A-Z)</option><option value="name_desc">Sort: Name (Z-A)</option></select></div>
                    </div>
                    <div id="contacts-loading-spinner" class="text-center py-20"><i class="fas fa-spinner fa-spin fa-3x text-primary-azure"></i><p class="mt-6 text-lg">Loading GECANâ„¢ Contact Database...</p></div>
                    <div id="contacts-container" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6"></div>
                    <div id="contacts-pagination" class="hidden mt-8 flex justify-center items-center gap-3"></div>
                `,
                createContactCardHTML: (c) => {
                    const legitimacyScore = c.legitimacyScore || 0;
                    const legitimacyPercentage = Math.min(legitimacyScore * 10, 100);
                    const legitimacyBarClass = legitimacyPercentage >= 70 ? 'legitimacy-high' : legitimacyPercentage >= 40 ? 'legitimacy-medium' : 'legitimacy-low';
                    
                    let selectionClass = '';
                    let selectionBadge = '';
                    if (AppState.pathAnalysis.start === c.fullName) { selectionClass = 'border-sky-400/60 ring-2 ring-sky-400/40'; selectionBadge = `<div class="absolute -top-2 -right-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg z-20">START</div>`; } 
                    else if (AppState.pathAnalysis.via === c.fullName) { selectionClass = 'border-indigo-400/60 ring-2 ring-indigo-400/40'; selectionBadge = `<div class="absolute -top-2 -right-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg z-20">VIA</div>`; } 
                    else if (AppState.pathAnalysis.end === c.fullName) { selectionClass = 'border-emerald-400/60 ring-2 ring-emerald-400/40'; selectionBadge = `<div class="absolute -top-2 -right-2 bg-gradient-to-r from-emerald-500 to-green-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg z-20">END</div>`; }

                    const isExpanded = AppState.ui.expandedCards.has(c.contactId);

                    return `
                    <div id="contact-card-${c.contactId}" class="contact-card rounded-2xl p-5 flex flex-col h-full group ${selectionClass}">
                        ${selectionBadge}
                        <div class="flex items-start gap-4 mb-4">
                            <div class="status-indicator-ring status-ring-${c.status} relative">
                                <div class="status-dot-${c.status}"></div>
                                ${c.status === 'ACTIVE' ? '<div class="absolute inset-0 rounded-full bg-current opacity-20 animate-ping"></div>' : ''}
                            </div>
                            <div class="flex-grow min-w-0">
                                <h3 class="text-lg font-bold text-white truncate group-hover:text-primary-azure transition-colors">${c.fullName}</h3>
                                <p class="text-sm text-text-secondary truncate">${c.entity}</p>
                            </div>
                            <button onclick="Logic.toggleCardExpansion('${c.contactId}')" class="expand-toggle-btn w-8 h-8 rounded-full bg-background-secondary/50 hover:bg-background-secondary flex items-center justify-center transition-all duration-300 hover:scale-110 flex-shrink-0" title="${isExpanded ? 'Collapse Details' : 'Expand Details'}">
                                <i class="fas fa-chevron-down transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}"></i>
                            </button>
                        </div>
                        
                        <div class="text-xs text-text-muted">Legitimacy Score: <span class="font-bold text-white">${legitimacyScore}/10</span></div>
                        <div class="legitimacy-bar-container relative h-3 rounded-full overflow-hidden mt-1">
                            <div class="legitimacy-bar-fill ${legitimacyBarClass} h-full rounded-full" data-score="${legitimacyPercentage}" style="width: 0%;"></div>
                        </div>

                        <div class="card-details ${isExpanded ? 'expanded' : ''} text-xs space-y-2">
                            <p class="text-text-platinum"><strong class="text-text-muted">Role:</strong> ${c.primaryRole || 'N/A'}</p>
                            <p class="text-text-platinum"><strong class="text-text-muted">Jurisdiction:</strong> ${c.jurisdiction || 'N/A'}</p>
                            <p class="text-text-platinum"><strong class="text-text-muted">Asset Focus:</strong> ${c.primaryAssetFocus || 'N/A'}</p>
                        </div>
                        
                        <div class="flex-grow"></div> 
                        <div class="relative z-10 mt-4 pt-4 border-t border-border-color">
                            <div class="grid grid-cols-3 gap-2">
                                ${['start', 'via', 'end'].map(t => {
                                    const icons = { start: 'fa-flag-checkered', via: 'fa-map-signs', end: 'fa-bullseye' };
                                    const isSelected = AppState.pathAnalysis[t] === c.fullName;
                                    return `<button class="btn-secondary !rounded-lg text-xs py-2 ${isSelected ? '!bg-primary-azure !text-white !border-primary-azure' : ''}" onclick="Logic.setContactForAnalysis('${t}', '${c.fullName}')" title="Set as ${t}"><i class="fas ${icons[t]}"></i></button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                },
                createPathRowHTML: (p) => {
                    const scoreColor = p.integrityScore >= 75 ? 'text-success-color' : p.integrityScore >= 50 ? 'text-warning-color' : 'text-error-color';
                    const userCentricIcon = p.isUserCentric ? `<i class="fas fa-user-check text-primary-royal" title="Path includes you"></i>` : '';
                    return `
                        <tr class="hover:bg-background-secondary cursor-pointer group" id="path-row-${p.pathId}" onclick="Logic.selectPath('${p.pathId}')">
                            <td class="p-4 font-bold ${scoreColor}"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full ${scoreColor.replace('text-', 'bg-')}"></div>${p.integrityScore.toFixed(0)}%</div></td>
                            <td class="p-4"><div class="flex items-center gap-3">${userCentricIcon}<span class="truncate max-w-sm font-medium group-hover:text-primary-azure transition-colors" title="${p.pathText}">${p.pathText}</span></div></td>
                            <td class="p-4 text-center"><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-background-secondary text-text-secondary">${p.hops}</span></td>
                            <td class="p-4 text-center font-medium">${p.avgLegitimacy.toFixed(1)}</td>
                            <td class="p-4 text-error-color/80 text-sm"><div class="truncate">${p.weakestLink.name} (${p.weakestLink.score})</div></td>
                            <td class="p-4 text-center"><i class="fas fa-chevron-down transition-transform duration-300" id="details-icon-${p.pathId}"></i></td>
                        </tr>
                        <tr id="details-row-${p.pathId}" class="path-details-row hidden"><td colspan="6" class="bg-background-dark/50 p-0"><div id="details-content-${p.pathId}" class="p-6">Loading details...</div></td></tr>
                    `;
                },
                renderExecutiveSummary: (path) => {
                    const container = document.getElementById('path-summary-section');
                    if (!path || !container) return;
                    const riskColor = path.integrityScore >= 75 ? 'text-emerald-400' : path.integrityScore >= 50 ? 'text-yellow-400' : 'text-red-400';
                    const riskText = path.integrityScore >= 75 ? 'LOW' : path.integrityScore >= 50 ? 'MEDIUM' : 'HIGH';
                    container.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-2xl font-bold text-white">Intelligence Briefing</h3>
                                <div class="text-right"><div class="text-xs text-text-muted">Risk Assessment</div><div class="text-lg font-bold ${riskColor}">${riskText}</div></div>
                            </div>
                            <div class="bg-background-dark/50 rounded-xl p-4 mb-4"><p class="text-xl font-semibold text-primary-azure">${path.pathText}</p></div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-center">
                                <div class="stat-card p-3 rounded-lg"><p class="text-xs text-text-muted">Hops</p><p class="value text-2xl">${path.hops}</p></div>
                                <div class="stat-card p-3 rounded-lg"><p class="text-xs text-text-muted">Integrity</p><p class="value text-2xl ${riskColor}">${path.integrityScore.toFixed(0)}%</p></div>
                                <div class="stat-card p-3 rounded-lg"><p class="text-xs text-text-muted">Avg Legitimacy</p><p class="value text-2xl">${path.avgLegitimacy.toFixed(1)}</p></div>
                                <div class="stat-card p-3 rounded-lg"><p class="text-xs text-text-muted">Est. Time</p><p class="value text-2xl">${path.estimatedTime}</p></div>
                            </div>
                        </div>`;
                    container.classList.remove('hidden');
                },
                loadPathDetailsContent: async (path) => {
                    const contentDiv = document.getElementById(`details-content-${path.pathId}`);
                    if (!contentDiv) return;
                    contentDiv.innerHTML = '<i class="fas fa-spinner fa-spin text-primary-azure"></i> Fetching entity data...';
                    try {
                        const contacts = path.pathText.split('  â†’  ');
                        const entities = await Utils.createApiRequest('getEntitiesForPathAnalysis', 'POST', { pathContacts: contacts, accessCode: AppState.userAccessCode });
                        const entitiesHtml = entities.length ? entities.map(e => `<span class="inline-block bg-background-secondary text-text-secondary px-2 py-1 rounded text-xs mr-1 mb-1">${e}</span>`).join('') : '<span class="text-text-muted text-xs">No unique entities found.</span>';
                        contentDiv.innerHTML = `
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <h4 class="font-bold text-white">Pathway Details</h4>
                                    <div class="text-sm space-y-2">
                                        <p><strong>Security Rating:</strong> <span class="font-mono ${path.securityRating >= 7 ? 'text-success-color' : 'text-warning-color'}">${path.securityRating}/10</span></p>
                                        <p><strong>Jurisdiction Shifts:</strong> <span class="font-mono">${path.jurisdictionShifts}</span></p>
                                        <div><strong>Involved Entities:</strong><div class="mt-2">${entitiesHtml}</div></div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h4 class="font-bold text-white">Risk Analysis</h4>
                                    <div class="text-sm text-text-secondary">${path.riskFactors && path.riskFactors.length ? path.riskFactors.map(r => `<p class="mb-2 p-2 bg-warning-color/10 rounded-md border-l-2 border-warning-color"><strong>${r.type}:</strong> ${r.description}</p>`).join('') : '<p class="text-success-color">No specific risk factors identified.</p>'}</div>
                                </div>
                            </div>`;
                    } catch (error) {
                        contentDiv.innerHTML = `<p class="text-error-color">Could not load entity details: ${error.message}</p>`;
                    }
                }
            };

            const Logic = {
                init: () => {
                    UI.init();
                    Logic.checkForAutoAuth();
                },
                checkForAutoAuth: () => {
                    const code = new URLSearchParams(window.location.search).get('code');
                    if (code) {
                        const input = document.getElementById('access-code-input');
                        if (input) {
                            input.value = code;
                            Logic.validatePremiumCode();
                        }
                    }
                },
                validatePremiumCode: async () => {
                    const btn = document.getElementById('validate-code-btn');
                    const input = document.getElementById('access-code-input');
                    const errEl = document.getElementById('access-error');
                    const progEl = document.getElementById('auth-progress');
                    
                    if (!btn || !input || !errEl) return;
                    const accessCode = input.value.trim().toUpperCase();
                    if (!accessCode) {
                        errEl.textContent = 'Access Code cannot be empty.';
                        errEl.classList.remove('hidden');
                        return;
                    }
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    errEl.classList.add('hidden');

                    try {
                        const responseData = await Utils.createApiRequest('validatePremiumAccessCode', 'POST', { accessCode });
                        if (responseData && responseData.isValid) {
                            AppState.userAccessCode = accessCode;
                            AppState.userAccessTier = responseData.accessTier;
                            AppState.partnerName = responseData.partnerName;
                            
                            document.getElementById('premium-access-gate').style.display = 'none';
                            document.getElementById('intelligence-suite').classList.remove('hidden');
                            
                            const welcomeBanner = document.getElementById('welcome-banner');
                            if(welcomeBanner) {
                                welcomeBanner.innerHTML = `<p class="text-sm text-text-secondary">Partner: <strong class="text-white">${responseData.partnerName}</strong></p><p class="text-xs font-mono text-primary-amethyst">Tier: ${responseData.accessTier}</p>`;
                                welcomeBanner.classList.remove('hidden');
                            }
                            
                            Utils.showNotification('Authentication successful!', 'success');
                            UI.renderView('suite');
                            await Logic.initialDataLoad();
                        } else {
                            throw new Error(responseData.message || 'Invalid or inactive Access Code.');
                        }
                    } catch (error) {
                        errEl.textContent = error.message;
                        errEl.classList.remove('hidden');
                        btn.disabled = false;
                        btn.textContent = 'Authenticate';
                    }
                },
                initialDataLoad: async () => {
                    try {
                        const contacts = await Utils.createApiRequest('getContactsForIntelligencePage', 'POST', { accessCode: AppState.userAccessCode });
                        AppState.allContacts = contacts.map(c => ({...c, searchText: [c.fullName, c.entity, c.primaryRole, c.jurisdiction, c.primaryAssetFocus].join(' ').toLowerCase()}));
                        AppState.lastDataHash = Utils.hashString(JSON.stringify(AppState.allContacts));
                        
                        document.getElementById('role-filter-select').innerHTML = '<option value="ALL">All Roles</option>' + [...new Set(AppState.allContacts.map(c => c.primaryRole).filter(Boolean))].sort().map(r => `<option value="${r}">${r}</option>`).join('');
                        document.getElementById('asset-filter-select').innerHTML = '<option value="ALL">All Assets</option>' + [...new Set(AppState.allContacts.map(c => c.primaryAssetFocus).filter(Boolean))].sort().map(a => `<option value="${a}">${a}</option>`).join('');
                        document.getElementById('total-contacts').textContent = AppState.allContacts.length;
                        
                        Logic.applyFiltersAndSort();
                    } catch (error) {
                        Utils.showNotification(error.message, 'error');
                        document.getElementById('contacts-loading-spinner').innerHTML = `<p class="text-error-color">Failed to load contact data.</p>`;
                    }
                },
                applyFiltersAndSort: () => {
                    const q = document.getElementById('contact-search-input').value.toLowerCase();
                    const s = document.querySelector('#contact-status-filters .btn-primary').dataset.status;
                    const r = document.getElementById('role-filter-select').value;
                    const a = document.getElementById('asset-filter-select').value;
                    
                    AppState.filteredContacts = AppState.allContacts.filter(c => 
                        (s === 'ALL' || c.status === s) && 
                        (r === 'ALL' || c.primaryRole === r) && 
                        (a === 'ALL' || c.primaryAssetFocus === a) && 
                        (q === '' || c.searchText.includes(q))
                    );
                    
                    document.getElementById('clear-search-btn').classList.toggle('hidden', !q);
                    Logic.sortContacts();
                    AppState.currentPage = 1;
                    UI.updateContactDisplay();
                },
                sortContacts: () => {
                    const [field, dir] = AppState.contactSort.split('_');
                    const sortField = field === 'legitimacy' ? 'legitimacyScore' : 'fullName';
                    AppState.filteredContacts.sort((a, b) => {
                        let vA = a[sortField] || (field === 'legitimacy' ? 0 : '');
                        let vB = b[sortField] || (field === 'legitimacy' ? 0 : '');
                        if (typeof vA === 'number') return dir === 'asc' ? vA - vB : vB - vA;
                        return dir === 'asc' ? String(vA).localeCompare(String(vB)) : String(vB).localeCompare(String(vA));
                    });
                },
                prevPage: () => {
                    if (AppState.currentPage > 1) { AppState.currentPage--; UI.updateContactDisplay(); }
                },
                nextPage: () => {
                    if (AppState.currentPage * AppState.contactsPerPage < AppState.filteredContacts.length) { AppState.currentPage++; UI.updateContactDisplay(); }
                },
                handleAutocompleteInput: (event, target) => {
                    const query = event.target.value.toLowerCase();
                    const suggestionsEl = document.getElementById(`${target}-contact-suggestions`);
                    if (!query) { suggestionsEl.classList.add('hidden'); return; }
                    const filtered = AppState.allContacts.filter(c => c.searchText.includes(query) && c.status === 'ACTIVE').slice(0, 5);
                    UI.renderAutocompleteSuggestions(filtered, target);
                },
                selectAutocompleteSuggestion: (target, name) => {
                    Logic.setContactForAnalysis(target, name);
                },
                toggleCardExpansion: (contactId) => {
                    if (AppState.ui.expandedCards.has(contactId)) {
                        AppState.ui.expandedCards.delete(contactId);
                    } else {
                        AppState.ui.expandedCards.add(contactId);
                    }
                    UI.updateSingleCardExpansion(contactId);
                },
                clearSelectedContact: (target) => {
                    AppState.pathAnalysis[target] = null;
                    UI.updateSelectedContactDisplay(target, null);
                    document.getElementById(`${target}-contact-input`).focus();
                },
                clearPathUI: () => {
                    AppState.pathAnalysis.start = null;
                    AppState.pathAnalysis.via = null;
                    AppState.pathAnalysis.end = null;
                    AppState.pathAnalysis.results = [];
                    AppState.pathAnalysis.selectedPathId = null;
                    UI.updateSelectedContactDisplay('start', null);
                    UI.updateSelectedContactDisplay('via', null);
                    UI.updateSelectedContactDisplay('end', null);
                    document.getElementById('path-results-area').classList.add('hidden');
                    Utils.showNotification('Path Analyzer cleared.', 'info');
                },
                setContactForAnalysis: (target, name) => {
                    if (Object.values(AppState.pathAnalysis).includes(name)) {
                        Utils.showNotification(`${name} is already selected for another role.`, 'warning');
                        return;
                    }
                    AppState.pathAnalysis[target] = name;
                    UI.updateSelectedContactDisplay(target, name);
                },
                runPathAnalysis: async () => {
                    const findPathsBtn = document.getElementById('find-paths-btn');
                    if(findPathsBtn) findPathsBtn.disabled = true;

                    const { start, end } = AppState.pathAnalysis;
                    if (!start || !end) {
                        Utils.showNotification('A Start and End contact are required for analysis.', 'warning');
                        if(findPathsBtn) findPathsBtn.disabled = false;
                        return;
                    }
                    
                    document.getElementById('path-loading-spinner').classList.remove('hidden');
                    document.getElementById('path-error-display').classList.add('hidden');
                    document.getElementById('path-report-container').classList.add('hidden');
                    document.getElementById('path-results-area').classList.remove('hidden');
                    AppState.pathAnalysis.isLoading = true;

                    try {
                        const params = {
                            start, end,
                            via: AppState.pathAnalysis.via,
                            goal: AppState.pathAnalysis.goal,
                            excludeBlacklisted: document.getElementById('exclude-blacklisted').checked,
                            accessCode: AppState.userAccessCode
                        };
                        const results = await Utils.createApiRequest('runAdvancedPathAnalysis', 'POST', params);
                        UI.renderPathResults(results);
                    } catch (error) {
                        document.getElementById('path-loading-spinner').classList.add('hidden');
                        document.getElementById('path-error-message').textContent = error.message;
                        document.getElementById('path-error-display').classList.remove('hidden');
                    } finally {
                        AppState.pathAnalysis.isLoading = false;
                        if(findPathsBtn) findPathsBtn.disabled = false;
                    }
                },
                handlePathSortClick: (field) => {
                    const sortState = AppState.pathAnalysis.pathSort;
                    if (sortState.field === field) {
                        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.field = field;
                        sortState.dir = 'desc';
                    }
                    Logic.sortPaths();
                    document.getElementById('path-results-tbody').innerHTML = AppState.pathAnalysis.results.map(ComponentBuilders.createPathRowHTML).join('');
                },
                sortPaths: () => {
                    const { field, dir } = AppState.pathAnalysis.pathSort;
                    AppState.pathAnalysis.results.sort((a, b) => {
                        let valA = a[field]; let valB = b[field];
                        if (typeof valA === 'number') return dir === 'asc' ? valA - valB : valB - valA;
                        return dir === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(a));
                    });
                },
                selectPath: (pathId) => {
                    const isDeselecting = AppState.pathAnalysis.selectedPathId === pathId;
                    
                    // Deselect previous row if one was selected
                    if (AppState.pathAnalysis.selectedPathId) {
                        document.getElementById(`details-row-${AppState.pathAnalysis.selectedPathId}`)?.classList.add('hidden');
                        document.getElementById(`path-row-${AppState.pathAnalysis.selectedPathId}`)?.classList.remove('selected-path');
                        document.getElementById(`details-icon-${AppState.pathAnalysis.selectedPathId}`)?.classList.remove('rotate-180');
                    }
                    
                    if (isDeselecting) {
                        AppState.pathAnalysis.selectedPathId = null;
                        document.getElementById('path-summary-section').classList.add('hidden');
                    } else {
                        AppState.pathAnalysis.selectedPathId = pathId;
                        const path = AppState.pathAnalysis.results.find(p => p.pathId === pathId);
                        
                        document.getElementById(`path-row-${pathId}`).classList.add('selected-path');
                        document.getElementById(`details-row-${pathId}`).classList.remove('hidden');
                        document.getElementById(`details-icon-${pathId}`).classList.add('rotate-180');
                        
                        ComponentBuilders.renderExecutiveSummary(path);
                        ComponentBuilders.loadPathDetailsContent(path);
                    }
                },
                setupGlobalEventListeners: () => {
                    document.body.addEventListener('click', (e) => {
                        if (!e.target.closest('.autocomplete-input, .autocomplete-suggestions')) {
                           document.querySelectorAll('.autocomplete-suggestions').forEach(s => s.classList.add('hidden'));
                        }
                    });
                },
                bindEventListenersForView: (view) => {
                    if (view === 'auth') {
                        document.getElementById('validate-code-btn')?.addEventListener('click', Logic.validatePremiumCode);
                        document.getElementById('access-code-input')?.addEventListener('keypress', e => { if (e.key === 'Enter') Logic.validatePremiumCode(); });
                    } else if (view === 'suite') {
                        Logic.setupSuiteEventListeners();
                    }
                },
                setupSuiteEventListeners: () => {
                    const addListener = (selector, event, handler) => document.querySelector(selector)?.addEventListener(event, handler);
                    const debouncedFilter = Utils.debounce(Logic.applyFiltersAndSort, 300);
                    
                    addListener('#contact-search-input', 'input', debouncedFilter);
                    addListener('#clear-search-btn', 'click', () => { document.getElementById('contact-search-input').value = ''; debouncedFilter(); }); 
                    addListener('#role-filter-select', 'change', Logic.applyFiltersAndSort);
                    addListener('#asset-filter-select', 'change', Logic.applyFiltersAndSort);
                    addListener('#contacts-sort-select', 'change', (e) => { AppState.contactSort = e.target.value; Logic.applyFiltersAndSort(); });
                    
                    document.querySelector('#contact-status-filters')?.addEventListener('click', (e) => {
                        if (e.target.tagName === 'BUTTON') {
                            document.querySelectorAll('#contact-status-filters button').forEach(b => b.className = 'btn-secondary px-3 py-1 text-xs rounded-lg');
                            e.target.className = 'btn-primary px-3 py-1 text-xs rounded-lg';
                            Logic.applyFiltersAndSort();
                        }
                    });
                    
                    ['start', 'via', 'end'].forEach(target => {
                        const inputEl = document.getElementById(`${target}-contact-input`);
                        if(inputEl) {
                            const debouncedHandler = Utils.debounce((e) => Logic.handleAutocompleteInput(e, target), 250);
                            inputEl.addEventListener('input', debouncedHandler);
                            inputEl.addEventListener('focus', (e) => Logic.handleAutocompleteInput(e, target));
                        }
                    });

                    document.querySelector('#optimization-goal-selector')?.addEventListener('click', e => {
                        const button = e.target.closest('.goal-btn');
                        if (button) {
                            document.querySelectorAll('#optimization-goal-selector .goal-btn').forEach(b => b.classList.remove('active'));
                            button.classList.add('active');
                            AppState.pathAnalysis.goal = button.dataset.goal;
                        }
                    });

                    addListener('#find-paths-btn', 'click', Logic.runPathAnalysis);
                    addListener('#clear-paths-btn', 'click', Logic.clearPathUI);
                    
                    addListener('#prev-page-btn', 'click', Logic.prevPage);
                    addListener('#next-page-btn', 'click', Logic.nextPage);
                }
            };
            
            // Initialize the application once the DOM is fully loaded.
            document.addEventListener('DOMContentLoaded', Logic.init);
            
            // Expose main controllers to the global scope for inline event handlers (onclick).
            window.Logic = Logic;
        })();
    </script>
</body>
</html>
