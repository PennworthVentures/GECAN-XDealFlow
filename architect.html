<!DOCTYPE html>
<html>
<head>
    <!-- ========================================================================= -->
    <!-- === DEFINITIVE FAVICON INTEGRATION (PINNACLE STANDARD) === -->
    <!-- ========================================================================= -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <base target="_top">
    <title>GECAN™ Architect | Deal Structuring Wizard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CUSTOM TAILWIND CONFIG (BENCHMARKED) -->
    <script>
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px',
                    '2xl': '1536px', '3xl': '1920px',
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PERFORMANCE FIX: Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&family=JetBrains+Mono:wght@300..700&display=swap" rel="stylesheet">

    <style>
        /* ========================================================================= */
        /* === PINNACLE CSS ENGINE v4.0 (BENCHMARKED & UNIFIED) === */
        /* This stylesheet is the definitive standard, ensuring visual consistency */
        /* with the entire GECAN platform. */
        /* ========================================================================= */

        /* --- A. CORE THEME & VARIABLES (BENCHMARKED) --- */
        :root {
            --text-premium-gold: #EAE0C8;
            --brand-gecan-blue: #1c2e4a; --brand-gecan-gold: #b4975a; --primary-azure: #0ea5e9;
            --primary-sapphire: #3b82f6; --primary-royal: #6366f1; --primary-amethyst: #8b5cf6;
            --primary-diamond: #f8fafc; --primary-dark: #0369a1;
            --background-primary: #0a0a0f; --background-secondary: #1e293b; --background-light: #0f172a; --background-accent: #1e293b; --background-dark: #030712;
            --background-glass: rgba(15, 23, 42, 0.8); --background-glass-premium: rgba(15, 23, 42, 0.9);
            --border-color: rgba(148, 163, 184, 0.2); --border-secondary: rgba(148, 163, 184, 0.2);
            --border-premium: rgba(148, 163, 184, 0.3); --border-accent: #64748b;
            --text-diamond: #f8fafc; --text-platinum: #e2e8f0; --text-silver: #cbd5e1;
            --text-muted: #94a3b8; --text-subtle: #64748b; --text-primary: #f8fafc; --text-secondary: #a0aec0;
            --glow-azure: rgba(14, 165, 233, 0.8); --glow-sapphire: rgba(59, 130, 246, 0.9);
            --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #0ea5e9, #3b82f6, #8b5cf6);
            --shadow-ultra: 0 25px 50px -12px rgba(0, 0, 0, 0.25); --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.8);
            --shadow-quantum: 0 50px 100px -20px rgba(0,0,0,0.5), 0 30px 60px -30px rgba(0,0,0,0.6);
            --transform-ultra: translateY(-16px) rotateX(10deg) rotateY(5deg) scale(1.07);
        }

        /* --- B. BASE STYLES & RESETS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', sans-serif; background: var(--background-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--background-secondary); } ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 4px; }
        ::selection { background: var(--gradient-primary); color: var(--text-diamond); }

        /* --- C. DYNAMIC BACKGROUND & PREMIUM HEADER (BENCHMARKED) --- */
        #particles-js { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        
        .premium-header { position: sticky; top: 0; z-index: 50; background: var(--background-glass-premium); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-bottom: 1px solid var(--border-premium); box-shadow: var(--shadow-ultra); }
        .gecan-logo-container { perspective: 800px; }
        .gecan-logo-flipper { position: relative; width: 250px; height: 120px; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .gecan-logo-container:hover .gecan-logo-flipper { transform: rotateY(180deg); }
        .logo-face { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
        .logo-front { font-family: 'Orbitron', monospace; font-weight: 900; font-size: 2.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 40px var(--glow-azure); }
        .logo-back img { height: 100%; width: auto; object-fit: contain; filter: brightness(1.1) drop-shadow(0 0 10px var(--brand-gecan-gold)) drop-shadow(0 0 25px var(--brand-gecan-blue)); transform: rotateY(180deg); }
        .logo-separator { width: 6px; height: 120px; background: var(--gradient-primary); border-radius: 4px; box-shadow: 0 0 30px var(--glow-azure); }

        .nav-btn { background: var(--background-glass); border: 1px solid var(--border-secondary); color: var(--text-silver); font-weight: 500; padding: 0.75rem 1.25rem; border-radius: 1rem; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.75rem; transform-style: preserve-3d; }
        .nav-btn:hover:not(.active) { background: var(--background-glass-premium); color: var(--text-diamond); transform: var(--transform-ultra); box-shadow: var(--shadow-premium), 0 0 60px var(--glow-azure); border-color: var(--border-premium); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.65), rgba(139, 92, 246, 0.65)), var(--background-glass); color: var(--text-diamond); font-weight: 700; border-color: var(--primary-azure); filter: brightness(1.1); animation: premium-active-glow 2.5s ease-in-out infinite; }
        @keyframes premium-active-glow { 50% { box-shadow: var(--shadow-ultra), 0 0 55px var(--glow-royal), 0 0 80px var(--glow-amethyst); text-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 30px var(--glow-royal); } }
        .nav-icon-wrapper { perspective: 500px; width: 24px; height: 24px; }
        .nav-icon-flipper { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-btn:hover:not(:active) .nav-icon-flipper { transform: rotateY(360deg); }
        .nav-icon-face { position: absolute; inset: 0; display: grid; place-items: center; backface-visibility: hidden; }
        .nav-icon-back { transform: rotateY(180deg); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px var(--glow-royal); }

        /* --- D. WIZARD-SPECIFIC STYLES (SEVERELY ENHANCED) --- */
        .glass-card { background: var(--background-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-azure), var(--primary-dark)); border: 1px solid var(--primary-azure); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transform: translateY(-3px); }
        .btn-primary:disabled { background: var(--background-secondary); border-color: var(--border-color); color: var(--text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        .btn-secondary { background: var(--background-accent); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .btn-secondary:hover:not(:disabled) { background: var(--background-secondary); border-color: var(--border-accent); color: var(--text-primary); }
        .form-input, .form-select { background-color: var(--background-dark); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-size: 1rem; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-azure); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), inset 0 2px 4px rgba(0,0,0,0.3); }
        
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .progress-bar-container { background: var(--background-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
        .progress-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .result-card { border: 1px solid var(--border-color); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; background: linear-gradient(145deg, var(--background-light), var(--background-dark)); cursor: pointer; }
        .result-card:before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 0, var(--asset-color, rgba(14, 165, 233, 0.15)), transparent 70%); opacity: 0; transition: opacity 0.6s ease; pointer-events: none; }
        .result-card:hover { transform: translateY(-10px) scale(1.03); border-color: var(--asset-color, var(--primary-azure)); box-shadow: 0 0 40px var(--asset-color, rgba(14, 165, 233, 0.3)), 0 20px 40px rgba(0, 0, 0, 0.4); }
        .result-card:hover:before { opacity: 1; }
        .asset-color-BITCOIN { --asset-color: #f7931a; } .asset-color-GOLD { --asset-color: #ffd700; } .asset-color-PALLETS { --asset-color: #16a34a; } .asset-color-SBLC_MONETIZATION { --asset-color: #6366f1; } .asset-color-USDT { --asset-color: #26a17b; } .asset-color-CRUDE_OIL { --asset-color: #64748b; } .asset-color-REFINED_FUEL { --asset-color: #fb923c; } .asset-color-PRECIOUS_METAL { --asset-color: #eab308; }

        .match-bar-bg { background-color: var(--background-secondary); }
        .match-bar { transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); }

        .modal-grid-item { background: linear-gradient(145deg, var(--background-dark), var(--background-accent)); border: 1px solid var(--border-color); }
    </style>
</head>
<body class="min-h-screen">

    <div id="particles-js"></div>
    
    <!-- PREMIUM HEADER (BENCHMARKED FROM TOOLKITS.HTML) -->
    <header class="premium-header p-4 lg:px-6">
        <div class="container mx-auto flex items-center justify-between gap-6">
            <div class="flex items-center gap-6 flex-shrink-0">
                <a href="./index.html" class="gecan-logo-container flex items-center gap-4 group">
                    <div class="gecan-logo-flipper">
                        <div class="logo-face logo-front">GECAN™</div>
                        <div class="logo-face logo-back">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjYjQ5NzVhIiBkPSJNNTAsMi41QTI0LjIsMjQuMiwwLDAsMCwyNS44LDI2LjdsMTIuMSw3YTEyLjEsMTIuMSwwLDAsMSwxMi4xLTEyLjFabTAsODVhMjQuMiwyNC4yLDAsMCwwLDI0LjItMjQuMkw2Mi4xLDY2LjNhMTIuMSwxMi4xLDAsMCwxLTEyLjEsMTIuMVptLTM1LjQtMjBhMjQuMiwyNC4yLDAsMCwwLDIxLjYsMjEuNkwyNC4xLDYyLjFBNTEuMyw1MS4zLDAsMCwxLDE0LjYsNzBabTE4LjMtNDEuN0wyMC44LDMyLjVhMjQuMiwyNC4yLDAsMCwwLDAsMzVsMTIuMS03YTEyLjEsMTIuMSwwLDAsMSwwLTE3LjlaTTc5LjIsMzIuNUw2Ny4xLDM5LjdhMTIuMSwxMi4xLDAsMCwxLDAsMTcuOWwxMi4xLDdhMjQuMiwyNC4yLDAsMCwwLDAtMzVaTTUwLDQxLjZhOC40LDguNCwwLDEsMCw4LjQsOC40QTguNCw4LjQsMCwwLDAsNTAsNDEuNloiLz48L3N2Zz4=" alt="GECAN Logo">
                        </div>
                    </div>
                    <div class="logo-separator"></div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Architect Wizard</h1>
                        <p class="text-sm text-gray-400 font-mono">Intelligent Deal Structuring</p>
                    </div>
                </a>
            </div>
            <nav id="nav-container" class="hidden xl:flex items-center justify-center gap-3 bg-black/20 backdrop-blur-sm border border-white/10 p-2 rounded-xl">
                <!-- Navigation will be dynamically injected by JavaScript -->
            </nav>
            <div id="referral-banner" class="hidden lg:block text-right"></div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div id="referral-gate" class="glass-card rounded-2xl p-6 md:p-8 max-w-lg mx-auto shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-2">Secure Access Required</h2>
            <p class="text-text-secondary mb-6">Please enter your assigned GECAN Partner Referral ID to proceed.</p>
            <div class="flex items-center gap-3">
                <input type="text" id="referral-id-input" placeholder="e.g., GECAN-PARTNER-001" class="flex-grow form-input p-3 text-white rounded-xl focus:outline-none text-sm">
                <button id="validate-id-btn" class="btn-primary font-bold py-3 px-6 rounded-xl">Validate</button>
            </div>
            <p id="referral-error" class="text-sm text-error-color mt-3 hidden"></p>
            <div id="auth-progress" class="mt-4 hidden">
              <div class="w-full progress-bar-container rounded-full h-2.5">
                <div class="bg-gradient-to-r from-primary-azure to-primary-royal h-2.5 rounded-full progress-bar" style="width: 0%"></div>
              </div>
              <p id="auth-status-text" class="text-xs text-gray-400 mt-2 text-center">Validating credentials...</p>
            </div>
        </div>

        <div id="architect-wizard" class="hidden">
            <div id="initial-loading" class="text-center py-20">
                <div class="relative inline-block">
                    <i class="fas fa-spinner fa-spin fa-3x text-primary-azure drop-shadow-[0_0_15px_rgba(14,165,233,0.5)]"></i>
                    <div class="absolute inset-0 rounded-full animate-ping bg-primary-azure opacity-20"></div>
                </div>
                <p class="mt-6 text-xl font-medium text-text-secondary">Initializing Architect Engine...</p>
            </div>
            
            <div id="wizard-content" class="hidden">
                <h2 class="text-3xl lg:text-4xl font-bold text-white text-center mb-2">Structure Your Ideal Transaction</h2>
                <p class="text-text-secondary mb-8 text-center max-w-3xl mx-auto">This intelligent wizard guides you through defining your ideal deal parameters. As you make selections, the system dynamically filters and cross-references against our live institutional offer ledger to find compatible counterparties.</p>
                
                <div class="mb-8 max-w-4xl mx-auto">
                    <div class="w-full progress-bar-container rounded-full h-2.5">
                        <div id="progress-bar" class="bg-gradient-to-r from-primary-azure to-secondary-color h-2.5 rounded-full progress-bar"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 glass-card rounded-2xl p-6 md:p-8 shadow-xl">
                        <div id="step-1" class="wizard-step"><h3 class="text-xl font-bold text-white mb-2">Step 1: Select Your Asset Category</h3><p class="text-text-secondary mb-6">What commodity or financial instrument are you targeting?</p><select id="asset-select" class="form-select w-full p-3 text-white rounded-xl focus:outline-none"></select></div>
                        <div id="step-2" class="wizard-step"><h3 class="text-xl font-bold text-white mb-2">Step 2: Define Core Procedure</h3><p class="text-text-secondary mb-6">How do you prefer the transaction to be conducted?</p><select id="procedure-select" class="form-input w-full p-3 text-white rounded-xl focus:outline-none"></select></div>
                        <div id="step-3" class="wizard-step"><h3 class="text-xl font-bold text-white mb-2">Step 3: Choose Transaction Venue</h3><p class="text-text-secondary mb-6">Where should the transaction take place?</p><select id="venue-select" class="form-input w-full p-3 text-white rounded-xl focus:outline-none"></select></div>
                        <div id="step-4" class="wizard-step"><h3 class="text-xl font-bold text-white mb-2">Step 4: Specify Settlement Protocol</h3><p class="text-text-secondary mb-6">What is the required method for final settlement?</p><select id="settlement-select" class="form-input w-full p-3 text-white rounded-xl focus:outline-none"></select></div>
                        <div class="mt-8 flex justify-between items-center">
                            <button id="prev-btn" class="btn-secondary px-6 py-2 text-sm rounded-lg" disabled>Previous</button>
                            <button id="next-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">Next</button>
                            <button id="find-matches-btn" class="hidden btn-primary bg-gradient-to-r from-success-color to-green-600 border-green-500 font-bold py-2 px-6 rounded-lg"><i class="fas fa-cogs mr-2"></i>Find Matches</button>
                        </div>
                    </div>

                    <div class="glass-card border-dashed rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Your Ideal Deal Structure</h3>
                        <div class="space-y-4 text-sm">
                            <div><p class="text-xs text-text-muted">Asset Category</p><p id="summary-asset"></p></div>
                            <div><p class="text-xs text-text-muted">Core Procedure</p><p id="summary-procedure"></p></div>
                            <div><p class="text-xs text-text-muted">Transaction Venue</p><p id="summary-venue"></p></div>
                            <div><p class="text-xs text-text-muted">Settlement Protocol</p><p id="summary-settlement"></p></div>
                        </div>
                        <button id="reset-wizard-btn" class="w-full mt-6 text-xs text-text-muted hover:text-white transition-colors"><i class="fas fa-undo mr-2"></i>Start Over</button>
                    </div>
                </div>
            </div>

            <div id="results-area" class="mt-12 hidden">
                <div id="results-spinner" class="hidden text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-primary-azure"></i><p class="mt-4 text-lg text-text-secondary">Analyzing GECAN™ Ledger...</p></div>
                <div id="perfect-matches-section" class="hidden">
                    <h3 class="text-2xl font-bold text-white border-b-2 border-success-color pb-3 mb-6 flex items-center gap-3"><i class="fas fa-check-circle text-success-color"></i>Perfect Matches</h3>
                    <div id="perfect-matches-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
                </div>
                <div id="partial-matches-section" class="hidden mt-12">
                    <h3 class="text-2xl font-bold text-white border-b-2 border-warning-color pb-3 mb-6 flex items-center gap-3"><i class="fas fa-exclamation-triangle text-warning-color"></i>Partial Matches & Gap Analysis</h3>
                    <div id="partial-matches-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
                </div>
                <div id="no-results" class="hidden text-center py-20">
                    <i class="fas fa-search-minus fa-3x text-text-muted"></i>
                    <p class="mt-4 text-xl text-text-secondary font-medium">No offers found matching your specific criteria.</p>
                    <p class="text-sm text-text-muted">Try broadening your search by setting a parameter to 'Any'.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity duration-300">
      <div id="modal-content-wrapper" class="rounded-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl bg-gradient-to-br from-background-light to-background-accent border border-border-accent transform scale-95 opacity-0 transition-all duration-300"></div>
    </div>
    
    <footer class="mt-auto pt-16">
        <div class="container mx-auto p-6 md:p-10 border-t border-border-color">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm text-text-silver">
                <div>
                    <h3 class="font-bold text-lg mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-blue-600">GECAN™</h3>
                    <p class="mb-2">Global Energy & Commodities Alliance Network. Powered by Pennworth Ventures.</p>
                    <p class="text-xs text-text-muted">© 2025 GECAN™. All Rights Reserved.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Legal Disclaimer</h4>
                    <p class="text-xs leading-relaxed">The information on this platform is for informational purposes only. GECAN™ acts solely as an intermediary. We make no warranties regarding the accuracy, completeness, or performance of any offer or counterparty.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-3">Risk & Compliance</h4>
                    <p class="text-xs leading-relaxed">All transactions carry inherent financial, operational, and regulatory risks. Users must conduct independent due diligence and agree to indemnify GECAN™ from any and all claims or liabilities arising from platform use.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ====================================================================================
        // === GECAN™ ARCHITECT ENGINE v2.0 (PINNACLE STANDARD) ===
        // This engine is the definitive, production-grade standard for the Architect Wizard.
        // It has been severely upgraded to use the unified API protocol and platform aesthetics.
        // ====================================================================================

        const API_URL = "https://script.google.com/macros/s/AKfycbx2iCFhN8RB-sMQxBKu9d8NGUEbBLm2wKhRosXE6L4UNVifh59O5JDAbgoTU_q4zJkc/exec";

        const AppState = {
            allOffers: [],
            baseUrl: '',
            referralInfo: { id: null, partnerName: null },
            currentStep: 1,
            totalSteps: 4,
            offerGapsMap: new Map(),
            requirements: {
                asset: 'Any',
                procedure: 'Any',
                venue: 'Any',
                settlement: 'Any'
            }
        };

        const Utils = {
            createApiRequest: async (action, method = 'GET', params = {}) => {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                const options = { method: method.toUpperCase(), redirect: 'follow' };
                if (options.method === 'GET') {
                    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
                } else {
                    options.body = JSON.stringify({ action, data: params });
                    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
                }
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`API Network Error: Status ${response.status}`);
                    const result = await response.json();
                    if (result.success === false) throw new Error(result.error || 'An unknown server error occurred.');
                    return result.data || result.message || result;
                } catch (error) {
                    console.error(`API Error for action '${action}':`, error);
                    throw error;
                }
            },
            closeModal: () => {
                const overlay = document.getElementById('modal-overlay');
                const wrapper = document.getElementById('modal-content-wrapper');
                overlay.classList.add('opacity-0');
                wrapper.classList.remove('scale-100', 'opacity-100');
                wrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('opacity-0'); // Reset for next time
                }, 300);
            },
            showNotification: (message, type = 'info') => {
                const toast = document.createElement('div');
                const colors = {
                    success: 'from-green-500 to-emerald-600',
                    error: 'from-red-500 to-rose-600',
                    warning: 'from-amber-500 to-orange-600',
                    info: 'from-sky-500 to-blue-600'
                };
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-times-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                toast.className = `fixed top-5 right-5 p-4 rounded-xl shadow-2xl z-[200] text-white font-medium bg-gradient-to-br ${colors[type]} transform translate-y-[-100px] opacity-0 transition-all duration-500`;
                toast.innerHTML = `<div class="flex items-center gap-3"><i class="fas ${icons[type]}"></i><span>${message}</span></div>`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('translate-y-[-100px]', 'opacity-0');
                }, 10);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-20px)';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },
            animateProgressBar: (el, targetWidth, onComplete) => {
                let currentWidth = parseFloat(el.style.width) || 0;
                const animate = () => {
                    currentWidth += (targetWidth - currentWidth) * 0.1;
                    el.style.width = currentWidth + '%';
                    if (Math.abs(targetWidth - currentWidth) < 0.5) {
                        el.style.width = targetWidth + '%';
                        if (onComplete) onComplete();
                    } else {
                        requestAnimationFrame(animate);
                    }
                };
                animate();
            }
        };

        const UI = {
            init: () => {
                UI.initParticles();
                UI.populateNavLinks();
                Logic.setupEventListeners();
            },
            initParticles: () => {
                if (typeof particlesJS !== 'undefined') {
                    particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":1200}},"color":{"value":"#334155"},"shape":{"type":"circle"},"opacity":{"value":0.4,"random":true},"size":{"value":2,"random":true},"line_linked":{"enable":true,"distance":180,"color":"#475569","opacity":0.2,"width":1},"move":{"enable":true,"speed":0.8,"direction":"none","random":true,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":false}},"modes":{"grab":{"distance":200,"line_linked":{"opacity":0.5}}}},"retina_detect":true});
                }
            },
            populateNavLinks: () => {
                const navContainer = document.getElementById('nav-container');
                if (!navContainer) return;

                const links = [
                    { page: 'index', icon: 'fas fa-tachometer-alt', text: 'XDealFlow Home' },
                    { page: 'toolkits', icon: 'fas fa-tools', text: 'Intelligent Toolkits' },
                    { page: 'architect', icon: 'fas fa-drafting-compass', text: 'Architect Wizard' },
                    { page: 'intelligence', icon: 'fas fa-sitemap', text: 'Network Intelligence' }
                ];

                navContainer.innerHTML = links.map(link => {
                    const isActive = link.page === 'architect';
                    return `
                        <a href="./${link.page}.html" class="nav-btn ${isActive ? 'active' : ''}">
                            <div class="nav-icon-wrapper">
                                <div class="nav-icon-flipper">
                                    <div class="nav-icon-face nav-icon-front"><i class="${link.icon}"></i></div>
                                    <div class="nav-icon-face nav-icon-back"><i class="${link.icon}"></i></div>
                                </div>
                            </div>
                            <span class="nav-text">${link.text}</span>
                        </a>`;
                }).join('');
            },
            updateProgressBar: () => {
                const percentage = ((AppState.currentStep - 1) / (AppState.totalSteps - 1)) * 100;
                const bar = document.getElementById('progress-bar');
                if (bar) bar.style.width = `${percentage}%`;
            },
            updateWizardStep: () => {
                document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
                const currentStepEl = document.getElementById(`step-${AppState.currentStep}`);
                if (currentStepEl) currentStepEl.classList.add('active');
                
                document.getElementById('prev-btn').disabled = AppState.currentStep === 1;
                document.getElementById('next-btn').classList.toggle('hidden', AppState.currentStep === AppState.totalSteps);
                document.getElementById('find-matches-btn').classList.toggle('hidden', AppState.currentStep !== AppState.totalSteps);
                UI.updateProgressBar();
            },
            updateSummary: () => {
                const getDisplayValue = (value) => value === 'Any' ? '<span class="text-text-muted italic">Any</span>' : `<strong class="text-white">${value}</strong>`;
                document.getElementById('summary-asset').innerHTML = getDisplayValue(AppState.requirements.asset);
                document.getElementById('summary-procedure').innerHTML = getDisplayValue(AppState.requirements.procedure);
                document.getElementById('summary-venue').innerHTML = getDisplayValue(AppState.requirements.venue);
                document.getElementById('summary-settlement').innerHTML = getDisplayValue(AppState.requirements.settlement);
            },
            populateDropdowns: (offers, key, selectId, filters = []) => {
                let filteredOffers = offers;
                filters.forEach(filter => {
                    if (filter.value !== 'Any') {
                        filteredOffers = filteredOffers.filter(o => o[filter.key] === filter.value);
                    }
                });
                const uniqueValues = ['Any', ...new Set(filteredOffers.map(o => o[key]).filter(Boolean))].sort();
                const selectEl = document.getElementById(selectId);
                const currentValue = selectEl.value;
                selectEl.innerHTML = uniqueValues.map(val => `<option value="${val}">${val}</option>`).join('');
                if (uniqueValues.includes(currentValue)) {
                    selectEl.value = currentValue;
                } else {
                    selectEl.value = 'Any';
                    const keyName = selectId.split('-')[0];
                    AppState.requirements[keyName] = 'Any';
                    UI.updateSummary();
                }
            },
            renderResults: (perfect, partial) => {
                document.getElementById('results-spinner').classList.add('hidden');
                
                const perfectContainer = document.getElementById('perfect-matches-container');
                const partialContainer = document.getElementById('partial-matches-container');
                
                if (perfect.length > 0) {
                    perfectContainer.innerHTML = perfect.map(m => UI.ComponentBuilders.createResultCardHTML(m.offer, null, m.matchPercentage)).join('');
                    document.getElementById('perfect-matches-section').classList.remove('hidden');
                }
                if (partial.length > 0) {
                    partialContainer.innerHTML = partial.map(m => UI.ComponentBuilders.createResultCardHTML(m.offer, m.gaps, m.matchPercentage)).join('');
                    document.getElementById('partial-matches-section').classList.remove('hidden');
                }
                if (perfect.length === 0 && partial.length === 0) {
                    document.getElementById('no-results').classList.remove('hidden');
                }
            }
        };

        const Logic = {
            init: () => {
                UI.init();
            },
            validateReferralId: async () => {
                const btn = document.getElementById('validate-id-btn');
                const input = document.getElementById('referral-id-input');
                const errorEl = document.getElementById('referral-error');
                const progressEl = document.getElementById('auth-progress');
                const statusText = document.getElementById('auth-status-text');
                
                const referralId = input.value.trim();
                if (!referralId) {
                    errorEl.textContent = 'Referral ID cannot be empty.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                errorEl.classList.add('hidden');
                progressEl.classList.remove('hidden');
                statusText.textContent = "Validating credentials...";

                try {
                    Utils.animateProgressBar(progressEl.querySelector('.progress-bar'), 50);
                    const response = await Utils.createApiRequest('validateReferralId', 'POST', { referralId });
                    statusText.textContent = "Validation successful. Loading data...";
                    Utils.animateProgressBar(progressEl.querySelector('.progress-bar'), 75);

                    if (response && response.isValid) {
                        AppState.referralInfo = { id: response.referralId, partnerName: response.partnerName };
                        const offerData = await Utils.createApiRequest('getOfferData');
                        Utils.animateProgressBar(progressEl.querySelector('.progress-bar'), 100, () => {
                           setTimeout(() => {
                                document.getElementById('referral-gate').style.display = 'none';
                                document.getElementById('architect-wizard').classList.remove('hidden');
                                document.getElementById('referral-banner').innerHTML = `<p class="text-sm text-text-secondary">Referral: <strong class="text-white">${response.referralId}</strong></p><p class="text-xs text-text-muted">Partner: ${response.partnerName}</p>`;
                                Logic.onDataLoaded(offerData);
                            }, 500);
                        });
                    } else {
                        throw new Error('Invalid or inactive Referral ID. Please check and try again.');
                    }
                } catch (error) {
                    progressEl.classList.add('hidden');
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'Validate';
                }
            },
            onDataLoaded: (data) => {
                AppState.allOffers = data.filter(o => o.OFFER_ID && o.OFFER_DESCRIPTION); // Data integrity check
                document.getElementById('initial-loading').style.display = 'none';
                document.getElementById('wizard-content').classList.add('fade-in-up');
                document.getElementById('wizard-content').classList.remove('hidden');
                Logic.initializeWizard();
            },
            initializeWizard: () => {
                AppState.currentStep = 1;
                AppState.requirements = { asset: 'Any', procedure: 'Any', venue: 'Any', settlement: 'Any' };
                UI.populateDropdowns(AppState.allOffers, 'ASSET_CATEGORY', 'asset-select');
                UI.populateDropdowns(AppState.allOffers, 'CORE_PROCEDURE_TYPE', 'procedure-select');
                UI.populateDropdowns(AppState.allOffers, 'TRANSACTION_VENUE', 'venue-select');
                UI.populateDropdowns(AppState.allOffers, 'SETTLEMENT_PROTOCOL', 'settlement-select');
                ['asset-select','procedure-select','venue-select','settlement-select'].forEach(id => document.getElementById(id).value = 'Any');
                UI.updateWizardStep();
                UI.updateSummary();
                document.getElementById('results-area').classList.add('hidden');
            },
            handleSelectionChange: (event) => {
                const { id, value } = event.target;
                const key = id.split('-')[0];
                AppState.requirements[key] = value;
                UI.updateSummary();

                const filters = [];
                if (AppState.requirements.asset !== 'Any') filters.push({ key: 'ASSET_CATEGORY', value: AppState.requirements.asset });
                if (AppState.requirements.procedure !== 'Any') filters.push({ key: 'CORE_PROCEDURE_TYPE', value: AppState.requirements.procedure });
                if (AppState.requirements.venue !== 'Any') filters.push({ key: 'TRANSACTION_VENUE', value: AppState.requirements.venue });

                if (id === 'asset-select') {
                    UI.populateDropdowns(AppState.allOffers, 'CORE_PROCEDURE_TYPE', 'procedure-select', filters);
                    UI.populateDropdowns(AppState.allOffers, 'TRANSACTION_VENUE', 'venue-select', filters);
                    UI.populateDropdowns(AppState.allOffers, 'SETTLEMENT_PROTOCOL', 'settlement-select', filters);
                } else if (id === 'procedure-select') {
                    UI.populateDropdowns(AppState.allOffers, 'TRANSACTION_VENUE', 'venue-select', filters);
                    UI.populateDropdowns(AppState.allOffers, 'SETTLEMENT_PROTOCOL', 'settlement-select', filters);
                } else if (id === 'venue-select') {
                    UI.populateDropdowns(AppState.allOffers, 'SETTLEMENT_PROTOCOL', 'settlement-select', filters);
                }
            },
            findMatches: () => {
                document.getElementById('results-area').classList.remove('hidden');
                document.getElementById('results-spinner').classList.remove('hidden');
                ['perfect-matches-section', 'partial-matches-section', 'no-results'].forEach(id => document.getElementById(id).classList.add('hidden'));
                
                setTimeout(() => {
                    let perfect = [], partial = [];
                    AppState.offerGapsMap.clear();
                    const reqMap = { asset: 'ASSET_CATEGORY', procedure: 'CORE_PROCEDURE_TYPE', venue: 'TRANSACTION_VENUE', settlement: 'SETTLEMENT_PROTOCOL' };
                    
                    const activeOffers = AppState.allOffers.filter(o => o.OFFER_STATUS && o.OFFER_STATUS.toUpperCase().includes('ACTIVE'));
                    
                    activeOffers.forEach(offer => {
                        let gaps = [], met = 0, potential = 0;
                        Object.keys(AppState.requirements).forEach(key => {
                            const userValue = AppState.requirements[key], offerValue = offer[reqMap[key]];
                            if (userValue !== 'Any') {
                                potential++;
                                if (userValue === offerValue) {
                                    met++;
                                } else {
                                    gaps.push(`<strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> Required '${userValue}', but offer has '${offerValue || 'N/A'}'.`);
                                }
                            }
                        });
                        
                        if (potential > 0) {
                            const matchPercentage = (met / potential) * 100;
                            if (gaps.length === 0) {
                                perfect.push({ offer, matchPercentage });
                            } else {
                                AppState.offerGapsMap.set(offer.OFFER_ID, {gaps, matchPercentage});
                                partial.push({ offer, gaps, matchPercentage });
                            }
                        } else {
                            perfect.push({ offer, matchPercentage: 100 });
                        }
                    });

                    perfect.sort((a,b) => (b.offer.OFFER_RELIABILITY_SCORE || 0) - (a.offer.OFFER_RELIABILITY_SCORE || 0));
                    partial.sort((a, b) => b.matchPercentage - a.matchPercentage);

                    UI.renderResults(perfect, partial);
                }, 800);
            },
            openModal: async (offerId) => {
                const offer = AppState.allOffers.find(o => o.OFFER_ID === offerId);
                if (!offer) { Utils.showNotification('Could not load offer details.', 'error'); return; }
                const { gaps, matchPercentage } = AppState.offerGapsMap.get(offerId) || { gaps: null, matchPercentage: 100 };
                
                const modalContentWrapper = document.getElementById('modal-content-wrapper');
                modalContentWrapper.innerHTML = UI.ComponentBuilders.renderDetailsModalContent(offer, gaps, matchPercentage);
                
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.remove('hidden');
                overlay.classList.remove('opacity-0');
                
                setTimeout(() => { 
                    modalContentWrapper.classList.remove('scale-95', 'opacity-0');
                    modalContentWrapper.classList.add('scale-100', 'opacity-100');
                }, 50);
            },
            transitionToFormModal: (offerId) => {
                const offer = AppState.allOffers.find(o => o.OFFER_ID === offerId);
                const { gaps, matchPercentage } = AppState.offerGapsMap.get(offerId) || { gaps: null, matchPercentage: 100 };
                const isPerfect = !gaps || gaps.length === 0;

                const formHtml = isPerfect 
                    ? UI.ComponentBuilders.renderEngagementForm(offer) 
                    : UI.ComponentBuilders.renderInquiryForm(offer, gaps);
                
                document.getElementById('modal-content-wrapper').innerHTML = formHtml;
                
                const formType = isPerfect ? 'engagement' : 'inquiry';
                Logic.setupFormEventListeners(formType, offerId);
            },
            submitForm: async (type, offerId) => {
                const btn = document.querySelector('#modal-form button[type="submit"]');
                if(!btn) return;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating & Preparing...';

                try {
                    const form = document.getElementById('modal-form');
                    if (!form.checkValidity()) {
                        Utils.showNotification('Please fill out all required fields marked with *.', 'warning');
                        form.reportValidity();
                        btn.disabled = false;
                        btn.innerHTML = type === 'engagement' ? 'Submit Formal Enquiry' : 'Submit Structured Inquiry';
                        return;
                    }
                    
                    const getValue = id => document.getElementById(id)?.value || '';
                    const getAmendment = id => { const el = document.getElementById(id); return { value: el.value, isAmended: el.value !== el.dataset.original, original: el.dataset.original }; };
                    
                    const payload = {
                        offerId: offerId,
                        referralInfo: AppState.referralInfo,
                        requirements: AppState.requirements,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        enquiryDetails: {
                            userName: getValue('modal-user-name'),
                            userEmail: getValue('modal-user-email'),
                            userPhone: getValue('modal-user-phone'),
                            userRelationship: getValue('modal-user-relationship'),
                            buyerName: getValue('modal-buyer-name'),
                            buyerEntity: getValue('modal-buyer-entity'),
                            buyerJurisdiction: getValue('modal-buyer-jurisdiction'),
                            comments: getValue('modal-comments'),
                        },
                        amendments: type === 'engagement' ? {
                            asset: getAmendment('modal-asset-category'),
                            procedure: getAmendment('modal-core-procedure'),
                            venue: getAmendment('modal-preferred-venue'),
                            settlement: getAmendment('modal-settlement-protocol'),
                            volume: getAmendment('modal-required-volume'),
                            price: getAmendment('modal-target-price'),
                            wallet: { value: getValue('modal-wallet-address') }
                        } : null,
                        gaps: type === 'inquiry' ? (AppState.offerGapsMap.get(offerId)?.gaps || []) : null
                    };

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting to GECAN™...';
                    const action = type === 'engagement' ? 'sendEngagementRequestEmail' : 'sendStructuredInquiryEmail';
                    const response = await Utils.createApiRequest(action, 'POST', payload);
                    
                    Utils.showNotification(response || 'Submission successful!', 'success');
                    Utils.closeModal();

                } catch (error) {
                    Utils.showNotification(error.message, 'error', 'Submission Failed');
                    btn.disabled = false;
                    btn.innerHTML = type === 'engagement' ? 'Submit Formal Enquiry' : 'Submit Structured Inquiry';
                }
            },
            setupEventListeners: () => {
                document.getElementById('validate-id-btn').addEventListener('click', Logic.validateReferralId);
                document.getElementById('referral-id-input').addEventListener('keypress', e => { if (e.key === 'Enter') Logic.validateReferralId(); });
                document.getElementById('prev-btn').addEventListener('click', () => { if (AppState.currentStep > 1) { AppState.currentStep--; UI.updateWizardStep(); } });
                document.getElementById('next-btn').addEventListener('click', () => { if (AppState.currentStep < AppState.totalSteps) { AppState.currentStep++; UI.updateWizardStep(); } });
                document.getElementById('find-matches-btn').addEventListener('click', Logic.findMatches);
                document.getElementById('reset-wizard-btn').addEventListener('click', Logic.initializeWizard);
                ['asset-select', 'procedure-select', 'venue-select', 'settlement-select'].forEach(id => { 
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', Logic.handleSelectionChange);
                });
                document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'modal-overlay') Utils.closeModal(); });
            },
            setupFormEventListeners: (type, offerId) => {
                document.getElementById('modal-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    Logic.submitForm(type, offerId);
                });
                
                if (type === 'engagement') {
                    const settlementInput = document.getElementById('modal-settlement-protocol');
                    const walletArea = document.getElementById('wallet-input-area');
                    
                    const renderWalletInput = () => {
                        if (!settlementInput || !walletArea) return;
                        const protocol = settlementInput.value.toUpperCase();
                        let placeholder = '';
                        if (protocol.includes('USDT (TRC-20)')) placeholder = 'USDT (TRC-20) Wallet Address (Optional)';
                        else if (protocol.includes('USDT (ERC-20)')) placeholder = 'USDT (ERC-20) Wallet Address (Optional)';
                        else if (protocol.includes('BTC')) placeholder = 'Bitcoin Wallet Address (Optional)';
                        
                        walletArea.innerHTML = placeholder 
                            ? `<div class="relative group mt-4"><input type="text" id="modal-wallet-address" placeholder="${placeholder}" class="form-input p-3 text-white rounded-xl w-full"><p class="absolute left-2 -bottom-5 text-xs text-gray-500 opacity-0 group-focus-within:opacity-100 transition-opacity pointer-events-none">Provide the relevant wallet address for settlement.</p></div>` 
                            : '';
                    };
                    
                    settlementInput.addEventListener('input', renderWalletInput);
                    renderWalletInput();

                    const dealParams = document.querySelectorAll('.deal-param');
                    const updateFeasibility = () => {
                        let score = 100, deviations = 0;
                        dealParams.forEach(input => {
                            if (input.value.trim() !== '' && input.value !== input.dataset.original) { deviations++; }
                        });
                        const totalParams = dealParams.length;
                        score = Math.max(0, totalParams > 0 ? ((totalParams - deviations) / totalParams) * 100 : 100);
                        
                        const scoreEl = document.getElementById('feasibility-score');
                        const barEl = document.getElementById('feasibility-bar');
                        const guidanceEl = document.getElementById('feasibility-guidance');
                        
                        if(scoreEl && barEl && guidanceEl){
                            scoreEl.textContent = `${Math.round(score)}%`;
                            scoreEl.className = `text-3xl font-black transition-all duration-300 ${score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'}`;
                            barEl.style.width = `${score}%`;
                            barEl.className = `h-2.5 rounded-full transition-all duration-500 ${score >= 80 ? 'bg-gradient-to-r from-green-500 to-emerald-400' : score >= 50 ? 'bg-gradient-to-r from-yellow-500 to-amber-400' : 'bg-gradient-to-r from-red-500 to-rose-400'}`;
                            
                            if (deviations > 0) {
                                guidanceEl.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>You have proposed ${deviations} amendment(s). This may increase negotiation time and complexity.`;
                            } else {
                                guidanceEl.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-1"></i>Your enquiry perfectly aligns with the seller's offer, representing the path of least resistance.`;
                            }
                        }
                    };
                    dealParams.forEach(input => input.addEventListener('input', updateFeasibility));
                    updateFeasibility();
                }
            }
        };

        const UI = {
            // ... (keep the existing UI functions: init, initParticles, populateNavLinks, etc.) ...
            // The ComponentBuilders object will be added here
        };

        // ====================================================================================
        // === COMPONENT BUILDERS (PINNACLE STANDARD) ===
        // These functions are isolated to prevent script execution errors during page load.
        // They are only called after the main application logic has initialized.
        // ====================================================================================
        const ComponentBuilders = {
            createResultCardHTML: (offer, gaps = null, matchPercentage = 100) => {
                const isPerfect = !gaps || gaps.length === 0;
                const score = offer.OFFER_RELIABILITY_SCORE || 0;
                const scoreColor = score >= 75 ? 'text-success-color' : score >= 50 ? 'text-warning-color' : 'text-error-color';
                const assetClass = `asset-color-${String(offer.ASSET_CATEGORY).replace(/[\s\/_]+/g, '_').toUpperCase()}`;
                
                let matchBarGradient = `linear-gradient(to right, var(--success-color), #16a34a)`;
                if (matchPercentage < 100) matchBarGradient = `linear-gradient(to right, var(--warning-color), #ca8a04)`;
                
                const buttonText = isPerfect ? "Request Official Engagement" : "Submit Structured Inquiry";
                const buttonIcon = isPerfect ? "fa-file-signature" : "fa-paper-plane";

                let buttonClasses = 'w-full mt-auto pt-3 font-bold text-sm py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 transform group-hover:scale-105 ';
                if(isPerfect) {
                    buttonClasses += 'bg-gradient-to-r from-success-color to-green-600 text-white shadow-lg shadow-green-500/20';
                } else {
                    buttonClasses += 'bg-gradient-to-r from-warning-color to-yellow-500 text-black shadow-lg shadow-yellow-500/20';
                }
                
                return `
                <div class="result-card rounded-2xl p-5 flex flex-col h-full ${assetClass} group" onclick="Logic.openModal('${offer.OFFER_ID}')">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 pr-4">
                                <h4 class="font-bold text-white text-lg line-clamp-2">${offer.OFFER_DESCRIPTION}</h4>
                                <p class="text-xs font-mono text-text-muted mt-1">${offer.OFFER_ID}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-xs text-text-muted">Confidence</p>
                                <p class="font-black text-3xl ${scoreColor}">${score}%</p>
                            </div>
                        </div>
                        <div class="my-4">
                           <div class="flex justify-between items-center text-xs mb-1">
                                <span class="font-medium text-text-secondary">Match Percentage</span>
                                <span class="font-bold" style="color: ${matchPercentage < 100 ? 'var(--warning-color)' : 'var(--success-color)'};">${Math.round(matchPercentage)}%</span>
                           </div>
                           <div class="w-full h-1.5 rounded-full match-bar-bg">
                               <div class="h-full rounded-full match-bar" style="width: ${matchPercentage}%; background: ${matchBarGradient};"></div>
                           </div>
                        </div>
                    </div>
                     <div class="${buttonClasses}">
                        <i class="fas ${buttonIcon}"></i>
                        <span>${buttonText}</span>
                    </div>
                </div>`;
            },
            renderDetailsModalContent: (offer, gaps, matchPercentage) => {
                const isPerfect = !gaps || gaps.length === 0;
                const assetClass = `asset-color-${String(offer.ASSET_CATEGORY).replace(/[\s\/_]+/g, '_').toUpperCase()}`;
                const stars = offer.GECAN_CONFIDENCE || 0;
                const createDetailItem = (label, value, icon) => `<div class="modal-grid-item"><p class="text-xs text-text-secondary flex items-center mb-2"><i class="fas ${icon} fa-fw mr-2 text-primary-azure"></i>${label}</p><p class="font-semibold text-sm text-white">${value || 'N/A'}</p></div>`;
                
                let gapAnalysisHtml = isPerfect
                    ? `<div class="mb-6 p-4 bg-green-900/20 border border-green-500/50 rounded-2xl"><h4 class="font-bold text-lg text-green-300"><i class="fas fa-check-circle mr-2"></i>Perfect Match Found</h4><p class="text-sm text-green-200">This offer aligns perfectly with your requirements. You can proceed to submit a formal enquiry.</p></div>`
                    : `<div class="mb-6 p-4 bg-yellow-900/20 border border-yellow-500/50 rounded-2xl"><h4 class="font-bold text-lg text-yellow-300 mb-3">Gap Analysis (Match: ${Math.round(matchPercentage)}%)</h4><ul class="text-sm text-yellow-200 space-y-1.5 list-disc list-inside">${gaps.map(g => `<li>${g}</li>`).join('')}</ul><p class="text-xs text-yellow-400/80 mt-3">The following offer details differ from your requirements. Review below and proceed to submit a structured inquiry if you wish to negotiate.</p></div>`;

                const buttonText = isPerfect ? "Proceed to Formal Enquiry" : "Proceed to Structured Inquiry";
                const buttonIcon = isPerfect ? "fa-file-signature" : "fa-paper-plane";
                
                return `<div class="flex flex-col h-full"><div class="p-6 border-b border-border-color flex-shrink-0 ${assetClass}"> <div class="flex justify-between items-center"><div><p class="font-bold text-xl text-white">${offer.OFFER_DESCRIPTION}</p><p class="text-sm font-mono text-text-secondary">${offer.OFFER_ID}</p></div><button type="button" onclick="Utils.closeModal()" class="text-3xl text-text-muted hover:text-white transition-colors">×</button></div></div> <div class="flex-grow overflow-y-auto p-8">${gapAnalysisHtml}<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">${createDetailItem('OFFER STATUS', offer.OFFER_STATUS, 'fa-check-circle')}${createDetailItem('GECAN CONFIDENCE', `<span class="text-yellow-400 text-lg">${'★'.repeat(stars)}<span class="text-gray-600">${'☆'.repeat(5-stars)}</span></span>`, 'fa-star')}${createDetailItem('TOTAL VOLUME', `${offer.TOTAL_VOLUME_AVAILABLE} ${offer.UNITS_OF_MEASURE}`, 'fa-coins')}${createDetailItem('DATE RECEIVED', new Date(offer.DATE_RECEIVED).toLocaleDateString(), 'fa-calendar-alt')}</div><div class="glass-card rounded-2xl p-6 border-l-4 border-primary-azure mb-8"><h3 class="text-xl font-bold mb-4 text-white flex items-center gap-3"><i class="fas fa-file-alt text-primary-azure"></i>Executive Summary</h3><p class="text-sm text-text-secondary leading-relaxed">${offer.EXECUTIVE_SUMMARY_AND_OVERVIEW}</p></div><div class="glass-card rounded-2xl p-6 border-l-4 border-primary-azure mb-8"><h3 class="text-xl font-bold mb-4 text-white flex items-center gap-3"><i class="fas fa-tags text-primary-azure"></i>Pricing & Commission</h3><div class="bg-background-dark rounded-xl p-4 font-mono text-sm"><pre class="text-text-platinum whitespace-pre-wrap">${offer.DISCOUNT_COMMISSION_SUMMARY}</pre></div></div></div> <div class="p-6 flex justify-end items-center rounded-b-2xl border-t border-border-color flex-shrink-0 bg-background-dark/50"><button onclick="Logic.transitionToFormModal('${offer.OFFER_ID}')" class="btn-primary font-bold py-3 px-8 rounded-lg"><i class="fas ${buttonIcon} mr-2"></i>${buttonText}</button></div></div>`;
            },
            renderEngagementForm: (offer) => {
                const userReqs = AppState.requirements; 
                const getVal = (key, offerKey) => userReqs[key] !== 'Any' ? userReqs[key] : offer[offerKey] || '';
                
                return `<form id="modal-form" class="flex flex-col h-full"><div class="p-6 border-b border-border-color flex-shrink-0"><div class="flex justify-between items-start"><div><h3 class="text-xl md:text-2xl font-bold text-white">Intermediary Deal Submission Portal</h3><p class="text-sm text-gray-400">Enquiry Against Offer: ${offer.OFFER_ID}</p></div><button type="button" onclick="Utils.closeModal()" class="text-2xl text-gray-500 hover:text-white transition-colors">×</button></div></div><div class="p-6 space-y-6 overflow-y-auto flex-grow"><div class="p-4 bg-gray-900/50 rounded-2xl border border-gray-700 shadow-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-lg text-white">Engagement Feasibility Score</h4><span id="feasibility-score" class="text-3xl font-black text-green-400">100%</span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div id="feasibility-bar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-2.5 rounded-full" style="width: 100%;"></div></div><p id="feasibility-guidance" class="text-xs text-gray-400 mt-3"><i class="fas fa-check-circle text-green-500 mr-1"></i>Your enquiry aligns with the offer.</p></div><input type="hidden" id="modal-timezone"><div class="form-section"><h4 class="font-bold text-white mb-4">1. Your Details (Enquiry Source)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative group"><input type="text" id="modal-user-name" placeholder="Your Full Name*" class="form-input" required><p class="helper-text">Your name as the introducer.</p></div><div class="relative group"><input type="email" id="modal-user-email" placeholder="Your Email Address*" class="form-input" required><p class="helper-text">Your primary email for communication.</p></div><div class="relative group"><input type="text" id="modal-user-phone" placeholder="Your Phone (Signal/WA)*" class="form-input" required><p class="helper-text">Your direct contact number.</p></div><div class="relative group"><select id="modal-user-relationship" class="form-input" required><option value="" disabled selected>Your Relationship to Buyer*</option><option>Mandate</option><option>Broker/Intermediary</option><option>Consultant</option><option>Direct Principal</option></select><p class="helper-text">Select your role in this transaction.</p></div></div></div><div class="form-section"><h4 class="font-bold text-white mb-4">2. End Buyer Identity</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative group"><input type="text" id="modal-buyer-name" placeholder="Buyer Principal Full Name*" class="form-input" required><p class="helper-text">The full name of the ultimate end buyer.</p></div><div class="relative group"><input type="text" id="modal-buyer-entity" placeholder="Buyer Legal Entity Name*" class="form-input" required><p class="helper-text">The registered company or trust name.</p></div><div class="relative group"><input type="text" id="modal-buyer-jurisdiction" placeholder="Buyer Jurisdiction*" class="form-input" required><p class="helper-text">The country of incorporation.</p></div></div></div><div class="form-section"><h4 class="font-bold text-white mb-4">3. Core Deal Structure (Verify & Amend)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative group"><input type="text" id="modal-asset-category" value="${getVal('asset', 'ASSET_CATEGORY')}" data-original="${offer.ASSET_CATEGORY}" class="form-input deal-param" required><p class="helper-text">Asset Category</p></div><div class="relative group"><input type="text" id="modal-core-procedure" value="${getVal('procedure', 'CORE_PROCEDURE_TYPE')}" data-original="${offer.CORE_PROCEDURE_TYPE}" class="form-input deal-param" required><p class="helper-text">Core Procedure</p></div><div class="relative group"><input type="text" id="modal-preferred-venue" value="${getVal('venue', 'TRANSACTION_VENUE')}" data-original="${offer.TRANSACTION_VENUE}" class="form-input deal-param" required><p class="helper-text">Transaction Venue</p></div><div class="relative group"><input type="text" id="modal-settlement-protocol" value="${getVal('settlement', 'SETTLEMENT_PROTOCOL')}" data-original="${offer.SETTLEMENT_PROTOCOL}" class="form-input deal-param" required><p class="helper-text">Settlement Protocol</p></div></div><div id="wallet-input-area"></div></div><div class="form-section"><h4 class="font-bold text-white mb-4">4. Commercials & Supporting Documents</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="relative group"><input type="text" id="modal-required-volume" placeholder="Required Volume*" class="form-input deal-param" required data-original="${offer.TOTAL_VOLUME_AVAILABLE || ''}"><p class="helper-text">Total volume buyer wishes to acquire.</p></div><div class="relative group"><input type="text" id="modal-target-price" placeholder="Target Price/Discount*" class="form-input deal-param" required data-original="${offer.PRICE_REFERENCE_BASIS || ''}"><p class="helper-text">e.g., LME -6% Net to Buyer.</p></div></div><div class="relative group"><textarea id="modal-comments" placeholder="Additional comments on buyer requirements, SOP points, etc..." class="form-input w-full h-24"></textarea></div></div></div><div class="p-6 border-t border-border-color mt-auto flex-shrink-0 flex justify-end"><button type="submit" class="btn-primary bg-gradient-to-r from-success-color to-green-600 border-green-500 font-bold py-3 px-8 rounded-lg">Submit Formal Enquiry</button></div></form>`;
            },
            renderInquiryForm: (offer, gaps) => {
                return `<form id="modal-form" class="flex flex-col h-full"><div class="p-6 border-b border-border-color flex-shrink-0"><div class="flex justify-between items-start"><div><h3 class="text-xl md:text-2xl font-bold text-white">Structured Inquiry Portal</h3><p class="text-sm text-gray-400">Against Offer: ${offer.OFFER_ID}</p></div><button type="button" onclick="Utils.closeModal()" class="text-2xl text-gray-500 hover:text-white transition-colors">×</button></div></div><div class="p-6 space-y-6 overflow-y-auto flex-grow"><div class="p-4 bg-yellow-900/20 border border-yellow-500/50 rounded-2xl"><h4 class="font-bold text-lg text-yellow-300 mb-2">Identified Gaps for Negotiation</h4><ul class="text-sm text-yellow-200 space-y-1 list-disc list-inside ml-4">${gaps.map(g => `<li>${g}</li>`).join('')}</ul></div><input type="hidden" id="modal-timezone"><div class="form-section"><h4 class="font-bold text-white mb-4">1. Your Details (Enquiry Source)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative group"><input type="text" id="modal-user-name" placeholder="Your Full Name*" class="form-input" required><p class="helper-text">Your name as the introducer.</p></div><div class="relative group"><input type="email" id="modal-user-email" placeholder="Your Email Address*" class="form-input" required><p class="helper-text">Your primary email for communication.</p></div></div></div><div class="form-section"><h4 class="font-bold text-white mb-4">2. End Buyer Details</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative group"><input type="text" id="modal-buyer-name" placeholder="Buyer Principal Full Name*" class="form-input" required><p class="helper-text">The ultimate end buyer.</p></div><div class="relative group"><input type="text" id="modal-buyer-entity" placeholder="Buyer Legal Entity Name*" class="form-input" required><p class="helper-text">The registered company name.</p></div></div></div><div class="form-section"><h4 class="font-bold text-white mb-4">3. Comments & Clarifications</h4><div class="relative group"><textarea id="modal-comments" placeholder="Provide clarifications on the identified gaps or add other critical information..." class="form-input w-full h-24" required></textarea><p class="helper-text">This information is key to bridging the gap.</p></div></div></div><div class="p-6 border-t border-border-color mt-auto flex-shrink-0 flex justify-end"><button type="submit" class="btn-primary font-bold py-3 px-8 rounded-lg bg-gradient-to-r from-warning-color to-yellow-600 border-yellow-500 text-black">Submit Structured Inquiry</button></div></form>`;
            }
        };

        // Initialize on DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            Object.assign(UI, ComponentBuilders); // Safely assign builders after DOM is ready
            Logic.init();
        });
    </script>
</body>
</html>
